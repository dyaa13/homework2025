<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arithmetic Sequences — nth term & sum — DYAA</title>

<style>
    :root{
      --blue:#0d47a1;
      --orange:#ff9800;
      --purple:#6a1b9a;
      --bg:#f4f4f9;
      --ink:#222;
      --muted:#666;
      --card:#fff;
      --line:#e6e6ef;
      --ok:#1b5e20;
      --bad:#b71c1c;
      --shadow:0 6px 15px rgba(0,0,0,0.10);
      --stroke:#111;
      --radius:18px;
    }

    *{box-sizing:border-box;}
    body{
      font-family:'Segoe UI', Tahoma, sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      color:var(--ink);
    }

    body:before{
      content:"DYAA";
      position:fixed;
      inset:auto auto 8% -10%;
      font-size:180px;
      font-weight:900;
      letter-spacing:8px;
      color:rgba(13,71,161,0.05);
      transform:rotate(-10deg);
      pointer-events:none;
      user-select:none;
    }

    .quiz-container{
      max-width:980px;
      margin:24px auto;
      background:var(--card);
      padding:26px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,0.04);
    }

    #headerLogo{
      display:flex;align-items:center;gap:12px;
      padding-bottom:12px;margin-bottom:14px;
      border-bottom:2px solid var(--line);
    }
    .logo-icon{
      width:44px;height:44px;background:var(--blue);
      border-radius:10px;position:relative;flex:0 0 auto;
      box-shadow:0 6px 14px rgba(13,71,161,0.18);
    }
    .logo-icon:before{
      content:"";position:absolute;width:22px;height:10px;background:var(--orange);
      top:-6px;left:11px;border-radius:3px;
      box-shadow:0 4px 10px rgba(255,152,0,0.22);
    }
    .logo-icon:after{
      content:"";position:absolute;width:18px;height:18px;border:2px solid rgba(255,255,255,0.75);
      left:13px;top:13px;border-radius:5px;
    }

    .header-text h1{
      margin:0;
      font-size:22px;
      color:var(--blue);
      line-height:1.15;
    }
    .header-text .sub{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
    }

    .row{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin:10px 0 6px 0;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:#fafbff;
      border-radius:999px;
      padding:8px 12px;
      color:var(--ink);
      font-size:13px;
      flex-wrap:wrap;
    }
    .pill b{color:var(--blue);}
    .pill small{color:var(--muted);}

    .select{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:7px 10px;
      font-weight:900;
      color:var(--ink);
      cursor:pointer;
      outline:none;
    }
    .select:focus{
      border-color:rgba(13,71,161,0.35);
      box-shadow:0 0 0 4px rgba(13,71,161,0.10);
    }

    .btn{
      appearance:none;border:none;cursor:pointer;
      border-radius:12px;padding:10px 12px;
      font-weight:900;font-size:13px;
      background:var(--blue);color:#fff;
      box-shadow:0 6px 14px rgba(13,71,161,0.18);
    }
    .btn:hover{filter:brightness(1.03);}
    .btn.secondary{
      background:#fff;color:var(--blue);
      border:1px solid rgba(13,71,161,0.22);
      box-shadow:none;
    }
    .btn.ghost{
      background:#fff;color:var(--ink);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:900;
    }
    .btn.danger{
      background:#fff;color:var(--bad);
      border:1px solid rgba(183,28,28,0.25);
      box-shadow:none;
    }
    .btn.orange{
      background:var(--orange);
      color:#fff;
      box-shadow:0 6px 14px rgba(255,152,0,0.20);
    }
    .btn.purple{
      background:var(--purple);
      color:#fff;
      box-shadow:0 6px 14px rgba(106,27,154,0.20);
    }

    .tabs{
      display:flex;gap:10px;margin-top:12px;
      border-bottom:1px solid var(--line);
      padding-bottom:10px;
      flex-wrap:wrap;
    }
    .tab{
      border:none;cursor:pointer;
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:1000;
      color:var(--muted);
      border:1px solid var(--line);
    }
    .tab.active{
      color:var(--blue);
      border-color:rgba(13,71,161,0.25);
      background:#f5f8ff;
    }

    .panel{display:none;margin-top:14px;}
    .panel.active{display:block;}

    .learn-card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      background:#fbfcff;
    }
    .learn-card h2{
      margin:0 0 8px 0;
      font-size:18px;
      color:var(--blue);
    }
    .learn-card p{
      margin:8px 0;
      color:#2a2a2a;
      line-height:1.55;
    }

    .learn-svg-wrap{
      width:100%;
      max-width:560px;
      margin:10px auto 14px;
    }
    .learn-svg-wrap svg{
      width:100%;
      height:auto;
      display:block;
    }

    .note{
      border-left:4px solid var(--orange);
      padding:10px 12px;
      background:#fff7ea;
      border-radius:12px;
      color:#4a3b22;
      margin-top:10px;
      font-size:13px;
      line-height:1.5;
    }

    .learn-grid{
      display:grid;
      grid-template-columns:1.2fr 0.8fr;
      gap:14px;
      margin-top:12px;
      align-items:start;
    }
    @media (max-width:860px){
      .learn-grid{grid-template-columns:1fr;}
    }

    .mini-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      margin-top:10px;
      font-size:13px;
    }
    .mini-table th, .mini-table td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:top;
    }
    .mini-table th{
      background:#f5f8ff;
      color:var(--blue);
      font-weight:1000;
    }
    .mini-table tr:last-child td{border-bottom:none;}

    .q-list{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:12px;
    }
    .q-card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,0.04);
    }

    .q-top{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .q-title{
      margin:0;
      font-size:15px;
      color:var(--ink);
      line-height:1.35;
      max-width:100%;
      overflow-wrap:anywhere;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid var(--line);
      font-size:12px;
      font-weight:1000;
      background:#fafbff;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.easy{color:#1b5e20;border-color:rgba(27,94,32,0.18);background:#f2fff4;}
    .badge.medium{color:#0d47a1;border-color:rgba(13,71,161,0.18);background:#f3f6ff;}
    .badge.hard{color:#b71c1c;border-color:rgba(183,28,28,0.18);background:#fff3f3;}

    .q-body{
      display:grid;
      grid-template-columns:360px 1fr;
      gap:12px;
      margin-top:10px;
      align-items:start;
    }
    @media (max-width:860px){
      .q-body{grid-template-columns:1fr;}
    }

    /* IMPORTANT: no cropping on screen */
    .svg-wrap{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:12px 12px 10px 12px;
      overflow: hidden;
    }
    .svg-wrap svg{
      display:block;
      width:100%;
      height:auto;
      overflow: hidden;
    }
    .svg-note{
      margin-top:6px;
      font-size:12px;
      color:rgba(0,0,0,0.55);
      font-weight:900;
    }

    .answer-area{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }
    .input-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    input[type="text"]{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font-size:14px;
      min-width:240px;
      max-width:100%;
      outline:none;
      background:#fff;
    }
    input[type="text"]:focus{
      border-color:rgba(13,71,161,0.35);
      box-shadow:0 0 0 4px rgba(13,71,161,0.10);
    }

    .hint-box{
      display:none;
      padding:10px 12px;
      border-radius:12px;
      border:1px dashed rgba(13,71,161,0.35);
      background:#f5f8ff;
      color:#1a2b55;
      font-size:13px;
      line-height:1.5;
    }
    .hint-box.show{display:block;}

    .feedback{
      font-size:13px;
      line-height:1.45;
      color:var(--muted);
    }
    .feedback.ok{color:var(--ok);font-weight:1000;}
    .feedback.bad{color:var(--bad);font-weight:1000;}

    .result-box{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fbfcff;
      display:none;
    }
    .result-box h3{
      margin:0 0 8px 0;
      color:var(--blue);
      font-size:16px;
    }

    /* Confirm overlay */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,0.25);
      padding:16px;
      border:1px solid rgba(0,0,0,0.08);
    }
    .modal h3{margin:0;color:var(--blue);}
    .modal p{margin:8px 0 12px 0;color:var(--ink);line-height:1.5;}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}

    /* =========================
       PDF Export (offscreen pages)
       ========================= */
    .export-root{
      position:fixed;
      left:-99999px;
      top:0;
      width:210mm;
      height:auto;
      overflow:hidden;
      background:#fff;
    }
    .export-page{
      width:210mm;
      height:297mm;
      background:#fff;
      padding:12mm;
      box-sizing:border-box;
      position:relative;
    }
    .export-header{
      height:20mm;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10mm;
    }
    .export-title{
      font-weight:1000;
      font-size:16px;
      color:#111;
      line-height:1.1;
    }
    .export-sub{
      margin-top:2mm;
      font-size:11px;
      color:#555;
      font-weight:900;
      line-height:1.25;
    }
    .export-content{
      height: calc(297mm - 12mm - 12mm - 20mm);
      overflow:hidden;
    }
    .export-qgrid{
      width:100%;
      height:100%;
      display:grid;
      min-height:0;
    }
    .export-qgrid.two{
      grid-template-columns:1fr;
      grid-auto-rows:minmax(0, 1fr);
      gap:8mm;
    }
    .export-qgrid.three{
      grid-template-columns:1fr;
      grid-auto-rows:minmax(0, 1fr);
      gap:4mm;
    }
    .export-qgrid.six{
      grid-template-columns:1fr 1fr;
      grid-auto-rows:minmax(0, 1fr);
      gap:5mm;
    }
    .export-q{
      border:1px solid #ddd;
      border-radius:10px;
      padding:6mm;
      display:flex;
      flex-direction:column;
      gap:3mm;
      min-height:0;
      overflow:hidden;
    }
    .export-q .qprompt{
      font-weight:900;
      font-size:12px;
      color:#111;
      line-height:1.2;
    }
    .export-qgrid.six .qprompt{font-size:11px;}

    .export-diagram{
      border:1px solid #e6e6e6;
      border-radius:9px;
      padding:3mm;
      flex:1;
      min-height:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .export-diagram svg{
      width:100%;
      height:100%;
      max-height:100%;
      display:block;
      overflow:visible;
    }
    .export-diagram .svg-note{ display:none !important; }

    .export-answerline{
      margin-top:2mm;
      font-size:12px;
      font-weight:900;
      color:#111;
    }
    .export-answerline span{
      display:inline-block;
      border-bottom:1px solid #111;
      min-width:62mm;
      height:0.95em;
      vertical-align:baseline;
    }
    .export-qgrid.six .export-answerline{font-size:11px;}
    .export-qgrid.six .export-answerline span{min-width:35mm;}

    .answers-list{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:4mm 10mm;
      align-content:start;
      font-size:13px;
      font-weight:900;
      color:#111;
    }
    .answers-note{
      margin-top:3mm;
      font-size:11px;
      color:#666;
      font-weight:900;
    }
  </style>
</head>

<body>
  <div class="quiz-container">
    <div id="headerLogo">
      <div class="logo-icon" aria-hidden="true"></div>
      <div class="header-text">
        <h1 id="pageTitle">Arithmetic Sequences (AP)</h1>
        <div class="sub" id="pageSubtitle">Learn • Practice • Timer • PDF export</div>
      </div>
    </div>

    <!-- TOP BAR -->
    <div class="row">
      <div class="pill">
        <b>Student:</b>
        <span id="studentNameValue" class="muted">DYAA</span>
        <span class="muted">•</span>
        <b>Time:</b>
        <span id="timerValue">00:00</span>
        <span id="timerStatus" class="muted" style="font-weight:900;"></span>
        
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="pill">
          <b>PDF per page</b>
          <select id="pdfPerPage" class="select" aria-label="PDF per page">
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="6">6</option>
          </select>
        </div>

        <button class="btn orange" id="pauseBtn" type="button">Pause</button>
        <button class="btn orange" id="newSetBtn" type="button">Generate New Set</button>
        <button class="btn purple" id="exportLearnBtn" type="button">Export Learn PDF</button>
        <button class="btn purple" id="exportQuestionsBtn" type="button">Export Questions PDF</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="learn" type="button">Learn</button>
      <button class="tab" data-tab="practice" type="button">Practice</button>
    </div>

    <!-- LEARN -->

    <div class="panel active" id="panel-learn">

      <div class="learn-card">
        <h2>Arithmetic Sequences — Review</h2>

        <div id="learnSvgWrap" class="learn-svg-wrap" aria-hidden="false"></div>

        <p>
          An <b>arithmetic sequence</b> (also called an <b>arithmetic progression</b>, AP) is a sequence where each term is
          made by adding the same number each time.
          That number is the <b>common difference</b>, written as <b>d</b>.
        </p>

        <div class="learn-grid">
          <div>
            <h3>Key ideas</h3>
            <ul class="learn-ul">
              <li><b>First term:</b> a<sub>1</sub></li>
              <li><b>Common difference:</b> d = a<sub>n</sub> − a<sub>n−1</sub></li>
              <li><b>nth term:</b> a<sub>n</sub> = a<sub>1</sub> + (n−1)d</li>
              <li><b>Sum of first n terms:</b> S<sub>n</sub> = n/2 × (2a<sub>1</sub> + (n−1)d)</li>
            </ul>

            <div class="note">
              <b>Order of steps (typical):</b><br/>
              1) Identify a<sub>1</sub> and d (or find them from given terms).<br/>
              2) Use the nth-term formula to find a term, or use the sum formula to find S<sub>n</sub>.<br/>
              3) For word problems, define what the “term” represents (row, week, layer, etc.).
            </div>
          </div>

          <div>
            <h3>Quick checks</h3>
            <table class="mini-table" aria-label="Quick checks table">
              <thead>
                <tr><th>Question</th><th>What to use</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td>Find a specific term (e.g., a<sub>20</sub>)</td>
                  <td>Use a<sub>n</sub> = a<sub>1</sub> + (n−1)d</td>
                </tr>
                <tr>
                  <td>Find total of first n terms</td>
                  <td>Use S<sub>n</sub> = n/2 × (2a<sub>1</sub> + (n−1)d)</td>
                </tr>
                <tr>
                  <td>Given two terms like a<sub>p</sub> and a<sub>q</sub></td>
                  <td>Solve for d, then a<sub>1</sub></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <hr class="sep"/>

        <h3>Worked examples</h3>

        <div class="example">
          <h4>Example 1 — nth term (direct)</h4>
          <p>
            The sequence starts at 7 and increases by 4 each time: 7, 11, 15, 19, ...<br/>
            Find a<sub>12</sub>.
          </p>
          <div class="work">
            a<sub>1</sub> = 7, d = 4<br/>
            a<sub>12</sub> = a<sub>1</sub> + (12−1)d = 7 + 11×4 = 7 + 44 = 51
          </div>
          <div class="answer-line"><b>Answer:</b> a<sub>12</sub> = 51</div>
        </div>

        <div class="example">
          <h4>Example 2 — sum of first n terms</h4>
          <p>
            A savings plan starts at $10 in week 1 and increases by $3 each week.<br/>
            Find the total saved in the first 20 weeks.
          </p>
          <div class="work">
            a<sub>1</sub> = 10, d = 3, n = 20<br/>
            S<sub>20</sub> = 20/2 × (2×10 + 19×3)<br/>
            = 10 × (20 + 57) = 10 × 77 = 770
          </div>
          <div class="answer-line"><b>Answer:</b> $770</div>
        </div>

        <div class="example">
          <h4>Example 3 — find d and a<sub>1</sub>, then solve</h4>
          <p>
            In an arithmetic sequence, a<sub>4</sub> = 19 and a<sub>11</sub> = 54.<br/>
            Find a<sub>1</sub> and d, then find S<sub>12</sub>.
          </p>
          <div class="work">
            a<sub>4</sub> = a<sub>1</sub> + 3d = 19<br/>
            a<sub>11</sub> = a<sub>1</sub> + 10d = 54<br/><br/>
            Subtract: (a<sub>1</sub>+10d) − (a<sub>1</sub>+3d) = 54 − 19 ⇒ 7d = 35 ⇒ d = 5<br/>
            Then a<sub>1</sub> = 19 − 3×5 = 4<br/><br/>
            S<sub>12</sub> = 12/2 × (2×4 + 11×5) = 6 × (8 + 55) = 6 × 63 = 378
          </div>
          <div class="answer-line"><b>Answer:</b> a<sub>1</sub>=4, d=5, S<sub>12</sub>=378</div>
        </div>

        <div class="note" style="margin-top:12px;">
          <b>Tip:</b> Always label what “term number” means in context (row number, week number, layer number, etc.).
        </div>
      </div>

    </div>

    <div class="panel" id="panel-practice">
      <div class="row" style="margin-top:6px;">
        <div class="pill">
          <b>Instructions:</b>
          <span class="muted" id="instructionsText">Enter your answer as an integer (e.g., 51).</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ghost" id="submitBtn" type="button">Submit & View Results</button>
          <button class="btn ghost" id="saveBtn" type="button">Save Current Result (TXT)</button>
          <button class="btn danger" id="resetBtn" type="button">Reset Answers</button>
        </div>
      </div>

      <div class="q-list" id="questionList"></div>

      <div class="result-box" id="resultsBox">
        <h3>Results</h3>
        <div id="resultsSummary" class="muted"></div>
      </div>
    </div>
  </div>

  <!-- Confirm overlay -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>Confirm</h3>
      <p id="overlayMsg"></p>
      <div class="actions">
        <button class="btn ghost" id="overlayCancel" type="button">Cancel</button>
        <button class="btn" id="overlayOk" type="button">Confirm</button>
      </div>
    </div>
  </div>

  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /********************
     * META
     ********************/
    const TEMPLATE_META = {
      title: "Arithmetic Sequences — nth term & sum — DYAA",
      subtitle: "Learn • Practice • Timer • PDF export",
      filePrefix: "DYAA_Arithmetic_Sequences",
      instructions: "Enter your answer as an integer (example: 51). Commas are allowed (example: 1,512)."
    };

    /********************
     * Helpers
     ********************/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function randint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function safeName(s){
      if(!s) return "";
      return String(s).replace(/[<>]/g,"").trim().slice(0,40);
    }
    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/\"/g,"&quot;");
    }

    /********************
     * Answer parsing (integer)
     ********************/
    function parseIntAnswer(input){
      if(input == null) return null;
      let s = String(input).trim();
      if(!s) return null;
      s = s.replace(/,/g, "");
      if(!/^[-+]?\d+$/.test(s)) return null;
      const n = Number(s);
      if(!Number.isSafeInteger(n)) return null;
      return n;
    }

    function formatAnswer(n){
      if(n == null || !Number.isFinite(Number(n))) return "?";
      try{
        return Number(n).toLocaleString('en-NZ');
      }catch{
        return String(n);
      }
    }

    function stripSvgNote(html){
      return String(html).replace(/<div class=\"svg-note\">[\s\S]*?<\/div>/g, "");
    }

    /********************
     * Confirm overlay
     ********************/
    const overlay = $("#overlay");
    const overlayMsg = $("#overlayMsg");
    const overlayOk = $("#overlayOk");
    const overlayCancel = $("#overlayCancel");
    let overlayOnOk = null;

    function confirmDialog(message, onOk){
      overlayMsg.textContent = message;
      overlay.style.display = "flex";
      overlayOnOk = onOk;
    }
    overlayCancel.addEventListener("click", () => {
      overlay.style.display = "none";
      overlayOnOk = null;
    });
    overlayOk.addEventListener("click", () => {
      overlay.style.display = "none";
      const fn = overlayOnOk;
      overlayOnOk = null;
      if(typeof fn === "function") fn();
    });

    /********************
     * Timer + Pause/Resume
     ********************/
    const TIMER = { seconds: 0, running: true, id: null };
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatTime(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${pad2(m)}:${pad2(s)}`;
    }
    function updateTimerUI(){
      $("#timerValue").textContent = formatTime(TIMER.seconds);
      $("#timerStatus").textContent = TIMER.running ? "" : "(Paused)";
      $("#pauseBtn").textContent = TIMER.running ? "Pause" : "Resume";
    }
    function startTimerTick(){
      if(TIMER.id) clearInterval(TIMER.id);
      TIMER.id = setInterval(() => {
        if(TIMER.running){
          TIMER.seconds += 1;
          updateTimerUI();
        }
      }, 1000);
    }
    function resetTimer(){
      TIMER.seconds = 0;
      TIMER.running = true;
      updateTimerUI();
    }
    function togglePause(){
      TIMER.running = !TIMER.running;
      updateTimerUI();
    }
    $("#pauseBtn").addEventListener("click", togglePause);

    /********************
     * SVG builders (text diagram)
     ********************/
    function wrapLines(text, maxLen=34){
      const words = String(text).split(/\s+/);
      const lines = [];
      let cur = "";
      for(const w of words){
        if(!cur) { cur = w; continue; }
        if((cur + " " + w).length <= maxLen){
          cur += " " + w;
        }else{
          lines.push(cur);
          cur = w;
        }
      }
      if(cur) lines.push(cur);
      return lines;
    }

    function textCardSvg(title, lines){
      const all = [];
      all.push(...wrapLines(title, 30).map(s=>({t:s, kind:"title"})));
      all.push({t:"", kind:"spacer"});
      for(const ln of lines){
        const ws = wrapLines(ln, 36);
        ws.forEach(s=>all.push({t:s, kind:"line"}));
      }

      let y = 26;
      const dy = 18;

      const textEls = all.map(row=>{
        if(row.kind==="spacer"){ y += 8; return ""; }
        let style;
        if(row.kind==="title"){
          style = "font: 15px 'Segoe UI', Tahoma, sans-serif; font-weight: 1000; fill: #0d47a1;";
        }else{
          const isMath = /[!P\(\)]/.test(String(row.t));
          style = isMath
            ? "font: 16px 'Segoe UI', Tahoma, sans-serif; font-weight: 1000; fill: #111;"
            : "font: 14px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill: rgba(0,0,0,0.78);";
        }
        const t = escapeHtml(row.t);
        const el = `<text x=\"14\" y=\"${y}\" style=\"${style}\">${t}</text>`;
        y += dy;
        return el;
      }).join("");

      const height = Math.max(160, y + 12);

      const svg = `
        <svg viewBox=\"0 0 360 ${height}\" preserveAspectRatio=\"xMidYMid meet\" role=\"img\" aria-label=\"Text diagram\">
          <rect x=\"6\" y=\"6\" width=\"348\" height=\"${height-12}\" rx=\"14\" fill=\"#ffffff\" stroke=\"var(--stroke)\" stroke-width=\"1.5\"></rect>
          <rect x=\"6\" y=\"6\" width=\"348\" height=\"34\" rx=\"14\" fill=\"rgba(13,71,161,0.06)\" stroke=\"none\"></rect>
          ${textEls}
        </svg>
      `;
      return svg;
    }

    /********************
     * Permutation math
     ********************/
    function factorial(n){
      if(n < 0) return NaN;
      let r = 1;
      for(let i=2;i<=n;i++) r *= i;
      return r;
    }

    function nPr(n, r){
      if(r < 0 || r > n) return 0;
      let p = 1;
      for(let k=0;k<r;k++) p *= (n - k);
      return p;
    }


    function nCr(n, r){
      if(r < 0 || r > n) return 0;
      r = Math.min(r, n - r);
      if(r === 0) return 1;
      let num = 1;
      let den = 1;
      for(let i=1;i<=r;i++){
        num *= (n - (r - i));
        den *= i;
      }
      return Math.round(num / den);
    }

    /********************
     * Question generators
     * - 2 simple (arrange all)  => n!
     * - 2 two-step (choose & order) => P(n,r)
     * - 2 multi-step (restrictions)
     ********************/

    const NAMES = [
      "Ava","Ben","Chloe","Dylan","Ethan","Fiona","Grace","Henry","Isla","Jack",
      "Kylie","Leo","Mia","Noah","Olivia","Pablo","Quinn","Ruby","Sofia","Theo",
      "Uma","Violet","Will","Zoe"
    ];

    function pickTwoNames(){
      const a = choice(NAMES);
      let b = choice(NAMES);
      while(b === a) b = choice(NAMES);
      return [a,b];
    }

    const SIMPLE_SCENARIOS = [
      { plural:"books", place:"on a shelf" },
      { plural:"photos", place:"in a row on a wall" },
      { plural:"trophies", place:"on a display table" },
      { plural:"flags", place:"along a line" },
      { plural:"students", place:"in a single line" },
      { plural:"cards", place:"in a row" }
    ];

    

/********************
     * Arithmetic Sequences: question generators
     * Answers are integers.
     * Use subscript notation like a₁, a₁₂, Sₙ (avoid parentheses indexing).
     ********************/

    // Unicode subscript digits
    const SUB_DIGITS = { "0":"₀","1":"₁","2":"₂","3":"₃","4":"₄","5":"₅","6":"₆","7":"₇","8":"₈","9":"₉","-":"₋","+":"₊" };
    function subNum(n){
      return String(n).split("").map(ch => SUB_DIGITS[ch] || ch).join("");
    }
    function aSub(n){ return `a${subNum(n)}`; }
    function SSub(n){ return `S${subNum(n)}`; }

    const A1 = "a₁";
    const An = "aₙ";
    const Sn = "Sₙ";

    function qNthDirect(){
      // Find a_n given a1, d, n
      const a1 = randint(-12, 30);
      let d = randint(-9, 9);
      while(d === 0) d = randint(-9, 9);
      const n = randint(6, 28);

      const ans = a1 + (n-1)*d;
      const prompt = `An arithmetic sequence has ${A1} = ${a1} and common difference d = ${d}. Find ${aSub(n)}.`;
      const hint = `Use ${An} = ${A1} + (n−1)d. Here: ${aSub(n)} = ${a1} + (${n}−1)×${d}.`;
      return { difficulty:"easy", prompt, hint, answer: ans };
    }

    function qFindDFromTwoTerms(){
      // Find d given a_p and a_q
      let d = randint(2, 12);
      if(Math.random() < 0.25) d = -d;
      const a1 = randint(-15, 25);

      const p = randint(3, 8);
      const q = randint(p+3, p+12);
      const ap = a1 + (p-1)*d;
      const aq = a1 + (q-1)*d;

      const prompt = `In an arithmetic sequence, ${aSub(p)} = ${ap} and ${aSub(q)} = ${aq}. Find the common difference d.`;
      const hint = `${aSub(q)} − ${aSub(p)} = (q−p)d, so d = (${aq} − ${ap}) / (${q} − ${p}).`;
      return { difficulty:"easy", prompt, hint, answer: d };
    }

    function qFindA1FromAn(){
      // Given a_n, d, n, find a1
      let d = randint(2, 10);
      if(Math.random() < 0.25) d = -d;
      const a1 = randint(-12, 25);
      const n = randint(6, 24);
      const an = a1 + (n-1)*d;

      const prompt = `An arithmetic sequence has common difference d = ${d} and ${aSub(n)} = ${an}. Find ${A1}.`;
      const hint = `Rearrange: ${An} = ${A1} + (n−1)d ⇒ ${A1} = ${An} − (n−1)d.`;
      return { difficulty:"easy", prompt, hint, answer: a1 };
    }

    function qSumDirect(){
      // Find S_n given a1, d, n (ensure integer)
      const a1 = randint(1, 20);
      let d = randint(1, 12);
      if(Math.random() < 0.2) d = -d;
      let n = randint(8, 30);

      function SnVal(n){
        return n*(2*a1 + (n-1)*d)/2;
      }
      // Ensure integer sum
      let guard=0;
      while(!Number.isInteger(SnVal(n)) && guard<80){
        n = randint(8, 30);
        guard++;
      }
      const ans = SnVal(n);

      const prompt = `An arithmetic sequence has ${A1} = ${a1} and d = ${d}. Find ${SSub(n)} (the sum of the first ${n} terms).`;
      const hint = `Use ${Sn} = n/2 × (2${A1} + (n−1)d).`;
      return { difficulty:"medium", prompt, hint, answer: ans };
    }

    function qFindNFromAn(){
      // Given a1, d, and a_n, find n (exact)
      const a1 = randint(-10, 18);
      let d = randint(2, 10);
      if(Math.random() < 0.2) d = -d;

      const n = randint(6, 25);
      const an = a1 + (n-1)*d;

      const prompt = `An arithmetic sequence has ${A1} = ${a1} and d = ${d}. If ${An} = ${an}, find n.`;
      const hint = `Solve ${An} = ${A1} + (n−1)d for n.`;
      return { difficulty:"medium", prompt, hint, answer: n };
    }

    function qNthFromTwoTerms(){
      // Two-step: find d and/or a1 from two terms, then find a_k
      let d = randint(2, 9);
      if(Math.random() < 0.25) d = -d;
      const a1 = randint(-15, 25);

      const p = randint(2, 6);
      const q = randint(p+3, p+12);
      const k = randint(q+1, q+10);

      const ap = a1 + (p-1)*d;
      const aq = a1 + (q-1)*d;
      const ak = a1 + (k-1)*d;

      const prompt = `In an arithmetic sequence, ${aSub(p)} = ${ap} and ${aSub(q)} = ${aq}. Find ${aSub(k)}.`;
      const hint = `Find d = (${aq} − ${ap})/(${q}−${p}), then use ${An} = ${A1} + (n−1)d to get ${aSub(k)}.`;
      return { difficulty:"medium", prompt, hint, answer: ak };
    }

    function qFindDFromA1An(){
      // Given a1 and a_n, find d
      const a1 = randint(-8, 20);
      const n = randint(7, 25);
      let d = randint(1, 9);
      if(Math.random() < 0.25) d = -d;
      const an = a1 + (n-1)*d;

      const prompt = `An arithmetic sequence has ${A1} = ${a1} and ${aSub(n)} = ${an}. Find the common difference d.`;
      const hint = `Use ${aSub(n)} = ${A1} + (${n}−1)d ⇒ d = (${an} − ${a1})/(${n}−1).`;
      return { difficulty:"medium", prompt, hint, answer: d };
    }

    /********************
     * Application question templates (expanded)
     ********************/
    const AP_CONTEXTS = [
      { place:"Row", unit:"seats", verb:"has", more:"more", dir: 1 },
      { place:"Step", unit:"tiles", verb:"uses", more:"more", dir: 1 },
      { place:"Week", unit:"pages", verb:"reads", more:"more", dir: 1 },
      { place:"Day", unit:"minutes", verb:"practises", more:"more", dir: 1 },
      { place:"Year", unit:"trees", verb:"plants", more:"more", dir: 1 },
      { place:"Level", unit:"points", verb:"earns", more:"more", dir: 1 },
      { place:"Layer", unit:"bricks", verb:"contains", more:"fewer", dir:-1 },
      { place:"Day", unit:"candles", verb:"uses", more:"fewer", dir:-1 },
      { place:"Round", unit:"stickers", verb:"collects", more:"more", dir: 1 },
      { place:"Session", unit:"laps", verb:"swims", more:"more", dir: 1 },
      { place:"Month", unit:"dollars", verb:"saves", more:"more", dir: 1 },
      { place:"Shipment", unit:"boxes", verb:"delivers", more:"more", dir: 1 },
      { place:"Stage", unit:"marbles", verb:"adds", more:"more", dir: 1 }
    ];

    function qAppNth(){
      // Application: find the term at position n
      const c = choice(AP_CONTEXTS);
      const first = randint(6, 35);
      let step = randint(2, 9);
      if(c.dir < 0) step = -step;

      const n = randint(10, 35);
      const ans = first + (n-1)*step;

      const prompt = `${c.place} 1 ${c.verb} ${first} ${c.unit}. Each next ${c.place.toLowerCase()} has ${Math.abs(step)} ${c.unit} ${c.more} than the previous one. How many ${c.unit} are in ${c.place.toLowerCase()} ${n}?`;
      const hint = `Model as an AP with ${A1}=${first}, d=${step}. Find ${aSub(n)}.`;
      return { difficulty:"hard", prompt, hint, answer: ans };
    }

    function qAppSum(){
      // Application: sum of first n terms
      const c = choice(AP_CONTEXTS);
      const first = randint(4, 25);
      let step = randint(1, 8);
      if(c.dir < 0) step = -step;

      let n = randint(12, 32);
      function SnVal(n){ return n*(2*first + (n-1)*step)/2; }
      let guard=0;
      while(!Number.isInteger(SnVal(n)) && guard<100){
        n = randint(12, 32);
        guard++;
      }
      const ans = SnVal(n);

      const prompt = `A person ${c.verb} ${first} ${c.unit} in ${c.place.toLowerCase()} 1. Each next ${c.place.toLowerCase()} has ${Math.abs(step)} ${c.unit} ${c.more} than the previous one. Find the total number of ${c.unit} over the first ${n} ${c.place.toLowerCase()}s.`;
      const hint = `Treat the amounts as an AP and use the sum formula ${Sn} = n/2 × (2${A1} + (n−1)d).`;
      return { difficulty:"hard", prompt, hint, answer: ans };
    }

    function qAppReachValue(){
      // Application: find n when the nth term reaches a target (exact)
      const c = choice(AP_CONTEXTS);
      const first = randint(5, 40);
      let step = randint(2, 10);
      if(c.dir < 0) step = -step;

      const n = randint(8, 28);
      const target = first + (n-1)*step;

      const prompt = `${c.place} 1 has ${first} ${c.unit}. Each next ${c.place.toLowerCase()} changes by ${step} ${c.unit} each time. On which ${c.place.toLowerCase()} number will it be ${target} ${c.unit}?`;
      const hint = `Solve ${An} = ${A1} + (n−1)d for n.`;
      return { difficulty:"hard", prompt, hint, answer: n };
    }

    function qAppPartialSum(){
      // Application: sum from term m to term n (inclusive)
      const c = choice(AP_CONTEXTS);
      const first = randint(6, 30);
      let step = randint(1, 8);
      if(c.dir < 0) step = -step;

      const m = randint(4, 10);
      const n = randint(m+6, m+18);

      function S(t){ return t*(2*first + (t-1)*step)/2; }
      const ans = S(n) - S(m-1);
      if(!Number.isInteger(ans)) return qAppPartialSum();

      const prompt = `${c.place} 1 has ${first} ${c.unit}. Each next ${c.place.toLowerCase()} changes by ${step} ${c.unit}. Find the total number of ${c.unit} from ${c.place.toLowerCase()} ${m} to ${c.place.toLowerCase()} ${n} (inclusive).`;
      const hint = `Use partial sums: total = ${SSub(n)} − ${SSub(m-1)}.`;
      return { difficulty:"hard", prompt, hint, answer: ans };
    }

    function qAppTwoSequencesMeet(){
      // Two APs: find n when values are equal (exact)
      const c = choice(AP_CONTEXTS);
      const firstA = randint(5, 25);
      const firstB = randint(firstA+5, firstA+20);

      let dA = randint(2, 8);
      let dB = randint(1, dA-1); // ensure A catches up
      if(Math.random() < 0.2){ dA = -dA; dB = -dB; } // both decreasing

      // Ensure solvable n: firstA + (n-1)dA = firstB + (n-1)dB
      // n-1 = (firstB-firstA)/(dA-dB)
      const denom = (dA - dB);
      const numer = (firstB - firstA);
      if(denom === 0 || numer % denom !== 0) return qAppTwoSequencesMeet();
      const n = numer/denom + 1;
      if(n < 4 || n > 30) return qAppTwoSequencesMeet();

      const prompt = `Two plans form arithmetic sequences.\nPlan A: ${A1} = ${firstA}, d = ${dA}.\nPlan B: ${A1} = ${firstB}, d = ${dB}.\nFor what value of n will the terms be equal?`;
      const hint = `Set the nth terms equal and solve for n: ${firstA} + (n−1)${dA} = ${firstB} + (n−1)${dB}.`;
      return { difficulty:"hard", prompt, hint, answer: n };
    }

    function qMultiGivenTermsThenSum(){
      // Multi-step: two terms -> find a1 and d -> then compute a sum
      let d = randint(2, 9);
      if(Math.random() < 0.25) d = -d;
      const a1 = randint(-6, 16);

      const p = randint(3, 8);
      const q = randint(p+4, p+12);

      const ap = a1 + (p-1)*d;
      const aq = a1 + (q-1)*d;

      const n = randint(q+1, q+10);

      const SnVal = n*(2*a1 + (n-1)*d)/2;
      if(!Number.isInteger(SnVal)) return qMultiGivenTermsThenSum();

      const prompt = `In an arithmetic sequence, ${aSub(p)} = ${ap} and ${aSub(q)} = ${aq}. Find ${SSub(n)} (the sum of the first ${n} terms).`;
      const hint = `First find d, then ${A1}, then use the sum formula.`;
      return { difficulty:"hard", prompt, hint, answer: SnVal };
    }

    

    /********************
     * NEW: Matchstick / stick pattern application questions
     * (All are arithmetic sequences with a₁ and constant difference.)
     ********************/

    function qAppSticksChainPolygon(){
      // Chain of regular polygons sharing one side each time.
      // Figure 1 uses s sticks, each new polygon adds (s-1) sticks.
      const sides = randint(3, 8);         // triangle to octagon
      const n = randint(8, 30);

      const a1 = sides;
      const d = sides - 1;
      const ans = a1 + (n-1)*d;

      const name = (sides===3) ? "equilateral triangles"
                 : (sides===4) ? "squares"
                 : (sides===5) ? "pentagons"
                 : (sides===6) ? "hexagons"
                 : (sides===7) ? "heptagons"
                 : "octagons";

      const prompt = `Matchsticks form a chain of ${name}. Figure 1 uses ${a1} sticks. Each new shape shares one side with the previous, so it needs ${d} more sticks each time. How many sticks are needed for Figure ${n}?`;
      const hint = `This is an AP: a₁=${a1}, d=${d}. Find a${subNum(n)} = a₁ + (n−1)d.`;
      const svg = textCardSvg("Matchstick Pattern", [
        `Figure 1: ${a1} sticks`,
        `Each next figure: +${d} sticks`,
        `Find Figure ${n}`
      ]);
      return { difficulty:"hard", prompt, hint, answer: ans, svg };
    }

    function qAppSticksGridFixedRows(){
      // Figure k is an m × k grid of unit squares made from sticks (including shared edges).
      // sticks = (k+1)m + (m+1)k = (2m+1)k + m  -> AP in k
      const m = randint(2, 4);     // fixed rows
      const k = randint(6, 18);    // figure number / columns

      const a1 = (2*m + 1)*1 + m;  // Figure 1
      const d = (2*m + 1);
      const ans = (2*m + 1)*k + m;

      const prompt = `A matchstick grid has ${m} rows of unit squares. Figure 1 is a ${m}×1 grid, Figure 2 is a ${m}×2 grid, and so on. How many sticks are needed for Figure ${k}? (Count all edges, including shared edges.)`;
      const hint = `Sticks form an AP with a₁=${a1}, d=${d}. So a${subNum(k)} = ${a1} + (${k}−1)×${d}.`;
      const svg = textCardSvg("Matchstick Grid", [
        `Rows fixed: ${m}`,
        `Figure k = ${m}×k squares`,
        `a₁=${a1}, d=${d}`,
        `Find Figure ${k}`
      ]);
      return { difficulty:"hard", prompt, hint, answer: ans, svg };
    }

    function qAppSticksBorderPerimeter(){
      // Perimeter (outline) of a 1×n row of unit squares built with sticks (outline only).
      // Perimeter sticks = 2n + 4  -> AP a1=6, d=2
      const n = randint(6, 30);
      const a1 = 4;
      const d = 2;
      const ans = 2*n + 2;

      const prompt = `A row of ${n} unit squares is placed side-by-side. If you only count the sticks on the outer boundary (the outline), how many sticks are needed?`;
      const hint = `Outline counts form an AP: a₁=4 (for 1 square), d=2 (each extra square increases the outline by 2). Find a${subNum(n)}.`;
      const svg = textCardSvg("Outline (Perimeter) Pattern", [
        "Outer boundary only",
        "Perimeter sticks: 2n + 2",
        `For n = ${n}`
      ]);
      return { difficulty:"hard", prompt, hint, answer: ans, svg };
    }

    function qAppSticksTotalForFirstN(){
      // Total sticks used across Figure 1 to Figure n for a chain of squares/triangles/polygons (sum of AP).
      const sides = choice([3,4,5,6]); // keep friendly
      const n = randint(8, 20);

      const a1 = sides;
      const d = sides - 1;
      const ans = n*(2*a1 + (n-1)*d)/2;

      const name = (sides===3) ? "triangles" : (sides===4) ? "squares" : (sides===5) ? "pentagons" : "hexagons";

      const prompt = `Matchsticks form a chain of ${name}. Figure 1 uses ${a1} sticks, and each next figure needs ${d} more sticks than the previous. Find the total number of sticks needed for Figures 1 to ${n} altogether.`;
      const hint = `This is the sum of an AP: Sₙ = n/2 × (2a₁ + (n−1)d). Here a₁=${a1}, d=${d}, n=${n}.`;
      const svg = textCardSvg("Total Sticks (Sum)", [
        `a₁=${a1}, d=${d}`,
        `Total for Figures 1→${n}`,
        "Use Sₙ formula"
      ]);
      return { difficulty:"hard", prompt, hint, answer: ans, svg };
    }



    function makeQuestions(){
      const used = new Set();
      const qs = [];

      function addWithRetries(gen, tries=260){
        for(let t=0;t<tries;t++){
          const q = gen();
          if(!q || !q.prompt) continue;
          if(used.has(q.prompt)) continue;
          if(!Number.isSafeInteger(q.answer)) continue;
          used.add(q.prompt);
          qs.push(q);
          return true;
        }
        return false;
      }

      const easy = [qNthDirect, qFindDFromTwoTerms, qFindA1FromAn];
      const medium = [qSumDirect, qFindNFromAn, qNthFromTwoTerms, qFindDFromA1An];

      // Hard pools
      const hardPatterns = [
        qAppSticksChainPolygon,
        qAppSticksGridFixedRows,
        qAppSticksBorderPerimeter,
        qAppSticksTotalForFirstN
      ];
      const hardOther = [
        qAppNth, qAppSum, qAppReachValue, qAppPartialSum, qAppTwoSequencesMeet, qMultiGivenTermsThenSum
      ];
      const hardAll = [...hardPatterns, ...hardOther];

      // 8 questions (same layout):
      // 3 easy, 3 medium, 2 hard (at least 1 hard is a stick/pattern application)
      addWithRetries(()=>choice(easy)());
      addWithRetries(()=>choice(easy)());
      addWithRetries(()=>choice(easy)());

      addWithRetries(()=>choice(medium)());
      addWithRetries(()=>choice(medium)());
      addWithRetries(()=>choice(medium)());

      // Guarantee at least one matchstick/pattern hard question
      addWithRetries(()=>choice(hardPatterns)(), 520);
      addWithRetries(()=>choice(hardAll)(), 520);

      // Fill if needed
      const all = shuffle([...easy, ...medium, ...hardAll].map(fn => () => fn()));
      let guard = 0;
      while(qs.length < 8 && guard < 1400){
        addWithRetries(all[guard % all.length], 360);
        guard += 1;
      }

      return qs.slice(0,8);
    }



    /********************
     * UI state + rendering
     ********************/
    let QUESTIONS = [];
    let STATE = { answers:[], checked:[], correct:[], hintShown:[], submitted:false };

    function badgeClass(d){
      if(d==="easy") return "badge easy";
      if(d==="medium") return "badge medium";
      return "badge hard";
    }
    function niceDiff(d){
      if(d==="easy") return "Easy";
      if(d==="medium") return "Medium";
      return "Hard";
    }

    function renderQuestions(){
      const list = $("#questionList");
      list.innerHTML = "";

      QUESTIONS.forEach((q, idx) => {
        const card = document.createElement("div");
        card.className = "q-card";

        const userVal = STATE.answers[idx] ?? "";
        const checked = !!STATE.checked[idx];
        const correct = !!STATE.correct[idx];
        const hintShown = !!STATE.hintShown[idx];

        card.innerHTML = `
          <div class=\"q-top\">
            <h3 class=\"q-title\">Q${idx+1}. ${escapeHtml(q.prompt)}</h3>
            <span class=\"${badgeClass(q.difficulty)}\">${niceDiff(q.difficulty)}</span>
          </div>

          <div class=\"q-body\">
            <div class=\"svg-wrap\">${q.svg || ""}</div>

            <div class=\"answer-area\">
              <div class=\"input-row\">
                <input type=\"text\" autocomplete=\"off\"
                  id=\"ans-${idx}\" placeholder=\"Answer (integer) e.g., 720\"
                  value=\"${escapeHtml(userVal)}\">
                <button class=\"btn ghost\" type=\"button\" id=\"check-${idx}\">Check</button>
                <button class=\"btn ghost\" type=\"button\" id=\"hint-${idx}\">${hintShown ? "Hide Hint" : "Hint"}</button>
              </div>

              <div class=\"hint-box ${hintShown ? "show" : ""}\" id=\"hintBox-${idx}\">
                ${escapeHtml(q.hint || "")}
              </div>

              <div class=\"feedback ${checked ? (correct ? "ok" : "bad") : ""}\" id=\"fb-${idx}\">
                ${checked
                  ? (correct
                      ? "Correct ✅"
                      : `Not correct ❌  (Correct answer: ${escapeHtml(formatAnswer(q.answer))})`)
                  : ""}
              </div>
            </div>
          </div>
        `;

        list.appendChild(card);

        const inp = $("#ans-"+idx, card);
        inp.addEventListener("input", () => {
          STATE.answers[idx] = inp.value;
          STATE.checked[idx] = false;
          STATE.correct[idx] = false;
          if(STATE.submitted){
            STATE.submitted = false;
            $("#resultsBox").style.display = "none";
          }
          const fb = $("#fb-"+idx, card);
          fb.className = "feedback";
          fb.textContent = "";
        });

        $("#check-"+idx, card).addEventListener("click", () => checkOne(idx));
        $("#hint-"+idx, card).addEventListener("click", () => {
          STATE.hintShown[idx] = !STATE.hintShown[idx];
          renderQuestions();
        });
      });

      $("#resultsBox").style.display = "none";
    }

    function checkOne(idx){
      const q = QUESTIONS[idx];
      const v = parseIntAnswer(STATE.answers[idx]);
      STATE.checked[idx] = true;

      if(v === null){
        STATE.correct[idx] = false;
        renderQuestions();
        const fb = $("#fb-"+idx);
        fb.className = "feedback bad";
        fb.textContent = "Please enter a valid integer (commas are allowed).";
        return;
      }

      STATE.correct[idx] = (v === q.answer);
      renderQuestions();
    }

    function submitAll(){
      let correctCount = 0;

      for(let i=0;i<QUESTIONS.length;i++){
        const q = QUESTIONS[i];
        const v = parseIntAnswer(STATE.answers[i]);
        STATE.checked[i] = true;
        STATE.correct[i] = (v !== null && v === q.answer);
        if(STATE.correct[i]) correctCount++;
      }

      STATE.submitted = true;
      renderQuestions();

      const total = QUESTIONS.length;
      const pct = total ? Math.round((correctCount/total)*100) : 0;

      const lines = QUESTIONS.map((q,i)=>(
        `<div style=\"margin:6px 0;\"><b>Q${i+1}:</b> ${escapeHtml(formatAnswer(q.answer))}</div>`
      )).join("");

      $("#resultsSummary").innerHTML = `
        <div><b>Score:</b> ${correctCount} / ${total} (${pct}%)</div>
        <div class=\"muted\" style=\"margin-top:8px;\"><b>Correct Answers:</b></div>
        <div style=\"margin-top:6px;\">${lines}</div>
      `;
      $("#resultsBox").style.display = "block";
      window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
    }

    function resetAnswers(){
      STATE.answers = Array(QUESTIONS.length).fill("");
      STATE.checked = Array(QUESTIONS.length).fill(false);
      STATE.correct = Array(QUESTIONS.length).fill(false);
      STATE.hintShown = Array(QUESTIONS.length).fill(false);
      STATE.submitted = false;
      renderQuestions();
    }

    /********************
     * Save Current Result as TXT
     ********************/
    function saveResult(){
      const title = TEMPLATE_META.title;
      const student = safeName($("#studentNameValue").textContent) || "Student";
      const when = new Date();
      const dateStr = when.toLocaleString();
      const elapsed = formatTime(TIMER.seconds);

      let correctCount = 0;
      const out = [];

      out.push(`DYAA — Save Current Result`);
      out.push(`Title: ${title}`);
      out.push(`Student: ${student}`);
      out.push(`Date: ${dateStr}`);
      out.push(`Elapsed Time: ${elapsed}`);
      out.push("");

      QUESTIONS.forEach((q, i) => {
        const raw = (STATE.answers[i] ?? "").toString().trim();
        const v = parseIntAnswer(raw);
        const valid = (v !== null);
        const isCorrect = valid && (v === q.answer);
        if(isCorrect) correctCount++;

        out.push(`Q${i+1} (${String(q.difficulty||"").toUpperCase()}): ${q.prompt}`);
        out.push(`Your answer: ${valid ? formatAnswer(v) : (raw ? raw : "(blank)")}`);
        out.push(`Correct answer: ${formatAnswer(q.answer)}`);
        out.push(`Result: ${isCorrect ? "Correct" : "Not correct"}`);
        out.push("");
      });

      const total = QUESTIONS.length;
      const pct = total ? Math.round((correctCount/total)*100) : 0;
      out.splice(5, 0, `Score: ${correctCount} / ${total} (${pct}%)`);

      const text = out.join("\r\n");
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${TEMPLATE_META.filePrefix}_${student.replace(/\s+/g,"_")}_result.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /********************
     * Tabs + Student name
     ********************/
    $$(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        $$(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        const tab = btn.getAttribute("data-tab");
        $$(".panel").forEach(p=>p.classList.remove("active"));
        $("#panel-"+tab).classList.add("active");
      });
    });

    function ensureStudentName(){
      const fromUrl = safeName(getParam("name"));
      if(fromUrl){
        $("#studentNameValue").textContent = fromUrl;
        return;
      }
      const defaultName = "DYAA";
      const name = safeName(prompt("Enter student name:", defaultName));
      $("#studentNameValue").textContent = name ? name : defaultName;
    }

    /********************
     * Generate New Set (resets timer)
     ********************/
    function generateNewSet(){
      QUESTIONS = makeQuestions();

      STATE.answers = Array(QUESTIONS.length).fill("");
      STATE.checked = Array(QUESTIONS.length).fill(false);
      STATE.correct = Array(QUESTIONS.length).fill(false);
      STATE.hintShown = Array(QUESTIONS.length).fill(false);
      STATE.submitted = false;

      resetTimer();
      renderQuestions();
    }

    $("#newSetBtn").addEventListener("click", ()=>{
      confirmDialog("Generate a new set? This will clear your current answers and reset the timer.", () => {
        generateNewSet();
        // go to practice
        $$(".tab").forEach(b=>b.classList.remove("active"));
        $('.tab[data-tab="practice"]').classList.add('active');
        $$(".panel").forEach(p=>p.classList.remove("active"));
        $("#panel-practice").classList.add("active");
      });
    });

    $("#submitBtn").addEventListener("click", submitAll);
    $("#resetBtn").addEventListener("click", ()=>{
      confirmDialog("Reset all answers for the current set?", resetAnswers);
    });
    $("#saveBtn").addEventListener("click", saveResult);

    /********************
     * Learn diagram
     ********************/
    function renderLearnDiagram(){
      const el = $("#learnSvgWrap");
      if(!el) return;

      const svg = `
        <svg viewBox="0 0 360 240" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Arithmetic sequence quick map">
          <defs>
            <marker id="arr" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <path d="M0,0 L9,3 L0,6 Z" fill="rgba(0,0,0,0.55)"></path>
            </marker>
          </defs>

          <rect x="8" y="10" width="344" height="220" rx="18" fill="#fff" stroke="rgba(0,0,0,0.12)" stroke-width="1.5"></rect>
          <rect x="8" y="10" width="344" height="36" rx="18" fill="rgba(13,71,161,0.06)"></rect>
          <text x="20" y="34" style="font: 15px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill:#0d47a1;">
            Arithmetic Sequence Quick Map
          </text>

          <!-- Term boxes -->
          <g>
            <rect x="22" y="64" width="88" height="44" rx="12" fill="#f5f8ff" stroke="rgba(13,71,161,0.22)"></rect>
            <rect x="136" y="64" width="88" height="44" rx="12" fill="#f5f8ff" stroke="rgba(13,71,161,0.22)"></rect>
            <rect x="250" y="64" width="88" height="44" rx="12" fill="#f5f8ff" stroke="rgba(13,71,161,0.22)"></rect>

            <text x="66" y="92" text-anchor="middle" style="font: 14px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill:#0d47a1;">a₁</text>
            <text x="180" y="92" text-anchor="middle" style="font: 14px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill:#0d47a1;">a₂</text>
            <text x="294" y="92" text-anchor="middle" style="font: 14px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill:#0d47a1;">a₃</text>

            <line x1="110" y1="86" x2="136" y2="86" stroke="rgba(0,0,0,0.55)" stroke-width="1.6" marker-end="url(#arr)"></line>
            <line x1="224" y1="86" x2="250" y2="86" stroke="rgba(0,0,0,0.55)" stroke-width="1.6" marker-end="url(#arr)"></line>

            <text x="123" y="76" text-anchor="middle" style="font: 12px 'Segoe UI', Tahoma, sans-serif; font-weight: 800; fill: rgba(0,0,0,0.55);">+ d</text>
            <text x="237" y="76" text-anchor="middle" style="font: 12px 'Segoe UI', Tahoma, sans-serif; font-weight: 800; fill: rgba(0,0,0,0.55);">+ d</text>
          </g>

          <!-- Formulas -->
          <g>
            <rect x="22" y="124" width="316" height="84" rx="14" fill="rgba(255,152,0,0.08)" stroke="rgba(255,152,0,0.30)"></rect>

            <text x="34" y="150" style="font: 13px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill:#b45f06;">
              nth term:
            </text>
            <text x="118" y="150" style="font: 13px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill:#222;">
              aₙ = a₁ + (n−1)d
            </text>

            <text x="34" y="176" style="font: 13px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill:#b45f06;">
              sum:
            </text>
            <text x="118" y="176" style="font: 13px 'Segoe UI', Tahoma, sans-serif; font-weight: 900; fill:#222;">
              Sₙ = n/2 × (2a₁ + (n−1)d)
            </text>

            <text x="34" y="202" style="font: 12px 'Segoe UI', Tahoma, sans-serif; font-weight: 800; fill: rgba(0,0,0,0.55);">
              Tip: identify a₁ and d first, then choose the right formula.
            </text>
          </g>
        </svg>
      `;
      el.innerHTML = svg;
    }

    /********************
     * Export Questions PDF
     ********************/
    function layoutClass(perPage){
      if(perPage === 6) return "six";
      if(perPage === 3) return "three";
      return "two";
    }

    function buildQuestionPageDOM(indexGroup, perPage, meta){
      const page = document.createElement("div");
      page.className = "export-page";

      const header = document.createElement("div");
      header.className = "export-header";
      header.innerHTML = `
        <div>
          <div class=\"export-title\">${escapeHtml(meta.title)}</div>
          <div class=\"export-sub\">
            Student: ${escapeHtml(meta.student)} • Date: ${escapeHtml(meta.dateStr)} • Time: ${escapeHtml(meta.timeStr)}
          </div>
        </div>
      `;

      const content = document.createElement("div");
      content.className = "export-content";

      const grid = document.createElement("div");
      grid.className = `export-qgrid ${layoutClass(perPage)}`;

      indexGroup.forEach(i => {
        const q = QUESTIONS[i];
        const box = document.createElement("div");
        box.className = "export-q";
        box.innerHTML = `
          <div class=\"qprompt\">Q${i+1}. ${escapeHtml(q.prompt)}</div>
          <div class=\"export-diagram\">${stripSvgNote(q.svg || "")}</div>
          <div class=\"export-answerline\">Answer: <span></span></div>
        `;
        grid.appendChild(box);
      });

      content.appendChild(grid);
      page.appendChild(header);
      page.appendChild(content);
      return page;
    }

    function createAnswerPage(meta){
      const page = document.createElement("div");
      page.className = "export-page";

      const header = document.createElement("div");
      header.className = "export-header";
      header.innerHTML = `
        <div>
          <div class=\"export-title\">Answers — ${escapeHtml(meta.title)}</div>
          <div class=\"export-sub\">
            Student: ${escapeHtml(meta.student)} • Date: ${escapeHtml(meta.dateStr)}
          </div>
          <div class=\"answers-note\">These are the correct answers for the exported question set.</div>
        </div>
      `;

      const content = document.createElement("div");
      content.className = "export-content";

      const list = document.createElement("div");
      list.className = "answers-list";
      content.appendChild(list);

      page.appendChild(header);
      page.appendChild(content);

      return { page, content, list };
    }

    async function exportQuestionsPdf(){
      const perPage = Number($("#pdfPerPage").value) || 2;

      const libsOk = (window.html2canvas && window.jspdf && window.jspdf.jsPDF);
      if(!libsOk){
        alert("PDF export needs html2canvas + jsPDF. Please check your connection (CDN) or include the libraries locally.");
        return;
      }

      const title = TEMPLATE_META.title;
      const student = safeName($("#studentNameValue").textContent) || "Student";
      const now = new Date();
      const dateStr = now.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit" });
      const timeStr = $("#timerValue").textContent;

      const exportRoot = document.createElement("div");
      exportRoot.className = "export-root";
      document.body.appendChild(exportRoot);

      // Question pages
      const idxs = QUESTIONS.map((_,i)=>i);
      for(let i=0;i<idxs.length;i+=perPage){
        const group = idxs.slice(i, i+perPage);
        exportRoot.appendChild(buildQuestionPageDOM(group, perPage, { title, student, dateStr, timeStr }));
      }

      // Answer pages (auto paged)
      let ap = createAnswerPage({ title, student, dateStr });
      exportRoot.appendChild(ap.page);

      for(let i=0;i<QUESTIONS.length;i++){
        const item = document.createElement("div");
        item.textContent = `Q${i+1}: ${formatAnswer(QUESTIONS[i].answer)}`;
        ap.list.appendChild(item);

        if(ap.content.scrollHeight > ap.content.clientHeight){
          ap.list.removeChild(item);
          ap = createAnswerPage({ title, student, dateStr });
          exportRoot.appendChild(ap.page);
          ap.list.appendChild(item);
        }
      }

      // Render to PDF
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

      const pages = Array.from(exportRoot.querySelectorAll(".export-page"));
      const marginMm = 8;

      for(let i=0;i<pages.length;i++){
        const pageEl = pages[i];

        const canvas = await window.html2canvas(pageEl, {
          scale: 2,
          backgroundColor: "#ffffff",
          useCORS: true
        });

        const imgData = canvas.toDataURL("image/png", 1.0);

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const usableW = pageW - marginMm*2;
        const usableH = pageH - marginMm*2;

        const imgH = canvas.height * (usableW / canvas.width);

        let drawW = usableW;
        let drawH = imgH;

        if(drawH > usableH){
          drawH = usableH;
          drawW = canvas.width * (drawH / canvas.height);
        }

        const x = (pageW - drawW) / 2;
        const y = marginMm;

        if(i > 0) pdf.addPage();
        pdf.addImage(imgData, "PNG", x, y, drawW, drawH, undefined, "FAST");
      }

      pdf.save(`${TEMPLATE_META.filePrefix}_${student.replace(/\s+/g,"_")}_Questions.pdf`);
      exportRoot.remove();
    }

    $("#exportQuestionsBtn").addEventListener("click", exportQuestionsPdf);

    /********************
     * Export Learn PDF (captures the Learn page content)
     ********************/
    function setActiveTab(tabName){
      $$(".tab").forEach(b=>b.classList.remove("active"));
      const tabBtn = $(`.tab[data-tab="${tabName}"]`);
      if(tabBtn) tabBtn.classList.add("active");

      $$(".panel").forEach(p=>p.classList.remove("active"));
      const panel = $("#panel-"+tabName);
      if(panel) panel.classList.add("active");
    }

    function nextFrame(){
      return new Promise(r => requestAnimationFrame(() => setTimeout(r, 30)));
    }

    async function exportLearnPdf(){
      const libsOk = (window.html2canvas && window.jspdf && window.jspdf.jsPDF);
      if(!libsOk){
        alert("PDF export needs html2canvas + jsPDF. Please check your connection (CDN) or include the libraries locally.");
        return;
      }

      const prevTab = $(".tab.active")?.getAttribute("data-tab") || "learn";
      setActiveTab("learn");
      await nextFrame();

      const learnCard = $("#panel-learn .learn-card");
      if(!learnCard){
        alert("Cannot find the Learn page content to export.");
        setActiveTab(prevTab);
        return;
      }

      const canvas = await window.html2canvas(learnCard, {
        scale: 2,
        backgroundColor: "#ffffff",
        useCORS: true
      });

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

      const marginMm = 10;
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const usableW = pageW - marginMm*2;
      const usableH = pageH - marginMm*2;

      const imgW = usableW;
      const mmPerPx = imgW / canvas.width; // scale factor
      const pageHPx = usableH / mmPerPx;

      let yPx = 0;
      let pageIndex = 0;
      while(yPx < canvas.height){
        const sliceH = Math.min(pageHPx, canvas.height - yPx);
        const sliceCanvas = document.createElement("canvas");
        sliceCanvas.width = canvas.width;
        sliceCanvas.height = Math.max(1, Math.floor(sliceH));
        const ctx = sliceCanvas.getContext("2d");
        ctx.drawImage(canvas, 0, yPx, canvas.width, sliceCanvas.height, 0, 0, canvas.width, sliceCanvas.height);

        const imgData = sliceCanvas.toDataURL("image/png", 1.0);
        if(pageIndex > 0) pdf.addPage();
        const drawH = sliceCanvas.height * mmPerPx;
        pdf.addImage(imgData, "PNG", marginMm, marginMm, imgW, drawH, undefined, "FAST");

        yPx += sliceCanvas.height;
        pageIndex++;
      }

      const student = safeName($("#studentNameValue").textContent) || "Student";
      pdf.save(`${TEMPLATE_META.filePrefix}_${student.replace(/\s+/g,"_")}_Learn.pdf`);

      setActiveTab(prevTab);
    }

    $("#exportLearnBtn").addEventListener("click", exportLearnPdf);

    /********************
     * Init
     ********************/
    function applyTemplateMeta(){
      document.title = TEMPLATE_META.title;
      $("#pageTitle").textContent = TEMPLATE_META.title;
      $("#pageSubtitle").textContent = TEMPLATE_META.subtitle;
      $("#instructionsText").textContent = TEMPLATE_META.instructions;
    }

    applyTemplateMeta();
    ensureStudentName();
    renderLearnDiagram();
    updateTimerUI();
    startTimerTick();
    generateNewSet();
  </script>
</body>
</html>
