<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NZ Year 6 Maths Test (Practice / Exam)</title>

  <style>
    body{
      font-family:'Segoe UI', Tahoma, sans-serif;
      background:#f4f4f9;
      margin:0; padding:20px;
      color:#333;
    }
    .quiz-container{
      max-width:980px;
      margin:40px auto;
      background:#fff;
      padding:30px;
      border-radius:12px;
      box-shadow:0 6px 15px rgba(0,0,0,0.1);
      position:relative;
    }
    #headerLogo{
      display:flex; align-items:center;
      margin-bottom:10px;
      border-bottom:2px solid #e0e0e0;
      padding-bottom:10px;
      gap:12px;
    }
    .logo-icon{
      width:40px; height:40px;
      background:#0d47a1; border-radius:6px;
      position:relative;
      flex:0 0 auto;
    }
    .logo-icon:before{
      content:"";
      position:absolute;
      width:20px;height:9px;
      background:#ff9800;
      top:-6px; left:22px;
      border-radius:3px;
    }
    .logo-text{
      min-width:0;
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .logo-text .brand{
      font-weight:900;
      letter-spacing:1px;
      color:#0d47a1;
      font-size:1.05em;
    }
    .logo-text .edu{
      font-size:0.9em;
      color:#ff9800;
      font-weight:900;
      letter-spacing:0.6px;
    }

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:10px 0 6px;
      gap:10px;
      flex-wrap:wrap;
    }
    .top-left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .mode-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid #dfe5ff;
      font-weight:800;
      font-size:0.9em;
      color:#222;
      display:none;
    }
    .timer-box{
      padding:8px 12px;
      border:1px solid #e0e0e0;
      border-radius:10px;
      background:#fafafa;
      font-weight:800;
      font-size:0.95em;
      display:none;
    }
    .timer-box .paused-tag{
      display:inline-block;
      margin-left:8px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #ffd0d0;
      background:#fff2f2;
      color:#b00020;
      font-weight:900;
      font-size:0.85em;
      display:none;
    }

    .top-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .top-right button{
      padding:10px 16px;
      border:none;
      color:#fff;
      border-radius:10px;
      cursor:pointer;
      font-size:0.98em;
      font-weight:800;
    }
    #generateButton{ background:#ff9800; display:none; }
    #pauseResumeButton{ background:#607d8b; display:none; }
    #resetButton{ background:#455a64; display:none; }
    #exportPdfButton{ background:#6a1b9a; display:none; }
    #exportWordButton{ background:#2e7d32; display:none; }

    .quiz-main{
      display:flex; gap:20px;
      margin-top:10px;
    }
    .sidebar{
      width:250px;
      border-right:1px solid #ddd;
      padding-right:10px;
      display:none;
    }
    .sidebar h4{
      margin:0 0 8px;
      font-size:0.95em;
      border-bottom:1px solid #eee;
      padding-bottom:4px;
    }
    .sidebar .sub{
      font-size:0.86em;
      color:#666;
      margin:4px 0 10px;
      line-height:1.35;
    }
    .sidebar ul{ list-style:none; padding:0; margin:0; }
    .sidebar li{
      padding:6px;
      cursor:pointer;
      border-radius:6px;
      font-size:0.9em;
      user-select:none;
      margin-bottom:6px;
      border:1px solid transparent;
      background:#fafafa;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .sidebar li:hover{ border-color:#e6e6e6; }
    .sidebar li.active{ outline:2px solid #1976d2; font-weight:800; background:#fff; }
    .sidebar li.correct{ background:#d4edda; border-left:4px solid #28a745; }
    .sidebar li.incorrect{ background:#f8d7da; border-left:4px solid #f44336; }
    .sidebar li.answered{ border-left:4px solid #4caf50; background:#fdfdfd; }
    .pts-badge{
      font-size:0.78em;
      font-weight:900;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e0e0e0;
      background:#fff;
      color:#444;
      flex:0 0 auto;
    }

    #quizContent{ flex:1; min-width:0; }

    h2{
      margin:10px 0 6px;
      font-size:1.5em;
      color:#111;
    }
    .meta-line{
      margin:0 0 6px;
      color:#555;
      font-size:0.95em;
    }
    .question-text{
      font-size:1.05em;
      margin:10px 0 8px;
      font-weight:800;
    }
    .instructions{
      font-size:0.92em;
      color:#555;
      margin:0 0 12px;
      line-height:1.45;
    }
    .part-title{
      font-weight:900;
      margin:10px 0 8px;
      color:#0d47a1;
    }
    .points-line{
      margin:0 0 10px;
      color:#444;
      font-size:0.92em;
      font-weight:900;
    }
    .single-question{
      margin-top:8px;
      line-height:1.55;
      font-size:1.02em;
    }

    .answer-box{
      width:min(520px, 96%);
      padding:8px 10px;
      font-size:1em;
      margin-top:8px;
      border:1px solid #cfcfcf;
      border-radius:10px;
      outline:none;
    }
    .answer-box:focus{ border-color:#1976d2; box-shadow:0 0 0 3px rgba(25,118,210,0.12); }

    /* display-only fraction/mixed-number (for questions + solutions) */
    .mxd{
      display:inline-flex;
      align-items:center;
      gap:0.25em;
      vertical-align:middle;
      margin:0 0.15em;
      font-size:1em; /* inherit from surrounding text */
    }
    .mxd .frac{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      gap:0.15em;
      line-height:1;
    }
    .mxd .box{
      width:2.0em;
      height:1.6em;
      border:1px solid #cfcfcf;
      border-radius:0.45em;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      background:#fff;
      font-size:1em;
      padding:0;
      box-sizing:border-box;
    }
    .mxd .bar{
      width:2.0em;
      height:0.12em;
      background:#111;
      border-radius:2px;
      opacity:0.9;
    }

    /* display-only mixed numbers (for questions + solutions) */
    .mixed-inline{
      display:inline-flex;
      align-items:center;
      gap:0.25em;
      vertical-align:middle;
      margin:0 0.15em;
      font-size:1em;
    }
    .mixed-box{
      min-width:1.9em;
      height:1.6em;
      padding:0 0.35em;
      border:1px solid #cfcfcf;
      border-radius:0.45em;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      background:#fff;
      box-sizing:border-box;
      font-size:1em;
      line-height:1;
    }
    .mixed-inline .frac{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      line-height:1;
    }
    .mixed-inline .frac-bar{
      width:2.1em;
      height:0.12em;
      background:#111;
      margin:0.15em 0;
      border-radius:2px;
    }

/* answer mixed input */
    .mixed-answer{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
.mixed-inline{display:inline-flex;align-items:center;gap:8px;vertical-align:middle;}
.mixed-box{
  min-width:44px;height:36px;padding:0 10px;
  border:1.5px solid #cfcfcf;border-radius:10px;
  display:inline-flex;align-items:center;justify-content:center;
  font-weight:900;background:#fff;
}
.mixed-inline .frac{display:inline-flex;flex-direction:column;align-items:center;line-height:1;}
.mixed-inline .frac-bar{width:54px;height:2px;background:#111;margin:3px 0;}
	
    .mixed-answer input{
      width:64px;
      height:44px;
      border:1px solid #cfcfcf;
      border-radius:12px;
      font-size:1.05em;
      font-weight:900;
      text-align:center;
      outline:none;
      background:#fff;
    }
    .mixed-answer input:focus{
      border-color:#1976d2;
      box-shadow:0 0 0 3px rgba(25,118,210,0.12);
    }
    .mixed-answer .fraccol{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }
    .mixed-answer .bar{
      height:2px;
      width:68px;
      background:#111;
      border-radius:2px;
      opacity:0.9;
    }
    .mixed-answer .note{
      color:#666;
      font-size:0.92em;
      font-weight:800;
    }

    .hint-toggle{
      margin-top:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #e0e0e0;
      background:#fafafa;
      cursor:pointer;
      font-weight:900;
      user-select:none;
    }
    .hint-toggle:disabled{
      cursor:not-allowed;
      opacity:0.6;
    }
    .hint-box{
      margin-top:10px;
      padding:10px 12px;
      background:#f7f7ff;
      border:1px solid #e6e6ff;
      border-radius:10px;
      font-size:0.92em;
      color:#444;
      line-height:1.45;
      display:none;
    }
    .hint-box b{ color:#111; }

    .check-feedback{
      margin-top:12px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #e0e0e0;
      background:#fafafa;
      font-size:0.95em;
      display:none;
      white-space:pre-wrap;
      line-height:1.45;
    }
    .check-feedback.neutral{ display:block; background:#f6f7fb; border-color:#e2e6ff; }
    .check-feedback.correct{ display:block; background:#d4edda; border-color:#28a745; }
    .check-feedback.incorrect{ display:block; background:#f8d7da; border-color:#f44336; }

    .question-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:18px;
      align-items:center;
    }
    .question-buttons button{
      padding:10px 18px;
      border:none;
      color:#fff;
      border-radius:10px;
      cursor:pointer;
      font-size:1em;
      font-weight:900;
    }
    #nextButton{ background:#4caf50; }
    #backButton{ background:#039be5; }
    #submitButton{ background:#9c27b0; }
    #checkButton{ background:#00897b; }
    #submitPracticeButton{ background:#455a64; }
    #saveButton{ background:#607d8b; }

    table.review-table{
      width:100%;
      border-collapse:collapse;
      margin-top:18px;
    }
    .review-table th, .review-table td{
      border:1px solid #ccc;
      padding:6px;
      font-size:0.85em;
      text-align:center;
      vertical-align:top;
    }
    .review-table th{ background:#f2f2f2; }
    .correct-answer{ background:#d4edda; }
    .incorrect-answer{ background:#f8d7da; }

    @media (max-width:760px){
      .quiz-main{ flex-direction:column; }
      .sidebar{
        width:100%;
        border-right:none;
        border-bottom:1px solid #ddd;
        margin-bottom:10px;
        padding-bottom:10px;
      }
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text">
      <div class="brand">DYAA</div>
      <div class="edu">EDUCATION</div>
    </div>
  </div>

  <div class="top-bar">
    <div class="top-left">
      <span id="modePill" class="mode-pill"></span>
      <div id="timerBox" class="timer-box">
        <span id="timerLabel">Time: 00:00</span>
        <span id="pausedTag" class="paused-tag">PAUSED</span>
      </div>
    </div>
    <div class="top-right">
      <button id="pauseResumeButton">Pause</button>
      <button id="exportPdfButton">Export PDF</button>
      <button id="exportWordButton">Export Word</button>
      <button id="generateButton">Generate New Set</button>
      <button id="resetButton">Back to Start</button>
    </div>
  </div>

  <h2>NZ Year 6 Maths Test</h2>
  <p class="meta-line" id="metaLine"></p>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>
</div>

<script>
/* ==========================================================
   NZ Year 6 Maths Test (Practice / Exam)
   ✅ 40 questions per set, total 100 points
   ✅ No repeated question TYPES within one set (unique templates)
   ✅ Mixed numbers displayed in "3-box" style
   ✅ Mixed subtraction/addition question random (numbers + +/−)
      and answer required as simplified fraction (NOT decimal)
   ✅ Ratio simplify questions ALWAYS reducible (never coprime like 35:11)
   ✅ Geometry questions are TEXT-ONLY (no diagrams/images)
========================================================== */

/* ---------------- URL name ---------------- */
function getStudentNameFromURL(){
  try{
    const params = new URLSearchParams(window.location.search || "");
    const raw = params.get("name");
    if (!raw) return "";
    return decodeURIComponent(raw.replace(/\+/g, "%20")).trim();
  }catch(e){ return ""; }
}
const URL_STUDENT_NAME = getStudentNameFromURL();

/* ---------------- Utilities ---------------- */
function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
function choice(arr){ return arr[randInt(0, arr.length - 1)]; }
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function gcd(a,b){
  a = Math.abs(a); b = Math.abs(b);
  while(b){ const t=a%b; a=b; b=t; }
  return a || 1;
}
function gcd3(a,b,c){ return gcd(gcd(a,b),c); }
function lcm(a,b){ return Math.abs(a / gcd(a,b) * b); }
function stripHTML(html){
  const tmp = document.createElement("div");
  tmp.innerHTML = html;

  // Replace math-style fraction/mixed markup with their aria-label for plain text extraction
  tmp.querySelectorAll(".mxd[aria-label], .mixed-inline[aria-label]").forEach(el=>{
    const label = el.getAttribute("aria-label");
    if (label) el.textContent = label;
  });

  return (tmp.textContent || tmp.innerText || "").trim();
}
function pad2(n){ return String(n).padStart(2,"0"); }
function roundTo(n, place){ return Math.round(n / place) * place; }

/* ---------------- Mixed display HTML (for questions) ---------------- */
function mixedHTML(whole, num, den){
  // 如果你已经有自己的 mixed number 样式函数，就用你自己的；这里给一个通用版本
  return `
    <span class="mixed-inline" aria-label="${whole} ${num}/${den}">
      <span class="mixed-box whole">${whole}</span>
      <span class="frac">
        <span class="mixed-box num">${num}</span>
        <span class="frac-bar"></span>
        <span class="mixed-box den">${den}</span>
      </span>
    </span>
  `;
}

function fracHTML(num, den){
  return `
    <span class="mxd" aria-label="${num}/${den}">
      <span class="frac">
        <span class="box">${num}</span>
        <span class="bar"></span>
        <span class="box">${den}</span>
      </span>
    </span>
  `;
}

/* ---------------- Safe text -> math-style HTML for inline display ---------------- */
function escapeHTML(str){
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

// Expects an already-escaped string (no HTML tags), returns HTML with fraction/mixed styling.
function mathifyText(escapedStr){
  let s = String(escapedStr);

  // Mixed number: "2 1/3" -> 2 + stacked fraction (no space)
  s = s.replace(/\b(\d{1,3})\s+(\d{1,3})\/(\d{1,3})\b/g, (m, w, n, d) => {
    return mixedHTML(Number(w), Number(n), Number(d));
  });

  // Simple fraction: "7/10" -> stacked fraction
  s = s.replace(/\b(\d{1,3})\/(\d{1,3})\b/g, (m, n, d) => {
    return fracHTML(Number(n), Number(d));
  });

  return s;
}

/* ---------------- Points: 40 questions, total 100 ---------------- */
function buildPointsArray(){
  const pts = [];
  for (let i=0;i<10;i++) pts.push(1);  // Easy (10)  -> 10
  for (let i=0;i<15;i++) pts.push(2);  // Medium (15)-> 40
  for (let i=0;i<15;i++) pts.push(4);  // Hard (15)  -> 100
  return pts;
}
const POINTS = buildPointsArray();
const TOTAL_POINTS = POINTS.reduce((a,b)=>a+b,0);

/* ---------------- Words for numbers (0..9999) ---------------- */
const ONES = ["zero","one","two","three","four","five","six","seven","eight","nine"];
const TEENS = ["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
const TENS  = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];
function numberToWords(n){
  n = Math.floor(Number(n));
  if (!Number.isFinite(n) || n < 0 || n > 9999) return "";
  if (n < 10) return ONES[n];
  if (n < 20) return TEENS[n-10];
  if (n < 100){
    const t = Math.floor(n/10);
    const u = n%10;
    if (u === 0) return TENS[t];
    return TENS[t] + "-" + ONES[u];
  }
  if (n < 1000){
    const h = Math.floor(n/100);
    const rest = n%100;
    if (rest === 0) return ONES[h] + " hundred";
    return ONES[h] + " hundred and " + numberToWords(rest);
  }
  const th = Math.floor(n/1000);
  const rest = n%1000;
  const thPart = ONES[th] + " thousand";
  if (rest === 0) return thPart;
  if (rest < 100) return thPart + " and " + numberToWords(rest);
  return thPart + " " + numberToWords(rest);
}
function normalizeWords(s){
  s = String(s || "").toLowerCase().trim();
  s = s.replace(/[,]/g," ");
  s = s.replace(/-/g," ");
  s = s.replace(/\s+/g," ").trim();
  return s;
}
function normalizeWordsNoAnd(s){
  return normalizeWords(s).replace(/\band\b/g," ").replace(/\s+/g," ").trim();
}

/* ---------------- Parsers ---------------- */
function parseIntStrict(str){
  let s = (str || "").trim();
  if (!s) return NaN;
  s = s.replace(/−/g,"-").replace(/,/g,"");
  if (!/^-?\d+$/.test(s)) return NaN;
  const v = Number(s);
  return Number.isFinite(v) ? v : NaN;
}
function parseDecimalStrict(str){
  let s = (str || "").trim();
  if (!s) return NaN;
  s = s.replace(/,/g,"");
  if (!/^-?\d+(\.\d+)?$/.test(s)) return NaN;
  const v = Number(s);
  return Number.isFinite(v) ? v : NaN;
}
function roundToDp(x, dp){
  const p = Math.pow(10, dp);
  return Math.round(x*p)/p;
}

/* ---- Money ---- */
function parseMoneyToCents(s){
  let t = String(s||"").trim();
  if (!t) return NaN;
  t = t.replace(/\$/g,"").replace(/,/g,"").trim();
  if (!/^\-?\d+(\.\d{1,2})?$/.test(t)) return NaN;
  const neg = t.startsWith("-");
  if (neg) t = t.slice(1);
  const parts = t.split(".");
  const dollars = Number(parts[0]);
  const cents = parts.length === 2 ? Number((parts[1] + "00").slice(0,2)) : 0;
  const v = dollars*100 + cents;
  return neg ? -v : v;
}

/* ---- Fractions (supports mixed input: "w n/d") ---- */
function parseFraction(s){
  const raw = String(s || "").trim().replace(/−/g, "-");
  if (!raw) return null;

  // Mixed number:  w n/d
  let m = raw.match(/^(-?\d+)\s+(\d+)\s*\/\s*(\d+)$/);
  if (m){
    const w = Number(m[1]), n = Number(m[2]), d = Number(m[3]);
    if (!Number.isInteger(w) || !Number.isInteger(n) || !Number.isInteger(d) || d === 0) return null;
    if (n < 0 || n >= Math.abs(d)) return null;
    const sign = w < 0 ? -1 : 1;
    const a = sign * (Math.abs(w) * d + n);
    return { a, b: d };
  }

  // Simple fraction: a/b
  const t = raw.replace(/\s+/g, "");
  m = t.match(/^(-?\d+)\/(\d+)$/);
  if (!m) return null;

  const a = Number(m[1]), b = Number(m[2]);
  if (!Number.isInteger(a) || !Number.isInteger(b) || b === 0) return null;
  return { a, b };
}
function reduceFraction(a,b){
  const g = gcd(a,b);
  const sign = (a<0) ? -1 : 1;
  a = Math.abs(a);
  return {a: sign*(a/g), b: b/g};
}
function improperToMixed(a,b){
  const r = reduceFraction(a,b);
  const sign = r.a < 0 ? -1 : 1;
  const aa = Math.abs(r.a);
  const d = r.b;
  const w = Math.floor(aa / d);
  const n = aa % d;
  return { w: sign*w, n, d };
}
function isMixedValue(a,b){
  const r = reduceFraction(a,b);
  const aa = Math.abs(r.a);
  return aa > r.b && (aa % r.b !== 0);
}

/* ---- Ratio ---- */
function parseRatioN(s, count){
  const t = String(s||"").toLowerCase().trim();
  if (!t) return null;

  const nums = t.match(/\-?\d+/g);
  if (!nums || nums.length < count) return null;
  const vals = nums.slice(0,count).map(x=>Number(x));
  if (vals.some(v => !Number.isInteger(v))) return null;
  if (vals.some(v => v === 0)) return null;
  if (count === 2){
    const g = gcd(vals[0], vals[1]);
    return [vals[0]/g, vals[1]/g];
  }
  if (count === 3){
    const g = gcd3(vals[0], vals[1], vals[2]);
    return [vals[0]/g, vals[1]/g, vals[2]/g];
  }
  return vals;
}

/* ---- Time ---- */
function parseTimeToMinutes(str){
  let s = String(str||"").toLowerCase().trim();
  if (!s) return NaN;

  s = s.replace(/\./g,":").replace(/\s+/g," ").trim();

  let m24 = s.match(/^(\d{1,2}):(\d{2})$/);
  if (m24){
    const hh = Number(m24[1]), mm = Number(m24[2]);
    if (hh>=0 && hh<=23 && mm>=0 && mm<=59) return hh*60+mm;
  }
  let m24b = s.match(/^(\d{2})(\d{2})$/);
  if (m24b){
    const hh = Number(m24b[1]), mm = Number(m24b[2]);
    if (hh>=0 && hh<=23 && mm>=0 && mm<=59) return hh*60+mm;
  }

  const m12 = s.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)$/);
  if (!m12) return NaN;
  let hh = Number(m12[1]);
  let mm = m12[2] ? Number(m12[2]) : 0;
  const ap = m12[3];
  if (!(hh>=1 && hh<=12 && mm>=0 && mm<=59)) return NaN;
  if (hh === 12) hh = 0;
  let mins = hh*60 + mm;
  if (ap === "pm") mins += 12*60;
  return mins;
}
function minutesToTime12(mins){
  mins = ((mins%1440)+1440)%1440;
  let hh24 = Math.floor(mins/60);
  const mm = mins%60;
  const ap = hh24 >= 12 ? "pm" : "am";
  let hh12 = hh24 % 12;
  if (hh12 === 0) hh12 = 12;
  return `${hh12}:${pad2(mm)} ${ap}`;
}

/* ---------------- Answer compare ---------------- */
function compareByType(userStr, correct){
  const ans = String(userStr||"").trim();
  if (ans === "") return { ok:false, empty:true };

  if (correct.type === "integer"){
    const u = parseIntStrict(ans);
    if (!Number.isInteger(u)) return { ok:false, empty:false };
    return { ok: u === correct.value, empty:false };
  }

  if (correct.type === "decimal"){
    const u = parseDecimalStrict(ans);
    if (!Number.isFinite(u)) return { ok:false, empty:false };
    if (Number.isInteger(correct.dp)){
      const uu = roundToDp(u, correct.dp);
      const cc = roundToDp(correct.value, correct.dp);
      return { ok: uu === cc, empty:false };
    }
    return { ok: Math.abs(u - correct.value) < 1e-9, empty:false };
  }

  if (correct.type === "words"){
    const u1 = normalizeWords(ans);
    const u2 = normalizeWordsNoAnd(ans);
    const c1 = normalizeWords(correct.value);
    const c2 = normalizeWordsNoAnd(correct.value);
    return { ok: (u1 === c1) || (u2 === c2), empty:false };
  }

  if (correct.type === "choiceWord"){
    const u = normalizeWords(ans);
    return { ok: correct.allowed.includes(u), empty:false };
  }

  if (correct.type === "money"){
    const u = parseMoneyToCents(ans);
    if (!Number.isFinite(u)) return { ok:false, empty:false };
    return { ok: u === correct.cents, empty:false };
  }

  if (correct.type === "fraction"){
    const f = parseFraction(ans);
    if (!f) return { ok:false, empty:false };
    const r = reduceFraction(f.a,f.b);
    return { ok: (r.a === correct.a && r.b === correct.b), empty:false };
  }

  if (correct.type === "ratio2"){
    const r = parseRatioN(ans, 2);
    if (!r) return { ok:false, empty:false };
    return { ok: (r[0] === correct.values[0] && r[1] === correct.values[1]), empty:false };
  }

  if (correct.type === "ratio3"){
    const r = parseRatioN(ans, 3);
    if (!r) return { ok:false, empty:false };
    return { ok: (r[0] === correct.values[0] && r[1] === correct.values[1] && r[2] === correct.values[2]), empty:false };
  }

  if (correct.type === "time"){
    const u = parseTimeToMinutes(ans);
    if (!Number.isFinite(u)) return { ok:false, empty:false };
    return { ok: u === correct.mins, empty:false };
  }

  return { ok:false, empty:false };
}

/* ---------------- Question model ---------------- */
function makeQ(index, partIndex, partName, points, html, correct, displayCorrect, answerHint, hint){
  return {
    index,
    partIndex,
    partName,
    points,
    html,
    plain: stripHTML(html),
    correct,
    displayCorrect,
    answerHint,
    hint,
    userValue:"",
    checked:false,
    isCorrect:false,
    hintShown:false
  };
}

/* ==========================================================
   Parts (Year 6)
========================================================== */
const PARTS = [
  "Number & Algebra",
  "Fractions, Decimals & Percent",
  "Ratio & Proportion",
  "Measurement",
  "Geometry",
  "Word Problems & Reasoning"
];

function T(id, partIndex, html, correct, displayCorrect, answerHint, hint){
  return { id, partIndex, partName: PARTS[partIndex], html, correct, displayCorrect, answerHint, hint };
}

/* ==========================================================
   Template bank — EASY (2 pts)
========================================================== */
function tplE_negCompare(){
  const a = -randInt(1, 20);
  let b = -randInt(1, 20);
  while (b === a) b = -randInt(1, 20);
  const correct = (a > b) ? ">" : "<";
  return T("E_negCompare", 0,
    `Fill in the blank with <b>&lt;</b> or <b>&gt;</b>:<br><br><b>${a}</b> ____ <b>${b}</b>`,
    {type:"choiceWord", allowed:[correct]},
    `${correct}`,
    `Type < or >`,
    `Among negative numbers, the one closer to 0 is greater.`
  );
}
function tplE_roundNearest1000(){
  let n = randInt(1500, 99500);
  while (n % 1000 === 0) n = randInt(1500, 99500);
  const rounded = Math.round(n/1000)*1000;
  return T("E_round1000", 0,
    `Round <b>${n.toLocaleString("en-NZ")}</b> to the nearest <b>1000</b>.`,
    {type:"integer", value:rounded},
    `${rounded.toLocaleString("en-NZ")}`,
    `Enter an integer.`,
    `Look at the last three digits.`
  );
}
function tplE_simplifyFraction(){
  const pairs = [[6,8],[8,12],[9,12],[10,15],[12,18],[14,21],[15,25],[16,24],[18,30],[21,28]];
  const [n,d] = choice(pairs);
  const r = reduceFraction(n,d);
  return T("E_simplifyFrac", 1,
    `Express this fraction in its simplest form: ${fracHTML(n,d)}`,
    {type:"fraction", a:r.a, b:r.b},
    `${fracHTML(r.a,r.b)}`,
    `Enter as a fraction like 2/3.`,
    `Divide top and bottom by the highest common factor.`
  );
}
function tplE_percentOfNumber(){
  const pct = choice([25, 50, 75, 20, 10, 40, 60]);
  const base = choice([80,120,160,200,240,300,360,420,500]);
  const ans = base * (pct/100);
  return T("E_percentOf", 1,
    `Find <b>${pct}%</b> of <b>${base}</b>.`,
    {type:"integer", value:ans},
    `${ans}`,
    `Enter an integer.`,
    `Convert ${pct}% to a fraction or a decimal, then multiply.`
  );
}
function tplE_digitsToWords(){
  const n = randInt(1000, 9999);
  const w = numberToWords(n);
  return T("E_digitsToWords", 0,
    `Write this number in words: <b>${n}</b>.`,
    {type:"words", value:w},
    `${w}`,
    `Type the number in words (hyphens optional; “and” optional).`,
    `NZ/UK style: 127 = one hundred and twenty-seven.`
  );
}
function tplE_ratioSimplify(){
  // ALWAYS reducible (never coprime like 35:11)
  let u = randInt(2, 15);
  let v = randInt(2, 15);
  while (gcd(u,v) !== 1){
    u = randInt(2, 15);
    v = randInt(2, 15);
  }
  const k = randInt(2, 9);  // force simplifiable
  const a = u*k, b = v*k;
  return T("E_ratioSimplify", 2,
    `Simplify this ratio: <b>${a}:${b}</b>.`,
    {type:"ratio2", values:[u,v]},
    `${u}:${v}`,
    `Answer format: a:b (simplest form).`,
    `Divide both parts by the highest common factor.`
  );
}

/* --- extra EASY templates to enrich randomness --- */
function tplE_placeValue(){
  const n = randInt(2000, 9999);
  const s = String(n).padStart(4,"0");
  const digits = s.split("").map(x=>Number(x));
  const positions = [
    {name:"thousands", value:1000, digit:digits[0]},
    {name:"hundreds", value:100, digit:digits[1]},
    {name:"tens", value:10, digit:digits[2]},
    {name:"ones", value:1, digit:digits[3]}
  ];
  const pos = choice(positions);
  const ans = pos.digit * pos.value;
  return T("E_placeValue", 0,
    `In the number <b>${n.toLocaleString("en-NZ")}</b>, what is the value of the <b>${pos.name}</b> digit?`,
    {type:"integer", value:ans},
    `${ans.toLocaleString("en-NZ")}`,
    `Enter an integer.`,
    `Find the ${pos.name} digit and multiply by its place value.`
  );
}

function tplE_decimalCompare(){
  const whole = randInt(1, 9);
  let a = whole + randInt(0, 99)/100;
  let b = whole + randInt(0, 99)/100;
  while (Math.abs(a-b) < 1e-9){
    b = whole + randInt(0, 99)/100;
  }
  const left = a.toFixed(2);
  const right = b.toFixed(2);
  const correct = (a > b) ? ">" : "<";
  return T("E_decimalCompare", 1,
    `Fill in the blank with <b>&lt;</b> or <b>&gt;</b>:<br><br><b>${left}</b> ____ <b>${right}</b>`,
    {type:"choiceWord", allowed:[correct]},
    `${correct}`,
    `Type < or >`,
    `Compare digit by digit from the left.`
  );
}

function tplE_fractionOfNumber(){
  const fracs = [[1,2],[1,3],[2,3],[1,4],[3,4],[2,5],[3,5]];
  const [n,d] = choice(fracs);
  const unit = randInt(3, 18);
  const base = d * unit;
  const ans = base * n / d;
  return T("E_fracOfNumber", 1,
    `Find ${fracHTML(n,d)} of <b>${base}</b>.`,
    {type:"integer", value:ans},
    `${ans}`,
    `Enter an integer.`,
    `Divide by ${d}, then multiply by ${n}.`
  );
}

function tplE_timeToMinutes(){
  const h = randInt(1, 4);
  const m = choice([0,5,10,15,20,25,30,35,40,45,50,55]);
  const ans = h*60 + m;
  return T("E_timeToMinutes", 3,
    `Convert <b>${h} hours ${m} minutes</b> to <b>minutes</b>.`,
    {type:"integer", value:ans},
    `${ans}`,
    `Enter an integer (minutes).`,
    `1 hour = 60 minutes.`
  );
}

function tplE_lengthConvert(){
  const m = randInt(12, 250) / 10; // one decimal place
  const cm = Math.round(m * 100);
  return T("E_lengthConvert", 4,
    `Convert <b>${m.toFixed(1)} m</b> to <b>centimetres</b>.`,
    {type:"integer", value:cm},
    `${cm} cm`,
    `Enter an integer (cm).`,
    `1 m = 100 cm, so multiply by 100.`
  );
}

function tplE_perimeterSquare(){
  const side = randInt(4, 25);
  const p = 4*side;
  return T("E_perimeterSquare", 4,
    `A square has side length <b>${side} cm</b>. Find its perimeter.`,
    {type:"integer", value:p},
    `${p} cm`,
    `Enter an integer (cm).`,
    `Perimeter of a square = 4 × side.`
  );
}

/* ==========================================================
   Template bank — MEDIUM (3 pts)
========================================================== */
function tplM_addSubNeg(){
  const a = randInt(-50, 50);
  let b = randInt(-50, 50);
  while (b === 0) b = randInt(-50, 50);
  const op = choice(["+","−"]);
  const val = (op === "+") ? (a + b) : (a - b);
  return T("M_addSubNeg", 0,
    `Calculate: <b>${a} ${op} ${b}</b>.`,
    {type:"integer", value:val},
    `${val}`,
    `Enter an integer.`,
    `Watch the signs carefully.`
  );
}
function tplM_fracAddUnlike(){
  const d1 = choice([6,8,9,10,12]);
  const d2 = choice([6,8,9,10,12]);
  let a = randInt(1, d1-1);
  let b = randInt(1, d2-1);
  const L = lcm(d1,d2);
  const sumN = a*(L/d1) + b*(L/d2);
  const r = reduceFraction(sumN, L);
  return T("M_fracAddUnlike", 1,
    `Find: ${fracHTML(a,d1)} + ${fracHTML(b,d2)} (simplest form).`,
    {type:"fraction", a:r.a, b:r.b},
    `${fracHTML(r.a,r.b)}`,
    `Enter as a fraction like 5/6.`,
    `Find a common denominator, then simplify.`
  );
}
function tplM_percentReverse(){
  const pct = choice([25, 40, 60, 75, 80]);
  const original = choice([120, 160, 200, 240, 300, 360, 480, 600]);
  const part = original * (pct/100);
  return T("M_percentReverse", 1,
    `<b>${pct}%</b> of a number is <b>${part}</b>. What is the original number?`,
    {type:"integer", value:original},
    `${original}`,
    `Enter an integer.`,
    `Original = part ÷ (${pct}/100).`
  );
}
function tplM_ratioWordShare(){
  const total = choice([72,84,96,108,120,144,180,240]);
  const r1 = choice([2,3,4,5]);
  const r2 = choice([3,4,5,6,7]);
  const sum = r1+r2;
  if (total % sum !== 0) return tplM_ratioWordShare();
  const unit = total/sum;
  const a = r1*unit, b = r2*unit;
  return T("M_ratioShare", 2,
    `Two groups share <b>${total}</b> stickers in the ratio <b>${r1}:${r2}</b>.<br>
     How many stickers are in each group? (Answer as: first group, second group)`,
    {type:"choiceWord", allowed:[normalizeWords(`${a},${b}`), normalizeWords(`${a} ${b}`), normalizeWords(`${a}, ${b}`)]},
    `${a}, ${b}`,
    `Answer format: a, b`,
    `Find one unit = total ÷ (ratio sum), then multiply.`
  );
}
function tplM_linearEquationOneStep(){
  const x = randInt(4, 30);
  const a = choice([2,3,4,5,6,7,8,9]);
  const b = randInt(-20, 20);
  const left = a*x + b;
  const sign = (b>=0) ? "+" : "−";
  const bb = Math.abs(b);
  return T("M_linear1", 0,
    `Solve for <b>x</b>: <b>${a}x ${sign} ${bb} = ${left}</b>.`,
    {type:"integer", value:x},
    `${x}`,
    `Enter an integer.`,
    `Undo addition/subtraction, then divide by ${a}.`
  );
}

/* TEXT-ONLY (no picture): improper fraction → mixed number */
function tplM_improperToMixed_TextOnly(){
  const d = choice([4,5,6,8,10,12]);
  const whole = randInt(1, 4);
  const rem = randInt(1, d-1);
  const n = whole*d + rem;

  const rr = reduceFraction(rem, d);
  const targetA = whole*rr.b + rr.a;
  const targetB = rr.b;

  return T("M_improperToMixed_text", 1,
    `Convert the improper fraction ${fracHTML(n,d)} to a mixed number in simplest form.`,
    {type:"fraction", a:targetA, b:targetB, forceMixed:true},
    `${mixedHTML(whole, rr.a, rr.b)}`,
    `Use the 3-box mixed-number input.`,
    `Divide ${n} by ${d}: the quotient is the whole number, and the remainder is the numerator. Then simplify the fraction.`
  );
}

function tplM_estimateDivision(){
  const a = randInt(300, 900);
  const b = choice([6,7,8,9]);
  const roundedA = roundTo(a, 100);
  const est = Math.round(roundedA / b);
  return T("M_estDiv", 0,
    `Estimate <b>${a} ÷ ${b}</b> by rounding <b>${a}</b> to the nearest <b>100</b>.`,
    {type:"integer", value:est},
    `${est}`,
    `Enter an integer estimate.`,
    `Round first, then divide.`
  );
}
function tplM_moneyMulti(){
  const a = choice([12.50, 18.75, 24.30, 31.60, 45.90]);
  const b = choice([2,3,4,5]);
  const cost = a*b;
  const paid = choice([100, 80, 150, 200]);
  if (paid < cost) return tplM_moneyMulti();
  const changeCents = Math.round((paid-cost)*100);
  return T("M_moneyMulti", 5,
    `A family buys <b>${b}</b> tickets at <b>$${a.toFixed(2)}</b> each.<br>
     They pay with <b>$${paid}</b>. How much change do they get?`,
    {type:"money", cents:changeCents},
    `$${(changeCents/100).toFixed(2)}`,
    `Enter dollars (e.g., 12.50).`,
    `Total cost = price × quantity; change = paid − total.`
  );
}
function tplM_ratioFromScreenshot12(){
  return T("IMG12_ratio_250c_10d", 2,
    `Express <b>250 cents</b> as a ratio of <b>$10</b> in simplest form.`,
    {type:"ratio2", values:[1,4]},
    `1:4`,
    `Answer format: a:b (simplest form).`,
    `Convert 250 cents to dollars, then simplify the ratio.`
  );
}
function tplM_decimalFromMixedScreenshot13(){
  // random mixed number: W (N/D)
  const den = choice([4,5,6,7,8,9,10,12]);
  const num = randInt(1, den - 1);
  const whole = randInt(2, 12);

  const value = whole + num/den;
  const corr = roundToDp(value, 2); // same rounding rule as checker

  return T("IMG13_mixed_to_decimal", 1,
    `Express ${mixedHTML(whole, num, den)} as a decimal. Round your answer to <b>2 decimal places</b>.`,
    {type:"decimal", value:value, dp:2},
    `${corr.toFixed(2)}`,
    `Enter a decimal (2 dp).`,
    `Convert ${fracHTML(num, den)} to a decimal, add ${whole}, then round to 2 dp.`
  );
}


/* --- extra medium templates to diversify --- */
function tplM_decimalTimesInt(){
  const x = choice([1.2, 1.5, 2.4, 3.6, 4.8, 6.4]);
  const n = choice([2,3,4,5,6,8,10]);
  const ans = x*n;
  return T("M_decimalTimesInt", 1,
    `Calculate mentally: <b>${x} × ${n}</b>.`,
    {type:"decimal", value:ans, dp:1},
    `${ans.toFixed(1)}`,
    `Enter a decimal (1 dp).`,
    `Multiply as whole numbers then place the decimal.`
  );
}
function tplM_decimalDivide10_100(){
  const base = choice([24.5, 36.8, 120.4, 75.6, 9.3, 180.0]);
  const div = choice([10, 100]);
  const ans = base / div;
  const dp = div === 10 ? 2 : 3;
  return T("M_decimalDivide10_100", 1,
    `Calculate: <b>${base} ÷ ${div}</b>.`,
    {type:"decimal", value:ans, dp:dp},
    `${ans}`,
    `Enter a decimal.`,
    `Dividing by ${div} moves the decimal point.`
  );
}
function tplM_perimeterRectangle(){
  const L = randInt(8, 24);
  const W = randInt(5, 18);
  const p = 2*(L+W);
  return T("M_perimeterRect", 4,
    `A rectangle is <b>${L} cm</b> long and <b>${W} cm</b> wide. Find its perimeter.`,
    {type:"integer", value:p},
    `${p} cm`,
    `Enter an integer (cm).`,
    `Perimeter = 2(L + W).`
  );
}
function tplM_timeAdd(){
  const startH = randInt(7, 11);
  const startM = choice([0,10,15,20,30,35,40,45,50]);
  const addM = choice([25,35,40,50,75,90,110]);
  const start = startH*60 + startM;
  const end = start + addM;
  const ans = minutesToTime12(end);
  return T("M_timeAdd", 3,
    `A movie starts at <b>${minutesToTime12(start)}</b>. It lasts <b>${addM}</b> minutes.<br>
     What time does it finish? (Answer like <b>9:15 pm</b>)`,
    {type:"time", mins:end},
    `${ans}`,
    `Enter a time like 9:15 pm.`,
    `Add minutes, then convert back to a clock time.`
  );
}
function tplM_orderOps(){
  const a = randInt(8, 20);
  const b = randInt(6, 15);
  const c = randInt(3, 12);
  const d = randInt(2, 9);
  const ans = a + b*c - d;
  return T("M_orderOps", 0,
    `Calculate: <b>${a} + ${b} × ${c} − ${d}</b>.`,
    {type:"integer", value:ans},
    `${ans}`,
    `Enter an integer.`,
    `Multiply first, then add/subtract.`
  );
}

/* ---------------- screenshot14-style mixed op: RANDOM numbers + RANDOM +/−, answer as simplified fraction ---------------- */
function tplM_mixedOpAnswerFraction(){
  const op = choice(["+","−"]);
  const DENOMS = [2,4,5,8,10,12];

  function makeMixed(){
    const d = choice(DENOMS);
    const whole = randInt(2, 18);
    const n = randInt(1, d-1);
    return { whole, n, d };
  }

  let A = makeMixed();
  let B = makeMixed();

  function toImproper(M){ return M.whole * M.d + M.n; }

  // ensure subtraction not negative
  if (op === "−"){
    let tries = 0;
    while ( (toImproper(A)/A.d) <= (toImproper(B)/B.d) && tries < 120 ){
      A = makeMixed(); B = makeMixed(); tries++;
    }
  }

  const aN = toImproper(A), aD = A.d;
  const bN = toImproper(B), bD = B.d;

  const L = lcm(aD, bD);
  const Aeq = aN * (L / aD);
  const Beq = bN * (L / bD);

  const num = (op === "+") ? (Aeq + Beq) : (Aeq - Beq);
  const r = reduceFraction(num, L);

  const left  = mixedHTML(A.whole, A.n, A.d);
  const right = mixedHTML(B.whole, B.n, B.d);

  const forceMixed = isMixedValue(r.a, r.b);

  return T("M_mixed_op_fraction", 1,
    `Calculate: <b>${left} ${op} ${right}</b>.<br>
     Give your answer as a <b>fraction in simplest form</b>.`,
    {type:"fraction", a:r.a, b:r.b, forceMixed: forceMixed},
    `${fracHTML(r.a,r.b)}`,
    forceMixed ? `Use the 3-box mixed-number input.` : `Enter as a/b (e.g., 7/10).`,
    `Convert to improper fractions, use a common denominator, then simplify.`
  );
}

/* --- extra MEDIUM templates to enrich randomness --- */
function tplM_fracSubtractUnlike(){
  const d1 = choice([6,8,9,10,12]);
  const d2 = choice([6,8,9,10,12]);
  let a = randInt(1, d1-1);
  let b = randInt(1, d2-1);

  const L = lcm(d1,d2);
  let Aeq = a*(L/d1);
  let Beq = b*(L/d2);

  // ensure positive result
  if (Aeq < Beq){
    const tmp = Aeq; Aeq = Beq; Beq = tmp;
    const tmp2 = a; a = b; b = tmp2;
    const tmp3 = d1; // NOTE: keep display consistent by swapping denominators too
    // swap denominators for display
    // (we only swapped numerators; now swap denominators so the displayed fractions match)
  }

  // Recompute displayed denominators properly by using original values:
  // We'll just build again with two new fractions ensuring positive:
  let tries=0;
  while (tries<60){
    const D1 = choice([6,8,9,10,12]);
    const D2 = choice([6,8,9,10,12]);
    const A = randInt(1, D1-1);
    const B = randInt(1, D2-1);
    const LL = lcm(D1,D2);
    const AA = A*(LL/D1);
    const BB = B*(LL/D2);
    if (AA > BB){
      a=A; b=B;
      const diffN = AA - BB;
      const r = reduceFraction(diffN, LL);
      return T("M_fracSubUnlike", 1,
        `Find: ${fracHTML(a,D1)} − ${fracHTML(b,D2)} (simplest form).`,
        {type:"fraction", a:r.a, b:r.b},
        `${fracHTML(r.a,r.b)}`,
        `Enter as a fraction like 5/6.`,
        `Use a common denominator, subtract, then simplify.`
      );
    }
    tries++;
  }
  return tplM_fracSubtractUnlike();
}

function tplM_decimalAddSub(){
  const a = randInt(120, 980) / 10;   // 1 dp
  const b = randInt(105, 995) / 100;  // 2 dp
  const op = choice(["+","−"]);
  const val = (op === "+") ? (a + b) : (a - b);
  const ans = roundToDp(val, 2);
  return T("M_decimalAddSub", 1,
    `Calculate: <b>${a.toFixed(1)} ${op} ${b.toFixed(2)}</b>. Give your answer to <b>2 decimal places</b>.`,
    {type:"decimal", value:val, dp:2},
    `${ans.toFixed(2)}`,
    `Enter a decimal (2 dp).`,
    `Line up decimal points, then add/subtract.`
  );
}

function tplM_areaRectangle(){
  const L = randInt(6, 28);
  const W = randInt(4, 18);
  const area = L*W;
  return T("M_areaRect", 4,
    `A rectangle is <b>${L} cm</b> long and <b>${W} cm</b> wide. Find its area.`,
    {type:"integer", value:area},
    `${area} cm²`,
    `Enter an integer (cm²).`,
    `Area = length × width.`
  );
}

function tplM_volumeCuboid(){
  const L = randInt(4, 16);
  const W = randInt(3, 12);
  const H = randInt(2, 10);
  const vol = L*W*H;
  return T("M_volumeCuboid", 4,
    `A cuboid is <b>${L} cm</b> long, <b>${W} cm</b> wide and <b>${H} cm</b> high. Find its volume.`,
    {type:"integer", value:vol},
    `${vol} cm³`,
    `Enter an integer (cm³).`,
    `Volume = length × width × height.`
  );
}

function tplM_average5(){
  const base = randInt(10, 40);
  const nums = [base-4, base-1, base, base+2, base+3];
  const sum = nums.reduce((a,b)=>a+b,0);
  const avg = sum/5;
  return T("M_average5", 5,
    `The numbers are <b>${nums.join(", ")}</b>. Find the average (mean).`,
    {type:"integer", value:avg},
    `${avg}`,
    `Enter an integer.`,
    `Average = sum ÷ 5.`
  );
}

function tplM_probabilitySimple(){
  const r = randInt(3, 9);
  const b = randInt(4, 10);
  const g = randInt(2, 8);
  const total = r+b+g;
  const rr = reduceFraction(r, total);
  return T("M_probabilityRed", 5,
    `A bag contains <b>${r}</b> red, <b>${b}</b> blue and <b>${g}</b> green marbles.<br>
     A marble is chosen at random. What is the probability of choosing a <b>red</b> marble? (simplest form)`,
    {type:"fraction", a:rr.a, b:rr.b},
    `${fracHTML(rr.a, rr.b)}`,
    `Enter as a fraction like 3/10.`,
    `Probability = favourable ÷ total.`
  );
}

function tplM_linearEquationTwoStep(){
  const x = randInt(4, 25);
  const a = choice([2,3,4,5,6,7,8,9]);
  const b = randInt(2, 12);
  const sign = choice(["+","−"]);
  const inner = (sign === "+") ? (x + b) : (x - b);
  const left = a * inner;

  return T("M_linear2", 0,
    `Solve for <b>x</b>: <b>${a}(x ${sign} ${b}) = ${left}</b>.`,
    {type:"integer", value:x},
    `${x}`,
    `Enter an integer.`,
    `Divide both sides by ${a}, then undo ${sign === "+" ? "adding" : "subtracting"} ${b}.`
  );
}

function tplM_speedDistance(){
  const timeH = choice([2,3,4,5,6]);
  const speed = choice([35,40,45,50,55,60,65,70]);
  const dist = timeH * speed;
  return T("M_speedDist", 5,
    `A cyclist travels <b>${dist} km</b> in <b>${timeH} hours</b> at a constant speed.<br>
     Find the speed in <b>km/h</b>.`,
    {type:"integer", value:speed},
    `${speed} km/h`,
    `Enter an integer (km/h).`,
    `Speed = distance ÷ time.`
  );
}

function tplM_fracToPercent(){
  const fracs = [[1,2],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[3,10],[7,10]];
  const [n,d] = choice(fracs);
  const pct = (n/d)*100;
  return T("M_fracToPercent", 1,
    `Convert ${fracHTML(n,d)} to a percentage.`,
    {type:"integer", value:pct},
    `${pct}%`,
    `Enter an integer (%).`,
    `Multiply by 100%.`
  );
}

/* ==========================================================
   Template bank — HARD (4 pts)  (text-only geometry)
========================================================== */
function tplH_filmRollsScreenshot15(){
  return T("IMG15_film_rolls", 5,
    `A shop collected <b>$6384</b> from selling film. The film was packed in <b>packs of 2 rolls</b>.<br>
     If each pack cost <b>$21</b>, how many rolls of film were sold altogether?`,
    {type:"integer", value:608},
    `608`,
    `Enter an integer (rolls).`,
    `Number of packs = 6384 ÷ 21, then multiply by 2.`
  );
}
function tplH_ratioFailPassScreenshot19(){
  return T("IMG19_ratio_fail_pass", 2,
    `There are <b>42</b> students in a class. If <b>8</b> students fail a test, what is the ratio of<br>
     (students who fail) : (students who pass)? Give your ratio in simplest form.`,
    {type:"ratio2", values:[4,17]},
    `4:17`,
    `Answer format: a:b (simplest form).`,
    `Pass = 42 − 8, then simplify 8:pass.`
  );
}
function tplH_areaTriangleScreenshot20(){
  return T("IMG20_area_triangle", 4,
    `A triangle has a base of <b>40 cm</b> and a height of <b>58 cm</b>.<br>
     Find its area.`,
    {type:"integer", value:1160},
    `1160 cm²`,
    `Enter an integer (cm²).`,
    `Area = (base × height) ÷ 2.`
  );
}
function tplH_cakesMoneyScreenshot21(){
  return T("IMG21_cakes_money", 5,
    `Max baked <b>12</b> trays of cakes. There were <b>12</b> cakes on each tray.<br>
     He sold each cake for <b>$10</b>. How much money would he collect if he sold all the cakes?`,
    {type:"integer", value:1440},
    `$1440`,
    `Enter an integer (dollars).`,
    `Total cakes = 12 × 12, then multiply by $10.`
  );
}

/* TEXT-ONLY replacement for the old “shaded right triangle diagram” */
function tplH_rightTriangleArea_TextOnly(){
  const base = choice([6,8,10,12,14,16]);
  const height = choice([5,7,9,11,13,15]);
  const area = (base * height) / 2;
  if (!Number.isInteger(area)) return tplH_rightTriangleArea_TextOnly();
  return T("H_rightTriangleArea_text", 4,
    `A right triangle has a base of <b>${base} cm</b> and a height of <b>${height} cm</b>.<br>
     Find the area of the triangle.`,
    {type:"integer", value:area},
    `${area} cm²`,
    `Enter an integer (cm²).`,
    `Area = (base × height) ÷ 2.`
  );
}

function tplH_mixedTimesScreenshot23(){
  const m = mixedHTML(4,6,8);
  return T("IMG23_mixed_times", 1,
    `Find the value of ${m} × <b>12</b>.`,
    {type:"integer", value:57},
    `57`,
    `Enter an integer.`,
    `Simplify ${fracHTML(6,8)} first, convert to an improper fraction, then multiply.`
  );
}
function tplH_wordsToNumeralsScreenshot24(){
  return T("IMG24_words_to_numerals", 0,
    `Write <b>three million, five hundred and nine thousand</b> in numerals.`,
    {type:"integer", value:3509000},
    `3,509,000`,
    `Enter an integer (digits only).`,
    `3,000,000 + 509,000.`
  );
}
function tplH_mixtureBottlesScreenshot25(){
  return T("IMG25_mixture_bottles", 3,
    `Jasmine mixes <b>3750 ml</b> of rose syrup with <b>8750 ml</b> of water.<br>
     The mixture fills <b>10</b> identical bottles equally. What is the capacity of each bottle in <b>litres</b>?`,
    {type:"decimal", value:1.25, dp:2},
    `1.25 L`,
    `Enter a decimal (litres).`,
    `Add volumes, divide by 10, then convert ml → L.`
  );
}
function tplH_proportionScreenshot26(){
  return T("IMG26_ratio_proportion", 2,
    `If <b>18 : 30 : 72 = 6 : □ : 24</b>, what is the missing number?`,
    {type:"integer", value:10},
    `10`,
    `Enter an integer.`,
    `Scale factor is 18 → 6 (÷3). Apply the same to 30.`
  );
}
function tplH_tankFractionScreenshot27(){
  return T("IMG27_tank_fraction", 3,
    `A rectangular tank is <b>45 cm</b> long, <b>24 cm</b> wide and <b>30 cm</b> high, and is filled to the brim.<br>
     Maggie takes ${fracHTML(1,5)} of the water from the tank. How much water is taken, in <b>litres</b>? (1 L = 1000 cm³)`,
    {type:"decimal", value:6.48, dp:2},
    `6.48 L`,
    `Enter a decimal (litres).`,
    `Volume = L×W×H, take ${fracHTML(1,5)}, then convert cm³ to litres.`
  );
}
function tplH_sugarLeftScreenshot28(){
  return T("IMG28_sugar_left", 1,
    `Mrs Brown bought <b>3 kg</b> of sugar. She used ${fracHTML(3,4)} of it.<br>
     How many <b>grams</b> of sugar did she have left?`,
    {type:"integer", value:750},
    `750 g`,
    `Enter an integer (grams).`,
    `Left = ${fracHTML(1,4)} of 3 kg = 0.75 kg = 750 g.`
  );
}
function tplH_ageRatioScreenshot29(){
  return T("IMG29_age_ratio", 2,
    `Derrick is <b>8</b> years old. He is <b>32</b> years younger than his father.<br>
     Express the ratio of Derrick's age to his father's age in simplest form.`,
    {type:"ratio2", values:[1,5]},
    `1:5`,
    `Answer format: a:b (simplest form).`,
    `Father = 8 + 32, then simplify 8:father.`
  );
}
function tplH_expressionScreenshot30(){
  return T("IMG30_expression", 0,
    `Find the value of <b>80 × (69 + 22) − 288</b>.`,
    {type:"integer", value:6992},
    `6992`,
    `Enter an integer.`,
    `Do brackets first.`
  );
}
function tplH_platesCupsScreenshot36(){
  return T("IMG36_plates_cups", 5,
    `3 similar plates and 4 similar cups cost <b>$35.50</b> while 3 such plates and 3 such cups cost <b>$31.50</b>.<br>
     What is the cost of <b>9</b> such plates?`,
    {type:"money", cents:5850},
    `$58.50`,
    `Enter dollars (e.g., 58.50).`,
    `Subtract to find 1 cup, then find 1 plate, then ×9.`
  );
}
function tplH_octagonAreaScreenshot37(){
  return T("IMG37_octagon_area", 4,
    `An octagon is made up of <b>8</b> identical triangles. Each triangle has a base of <b>5 cm</b> and a height of <b>8 cm</b>.<br>
     Find the area of the octagon.`,
    {type:"integer", value:160},
    `160 cm²`,
    `Enter an integer (cm²).`,
    `Area of 1 triangle = (5×8)/2, then ×8.`
  );
}
function tplH_basketsMassScreenshot38(){
  const t1 = mixedHTML(21,3,5);
  const a = mixedHTML(6,1,4);
  const more = mixedHTML(2,7,8);
  return T("IMG38_baskets_mass", 3,
    `The total mass of 3 baskets of vegetables is ${t1}.<br>
     Basket A has a mass of ${a} and Basket B has a mass of ${more} more than Basket A.<br>
     Find the difference between the mass of the heaviest and the lightest baskets (in kg).`,
    {type:"decimal", value:2.9, dp:2},
    `2.90 kg`,
    `Enter a decimal (kg).`,
    `Find B from A, then C from total, then heaviest − lightest.`
  );
}
function tplH_squareAreaDiffScreenshot39(){
  return T("IMG39_square_area_diff", 4,
    `The sides of two squares are in the ratio <b>7 : 9</b>. The perimeter of the smaller square is <b>112 cm</b>.<br>
     What is the difference in the area of the two squares?`,
    {type:"integer", value:512},
    `512 cm²`,
    `Enter an integer (cm²).`,
    `Find side from perimeter, scale by ratio, then subtract areas.`
  );
}
function tplH_tourPackagesScreenshot40(){
  const jpMul = mixedHTML(2,1,2);
  const frac = fracHTML(5,7);
  return T("IMG40_tour_packages", 5,
    `A tour package to Japan is ${jpMul} times as much as a tour package to Indonesia.<br>
     The tour package to Japan is ${frac} times as much as a tour package to England.<br>
     If the cost of the Indonesian tour package is <b>$880</b>, find the total cost of all three tour packages.`,
    {type:"integer", value:6160},
    `$6160`,
    `Enter an integer (dollars).`,
    `Find Japan from Indonesia, then England from Japan, then add all three.`
  );
}
function tplH_forksSpoonsScreenshot41(){
  return T("IMG41_forks_spoons", 5,
    `Angie bought an equal number of forks and spoons for a party.<br>
     Forks were sold at <b>3 for $2</b> while spoons were sold at <b>4 for $3</b>.<br>
     She spent <b>$5</b> more on spoons than on forks. How much did she spend altogether?`,
    {type:"integer", value:85},
    `$85`,
    `Enter an integer (dollars).`,
    `Let n be the number of each. Use unit prices and solve.`
  );
}
function tplH_clubMembersScreenshot42(){
  return T("IMG42_club_members", 5,
    `Last year, ${fracHTML(1,4)} of the members in a health club were women.<br>
     When <b>56</b> women joined the club, the fraction of women became ${fracHTML(5,6)}.<br>
     How many men were there in the health club <b>last year</b>?`,
    {type:"integer", value:12},
    `12`,
    `Enter an integer (men).`,
    `Solve for original total using fractions, then take 3/4.`
  );
}
function tplH_blueRedPensScreenshot43(){
  return T("IMG43_blue_red_pens", 5,
    `There were <b>648</b> more blue pens than red pens in a stationery shop.<br>
     After ${fracHTML(1,6)} of the blue pens and ${fracHTML(3,4)} of the red pens were sold, there were <b>1338</b> more blue pens than red pens left.<br>
     How many blue pens were there at first?`,
    {type:"integer", value:2016},
    `2016`,
    `Enter an integer.`,
    `Let red = R, blue = R+648. Use new difference after selling fractions.`
  );
}
function tplH_averageRatioScreenshot44(){
  return T("IMG44_average_ratio", 5,
    `Andrew, Bertha and Chloe collected money for their class fund.<br>
     The average collected by Andrew and Bertha was <b>$108</b>. The average collected by Andrew and Chloe was <b>$142</b>.<br>
     The ratio of the amount collected by Chloe to Bertha was <b>3 : 1</b>.<br>
     Find the total amount collected.`,
    {type:"integer", value:318},
    `$318`,
    `Enter an integer (dollars).`,
    `Turn averages into sums; use C = 3B, solve then add.`
  );
}
function tplH_tradingCardsScreenshot45(){
  return T("IMG45_trading_cards", 5,
    `Cathy had five times as many trading cards as Patrick.<br>
     Cathy gave ${fracHTML(1,4)} of her cards to Patrick. Patrick then gave ${fracHTML(1,3)} of his trading cards to Cathy.<br>
     If Cathy had <b>96</b> more trading cards than Patrick in the end, how many trading cards did Cathy have at first?`,
    {type:"integer", value:160},
    `160`,
    `Enter an integer.`,
    `Let Patrick = p, Cathy = 5p. Track transfers, then use final difference.`
  );
}
function tplH_daphneRatioScreenshot46a(){
  const frac = fracHTML(1,5);
  return T("IMG46a_daphne_ratio", 2,
    `Daphne's present age is ${frac} her grandmother's present age.<br>
     Five years ago, her grandmother was <b>60</b> years old.<br>
     Express Daphne's age five years ago as a ratio of her grandmother's age five years ago, in simplest form.`,
    {type:"ratio2", values:[2,15]},
    `2:15`,
    `Answer format: a:b (simplest form).`,
    `Grandmother now = 65, Daphne now = 13; subtract 5 and simplify.`
  );
}
function tplH_daphneYearsScreenshot46b(){
  const frac = fracHTML(1,5);
  const frac2 = fracHTML(2,5);
  return T("IMG46b_daphne_years", 0,
    `Daphne's present age is ${frac} her grandmother's present age. Five years ago, her grandmother was <b>60</b> years old.<br>
     In how many years' time will Daphne's age be ${frac2} of her grandmother's <b>present</b> age?`,
    {type:"integer", value:13},
    `13`,
    `Enter an integer (years).`,
    `Grandmother present age is fixed at 65; solve 13 + x = (${fracHTML(2,5)})×65.`
  );
}
function tplH_containerCupsScreenshot47(){
  return T("IMG47_container_cups", 4,
    `A container has a square base of <b>121 cm²</b> and a height of <b>8 cm</b>.<br>
     It is ${fracHTML(1,4)} filled with water. The water is poured into cups of <b>22 ml</b>.<br>
     How many cups are needed? (1 ml = 1 cm³)`,
    {type:"integer", value:11},
    `11`,
    `Enter an integer (cups).`,
    `Volume = base area × height, take ${fracHTML(1,4)}, then ÷22.`
  );
}
function tplH_cubesHeightScreenshot48(){
  return T("IMG48_cubes_height", 4,
    `A solid is made up of <b>1-cm cubes</b>. The top layer has <b>15</b> cubes (a 5 by 3 rectangle).<br>
     If the volume of the solid is <b>30 cm³</b>, what is its height (in cm)?`,
    {type:"integer", value:2},
    `2 cm`,
    `Enter an integer (cm).`,
    `Height = total volume ÷ cubes per layer.`
  );
}
function tplH_triangleSquaresScreenshot49a(){
  return T("IMG49a_triangle_height", 4,
    `A figure is made using <b>8 identical squares</b> and a triangle on top.<br>
     The 8 squares have a total area of <b>1568 cm²</b>.<br>
     The height of the triangle is <b>4 cm less</b> than its base. The triangle sits on top of <b>2 squares</b> (so its base equals the width of 2 squares).<br>
     Find the height of the triangle.`,
    {type:"integer", value:24},
    `24 cm`,
    `Enter an integer (cm).`,
    `Find square side → triangle base (2 sides) → height = base − 4.`
  );
}
function tplH_triangleSquaresScreenshot49b(){
  return T("IMG49b_ratio_areas", 4,
    `Using the same figure: the 8 squares have total area <b>1568 cm²</b>, and the triangle sits on top of <b>2 squares</b>.<br>
     Find the ratio of (area of 1 square) : (area of the triangle) : (area of the whole figure), in simplest form.`,
    {type:"ratio3", values:[7,12,68]},
    `7:12:68`,
    `Answer format: a:b:c (simplest form).`,
    `Find triangle area and total area, then simplify the 3-term ratio.`
  );
}

/* Extra hard templates to enrich randomness */
function tplH_reverseFractionOfNumber(){
  const num = choice([180, 240, 300, 360, 420, 480]);
  const frac = choice([[2,3],[3,4],[4,5],[5,6]]);
  const part = num * (frac[0]/frac[1]);
  if (!Number.isInteger(part)) return tplH_reverseFractionOfNumber();
  return T("H_reverseFrac", 1,
    `${fracHTML(frac[0], frac[1])} of a number is <b>${part}</b>. What is the original number?`,
    {type:"integer", value:num},
    `${num}`,
    `Enter an integer.`,
    `Original = part ÷ (${fracHTML(frac[0], frac[1])}).`
  );
}
function tplH_percentIncrease(){
  const original = choice([80,120,150,200,240,320,400]);
  const pct = choice([10,15,20,25]);
  const newVal = original*(1+pct/100);
  if (Math.abs(newVal - Math.round(newVal)) > 1e-9) return tplH_percentIncrease();
  return T("H_percentIncrease", 1,
    `A bike costs <b>$${original}</b>. Its price increases by <b>${pct}%</b>.<br>
     What is the new price?`,
    {type:"integer", value:newVal},
    `$${newVal}`,
    `Enter an integer (dollars).`,
    `New = original × (1 + pct/100).`
  );
}
function tplH_negTempChange(){
  const start = -randInt(2, 12);
  const up = randInt(3, 10);
  const down = randInt(2, 9);
  const final = start + up - down;
  return T("H_negTemp", 0,
    `At 6am the temperature was <b>${start}°C</b>. It rose by <b>${up}°C</b> and later dropped by <b>${down}°C</b>.<br>
     What was the final temperature?`,
    {type:"integer", value:final},
    `${final}°C`,
    `Enter an integer (°C).`,
    `Start + rise − drop.`
  );
}
function tplH_areaCompositeRectangles(){
  const a = randInt(6, 14);
  const b = randInt(4, 10);
  const c = randInt(4, 12);
  const d = randInt(3, 8);
  const area = a*b + c*d;
  return T("H_areaComposite2Rect", 4,
    `A shape is made by joining two rectangles (no overlap):<br>
     • Rectangle 1: <b>${a} cm</b> by <b>${b} cm</b><br>
     • Rectangle 2: <b>${c} cm</b> by <b>${d} cm</b><br>
     Find the total area.`,
    {type:"integer", value:area},
    `${area} cm²`,
    `Enter an integer (cm²).`,
    `Add the areas of the two rectangles.`
  );
}

/* --- extra HARD templates to enrich randomness --- */
function tplH_ratio3Share(){
  const total = choice([210, 240, 270, 300, 360, 420]);
  let a = choice([2,3,4,5]);
  let b = choice([3,4,5,6,7]);
  let c = choice([4,5,6,7,8]);
  const sum = a+b+c;
  if (total % sum !== 0) return tplH_ratio3Share();
  const unit = total / sum;
  const A = a*unit, B = b*unit, C = c*unit;
  const who = choice(["Ava","Ben","Chloe"]);
  const ask = choice(["largest","difference"]);
  let ans, question;
  if (ask === "largest"){
    ans = Math.max(A,B,C);
    question = `Three friends share <b>${total}</b> stickers in the ratio <b>${a}:${b}:${c}</b> (Ava:Ben:Chloe).<br>
               How many stickers does the friend with the <b>largest</b> share get?`;
  } else {
    ans = Math.max(A,B,C) - Math.min(A,B,C);
    question = `Three friends share <b>${total}</b> stickers in the ratio <b>${a}:${b}:${c}</b> (Ava:Ben:Chloe).<br>
               What is the <b>difference</b> between the largest and smallest shares?`;
  }
  return T("H_ratio3Share", 2,
    question,
    {type:"integer", value:ans},
    `${ans}`,
    `Enter an integer.`,
    `Find 1 unit = total ÷ (ratio sum), then scale.`
  );
}

function tplH_busScheduleLCM(){
  const startH = choice([7,8,9]);
  const startM = choice([0,10,15,20,30,40,45,50]);
  const A = choice([12,15,18,20,24]);
  const B = choice([10,16,20,25,30]);
  const start = startH*60 + startM;
  const L = lcm(A,B);
  const next = start + L;
  return T("H_busLCM", 3,
    `Bus A leaves every <b>${A}</b> minutes and Bus B leaves every <b>${B}</b> minutes.<br>
     If they both leave together at <b>${minutesToTime12(start)}</b>, what time will they next leave together?`,
    {type:"time", mins:next},
    `${minutesToTime12(next)}`,
    `Enter a time like 9:15 am.`,
    `Next time together is after LCM(${A}, ${B}) minutes.`
  );
}

function tplH_originalFromRemainingFraction(){
  const d = choice([4,5,6,8,10,12]);
  const usedN = choice([1,2,3,4,5]);
  if (usedN >= d) return tplH_originalFromRemainingFraction();
  const remainN = d - usedN;

  const base = choice([20,25,30,35,40,45,50,60,70,80,90,100]);
  // choose original so that remaining is integer base
  const original = base * d / remainN;
  if (!Number.isInteger(original)) return tplH_originalFromRemainingFraction();

  return T("H_originalRemainFrac", 1,
    `After using ${fracHTML(usedN, d)} of a container of juice, there are <b>${base} L</b> left.<br>
     How many litres were in the container at first?`,
    {type:"integer", value:original},
    `${original} L`,
    `Enter an integer (litres).`,
    `Remaining fraction is ${fracHTML(remainN, d)}, so original = remaining ÷ (${fracHTML(remainN, d)}).`
  );
}

function tplH_arithSequenceNth(){
  const a1 = randInt(2, 20);
  const d = choice([2,3,4,5,6,7,8,9,10]);
  const n = randInt(8, 25);
  const an = a1 + (n-1)*d;
  return T("H_arithNth", 0,
    `The sequence is <b>${a1}, ${a1+d}, ${a1+2*d}, ...</b><br>
     Find the <b>${n}th</b> term.`,
    {type:"integer", value:an},
    `${an}`,
    `Enter an integer.`,
    `Use aₙ = a₁ + (n−1)d.`
  );
}

function tplH_twoStepEquationFraction(){
  // (ax + b)/c = k
  const x = randInt(3, 20);
  const a = choice([2,3,4,5,6,7,8,9]);
  const b = randInt(-12, 12);
  const c = choice([2,3,4,5,6]);
  const k = (a*x + b)/c;
  if (!Number.isFinite(k) || Math.abs(k - Math.round(k)) > 1e-9) return tplH_twoStepEquationFraction();
  const kk = Math.round(k);
  const sign = b >= 0 ? "+" : "−";
  const bb = Math.abs(b);
  return T("H_eqnFrac", 0,
    `Solve for <b>x</b>: <b>(${a}x ${sign} ${bb}) ÷ ${c} = ${kk}</b>.`,
    {type:"integer", value:x},
    `${x}`,
    `Enter an integer.`,
    `Multiply both sides by ${c}, then solve ${a}x ${sign} ${bb} = ${c*kk}.`
  );
}

function tplH_rectPerimRatioArea(){
  const ratio = choice([[2,3],[3,5],[4,7],[5,8],[7,9]]);
  const k = randInt(4, 18);
  const L = ratio[1]*k;
  const W = ratio[0]*k;
  const P = 2*(L+W);
  const area = L*W;
  return T("H_rectPerimRatio", 4,
    `A rectangle has length : width = <b>${ratio[1]} : ${ratio[0]}</b>.<br>
     Its perimeter is <b>${P} cm</b>. Find its area.`,
    {type:"integer", value:area},
    `${area} cm²`,
    `Enter an integer (cm²).`,
    `Use the ratio to write length and width as multiples of k, then use the perimeter to find k.`
  );
}

function tplH_twoStageProbability(){
  const reds = randInt(2, 6);
  const blues = randInt(3, 7);
  const total = reds + blues;
  // Draw one without replacement then flip coin
  const pRed = {a: reds, b: total};
  const pHeads = {a:1, b:2};
  const num = pRed.a * pHeads.a;
  const den = pRed.b * pHeads.b;
  const r = reduceFraction(num, den);
  return T("H_twoStageProb", 5,
    `A bag has <b>${reds}</b> red and <b>${blues}</b> blue balls.<br>
     One ball is chosen at random (not replaced). Then a fair coin is flipped.<br>
     What is the probability of choosing a <b>red</b> ball and getting <b>heads</b>? (simplest form)`,
    {type:"fraction", a:r.a, b:r.b},
    `${fracHTML(r.a,r.b)}`,
    `Enter as a fraction like 1/6.`,
    `Multiply probabilities: P(red) × P(heads).`
  );
}

function tplH_shoppingChangeMulti(){
  const price1 = choice([8.75, 12.50, 15.20, 18.60, 24.30]);
  const price2 = choice([6.40, 9.80, 11.25, 14.70, 19.90]);
  const q1 = choice([2,3,4]);
  const q2 = choice([1,2,3,5]);
  const subtotal = price1*q1 + price2*q2;

  const discPct = choice([10,15,20]);
  const discounted = subtotal * (1 - discPct/100);

  // paid is next multiple of 10 above discounted
  const paid = Math.ceil(discounted/10)*10;
  const change = paid - discounted;

  const changeCents = Math.round(change*100);
  return T("H_shoppingChange", 5,
    `A shopper buys <b>${q1}</b> items at <b>$${price1.toFixed(2)}</b> each and <b>${q2}</b> items at <b>$${price2.toFixed(2)}</b> each.<br>
     The shop gives a <b>${discPct}%</b> discount on the total. The shopper pays with <b>$${paid}</b>.<br>
     How much change do they receive? (to the nearest cent)`,
    {type:"money", cents:changeCents},
    `$${(changeCents/100).toFixed(2)}`,
    `Enter dollars (e.g., 12.50).`,
    `Find subtotal, apply discount, then change = paid − discounted.`
  );
}

/* ==========================================================
   Build banks
========================================================== */
const EASY_BANK = [
  tplE_negCompare,
  tplE_roundNearest1000,
  tplE_simplifyFraction,
  tplE_percentOfNumber,
  tplE_digitsToWords,
  tplE_ratioSimplify,
  tplE_placeValue,
  tplE_decimalCompare,
  tplE_fractionOfNumber,
  tplE_timeToMinutes,
  tplE_lengthConvert,
  tplE_perimeterSquare
];

const MED_BANK = [
  tplM_addSubNeg,
  tplM_fracAddUnlike,
  tplM_percentReverse,
  tplM_ratioWordShare,
  tplM_linearEquationOneStep,
  tplM_improperToMixed_TextOnly,
  // text-only replacement
  tplM_estimateDivision,
  tplM_moneyMulti,
  tplM_ratioFromScreenshot12,
  tplM_decimalFromMixedScreenshot13,
  tplM_decimalTimesInt,
  tplM_decimalDivide10_100,
  tplM_perimeterRectangle,
  tplM_timeAdd,
  tplM_orderOps,
  tplM_mixedOpAnswerFraction,
  tplM_fracSubtractUnlike,
  tplM_decimalAddSub,
  tplM_areaRectangle,
  tplM_volumeCuboid,
  tplM_average5,
  tplM_probabilitySimple,
  tplM_linearEquationTwoStep,
  tplM_speedDistance,
  tplM_fracToPercent
];

const HARD_BANK = [
  tplH_filmRollsScreenshot15,
  tplH_ratioFailPassScreenshot19,
  tplH_areaTriangleScreenshot20,
  tplH_cakesMoneyScreenshot21,
  tplH_rightTriangleArea_TextOnly,
  // text-only geometry
  tplH_mixedTimesScreenshot23,
  tplH_wordsToNumeralsScreenshot24,
  tplH_mixtureBottlesScreenshot25,
  tplH_proportionScreenshot26,
  tplH_tankFractionScreenshot27,
  tplH_sugarLeftScreenshot28,
  tplH_ageRatioScreenshot29,
  tplH_expressionScreenshot30,
  tplH_platesCupsScreenshot36,
  tplH_octagonAreaScreenshot37,
  tplH_basketsMassScreenshot38,
  tplH_squareAreaDiffScreenshot39,
  tplH_tourPackagesScreenshot40,
  tplH_forksSpoonsScreenshot41,
  tplH_clubMembersScreenshot42,
  tplH_blueRedPensScreenshot43,
  tplH_averageRatioScreenshot44,
  tplH_tradingCardsScreenshot45,
  tplH_daphneRatioScreenshot46a,
  tplH_daphneYearsScreenshot46b,
  tplH_containerCupsScreenshot47,
  tplH_cubesHeightScreenshot48,
  tplH_triangleSquaresScreenshot49a,
  tplH_triangleSquaresScreenshot49b,
  tplH_reverseFractionOfNumber,
  tplH_percentIncrease,
  tplH_negTempChange,
  tplH_areaCompositeRectangles,
  tplH_ratio3Share,
  tplH_busScheduleLCM,
  tplH_originalFromRemainingFraction,
  tplH_arithSequenceNth,
  tplH_twoStepEquationFraction,
  tplH_rectPerimRatioArea,
  tplH_twoStageProbability,
  tplH_shoppingChangeMulti
];

/* Uniqueness: pick WITHOUT replacement per bank */
function pickUnique(bank, count){
  if (bank.length < count){
    throw new Error("Question bank too small for uniqueness requirement.");
  }
  return shuffle(bank).slice(0, count);
}

/* ---------------- Generate Questions (40 unique templates) ---------------- */
/* Difficulty ranks (lower = easier). Used to keep questions ordered from easy to hard. */
const DIFF_RANK = {
  // EASY
  "E_negCompare": 1,
  "E_placeValue": 2,
  "E_round1000": 3,
  "E_decimalCompare": 4,
  "E_digitsToWords": 5,
  "E_fracOfNumber": 6,
  "E_percentOf": 7,
  "E_perimeterSquare": 8,
  "E_lengthConvert": 9,
  "E_timeToMinutes": 10,
  "E_ratioSimplify": 11,
  "E_simplifyFrac": 12,

  // MEDIUM
  "M_decimalDivide10_100": 1,
  "M_decimalTimesInt": 2,
  "M_decimalAddSub": 3,
  "M_orderOps": 4,
  "M_addSubNeg": 5,
  "M_estDiv": 6,
  "M_perimeterRect": 7,
  "M_areaRect": 8,
  "M_volumeCuboid": 9,
  "M_timeAdd": 10,
  "M_average5": 11,
  "M_fracAddUnlike": 12,
  "M_fracSubUnlike": 13,
  "M_mixed_op_fraction": 14,
  "M_percentReverse": 15,
  "M_fracToPercent": 16,
  "M_ratioShare": 17,
  "IMG12_ratio_250c_10d": 18,
  "IMG13_mixed_to_decimal": 19,
  "M_moneyMulti": 20,
  "M_speedDist": 21,
  "M_linear1": 22,
  "M_linear2": 23,
  "M_improperToMixed_text": 24,

  // HARD
  "H_negTemp": 1,
  "H_reverseFrac": 2,
  "H_percentIncrease": 3,
  "H_rightTriangleArea_text": 4,
  "H_areaComposite2Rect": 5,
  "IMG20_area_triangle": 6,
  "IMG24_words_to_numerals": 7,
  "IMG30_expression": 8,
  "H_arithNth": 9,
  "H_eqnFrac": 10,
  "H_rectPerimRatio": 11,
  "IMG19_ratio_fail_pass": 12,
  "IMG26_ratio_proportion": 13,
  "H_ratio3Share": 14,
  "IMG29_age_ratio": 15,
  "IMG44_average_ratio": 16,
  "IMG49a_triangle_height": 17,
  "IMG49b_ratio_areas": 18,
  "IMG27_tank_fraction": 19,
  "IMG28_sugar_left": 20,
  "IMG38_baskets_mass": 21,
  "IMG39_square_area_diff": 22,
  "IMG37_octagon_area": 23,
  "IMG48_cubes_height": 24,
  "IMG15_film_rolls": 25,
  "IMG21_cakes_money": 26,
  "IMG23_mixed_times": 27,
  "IMG25_mixture_bottles": 28,
  "IMG36_plates_cups": 29,
  "IMG41_forks_spoons": 30,
  "IMG42_club_members": 31,
  "IMG43_blue_red_pens": 32,
  "IMG45_trading_cards": 33,
  "IMG46a_daphne_ratio": 34,
  "IMG46b_daphne_years": 35,
  "IMG47_container_cups": 36,
  "IMG40_tour_packages": 37,
  "H_originalRemainFrac": 38,
  "H_twoStageProb": 39,
  "H_busLCM": 40,
  "H_shoppingChange": 41
};
function diffRank(id){ return (DIFF_RANK[id] ?? 999); }

function generateQuestions(){
  // Pick templates
  const easyTs = pickUnique(EASY_BANK, 10).map(fn=>fn()).sort((a,b)=>diffRank(a.id)-diffRank(b.id));
  const medTs  = pickUnique(MED_BANK, 15).map(fn=>fn()).sort((a,b)=>diffRank(a.id)-diffRank(b.id));
  const hardTs = pickUnique(HARD_BANK, 15).map(fn=>fn()).sort((a,b)=>diffRank(a.id)-diffRank(b.id));

  // Keep questions ordered by difficulty: EASY → MEDIUM → HARD
  const ts = [...easyTs, ...medTs, ...hardTs];

  const Q = [];
  for (let i=0;i<40;i++){
    const t = ts[i];
    Q.push(makeQ(i, t.partIndex, t.partName, POINTS[i], t.html, t.correct, t.displayCorrect, t.answerHint, t.hint));
  }
  return Q;
}

/* ---------------- UI + State ---------------- */
const quizContent = document.getElementById("quizContent");
const sidebarEl   = document.getElementById("sidebar");
const generateBtn = document.getElementById("generateButton");
const resetBtn    = document.getElementById("resetButton");
const pauseBtn    = document.getElementById("pauseResumeButton");
const exportBtn   = document.getElementById("exportPdfButton");
const exportWordBtn = document.getElementById("exportWordButton");
const modePill    = document.getElementById("modePill");
const metaLine    = document.getElementById("metaLine");

const timerBox    = document.getElementById("timerBox");
const timerLabel  = document.getElementById("timerLabel");
const pausedTag   = document.getElementById("pausedTag");

let MODE = "practice";
let studentName = "Student";
let questions = [];
let currentIndex = 0;
let examSubmitted = false;
let practiceSubmitted = false;

/* ---------------- Timer ---------------- */
let timerInterval = null;
let elapsedMs = 0;
let lastTickMs = 0;
let timerRunning = false;
let timerPaused = false;

function formatElapsed(ms){
  const totalSec = Math.floor(ms / 1000);
  const m = Math.floor(totalSec / 60);
  const s = totalSec % 60;
  return `${pad2(m)}:${pad2(s)}`;
}
function updateTimerUI(){
  timerLabel.textContent = `Time: ${formatElapsed(elapsedMs)}`;
  pausedTag.style.display = timerPaused ? "inline-block" : "none";
}
function startQuizTimer(){
  stopQuizTimer();
  elapsedMs = 0;
  timerRunning = true;
  timerPaused = false;
  lastTickMs = Date.now();
  timerBox.style.display = "inline-flex";
  pauseBtn.style.display = "inline-block";
  pauseBtn.textContent = "Pause";
  updateTimerUI();

  timerInterval = setInterval(() => {
    if (!timerRunning || timerPaused) return;
    const now = Date.now();
    elapsedMs += (now - lastTickMs);
    lastTickMs = now;
    updateTimerUI();
  }, 250);
}
function stopQuizTimer(){
  timerRunning = false;
  timerPaused = false;
  if (timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
  updateTimerUI();
}
function setPausedUI(isPaused){
  const input = document.getElementById("answerInput");
  if (input) input.disabled = isPaused || practiceSubmitted || examSubmitted;

  ["ansWhole","ansNum","ansDen"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = isPaused || practiceSubmitted || examSubmitted;
  });

  ["nextButton","backButton","submitButton","checkButton","submitPracticeButton","saveButton","hintButton"].forEach(id=>{
    const b = document.getElementById(id);
    if (b) b.disabled = isPaused;
  });

  generateBtn.disabled = isPaused;
  resetBtn.disabled = isPaused;
  exportBtn.disabled = isPaused;
  if (exportWordBtn) exportWordBtn.disabled = isPaused;

  sidebarEl.style.pointerEvents = isPaused ? "none" : "auto";
  sidebarEl.style.opacity = isPaused ? "0.6" : "1";
}
function togglePause(){
  if (!timerRunning) return;
  timerPaused = !timerPaused;
  lastTickMs = Date.now();
  pauseBtn.textContent = timerPaused ? "Resume" : "Pause";
  updateTimerUI();
  setPausedUI(timerPaused);
}

/* ---------------- Sidebar ---------------- */
function renderSidebar(){
  sidebarEl.style.display = "block";
  const total = questions.length;

  let sub = "";
  if (MODE === "practice"){
    const answered = questions.filter(q => (q.userValue||"").trim() !== "").length;
    const correctCount = questions.filter(q => q.isCorrect).length;
    sub = practiceSubmitted
      ? `<div class="sub">Submitted. Answered: <b>${answered}</b> / <b>${total}</b><br>Correct: <b>${correctCount}</b> / <b>${total}</b></div>`
      : `<div class="sub">Answered: <b>${answered}</b> / <b>${total}</b><br>(Use <b>Check Answer</b>, then submit on Q${total}.)</div>`;
  } else {
    sub = `<div class="sub">Total: <b>${TOTAL_POINTS}</b> points. Submit on Q${total}.</div>`;
  }

  sidebarEl.innerHTML = `<h4>Questions</h4>${sub}<ul id="qList"></ul>`;
  const ul = document.getElementById("qList");

  for (let i=0;i<total;i++){
    const li = document.createElement("li");
    li.dataset.index = String(i);

    const left = document.createElement("span");
    left.textContent = `Q${i+1}`;

    const badge = document.createElement("span");
    badge.className = "pts-badge";
    badge.textContent = `${questions[i].points} pts`;

    li.appendChild(left);
    li.appendChild(badge);

    li.addEventListener("click", () => {
      if (timerPaused) return;
      saveCurrentInput();
      currentIndex = i;
      renderQuestion();
    });

    ul.appendChild(li);
  }

  updateSidebarStatus();
}
function updateSidebarStatus(){
  const items = document.querySelectorAll("#qList li");
  items.forEach(li => {
    li.classList.remove("active","answered","correct","incorrect");
    const idx = Number(li.dataset.index);
    const q = questions[idx];

    li.classList.toggle("active", idx === currentIndex);

    const hasAns = (q.userValue || "").trim() !== "";

    if (MODE === "practice"){
      if (practiceSubmitted){
        li.classList.add(q.isCorrect ? "correct" : "incorrect");
      } else {
        if (q.checked){
          li.classList.add(q.isCorrect ? "correct" : "incorrect");
        } else if (hasAns){
          li.classList.add("answered");
        }
      }
    } else {
      if (!examSubmitted){
        if (hasAns) li.classList.add("answered");
      } else {
        li.classList.add(q.isCorrect ? "correct" : "incorrect");
      }
    }
  });
}

/* ---------------- Mixed answer input helpers ---------------- */
function needsMixedAnswerUI(correct){
  if (!correct || correct.type !== "fraction") return false;
  if (correct.forceMixed) return true;
  return isMixedValue(correct.a, correct.b);
}
function buildMixedAnswerHTML(prefillStr, locked){
  let w = "", n = "", d = "";
  const f = parseFraction(prefillStr);
  if (f){
    const mx = improperToMixed(f.a, f.b);
    w = String(mx.w);
    n = String(mx.n);
    d = String(mx.d);
    if (mx.n === 0){
      n = "";
      d = "";
    }
  }

  const dis = locked ? "disabled" : "";
  return `
    <div class="mixed-answer" aria-label="mixed answer input">
      <input id="ansWhole" ${dis} inputmode="numeric" placeholder="Whole" value="${(w||"").replace(/"/g,'&quot;')}">
      <div class="fraccol">
        <input id="ansNum" ${dis} inputmode="numeric" placeholder="Num" value="${(n||"").replace(/"/g,'&quot;')}">
        <div class="bar"></div>
        <input id="ansDen" ${dis} inputmode="numeric" placeholder="Den" value="${(d||"").replace(/"/g,'&quot;')}">
      </div>
      <div class="note">Mixed number</div>
    </div>
  `;
}
function readMixedAnswerToString(){
  const wh = (document.getElementById("ansWhole")?.value || "").trim();
  const nu = (document.getElementById("ansNum")?.value || "").trim();
  const de = (document.getElementById("ansDen")?.value || "").trim();

  if (!wh && !nu && !de) return "";
  if (wh && !nu && !de) return wh;
  if (!wh || !nu || !de) return "__incomplete__";
  return `${wh} ${nu}/${de}`;
}

/* ---------------- Save input ---------------- */
function saveCurrentInput(){
  if (practiceSubmitted || examSubmitted) return;

  const q = questions[currentIndex];
  if (needsMixedAnswerUI(q.correct)){
    const v = readMixedAnswerToString();
    if (v === "__incomplete__"){
      return;
    }
    q.userValue = v.trim();
    return;
  }

  const input = document.getElementById("answerInput");
  if (!input) return;
  q.userValue = input.value.trim();
}

/* ---------------- Check (Practice only) ---------------- */
function checkCurrentAnswer(){
  if (timerPaused) return;
  if (practiceSubmitted) return;
  if (MODE !== "practice") return;

  saveCurrentInput();
  const q = questions[currentIndex];
  const fb = document.getElementById("checkFeedback");
  if (!fb) return;

  const ans = (q.userValue || "").trim();
  if (!ans){
    fb.textContent = "Please enter an answer first.";
    fb.className = "check-feedback neutral";
    return;
  }

  if (needsMixedAnswerUI(q.correct)){
    const wh = (document.getElementById("ansWhole")?.value || "").trim();
    const nu = (document.getElementById("ansNum")?.value || "").trim();
    const de = (document.getElementById("ansDen")?.value || "").trim();
    if ((wh && (!nu || !de)) || (!wh && (nu || de))){
      fb.textContent = "Please fill in all 3 boxes (whole, numerator, denominator).";
      fb.className = "check-feedback neutral";
      return;
    }
  }

  const res = compareByType(ans, q.correct);
  q.isCorrect = !!res.ok;
  q.checked = true;

  if (q.isCorrect){
    fb.textContent = "✅ Correct!";
    fb.className = "check-feedback correct";
  } else {
    fb.textContent = `❌ Not quite. Try again.\n(Answer format reminder: ${q.answerHint})`;
    fb.className = "check-feedback incorrect";
  }

  renderSidebar();
}

/* ---------------- Hint button ---------------- */
function toggleHint(){
  const q = questions[currentIndex];
  q.hintShown = !q.hintShown;
  const hb = document.getElementById("hintBox");
  const btn = document.getElementById("hintButton");
  if (hb) hb.style.display = q.hintShown ? "block" : "none";
  if (btn) btn.textContent = q.hintShown ? "Hide Hint" : "Show Hint";
}
function hintBlock(q){
  return `
    <button id="hintButton" class="hint-toggle" type="button">${q.hintShown ? "Hide Hint" : "Show Hint"}</button>
    <div id="hintBox" class="hint-box" style="display:${q.hintShown ? "block" : "none"};">
      <b>Hint:</b> ${q.hint || "Work step-by-step."}
    </div>
  `;
}

/* ---------------- Render answer input ---------------- */
function renderAnswerInput(q){
  const locked = practiceSubmitted || examSubmitted;
  if (needsMixedAnswerUI(q.correct)){
    return buildMixedAnswerHTML(q.userValue || "", locked);
  }
  return `
    <input id="answerInput" class="answer-box" type="text"
      ${locked ? "disabled" : ""}
      value="${(q.userValue||"").replace(/"/g,'&quot;')}" />
  `;
}

/* ---------------- Render question ---------------- */
function renderQuestion(){
  const total = questions.length;
  const q = questions[currentIndex];
  const isLast = (currentIndex === total - 1);

  const topLine = (MODE === "practice")
    ? `Practice Mode — Question ${currentIndex+1} of ${total}`
    : `Exam Mode — Question ${currentIndex+1} of ${total}`;

  const showPrev = currentIndex > 0;
  const showNext = currentIndex < total - 1;

  const showCheck = (MODE === "practice" && !practiceSubmitted);
  const showSubmitExam = (MODE === "exam" && !examSubmitted && isLast);
  const showSubmitPractice = (MODE === "practice" && !practiceSubmitted && isLast);

  const feedbackBox = showCheck ? `<div id="checkFeedback" class="check-feedback"></div>` : ``;

  const pointsLine = (MODE === "exam")
    ? `<div class="points-line">This question is worth <b>${q.points}</b> points.</div>`
    : ``;

  const lockedNote = (examSubmitted)
    ? `<div class="hint-box" style="display:block;background:#fff8e1;border-color:#ffe0b2;">
         <b>Exam submitted.</b> Answers are locked. Use the sidebar to review.
       </div>`
    : (MODE === "practice" && practiceSubmitted)
      ? `<div class="hint-box" style="display:block;background:#fff8e1;border-color:#ffe0b2;">
           <b>Practice submitted.</b> Answers are locked. Use the sidebar to review.
         </div>`
      : ``;

  quizContent.innerHTML = `
    <p class="question-text">${topLine}</p>
    ${pointsLine}
    <p class="instructions">${mathifyText(escapeHTML(q.answerHint))}</p>

    <div class="part-title">${q.partName}</div>

    <div class="single-question">
      <div><b>Q${currentIndex+1}.</b> ${q.html}</div>
      ${renderAnswerInput(q)}
    </div>

    ${hintBlock(q)}
    ${feedbackBox}
    ${lockedNote}

    <div class="question-buttons">
      <button id="backButton" style="${showPrev ? "" : "display:none;"}">Previous</button>
      ${showCheck ? `<button id="checkButton">Check Answer</button>` : ``}
      ${showSubmitPractice ? `<button id="submitPracticeButton">Submit (Practice)</button>` : ``}
      ${showSubmitExam ? `<button id="submitButton">Submit (Exam)</button>` : ``}
      <button id="nextButton" style="${showNext ? "" : "display:none;"}">Next</button>
    </div>
  `;

  document.getElementById("nextButton")?.addEventListener("click", onNext);
  document.getElementById("backButton")?.addEventListener("click", onPrev);
  document.getElementById("checkButton")?.addEventListener("click", checkCurrentAnswer);
  document.getElementById("submitButton")?.addEventListener("click", onSubmitExam);
  document.getElementById("submitPracticeButton")?.addEventListener("click", onSubmitPractice);
  document.getElementById("hintButton")?.addEventListener("click", () => {
    if (timerPaused) return;
    toggleHint();
  });

  updateSidebarStatus();
  setPausedUI(timerPaused);
}

/* ---------------- Navigation ---------------- */
function onNext(){
  if (timerPaused) return;
  saveCurrentInput();
  if (currentIndex < questions.length - 1){
    currentIndex++;
    renderQuestion();
  }
}
function onPrev(){
  if (timerPaused) return;
  saveCurrentInput();
  if (currentIndex > 0){
    currentIndex--;
    renderQuestion();
  }
}

/* ---------------- Grading ---------------- */
function gradeExamAll(){
  let pointsEarned = 0;
  questions.forEach(q => {
    const res = compareByType(q.userValue || "", q.correct);
    q.isCorrect = !!res.ok;
    if (q.isCorrect) pointsEarned += q.points;
  });
  return pointsEarned;
}
function gradePracticeAll(){
  let correctCount = 0;
  questions.forEach(q => {
    const res = compareByType(q.userValue || "", q.correct);
    q.isCorrect = !!res.ok;
    if (q.isCorrect) correctCount++;
  });
  return correctCount;
}
function onSubmitExam(){
  if (timerPaused) return;
  if (examSubmitted) return;
  saveCurrentInput();

  examSubmitted = true;

  timerRunning = false;
  if (timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
  pauseBtn.style.display = "none";
  pausedTag.style.display = "none";

  const pts = gradeExamAll();
  renderSidebar();
  renderExamResults(pts);
}
function onSubmitPractice(){
  if (timerPaused) return;
  if (practiceSubmitted) return;
  saveCurrentInput();

  practiceSubmitted = true;

  timerRunning = false;
  if (timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
  pauseBtn.style.display = "none";
  pausedTag.style.display = "none";

  const correctCount = gradePracticeAll();
  renderSidebar();
  renderPracticeResults(correctCount);
}

/* ---------------- Results (Exam) ---------------- */
function renderExamResults(pointsEarned){
  const total = questions.length;
  const timeText = formatElapsed(elapsedMs);
  const correctCount = questions.filter(q => q.isCorrect).length;

  let html = `
    <h3>Exam Results</h3>
    <p><b>Student:</b> ${studentName}</p>
    <p><b>Score:</b> ${pointsEarned} / ${TOTAL_POINTS} points</p>
    <p><b>Correct:</b> ${correctCount} / ${total} questions</p>
    <p><b>Time:</b> ${timeText}</p>

    <div class="question-buttons">
      <button id="saveButton">Save Result (TXT)</button>
    </div>

    <table class="review-table">
      <tr>
        <th>#</th>
        <th>Pts</th>
        <th>Earned</th>
        <th>Topic</th>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct Answer</th>
        <th>Result</th>
      </tr>
  `;

  questions.forEach((q, i) => {
    const yourAns = (q.userValue || "").trim() === "" ? "—" : q.userValue;
    const earned = q.isCorrect ? q.points : 0;
    const isAnswered = (q.userValue||"").trim() !== "";
    html += `
      <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
        <td>${i+1}</td>
        <td>${q.points}</td>
        <td>${earned}</td>
        <td>${q.partName}</td>
        <td style="text-align:left;">${q.html}</td>
        <td>${mathifyText(escapeHTML(yourAns))}</td>
        <td>${q.displayCorrect}</td>
        <td>${!isAnswered ? "Not answered" : (q.isCorrect ? "Correct" : "Incorrect")}</td>
      </tr>
    `;
  });
  html += `</table>`;

  quizContent.innerHTML = html;
  document.getElementById("saveButton")?.addEventListener("click", saveExamResultAsTxt);

  updateSidebarStatus();
}

/* ---------------- Results (Practice) ---------------- */
function renderPracticeResults(correctCount){
  const total = questions.length;
  const timeText = formatElapsed(elapsedMs);
  const answered = questions.filter(q => (q.userValue||"").trim() !== "").length;

  let html = `
    <h3>Practice Summary</h3>
    <p><b>Student:</b> ${studentName}</p>
    <p><b>Answered:</b> ${answered} / ${total} questions</p>
    <p><b>Correct:</b> ${correctCount} / ${total} questions</p>
    <p><b>Time:</b> ${timeText}</p>

    <div class="hint-box" style="display:block;background:#e8fff0;border-color:#b7f0c8;">
      <b>Tip:</b> You can still click questions in the sidebar to review.
      Generate a new set anytime to practise again.
    </div>

    <div class="question-buttons">
      <button id="saveButton">Save Practice Result (TXT)</button>
    </div>

    <table class="review-table">
      <tr>
        <th>#</th>
        <th>Topic</th>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct Answer</th>
        <th>Result</th>
      </tr>
  `;

  questions.forEach((q, i) => {
    const yourAns = (q.userValue || "").trim() === "" ? "—" : q.userValue;
    html += `
      <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
        <td>${i+1}</td>
        <td>${q.partName}</td>
        <td style="text-align:left;">${q.html}</td>
        <td>${mathifyText(escapeHTML(yourAns))}</td>
        <td>${q.displayCorrect}</td>
        <td>${(q.userValue||"").trim()==="" ? "Not answered" : (q.isCorrect ? "Correct" : "Incorrect")}</td>
      </tr>
    `;
  });
  html += `</table>`;

  quizContent.innerHTML = html;
  document.getElementById("saveButton")?.addEventListener("click", savePracticeResultAsTxt);

  updateSidebarStatus();
}

/* ---------------- Save result (TXT) ---------------- */
function formatDateForFilename(date){
  const pad = n => String(n).padStart(2,"0");
  return (
    date.getFullYear() +
    pad(date.getMonth() + 1) +
    pad(date.getDate()) + "_" +
    pad(date.getHours()) +
    pad(date.getMinutes()) +
    pad(date.getSeconds())
  );
}
function saveExamResultAsTxt(){
  const pointsEarned = questions.reduce((sum,q)=>sum+(q.isCorrect?q.points:0),0);
  const correctCount = questions.filter(q=>q.isCorrect).length;

  const lines = [];
  lines.push("NZ Year 6 Maths Test - Exam Result");
  lines.push("Student: " + studentName);
  lines.push("Mode: Exam");
  lines.push("Time: " + formatElapsed(elapsedMs));
  lines.push("Score: " + pointsEarned + " / " + TOTAL_POINTS + " points");
  lines.push("Correct: " + correctCount + " / " + questions.length);
  lines.push("");
  lines.push("Details:");
  lines.push("--------");

  questions.forEach((q, i) => {
    const userAns = (q.userValue || "").trim() === "" ? "Not answered" : q.userValue;
    const earned = q.isCorrect ? q.points : 0;
    const resultText = (q.userValue || "").trim() === ""
      ? "Not answered"
      : (q.isCorrect ? "Correct" : "Incorrect");

    lines.push(
      `Q${i+1} (${q.partName}) [${earned}/${q.points} pts]` +
      "\nQuestion: " + q.plain +
      "\nYour answer: " + userAns +
      "\nCorrect answer: " + stripHTML(q.displayCorrect) +
      "\nResult: " + resultText
    );
    lines.push("");
  });

  const content = lines.join("\n");
  const blob = new Blob([content], { type:"text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = studentName.replace(/[^a-z0-9_\-]/gi,"_") || "Student";
  const ts = formatDateForFilename(new Date());
  a.href = url;
  a.download = `NZ_Y6_Exam_${safeName}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function savePracticeResultAsTxt(){
  const correctCount = questions.filter(q=>q.isCorrect).length;
  const answered = questions.filter(q => (q.userValue||"").trim() !== "").length;

  const lines = [];
  lines.push("NZ Year 6 Maths Test - Practice Result");
  lines.push("Student: " + studentName);
  lines.push("Mode: Practice");
  lines.push("Time: " + formatElapsed(elapsedMs));
  lines.push("Answered: " + answered + " / " + questions.length);
  lines.push("Correct: " + correctCount + " / " + questions.length);
  lines.push("");
  lines.push("Details:");
  lines.push("--------");

  questions.forEach((q, i) => {
    const userAns = (q.userValue || "").trim() === "" ? "Not answered" : q.userValue;
    const resultText = (q.userValue || "").trim() === ""
      ? "Not answered"
      : (q.isCorrect ? "Correct" : "Incorrect");

    lines.push(
      `Q${i+1} (${q.partName})` +
      "\nQuestion: " + q.plain +
      "\nYour answer: " + userAns +
      "\nCorrect answer: " + stripHTML(q.displayCorrect) +
      "\nResult: " + resultText
    );
    lines.push("");
  });

  const content = lines.join("\n");
  const blob = new Blob([content], { type:"text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = studentName.replace(/[^a-z0-9_\-]/gi,"_") || "Student";
  const ts = formatDateForFilename(new Date());
  a.href = url;
  a.download = `NZ_Y6_Practice_${safeName}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ---------------- Export to PDF (Print) ---------------- */
/* ---------------- Export to PDF (Print) ---------------- */
function exportToPDF(){
  if (!questions.length) return;

  const w = window.open("", "_blank");
  if (!w) return;

  const now = new Date();
  const ts = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;

  const titleText = (MODE === "practice")
    ? "NZ Year 6 Maths — Practice Set"
    : "NZ Year 6 Maths — Exam Paper";

  const noteText = (MODE === "practice")
    ? `Write your answers in the spaces provided. If your answer is a fraction, write it in simplest form (e.g., ${fracHTML(2,3)}). If it is a mixed number, write it as (e.g., ${mixedHTML(1,1,2)}).`
    : `Answer all questions. If your answer is a fraction, write it in simplest form (e.g., ${fracHTML(2,3)}). If it is a mixed number, write it as (e.g., ${mixedHTML(1,1,2)}).`;

  const printStyles = `
    <style>
      body{ font-family: 'Segoe UI', Tahoma, sans-serif; color:#111; margin:24px; }
      .hdr{ display:flex; align-items:center; gap:12px; border-bottom:2px solid #ddd; padding-bottom:10px; margin-bottom:16px; }
      .logo{ width:34px; height:34px; background:#0d47a1; border-radius:6px; position:relative; }
      .logo:before{ content:""; position:absolute; width:18px; height:8px; background:#ff9800; top:-6px; left:18px; border-radius:3px; }
      .brand{ font-weight:900; letter-spacing:1px; color:#0d47a1; }
      .edu{ font-weight:900; letter-spacing:0.6px; color:#ff9800; font-size:0.9em; }
      h1{ font-size:1.25em; margin:0 0 6px; }
      .meta{ color:#444; font-size:0.95em; margin:0 0 10px; }
      .small{ color:#555; font-size:0.9em; margin:0 0 12px; }
      .q{ margin:10px 0 14px; page-break-inside: avoid; }
      .q .qt{ margin-bottom:8px; }
      .ansbox{ margin-top:8px; border:1px solid #aaa; border-radius:8px; height:44px; }
      .pts{ font-size:0.9em; color:#444; font-weight:800; margin-left:8px; }
      .topic{ font-size:0.92em; color:#0d47a1; font-weight:900; margin:16px 0 6px; }
      .page-break{ page-break-before: always; }
      /* Fraction / Mixed number display */
      .mxd{
        display:inline-flex;
        align-items:center;
        gap:10px;
        vertical-align:middle;
        margin:0 4px;
      }
      .mxd .box{
        width:52px;
        height:42px;
        border:1px solid #cfcfcf;
        border-radius:10px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:900;
        background:#fff;
      }
      .mxd .frac{
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .mxd .bar{
        height:2px;
        background:#111;
        border-radius:2px;
        opacity:0.9;
      }
      .mixed-inline{ display:inline-flex; align-items:center; gap:8px; vertical-align:middle; margin:0 4px; }
      .mixed-box{
        min-width:44px; height:36px; padding:0 10px;
        border:1.5px solid #cfcfcf;
        border-radius:10px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-weight:900;
        background:#fff;
      }
      .mixed-inline .frac{ display:inline-flex; flex-direction:column; align-items:center; line-height:1; }
      .mixed-inline .frac-bar{ width:54px; height:2px; background:#111; margin:3px 0; }


      table.ans-table{ width:100%; border-collapse:collapse; margin-top:10px; }
      .ans-table th, .ans-table td{
        border:1px solid #bbb;
        padding:6px 8px;
        font-size:0.9em;
        text-align:left;
        vertical-align:top;
      }
      .ans-table th{ background:#f2f2f2; }

      @media print{ .noprint{ display:none; } }
    </style>
  `;

  // ---------- Header ----------
  let body = `
    <div class="hdr">
      <div class="logo"></div>
      <div>
        <div class="brand">DYAA</div>
        <div class="edu">EDUCATION</div>
      </div>
    </div>

    <h1>${titleText}</h1>
    <p class="meta"><b>Student:</b> ${studentName} &nbsp; | &nbsp; <b>Date:</b> ${ts} &nbsp; | &nbsp; <b>Mode:</b> ${MODE.toUpperCase()}</p>
    <p class="small">${noteText}</p>

    <div class="noprint" style="margin:12px 0;">
      <button onclick="window.print()" style="padding:10px 16px;border:none;border-radius:10px;background:#6a1b9a;color:#fff;font-weight:900;cursor:pointer;">
        Print / Save as PDF
      </button>
    </div>
  `;

  // ---------- Questions in ORDER Q1..Q30 ----------
  let lastTopic = "";
  questions.forEach((q) => {
    if (q.partName !== lastTopic){
      body += `<div class="topic">${q.partName}</div>`;
      lastTopic = q.partName;
    }

    const ptsText = (MODE === "exam") ? `<span class="pts">(${q.points} pts)</span>` : "";
    body += `
      <div class="q">
        <div class="qt"><b>Q${q.index+1}.</b> ${q.html} ${ptsText}</div>
        <div class="ansbox"></div>
      </div>
    `;
  });

  // ---------- Answers on a SEPARATE page ----------
  body += `
    <div class="page-break"></div>
    <h1>Answer Sheet</h1>
    <p class="small">Do not use mixed numbers. Fractions are shown as a/b in simplest form.</p>

    <table class="ans-table">
      <tr>
        <th style="width:70px;">Q#</th>
        <th style="width:180px;">Answer</th>
        <th>Topic</th>
      </tr>
  `;

  questions.forEach((q) => {
    const ansText = (q.displayCorrect || "");
    body += `
      <tr>
        <td><b>Q${q.index+1}</b></td>
        <td>${ansText}</td>
        <td>${q.partName}</td>
      </tr>
    `;
  });

  body += `</table>`;

  // ---------- Write to new window ----------
  w.document.open();
  w.document.write(`
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="UTF-8">
        <title>${titleText}</title>
        ${printStyles}
      </head>
      <body>${body}</body>
    </html>
  `);
  w.document.close();

  setTimeout(() => { try{ w.focus(); }catch(e){} }, 200);
}

/* ---------------- Start / Reset ---------------- */
function startNewSet(){
  questions = generateQuestions();
  currentIndex = 0;
  examSubmitted = false;
  practiceSubmitted = false;

  questions.forEach(q => {
    q.userValue = "";
    q.checked = false;
    q.isCorrect = false;
    q.hintShown = false;
  });

  renderSidebar();
  renderQuestion();

  generateBtn.style.display = "inline-block";
  resetBtn.style.display = "inline-block";
  pauseBtn.style.display = "inline-block";
  timerBox.style.display = "inline-flex";
  exportBtn.style.display = "inline-block";

  if (exportWordBtn) exportWordBtn.style.display = "inline-block";

  setPausedUI(false);
  startQuizTimer();
  updateMetaLine();
}

function exportToWord(){
  if (!questions || !questions.length) return;

  const safeStudent = (studentName || "Student")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");

  const tsHuman = new Date().toLocaleString();
  const titleText = (MODE === "practice")
    ? "NZ Year 6 Maths – Practice Set"
    : "NZ Year 6 Maths – Exam Paper";
  const noteText = (MODE === "practice")
    ? "Practice Mode: You may check answers after each question. Export includes an answer sheet on the last page."
    : "Exam Mode: Show full working. No calculators unless stated.";

  // Reuse the same export CSS (Word can open HTML with styles)
  const css = `
    <style>
      body{ font-family: Arial, Helvetica, sans-serif; margin:24px; color:#111; }
      h1{ margin:0 0 6px 0; }
      .meta{ margin:0 0 10px 0; font-size:13px; color:#333; }
      .small{ margin:0 0 14px 0; font-size:12px; color:#555; }
      .hdr{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
      .logo{ width:40px; height:40px; background:#fff; border:2px solid #d35400; border-radius:8px; }
      .brand{ font-weight:900; letter-spacing:1px; }
      .edu{ font-size:11px; color:#d35400; font-weight:900; letter-spacing:1px; }

      .topic{ margin:18px 0 8px; padding:6px 10px; border-left:6px solid #1a237e; background:#f2f4ff; font-weight:800; }
      .q{ border:1px solid #ddd; border-radius:10px; padding:12px; margin:10px 0; }
      .qt{ font-size:14px; line-height:1.35; }
      .ansbox{ margin-top:8px; height:38px; border:1px dashed #999; border-radius:8px; }

      /* Fraction / Mixed number display */
      .mxd{
        display:inline-flex;
        align-items:center;
        gap:10px;
        vertical-align:middle;
        margin:0 4px;
      }
      .mxd .box{
        width:52px;
        height:42px;
        border:1px solid #cfcfcf;
        border-radius:10px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:900;
        background:#fff;
      }
      .mxd .frac{
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .mxd .bar{
        height:2px;
        background:#111;
        border-radius:2px;
        opacity:0.9;
      }
      .mixed-inline{ display:inline-flex; align-items:center; gap:8px; vertical-align:middle; margin:0 4px; }
      .mixed-box{
        min-width:44px; height:36px; padding:0 10px;
        border:1.5px solid #cfcfcf;
        border-radius:10px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-weight:900;
        background:#fff;
      }
      .mixed-inline .frac{ display:inline-flex; flex-direction:column; align-items:center; line-height:1; }
      .mixed-inline .frac-bar{ width:54px; height:2px; background:#111; margin:3px 0; }


      .page-break{ page-break-before:always; }
      table.ans-table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
      table.ans-table th, table.ans-table td{ border:1px solid #bbb; padding:6px 8px; text-align:left; vertical-align:top; }
      table.ans-table th{ background:#f2f2f2; }
    </style>
  `;

  // ---------- Header ----------
  let body = `
    <div class="hdr">
      <div class="logo"></div>
      <div>
        <div class="brand">DYAA</div>
        <div class="edu">EDUCATION</div>
      </div>
    </div>

    <h1>${titleText}</h1>
    <p class="meta"><b>Student:</b> ${safeStudent} &nbsp; | &nbsp; <b>Date:</b> ${tsHuman} &nbsp; | &nbsp; <b>Mode:</b> ${MODE.toUpperCase()}</p>
    <p class="small">${noteText}</p>
  `;

  // ---------- Questions ----------
  let lastTopic = "";
  questions.forEach((q) => {
    if (q.partName !== lastTopic){
      body += `<div class="topic">${q.partName}</div>`;
      lastTopic = q.partName;
    }
    const ptsText = (MODE==="exam") ? ` <span class="small">[${q.points} marks]</span>` : "";
    body += `
      <div class="q">
        <div class="qt"><b>Q${q.index+1}.</b> ${q.html} ${ptsText}</div>
        <div class="ansbox"></div>
      </div>
    `;
  });

  // ---------- Answers page ----------
  body += `
    <div class="page-break"></div>
    <h1>Answer Sheet</h1>
    <p class="small">Do not use mixed numbers. Fractions are shown as a/b in simplest form.</p>
    <table class="ans-table">
      <tr>
        <th style="width:70px;">Q#</th>
        <th style="width:180px;">Answer</th>
        <th>Topic</th>
      </tr>
  `;
  questions.forEach((q) => {
    const ansText = (q.displayCorrect || "");
    body += `
      <tr>
        <td><b>Q${q.index+1}</b></td>
        <td>${ansText}</td>
        <td>${q.partName}</td>
      </tr>
    `;
  });
  body += `</table>`;

  const html = `
    <!DOCTYPE html>
    <html xmlns:o="urn:schemas-microsoft-com:office:office"
          xmlns:w="urn:schemas-microsoft-com:office:word"
          xmlns="http://www.w3.org/TR/REC-html40">
      <head>
        <meta charset="utf-8" />
        <title>${titleText}</title>
        ${css}
      </head>
      <body>${body}</body>
    </html>
  `;

  const blob = new Blob(["\ufeff", html], { type: "application/msword;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = (studentName || "Student").replace(/[^a-z0-9_\-]/gi,"_") || "Student";
  const tsFile = formatDateForFilename(new Date());
  a.href = url;
  a.download = `NZ_Y6_${MODE==="practice" ? "Practice" : "Exam"}_${safeName}_${tsFile}.doc`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function updateMetaLine(){
  const modeText = (MODE === "practice")
    ? "Practice Mode (timed, Check Answer + Export PDF + Submit Summary)"
    : `Exam Mode (timed, total ${TOTAL_POINTS} points)`;
  metaLine.textContent = `Student: ${studentName} • ${modeText} • ${POINTS.length} questions • NZ Year 6`;
}
function showStartScreen(){
  sidebarEl.style.display = "none";
  generateBtn.style.display = "none";
  pauseBtn.style.display = "none";
  resetBtn.style.display = "none";
  exportBtn.style.display = "none";
  if (exportWordBtn) exportWordBtn.style.display = "none";
  timerBox.style.display = "none";
  modePill.style.display = "none";
  metaLine.textContent = "";

  quizContent.innerHTML = `
    <div class="hint-box" style="display:block;">
      <b>Choose a mode:</b><br>
      • <b>Practice</b>: timed + every question has <b>Check Answer</b>. Submit on the last question to get a <b>summary</b> and <b>save result</b>.<br>
      • <b>Exam</b>: timed, total <b>${TOTAL_POINTS}</b> points. Only <b>Submit</b> on the last question.<br><br>

      <b>Note:</b> Geometry questions are <b>text-only</b> (no diagrams).
      Each set contains <b>40 different question types</b> (no repeats).
    </div>

    <div style="margin-top:14px;">
      <div style="font-weight:900; margin-bottom:6px;">Student Name</div>
      <input id="nameInput" class="answer-box" type="text" placeholder="Your name" style="margin-top:0;">
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:900; margin-bottom:6px;">Mode</div>
      <label style="display:block; margin:6px 0;">
        <input type="radio" name="modeChoice" value="practice" checked>
        Practice Mode
      </label>
      <label style="display:block; margin:6px 0;">
        <input type="radio" name="modeChoice" value="exam">
        Exam Mode
      </label>
    </div>

    <div class="question-buttons" style="margin-top:18px;">
      <button id="startButton" style="background:#4caf50;">Start</button>
    </div>
  `;

  const nameInput = document.getElementById("nameInput");
  if (nameInput && URL_STUDENT_NAME) nameInput.value = URL_STUDENT_NAME;

  document.getElementById("startButton")?.addEventListener("click", () => {
    const name = (document.getElementById("nameInput")?.value || "Student").trim();
    studentName = name || "Student";

    const picked = document.querySelector('input[name="modeChoice"]:checked');
    MODE = picked ? picked.value : "practice";

    modePill.style.display = "inline-flex";
    modePill.textContent = (MODE === "practice") ? "Practice Mode" : "Exam Mode";

    startNewSet();
  });
}

/* ---------------- Buttons ---------------- */
generateBtn.addEventListener("click", () => {
  if (timerPaused) return;
  const msg =
    MODE === "practice"
      ? "Generate a new practice set?\n\nYour current answers and progress will be cleared."
      : "Generate a new exam set?\n\nYour current answers and progress will be cleared.";
  const ok = window.confirm(msg);
  if (!ok) return;
  startNewSet();
});
resetBtn.addEventListener("click", () => {
  stopQuizTimer();
  timerPaused = false;
  setPausedUI(false);
  showStartScreen();
});
pauseBtn.addEventListener("click", () => togglePause());
exportBtn.addEventListener("click", () => {
  if (timerPaused) return;
  exportToPDF();
});
if (exportWordBtn) exportWordBtn.addEventListener("click", () => {
  if (timerPaused) return;
  exportToWord();
});

/* Init */
showStartScreen();
</script>
</body>
</html>
