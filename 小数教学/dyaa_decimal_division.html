<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decimal Division — Learn & Practice — DYAA</title>

  <style>
    :root{
      --blue:#0d47a1;
      --orange:#ff9800;
      --bg:#f4f4f9;
      --ink:#222;
      --muted:#666;
      --card:#fff;
      --line:#e6e6ef;
      --ok:#1b5e20;
      --bad:#b71c1c;
      --shadow:0 6px 15px rgba(0,0,0,0.10);
    }
    *{box-sizing:border-box;}
    body{
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      color:var(--ink);
    }
    body:before{
      content:"DYAA";
      position:fixed;
      inset:auto auto 8% -10%;
      font-size:180px;
      font-weight:900;
      letter-spacing:8px;
      color:rgba(13,71,161,0.06);
      transform:rotate(-12deg);
      pointer-events:none;
      z-index:0;
      user-select:none;
    }

    .container{
      position:relative;
      z-index:1;
      max-width:980px;
      margin:28px auto;
      background:#fff;
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:26px;
      border:1px solid var(--line);
    }

    #headerLogo{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:12px;
      border-bottom:2px solid #e0e0e0;
      padding-bottom:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px;}
    .logo-icon{
      width:44px;height:44px;background:var(--blue);
      border-radius:8px;position:relative;flex:0 0 auto;
    }
    .logo-icon:before{
      content:"";position:absolute;width:22px;height:9px;background:var(--orange);
      top:-6px;left:11px;border-radius:4px;
    }
    .logo-text{display:flex;flex-direction:column;line-height:1.1;}
    .logo-text b{font-size:1.12rem;color:var(--blue);letter-spacing:.2px;}
    .logo-text span{font-size:.92rem;color:var(--orange);font-weight:800;}
    .title-block{flex:1 1 260px;min-width:260px;}
    .title-block h1{margin:0;font-size:1.15rem;color:#111;letter-spacing:.2px;}
    .title-block p{margin:4px 0 0 0;color:var(--muted);font-size:.95rem;}

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin:14px 0 18px;
      flex-wrap:wrap;
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;}
    .tab-btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      color:#333;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .tab-btn.active{
      background:rgba(13,71,161,0.10);
      border-color:rgba(13,71,161,0.25);
      color:var(--blue);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex:1 1 360px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      min-width:240px;
      flex:1 1 240px;
    }
    .pill label{font-weight:800;color:#333;font-size:.95rem;white-space:nowrap;}
    .pill input{
      border:1px solid var(--line);
      border-radius:10px;
      padding:9px 10px;
      outline:none;
      width:100%;
      font-size:.95rem;
    }
    .student-name{font-weight:800;color:#111;}

    .btn{
      border:none;
      background:var(--blue);
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      box-shadow:0 4px 12px rgba(13,71,161,0.18);
      white-space:nowrap;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid var(--line);
      box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    .btn.orange{
      background:var(--orange);
      box-shadow:0 4px 12px rgba(255,152,0,0.18);
    }

    select{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }

    .section{display:none;margin-top:10px;}
    .section.active{display:block;}

    .grid{display:grid;grid-template-columns:1fr;gap:14px;}
    @media (min-width: 900px){
      .grid.two{grid-template-columns:1fr 1fr;}
    }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
    }
    .card h2{margin:0 0 8px 0;font-size:1.05rem;color:var(--blue);}
    .card h3{margin:12px 0 6px 0;font-size:1rem;color:#111;}
    .card p, .card li{color:#222;line-height:1.55;margin:6px 0;}
    .muted{color:var(--muted);}

    .mini-table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      margin-top:10px;
    }
    .mini-table th, .mini-table td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      text-align:left;
      font-size:.95rem;
      vertical-align:top;
    }
    .mini-table th{
      background:rgba(13,71,161,0.06);
      color:#111;
    }
    .mini-table tr:last-child td{border-bottom:none;}

    .practice-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .note{
      background:rgba(255,152,0,0.12);
      border:1px solid rgba(255,152,0,0.25);
      padding:10px 12px;
      border-radius:12px;
      color:#222;
      line-height:1.45;
      flex:1 1 420px;
    }
    .tiny{font-size:.9rem;color:var(--muted);}

    .part-title{
      margin:18px 0 10px 0;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(13,71,161,0.06);
      border:1px solid rgba(13,71,161,0.15);
      color:#111;
      font-weight:900;
    }

    .qCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
      margin:12px 0;
    }
    .qHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .qHeader .qTitle{
      font-weight:1000;
      color:var(--blue);
      font-size:1.05rem;
      letter-spacing:.3px;
    }
    .qChip{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      color:#111;
      font-size:.85rem;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }

    .qPrompt{line-height:1.5;color:#111;margin:6px 0 10px 0;}

    .answerRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin:8px 0 10px 0;
    }
    .answerRow .label{
      font-weight:900;
      color:#111;
      min-width:70px;
      padding-top:8px;
    }
    .answerRow input{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      outline:none;
      width:min(520px, 100%);
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:2px;
    }
    .btnSmall{
      border:none;
      background:var(--blue);
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      box-shadow:0 4px 12px rgba(13,71,161,0.18);
    }
    .btnSmall.hint,
    .btnSmall.reveal{
      background:#eef3ff;
      color:var(--blue);
      border:1px solid rgba(13,71,161,0.18);
      box-shadow:none;
    }

    .msgBox{
      margin-top:10px;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid var(--line);
      display:none;
    }
    .msgBox.show{display:block;}
    .msgBox .msgHead{font-weight:1000;margin-bottom:6px;}
    .msgBox .msgBody{line-height:1.5;color:#111;}
    .msgBox.solution{background:rgba(27,94,32,0.08);border-color:rgba(27,94,32,0.22);}
    .msgBox.hint{background:rgba(13,71,161,0.07);border-color:rgba(13,71,161,0.20);}
    .msgBox.wrong{background:rgba(183,28,28,0.07);border-color:rgba(183,28,28,0.22);}

    .footer-actions{
      margin-top:18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .score{font-weight:900;color:#111;}

    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:18px;
    }
    .modal-backdrop.show{display:flex;}
    .modal{
      background:#fff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
      max-width:520px;
      width:100%;
      padding:18px;
    }
    .modal h4{margin:0 0 8px 0;color:#111;font-size:1.05rem;}
    .modal p{margin:0 0 14px 0;color:#333;line-height:1.5;}
    .modal .row{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}

    .math{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1;}
  </style>
</head>

<body>
  <div class="container">
    <div id="headerLogo">
      <div class="brand">
        <div class="logo-icon"></div>
        <div class="logo-text">
          <b>DYAA Education</b>
          <span>Mathematics</span>
        </div>
      </div>
      <div class="title-block">
        <h1>Decimal Division — Learn & Practice</h1>
        <p>All divisors are decimals (no integers, no fractions)</p>
      </div>
    </div>

    <div class="topbar">
      <div class="tabs">
        <button class="tab-btn active" id="learnTab">Learn</button>
        <button class="tab-btn" id="practiceTab">Practice</button>
      </div>

      <div class="controls">
        <div class="pill" id="studentPill">
          <label>Student</label>
          <span id="studentDisplay" class="student-name" style="display:none;"></span>
          <input id="studentInput" type="text" placeholder="Enter student name" style="display:none;">
        </div>

        <select id="perPageSelect" title="Questions per page for Export to PDF">
          <option value="3">3 / page</option>
          <option value="4" selected>4 / page</option>
          <option value="6">6 / page</option>
          <option value="8">8 / page</option>
          <option value="9">9 / page</option>
        </select>

        <button class="btn secondary" id="exportBtn" title="Opens the print dialog (Save as PDF)">
          Export to PDF
        </button>
        <button class="btn orange" id="newSetBtn">Generate New Set</button>
      </div>
    </div>

    <!-- LEARN -->
    <div class="section active" id="learnSection">
      <div class="grid two">
        <div class="card">
          <h2>Divide by powers of 10 (as decimals)</h2>
          <ul>
            <li>Dividing by <b>10</b> moves the decimal point <b>1 place left</b>.</li>
            <li>Dividing by <b>100</b> moves it <b>2 places left</b>.</li>
            <li>Dividing by <b>1000</b> moves it <b>3 places left</b>.</li>
          </ul>
          <p class="math"><b>Example:</b> 0.46 ÷ 100 = 0.0046</p>

          <h3>Divide by 0.1, 0.01, 0.001</h3>
          <ul>
            <li>Dividing by <b>0.1</b> is the same as multiplying by <b>10</b> (move decimal <b>right 1</b>).</li>
            <li>Dividing by <b>0.01</b> is the same as multiplying by <b>100</b> (move decimal <b>right 2</b>).</li>
            <li>Dividing by <b>0.001</b> is the same as multiplying by <b>1000</b> (move decimal <b>right 3</b>).</li>
          </ul>
          <p class="math"><b>Example:</b> 7.5 ÷ 0.1 = 75</p>
        </div>

        <div class="card">
          <h2>Decimal ÷ Decimal</h2>
          <ul>
            <li>If the divisor is a decimal, make it a whole number by <b>shifting decimals</b> in both numbers.</li>
            <li>Shift the decimal point the <b>same number of places</b> in the dividend.</li>
            <li>Then divide as whole numbers.</li>
          </ul>
          <p class="math"><b>Example:</b> 1.8 ÷ 0.3 = 18 ÷ 3 = 6</p>
        </div>

        <div class="card">
          <h2>Division Rules (summary table)</h2>
          <table class="mini-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Example</th>
                <th>Rule</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Decimal ÷ Power of 10</td>
                <td class="math">0.46 ÷ 100 = 0.0046</td>
                <td>Move decimal left</td>
              </tr>
              <tr>
                <td>Decimal ÷ Multiple of 10</td>
                <td class="math">7.2 ÷ 20 = 0.36</td>
                <td>Divide by digit, then move decimal</td>
              </tr>
              <tr>
                <td>Decimal ÷ Whole-number Divisor</td>
                <td class="math">8.4 ÷ 4 = 2.1</td>
                <td>Divide normally and place decimal</td>
              </tr>
              <tr>
                <td>Decimal ÷ Decimal</td>
                <td class="math">1.8 ÷ 0.3 = 6</td>
                <td>Make divisor whole by shifting decimals</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h2>Word Problems</h2>
          <ul>
            <li><b>1-step:</b> share equally / per unit → divide.</li>
            <li><b>2-step:</b> divide first, then multiply/add.</li>
            <li>Keep units: m, L, kg, $…</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- PRACTICE -->
    <div class="section" id="practiceSection">
      <div class="practice-head">
        <div class="note">
          <b>Instructions:</b> Each question has <b>Check</b>, <b>Hint</b>, and <b>Reveal</b>.
          <div class="tiny">Export to PDF will put the <b>Answer Key on a new page at the end</b>.</div>
        </div>
      </div>

      <div id="practiceRoot"></div>

      <div class="footer-actions">
        <div class="score" id="scoreText">Score: —</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn secondary" id="resetBtn">Reset Answers</button>
          <button class="btn" id="submitBtn">Submit & View Result</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-backdrop" id="confirmBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h4>Generate a new set?</h4>
      <p>This will replace all current questions and clear your answers.</p>
      <div class="row">
        <button class="btn secondary" id="cancelNewSet">Cancel</button>
        <button class="btn orange" id="confirmNewSet">Yes, generate</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Student name (URL param ?name=Tiger)
     ***********************/
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function initStudent(){
      const n = getParam("name");
      const studentDisplay = document.getElementById("studentDisplay");
      const studentInput = document.getElementById("studentInput");
      if(n && n.trim()){
        studentDisplay.style.display = "inline";
        studentInput.style.display = "none";
        studentDisplay.textContent = n.trim();
      }else{
        studentDisplay.style.display = "none";
        studentInput.style.display = "inline";
        const saved = localStorage.getItem("dyaa_student_name") || "";
        studentInput.value = saved;
        studentInput.addEventListener("input", ()=>{
          localStorage.setItem("dyaa_student_name", studentInput.value.trim());
        });
      }
    }
    function getStudentName(){
      const n = getParam("name");
      if(n && n.trim()) return n.trim();
      const v = (document.getElementById("studentInput").value || "").trim();
      return v || "________";
    }

    /***********************
     * Exact decimal helpers (BigInt)
     ***********************/
    function pow10(n){
      if(n <= 0) return 1n;
      return BigInt("1" + "0".repeat(n));
    }
    function powBig(base, exp){
      let b = BigInt(base);
      let e = exp;
      let r = 1n;
      while(e > 0){
        if(e & 1) r *= b;
        b *= b;
        e >>= 1;
      }
      return r;
    }
    function gcdBig(a,b){
      a = a < 0n ? -a : a;
      b = b < 0n ? -b : b;
      while(b !== 0n){
        const t = a % b;
        a = b;
        b = t;
      }
      return a;
    }
    function parseDec(str){
      str = String(str).trim();
      if(!str) return null;
      str = str.replace(/,/g,"");
      if(str[0]==="+") str = str.slice(1);
      if(!/^-?\d+(\.\d+)?$/.test(str)) return null;

      const neg = str[0]==="-";
      if(neg) str = str.slice(1);

      const parts = str.split(".");
      const intPart = parts[0] || "0";
      const frac = parts[1] || "";
      const scale = frac.length;
      const bi = BigInt(intPart + frac);
      return { int: (neg ? -bi : bi), scale };
    }
    function bigToStr(x, scale){
      const neg = x < 0n;
      let v = neg ? -x : x;
      let s = v.toString();
      if(scale === 0) return (neg ? "-" : "") + s;
      if(s.length <= scale){
        s = "0".repeat(scale - s.length + 1) + s;
      }
      const idx = s.length - scale;
      let out = s.slice(0, idx) + "." + s.slice(idx);
      out = out.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");
      return (neg ? "-" : "") + out;
    }
    function bigToStrFixed(x, scale){
      const neg = x < 0n;
      let v = neg ? -x : x;
      let s = v.toString();
      if(scale === 0) return (neg ? "-" : "") + s;
      if(s.length <= scale){
        s = "0".repeat(scale - s.length + 1) + s;
      }
      const idx = s.length - scale;
      return (neg ? "-" : "") + (s.slice(0, idx) + "." + s.slice(idx));
    }
    function stripTrailingZerosDec(s){
      return String(s).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");
    }
    function toFixedDpStr(xStr, dp){
      const p = parseDec(xStr);
      if(!p) return null;
      if(p.scale === dp) return bigToStrFixed(p.int, p.scale);
      if(p.scale < dp){
        const mul = pow10(dp - p.scale);
        return bigToStrFixed(p.int * mul, dp);
      }
      // truncate (fine for our generated money values)
      const diff = p.scale - dp;
      const div = pow10(diff);
      const neg = p.int < 0n;
      let v = neg ? -p.int : p.int;
      const q = v / div;
      const outInt = neg ? -q : q;
      return bigToStrFixed(outInt, dp);
    }
    function mulDecStr(aStr,bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      const prodInt = a.int * b.int;
      const scale = a.scale + b.scale;
      return bigToStr(prodInt, scale);
    }
    function divDecStr(aStr, bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      if(!a || !b) return null;
      if(b.int === 0n) return null;

      let num = a.int * pow10(b.scale);
      let den = b.int * pow10(a.scale);
      if(den < 0n){ den = -den; num = -num; }

      const g = gcdBig(num, den);
      num /= g; den /= g;

      let d = den;
      let c2 = 0, c5 = 0;
      while(d % 2n === 0n){ d /= 2n; c2++; }
      while(d % 5n === 0n){ d /= 5n; c5++; }

      if(d !== 1n){
        // fallback (should not happen with our generator)
        const scale = 6;
        const scaled = num * pow10(scale);
        const q = scaled / den;
        return bigToStr(q, scale);
      }

      const scale = Math.max(c2, c5);
      const adj2 = scale - c2;
      const adj5 = scale - c5;
      const adj = powBig(2, adj2) * powBig(5, adj5);

      const outInt = num * adj;
      return bigToStr(outInt, scale);
    }

    function sanitizeNumberInput(raw){
      let s = String(raw || "").trim();
      if(!s) return "";
      s = s.replace(/\$/g,"");
      s = s.replace(/[a-zA-Z]/g,"");
      s = s.replace(/\s+/g,"");
      return s;
    }

    /***********************
     * Random helpers
     ***********************/
    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function randDigits(len, allowAllZero=false){
      let s="";
      for(let i=0;i<len;i++) s += String(randInt(0,9));
      if(!allowAllZero && /^0+$/.test(s)) return randDigits(len, allowAllZero);
      return s;
    }
    function makeDecimalStr(intMin,intMax, dpOptions, allowAllZeroFrac=false){
      const intPart = randInt(intMin,intMax);
      const dp = randChoice(dpOptions);
      if(dp===0) return String(intPart); // for dividends it's okay
      const frac = randDigits(dp, allowAllZeroFrac);
      return `${intPart}.${frac}`;
    }
    function makeSmallDecimalStr(dpOptions){
      const dp = randChoice(dpOptions);
      const frac = randDigits(dp, true);
      return `0.${frac}`;
    }
    function niceQuotientStr(){
      const pool = ["0.6","0.8","1.2","1.5","1.6","1.8","2.1","2.4","2.5","3.2","3.6","4.8","5.4","6.0","7.5","8.0","9.6","10.5","12.0"];
      return randChoice(pool);
    }

    // IMPORTANT: divisor must LOOK like a decimal (contains a dot)
    function asDotZero(n){
      return `${n}.0`;
    }

    /***********************
     * Question model
     ***********************/
    let QUESTIONS = [];
    const PARTS = [
      {part:1, title:"Part 1 — Divide by Powers of 10 (divisors are decimals)"},
      {part:2, title:"Part 2 — Decimal ÷ Decimal (divisors are decimals)"},
      {part:3, title:"Part 3 — One-step Word Problems — Show your working"},
      {part:4, title:"Part 4 — Multi-step Word Problems — Show your working"},
    ];
    function qId(){ return "q_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }

    function makeNumericQuestion({part, chip, promptHtml, answerStr, hintHtml, solutionHtml, answerKeyText, acceptMoney=false}){
      const ansNorm = stripTrailingZerosDec(answerStr);
      return {
        id:qId(),
        part,
        chip,
        promptHtml,
        answer: ansNorm,
        hintHtml,
        solutionHtml: solutionHtml || (()=>`Answer: <b>${ansNorm}</b>.`),
        validate:(raw)=>{
          const cleaned = sanitizeNumberInput(raw);
          const p = parseDec(cleaned);
          if(!p) return {ok:false, msg:"Please enter a number."};
          const got = stripTrailingZerosDec(bigToStr(p.int,p.scale));

          if(got === ansNorm) return {ok:true};

          if(acceptMoney){
            const got2 = toFixedDpStr(got, 2);
            const ans2 = toFixedDpStr(ansNorm, 2);
            if(got2 === ans2) return {ok:true};
          }
          return {ok:false, msg:`Correct answer: ${ansNorm}`};
        },
        answerKeyText: answerKeyText || (()=>ansNorm),
        _checked:false,_isCorrect:false,_revealed:false,_value:"",
      };
    }

    /***********************
     * Build sets (like your screenshot)
     * Part 1: 15 questions
     * Part 2: 12 questions
     * Part 3: 5 questions
     * Part 4: 5 questions
     ***********************/
    function buildPart1(){
      const out = [];
      const pow10 = ["10.0","100.0","1000.0"];
      const negPow = ["0.1","0.01","0.001"];
      const all = pow10.concat(negPow);

      for(let i=0;i<15;i++){
        const d = randChoice(all);

        let a;
        if(d === "1000.0" || d === "0.001"){
          a = (Math.random()<0.55) ? makeDecimalStr(0,20,[1,2,3], true) : makeSmallDecimalStr([2,3]);
        }else{
          a = (Math.random()<0.50) ? makeDecimalStr(0,20,[1,2,3], true) : makeSmallDecimalStr([2,3]);
        }

        const ans = divDecStr(a, d);

        const places = (d==="10.0"||d==="0.1")?1:(d==="100.0"||d==="0.01")?2:3;
        const moveDir = (d==="10.0"||d==="100.0"||d==="1000.0") ? "left" : "right";

        out.push(makeNumericQuestion({
          part:1,
          chip:"Divide by powers of 10",
          promptHtml:`<span class="math">${stripTrailingZerosDec(a)} &divide; ${stripTrailingZerosDec(d)} =</span>`,
          answerStr: ans,
          hintHtml: (moveDir==="left")
            ? `Dividing by ${stripTrailingZerosDec(d)} moves the decimal point <b>${places}</b> place(s) to the <b>left</b>.`
            : `Dividing by ${stripTrailingZerosDec(d)} moves the decimal point <b>${places}</b> place(s) to the <b>right</b>.`,
          solutionHtml: ()=>`Move the decimal point <b>${places}</b> place(s) to the <b>${moveDir}</b>.<br/>So ${stripTrailingZerosDec(a)} &divide; ${stripTrailingZerosDec(d)} = <b>${stripTrailingZerosDec(ans)}</b>.`,
          answerKeyText: ()=>stripTrailingZerosDec(ans)
        }));
      }
      return out;
    }

    function buildPart2(){
      const out = [];

      // Divisors that look like decimals (must contain ".")
      const decDivisors = [
        "0.2","0.3","0.4","0.5","0.6","0.8","0.9","0.04","0.12","0.15",
        "2.5","3.2","4.8","1.6","2.4","3.6", // still decimals
        "3.0","6.0","9.0","12.0" // whole-number divisors shown as decimals
      ];

      // 12 questions, always build dividend = quotient × divisor to guarantee clean answers
      for(let i=0;i<12;i++){
        // prefer smaller divisors sometimes (like your screenshot)
        const d = (i < 8) ? randChoice(["0.2","0.3","0.4","0.5","0.6","0.8","0.9","0.04","0.12","0.15"])
                          : randChoice(["2.5","3.2","4.8","1.6","2.4","3.6","3.0","6.0","9.0","12.0"]);

        const q = niceQuotientStr();                 // answer
        const dividend = mulDecStr(q, d);            // dividend ÷ d = q

        out.push(makeNumericQuestion({
          part:2,
          chip:"Decimal ÷ Decimal",
          promptHtml:`<span class="math">${stripTrailingZerosDec(dividend)} &divide; ${stripTrailingZerosDec(d)} =</span>`,
          answerStr: q,
          hintHtml:`Make the divisor a whole number by shifting decimals in BOTH numbers, then divide.`,
          solutionHtml: ()=>{
            const dp = (d.split(".")[1]||"").length;
            const factor = dp === 0 ? "1.0" : ("1" + "0".repeat(dp) + ".0"); // looks decimal, e.g. 10.0, 100.0
            const div2 = mulDecStr(stripTrailingZerosDec(dividend), factor);
            const d2 = mulDecStr(d, factor);
            const ans = divDecStr(stripTrailingZerosDec(dividend), d);
            return `Shift decimals (${dp} place(s)) by multiplying both numbers by <b>${stripTrailingZerosDec(factor)}</b>.<br/>` +
                   `${stripTrailingZerosDec(dividend)} &divide; ${stripTrailingZerosDec(d)} = ${stripTrailingZerosDec(div2)} &divide; ${stripTrailingZerosDec(d2)}<br/>` +
                   `= <b>${stripTrailingZerosDec(ans)}</b>.`;
          },
          answerKeyText: ()=>stripTrailingZerosDec(q)
        }));
      }

      return out;
    }

    function buildPart3(){
      const out = [];

      // In word problems, the "count" can stay an integer in the story,
      // BUT in the working we show divisor as a decimal like 4.0, 6.0 etc.

      // 1) Rope
      {
        const pieceLen = randChoice(["0.4","0.6","0.8","1.2","1.5"]);
        const parts = randInt(3,8);
        const total = mulDecStr(pieceLen, String(parts));
        const div = asDotZero(parts);

        out.push(makeNumericQuestion({
          part:3,
          chip:"1-step",
          promptHtml:`A rope is <b>${stripTrailingZerosDec(total)} m</b> long. It is cut into <b>${parts}</b> equal parts. How long is each piece?`,
          answerStr: pieceLen,
          hintHtml:`Share equally → divide total length by the number of parts.`,
          solutionHtml: ()=>`${stripTrailingZerosDec(total)} &divide; ${stripTrailingZerosDec(div)} = <b>${stripTrailingZerosDec(pieceLen)}</b> m.`,
          answerKeyText: ()=>`${stripTrailingZerosDec(pieceLen)} m`
        }));
      }

      // 2) Water buckets
      {
        const each = randChoice(["0.7","0.8","1.2","1.4","1.6"]);
        const buckets = randInt(4,9);
        const total = mulDecStr(each, String(buckets));
        const div = asDotZero(buckets);

        out.push(makeNumericQuestion({
          part:3,
          chip:"1-step",
          promptHtml:`A tank contains <b>${stripTrailingZerosDec(total)} L</b> of water. It is shared equally among <b>${buckets}</b> buckets. How much water is in each bucket?`,
          answerStr: each,
          hintHtml:`Divide total litres by number of buckets.`,
          solutionHtml: ()=>`${stripTrailingZerosDec(total)} &divide; ${stripTrailingZerosDec(div)} = <b>${stripTrailingZerosDec(each)}</b> L.`,
          answerKeyText: ()=>`${stripTrailingZerosDec(each)} L`
        }));
      }

      // 3) km per litre (divisor shown as 8.0 etc in working)
      {
        const kmPerL = randChoice(["9.0","10.0","12.0","12.5","15.0","16.0"]);
        const litres = randInt(6,10);
        const km = mulDecStr(kmPerL, String(litres));
        const div = asDotZero(litres);

        out.push(makeNumericQuestion({
          part:3,
          chip:"1-step",
          promptHtml:`A car travels <b>${stripTrailingZerosDec(km)} km</b> using <b>${stripTrailingZerosDec(litres)} L</b> of petrol. How many kilometres does it travel per litre?`,
          answerStr: kmPerL,
          hintHtml:`Divide kilometres by litres.`,
          solutionHtml: ()=>`${stripTrailingZerosDec(km)} &divide; ${stripTrailingZerosDec(div)} = <b>${stripTrailingZerosDec(kmPerL)}</b> km/L.`,
          answerKeyText: ()=>`${stripTrailingZerosDec(kmPerL)} km/L`
        }));
      }

      // 4) Flour
      {
        const each = randChoice(["1.5","2.4","2.5","3.2"]);
        const bags = randInt(4,8);
        const total = mulDecStr(each, String(bags));
        const div = asDotZero(bags);

        out.push(makeNumericQuestion({
          part:3,
          chip:"1-step",
          promptHtml:`A baker has <b>${stripTrailingZerosDec(total)} kg</b> of flour. He divides it equally into <b>${bags}</b> bags. How much flour is in each bag?`,
          answerStr: each,
          hintHtml:`Divide total kg by number of bags.`,
          solutionHtml: ()=>`${stripTrailingZerosDec(total)} &divide; ${stripTrailingZerosDec(div)} = <b>${stripTrailingZerosDec(each)}</b> kg.`,
          answerKeyText: ()=>`${stripTrailingZerosDec(each)} kg`
        }));
      }

      // 5) Ribbon pieces (divisor is decimal already)
      {
        const piece = randChoice(["0.2","0.3","0.4","0.6","0.8"]);
        const count = randChoice([6,8,9,10,12,15]);
        const total = mulDecStr(piece, String(count));

        out.push(makeNumericQuestion({
          part:3,
          chip:"1-step",
          promptHtml:`A <b>${stripTrailingZerosDec(total)} m</b> ribbon is divided into <b>${piece} m</b> pieces. How many pieces are there?`,
          answerStr: String(count),
          hintHtml:`Number of pieces = total length ÷ length of each piece.`,
          solutionHtml: ()=>`${stripTrailingZerosDec(total)} &divide; ${piece} = <b>${count}</b> pieces.`,
          answerKeyText: ()=>`${count} pieces`
        }));
      }

      return out;
    }

    function buildPart4(){
      const out = [];

      // 1) wire (answer: number of pieces)
      {
        const piece = randChoice(["0.6","0.8","1.2"]);
        const pieces = randChoice([8,10,12,15,16]);
        const total = mulDecStr(piece, String(pieces));
        const fiveLen = mulDecStr(piece, "5.0");
        const divPiece = piece;               // already decimal
        const divPieces = asDotZero(pieces);  // show as decimal in working

        out.push(makeNumericQuestion({
          part:4,
          chip:"2-step",
          promptHtml:`A <b>${stripTrailingZerosDec(total)} m</b> wire is cut into <b>${piece} m</b> pieces. How many pieces can be made, and how long are <b>5</b> pieces together?<br/><span class="tiny">(Enter the number of pieces)</span>`,
          answerStr: String(pieces),
          hintHtml:`Step 1: pieces = total ÷ piece length. Step 2: length of 5 pieces = 5 × piece length.`,
          solutionHtml: ()=>`Pieces: ${stripTrailingZerosDec(total)} &divide; ${stripTrailingZerosDec(divPiece)} = <b>${pieces}</b>.<br/>Length of 5 pieces: 5.0 × ${piece} = <b>${stripTrailingZerosDec(fiveLen)}</b> m.`,
          answerKeyText: ()=>`Pieces ${pieces}, 5 pieces = ${stripTrailingZerosDec(fiveLen)} m`
        }));
      }

      // 2) juice sold (answer: total money)
      {
        const bottles = randChoice([6,8,10,12]);
        const litresEach = randChoice(["2.5","3.0","3.2","4.0"]);
        const totalL = mulDecStr(litresEach, String(bottles));
        const price = randChoice(["3.25","3.75","4.50","2.85"]);
        const money = mulDecStr(price, String(bottles));
        const money2 = toFixedDpStr(money,2);

        out.push(makeNumericQuestion({
          part:4,
          chip:"2-step ($)",
          promptHtml:`A <b>${stripTrailingZerosDec(totalL)} L</b> container of juice is shared equally into <b>${bottles}</b> bottles. Each bottle is then sold for <b>$${stripTrailingZerosDec(price)}</b>.<br/>How much money will be made in total?<br/><span class="tiny">(Enter the total money)</span>`,
          answerStr: money2,
          hintHtml:`Step 1: litres per bottle = total ÷ bottles. Step 2: total money = bottles × price.`,
          solutionHtml: ()=>{
            const perBottle = divDecStr(stripTrailingZerosDec(totalL), asDotZero(bottles));
            return `Juice per bottle: ${stripTrailingZerosDec(totalL)} &divide; ${stripTrailingZerosDec(asDotZero(bottles))} = <b>${stripTrailingZerosDec(perBottle)}</b> L.<br/>` +
                   `Total money: ${bottles} × $${stripTrailingZerosDec(price)} = <b>$${stripTrailingZerosDec(money2)}</b>.`;
          },
          answerKeyText: ()=>`$${stripTrailingZerosDec(money2)}`,
          acceptMoney:true
        }));
      }

      // 3) speed then distance (answer: distance)
      {
        const km = randChoice([96,120,150,180]);
        const hours = randChoice(["1.5","2.0","2.5","3.0"]);
        const speed = divDecStr(asDotZero(km), hours); // km/h
        const newHours = randChoice(["3.5","4.0","2.5","5.0"]);
        const dist = mulDecStr(speed, newHours);

        out.push(makeNumericQuestion({
          part:4,
          chip:"2-step",
          promptHtml:`A car travels <b>${stripTrailingZerosDec(km)} km</b> in <b>${stripTrailingZerosDec(hours)}</b> hours. How far will it go in <b>${newHours}</b> hours at the same speed?<br/><span class="tiny">(Enter the distance in km)</span>`,
          answerStr: stripTrailingZerosDec(dist),
          hintHtml:`Step 1: speed = distance ÷ time. Step 2: distance = speed × new time.`,
          solutionHtml: ()=>`Speed: ${stripTrailingZerosDec(asDotZero(km))} &divide; ${stripTrailingZerosDec(hours)} = <b>${stripTrailingZerosDec(speed)}</b> km/h.<br/>` +
                            `Distance: ${stripTrailingZerosDec(speed)} × ${newHours} = <b>${stripTrailingZerosDec(dist)}</b> km.`,
          answerKeyText: ()=>`${stripTrailingZerosDec(dist)} km`
        }));
      }

      // 4) unit cost then cost of 2.5 kg (answer: cost of 2.5 kg)
      {
        const kg = randChoice([10,12,15,20]);
        const unitCost = randChoice(["1.2","1.5","1.8","2.4"]);
        const totalCost = mulDecStr(unitCost, asDotZero(kg));
        const totalCost2 = toFixedDpStr(totalCost,2);

        const targetKg = "2.5";
        const targetCost = mulDecStr(unitCost, targetKg);
        const targetCost2 = toFixedDpStr(targetCost,2);

        out.push(makeNumericQuestion({
          part:4,
          chip:"2-step ($)",
          promptHtml:`A shop bought <b>${stripTrailingZerosDec(kg)} kg</b> of sugar for <b>$${stripTrailingZerosDec(totalCost2)}</b>.<br/>How much does <b>1 kg</b> cost, and what is the cost of <b>${targetKg} kg</b>?<br/><span class="tiny">(Enter the cost of ${targetKg} kg)</span>`,
          answerStr: targetCost2,
          hintHtml:`Step 1: $ per kg = total cost ÷ kg. Step 2: cost = (per kg) × ${targetKg}.`,
          solutionHtml: ()=>{
            const perKg = divDecStr(totalCost2, asDotZero(kg));
            return `Cost per kg: $${stripTrailingZerosDec(totalCost2)} &divide; ${stripTrailingZerosDec(asDotZero(kg))} = <b>$${stripTrailingZerosDec(toFixedDpStr(perKg,2))}</b> per kg.<br/>` +
                   `Cost of ${targetKg} kg: $${stripTrailingZerosDec(toFixedDpStr(perKg,2))} × ${targetKg} = <b>$${stripTrailingZerosDec(targetCost2)}</b>.`;
          },
          answerKeyText: ()=>`$ per kg = $${stripTrailingZerosDec(toFixedDpStr(unitCost,2))}, cost of ${targetKg} kg = $${stripTrailingZerosDec(targetCost2)}`,
          acceptMoney:true
        }));
      }

      // 5) cable parts then machines (answer: per machine length)
      {
        const machines = randChoice([3,4,5]);
        const parts = randChoice([6,8,10]);
        const perMachine = randChoice(["0.4","0.6","0.8","1.2"]);
        const total = mulDecStr(mulDecStr(perMachine, asDotZero(machines)), asDotZero(parts));

        out.push(makeNumericQuestion({
          part:4,
          chip:"2-step",
          promptHtml:`A <b>${stripTrailingZerosDec(total)} m</b> cable is cut into <b>${parts}</b> equal parts. Each part is used for <b>${machines}</b> machines. What length of cable does each machine get?`,
          answerStr: perMachine,
          hintHtml:`Step 1: one part = total ÷ parts. Step 2: per machine = (one part) ÷ machines.`,
          solutionHtml: ()=>{
            const onePart = divDecStr(stripTrailingZerosDec(total), asDotZero(parts));
            const per = divDecStr(stripTrailingZerosDec(onePart), asDotZero(machines));
            return `One part: ${stripTrailingZerosDec(total)} &divide; ${stripTrailingZerosDec(asDotZero(parts))} = <b>${stripTrailingZerosDec(onePart)}</b> m.<br/>` +
                   `Each machine: ${stripTrailingZerosDec(onePart)} &divide; ${stripTrailingZerosDec(asDotZero(machines))} = <b>${stripTrailingZerosDec(per)}</b> m.`;
          },
          answerKeyText: ()=>`${stripTrailingZerosDec(perMachine)} m`
        }));
      }

      return out;
    }

    function buildAllQuestions(){
      return [
        ...buildPart1(),
        ...buildPart2(),
        ...buildPart3(),
        ...buildPart4()
      ];
    }

    /***********************
     * Rendering
     ***********************/
    function renderPractice(){
      const root = document.getElementById("practiceRoot");
      root.innerHTML = "";

      let globalIndex = 0;

      PARTS.forEach(p=>{
        const partQs = QUESTIONS.filter(q=>q.part===p.part);
        if(!partQs.length) return;

        const title = document.createElement("div");
        title.className = "part-title";
        title.textContent = p.title;
        root.appendChild(title);

        partQs.forEach(q=>{
          globalIndex++;
          q._globalNo = globalIndex;

          const card = document.createElement("div");
          card.className = "qCard";
          card.dataset.qid = q.id;

          const header = document.createElement("div");
          header.className = "qHeader";

          const qTitle = document.createElement("div");
          qTitle.className = "qTitle";
          qTitle.textContent = `Q${globalIndex}`;

          const chip = document.createElement("div");
          chip.className = "qChip";
          chip.textContent = q.chip || "Practice";

          header.appendChild(qTitle);
          header.appendChild(chip);
          card.appendChild(header);

          const prompt = document.createElement("div");
          prompt.className = "qPrompt";
          prompt.innerHTML = q.promptHtml || "";
          card.appendChild(prompt);

          const answerRow = document.createElement("div");
          answerRow.className = "answerRow";

          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "Answer:";
          answerRow.appendChild(label);

          const inp = document.createElement("input");
          inp.type = "text";
          inp.placeholder = "Type your answer";
          inp.value = q._value || "";
          inp.addEventListener("input", ()=>{
            q._value = inp.value;
            hideMsg(q.id);
          });
          answerRow.appendChild(inp);

          card.appendChild(answerRow);

          const btnRow = document.createElement("div");
          btnRow.className = "btnRow";

          const btnCheck = document.createElement("button");
          btnCheck.className = "btnSmall";
          btnCheck.textContent = "Check";
          btnCheck.addEventListener("click", ()=>doCheck(q.id));

          const btnHint = document.createElement("button");
          btnHint.className = "btnSmall hint";
          btnHint.textContent = "Hint";
          btnHint.addEventListener("click", ()=>showHint(q.id));

          const btnReveal = document.createElement("button");
          btnReveal.className = "btnSmall reveal";
          btnReveal.textContent = "Reveal";
          btnReveal.addEventListener("click", ()=>doReveal(q.id));

          btnRow.appendChild(btnCheck);
          btnRow.appendChild(btnHint);
          btnRow.appendChild(btnReveal);

          card.appendChild(btnRow);

          const msg = document.createElement("div");
          msg.className = "msgBox";
          msg.id = "msg_" + q.id;
          msg.innerHTML = `<div class="msgHead"></div><div class="msgBody"></div>`;
          card.appendChild(msg);

          root.appendChild(card);
        });
      });

      document.getElementById("scoreText").textContent = "Score: —";
    }

    function hideMsg(qid){
      const box = document.getElementById("msg_"+qid);
      if(!box) return;
      box.className = "msgBox";
      box.style.display = "none";
    }

    function showMsg(qid, mode, title, html){
      const box = document.getElementById("msg_"+qid);
      if(!box) return;
      box.querySelector(".msgHead").textContent = title;
      box.querySelector(".msgBody").innerHTML = html;
      box.style.display = "block";
      box.className = "msgBox show " + mode;
    }

    function getQuestion(qid){ return QUESTIONS.find(q=>q.id===qid); }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function doCheck(qid){
      const q = getQuestion(qid);
      if(!q) return;

      const res = q.validate((q._value || "").trim());
      q._checked = true;
      q._isCorrect = !!res.ok;

      if(res.ok){
        showMsg(qid, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : "Correct.");
      }else{
        const extra = res.msg ? `<div style="margin-bottom:8px;"><b>Note:</b> ${escapeHtml(res.msg)}</div>` : "";
        showMsg(qid, "wrong", "Solution", extra + (q.solutionHtml ? q.solutionHtml() : ""));
      }
    }

    function showHint(qid){
      const q = getQuestion(qid);
      if(!q) return;
      showMsg(qid, "hint", "Hint", q.hintHtml || "Try shifting decimals to make the divisor a whole number.");
    }

    function doReveal(qid){
      const q = getQuestion(qid);
      if(!q) return;
      q._revealed = true;
      q._checked = true;
      q._isCorrect = true;
      showMsg(qid, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : `Answer: ${q.answer}`);
      updateScoreIfSubmitted(false);
    }

    /***********************
     * Submit & score
     ***********************/
    function updateScoreIfSubmitted(forceShow){
      const submitted = forceShow || window.__submitted;
      if(!submitted) return;

      let correct = 0;
      let total = QUESTIONS.length;

      for(const q of QUESTIONS){
        if(!q._checked){
          const res = q.validate((q._value || "").trim());
          q._checked = true;
          q._isCorrect = !!res.ok;

          if(res.ok){
            showMsg(q.id, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : "Correct.");
          }else{
            const extra = res.msg ? `<div style="margin-bottom:8px;"><b>Note:</b> ${escapeHtml(res.msg)}</div>` : "";
            showMsg(q.id, "wrong", "Solution", extra + (q.solutionHtml ? q.solutionHtml() : ""));
          }
        }
        if(q._isCorrect) correct++;
      }

      document.getElementById("scoreText").textContent = `Score: ${correct} / ${total}`;
    }

    /***********************
     * Export to PDF (questions first, answer key last page)
     ***********************/
    function stripHtml(html){
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return (tmp.textContent || tmp.innerText || "").trim();
    }

    function exportToPdfViaPrint(){
      const perPage = parseInt(document.getElementById("perPageSelect").value,10) || 4;
      const student = getStudentName();
      const today = new Date();
      const dateStr = today.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"});

      let html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Decimal Division Worksheet — DYAA</title>
  <style>
    body{font-family:Arial, sans-serif; margin:24px; color:#111;}
    .head{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; border-bottom:2px solid #ddd; padding-bottom:10px;}
    .head h1{margin:0; font-size:18px;}
    .meta{font-weight:700;}
    .part{margin-top:16px;}
    .part h2{font-size:14px; margin:0 0 8px 0; padding:8px 10px; background:#f2f6ff; border:1px solid #dbe6ff; border-radius:10px;}
    .q{border:1px solid #e6e6ef; border-radius:10px; padding:10px; margin:10px 0;}
    .q .qn{font-weight:900; margin-bottom:6px;}
    .line{margin-top:10px; border-bottom:1px solid #111; height:22px;}
    .small{font-size:12px; color:#444;}
    .pagebreak{page-break-after:always;}
    .ansKey h2{font-size:16px; margin:0 0 10px 0;}
    .ansRow{border-bottom:1px solid #eee; padding:8px 0;}
    .ansRow b{display:inline-block; width:56px;}
  </style>
</head>
<body>
  <div class="head">
    <div>
      <h1>Decimal Division Worksheet — DYAA</h1>
      <div class="small">Student: ${escapeHtml(student)} &nbsp;&nbsp;|&nbsp;&nbsp; Date: ${escapeHtml(dateStr)}</div>
    </div>
    <div class="meta">Questions first → Answer Key on last page</div>
  </div>
`;

      let qOnPage = 0;
      let globalNo = 0;

      PARTS.forEach(p=>{
        const list = QUESTIONS.filter(q=>q.part===p.part);
        if(!list.length) return;

        html += `<div class="part"><h2>${escapeHtml(p.title)}</h2>`;

        list.forEach(q=>{
          globalNo++;
          html += `<div class="q">
            <div class="qn">Q${globalNo}</div>
            <div>${escapeHtml(stripHtml(q.promptHtml))}</div>
            <div class="line"></div>
          </div>`;

          qOnPage++;
          if(qOnPage >= perPage){
            html += `<div class="pagebreak"></div>`;
            qOnPage = 0;
          }
        });

        html += `</div>`;
      });

      html += `<div class="pagebreak"></div>`;
      html += `<div class="ansKey"><h2>Answer Key</h2>`;

      globalNo = 0;
      PARTS.forEach(p=>{
        const list = QUESTIONS.filter(q=>q.part===p.part);
        list.forEach(q=>{
          globalNo++;
          const ansText = (typeof q.answerKeyText === "function")
            ? q.answerKeyText()
            : (typeof q.answer === "string" ? q.answer : JSON.stringify(q.answer));
          html += `<div class="ansRow"><b>Q${globalNo}</b> ${escapeHtml(String(ansText))}</div>`;
        });
      });

      html += `</div></body></html>`;

      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(()=>w.print(), 300);
    }

    /***********************
     * New set confirm + reset
     ***********************/
    function openConfirm(){ document.getElementById("confirmBackdrop").classList.add("show"); }
    function closeConfirm(){ document.getElementById("confirmBackdrop").classList.remove("show"); }

    function generateNewSet(){
      window.__submitted = false;
      QUESTIONS = buildAllQuestions();
      renderPractice();
    }

    function resetAnswers(){
      window.__submitted = false;
      QUESTIONS.forEach(q=>{
        q._value = "";
        q._checked = false;
        q._isCorrect = false;
        q._revealed = false;
        hideMsg(q.id);
      });
      renderPractice();
    }

    /***********************
     * Tabs
     ***********************/
    function setTab(which){
      const learnTab = document.getElementById("learnTab");
      const practiceTab = document.getElementById("practiceTab");
      const learnSection = document.getElementById("learnSection");
      const practiceSection = document.getElementById("practiceSection");

      if(which==="learn"){
        learnTab.classList.add("active");
        practiceTab.classList.remove("active");
        learnSection.classList.add("active");
        practiceSection.classList.remove("active");
      }else{
        practiceTab.classList.add("active");
        learnTab.classList.remove("active");
        practiceSection.classList.add("active");
        learnSection.classList.remove("active");
      }
    }

    /***********************
     * Init bindings
     ***********************/
    document.getElementById("learnTab").addEventListener("click", ()=>setTab("learn"));
    document.getElementById("practiceTab").addEventListener("click", ()=>setTab("practice"));

    document.getElementById("newSetBtn").addEventListener("click", openConfirm);
    document.getElementById("cancelNewSet").addEventListener("click", closeConfirm);
    document.getElementById("confirmNewSet").addEventListener("click", ()=>{
      closeConfirm();
      generateNewSet();
      setTab("practice");
    });
    document.getElementById("confirmBackdrop").addEventListener("click", (e)=>{
      if(e.target.id==="confirmBackdrop") closeConfirm();
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      setTab("practice");
      exportToPdfViaPrint();
    });

    document.getElementById("submitBtn").addEventListener("click", ()=>{
      window.__submitted = true;
      updateScoreIfSubmitted(true);
    });

    document.getElementById("resetBtn").addEventListener("click", resetAnswers);

    // Start
    initStudent();
    generateNewSet();
  </script>
</body>
</html>
