<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DYAA — Daily Multiplication & Division</title>

  <style>
    :root{
      --blue:#0d47a1;
      --orange:#ff9800;
      --bg:#f4f4f9;
      --ink:#222;
      --muted:#666;
      --card:#fff;
      --line:#e6e6ef;
      --ok:#1b5e20;
      --bad:#b71c1c;
      --shadow:0 6px 15px rgba(0,0,0,0.10);
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      font-family:'Segoe UI', Tahoma, sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      color:var(--ink);
    }
    body:before{
      content:"DYAA";
      position:fixed;
      inset:auto auto 8% -10%;
      font-size:180px;
      font-weight:900;
      letter-spacing:8px;
      color:rgba(13,71,161,0.05);
      transform:rotate(-10deg);
      pointer-events:none;
      user-select:none;
    }
    .quiz-container{
      max-width:980px;
      margin:24px auto;
      background:var(--card);
      padding:26px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,0.04);
    }

    #headerLogo{
      display:flex;align-items:center;gap:12px;
      padding-bottom:12px;margin-bottom:14px;
      border-bottom:2px solid var(--line);
    }
    .logo-icon{
      width:44px;height:44px;background:var(--blue);
      border-radius:10px;position:relative;flex:0 0 auto;
      box-shadow:0 6px 14px rgba(13,71,161,0.18);
    }
    .logo-icon:before{
      content:"";position:absolute;width:22px;height:10px;background:var(--orange);
      top:-6px;left:11px;border-radius:3px;
      box-shadow:0 4px 10px rgba(255,152,0,0.22);
    }
    .logo-icon:after{
      content:"";position:absolute;width:18px;height:18px;border:2px solid rgba(255,255,255,0.75);
      left:13px;top:13px;border-radius:5px;
    }

    .header-text h1{ margin:0; font-size:22px; color:var(--blue); line-height:1.15; }
    .header-text .sub{ margin-top:4px; color:var(--muted); font-size:13px; }

    .row{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin:10px 0 6px 0;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:#fafbff;
      border-radius:999px;
      padding:8px 12px;
      color:var(--ink);
      font-size:13px;
      flex-wrap:wrap;
    }
    .pill b{color:var(--blue);}
    .pill small{color:var(--muted);}

    .select{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:7px 10px;
      font-weight:900;
      color:var(--ink);
      cursor:pointer;
      outline:none;
    }
    .select:focus{
      border-color:rgba(13,71,161,0.35);
      box-shadow:0 0 0 4px rgba(13,71,161,0.10);
    }

    .btn{
      appearance:none;border:none;cursor:pointer;
      border-radius:12px;padding:10px 12px;
      font-weight:900;font-size:13px;
      background:var(--blue);color:#fff;
      box-shadow:0 6px 14px rgba(13,71,161,0.18);
    }
    .btn:hover{filter:brightness(1.03);}
    .btn.ghost{
      background:#fff;color:var(--ink);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:900;
    }
    .btn.danger{
      background:#fff;color:var(--bad);
      border:1px solid rgba(183,28,28,0.25);
      box-shadow:none;
    }
    .btn.orange{
      background:var(--orange);
      color:#fff;
      box-shadow:0 6px 14px rgba(255,152,0,0.20);
    }

    .tabs{
      display:flex;gap:10px;margin-top:12px;
      border-bottom:1px solid var(--line);
      padding-bottom:10px;
      flex-wrap:wrap;
    }
    .tab{
      border:none;cursor:pointer;
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:1000;
      color:var(--muted);
      border:1px solid var(--line);
    }
    .tab.active{
      color:var(--blue);
      border-color:rgba(13,71,161,0.25);
      background:#f5f8ff;
    }

    .panel{display:none;margin-top:14px;}
    .panel.active{display:block;}

    .learn-card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      background:#fbfcff;
    }
    .learn-card h2{
      margin:0 0 8px 0;
      font-size:18px;
      color:var(--blue);
    }
    .learn-card p{ margin:8px 0; color:#2a2a2a; line-height:1.55; }
    .note{
      border-left:4px solid var(--orange);
      padding:10px 12px;
      background:#fff7ea;
      border-radius:12px;
      color:#4a3b22;
      margin-top:10px;
      font-size:13px;
      line-height:1.5;
    }

    .q-list{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:12px;
    }
    .q-card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,0.04);
    }
    .q-top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .q-title{
      margin:0;
      font-size:15px;
      color:var(--ink);
      line-height:1.35;
      overflow-wrap:anywhere;
    }

    .input-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    input[type="text"]{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font-size:14px;
      min-width:220px;
      max-width:100%;
      outline:none;
      background:#fff;
    }
    input[type="text"]:focus{
      border-color:rgba(13,71,161,0.35);
      box-shadow:0 0 0 4px rgba(13,71,161,0.10);
    }

    .feedback{
      margin-top:8px;
      font-size:13px;
      line-height:1.45;
      color:var(--muted);
    }
    .feedback.ok{color:var(--ok);font-weight:1000;}
    .feedback.bad{color:var(--bad);font-weight:1000;}

    .result-box{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fbfcff;
      display:none;
    }
    .result-box h3{
      margin:0 0 8px 0;
      color:var(--blue);
      font-size:16px;
    }

    /* Confirm overlay */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,0.25);
      padding:16px;
      border:1px solid rgba(0,0,0,0.08);
    }
    .modal h3{margin:0;color:var(--blue);}
    .modal p{margin:8px 0 12px 0;color:var(--ink);line-height:1.5;}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
  </style>
</head>

<body>
  <div class="quiz-container">
    <div id="headerLogo">
      <div class="logo-icon" aria-hidden="true"></div>
      <div class="header-text">
        <h1 id="pageTitle">Daily Multiplication & Division</h1>
        <div class="sub" id="pageSubtitle">Simple • Random sets • Export PDF (Q page + Answer page)</div>
      </div>
    </div>

    <!-- TOP BAR -->
    <div class="row">
      <div class="pill">
        <b>Student:</b>
        <span id="studentNameValue" class="muted">Not set</span>
        <span class="muted">•</span>
        <b>Time:</b>
        <span id="timerValue">00:00</span>
        <span id="timerStatus" class="muted" style="font-weight:900;"></span>
        <span class="muted">•</span>
        <small>URL: <span class="muted">.../mul_div_simple_pdf.html?name=Tiger</span></small>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="pill">
          <b>Questions</b>
          <select id="qCount" class="select" aria-label="Questions per set">
            <option value="10" selected>10</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="25">25</option>
          </select>
        </div>

        <button class="btn orange" id="pauseBtn" type="button">Pause</button>
        <button class="btn orange" id="newSetBtn" type="button">Generate New Set</button>
        <button class="btn" id="exportPdfBtn" type="button">Export to PDF</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="learn" type="button">Learn</button>
      <button class="tab" data-tab="practice" type="button">Practice</button>
    </div>

    <!-- LEARN -->
    <div class="panel active" id="panel-learn">
      <div class="learn-card">
        <h2>How this set is made</h2>
        <p>
          This page generates a mix of <b>multiplication</b> and <b>division</b>.
          Division questions are created by reversing the multiplication facts, so answers are always whole numbers.
        </p>

        <div class="note">
          <b>Ranges used</b><br>
          • Multiplication: 10–16 × 2–6, 17–19 × 2–4, 20–26 × 2–5, 27–29 × 2–3<br>
          • Division: inverse (reverse) from the multiplication facts
        </div>

        <div class="note" style="border-left-color: rgba(13,71,161,0.7); background:#f5f8ff; color:#1a2b55;">
          PDF Export: Page 1 shows all questions on one page; Page 2 shows all answers.
        </div>
      </div>
    </div>

    <!-- PRACTICE -->
    <div class="panel" id="panel-practice">
      <div class="row" style="margin-top:6px;">
        <div class="pill">
          <b>Instructions:</b>
          <span class="muted">Enter an integer answer (no units).</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ghost" id="submitBtn" type="button">Submit & View Results</button>
          <button class="btn ghost" id="saveBtn" type="button">Save Current Result (TXT)</button>
          <button class="btn danger" id="resetBtn" type="button">Reset Answers</button>
        </div>
      </div>

      <div class="q-list" id="questionList"></div>

      <div class="result-box" id="resultsBox">
        <h3>Results</h3>
        <div id="resultsSummary" class="muted"></div>
      </div>
    </div>
  </div>

  <!-- Confirm overlay -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>Confirm</h3>
      <p id="overlayMsg"></p>
      <div class="actions">
        <button class="btn ghost" id="overlayCancel" type="button">Cancel</button>
        <button class="btn" id="overlayOk" type="button">Confirm</button>
      </div>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /********************
     * Helpers
     ********************/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function safeName(s){
      if(!s) return "";
      return String(s).replace(/[<>]/g,"").trim().slice(0,40);
    }
    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    /********************
     * Answer parsing (strict integer)
     ********************/
    function parseAnswer(input){
      if(input == null) return NaN;
      const s = String(input).trim().replace(/,/g,"").replace(/\s+/g,"");
      if(!s) return NaN;
      if(!/^-?\d+$/.test(s)) return NaN;
      const v = Number(s);
      return Number.isFinite(v) ? v : NaN;
    }

    /********************
     * Confirm overlay
     ********************/
    const overlay = $("#overlay");
    const overlayMsg = $("#overlayMsg");
    const overlayOk = $("#overlayOk");
    const overlayCancel = $("#overlayCancel");
    let overlayOnOk = null;

    function confirmDialog(message, onOk){
      overlayMsg.textContent = message;
      overlay.style.display = "flex";
      overlayOnOk = onOk;
    }
    overlayCancel.addEventListener("click", () => {
      overlay.style.display = "none";
      overlayOnOk = null;
    });
    overlayOk.addEventListener("click", () => {
      overlay.style.display = "none";
      const fn = overlayOnOk;
      overlayOnOk = null;
      if(typeof fn === "function") fn();
    });

    /********************
     * Timer + Pause/Resume
     ********************/
    const TIMER = { seconds: 0, running: true, id: null };
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatTime(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${pad2(m)}:${pad2(s)}`;
    }
    function updateTimerUI(){
      $("#timerValue").textContent = formatTime(TIMER.seconds);
      $("#timerStatus").textContent = TIMER.running ? "" : "(Paused)";
      $("#pauseBtn").textContent = TIMER.running ? "Pause" : "Resume";
    }
    function startTimerTick(){
      if(TIMER.id) clearInterval(TIMER.id);
      TIMER.id = setInterval(() => {
        if(TIMER.running){
          TIMER.seconds += 1;
          updateTimerUI();
        }
      }, 1000);
    }
    function resetTimer(){
      TIMER.seconds = 0;
      TIMER.running = true;
      updateTimerUI();
    }
    function togglePause(){
      TIMER.running = !TIMER.running;
      updateTimerUI();
    }
    $("#pauseBtn").addEventListener("click", togglePause);

    /********************
     * Question generator (your ranges)
     ********************/
    function buildPairs(aMin,aMax,bMin,bMax){
      const pairs = [];
      for(let a=aMin;a<=aMax;a++){
        for(let b=bMin;b<=bMax;b++){
          pairs.push([a,b]);
        }
      }
      return pairs;
    }

    function makeQuestions(total){
      total = Number(total) || 10;

      const multN = Math.ceil(total / 2);
      const divN  = total - multN;

      const pools = [
        shuffle(buildPairs(10,16,2,6)),
        shuffle(buildPairs(17,19,2,4)),
        shuffle(buildPairs(20,26,2,5)),
        shuffle(buildPairs(27,29,2,3))
      ];

      // pick unique multiplication pairs (round-robin for variety)
      const used = new Set();
      const multPairs = [];
      let guard = 0;

      while(multPairs.length < multN && guard < 9999){
        guard++;
        const pi = multPairs.length % pools.length;
        let picked = null;

        while(pools[pi].length){
          const [a,b] = pools[pi].pop();
          const key = `${a}x${b}`;
          if(!used.has(key)){
            used.add(key);
            picked = [a,b];
            break;
          }
        }

        if(!picked){
          for(const pool of pools){
            while(pool.length){
              const [a,b] = pool.pop();
              const key = `${a}x${b}`;
              if(!used.has(key)){
                used.add(key);
                picked = [a,b];
                break;
              }
            }
            if(picked) break;
          }
        }

        if(picked) multPairs.push(picked);
        else break;
      }

      const multQs = multPairs.map(([a,b]) => ({
        type: "mul",
        prompt: `${a} × ${b} =`,
        answer: a * b
      }));

      // build division variants from multiplication facts
      const divVariants = [];
      for(const [a,b] of multPairs){
        const p = a * b;
        divVariants.push({ type:"div", prompt: `${p} ÷ ${a} =`, answer: b });
        divVariants.push({ type:"div", prompt: `${p} ÷ ${b} =`, answer: a });
      }

      // pick divN unique division prompts
      const pickedDiv = [];
      const divUsed = new Set();
      for(const dv of shuffle(divVariants)){
        if(pickedDiv.length >= divN) break;
        if(divUsed.has(dv.prompt)) continue;
        divUsed.add(dv.prompt);
        pickedDiv.push(dv);
      }

      // final order: multiplication first, then division (your daily style)
      return multQs.concat(pickedDiv);
    }

    /********************
     * UI state + rendering
     ********************/
    let QUESTIONS = [];
    let STATE = { answers:[], checked:[], correct:[], submitted:false };

    function renderQuestions(){
      const list = $("#questionList");
      list.innerHTML = "";

      QUESTIONS.forEach((q, idx) => {
        const card = document.createElement("div");
        card.className = "q-card";

        const userVal = STATE.answers[idx] ?? "";
        const checked = !!STATE.checked[idx];
        const correct = !!STATE.correct[idx];

        const label = (q.type === "mul") ? "Multiplication" : "Division";

        card.innerHTML = `
          <div class="q-top">
            <h3 class="q-title">Q${idx+1}. <span style="color:rgba(0,0,0,0.55); font-weight:900;">(${label})</span> ${escapeHtml(q.prompt)}</h3>
          </div>

          <div class="input-row">
            <input type="text" inputmode="numeric" autocomplete="off"
              id="ans-${idx}" placeholder="Answer"
              value="${escapeHtml(userVal)}">
            <button class="btn ghost" type="button" id="check-${idx}">Check</button>
          </div>

          <div class="feedback ${checked ? (correct ? "ok" : "bad") : ""}" id="fb-${idx}">
            ${checked
              ? (correct
                  ? "Correct ✅"
                  : `Not correct ❌ (Correct answer: ${q.answer})`)
              : ""}
          </div>
        `;

        list.appendChild(card);

        const inp = $(`#ans-${idx}`, card);
        inp.addEventListener("input", () => {
          STATE.answers[idx] = inp.value;
          STATE.checked[idx] = false;
          STATE.correct[idx] = false;
          if(STATE.submitted){
            STATE.submitted = false;
            $("#resultsBox").style.display = "none";
          }
          const fb = $(`#fb-${idx}`, card);
          fb.className = "feedback";
          fb.textContent = "";
        });

        $(`#check-${idx}`, card).addEventListener("click", () => checkOne(idx));
      });

      $("#resultsBox").style.display = "none";
    }

    function checkOne(idx){
      const q = QUESTIONS[idx];
      const v = parseAnswer(STATE.answers[idx]);
      STATE.checked[idx] = true;

      if(!Number.isFinite(v)){
        STATE.correct[idx] = false;
        renderQuestions();
        const fb = $(`#fb-${idx}`);
        fb.className = "feedback bad";
        fb.textContent = "Please enter a valid integer.";
        return;
      }

      STATE.correct[idx] = (v === q.answer);
      renderQuestions();
    }

    function submitAll(){
      let correctCount = 0;

      for(let i=0;i<QUESTIONS.length;i++){
        const q = QUESTIONS[i];
        const v = parseAnswer(STATE.answers[i]);
        STATE.checked[i] = true;
        STATE.correct[i] = Number.isFinite(v) && (v === q.answer);
        if(STATE.correct[i]) correctCount++;
      }

      STATE.submitted = true;
      renderQuestions();

      const total = QUESTIONS.length;
      const pct = total ? Math.round((correctCount/total)*100) : 0;

      const lines = QUESTIONS.map((q,i)=>(
        `<div style="margin:6px 0;"><b>Q${i+1}:</b> ${q.answer}</div>`
      )).join("");

      $("#resultsSummary").innerHTML = `
        <div><b>Score:</b> ${correctCount} / ${total} (${pct}%)</div>
        <div class="muted" style="margin-top:8px;"><b>Correct Answers:</b></div>
        <div style="margin-top:6px;">${lines}</div>
      `;
      $("#resultsBox").style.display = "block";
      window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
    }

    function resetAnswers(){
      STATE.answers = Array(QUESTIONS.length).fill("");
      STATE.checked = Array(QUESTIONS.length).fill(false);
      STATE.correct = Array(QUESTIONS.length).fill(false);
      STATE.submitted = false;
      renderQuestions();
    }

    /********************
     * Save Current Result as TXT
     ********************/
    function saveResult(){
      const student = safeName($("#studentNameValue").textContent) || "Student";
      const when = new Date();
      const dateStr = when.toLocaleString();
      const elapsed = formatTime(TIMER.seconds);

      let correctCount = 0;
      const out = [];

      out.push(`DYAA — Save Current Result`);
      out.push(`Title: Daily Multiplication & Division`);
      out.push(`Student: ${student}`);
      out.push(`Date: ${dateStr}`);
      out.push(`Elapsed Time: ${elapsed}`);
      out.push(``);

      QUESTIONS.forEach((q, i) => {
        const raw = (STATE.answers[i] ?? "").toString().trim();
        const v = parseAnswer(raw);
        const valid = Number.isFinite(v);
        const isCorrect = valid && (v === q.answer);
        if(isCorrect) correctCount++;

        out.push(`Q${i+1}: ${q.prompt}`);
        out.push(`Your answer: ${valid ? v : (raw ? raw : "(blank)")}`);
        out.push(`Correct answer: ${q.answer}`);
        out.push(`Result: ${isCorrect ? "Correct" : "Not correct"}`);
        out.push(``);
      });

      const total = QUESTIONS.length;
      const pct = total ? Math.round((correctCount/total)*100) : 0;
      out.splice(5, 0, `Score: ${correctCount} / ${total} (${pct}%)`);

      const text = out.join("\r\n");
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `DYAA_MulDiv_${total}Q_${student.replace(/\s+/g,"_")}_result.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /********************
     * Tabs + Student name
     ********************/
    $$(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        $$(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        const tab = btn.getAttribute("data-tab");
        $$(".panel").forEach(p=>p.classList.remove("active"));
        $(`#panel-${tab}`).classList.add("active");
      });
    });

    function ensureStudentName(){
      const fromUrl = safeName(getParam("name"));
      if(fromUrl){
        $("#studentNameValue").textContent = fromUrl;
        return;
      }
      const name = safeName(prompt("Enter student name (or open URL with ?name=YourName):", ""));
      $("#studentNameValue").textContent = name ? name : "Anonymous";
    }

    /********************
     * Generate New Set
     ********************/
    function generateNewSet(){
      const total = Number($("#qCount").value) || 10;
      QUESTIONS = makeQuestions(total);

      STATE.answers = Array(QUESTIONS.length).fill("");
      STATE.checked = Array(QUESTIONS.length).fill(false);
      STATE.correct = Array(QUESTIONS.length).fill(false);
      STATE.submitted = false;

      resetTimer();
      renderQuestions();
    }

    $("#newSetBtn").addEventListener("click", ()=>{
      confirmDialog("Generate a new set? This will clear your current answers and reset the timer.", () => {
        generateNewSet();
        // switch to practice automatically
        $$('.tab').forEach(b=>b.classList.remove('active'));
        $('.tab[data-tab="practice"]').classList.add('active');
        $$('.panel').forEach(p=>p.classList.remove('active'));
        $('#panel-practice').classList.add('active');
      });
    });

    $("#submitBtn").addEventListener("click", submitAll);
    $("#resetBtn").addEventListener("click", ()=>{
      confirmDialog("Reset all answers for the current set?", resetAnswers);
    });
    $("#saveBtn").addEventListener("click", saveResult);

    /********************
     * Export PDF: page 1 questions (single page), page 2 answers
     ********************/
    function choosePdfLayout(total, usableW, usableH){
      // Try big font + few columns first; ensure everything fits on ONE page.
      // Return {fontSize, cols, lineH}
      const sizes = [12, 11, 10, 9, 8];
      const colsTry = [1, 2, 3];

      for(const fontSize of sizes){
        // approx line height in mm
        const lineH = Math.max(5.0, fontSize * 0.42); // tuned for jsPDF mm
        for(const cols of colsTry){
          const colW = usableW / cols;
          const linesPerCol = Math.floor(usableH / lineH);
          const capacity = linesPerCol * cols;
          if(capacity >= total){
            return { fontSize, cols, lineH, linesPerCol, colW };
          }
        }
      }
      // fallback (will still try best)
      const fontSize = 8;
      const lineH = Math.max(5.0, fontSize * 0.42);
      const cols = 3;
      const colW = usableW / cols;
      const linesPerCol = Math.max(1, Math.floor(usableH / lineH));
      return { fontSize, cols, lineH, linesPerCol, colW };
    }

    function exportToPdf(){
      const libsOk = (window.jspdf && window.jspdf.jsPDF);
      if(!libsOk){
        alert("jsPDF failed to load. Please check your internet (CDN) or host jsPDF locally.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

      const student = safeName($("#studentNameValue").textContent) || "Student";
      const now = new Date();
      const dateStr = now.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
      const timeStr = $("#timerValue").textContent;
      const total = QUESTIONS.length;

      // Page constants
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 10;

      // ===== Page 1: Questions (all on ONE page) =====
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(14);
      pdf.text("DYAA — Multiplication & Division", margin, 14);

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(10);
      pdf.text(`Student: ${student}`, margin, 20);
      pdf.text(`Date: ${dateStr}   Time: ${timeStr}`, margin, 25);
      pdf.text(`Questions: ${total}`, margin, 30);

      // area for questions
      const startY = 36;
      const usableW = pageW - margin*2;
      const usableH = pageH - startY - margin;

      const layoutQ = choosePdfLayout(total, usableW, usableH);

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(layoutQ.fontSize);

      for(let i=0;i<total;i++){
        const col = Math.floor(i / layoutQ.linesPerCol);
        const row = i % layoutQ.linesPerCol;

        const x = margin + col * layoutQ.colW;
        const y = startY + row * layoutQ.lineH;

        const q = QUESTIONS[i];
        const blank = "______";
        const line = `Q${i+1}. ${q.prompt} ${blank}`;
        pdf.text(line, x, y);
      }

      // ===== Page 2: Answers =====
      pdf.addPage();

      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(14);
      pdf.text("Answers", margin, 14);

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(10);
      pdf.text(`Student: ${student}`, margin, 20);
      pdf.text(`Date: ${dateStr}`, margin, 25);

      const startY2 = 34;
      const usableH2 = pageH - startY2 - margin;
      const usableW2 = pageW - margin*2;

      const answerLines = QUESTIONS.map((q,i)=>`Q${i+1}: ${q.answer}`);
      const layoutA = choosePdfLayout(answerLines.length, usableW2, usableH2);

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(layoutA.fontSize);

      for(let i=0;i<answerLines.length;i++){
        const col = Math.floor(i / layoutA.linesPerCol);
        const row = i % layoutA.linesPerCol;

        const x = margin + col * layoutA.colW;
        const y = startY2 + row * layoutA.lineH;

        pdf.text(answerLines[i], x, y);
      }

      const safeStudent = student.replace(/\s+/g, "_");
      pdf.save(`DYAA_MulDiv_${total}Q_${safeStudent}.pdf`);
    }

    $("#exportPdfBtn").addEventListener("click", exportToPdf);

    /********************
     * Init
     ********************/
    ensureStudentName();
    updateTimerUI();
    startTimerTick();
    generateNewSet();
  </script>
</body>
</html>
