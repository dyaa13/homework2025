<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Random Mixed Calculation Quiz</title>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .quiz-container {
      max-width: 900px;
      margin: 40px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    #headerLogo {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background-color: #0d47a1;
      border-radius: 4px;
    }

    .logo-text span.edu {
      font-size: 0.9em;
      color: #ff9800;
      font-weight: 700;
      margin-left: 10px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }

    #timerDisplay {
      font-size: 0.95em;
      color: #333;
    }

    #studentDisplay {
      font-size: 0.95em;
      color: #333;
      font-weight: 600;
    }

    .quiz-main {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 140px;
      border-right: 1px solid #ddd;
      padding-right: 10px;
      display: none;
    }

    .sidebar h4 {
      margin: 0 0 8px;
      font-size: 0.95em;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .sidebar li.active {
      outline: 2px solid #1976d2;
      font-weight: 600;
    }

    .sidebar li.answered {
      border-left: 4px solid #4caf50;
    }

    .sidebar li.correct {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }

    .sidebar li.incorrect {
      background: #f8d7da;
      border-left: 4px solid #f44336;
    }

    #quizContent {
      flex: 1;
    }

    .question-text {
      font-size: 1.1em;
      margin-bottom: 8px;
    }

    .instructions {
      font-size: 0.9em;
      color: #555;
      margin-top: 6px;
      margin-bottom: 12px;
    }

    .part-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .single-question {
      margin-top: 6px;
      margin-bottom: 6px;
    }

    .answer-box {
      width: 140px;
      padding: 6px;
      font-size: 1em;
      margin-left: 8px;
    }

    .button-container {
      display: flex;
      justify-content: flex-start;
      margin-top: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 20px;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
    }

    #nextButton { background:#4caf50; }
    #backButton { background:#039be5; }
    #generateButton { background:#ff9800; }
    #submitButton { background:#9c27b0; }
    #saveButton { background:#607d8b; }
    #pauseButton { background:#f57c00; }
    #checkButton { background:#455a64; }

    table.review-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .review-table th,
    .review-table td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 0.85em;
      text-align: center;
    }

    .review-table th {
      background: #f2f2f2;
    }

    .correct-answer { background: #d4edda; }
    .incorrect-answer { background: #f8d7da; }

    /* 分数上下显示 */
    .frac {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
    }

    .frac .top {
      display: block;
      border-bottom: 1px solid #000;
      padding: 0 2px;
    }

    .frac .bottom {
      display: block;
      padding: 0 2px;
      font-size: 0.9em;
    }

    .status-line {
      font-size: 0.9em;
      margin-top: 4px;
    }
    .status-ok {
      color:#2e7d32;
      font-weight:600;
    }
    .status-bad {
      color:#c62828;
      font-weight:600;
    }

    @media (max-width: 700px) {
      .quiz-main { flex-direction: column; }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
        padding-bottom: 10px;
      }
    }
  
/* Export to PDF button */
#exportPdfButton { background:#1976d2; }

/* Modal (Export to PDF) */
.modal-overlay{
  position:fixed;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.45);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal{
  width:min(420px, 92vw);
  background:#fff;
  border-radius:12px;
  padding:18px 18px 14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
}
.modal h3{
  margin:0 0 12px;
  font-size:1.1em;
}
.modal-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin:10px 0;
  font-size:0.95em;
}
.modal-row label{ color:#333; font-weight:600; }
.modal-row select{
  width:160px;
  padding:7px 10px;
  border:1px solid #ccc;
  border-radius:8px;
  font-size:0.95em;
}
.modal-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:14px;
}
.modal-btn{
  padding:8px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  color:#fff;
  font-size:0.95em;
}
.modal-btn.secondary{ background:#607d8b; }
.modal-btn.primary{ background:#1976d2; }

/* Hidden PDF render root (off-screen) */
#pdfRenderRoot{
  position:fixed;
  left:-9999px;
  top:-9999px;
  width:210mm;
  background:#fff;
}

/* PDF page layout */
.pdf-page{
  width:210mm;
  height:297mm;
  box-sizing:border-box;
  padding:10mm 10mm 8mm;
  background:#fff;
  color:#222;
  font-family:'Segoe UI', Tahoma, sans-serif;
}
.pdf-page.compact{
  padding:7mm 7mm 6mm;
}
.pdf-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:2px solid #e0e0e0;
  padding-bottom:5px;
  margin-bottom:8px;
}
.pdf-page.compact .pdf-header{
  padding-bottom:4px;
  margin-bottom:6px;
}
.pdf-brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.pdf-logo{
  width:14mm;
  height:14mm;
  background:#0d47a1;
  border-radius:2mm;
}
.pdf-page.compact .pdf-logo{
  width:12mm;
  height:12mm;
  border-radius:1.8mm;
}
.pdf-title{
  font-size:13pt;
  font-weight:700;
  margin:0;
}
.pdf-page.compact .pdf-title{
  font-size:11pt;
}
.pdf-meta{
  font-size:9.5pt;
  text-align:right;
  color:#333;
}
.pdf-page.compact .pdf-meta{
  font-size:8.2pt;
}
.pdf-grid{
  display:flex;
  flex-wrap:wrap;
  gap:5mm;
}
.pdf-grid.compact{
  gap:2.6mm;
}
.pdf-card{
  flex:0 0 calc(50% - 2.5mm);
  border:1px solid #cfcfcf;
  border-radius:10px;
  padding:4.5mm;
  box-sizing:border-box;
  min-height:26mm;
}
.pdf-grid.cols-3 .pdf-card{ flex-basis: calc(33.333% - 3.4mm); }
.pdf-grid.cols-4 .pdf-card{ flex-basis: calc(25% - 3.4mm); }

.pdf-page.compact .pdf-card{
  padding:3mm;
  border-radius:8px;
  min-height:18mm;
}
.pdf-qnum{
  font-weight:700;
  margin-bottom:3px;
  font-size:10pt;
}
.pdf-page.compact .pdf-qnum{
  font-size:9pt;
  margin-bottom:2px;
}
.pdf-qtext{
  font-size:11pt;
  line-height:1.15;
  margin-bottom:4mm;
  word-break:break-word;
}
.pdf-page.compact .pdf-qtext{
  font-size:9.5pt;
  line-height:1.1;
  margin-bottom:2.4mm;
}
.pdf-answer{
  font-size:9.5pt;
  color:#222;
}
.pdf-page.compact .pdf-answer{
  font-size:8.5pt;
}
.pdf-answer-line{
  display:inline-block;
  border-bottom:1px solid #333;
  width:65%;
  transform:translateY(-2px);
  margin-left:5px;
}
.pdf-page.compact .pdf-answer-line{
  width:55%;
  margin-left:4px;
}
/* Make fraction size consistent inside PDF cards */
.pdf-card .frac{ font-size:1em; }
.pdf-card .frac .top{ padding:0 2px; }
.pdf-card .frac .bottom{ font-size:0.9em; }
/* Answer key (separate PDF page) */
.pdf-answerkey{
  margin-top:2mm;
}
.pdf-answerkey-title{
  font-size:14pt;
  font-weight:800;
  margin:0 0 4mm;
}
.pdf-page.compact .pdf-answerkey-title{
  font-size:12pt;
  margin-bottom:3mm;
}
.pdf-ans-grid{
  display:flex;
  flex-wrap:wrap;
  column-gap:6mm;
  row-gap:2mm;
}
.pdf-ans-item{
  flex:0 0 calc(50% - 3mm);
  font-size:11pt;
  line-height:1.2;
  word-break:break-word;
}
.pdf-page.compact .pdf-ans-item{
  font-size:10pt;
}
.pdf-ans-num{
  font-weight:700;
  margin-right:4px;
}
.pdf-ans-item .frac{
  font-size:1em;
}
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text"><span class="edu">EDUCATION</span></div>
  </div>

  <div class="top-bar">
    <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentDisplay" style="display:none;">Student: Student</div>
    </div>
    <div>
      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="generateButton" style="display:none;">Generate New Set</button>
      <button id="exportPdfButton" style="display:none;">Export to PDF</button>
    </div>
  </div>

  <h2>Random Mixed Calculation Quiz</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <!-- 底部只留 Save 按钮（结果页用） -->
  <div class="button-container">
    <button id="saveButton" style="display:none;">Save Current Result</button>
  </div>
</div>

<!-- Export to PDF Modal + Hidden Render Root -->
<div id="pdfModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h3>Export to PDF</h3>

    <div class="modal-row">
      <label for="pdfTotalSelect">Total questions</label>
      <select id="pdfTotalSelect">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
    </div>

    <div class="modal-row">
      <label for="pdfPerPageSelect">Questions per page</label>
      <select id="pdfPerPageSelect">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
    </div>

    <div class="modal-actions">
      <button id="pdfCancelBtn" class="modal-btn secondary" type="button">Cancel</button>
      <button id="pdfExportBtn" class="modal-btn primary" type="button">Export</button>
    </div>
  </div>
</div>

<div id="pdfRenderRoot" aria-hidden="true"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */

const PART_TITLES = [
  "A. Mixed Decimals / Integers / Negatives",
  "B. Fractions × ÷ (with some negatives)",
  "C. Mixed Decimals / Fractions / Percentages"
];

const NUM_PARTS = 3;
const QUESTIONS_PER_PART = 6;
const TOTAL_QUESTIONS = NUM_PARTS * QUESTIONS_PER_PART;

/* ----------------------------------------------------------
   工具函数
---------------------------------------------------------- */

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function choice(arr) {
  return arr[randInt(0, arr.length - 1)];
}

function gcd(a, b) {
  a = Math.abs(a);
  b = Math.abs(b);
  while (b !== 0) {
    let t = b;
    b = a % b;
    a = t;
  }
  return a === 0 ? 1 : a;
}

function simplifyFraction(fr) {
  if (fr.d < 0) {
    fr.n = -fr.n;
    fr.d = -fr.d;
  }
  const g = gcd(fr.n, fr.d);
  fr.n /= g;
  fr.d /= g;
  return fr;
}

function fractionToValue(fr) {
  return fr.n / fr.d;
}

function fractionToString(fr) {
  fr = simplifyFraction({ n: fr.n, d: fr.d });
  if (fr.d === 1) return String(fr.n);
  return `${fr.n}/${fr.d}`;
}

// 分数转 HTML 上下形式
function fractionToHtml(fr) {
  fr = simplifyFraction({ n: fr.n, d: fr.d });
  if (fr.d === 1) return String(fr.n);
  return `<span class="frac"><span class="top">${fr.n}</span><span class="bottom">${fr.d}</span></span>`;
}

// 把整数 + 小数位数转成字符串，并去掉多余 0
function formatNumberFromInt(xInt, shift) {
  const isNegative = xInt < 0;
  const absInt = Math.abs(xInt);
  const base = absInt / Math.pow(10, shift);
  let s = base.toFixed(shift);
  s = s.replace(/\.0+$/,"").replace(/(\.\d*?[1-9])0+$/,"$1");
  if (isNegative) s = "-" + s;
  return s;
}

// 毫秒 -> mm:ss
function formatMs(ms) {
  const totalSec = Math.floor(ms / 1000);
  const min = Math.floor(totalSec / 60);
  const sec = totalSec % 60;
  return `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

/* ----------------------------------------------------------
   解析答案
---------------------------------------------------------- */

function parseAnswer(str) {
  let s = str.trim();
  if (s === "") return NaN;

  let sign = 1;
  if (s[0] === "+") {
    s = s.slice(1).trim();
  } else if (s[0] === "-") {
    sign = -1;
    s = s.slice(1).trim();
  }
  if (s === "") return NaN;

  const spaceParts = s.split(/\s+/);
  if (spaceParts.length === 2 && spaceParts[1].includes("/")) {
    const whole = Number(spaceParts[0]);
    const fracParts = spaceParts[1].split("/");
    if (fracParts.length !== 2) return NaN;

    const num = Number(fracParts[0]);
    const den = Number(fracParts[1]);

    if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;

    const absWhole = Math.abs(whole);
    const fracVal = num / den;
    let value = absWhole + fracVal;

    if (whole < 0) value = -value;

    return sign * value;
  }

  if (s.includes("/")) {
    const parts = s.split("/");
    if (parts.length !== 2) return NaN;

    const num = Number(parts[0]);
    const den = Number(parts[1]);

    if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;

    return sign * (num / den);
  }

  const n = Number(s);
  return Number.isFinite(n) ? sign * n : NaN;
}

function nearlyEqual(a, b, eps = 1e-6) {
  if (!Number.isFinite(a) || !Number.isFinite(b)) return false;
  return Math.abs(a - b) < eps;
}

/* ----------------------------------------------------------
   题目生成
---------------------------------------------------------- */

function generateDecimalQuestion() {
  const opType = choice(["mul", "div"]);
  const signCase = choice(["pos", "negA", "negB"]);

  let text = "";
  let value = 0;

  if (opType === "mul") {
    // 两位数 × 一位数（都不是 1）
    let aInt = randInt(10, 99);
    let bInt = randInt(2, 9);  // 避免 1

    let shiftA = randInt(0, 2);
    let shiftB = randInt(0, 2);

    // 避免太简单（整数×整数）
    if (shiftA === 0 && shiftB === 0 && Math.random() < 0.5) {
      if (Math.random() < 0.5) shiftA = choice([1,2]);
      else shiftB = choice([1,2]);
    }

    if (signCase === "negA") aInt = -aInt;
    if (signCase === "negB") bInt = -bInt;

    const aVal = aInt / Math.pow(10, shiftA);
    const bVal = bInt / Math.pow(10, shiftB);

    value = aVal * bVal;

    const aStr = formatNumberFromInt(aInt, shiftA);
    const bStr = formatNumberFromInt(bInt, shiftB);

    text = `${aStr} × ${bStr}`;

  } else {
    // 两位数 ÷ 一位数，再加小数点
    let dividendInt, divisorInt, quotientInt;
    while (true) {
      divisorInt = randInt(2, 9);      // 避免 1
      quotientInt = randInt(2, 12);
      dividendInt = divisorInt * quotientInt;
      if (dividendInt >= 10 && dividendInt <= 99) break;
    }

    let shiftDividend = randInt(0, 2);
    let shiftDivisor  = randInt(0, 2);

    // 有机会生成 0.02 / 0.05 一类
    if (Math.random() < 0.3 && (divisorInt === 2 || divisorInt === 5)) {
      shiftDivisor = 2;
      shiftDividend = randInt(0, 2);
    }

    if (shiftDividend === 0 && shiftDivisor === 0 && Math.random() < 0.5) {
      if (Math.random() < 0.5) shiftDividend = choice([1,2]);
      else shiftDivisor = choice([1,2]);
    }

    if (signCase === "negA") dividendInt = -dividendInt;
    if (signCase === "negB") divisorInt  = -divisorInt;

    const dividendVal = dividendInt / Math.pow(10, shiftDividend);
    const divisorVal  = divisorInt  / Math.pow(10, shiftDivisor);

    value = dividendVal / divisorVal;

    const dividendStr = formatNumberFromInt(dividendInt, shiftDividend);
    const divisorStr  = formatNumberFromInt(divisorInt,  shiftDivisor);

    text = `${dividendStr} ÷ ${divisorStr}`;
  }

  return {
    text,
    value,
    display: String(Number(value.toFixed(6)))
  };
}

function randomFraction() {
  const dens = [2,3,4,5,6,8,10,12];
  while (true) {
    const d = choice(dens);
    let n = randInt(1, d * 2);
    if (Math.random() < 0.3) n = -n;

    let fr = simplifyFraction({ n, d });
    if (Math.abs(fr.n) === fr.d) continue; // 排除 ±1
    return fr;
  }
}

function generateFractionQuestion() {
  const opType = choice(["mul", "div"]);

  let f1 = randomFraction();
  let f2 = randomFraction();
  if (f2.n === 0) f2.n = 1;

  let result;

  if (opType === "mul") {
    result = simplifyFraction({
      n: f1.n * f2.n,
      d: f1.d * f2.d
    });
  } else {
    result = simplifyFraction({
      n: f1.n * f2.d,
      d: f1.d * f2.n
    });
  }

  if (Math.abs(result.n) > 50 || Math.abs(result.d) > 50) {
    return generateFractionQuestion();
  }

  const opSymbol = opType === "mul" ? "×" : "÷";
  const f1Html = fractionToHtml(f1);
  const f2Html = fractionToHtml(f2);

  return {
    text: `${f1Html} ${opSymbol} ${f2Html}`,
    value: fractionToValue(result),
    display: fractionToString(result),
    displayHtml: fractionToHtml(result)
  };
}

function generateMixedQuestion() {
  const pattern = choice([1,2,3,4,5]);

  let text = "";
  let value = 0;

  if (pattern === 1) {
    const percents = [10,20,25,30,40,50,60,75];
    let p = choice(percents);
    let b = choice([0.6,0.8,1.2,1.5,1.8,-0.8,-1.2]);
    value = b * (p / 100);
    text = `${p}% of ${b}`;

  } else if (pattern === 2) {
    const d = choice([2,3,4,5,6,8,10]);
    const n = randInt(1, d - 1);
    const f = simplifyFraction({ n, d });
    const fHtml = fractionToHtml(f);

    let dec = choice([0.6,0.8,1.2,1.5,2.4]);
    if (Math.random() < 0.3) dec = -dec;

    value = dec * (f.n / f.d);
    text = `${fHtml} of ${dec}`;

  } else if (pattern === 3) {
    const d = choice([2,3,4,5,6,8,10]);
    const n = randInt(1, d - 1);
    const f = simplifyFraction({ n, d });
    const fHtml = fractionToHtml(f);

    let dec = choice([0.4,0.5,0.6,0.75,0.8,1.2]);
    if (Math.random() < 0.4) dec = -dec;

    value = dec * (f.n / f.d);
    text = `${dec} × ${fHtml}`;

  } else if (pattern === 4) {
    let dec = choice([0.36,0.48,0.72,1.2]);
    const p = choice([20,25,40,60]);
    if (Math.random() < 0.4) dec = -dec;

    value = dec / (p / 100);
    text = `${dec} ÷ ${p}%`;

  } else {
    const d = choice([2,3,4,5,6,8]);
    const whole = randInt(1, 3);
    const n = randInt(1, d - 1);
    const f = simplifyFraction({ n, d });

    const improper = simplifyFraction({
      n: whole * f.d + f.n,
      d: f.d
    });
    const improperHtml = fractionToHtml(improper);

    let dec = -choice([0.6,0.8,1.2,1.5]);
    value = dec * (improper.n / improper.d);

    text = `${dec} × ${improperHtml}`;
  }

  value = Number(value.toFixed(6));

  return {
    text,
    value,
    display: String(value)
  };
}

/* ----------------------------------------------------------
   QueryString 读取 name 参数
---------------------------------------------------------- */

function getNameFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get("name");
  if (!raw) return null;
  const name = raw.trim();
  return name ? name : null;
}

function updateStudentDisplay() {
  const el = document.getElementById("studentDisplay");
  el.style.display = "inline-block";
  el.textContent = `Student: ${studentName}`;
}

/* ----------------------------------------------------------
   全局状态（含计时器）
---------------------------------------------------------- */

let questions = [];
let currentQuestionIndex = 0;
let studentName = "Student";
let quizStartTime = null;
let quizEndTime = null;
let quizSubmitted = false;

let timerInterval = null;
let elapsedMs = 0;          // 当前这一轮已累计毫秒
let isPaused = false;
let firstAttemptMs = null;  // 首次提交的用时（锁定）

const quizContent   = document.getElementById("quizContent");
const sidebarEl     = document.getElementById("sidebar");
const saveButton    = document.getElementById("saveButton");
const generateBtn   = document.getElementById("generateButton");
const pauseButton   = document.getElementById("pauseButton");
const timerDisplay  = document.getElementById("timerDisplay");
const exportPdfButton = document.getElementById("exportPdfButton");
const pdfModal        = document.getElementById("pdfModal");
const pdfTotalSelect  = document.getElementById("pdfTotalSelect");
const pdfPerPageSelect= document.getElementById("pdfPerPageSelect");
const pdfCancelBtn    = document.getElementById("pdfCancelBtn");
const pdfExportBtn    = document.getElementById("pdfExportBtn");
const pdfRenderRoot   = document.getElementById("pdfRenderRoot");


// 题目按钮（放在题目下面用）
const backButton   = document.createElement("button");
backButton.id = "backButton";
backButton.textContent = "Previous";

const nextButton   = document.createElement("button");
nextButton.id = "nextButton";
nextButton.textContent = "Next";

const submitButton = document.createElement("button");
submitButton.id = "submitButton";
submitButton.textContent = "Submit & View Results";

const checkButton  = document.createElement("button");
checkButton.id = "checkButton";
checkButton.textContent = "Check Answer";

// 套用和 CSS 一致的颜色
backButton.style.background = "#039be5";
nextButton.style.background = "#4caf50";
submitButton.style.background = "#9c27b0";
checkButton.style.background = "#455a64";
backButton.style.color = nextButton.style.color = submitButton.style.color = checkButton.style.color = "white";
backButton.style.borderRadius = nextButton.style.borderRadius = submitButton.style.borderRadius = checkButton.style.borderRadius = "6px";
backButton.style.padding = nextButton.style.padding = submitButton.style.padding = checkButton.style.padding = "8px 20px";
backButton.style.border = nextButton.style.border = submitButton.style.border = checkButton.style.border = "none";
backButton.style.cursor = nextButton.style.cursor = submitButton.style.cursor = checkButton.style.cursor = "pointer";
backButton.style.fontSize = nextButton.style.fontSize = submitButton.style.fontSize = checkButton.style.fontSize = "0.95em";

/* ----------------------------------------------------------
   计时器相关
---------------------------------------------------------- */

function updateTimerDisplay() {
  let totalMs = elapsedMs;
  if (!isPaused && quizStartTime) {
    totalMs += (new Date() - quizStartTime);
  }
  let text = `Time: ${formatMs(totalMs)}`;
  if (firstAttemptMs !== null) {
    text += ` (First: ${formatMs(firstAttemptMs)})`;
  }
  timerDisplay.textContent = text;
}

function startTimerInterval() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay, 1000);
}

function pauseTimer() {
  if (isPaused || !quizStartTime) return;
  const now = new Date();
  elapsedMs += now - quizStartTime;
  isPaused = true;
  quizStartTime = null;
  updateTimerDisplay();
}

function resumeTimer() {
  if (!isPaused) return;
  isPaused = false;
  quizStartTime = new Date();
  updateTimerDisplay();
}

/* ----------------------------------------------------------
   生成整套题
---------------------------------------------------------- */

function generateQuiz() {
  questions = [];
  quizSubmitted = false;

  for (let p = 0; p < NUM_PARTS; p++) {
    for (let i = 0; i < QUESTIONS_PER_PART; i++) {

      let baseQ;
      if (p === 0) baseQ = generateDecimalQuestion();
      else if (p === 1) baseQ = generateFractionQuestion();
      else baseQ = generateMixedQuestion();

      questions.push({
        partIndex: p,
        indexInPart: i,
        text: baseQ.text,
        value: baseQ.value,
        display: baseQ.display,
        displayHtml: baseQ.displayHtml || null,
        userValue: "",
        isCorrect: false
      });
    }
  }
}

/* ----------------------------------------------------------
   Sidebar
---------------------------------------------------------- */

function renderSidebar() {
  sidebarEl.style.display = "block";
  sidebarEl.innerHTML = `
    <h4>Questions</h4>
    <ul id="qList"></ul>
  `;

  const ul = document.getElementById("qList");
  for (let i = 0; i < TOTAL_QUESTIONS; i++) {
    const q = questions[i];
    const li = document.createElement("li");
    const label = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);

    li.textContent = `Q${i + 1} (${label})`;
    li.dataset.index = i;

    li.addEventListener("click", () => {
      saveCurrentInput();
      currentQuestionIndex = i;
      renderQuestion();
    });

    ul.appendChild(li);
  }

  updateSidebarStatus();
}

function updateSidebarStatus() {
  const items = document.querySelectorAll("#qList li");

  items.forEach(li => {
    const idx = Number(li.dataset.index);
    const q = questions[idx];

    li.classList.remove("active", "answered", "correct", "incorrect");

    li.classList.toggle("active", idx === currentQuestionIndex);

    if (!quizSubmitted) {
      if ((q.userValue || "").trim() !== "") {
        li.classList.add("answered");
      }
    } else {
      if ((q.userValue || "").trim() !== "") {
        if (q.isCorrect) li.classList.add("correct");
        else li.classList.add("incorrect");
      }
    }
  });
}

/* ----------------------------------------------------------
   显示单题
---------------------------------------------------------- */

function renderQuestion() {
  const q = questions[currentQuestionIndex];
  const partLabel = ["A","B","C"][q.partIndex];
  const fullLabel = `${partLabel}${q.indexInPart + 1}`;

  quizContent.innerHTML = `
    <p class="question-text">
      Question ${currentQuestionIndex + 1} of ${TOTAL_QUESTIONS}
    </p>

    <div class="part-title">${PART_TITLES[q.partIndex]}</div>

    <div class="single-question">
      ${fullLabel}. ${q.text}
      <input id="answerInput" class="answer-box" type="text" value="${q.userValue || ""}">
    </div>

    <p id="statusLine" class="status-line">Status: <span>—</span></p>

    <p class="instructions">
      Enter your answer using integers, decimals, or fractions (e.g., 3/4 or -2 1/3).
      Answers will always be shown as improper fractions when applicable.
    </p>
  `;

  // 把按钮条插到题目下面
  const btnBar = document.createElement("div");
  btnBar.className = "button-container";

  // Previous
  btnBar.appendChild(backButton);
  // Next
  btnBar.appendChild(nextButton);
  // Submit 只在最后一题出现
  if (currentQuestionIndex === TOTAL_QUESTIONS - 1) {
    btnBar.appendChild(submitButton);
  }
  // Check 只在提交之后出现
  if (quizSubmitted) {
    btnBar.appendChild(checkButton);
  }

  quizContent.appendChild(btnBar);

  // 按钮显示/隐藏细节
  backButton.style.display = "inline-block";
  nextButton.style.display = "inline-block";

  backButton.style.visibility = currentQuestionIndex === 0 ? "hidden" : "visible";
  nextButton.style.visibility = currentQuestionIndex === TOTAL_QUESTIONS - 1 ? "hidden" : "visible";

  submitButton.style.display = currentQuestionIndex === TOTAL_QUESTIONS - 1 ? "inline-block" : "none";
  checkButton.style.display  = quizSubmitted ? "inline-block" : "none";

  updateSidebarStatus();
}

function saveCurrentInput() {
  const input = document.getElementById("answerInput");
  if (input) {
    questions[currentQuestionIndex].userValue = input.value.trim();
  }
}

/* ----------------------------------------------------------
   保存当前结果为 txt
---------------------------------------------------------- */

function formatDateForFilename(date) {
  if (!date) return "no_time";
  const pad = n => String(n).padStart(2, "0");
  return (
    date.getFullYear() +
    pad(date.getMonth() + 1) +
    pad(date.getDate()) + "_" +
    pad(date.getHours()) +
    pad(date.getMinutes()) +
    pad(date.getSeconds())
  );
}

function saveCurrentResultAsTxt() {
  saveCurrentInput();

  if (!quizSubmitted) {
    questions.forEach(q => {
      const val = parseAnswer(q.userValue || "");
      q.isCorrect = nearlyEqual(val, q.value);
    });
  }

  let correctCount = 0;
  questions.forEach(q => { if (q.isCorrect) correctCount++; });

  let lines = [];
  lines.push("Random Mixed Calculation Quiz - Current Result");
  lines.push("Student: " + studentName);
  if (quizStartTime) lines.push("Start time: " + quizStartTime.toLocaleString());
  if (quizEndTime) lines.push("Last submit time: " + quizEndTime.toLocaleString());
  lines.push("Score: " + correctCount + " / " + TOTAL_QUESTIONS);
  if (firstAttemptMs !== null) lines.push("First attempt time: " + formatMs(firstAttemptMs));
  lines.push("");
  lines.push("Details:");
  lines.push("----------");

  questions.forEach((q, i) => {
    const partLbl = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);
    const userAns = (q.userValue || "").trim() === "" ? "Not answered" : q.userValue;
    const resultText = (q.userValue || "").trim() === ""
      ? "Not answered"
      : (q.isCorrect ? "Correct" : "Incorrect");

    const plainQuestion = q.text.replace(/<[^>]+>/g,"");

    lines.push(
      `Q${i + 1} (${partLbl})` +
      "\nQuestion: " + plainQuestion +
      "\nYour answer: " + userAns +
      "\nCorrect answer: " + q.display +
      "\nResult: " + resultText
    );
    lines.push("");
  });

  const content = lines.join("\n");
  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = studentName.replace(/[^a-z0-9_\-]/gi, "_") || "Student";
  const ts = formatDateForFilename(new Date());
  a.href = url;
  a.download = `MixedQuiz_${safeName}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ----------------------------------------------------------
   结果页面 & 提交逻辑
---------------------------------------------------------- */

function calculateAndShowResults() {
  saveCurrentInput();

  const now = new Date();

  // 当前这一轮用时
  let attemptMs = elapsedMs;
  if (!isPaused && quizStartTime) {
    attemptMs += now - quizStartTime;
  }

  // 记录首次用时
  if (firstAttemptMs === null) {
    firstAttemptMs = attemptMs;
  }

  // 展示的开始/结束
  const attemptStartTime = quizStartTime || now;
  quizEndTime = now;

  quizSubmitted = true;

  // 判分
  let correctCount = 0;
  questions.forEach(q => {
    const val = parseAnswer(q.userValue || "");
    q.isCorrect = nearlyEqual(val, q.value);
    if (q.isCorrect) correctCount++;
  });

  updateSidebarStatus();

  const diffSec = Math.floor(attemptMs / 1000);
  const min = Math.floor(diffSec / 60);
  const sec = diffSec % 60;

  let timeInfo = `
    <p>Start time: <strong>${attemptStartTime.toLocaleTimeString()}</strong></p>
    <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
    <p>Time taken (this attempt): <strong>${min}m ${sec}s</strong></p>
  `;

  if (firstAttemptMs !== null) {
    timeInfo += `<p>First attempt time: <strong>${formatMs(firstAttemptMs)}</strong></p>`;
  }

  let html = `
    <h3>Results for ${studentName}</h3>
    <p>Score: <strong>${correctCount} / ${TOTAL_QUESTIONS}</strong></p>
    ${timeInfo}
    <p>You can click any question number on the left to go back, change your answers, and use <strong>Check Answer</strong> to practise again.</p>

    <table class="review-table">
      <tr>
        <th>#</th>
        <th>Part</th>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct</th>
        <th>Result</th>
      </tr>
  `;

  questions.forEach((q, i) => {
    const partLbl = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);

    html += `
      <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
        <td>${i + 1}</td>
        <td>${partLbl}</td>
        <td>${q.text}</td>
        <td>${q.userValue || "—"}</td>
        <td>${q.displayHtml || q.display}</td>
        <td>${q.isCorrect ? "Correct" : "Incorrect"}</td>
      </tr>
    `;
  });

  html += `</table>`;

  quizContent.innerHTML = html;

  // 显示保存按钮
  saveButton.style.display = "inline-block";

  // ★ 提交后：重新计时，为下一轮计时
  elapsedMs = 0;
  isPaused = false;
  quizStartTime = new Date();
  pauseButton.textContent = "Pause";
  startTimerInterval();
  updateTimerDisplay();
}

/* ----------------------------------------------------------
   Check 当前题（重做模式）
---------------------------------------------------------- */

function checkCurrentQuestion() {
  if (!quizSubmitted) return;

  saveCurrentInput();
  const q = questions[currentQuestionIndex];
  const statusLine = document.getElementById("statusLine");

  if (!statusLine) return;

  if ((q.userValue || "").trim() === "") {
    statusLine.innerHTML = 'Status: <span class="status-bad">No answer</span>';
    return;
  }

  const val = parseAnswer(q.userValue || "");
  if (!Number.isFinite(val)) {
    statusLine.innerHTML = 'Status: <span class="status-bad">Invalid input</span>';
    return;
  }

  if (nearlyEqual(val, q.value)) {
    q.isCorrect = true;
    statusLine.innerHTML = 'Status: <span class="status-ok">Correct</span>';
  } else {
    q.isCorrect = false;
    statusLine.innerHTML = 'Status: <span class="status-bad">Incorrect</span>';
  }

  updateSidebarStatus();
}

/* ----------------------------------------------------------
   按钮事件
---------------------------------------------------------- */

nextButton.addEventListener("click", () => {
  saveCurrentInput();
  if (currentQuestionIndex < TOTAL_QUESTIONS - 1) {
    currentQuestionIndex++;
    renderQuestion();
  }
});

backButton.addEventListener("click", () => {
  saveCurrentInput();
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    renderQuestion();
  }
});

submitButton.addEventListener("click", () => {
  calculateAndShowResults();
});

checkButton.addEventListener("click", checkCurrentQuestion);

saveButton.addEventListener("click", saveCurrentResultAsTxt);

// Pause / Resume
pauseButton.addEventListener("click", () => {
  if (!quizStartTime && elapsedMs === 0 && !quizSubmitted) return;

  if (isPaused) {
    resumeTimer();
    pauseButton.textContent = "Pause";
  } else {
    pauseTimer();
    pauseButton.textContent = "Resume";
  }
});

// Generate a new random set
generateBtn.addEventListener("click", () => {
  if (!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;

  if (timerInterval) clearInterval(timerInterval);
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;
  quizStartTime = new Date();
  quizEndTime = null;
  updateTimerDisplay();
  startTimerInterval();
  pauseButton.style.display = "inline-block";
  pauseButton.textContent = "Pause";

  generateQuiz();
  currentQuestionIndex = 0;

  renderSidebar();
  renderQuestion();

  saveButton.style.display = "none";
});

/* ----------------------------------------------------------
   Start screen / Auto start with ?name=
---------------------------------------------------------- */

function showStartScreen() {
  sidebarEl.style.display = "none";
  saveButton.style.display = "none";
  pauseButton.style.display = "none";
  generateBtn.style.display = "none";
  exportPdfButton.style.display = "none";

  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;
  quizStartTime = null;
  quizEndTime = null;
  updateTimerDisplay();

  quizContent.innerHTML = `
    <p>This quiz contains <strong>${TOTAL_QUESTIONS}</strong> questions (A/B/C parts).</p>
    <p>Please enter your name to begin:</p>

    <input id="nameInput"
           type="text"
           style="padding:10px; width:250px; font-size:1.05em;"
           placeholder="Your name">

    <button id="startButton"
            style="margin-left:10px; background:#4caf50; padding:10px 20px; color:white; border:none; border-radius:6px;">
      Start Quiz
    </button>
  `;

  document.getElementById("startButton").addEventListener("click", startQuizFromInput);
}

function startQuizCommon() {
  // 显示学生名
  updateStudentDisplay();

  quizStartTime = new Date();
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;
  updateTimerDisplay();
  startTimerInterval();

  generateQuiz();
  currentQuestionIndex = 0;

  renderSidebar();
  renderQuestion();

  generateBtn.style.display = "inline-block";
  pauseButton.style.display = "inline-block";
  exportPdfButton.style.display = "inline-block";
  pauseButton.textContent = "Pause";
  saveButton.style.display = "none";
}

function startQuizFromInput() {
  const nameInput = document.getElementById("nameInput");
  studentName = (nameInput.value || "Student").trim();
  startQuizCommon();
}

function startQuizFromUrlName(name) {
  studentName = name;
  startQuizCommon();
}

/* ----------------------------------------------------------
   Export to PDF (custom amount + per-page)
---------------------------------------------------------- */

function clampPdfSelects() {
  const total = Number(pdfTotalSelect.value || 10);
  // rebuild per-page options based on total
  const allowed = [5,10,15,20].filter(v => v <= total);
  const current = Number(pdfPerPageSelect.value || 10);

  pdfPerPageSelect.innerHTML = allowed.map(v => `<option value="${v}">${v}</option>`).join("");
  pdfPerPageSelect.value = allowed.includes(current) ? String(current) : String(allowed[0] || total);
}

function openPdfModal() {
  // default selection: total = 20 (or max), per page = 10
  pdfTotalSelect.value = "20";
  clampPdfSelects();
  if (![5,10,15,20].includes(Number(pdfPerPageSelect.value))) {
    pdfPerPageSelect.value = "10";
  }
  pdfModal.style.display = "flex";
}

function closePdfModal() {
  pdfModal.style.display = "none";
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#39;"
  }[m]));
}

function buildPdfQuestionSet(total) {
  const out = [];
  for (let i = 0; i < total; i++) {
    const partIndex = i % NUM_PARTS;
    let baseQ;
    if (partIndex === 0) baseQ = generateDecimalQuestion();
    else if (partIndex === 1) baseQ = generateFractionQuestion();
    else baseQ = generateMixedQuestion();

    const ansHtml = baseQ.displayHtml
      ? baseQ.displayHtml
      : escapeHtml(baseQ.display ?? String(baseQ.value));

    out.push({
      number: i + 1,
      partIndex,
      textHtml: baseQ.text,
      answerHtml: ansHtml
    });
  }
  return out;
}

function renderPdfAllPages(questionSet, total, perPage) {
  pdfRenderRoot.innerHTML = "";
  const pages = [];

  const questionPageCount = Math.ceil(total / perPage);

  // Answer key pagination (keep dense; 20 answers should fit on 1 page)
  const answersPerPage = 40;
  const answerPageCount = Math.ceil(total / answersPerPage);

  const totalPagesOverall = questionPageCount + answerPageCount;

  const safeStudent = (studentName || "Student").trim() || "Student";
  const title = "Random Mixed Calculation Quiz";

  // --- Question pages ---
  for (let p = 0; p < questionPageCount; p++) {
    const start = p * perPage;
    const end = Math.min(start + perPage, total);
    const compact = perPage >= 15;
    const cols = (perPage === 20 ? 4 : (perPage === 15 ? 3 : 2));

    const page = document.createElement("div");
    page.className = "pdf-page" + (compact ? " compact" : "");

    page.innerHTML = `
      <div class="pdf-header">
        <div class="pdf-brand">
          <div>
            <div style="font-weight:900; color:#0d47a1; letter-spacing:1px;">DYAA</div>
            <div class="pdf-title">${title}</div>
          </div>
        </div>
        <div class="pdf-meta">
          <div><strong>Student:</strong> ${safeStudent}</div>
          <div><strong>Page:</strong> ${p + 1} / ${totalPagesOverall}</div>
          <div style="margin-top:2px;"><strong>Total:</strong> ${total} questions</div>
        </div>
      </div>
      <div class="pdf-grid cols-${cols}${compact ? " compact" : ""}"></div>
    `;

    const grid = page.querySelector(".pdf-grid");

    for (let i = start; i < end; i++) {
      const q = questionSet[i];
      const card = document.createElement("div");
      card.className = "pdf-card";
      card.innerHTML = `
        <div class="pdf-qnum">Q${q.number}</div>
        <div class="pdf-qtext">${q.textHtml}</div>
        <div class="pdf-answer">Answer:<span class="pdf-answer-line"></span></div>
      `;
      grid.appendChild(card);
    }

    pdfRenderRoot.appendChild(page);
    pages.push(page);
  }

  // --- Answer key pages (always compact) ---
  for (let ap = 0; ap < answerPageCount; ap++) {
    const start = ap * answersPerPage;
    const end = Math.min(start + answersPerPage, total);

    const pageNo = questionPageCount + ap + 1;

    const page = document.createElement("div");
    page.className = "pdf-page compact pdf-answers";

    page.innerHTML = `
      <div class="pdf-header">
        <div class="pdf-brand">
          <div>
            <div style="font-weight:900; color:#0d47a1; letter-spacing:1px;">DYAA</div>
            <div class="pdf-title">Answer Key</div>
          </div>
        </div>
        <div class="pdf-meta">
          <div><strong>Student:</strong> ${safeStudent}</div>
          <div><strong>Page:</strong> ${pageNo} / ${totalPagesOverall}</div>
          <div style="margin-top:2px;"><strong>For:</strong> ${title}</div>
        </div>
      </div>

      <div class="pdf-answerkey">
        <div class="pdf-answerkey-title">Answers</div>
        <div class="pdf-ans-grid"></div>
      </div>
    `;

    const grid = page.querySelector(".pdf-ans-grid");
    for (let i = start; i < end; i++) {
      const q = questionSet[i];
      const item = document.createElement("div");
      item.className = "pdf-ans-item";
      item.innerHTML = `<span class="pdf-ans-num">Q${q.number}.</span> <span class="pdf-ans-val">${q.answerHtml}</span>`;
      grid.appendChild(item);
    }

    pdfRenderRoot.appendChild(page);
    pages.push(page);
  }

  return pages;
}

async function exportToPdf(total, perPage) {
  // Ensure libraries loaded
  if (!window.jspdf || !window.jspdf.jsPDF || !window.html2canvas) {
    alert("PDF libraries not loaded. Please refresh and try again.");
    return;
  }

  const questionSet = buildPdfQuestionSet(total);
  const pages = renderPdfAllPages(questionSet, total, perPage);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  // render each page to canvas
  for (let i = 0; i < pages.length; i++) {
    const canvas = await window.html2canvas(pages[i], {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true
    });

    const imgData = canvas.toDataURL("image/png");
    if (i > 0) pdf.addPage();
    pdf.addImage(imgData, "PNG", 0, 0, 210, 297);
  }

  const safeName = (studentName || "Student").replace(/[^a-z0-9_\-]/gi, "_") || "Student";
  const ts = formatDateForFilename(new Date());
  pdf.save(`MixedQuiz_${safeName}_${total}Q_${ts}.pdf`);
}

// Modal events
exportPdfButton.addEventListener("click", openPdfModal);
pdfCancelBtn.addEventListener("click", closePdfModal);
pdfModal.addEventListener("click", (e) => { if (e.target === pdfModal) closePdfModal(); });
pdfTotalSelect.addEventListener("change", clampPdfSelects);

pdfExportBtn.addEventListener("click", async () => {
  const total = Number(pdfTotalSelect.value || 10);
  const perPage = Number(pdfPerPageSelect.value || 5);

  pdfExportBtn.disabled = true;
  const oldText = pdfExportBtn.textContent;
  pdfExportBtn.textContent = "Exporting...";

  try {
    closePdfModal();
    await exportToPdf(total, perPage);
  } finally {
    pdfExportBtn.disabled = false;
    pdfExportBtn.textContent = oldText;
  }
});

/* ----------------------------------------------------------
   初始化
---------------------------------------------------------- */

(function init() {
  const urlName = getNameFromUrl();
  if (urlName) {
    // 带 ?name=xxx：直接开始
    startQuizFromUrlName(urlName);
  } else {
    showStartScreen();
  }
})();
</script>
</body>
</html>
