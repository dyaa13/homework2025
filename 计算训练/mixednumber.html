<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Random Mixed Calculation Quiz</title>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .quiz-container {
      max-width: 900px;
      margin: 40px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    #headerLogo {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background-color: #0d47a1;
      border-radius: 4px;
    }

    .logo-text span.edu {
      font-size: 0.9em;
      color: #ff9800;
      font-weight: 700;
      margin-left: 10px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }

    #timerDisplay {
      font-size: 0.95em;
      color: #333;
    }

    #studentDisplay {
      font-size: 0.95em;
      color: #333;
      font-weight: 600;
    }

    .quiz-main {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 140px;
      border-right: 1px solid #ddd;
      padding-right: 10px;
      display: none;
    }

    .sidebar h4 {
      margin: 0 0 8px;
      font-size: 0.95em;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .sidebar li.active {
      outline: 2px solid #1976d2;
      font-weight: 600;
    }

    .sidebar li.answered {
      border-left: 4px solid #4caf50;
    }

    .sidebar li.correct {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }

    .sidebar li.incorrect {
      background: #f8d7da;
      border-left: 4px solid #f44336;
    }

    #quizContent {
      flex: 1;
    }

    .question-text {
      font-size: 1.1em;
      margin-bottom: 8px;
    }

    .instructions {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 12px;
    }

    .part-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .single-question {
      margin-top: 6px;
      margin-bottom: 6px;
    }

    .answer-box {
      width: 140px;
      padding: 6px;
      font-size: 1em;
      margin-left: 8px;
    }

    .button-container {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
    }

    #nextButton { background:#4caf50; }
    #backButton { background:#039be5; }
    #generateButton { background:#ff9800; }
    #submitButton { background:#9c27b0; }
    #saveButton { background:#607d8b; }
    #pauseButton { background:#f57c00; }

    table.review-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .review-table th,
    .review-table td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 0.85em;
      text-align: center;
    }

    .review-table th {
      background: #f2f2f2;
    }

    .correct-answer { background: #d4edda; }
    .incorrect-answer { background: #f8d7da; }

    /* 分数上下显示 */
    .frac {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
    }

    .frac .top {
      display: block;
      border-bottom: 1px solid #000;
      padding: 0 2px;
    }

    .frac .bottom {
      display: block;
      padding: 0 2px;
      font-size: 0.9em;
    }

    @media (max-width: 700px) {
      .quiz-main { flex-direction: column; }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
        padding-bottom: 10px;
      }
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text"><span class="edu">EDUCATION</span></div>
  </div>

  <div class="top-bar">
    <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentDisplay" style="display:none;">Student: Student</div>
    </div>
    <div>
      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="generateButton" style="display:none;">Generate New Set</button>
    </div>
  </div>

  <h2>Random Mixed Calculation Quiz</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <div class="button-container">
    <button id="backButton" style="display:none;">Previous</button>
    <button id="submitButton" style="display:none;">Submit &amp; View Results</button>
    <button id="nextButton" style="display:none;">Next</button>
    <button id="saveButton" style="display:none;">Save Current Result</button>
  </div>
</div>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */

const PART_TITLES = [
  "A. Mixed Decimals / Integers / Negatives",
  "B. Fractions × ÷ (with some negatives)",
  "C. Mixed Decimals / Fractions / Percentages"
];

const NUM_PARTS = 3;
const QUESTIONS_PER_PART = 6;
const TOTAL_QUESTIONS = NUM_PARTS * QUESTIONS_PER_PART;

/* ----------------------------------------------------------
   工具函数
---------------------------------------------------------- */

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function choice(arr) {
  return arr[randInt(0, arr.length - 1)];
}

function gcd(a, b) {
  a = Math.abs(a);
  b = Math.abs(b);
  while (b !== 0) {
    let t = b;
    b = a % b;
    a = t;
  }
  return a === 0 ? 1 : a;
}

function simplifyFraction(fr) {
  if (fr.d < 0) {
    fr.n = -fr.n;
    fr.d = -fr.d;
  }
  const g = gcd(fr.n, fr.d);
  fr.n /= g;
  fr.d /= g;
  return fr;
}

function fractionToValue(fr) {
  return fr.n / fr.d;
}

function fractionToString(fr) {
  fr = simplifyFraction({ n: fr.n, d: fr.d });
  if (fr.d === 1) return String(fr.n);
  return `${fr.n}/${fr.d}`;
}

// 分数转 HTML 上下形式
function fractionToHtml(fr) {
  fr = simplifyFraction({ n: fr.n, d: fr.d });
  if (fr.d === 1) return String(fr.n);
  return `<span class="frac"><span class="top">${fr.n}</span><span class="bottom">${fr.d}</span></span>`;
}

// 把整数 + 小数位数转成字符串，并去掉多余 0
function formatNumberFromInt(xInt, shift) {
  const isNegative = xInt < 0;
  const absInt = Math.abs(xInt);
  const base = absInt / Math.pow(10, shift);
  let s = base.toFixed(shift);
  s = s.replace(/\.0+$/,"").replace(/(\.\d*?[1-9])0+$/,"$1");
  if (isNegative) s = "-" + s;
  return s;
}

// 毫秒 -> mm:ss
function formatMs(ms) {
  const totalSec = Math.floor(ms / 1000);
  const min = Math.floor(totalSec / 60);
  const sec = totalSec % 60;
  return `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

/* ----------------------------------------------------------
   解析答案
---------------------------------------------------------- */

function parseAnswer(str) {
  let s = str.trim();
  if (s === "") return NaN;

  let sign = 1;
  if (s[0] === "+") {
    s = s.slice(1).trim();
  } else if (s[0] === "-") {
    sign = -1;
    s = s.slice(1).trim();
  }
  if (s === "") return NaN;

  const spaceParts = s.split(/\s+/);
  if (spaceParts.length === 2 && spaceParts[1].includes("/")) {
    const whole = Number(spaceParts[0]);
    const fracParts = spaceParts[1].split("/");
    if (fracParts.length !== 2) return NaN;

    const num = Number(fracParts[0]);
    const den = Number(fracParts[1]);

    if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;

    const absWhole = Math.abs(whole);
    const fracVal = num / den;
    let value = absWhole + fracVal;

    if (whole < 0) value = -value;

    return sign * value;
  }

  if (s.includes("/")) {
    const parts = s.split("/");
    if (parts.length !== 2) return NaN;

    const num = Number(parts[0]);
    const den = Number(parts[1]);

    if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;

    return sign * (num / den);
  }

  const n = Number(s);
  return Number.isFinite(n) ? sign * n : NaN;
}

function nearlyEqual(a, b, eps = 1e-6) {
  if (!Number.isFinite(a) || !Number.isFinite(b)) return false;
  return Math.abs(a - b) < eps;
}

/* ----------------------------------------------------------
   题目生成
---------------------------------------------------------- */

function generateDecimalQuestion() {
  const opType = choice(["mul", "div"]);
  const signCase = choice(["pos", "negA", "negB"]);

  let text = "";
  let value = 0;

  if (opType === "mul") {
    // 两位数 × 一位数（都不是 1）
    let aInt = randInt(10, 99);
    let bInt = randInt(2, 9);  // 避免 1

    let shiftA = randInt(0, 2);
    let shiftB = randInt(0, 2);

    // 避免太简单（整数×整数）
    if (shiftA === 0 && shiftB === 0 && Math.random() < 0.5) {
      if (Math.random() < 0.5) shiftA = choice([1,2]);
      else shiftB = choice([1,2]);
    }

    if (signCase === "negA") aInt = -aInt;
    if (signCase === "negB") bInt = -bInt;

    const aVal = aInt / Math.pow(10, shiftA);
    const bVal = bInt / Math.pow(10, shiftB);

    value = aVal * bVal;

    const aStr = formatNumberFromInt(aInt, shiftA);
    const bStr = formatNumberFromInt(bInt, shiftB);

    text = `${aStr} × ${bStr}`;

  } else {
    // 两位数 ÷ 一位数，再加小数点
    let dividendInt, divisorInt, quotientInt;
    while (true) {
      divisorInt = randInt(2, 9);      // 避免 1
      quotientInt = randInt(2, 12);
      dividendInt = divisorInt * quotientInt;
      if (dividendInt >= 10 && dividendInt <= 99) break;
    }

    let shiftDividend = randInt(0, 2);
    let shiftDivisor  = randInt(0, 2);

    // 有机会生成 0.02 / 0.05 一类
    if (Math.random() < 0.3 && (divisorInt === 2 || divisorInt === 5)) {
      shiftDivisor = 2;
      shiftDividend = randInt(0, 2);
    }

    if (shiftDividend === 0 && shiftDivisor === 0 && Math.random() < 0.5) {
      if (Math.random() < 0.5) shiftDividend = choice([1,2]);
      else shiftDivisor = choice([1,2]);
    }

    if (signCase === "negA") dividendInt = -dividendInt;
    if (signCase === "negB") divisorInt  = -divisorInt;

    const dividendVal = dividendInt / Math.pow(10, shiftDividend);
    const divisorVal  = divisorInt  / Math.pow(10, shiftDivisor);

    value = dividendVal / divisorVal;

    const dividendStr = formatNumberFromInt(dividendInt, shiftDividend);
    const divisorStr  = formatNumberFromInt(divisorInt,  shiftDivisor);

    text = `${dividendStr} ÷ ${divisorStr}`;
  }

  return {
    text,
    value,
    display: String(Number(value.toFixed(6)))
  };
}

function randomFraction() {
  const dens = [2,3,4,5,6,8,10,12];
  while (true) {
    const d = choice(dens);
    let n = randInt(1, d * 2);
    if (Math.random() < 0.3) n = -n;

    let fr = simplifyFraction({ n, d });
    if (Math.abs(fr.n) === fr.d) continue; // 排除 ±1
    return fr;
  }
}

function generateFractionQuestion() {
  const opType = choice(["mul", "div"]);

  let f1 = randomFraction();
  let f2 = randomFraction();
  if (f2.n === 0) f2.n = 1;

  let result;

  if (opType === "mul") {
    result = simplifyFraction({
      n: f1.n * f2.n,
      d: f1.d * f2.d
    });
  } else {
    result = simplifyFraction({
      n: f1.n * f2.d,
      d: f1.d * f2.n
    });
  }

  if (Math.abs(result.n) > 50 || Math.abs(result.d) > 50) {
    return generateFractionQuestion();
  }

  const opSymbol = opType === "mul" ? "×" : "÷";
  const f1Html = fractionToHtml(f1);
  const f2Html = fractionToHtml(f2);

  return {
    text: `${f1Html} ${opSymbol} ${f2Html}`,
    value: fractionToValue(result),
    display: fractionToString(result),
    displayHtml: fractionToHtml(result)
  };
}

function generateMixedQuestion() {
  const pattern = choice([1,2,3,4,5]);

  let text = "";
  let value = 0;

  if (pattern === 1) {
    const percents = [10,20,25,30,40,50,60,75];
    let p = choice(percents);
    let b = choice([0.6,0.8,1.2,1.5,1.8,-0.8,-1.2]);
    value = b * (p / 100);
    text = `${p}% of ${b}`;

  } else if (pattern === 2) {
    const d = choice([2,3,4,5,6,8,10]);
    const n = randInt(1, d - 1);
    const f = simplifyFraction({ n, d });
    const fHtml = fractionToHtml(f);

    let dec = choice([0.6,0.8,1.2,1.5,2.4]);
    if (Math.random() < 0.3) dec = -dec;

    value = dec * (f.n / f.d);
    text = `${fHtml} of ${dec}`;

  } else if (pattern === 3) {
    const d = choice([2,3,4,5,6,8,10]);
    const n = randInt(1, d - 1);
    const f = simplifyFraction({ n, d });
    const fHtml = fractionToHtml(f);

    let dec = choice([0.4,0.5,0.6,0.75,0.8,1.2]);
    if (Math.random() < 0.4) dec = -dec;

    value = dec * (f.n / f.d);
    text = `${dec} × ${fHtml}`;

  } else if (pattern === 4) {
    let dec = choice([0.36,0.48,0.72,1.2]);
    const p = choice([20,25,40,60]);
    if (Math.random() < 0.4) dec = -dec;

    value = dec / (p / 100);
    text = `${dec} ÷ ${p}%`;

  } else {
    const d = choice([2,3,4,5,6,8]);
    const whole = randInt(1, 3);
    const n = randInt(1, d - 1);
    const f = simplifyFraction({ n, d });

    const improper = simplifyFraction({
      n: whole * f.d + f.n,
      d: f.d
    });
    const improperHtml = fractionToHtml(improper);

    let dec = -choice([0.6,0.8,1.2,1.5]);
    value = dec * (improper.n / improper.d);

    text = `${dec} × ${improperHtml}`;
  }

  value = Number(value.toFixed(6));

  return {
    text,
    value,
    display: String(value)
  };
}

/* ----------------------------------------------------------
   QueryString 读取 name 参数
---------------------------------------------------------- */

function getNameFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get("name");
  if (!raw) return null;
  const name = raw.trim();
  return name ? name : null;
}

function updateStudentDisplay() {
  const el = document.getElementById("studentDisplay");
  el.style.display = "inline-block";
  el.textContent = `Student: ${studentName}`;
}

/* ----------------------------------------------------------
   全局状态（含计时器）
---------------------------------------------------------- */

let questions = [];
let currentQuestionIndex = 0;
let studentName = "Student";
let quizStartTime = null;
let quizEndTime = null;
let quizSubmitted = false;

let timerInterval = null;
let elapsedMs = 0;          // 当前这一轮已累计毫秒
let isPaused = false;
let firstAttemptMs = null;  // 首次提交的用时（锁定）

const quizContent   = document.getElementById("quizContent");
const sidebarEl     = document.getElementById("sidebar");
const backButton    = document.getElementById("backButton");
const nextButton    = document.getElementById("nextButton");
const submitButton  = document.getElementById("submitButton");
const saveButton    = document.getElementById("saveButton");
const generateBtn   = document.getElementById("generateButton");
const pauseButton   = document.getElementById("pauseButton");
const timerDisplay  = document.getElementById("timerDisplay");

/* ----------------------------------------------------------
   计时器相关
---------------------------------------------------------- */

function updateTimerDisplay() {
  let totalMs = elapsedMs;
  if (!isPaused && quizStartTime) {
    totalMs += (new Date() - quizStartTime);
  }
  let text = `Time: ${formatMs(totalMs)}`;
  if (firstAttemptMs !== null) {
    text += ` (First: ${formatMs(firstAttemptMs)})`;
  }
  timerDisplay.textContent = text;
}

function startTimerInterval() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay, 1000);
}

function pauseTimer() {
  if (isPaused || !quizStartTime) return;
  const now = new Date();
  elapsedMs += now - quizStartTime;
  isPaused = true;
  quizStartTime = null;
  updateTimerDisplay();
}

function resumeTimer() {
  if (!isPaused) return;
  isPaused = false;
  quizStartTime = new Date();
  updateTimerDisplay();
}

/* ----------------------------------------------------------
   生成整套题
---------------------------------------------------------- */

function generateQuiz() {
  questions = [];
  quizSubmitted = false;

  for (let p = 0; p < NUM_PARTS; p++) {
    for (let i = 0; i < QUESTIONS_PER_PART; i++) {

      let baseQ;
      if (p === 0) baseQ = generateDecimalQuestion();
      else if (p === 1) baseQ = generateFractionQuestion();
      else baseQ = generateMixedQuestion();

      questions.push({
        partIndex: p,
        indexInPart: i,
        text: baseQ.text,
        value: baseQ.value,
        display: baseQ.display,
        displayHtml: baseQ.displayHtml || null,
        userValue: "",
        isCorrect: false
      });
    }
  }
}

/* ----------------------------------------------------------
   Sidebar
---------------------------------------------------------- */

function renderSidebar() {
  sidebarEl.style.display = "block";
  sidebarEl.innerHTML = `
    <h4>Questions</h4>
    <ul id="qList"></ul>
  `;

  const ul = document.getElementById("qList");
  for (let i = 0; i < TOTAL_QUESTIONS; i++) {
    const q = questions[i];
    const li = document.createElement("li");
    const label = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);

    li.textContent = `Q${i + 1} (${label})`;
    li.dataset.index = i;

    li.addEventListener("click", () => {
      saveCurrentInput();
      currentQuestionIndex = i;
      renderQuestion();
    });

    ul.appendChild(li);
  }

  updateSidebarStatus();
}

function updateSidebarStatus() {
  const items = document.querySelectorAll("#qList li");

  items.forEach(li => {
    const idx = Number(li.dataset.index);
    const q = questions[idx];

    li.classList.remove("active", "answered", "correct", "incorrect");

    if (!quizSubmitted) {
      li.classList.toggle("active", idx === currentQuestionIndex);
      if ((q.userValue || "").trim() !== "") {
        li.classList.add("answered");
      }
    } else {
      if ((q.userValue || "").trim() !== "") {
        if (q.isCorrect) li.classList.add("correct");
        else li.classList.add("incorrect");
      }
    }
  });
}

/* ----------------------------------------------------------
   显示单题
---------------------------------------------------------- */

function renderQuestion() {
  const q = questions[currentQuestionIndex];
  const partLabel = ["A","B","C"][q.partIndex];
  const fullLabel = `${partLabel}${q.indexInPart + 1}`;

  quizContent.innerHTML = `
    <p class="question-text">
      Question ${currentQuestionIndex + 1} of ${TOTAL_QUESTIONS}
    </p>

    <p class="instructions">
      Enter your answer using integers, decimals, or fractions (e.g., 3/4 or -2 1/3).
      Answers will always be shown as improper fractions when applicable.
    </p>

    <div class="part-title">${PART_TITLES[q.partIndex]}</div>

    <div class="single-question">
      ${fullLabel}. ${q.text}
      <input id="answerInput" class="answer-box" type="text" value="${q.userValue || ""}">
    </div>
  `;

  backButton.style.display = "inline-block";
  nextButton.style.display = "inline-block";
  submitButton.style.display = "inline-block";

  backButton.style.visibility = currentQuestionIndex === 0 ? "hidden" : "visible";
  nextButton.textContent = "Next";

  updateSidebarStatus();
}

function saveCurrentInput() {
  const input = document.getElementById("answerInput");
  if (input) {
    questions[currentQuestionIndex].userValue = input.value.trim();
  }
}

/* ----------------------------------------------------------
   保存当前结果为 txt
---------------------------------------------------------- */

function formatDateForFilename(date) {
  if (!date) return "no_time";
  const pad = n => String(n).padStart(2, "0");
  return (
    date.getFullYear() +
    pad(date.getMonth() + 1) +
    pad(date.getDate()) + "_" +
    pad(date.getHours()) +
    pad(date.getMinutes()) +
    pad(date.getSeconds())
  );
}

function saveCurrentResultAsTxt() {
  saveCurrentInput();

  if (!quizSubmitted) {
    questions.forEach(q => {
      const val = parseAnswer(q.userValue || "");
      q.isCorrect = nearlyEqual(val, q.value);
    });
  }

  let correctCount = 0;
  questions.forEach(q => { if (q.isCorrect) correctCount++; });

  let lines = [];
  lines.push("Random Mixed Calculation Quiz - Current Result");
  lines.push("Student: " + studentName);
  if (quizStartTime) lines.push("Start time: " + quizStartTime.toLocaleString());
  if (quizEndTime) lines.push("Last submit time: " + quizEndTime.toLocaleString());
  lines.push("Score: " + correctCount + " / " + TOTAL_QUESTIONS);
  if (firstAttemptMs !== null) lines.push("First attempt time: " + formatMs(firstAttemptMs));
  lines.push("");
  lines.push("Details:");
  lines.push("----------");

  questions.forEach((q, i) => {
    const partLbl = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);
    const userAns = (q.userValue || "").trim() === "" ? "Not answered" : q.userValue;
    const resultText = (q.userValue || "").trim() === ""
      ? "Not answered"
      : (q.isCorrect ? "Correct" : "Incorrect");

    const plainQuestion = q.text.replace(/<[^>]+>/g,"");

    lines.push(
      `Q${i + 1} (${partLbl})` +
      "\nQuestion: " + plainQuestion +
      "\nYour answer: " + userAns +
      "\nCorrect answer: " + q.display +
      "\nResult: " + resultText
    );
    lines.push("");
  });

  const content = lines.join("\n");
  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = studentName.replace(/[^a-z0-9_\-]/gi, "_") || "Student";
  const ts = formatDateForFilename(new Date());
  a.href = url;
  a.download = `MixedQuiz_${safeName}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ----------------------------------------------------------
   结果页面 & 提交逻辑
---------------------------------------------------------- */

function calculateAndShowResults() {
  saveCurrentInput();

  const now = new Date();

  // 当前这一轮用时
  let attemptMs = elapsedMs;
  if (!isPaused && quizStartTime) {
    attemptMs += now - quizStartTime;
  }

  // 记录首次用时
  if (firstAttemptMs === null) {
    firstAttemptMs = attemptMs;
  }

  // 展示的开始/结束
  const attemptStartTime = quizStartTime || now;
  quizEndTime = now;

  quizSubmitted = true;

  // 判分
  let correctCount = 0;
  questions.forEach(q => {
    const val = parseAnswer(q.userValue || "");
    q.isCorrect = nearlyEqual(val, q.value);
    if (q.isCorrect) correctCount++;
  });

  updateSidebarStatus();

  const diffSec = Math.floor(attemptMs / 1000);
  const min = Math.floor(diffSec / 60);
  const sec = diffSec % 60;

  let timeInfo = `
    <p>Start time: <strong>${attemptStartTime.toLocaleTimeString()}</strong></p>
    <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
    <p>Time taken (this attempt): <strong>${min}m ${sec}s</strong></p>
  `;

  if (firstAttemptMs !== null) {
    timeInfo += `<p>First attempt time: <strong>${formatMs(firstAttemptMs)}</strong></p>`;
  }

  let html = `
    <h3>Results for ${studentName}</h3>
    <p>Score: <strong>${correctCount} / ${TOTAL_QUESTIONS}</strong></p>
    ${timeInfo}
    <p>You can click any question number on the left to go back, change your answers, and submit again.</p>

    <table class="review-table">
      <tr>
        <th>#</th>
        <th>Part</th>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct</th>
        <th>Result</th>
      </tr>
  `;

  questions.forEach((q, i) => {
    const partLbl = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);

    html += `
      <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
        <td>${i + 1}</td>
        <td>${partLbl}</td>
        <td>${q.text}</td>
        <td>${q.userValue || "—"}</td>
        <td>${q.displayHtml || q.display}</td>
        <td>${q.isCorrect ? "Correct" : "Incorrect"}</td>
      </tr>
    `;
  });

  html += `</table>`;

  quizContent.innerHTML = html;

  backButton.style.display = "inline-block";
  nextButton.style.display = "inline-block";
  submitButton.style.display = "inline-block";
  saveButton.style.display = "inline-block";

  // ★ 提交后：重新计时，为下一轮计时
  elapsedMs = 0;
  isPaused = false;
  quizStartTime = new Date();
  pauseButton.textContent = "Pause";
  startTimerInterval();
  updateTimerDisplay();
}

/* ----------------------------------------------------------
   按钮事件
---------------------------------------------------------- */

nextButton.addEventListener("click", () => {
  saveCurrentInput();
  if (currentQuestionIndex < TOTAL_QUESTIONS - 1) {
    currentQuestionIndex++;
    renderQuestion();
  }
});

backButton.addEventListener("click", () => {
  saveCurrentInput();
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    renderQuestion();
  }
});

submitButton.addEventListener("click", () => {
  calculateAndShowResults();
});

saveButton.addEventListener("click", saveCurrentResultAsTxt);

// Pause / Resume
pauseButton.addEventListener("click", () => {
  if (!quizStartTime && elapsedMs === 0 && !quizSubmitted) return;

  if (isPaused) {
    resumeTimer();
    pauseButton.textContent = "Pause";
  } else {
    pauseTimer();
    pauseButton.textContent = "Resume";
  }
});

// Generate a new random set
generateBtn.addEventListener("click", () => {
  if (!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;

  if (timerInterval) clearInterval(timerInterval);
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;
  quizStartTime = new Date();
  quizEndTime = null;
  updateTimerDisplay();
  startTimerInterval();
  pauseButton.style.display = "inline-block";
  pauseButton.textContent = "Pause";

  generateQuiz();
  currentQuestionIndex = 0;

  renderSidebar();
  renderQuestion();

  backButton.style.display = "inline-block";
  nextButton.style.display = "inline-block";
  submitButton.style.display = "inline-block";
  saveButton.style.display = "none";
});

/* ----------------------------------------------------------
   Start screen / Auto start with ?name=
---------------------------------------------------------- */

function showStartScreen() {
  sidebarEl.style.display = "none";
  backButton.style.display = "none";
  nextButton.style.display = "none";
  submitButton.style.display = "none";
  generateBtn.style.display = "none";
  saveButton.style.display = "none";
  pauseButton.style.display = "none";

  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;
  quizStartTime = null;
  quizEndTime = null;
  updateTimerDisplay();

  quizContent.innerHTML = `
    <p>This quiz contains <strong>${TOTAL_QUESTIONS}</strong> questions (A/B/C parts).</p>
    <p>Please enter your name to begin:</p>

    <input id="nameInput"
           type="text"
           style="padding:10px; width:250px; font-size:1.05em;"
           placeholder="Your name">

    <button id="startButton"
            style="margin-left:10px; background:#4caf50; padding:10px 20px; color:white; border:none; border-radius:6px;">
      Start Quiz
    </button>
  `;

  document.getElementById("startButton").addEventListener("click", startQuizFromInput);
}

function startQuizCommon() {
  // 显示学生名
  updateStudentDisplay();

  quizStartTime = new Date();
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;
  updateTimerDisplay();
  startTimerInterval();

  generateQuiz();
  currentQuestionIndex = 0;

  renderSidebar();
  renderQuestion();

  backButton.style.display = "inline-block";
  nextButton.style.display = "inline-block";
  submitButton.style.display = "inline-block";
  generateBtn.style.display = "inline-block";
  saveButton.style.display = "none";
  pauseButton.style.display = "inline-block";
  pauseButton.textContent = "Pause";
}

function startQuizFromInput() {
  const nameInput = document.getElementById("nameInput");
  studentName = (nameInput.value || "Student").trim();
  startQuizCommon();
}

function startQuizFromUrlName(name) {
  studentName = name;
  startQuizCommon();
}

/* ----------------------------------------------------------
   初始化
---------------------------------------------------------- */

(function init() {
  const urlName = getNameFromUrl();
  if (urlName) {
    // ✅ 带 ?name=xxx：直接开始，不显示输入页
    startQuizFromUrlName(urlName);
  } else {
    // ✅ 不带 name：保持原逻辑
    showStartScreen();
  }
})();
</script>
</body>
</html>
