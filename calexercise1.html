<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Mixed Calculation Quiz</title>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .quiz-container {
            max-width: 900px;
            margin: 40px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        #headerLogo {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: #0d47a1;
            border-radius: 4px;
        }

        .logo-text span.edu {
            font-size: 0.9em;
            color: #ff9800;
            font-weight: 700;
            margin-left: 10px;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .quiz-main {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 140px;
            border-right: 1px solid #ddd;
            padding-right: 10px;
            display: none;
        }

        .sidebar h4 {
            margin: 0 0 8px;
            font-size: 0.95em;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar li {
            padding: 6px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .sidebar li.active {
            background: #bbdefb;
            font-weight: 600;
        }

        .sidebar li.answered {
            border-left: 4px solid #4caf50;
        }

        #quizContent {
            flex: 1;
        }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .instructions {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 12px;
        }

        .part-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .single-question {
            margin-top: 6px;
            margin-bottom: 6px;
        }

        .answer-box {
            width: 140px;
            padding: 6px;
            font-size: 1em;
            margin-left: 8px;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
        }

        #nextButton { background:#4caf50; }
        #backButton { background:#039be5; }
        #generateButton { background:#ff9800; }

        table.review-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .review-table th,
        .review-table td {
            border: 1px solid #ccc;
            padding: 6px;
            font-size: 0.85em;
            text-align: center;
        }

        .review-table th {
            background: #f2f2f2;
        }

        .correct-answer {
            background: #d4edda;
        }

        .incorrect-answer {
            background: #f8d7da;
        }

        @media (max-width: 700px) {
            .quiz-main {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #ddd;
                margin-bottom: 10px;
                padding-bottom: 10px;
            }
        }
    </style>
</head>

<body>
<div class="quiz-container">
    <div id="headerLogo">
        <div class="logo-icon"></div>
        <div class="logo-text"><span class="edu">EDUCATION</span></div>
    </div>

    <div class="top-bar">
        <button id="generateButton" style="display:none;">Generate New Set</button>
    </div>

    <h2>Random Mixed Calculation Quiz</h2>

    <div class="quiz-main">
        <div id="sidebar" class="sidebar"></div>
        <div id="quizContent"></div>
    </div>

    <div class="button-container">
        <button id="backButton" style="display:none;">Previous</button>
        <button id="nextButton" style="display:none;">Next</button>
    </div>
</div>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */

const PART_TITLES = [
    "A. Mixed Decimals / Integers / Negatives",
    "B. Fractions × ÷ (with some negatives)",
    "C. Mixed Decimals / Fractions / Percentages"
];

const NUM_PARTS = 3;
const QUESTIONS_PER_PART = 6;
const TOTAL_QUESTIONS = NUM_PARTS * QUESTIONS_PER_PART;

/* ----------------------------------------------------------
   工具函数
---------------------------------------------------------- */

function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function choice(arr) {
    return arr[randInt(0, arr.length - 1)];
}

function gcd(a, b) {
    a = Math.abs(a);
    b = Math.abs(b);
    while (b !== 0) {
        let t = b;
        b = a % b;
        a = t;
    }
    return a === 0 ? 1 : a;
}

function simplifyFraction(fr) {
    if (fr.d < 0) {
        fr.n = -fr.n;
        fr.d = -fr.d;
    }
    const g = gcd(fr.n, fr.d);
    fr.n /= g;
    fr.d /= g;
    return fr;
}

function fractionToValue(fr) {
    return fr.n / fr.d;
}

// 统一输出「假分数形式」或整数，不再显示带分数
function fractionToString(fr) {
    fr = simplifyFraction({ n: fr.n, d: fr.d });

    // 如果是整数
    if (fr.d === 1) return String(fr.n);

    // 假分数或真分数都用 n/d 形式
    return `${fr.n}/${fr.d}`;
}

/* ----------------------------------------------------------
   解析答案：支持整数 / 小数 / 分数 / 带分数输入
---------------------------------------------------------- */

function parseAnswer(str) {
    let s = str.trim();
    if (s === "") return NaN;

    let sign = 1;
    if (s[0] === "+") {
        s = s.slice(1).trim();
    } else if (s[0] === "-") {
        sign = -1;
        s = s.slice(1).trim();
    }
    if (s === "") return NaN;

    // 处理带分数 a b/c （学生输入）
    const spaceParts = s.split(/\s+/);
    if (spaceParts.length === 2 && spaceParts[1].includes("/")) {
        const whole = Number(spaceParts[0]);
        const fracParts = spaceParts[1].split("/");
        if (fracParts.length !== 2) return NaN;

        const num = Number(fracParts[0]);
        const den = Number(fracParts[1]);

        if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;

        const absWhole = Math.abs(whole);
        const fracVal = num / den;
        let value = absWhole + fracVal;

        if (whole < 0) value = -value;

        return sign * value;
    }

    // 普通分数 a/b
    if (s.includes("/")) {
        const parts = s.split("/");
        if (parts.length !== 2) return NaN;

        const num = Number(parts[0]);
        const den = Number(parts[1]);

        if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;

        return sign * (num / den);
    }

    // 普通数字
    const n = Number(s);
    return Number.isFinite(n) ? sign * n : NaN;
}

// 浮点比较
function nearlyEqual(a, b, eps = 1e-6) {
    if (!Number.isFinite(a) || !Number.isFinite(b)) return false;
    return Math.abs(a - b) < eps;
}

/* ----------------------------------------------------------
   题目生成 A / B / C
---------------------------------------------------------- */

//
// Part A — 小数 × ÷，含负数
//
function generateDecimalQuestion() {
    const opType = choice(["mul", "div"]);
    const signCase = choice(["pos", "negA", "negB"]);

    let text = "";
    let value = 0;

    if (opType === "mul") {
        const decimals = [0.2,0.3,0.4,0.5,0.6,0.75,0.8,1.2,1.5,2.4];
        let a = choice(decimals);
        let b = randInt(2, 12);

        if (signCase === "negA") a = -a;
        if (signCase === "negB") b = -b;

        value = a * b;
        text = `${a} × ${b}`;

    } else {
        // 设计 dividend ÷ divisor = quotient（确保答案是整数/小数）
        const divisors = [0.2,0.25,0.4,0.5,0.8,1.25,1.5];
        let q = randInt(2, 12);
        if (Math.random() < 0.3) q = -q;
        let d = choice(divisors);

        let dividend = Number((q * d).toFixed(3));

        value = q;
        text = `${dividend} ÷ ${d}`;
    }

    return {
        text,
        value,
        display: String(value)
    };
}

//
// 随机分数 (假分数或真分数)
//
function randomFraction() {
    const dens = [2,3,4,5,6,8,10,12];
    const d = choice(dens);
    let n = randInt(1, d * 2);  // 允许假分数
    if (Math.random() < 0.3) n = -n;
    return simplifyFraction({ n, d });
}

//
// Part B — 分数 × ÷，全部用假分数格式输出
//
function generateFractionQuestion() {
    const opType = choice(["mul", "div"]);

    let f1 = randomFraction();
    let f2 = randomFraction();
    if (f2.n === 0) f2.n = 1;

    let result;

    if (opType === "mul") {
        result = simplifyFraction({
            n: f1.n * f2.n,
            d: f1.d * f2.d
        });
    } else {
        // f1 ÷ f2 = f1 × (d2/n2)
        result = simplifyFraction({
            n: f1.n * f2.d,
            d: f1.d * f2.n
        });
    }

    // 限制结果不要太大
    if (Math.abs(result.n) > 50 || Math.abs(result.d) > 50) {
        return generateFractionQuestion();
    }

    const f1Str = fractionToString(f1);
    const f2Str = fractionToString(f2);
    const opSymbol = opType === "mul" ? "×" : "÷";

    return {
        text: `${f1Str} ${opSymbol} ${f2Str}`,
        value: fractionToValue(result),
        display: fractionToString(result)
    };
}

//
// Part C — 小数 / 分数 / 百分数混合
//
function generateMixedQuestion() {
    const pattern = choice([1,2,3,4,5]);

    let text = "";
    let value = 0;

    if (pattern === 1) {
        // p% of x
        const percents = [10,20,25,30,40,50,60,75];
        let p = choice(percents);
        let b = choice([0.6,0.8,1.2,1.5,1.8,-0.8,-1.2]);
        value = b * (p / 100);
        text = `${p}% of ${b}`;

    } else if (pattern === 2) {
        // fraction of decimal
        const d = choice([2,3,4,5,6,8,10]);
        const n = randInt(1, d - 1);
        const f = simplifyFraction({ n, d });

        let dec = choice([0.6,0.8,1.2,1.5,2.4]);
        if (Math.random() < 0.3) dec = -dec;

        value = dec * (f.n / f.d);
        text = `${fractionToString(f)} of ${dec}`;

    } else if (pattern === 3) {
        // decimal × fraction
        const d = choice([2,3,4,5,6,8,10]);
        const n = randInt(1, d - 1);
        const f = simplifyFraction({ n, d });

        let dec = choice([0.4,0.5,0.6,0.75,0.8,1.2]);
        if (Math.random() < 0.4) dec = -dec;

        value = dec * (f.n / f.d);
        text = `${dec} × ${fractionToString(f)}`;

    } else if (pattern === 4) {
        // decimal ÷ percent
        let dec = choice([0.36,0.48,0.72,1.2]);
        const p = choice([20,25,40,60]);
        if (Math.random() < 0.4) dec = -dec;

        value = dec / (p / 100);
        text = `${dec} ÷ ${p}%`;

    } else {
        // negative decimal × improper fraction (from random mix)
        const d = choice([2,3,4,5,6,8]);
        const whole = randInt(1, 3);
        const n = randInt(1, d - 1);
        const f = simplifyFraction({ n, d });

        // 转成假分数
        const improper = simplifyFraction({
            n: whole * f.d + f.n,
            d: f.d
        });

        let dec = -choice([0.6,0.8,1.2,1.5]);
        value = dec * (improper.n / improper.d);

        text = `${dec} × ${fractionToString(improper)}`;
    }

    value = Number(value.toFixed(6));

    return {
        text,
        value,
        display: String(value)
    };
}

/* ----------------------------------------------------------
   整套题目的数据结构
---------------------------------------------------------- */

let questions = [];          // 所有题：{ partIndex, indexInPart, text, value, display, userValue, isCorrect }
let currentQuestionIndex = 0;
let studentName = "Student";
let quizStartTime = null;
let quizEndTime = null;

const quizContent   = document.getElementById("quizContent");
const sidebarEl     = document.getElementById("sidebar");
const backButton    = document.getElementById("backButton");
const nextButton    = document.getElementById("nextButton");
const generateBtn   = document.getElementById("generateButton");

/* ----------------------------------------------------------
   生成一整套题（固定 18 小题，3 Parts × 6）
---------------------------------------------------------- */

function generateQuiz() {
    questions = [];

    for (let p = 0; p < NUM_PARTS; p++) {
        for (let i = 0; i < QUESTIONS_PER_PART; i++) {

            let baseQ;
            if (p === 0) baseQ = generateDecimalQuestion();
            else if (p === 1) baseQ = generateFractionQuestion();
            else baseQ = generateMixedQuestion();

            questions.push({
                partIndex: p,
                indexInPart: i,
                text: baseQ.text,
                value: baseQ.value,
                display: baseQ.display,
                userValue: "",
                isCorrect: false
            });
        }
    }
}


/* ----------------------------------------------------------
   Sidebar (左侧题号列表)
---------------------------------------------------------- */

function renderSidebar() {
    sidebarEl.style.display = "block";
    sidebarEl.innerHTML = `
        <h4>Questions</h4>
        <ul id="qList"></ul>
    `;

    const ul = document.getElementById("qList");
    for (let i = 0; i < TOTAL_QUESTIONS; i++) {
        const q = questions[i];
        const li = document.createElement("li");
        const label = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);

        li.textContent = `Q${i + 1} (${label})`;
        li.dataset.index = i;

        li.addEventListener("click", () => {
            saveCurrentInput();
            currentQuestionIndex = i;
            renderQuestion();
        });

        ul.appendChild(li);
    }

    updateSidebarStatus();
}

function updateSidebarStatus() {
    const items = document.querySelectorAll("#qList li");

    items.forEach(li => {
        const idx = Number(li.dataset.index);
        const q = questions[idx];

        li.classList.toggle("active", idx === currentQuestionIndex);
        li.classList.toggle("answered", (q.userValue || "").trim() !== "");
    });
}


/* ----------------------------------------------------------
   显示单题页面
---------------------------------------------------------- */

function renderQuestion() {
    const q = questions[currentQuestionIndex];
    const partLabel = ["A","B","C"][q.partIndex];
    const fullLabel = `${partLabel}${q.indexInPart + 1}`;

    quizContent.innerHTML = `
        <p class="question-text">
            Question ${currentQuestionIndex + 1} of ${TOTAL_QUESTIONS}
        </p>

        <p class="instructions">
            Enter your answer using integers, decimals, or fractions (e.g., 3/4 or -2 1/3).
            Answers will always be shown as improper fractions.
        </p>

        <div class="part-title">${PART_TITLES[q.partIndex]}</div>

        <div class="single-question">
            ${fullLabel}. ${q.text}
            <input id="answerInput" class="answer-box" type="text" value="${q.userValue || ""}">
        </div>
    `;

    // 按钮状态
    backButton.style.display = "inline-block";
    nextButton.style.display = "inline-block";

    backButton.style.visibility = currentQuestionIndex === 0 ? "hidden" : "visible";
    nextButton.textContent = currentQuestionIndex === TOTAL_QUESTIONS - 1
        ? "Submit & View Results"
        : "Next";

    updateSidebarStatus();
}

function saveCurrentInput() {
    const input = document.getElementById("answerInput");
    if (input) {
        questions[currentQuestionIndex].userValue = input.value.trim();
    }
}


/* ----------------------------------------------------------
   结果页面
---------------------------------------------------------- */

function calculateAndShowResults() {
    quizEndTime = new Date();

    let correctCount = 0;

    questions.forEach(q => {
        const val = parseAnswer(q.userValue || "");
        q.isCorrect = nearlyEqual(val, q.value);
        if (q.isCorrect) correctCount++;
    });

    // 计时信息
    let timeInfo = "";
    if (quizStartTime) {
        const diffSec = Math.floor((quizEndTime - quizStartTime) / 1000);
        const min = Math.floor(diffSec / 60);
        const sec = diffSec % 60;

        timeInfo = `
            <p>Start time: <strong>${quizStartTime.toLocaleTimeString()}</strong></p>
            <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
            <p>Time taken: <strong>${min}m ${sec}s</strong></p>
        `;
    }

    let html = `
        <h3>Results for ${studentName}</h3>
        <p>Score: <strong>${correctCount} / ${TOTAL_QUESTIONS}</strong></p>
        ${timeInfo}

        <table class="review-table">
            <tr>
                <th>#</th>
                <th>Part</th>
                <th>Question</th>
                <th>Your Answer</th>
                <th>Correct</th>
                <th>Result</th>
            </tr>
    `;

    questions.forEach((q, i) => {
        const partLbl = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);

        html += `
            <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
                <td>${i + 1}</td>
                <td>${partLbl}</td>
                <td>${q.text}</td>
                <td>${q.userValue || "—"}</td>
                <td>${q.display}</td>
                <td>${q.isCorrect ? "Correct" : "Incorrect"}</td>
            </tr>
        `;
    });

    html += `</table>`;

    quizContent.innerHTML = html;

    backButton.style.display = "none";
    nextButton.style.display = "none";
}


/* ----------------------------------------------------------
   按钮事件
---------------------------------------------------------- */

nextButton.addEventListener("click", () => {
    saveCurrentInput();

    if (currentQuestionIndex === TOTAL_QUESTIONS - 1) {
        calculateAndShowResults();
    } else {
        currentQuestionIndex++;
        renderQuestion();
    }
});

backButton.addEventListener("click", () => {
    saveCurrentInput();

    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
    }
});

// Generate a new random set
generateBtn.addEventListener("click", () => {
    if (!confirm("Generate a new random set? All answers will be lost.")) return;

    quizStartTime = new Date();
    generateQuiz();
    currentQuestionIndex = 0;

    renderSidebar();
    renderQuestion();
});


/* ----------------------------------------------------------
   Start screen (input name)
---------------------------------------------------------- */

function showStartScreen() {
    sidebarEl.style.display = "none";
    backButton.style.display = "none";
    nextButton.style.display = "none";
    generateBtn.style.display = "none";

    quizContent.innerHTML = `
        <p>This quiz contains <strong>${TOTAL_QUESTIONS}</strong> questions (A/B/C parts).</p>
        <p>Please enter your name to begin:</p>

        <input id="nameInput"
               type="text"
               style="padding:10px; width:250px; font-size:1.05em;"
               placeholder="Your name">

        <button id="startButton"
                style="margin-left:10px; background:#4caf50; padding:10px 20px; color:white; border:none; border-radius:6px;">
            Start Quiz
        </button>
    `;

    document.getElementById("startButton").addEventListener("click", startQuiz);
}

function startQuiz() {
    const nameInput = document.getElementById("nameInput");
    studentName = (nameInput.value || "Student").trim();

    quizStartTime = new Date();
    generateQuiz();
    currentQuestionIndex = 0;

    renderSidebar();
    renderQuestion();

    backButton.style.display = "inline-block";
    nextButton.style.display = "inline-block";
    generateBtn.style.display = "inline-block";
}


/* ----------------------------------------------------------
   初始化
---------------------------------------------------------- */

showStartScreen();

</script>
</body>
</html>
