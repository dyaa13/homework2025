<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Mixed Calculation Quiz</title>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .quiz-container {
            max-width: 900px;
            margin: 40px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        #headerLogo {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: #0d47a1;
            border-radius: 4px;
        }

        .logo-text span.edu {
            font-size: 0.9em;
            color: #ff9800;
            font-weight: 700;
            margin-left: 10px;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .quiz-main {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 140px;
            border-right: 1px solid #ddd;
            padding-right: 10px;
            display: none;
        }

        .sidebar h4 {
            margin: 0 0 8px;
            font-size: 0.95em;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar li {
            padding: 6px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .sidebar li.active {
            outline: 2px solid #1976d2;
            font-weight: 600;
        }

        .sidebar li.answered {
            border-left: 4px solid #4caf50;
        }

        .sidebar li.correct {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .sidebar li.incorrect {
            background: #f8d7da;
            border-left: 4px solid #f44336;
        }

        #quizContent {
            flex: 1;
        }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .instructions {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 12px;
        }

        .part-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .single-question {
            margin-top: 6px;
            margin-bottom: 6px;
        }

        .answer-box {
            width: 140px;
            padding: 6px;
            font-size: 1em;
            margin-left: 8px;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
        }

        #nextButton { background:#4caf50; }
        #backButton { background:#039be5; }
        #generateButton { background:#ff9800; }
        #submitButton { background:#9c27b0; }
        #saveButton { background:#607d8b; }

        table.review-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .review-table th,
        .review-table td {
            border: 1px solid #ccc;
            padding: 6px;
            font-size: 0.85em;
            text-align: center;
        }

        .review-table th {
            background: #f2f2f2;
        }

        .correct-answer {
            background: #d4edda;
        }

        .incorrect-answer {
            background: #f8d7da;
        }

        @media (max-width: 700px) {
            .quiz-main {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #ddd;
                margin-bottom: 10px;
                padding-bottom: 10px;
            }
        }
    </style>
</head>

<body>
<div class="quiz-container">
    <div id="headerLogo">
        <div class="logo-icon"></div>
        <div class="logo-text"><span class="edu">EDUCATION</span></div>
    </div>

    <div class="top-bar">
        <button id="generateButton" style="display:none;">Generate New Set</button>
    </div>

    <h2>Random Mixed Calculation Quiz</h2>

    <div class="quiz-main">
        <div id="sidebar" class="sidebar"></div>
        <div id="quizContent"></div>
    </div>

    <div class="button-container">
        <button id="backButton" style="display:none;">Previous</button>
        <button id="submitButton" style="display:none;">Submit &amp; View Results</button>
        <button id="nextButton" style="display:none;">Next</button>
        <button id="saveButton" style="display:none;">Save Current Result</button>
    </div>
</div>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */

const PART_TITLES = [
    "A. Mixed Decimals / Integers / Negatives",
    "B. Fractions × ÷ (with some negatives)",
    "C. Mixed Decimals / Fractions / Percentages"
];

const NUM_PARTS = 3;
const QUESTIONS_PER_PART = 6;
const TOTAL_QUESTIONS = NUM_PARTS * QUESTIONS_PER_PART;

/* ----------------------------------------------------------
   工具函数
---------------------------------------------------------- */

function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function choice(arr) {
    return arr[randInt(0, arr.length - 1)];
}

function gcd(a, b) {
    a = Math.abs(a);
    b = Math.abs(b);
    while (b !== 0) {
        let t = b;
        b = a % b;
        a = t;
    }
    return a === 0 ? 1 : a;
}

function simplifyFraction(fr) {
    if (fr.d < 0) {
        fr.n = -fr.n;
        fr.d = -fr.d;
    }
    const g = gcd(fr.n, fr.d);
    fr.n /= g;
    fr.d /= g;
    return fr;
}

function fractionToValue(fr) {
    return fr.n / fr.d;
}

function fractionToString(fr) {
    fr = simplifyFraction({ n: fr.n, d: fr.d });

    if (fr.d === 1) return String(fr.n);
    return `${fr.n}/${fr.d}`;
}

/* ----------------------------------------------------------
   解析答案
---------------------------------------------------------- */

function parseAnswer(str) {
    let s = str.trim();
    if (s === "") return NaN;

    let sign = 1;
    if (s[0] === "+") {
        s = s.slice(1).trim();
    } else if (s[0] === "-") {
        sign = -1;
        s = s.slice(1).trim();
    }
    if (s === "") return NaN;

    const spaceParts = s.split(/\s+/);
    if (spaceParts.length === 2 && spaceParts[1].includes("/")) {
        const whole = Number(spaceParts[0]);
        const fracParts = spaceParts[1].split("/");
        if (fracParts.length !== 2) return NaN;

        const num = Number(fracParts[0]);
        const den = Number(fracParts[1]);

        if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;

        const absWhole = Math.abs(whole);
        const fracVal = num / den;
        let value = absWhole + fracVal;

        if (whole < 0) value = -value;

        return sign * value;
    }

    if (s.includes("/")) {
        const parts = s.split("/");
        if (parts.length !== 2) return NaN;

        const num = Number(parts[0]);
        const den = Number(parts[1]);

        if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;

        return sign * (num / den);
    }

    const n = Number(s);
    return Number.isFinite(n) ? sign * n : NaN;
}

function nearlyEqual(a, b, eps = 1e-6) {
    if (!Number.isFinite(a) || !Number.isFinite(b)) return false;
    return Math.abs(a - b) < eps;
}

/* ----------------------------------------------------------
   题目生成
---------------------------------------------------------- */

function generateDecimalQuestion() {
    const opType = choice(["mul", "div"]);
    const signCase = choice(["pos", "negA", "negB"]);

    let text = "";
    let value = 0;

    if (opType === "mul") {
        const decimals = [0.2,0.3,0.4,0.5,0.6,0.75,0.8,1.2,1.5,2.4];
        let a = choice(decimals);
        let b = randInt(2, 12);

        if (signCase === "negA") a = -a;
        if (signCase === "negB") b = -b;

        value = a * b;
        text = `${a} × ${b}`;

    } else {
        const divisors = [0.2,0.25,0.4,0.5,0.8,1.25,1.5];
        let q = randInt(2, 12);
        if (Math.random() < 0.3) q = -q;
        let d = choice(divisors);

        let dividend = Number((q * d).toFixed(3));

        value = q;
        text = `${dividend} ÷ ${d}`;
    }

    return {
        text,
        value,
        display: String(value)
    };
}

function randomFraction() {
    const dens = [2,3,4,5,6,8,10,12];
    const d = choice(dens);
    let n = randInt(1, d * 2);
    if (Math.random() < 0.3) n = -n;
    return simplifyFraction({ n, d });
}

function generateFractionQuestion() {
    const opType = choice(["mul", "div"]);

    let f1 = randomFraction();
    let f2 = randomFraction();
    if (f2.n === 0) f2.n = 1;

    let result;

    if (opType === "mul") {
        result = simplifyFraction({
            n: f1.n * f2.n,
            d: f1.d * f2.d
        });
    } else {
        result = simplifyFraction({
            n: f1.n * f2.d,
            d: f1.d * f2.n
        });
    }

    if (Math.abs(result.n) > 50 || Math.abs(result.d) > 50) {
        return generateFractionQuestion();
    }

    const f1Str = fractionToString(f1);
    const f2Str = fractionToString(f2);
    const opSymbol = opType === "mul" ? "×" : "÷";

    return {
        text: `${f1Str} ${opSymbol} ${f2Str}`,
        value: fractionToValue(result),
        display: fractionToString(result)
    };
}

function generateMixedQuestion() {
    const pattern = choice([1,2,3,4,5]);

    let text = "";
    let value = 0;

    if (pattern === 1) {
        const percents = [10,20,25,30,40,50,60,75];
        let p = choice(percents);
        let b = choice([0.6,0.8,1.2,1.5,1.8,-0.8,-1.2]);
        value = b * (p / 100);
        text = `${p}% of ${b}`;

    } else if (pattern === 2) {
        const d = choice([2,3,4,5,6,8,10]);
        const n = randInt(1, d - 1);
        const f = simplifyFraction({ n, d });

        let dec = choice([0.6,0.8,1.2,1.5,2.4]);
        if (Math.random() < 0.3) dec = -dec;

        value = dec * (f.n / f.d);
        text = `${fractionToString(f)} of ${dec}`;

    } else if (pattern === 3) {
        const d = choice([2,3,4,5,6,8,10]);
        const n = randInt(1, d - 1);
        const f = simplifyFraction({ n, d });

        let dec = choice([0.4,0.5,0.6,0.75,0.8,1.2]);
        if (Math.random() < 0.4) dec = -dec;

        value = dec * (f.n / f.d);
        text = `${dec} × ${fractionToString(f)}`;

    } else if (pattern === 4) {
        let dec = choice([0.36,0.48,0.72,1.2]);
        const p = choice([20,25,40,60]);
        if (Math.random() < 0.4) dec = -dec;

        value = dec / (p / 100);
        text = `${dec} ÷ ${p}%`;

    } else {
        const d = choice([2,3,4,5,6,8]);
        const whole = randInt(1, 3);
        const n = randInt(1, d - 1);
        const f = simplifyFraction({ n, d });

        const improper = simplifyFraction({
            n: whole * f.d + f.n,
            d: f.d
        });

        let dec = -choice([0.6,0.8,1.2,1.5]);
        value = dec * (improper.n / improper.d);

        text = `${dec} × ${fractionToString(improper)}`;
    }

    value = Number(value.toFixed(6));

    return {
        text,
        value,
        display: String(value)
    };
}

/* ----------------------------------------------------------
   整套题目的数据结构
---------------------------------------------------------- */

let questions = [];
let currentQuestionIndex = 0;
let studentName = "Student";
let quizStartTime = null;
let quizEndTime = null;
let quizSubmitted = false;

const quizContent   = document.getElementById("quizContent");
const sidebarEl     = document.getElementById("sidebar");
const backButton    = document.getElementById("backButton");
const nextButton    = document.getElementById("nextButton");
const submitButton  = document.getElementById("submitButton");
const saveButton    = document.getElementById("saveButton");
const generateBtn   = document.getElementById("generateButton");

/* ----------------------------------------------------------
   生成整套题
---------------------------------------------------------- */

function generateQuiz() {
    questions = [];
    quizSubmitted = false;

    for (let p = 0; p < NUM_PARTS; p++) {
        for (let i = 0; i < QUESTIONS_PER_PART; i++) {

            let baseQ;
            if (p === 0) baseQ = generateDecimalQuestion();
            else if (p === 1) baseQ = generateFractionQuestion();
            else baseQ = generateMixedQuestion();

            questions.push({
                partIndex: p,
                indexInPart: i,
                text: baseQ.text,
                value: baseQ.value,
                display: baseQ.display,
                userValue: "",
                isCorrect: false
            });
        }
    }
}

/* ----------------------------------------------------------
   Sidebar
---------------------------------------------------------- */

function renderSidebar() {
    sidebarEl.style.display = "block";
    sidebarEl.innerHTML = `
        <h4>Questions</h4>
        <ul id="qList"></ul>
    `;

    const ul = document.getElementById("qList");
    for (let i = 0; i < TOTAL_QUESTIONS; i++) {
        const q = questions[i];
        const li = document.createElement("li");
        const label = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);

        li.textContent = `Q${i + 1} (${label})`;
        li.dataset.index = i;

        li.addEventListener("click", () => {
            saveCurrentInput();
            currentQuestionIndex = i;
            renderQuestion();
        });

        ul.appendChild(li);
    }

    updateSidebarStatus();
}

function updateSidebarStatus() {
    const items = document.querySelectorAll("#qList li");

    items.forEach(li => {
        const idx = Number(li.dataset.index);
        const q = questions[idx];

        li.classList.remove("active", "answered", "correct", "incorrect");

        if (!quizSubmitted) {
            li.classList.toggle("active", idx === currentQuestionIndex);
            if ((q.userValue || "").trim() !== "") {
                li.classList.add("answered");
            }
        } else {
            if ((q.userValue || "").trim() !== "") {
                if (q.isCorrect) {
                    li.classList.add("correct");
                } else {
                    li.classList.add("incorrect");
                }
            }
        }
    });
}

/* ----------------------------------------------------------
   显示单题
---------------------------------------------------------- */

function renderQuestion() {
    const q = questions[currentQuestionIndex];
    const partLabel = ["A","B","C"][q.partIndex];
    const fullLabel = `${partLabel}${q.indexInPart + 1}`;

    quizContent.innerHTML = `
        <p class="question-text">
            Question ${currentQuestionIndex + 1} of ${TOTAL_QUESTIONS}
        </p>

        <p class="instructions">
            Enter your answer using integers, decimals, or fractions (e.g., 3/4 or -2 1/3).
            Answers will always be shown as improper fractions.
        </p>

        <div class="part-title">${PART_TITLES[q.partIndex]}</div>

        <div class="single-question">
            ${fullLabel}. ${q.text}
            <input id="answerInput" class="answer-box" type="text" value="${q.userValue || ""}">
        </div>
    `;

    backButton.style.display = "inline-block";
    nextButton.style.display = "inline-block";
    submitButton.style.display = "inline-block";

    backButton.style.visibility = currentQuestionIndex === 0 ? "hidden" : "visible";
    nextButton.textContent = "Next";

    updateSidebarStatus();
}

function saveCurrentInput() {
    const input = document.getElementById("answerInput");
    if (input) {
        questions[currentQuestionIndex].userValue = input.value.trim();
    }
}

/* ----------------------------------------------------------
   保存当前结果为 txt
---------------------------------------------------------- */

function formatDateForFilename(date) {
    if (!date) return "no_time";
    const pad = n => String(n).padStart(2, "0");
    return (
        date.getFullYear() +
        pad(date.getMonth() + 1) +
        pad(date.getDate()) + "_" +
        pad(date.getHours()) +
        pad(date.getMinutes()) +
        pad(date.getSeconds())
    );
}

function saveCurrentResultAsTxt() {
    // 确保当前输入保存
    saveCurrentInput();

    // 如果还没提交过，也做一遍判分（但不改变页面内容）
    if (!quizSubmitted) {
        questions.forEach(q => {
            const val = parseAnswer(q.userValue || "");
            q.isCorrect = nearlyEqual(val, q.value);
        });
    }

    let correctCount = 0;
    questions.forEach(q => {
        if (q.isCorrect) correctCount++;
    });

    let lines = [];
    lines.push("Random Mixed Calculation Quiz - Current Result");
    lines.push("Student: " + studentName);
    if (quizStartTime) {
        lines.push("Start time: " + quizStartTime.toLocaleString());
    }
    if (quizEndTime) {
        lines.push("Last submit time: " + quizEndTime.toLocaleString());
    }
    lines.push("Score: " + correctCount + " / " + TOTAL_QUESTIONS);
    lines.push("");
    lines.push("Details:");
    lines.push("----------");

    questions.forEach((q, i) => {
        const partLbl = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);
        const userAns = (q.userValue || "").trim() === "" ? "Not answered" : q.userValue;
        const resultText = (q.userValue || "").trim() === ""
            ? "Not answered"
            : (q.isCorrect ? "Correct" : "Incorrect");

        lines.push(
            `Q${i + 1} (${partLbl})` +
            "\nQuestion: " + q.text +
            "\nYour answer: " + userAns +
            "\nCorrect answer: " + q.display +
            "\nResult: " + resultText
        );
        lines.push("");
    });

    const content = lines.join("\n");
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const safeName = studentName.replace(/[^a-z0-9_\-]/gi, "_") || "Student";
    const ts = formatDateForFilename(new Date());
    a.href = url;
    a.download = `MixedQuiz_${safeName}_${ts}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/* ----------------------------------------------------------
   结果页面
---------------------------------------------------------- */

function calculateAndShowResults() {
    saveCurrentInput();
    quizEndTime = new Date();
    quizSubmitted = true;

    let correctCount = 0;

    questions.forEach(q => {
        const val = parseAnswer(q.userValue || "");
        q.isCorrect = nearlyEqual(val, q.value);
        if (q.isCorrect) correctCount++;
    });

    updateSidebarStatus();

    let timeInfo = "";
    if (quizStartTime) {
        const diffSec = Math.floor((quizEndTime - quizStartTime) / 1000);
        const min = Math.floor(diffSec / 60);
        const sec = diffSec % 60;

        timeInfo = `
            <p>Start time: <strong>${quizStartTime.toLocaleTimeString()}</strong></p>
            <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
            <p>Time taken: <strong>${min}m ${sec}s</strong></p>
        `;
    }

    let html = `
        <h3>Results for ${studentName}</h3>
        <p>Score: <strong>${correctCount} / ${TOTAL_QUESTIONS}</strong></p>
        ${timeInfo}

        <p>You can click any question number on the left to go back, change your answers, and submit again.</p>

        <table class="review-table">
            <tr>
                <th>#</th>
                <th>Part</th>
                <th>Question</th>
                <th>Your Answer</th>
                <th>Correct</th>
                <th>Result</th>
            </tr>
    `;

    questions.forEach((q, i) => {
        const partLbl = ["A","B","C"][q.partIndex] + (q.indexInPart + 1);

        html += `
            <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
                <td>${i + 1}</td>
                <td>${partLbl}</td>
                <td>${q.text}</td>
                <td>${q.userValue || "—"}</td>
                <td>${q.display}</td>
                <td>${q.isCorrect ? "Correct" : "Incorrect"}</td>
            </tr>
        `;
    });

    html += `</table>`;

    quizContent.innerHTML = html;

    backButton.style.display = "inline-block";
    nextButton.style.display = "inline-block";
    submitButton.style.display = "inline-block";

    // ★ 结果出来后，显示保存按钮
    saveButton.style.display = "inline-block";
}

/* ----------------------------------------------------------
   按钮事件
---------------------------------------------------------- */

nextButton.addEventListener("click", () => {
    saveCurrentInput();

    if (currentQuestionIndex < TOTAL_QUESTIONS - 1) {
        currentQuestionIndex++;
        renderQuestion();
    }
});

backButton.addEventListener("click", () => {
    saveCurrentInput();

    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
    }
});

submitButton.addEventListener("click", () => {
    calculateAndShowResults();
});

saveButton.addEventListener("click", saveCurrentResultAsTxt);

// Generate a new random set
generateBtn.addEventListener("click", () => {
    if (!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;

    quizStartTime = new Date();
    generateQuiz();
    currentQuestionIndex = 0;

    renderSidebar();
    renderQuestion();
});

/* ----------------------------------------------------------
   Start screen
---------------------------------------------------------- */

function showStartScreen() {
    sidebarEl.style.display = "none";
    backButton.style.display = "none";
    nextButton.style.display = "none";
    submitButton.style.display = "none";
    generateBtn.style.display = "none";
    saveButton.style.display = "none";

    quizContent.innerHTML = `
        <p>This quiz contains <strong>${TOTAL_QUESTIONS}</strong> questions (A/B/C parts).</p>
        <p>Please enter your name to begin:</p>

        <input id="nameInput"
               type="text"
               style="padding:10px; width:250px; font-size:1.05em;"
               placeholder="Your name">

        <button id="startButton"
                style="margin-left:10px; background:#4caf50; padding:10px 20px; color:white; border:none; border-radius:6px;">
            Start Quiz
        </button>
    `;

    document.getElementById("startButton").addEventListener("click", startQuiz);
}

function startQuiz() {
    const nameInput = document.getElementById("nameInput");
    studentName = (nameInput.value || "Student").trim();

    quizStartTime = new Date();
    generateQuiz();
    currentQuestionIndex = 0;

    renderSidebar();
    renderQuestion();

    backButton.style.display = "inline-block";
    nextButton.style.display = "inline-block";
    submitButton.style.display = "inline-block";
    generateBtn.style.display = "inline-block";
    saveButton.style.display = "none";
}

/* ----------------------------------------------------------
   初始化
---------------------------------------------------------- */

showStartScreen();
</script>
</body>
</html>
