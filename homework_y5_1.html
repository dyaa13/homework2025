<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Assessment</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .quiz-container {
            max-width: 950px;
            margin: 40px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        /* 左右布局：左侧题号导航 + 右侧内容 */
        .quiz-main {
            display: flex;
            align-items: flex-start;
        }

        .question-nav {
            min-width: 120px;
            margin-right: 20px;
            font-size: 0.9em;
        }
        .question-nav table {
            width: 100%;
            border-collapse: collapse;
        }
        .question-nav td {
            border: 1px solid #ddd;
            padding: 6px 4px;
            text-align: center;
            cursor: pointer;
            user-select: none;
        }
        .question-nav td:hover {
            background-color: #e3f2fd;
        }
        .question-nav td.current-question {
            background-color: #bbdefb;
            font-weight: bold;
        }

        .quiz-main-right {
            flex: 1;
        }

        #headerLogo {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .logo-text {
            line-height: 1.2;
            margin-left: 10px;
        }
        .logo-text span.edu {
            font-size: 0.8em;
            letter-spacing: 1px;
            font-weight: 600;
            color: #ff9800;
            display: block;
        }
        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: #0d47a1;
            border-radius: 4px;
            position: relative;
        }
        .logo-icon::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 5px;
            width: 30px;
            height: 10px;
            background-color: #ff9800;
            border-radius: 2px;
        }
        
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }
        
        #nextButton, #backButton, #startButton, #saveResultsButton {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        #backButton {
            background-color: #03A9F4;
        }
        #saveResultsButton {
            margin-top: 20px;
            background-color: #ff9800;
        }
        #nextButton:hover, #startButton:hover { background-color: #388E3C; }
        #backButton:hover { background-color: #0288D1; }
        #saveResultsButton:hover { background-color: #fb8c00; }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .options-list {
            list-style: none;
            padding: 0;
            cursor: pointer;
        }
        .options-list li {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .options-list li:hover {
            background-color: #e3f2fd;
            border-color: #03A9F4;
        }
        .options-list li.selected {
            background-color: #bbdefb;
            border-color: #0288D1;
            font-weight: bold;
        }
        
        .review-table { width: 100%; border-collapse: collapse; margin-top: 20px; text-align: left; font-size: 0.9em; }
        .review-table th, .review-table td { border: 1px solid #ddd; padding: 10px; }
        .review-table th { background-color: #f2f2f2; color: #333; }
        .correct-answer { background-color: #d4edda; color: #155724; font-weight: bold; }
        .incorrect-answer { background-color: #f8d7da; color: #721c24; font-weight: bold; }
        #startScreen input { padding: 10px; width: 80%; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #studentInfo { font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="quiz-container">
    <div class="quiz-main">
        <!-- 左侧题号导航 -->
        <div id="questionNav" class="question-nav"></div>

        <!-- 右侧主内容 -->
        <div class="quiz-main-right">
            <div id="headerLogo">
                <div class="logo-icon"></div>
                <div class="logo-text">
                    <span class="edu">EDUCATION</span>
                </div>
            </div>
            
            <h2 id="quizTitle">Math Assessment</h2>
            
            <div id="quizContent"></div>

            <div class="button-container">
                <button id="backButton" style="display:none;">Previous</button>
                <button id="nextButton" style="display:none;">Next Question</button>
            </div>
        </div>
    </div>
</div>

<script>
  const IMG_FOLDER = "ICAS2015/";

  // 1) 题目：只放题干和选项，不放答案
  const questions = [
      {
          text: `Q1.
                 <img src="${IMG_FOLDER}q1.png"
                      alt="Question 1"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q2.
                 <img src="${IMG_FOLDER}q2.png"
                      alt="Question 2"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q3.
                 <img src="${IMG_FOLDER}q3.png"
                      alt="Question 3"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q4.
                 <img src="${IMG_FOLDER}q4.png"
                      alt="Question 4"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q5.
                 <img src="${IMG_FOLDER}q5.png"
                      alt="Question 5"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q6.
                 <img src="${IMG_FOLDER}q6.png"
                      alt="Question 6"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q7.
                 <img src="${IMG_FOLDER}q7.png"
                      alt="Question 7"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q8.
                 <img src="${IMG_FOLDER}q8.png"
                      alt="Question 8"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q9.
                 <img src="${IMG_FOLDER}q9.png"
                      alt="Question 9"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q10.
                 <img src="${IMG_FOLDER}q10.png"
                      alt="Question 10"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q11.
                 <img src="${IMG_FOLDER}q11.png"
                      alt="Question 11"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q12.
                 <img src="${IMG_FOLDER}q12.png"
                      alt="Question 12"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q13.
                 <img src="${IMG_FOLDER}q13.png"
                      alt="Question 13"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q14.
                 <img src="${IMG_FOLDER}q14.png"
                      alt="Question 14"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q15.
                 <img src="${IMG_FOLDER}q15.png"
                      alt="Question 15"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q16.
                 <img src="${IMG_FOLDER}q16.png"
                      alt="Question 16"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "", E: "", F: "" }
      },
      {
          text: `Q17.
                 <img src="${IMG_FOLDER}q17.png"
                      alt="Question 17"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q18.
                 <img src="${IMG_FOLDER}q18.png"
                      alt="Question 18"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q19.
                 <img src="${IMG_FOLDER}q19.png"
                      alt="Question 19"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q20.
                 <img src="${IMG_FOLDER}q20.png"
                      alt="Question 20"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q21.
                 <img src="${IMG_FOLDER}q21.png"
                      alt="Question 21"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q22.
                 <img src="${IMG_FOLDER}q22.png"
                      alt="Question 22"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q23.
                 <img src="${IMG_FOLDER}q23.png"
                      alt="Question 23"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q24.
                 <img src="${IMG_FOLDER}q24.png"
                      alt="Question 24"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q25.
                 <img src="${IMG_FOLDER}q25.png"
                      alt="Question 25"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q26.
                 <img src="${IMG_FOLDER}q26.png"
                      alt="Question 26"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q27.
                 <img src="${IMG_FOLDER}q27.png"
                      alt="Question 27"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q28.
                 <img src="${IMG_FOLDER}q28.png"
                      alt="Question 28"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q29.
                 <img src="${IMG_FOLDER}q29.png"
                      alt="Question 29"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q30.
                 <img src="${IMG_FOLDER}q30.png"
                      alt="Question 30"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q31.
                 <img src="${IMG_FOLDER}q31.png"
                      alt="Question 31"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q32.
                 <img src="${IMG_FOLDER}q32.png"
                      alt="Question 32"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q33.
                 <img src="${IMG_FOLDER}q33.png"
                      alt="Question 33"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q34.
                 <img src="${IMG_FOLDER}q34.png"
                      alt="Question 34"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q35.
                 <img src="${IMG_FOLDER}q35.png"
                      alt="Question 35"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q36.
                 <img src="${IMG_FOLDER}q36.png"
                      alt="Question 36"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "6", B: "7", C: "8", D: "9" }
      },
      {
          text: `Q37.
                 <img src="${IMG_FOLDER}q37.png"
                      alt="Question 37"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "21", B: "24", C: "27", D: "30" }
      },
      {
          text: `Q38.
                 <img src="${IMG_FOLDER}q38.png"
                      alt="Question 38"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "700", B: "732", C: "764", D: "796" }
      },
      {
          text: `Q39.
                 <img src="${IMG_FOLDER}q39.png"
                      alt="Question 39"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "", B: "", C: "", D: "" }
      },
      {
          text: `Q40.
                 <img src="${IMG_FOLDER}q40.png"
                      alt="Question 40"
                      style="max-width:100%; margin-top:8px;">`,
          options: { A: "101", B: "110", C: "119", D: "128" }
      }
  ];

  // 2) 答案：集中在一个数组里，后面只要改这里就行
  const answers = [
      "B",        // Q1
      "C",        // Q2
      "A",        // Q3
      "D",        // Q4
      "B",        // Q5
      "A",        // Q6
      "B",        // Q7
      "D",        // Q8
      "C",        // Q9
      "A",        // Q10
      "D",        // Q11
      "D",        // Q12
      "B",        // Q13
      "C",        // Q14
      "A",        // Q15
      "B,D,E,F",  // Q16 (多选)
      "A",        // Q17
      "D",        // Q18
      "B",        // Q19
      "A",        // Q20
      "C",        // Q21
      "D",        // Q22
      "B",        // Q23
      "B",        // Q24
      "B",        // Q25
      "C",        // Q26
      "A",        // Q27
      "C",        // Q28
      "A",        // Q29
      "D",        // Q30
      "B",        // Q31
      "A",        // Q32
      "A",        // Q33
      "D",        // Q34
      "C",        // Q35
      "C",        // Q36
      "A",        // Q37
      "B",        // Q38
      "A",        // Q39
      "C"         // Q40
  ];

  // 工具函数：把 "B,D,E" -> ["B","D","E"]
  function parseAnswerString(ansStr) {
      if (!ansStr) return [];
      return ansStr
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);
  }

  let currentQuestionIndex = 0;
  let score = 0; 
  let selectedAnswers = new Set();          // 当前题的多选
  let userAnswers = Array(questions.length).fill(null); 
  let studentName = "Smart"; 
  let quizStartTime = null;
  let quizEndTime = null;

  const quizContent = document.getElementById('quizContent');
  const nextButton = document.getElementById('nextButton');
  const backButton = document.getElementById('backButton'); 
  const questionNav = document.getElementById('questionNav');

  // 左侧题号表
  function renderQuestionNav() {
      if (!questionNav) return;

      let html = '<table><tbody>';
      questions.forEach((q, index) => {
          const isCurrent = index === currentQuestionIndex &&
                            currentQuestionIndex >= 0 &&
                            currentQuestionIndex < questions.length;
          html += `
              <tr>
                  <td data-qindex="${index}" class="${isCurrent ? 'current-question' : ''}">
                      Q${index + 1}
                  </td>
              </tr>
          `;
      });
      html += '</tbody></table>';
      questionNav.innerHTML = html;
  }

  function goToQuestion(index) {
      if (index < 0 || index >= questions.length) return;

      // 只有在当前索引还在题目范围内时才保存（结果页时不会保存）
      if (currentQuestionIndex >= 0 && currentQuestionIndex < questions.length) {
          saveCurrentAnswer();
      }

      currentQuestionIndex = index;
      renderQuestion();

      nextButton.style.display = 'inline-block';
      backButton.style.display = 'inline-block';
      backButton.style.visibility = (currentQuestionIndex > 0) ? 'visible' : 'hidden';
  }

  // 左侧导航点击事件
  if (questionNav) {
      questionNav.addEventListener('click', function (event) {
          const cell = event.target.closest('td[data-qindex]');
          if (!cell) return;

          const idx = parseInt(cell.getAttribute('data-qindex'), 10);
          if (Number.isNaN(idx)) return;

          goToQuestion(idx);
      });
  }

  // 选项点击事件（多选：切换选中/取消）
  quizContent.addEventListener('click', function(event) {
      let clickedElement = event.target;
      
      while (clickedElement && clickedElement.tagName !== 'LI') {
          if (clickedElement === quizContent) {
              return;
          }
          clickedElement = clickedElement.parentElement;
      }

      if (clickedElement && clickedElement.hasAttribute('data-answer')) {
          const key = clickedElement.getAttribute('data-answer');
          handleAnswerToggle(clickedElement, key);
      }
  });

  // 渲染当前题
  function renderQuestion() {
      if (currentQuestionIndex >= questions.length) {
          if (currentQuestionIndex === questions.length) {
              calculateFinalScore(); 
              showFinalResult();
          }
          return;
      }

      const q = questions[currentQuestionIndex];
      
      quizContent.innerHTML = '';

      // 更新左侧题号高亮
      renderQuestionNav();
      
      // 恢复当前题已选答案
      selectedAnswers = new Set();
      const existing = userAnswers[currentQuestionIndex];
      if (existing && Array.isArray(existing.userChoices)) {
          existing.userChoices.forEach(a => selectedAnswers.add(a));
      }

      nextButton.textContent =
          (currentQuestionIndex === questions.length - 1) ? 'View Results' : 'Next Question';

      nextButton.style.display = 'inline-block';
      backButton.style.display = 'inline-block';
      backButton.style.visibility = (currentQuestionIndex > 0) ? 'visible' : 'hidden';
      
      const qText = document.createElement('p');
      qText.className = 'question-text';
      qText.innerHTML = `(Question ${currentQuestionIndex + 1} of ${questions.length}) ` + q.text;
      quizContent.appendChild(qText);

      const optionsList = document.createElement('ul');
      optionsList.className = 'options-list';
      
      for (const key in q.options) {
          const listItem = document.createElement('li');
          listItem.textContent = `${key}. ${q.options[key]}`;
          listItem.setAttribute('data-answer', key);
          
          if (selectedAnswers.has(key)) {
              listItem.classList.add('selected');
          }
          
          optionsList.appendChild(listItem);
      }
      quizContent.appendChild(optionsList);
  }

  // 多选：切换选中状态
  function handleAnswerToggle(selectedElement, key) {
      if (selectedElement.classList.contains('selected')) {
          selectedElement.classList.remove('selected');
          selectedAnswers.delete(key);
      } else {
          selectedElement.classList.add('selected');
          selectedAnswers.add(key);
      }
  }

  // 保存当前题答案到 userAnswers
  function saveCurrentAnswer() {
      // 保护：只有在题目范围内才保存
      if (currentQuestionIndex < 0 || currentQuestionIndex >= questions.length) return;

      const q = questions[currentQuestionIndex];
      const correctAnswers = parseAnswerString(answers[currentQuestionIndex]);

      const userChoicesArray = Array.from(selectedAnswers);
      let isCorrect = false;

      if (userChoicesArray.length > 0) {
          const sortedUser = [...userChoicesArray].sort();
          const sortedCorrect = [...correctAnswers].sort();

          if (sortedUser.length === sortedCorrect.length) {
              isCorrect = sortedUser.every((val, idx) => val === sortedCorrect[idx]);
          }
      }

      userAnswers[currentQuestionIndex] = {
          questionIndex: currentQuestionIndex,
          userChoices: userChoicesArray,
          correctAnswers: correctAnswers,
          isCorrect: isCorrect
      };
  }

  function saveAnswerAndMove(direction) {
      saveCurrentAnswer();
      
      if (direction === 'next') {
          currentQuestionIndex++;
      } else if (direction === 'back' && currentQuestionIndex > 0) {
          currentQuestionIndex--;
      }
      
      if (currentQuestionIndex >= questions.length) {
          calculateFinalScore();
          showFinalResult();
      } else {
          renderQuestion();
      }
  }

  nextButton.addEventListener('click', function() {
      if (currentQuestionIndex === questions.length - 1) {
          saveCurrentAnswer();
          calculateFinalScore();
          showFinalResult();
      } else {
          saveAnswerAndMove('next');
      }
  });

  backButton.addEventListener('click', function() {
      saveAnswerAndMove('back');
  });

  function calculateFinalScore() {
      score = 0;
      userAnswers.forEach(answer => {
          if (answer && answer.isCorrect) {
              score++;
          }
      });
  }

  function formatDuration(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;

      const minPart = minutes > 0 ? `${minutes} minute${minutes !== 1 ? 's' : ''}` : "";
      const secPart = `${seconds} second${seconds !== 1 ? 's' : ''}`;

      return minPart ? `${minPart} ${secPart}` : secPart;
  }

  function saveResultsToFile() {
      const now = new Date();
      const timestampForFile = now.toISOString().replace(/[:.]/g, '-');
      const safeName = studentName.replace(/\s+/g, '_') || 'Student';
      const filename = `Homework_y5_1_Result_${safeName}_${timestampForFile}.txt`;

      let content = '';
      content += 'Y5 H1 Assessment Result\n';
      content += '--------------------------------------\n\n';
      content += 'Student: ' + studentName + '\n';
      content += 'Start Time: ' + (quizStartTime ? quizStartTime.toLocaleString() : 'N/A') + '\n';
      content += 'Submit Time: ' + (quizEndTime ? quizEndTime.toLocaleString() : now.toLocaleString()) + '\n';
      content += 'Score: ' + score + ' / ' + questions.length + '\n\n';
      content += 'Detailed Breakdown:\n\n';

      questions.forEach((q, index) => {
          const defaultCorrect = parseAnswerString(answers[index]);
          const result = userAnswers[index] || {
              userChoices: [],
              correctAnswers: defaultCorrect,
              isCorrect: false
          };
          const userChoices = result.userChoices || [];
          const correctAnswers = result.correctAnswers || defaultCorrect;

          const userChoiceText = userChoices.length > 0
              ? userChoices.map(k => k + '. ' + (q.options[k] || '')).join(' ; ')
              : 'Skipped';

          const correctAnswerText = correctAnswers.length > 0
              ? correctAnswers.map(k => k + '. ' + (q.options[k] || '')).join(' ; ')
              : '(None)';

          const resultText = result.isCorrect ? 'Correct' : 'Incorrect';

          content += 'Q' + (index + 1) + ':\n';
          content += 'Your answer: ' + userChoiceText + '\n';
          content += 'Correct answer: ' + correctAnswerText + '\n';
          content += 'Result: ' + resultText + '\n\n';
      });

      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
  }

  function showFinalResult() {
      quizEndTime = new Date();

      const endTimeStr = quizEndTime.toLocaleTimeString();
      const startTimeStr = quizStartTime ? quizStartTime.toLocaleTimeString() : 'N/A';
      let durationStr = "";
      if (quizStartTime) {
          const diffMs = quizEndTime - quizStartTime;
          durationStr = formatDuration(diffMs);
      }

      // 不改 currentQuestionIndex，方便再点左边跳回题目
      renderQuestionNav();

      let reviewHTML = ''
          + '<div id="studentInfo">'
          + '  <strong>Student Name:</strong> ' + studentName + '<br>'
          + '  <strong>Start Time:</strong> ' + startTimeStr + '<br>'
          + '  <strong>Submit Time:</strong> ' + endTimeStr
          + '</div>'
          + '<div id="finalResult">'
          + '  <p>You have finished all ' + questions.length + ' questions.</p>'
          + '  <p>Your final score is: <strong>' + score + ' / ' + questions.length + '</strong></p>'
          + (quizStartTime ? ('<p>Time taken: <strong>' + durationStr + '</strong></p>') : '')
          + '</div>'
          + '<h3>Detailed Review</h3>'
          + '<table class="review-table">'
          + '  <thead>'
          + '    <tr>'
          + '      <th>#</th>'
          + '      <th>Your Answer</th>'
          + '      <th>Correct Answer</th>'
          + '      <th>Result</th>'
          + '    </tr>'
          + '  </thead>'
          + '  <tbody>';

      questions.forEach((q, index) => {
          const defaultCorrect = parseAnswerString(answers[index]);
          const result = userAnswers[index] || {
              userChoices: [],
              correctAnswers: defaultCorrect,
              isCorrect: false
          };
          const userChoices = result.userChoices || [];
          const correctAnswers = result.correctAnswers || defaultCorrect;

          const userChoiceText = userChoices.length > 0
              ? userChoices.map(k => k + '. ' + (q.options[k] || '')).join(' ; ')
              : '— Skipped —';

          const correctAnswerText = correctAnswers.length > 0
              ? correctAnswers.map(k => k + '. ' + (q.options[k] || '')).join(' ; ')
              : '(None)';

          const resultClass = result.isCorrect ? 'correct-answer' : 'incorrect-answer';
          const resultText = result.isCorrect ? 'Correct' : 'Incorrect';

          reviewHTML += ''
              + '<tr>'
              + '  <td>Q' + (index + 1) + '</td>'
              + '  <td>' + userChoiceText + '</td>'
              + '  <td class="' + (result.isCorrect ? '' : 'correct-answer') + '">' + correctAnswerText + '</td>'
              + '  <td class="' + resultClass + '">' + resultText + '</td>'
              + '</tr>';
      });
          
      reviewHTML += ''
          + '  </tbody>'
          + '</table>'
          + '<button id="saveResultsButton">Save Results</button>';
      
      quizContent.innerHTML = reviewHTML;
      nextButton.style.display = 'none';
      backButton.style.display = 'none';

      const saveBtn = document.getElementById('saveResultsButton');
      if (saveBtn) {
          saveBtn.addEventListener('click', saveResultsToFile);
      }
  }

  // --- Start Screen Logic ---
  function showStartScreen() {
      nextButton.style.display = 'none';
      backButton.style.display = 'none';

      // 开始界面不显示左侧题号表
      if (questionNav) {
          questionNav.innerHTML = '';
      }

      quizContent.innerHTML = ''
          + '<div id="startScreen">'
          + '  <p class="question-text">'
          + '      Welcome to the Math Assessment! This test has ' + questions.length + ' questions.<br>'
          + '      Each question can have one or more correct answers (multi-select).<br>'
          + '      You can use the "Previous" button or left question list to review and change your answers.<br>'
          + '      Please enter your name to begin.'
          + '  </p>'
          + '  <label for="nameInput">Name:</label>'
          + '  <input type="text" id="nameInput" placeholder="Enter your name here" required>'
          + '  <button id="startButton">Start Quiz</button>'
          + '</div>';
      
      document.getElementById('startButton').addEventListener('click', startQuiz);
  }

  function startQuiz() {
      const nameInput = document.getElementById('nameInput').value.trim();
      
      if (nameInput) {
          studentName = nameInput;
      } else {
          studentName = "DYAA";
      }
      quizStartTime = new Date();
      quizEndTime = null;
      
      userAnswers = Array(questions.length).fill(null);
      selectedAnswers = new Set();

      currentQuestionIndex = 0;
      renderQuestion();
  }

  // 初始化：显示开始页面
  showStartScreen();
</script>

</body>
</html>
