<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Negative Numbers Quiz (Integer / Decimal Mode)</title>

  <style>
    body{
      font-family:'Segoe UI', Tahoma, sans-serif;
      background:#f4f4f9;
      margin:0; padding:20px;
      color:#333;
    }
    .quiz-container{
      max-width:900px;
      margin:40px auto;
      background:#fff;
      padding:30px;
      border-radius:12px;
      box-shadow:0 6px 15px rgba(0,0,0,0.1);
    }
    #headerLogo{
      display:flex; align-items:center;
      margin-bottom:10px;
      border-bottom:2px solid #e0e0e0;
      padding-bottom:10px;
    }
    .logo-icon{
      width:40px; height:40px;
      background:#0d47a1; border-radius:4px;
    }
    .logo-text span.edu{
      font-size:0.9em;
      color:#ff9800;
      font-weight:700;
      margin-left:10px;
      letter-spacing:0.5px;
    }
    .top-bar{ display:flex; justify-content:flex-end; margin-bottom:10px; }

    .quiz-main{ display:flex; gap:20px; }
    .sidebar{
      width:190px;
      border-right:1px solid #ddd;
      padding-right:10px;
      display:none;
    }
    .sidebar h4{
      margin:0 0 8px;
      font-size:0.95em;
      border-bottom:1px solid #eee;
      padding-bottom:4px;
    }
    .sidebar ul{ list-style:none; padding:0; margin:0; }
    .sidebar li{
      padding:6px;
      cursor:pointer;
      border-radius:4px;
      font-size:0.9em;
      user-select:none;
    }
    .sidebar li.active{ outline:2px solid #1976d2; font-weight:600; }

    .sidebar li.answered{ border-left:4px solid #4caf50; }
    .sidebar li.correct{ background:#d4edda; border-left:4px solid #28a745; }
    .sidebar li.incorrect{ background:#f8d7da; border-left:4px solid #f44336; }

    #quizContent{ flex:1; }
    .question-text{ font-size:1.1em; margin-bottom:8px; }
    .instructions{ font-size:0.9em; color:#555; margin-bottom:12px; }
    .part-title{ font-weight:700; margin-bottom:8px; }

    .single-question{
      margin-top:6px; margin-bottom:6px;
      line-height:1.5;
    }
    .answer-box{
      width:180px;
      padding:6px;
      font-size:1em;
      margin-left:8px;
    }

    .hint-box{
      margin-top:10px;
      padding:10px 12px;
      background:#f7f7ff;
      border:1px solid #e6e6ff;
      border-radius:8px;
      font-size:0.92em;
      color:#444;
    }
    .hint-box b{ color:#111; }

    .check-feedback{
      margin-top:12px;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #e0e0e0;
      background:#fafafa;
      font-size:0.95em;
      display:none;
      white-space:pre-wrap;
    }
    .check-feedback.neutral{ display:block; background:#f6f7fb; border-color:#e2e6ff; }
    .check-feedback.correct{ display:block; background:#d4edda; border-color:#28a745; }
    .check-feedback.incorrect{ display:block; background:#f8d7da; border-color:#f44336; }

    .question-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:18px;
      align-items:center;
    }
    .question-buttons button{
      padding:10px 18px;
      border:none;
      color:#fff;
      border-radius:6px;
      cursor:pointer;
      font-size:1em;
    }
    #nextButton{ background:#4caf50; }
    #backButton{ background:#039be5; }
    #submitButton{ background:#9c27b0; }
    #saveButton{ background:#607d8b; }
    #redoButton{ background:#e65100; }
    #exitRedoButton{ background:#455a64; }
    #checkButton{ background:#00897b; }
    #backToQuestionsButton{ background:#455a64; opacity:1; }

    table.review-table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
    }
    .review-table th, .review-table td{
      border:1px solid #ccc;
      padding:6px;
      font-size:0.85em;
      text-align:center;
      vertical-align:top;
    }
    .review-table th{ background:#f2f2f2; }
    .correct-answer{ background:#d4edda; }
    .incorrect-answer{ background:#f8d7da; }

    .mode-badge{
      display:inline-block;
      margin-left:8px;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.85em;
      background:#eef2ff;
      border:1px solid #dfe5ff;
      color:#333;
    }

    @media (max-width:700px){
      .quiz-main{ flex-direction:column; }
      .sidebar{
        width:100%;
        border-right:none;
        border-bottom:1px solid #ddd;
        margin-bottom:10px;
        padding-bottom:10px;
      }
      .answer-box{ width:160px; }
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text"><span class="edu">EDUCATION</span></div>
  </div>

  <div class="top-bar">
    <button id="generateButton"
      style="display:none; padding:10px 18px; border:none; color:#fff; border-radius:6px; cursor:pointer; background:#ff9800; font-size:1em;">
      Generate New Set
    </button>
  </div>

  <h2>Negative Numbers Quiz <span id="modeBadge" class="mode-badge" style="display:none;"></span></h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>
</div>

<script>
/* ----------------------------------------------------------
   MODE
---------------------------------------------------------- */
let MODE = "integer"; // "integer" | "decimal"

/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */
const PART_TITLES = [
  "Part 1. Operations with negative numbers ( + , − , × , ÷ )",
  "Part 2. Mixed operations with negatives (may include brackets)",
  "Part 3. Common real-life word problems with negatives"
];
const QUESTIONS_PER_PART = [12, 6, 6];
const TOTAL_QUESTIONS = QUESTIONS_PER_PART.reduce((a,b)=>a+b,0);

/* ----------------------------------------------------------
   Read student name from URL: ?name=Amber
---------------------------------------------------------- */
function getStudentNameFromURL(){
  try{
    const params = new URLSearchParams(window.location.search || "");
    const raw = params.get("name");
    if (!raw) return "";
    return decodeURIComponent(raw.replace(/\+/g, "%20")).trim();
  }catch(e){
    return "";
  }
}
const URL_STUDENT_NAME = getStudentNameFromURL();

/* ----------------------------------------------------------
   Utilities
---------------------------------------------------------- */
function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
function choice(arr){ return arr[randInt(0, arr.length - 1)]; }
function fmtMinus(nStr){ return String(nStr).replace(/-/g, "−"); }
function roundTo(x, dp){
  const f = Math.pow(10, dp);
  return Math.round(x * f) / f;
}
function showNumberInt(x){ return fmtMinus(String(Math.trunc(x))); }
function showNumberDec(x, dp){ return fmtMinus(roundTo(x, dp).toFixed(dp)); }
function nearlyEqual(a, b, eps = 1e-6){
  if (!Number.isFinite(a) || !Number.isFinite(b)) return false;
  return Math.abs(a - b) < eps;
}
function parseAnswer(str){
  let s = (str || "").trim();
  if (s === "") return NaN;
  s = s.replace(/−/g, "-");
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* ----------------------------------------------------------
   Decimal makers
---------------------------------------------------------- */
function makeDecimalNonZero(dp, minAbs=0.2, maxAbs=9.9){
  const scale = dp === 1 ? 10 : 100;
  const minTick = Math.ceil(minAbs * scale);
  const maxTick = Math.floor(maxAbs * scale);
  let t = 0;
  while(t === 0){
    t = randInt(minTick, maxTick);
    if (Math.random() < 0.5) t = -t;
  }
  return t / scale;
}

/* ----------------------------------------------------------
   Exact decimal division (dividend & divisor: 1 or 2 dp, always exact)
---------------------------------------------------------- */
function generateExactDecimalDivision(signType){
  const dpDivisor = (Math.random() < 0.5) ? 1 : 2;
  const scaleD = dpDivisor === 1 ? 10 : 100;

  const dpDividendPick = (Math.random() < 0.5) ? 1 : 2;
  let scaleA = dpDividendPick === 1 ? 10 : 100;

  if (scaleA < scaleD) scaleA = scaleD;
  const dpDividend = (scaleA === 10) ? 1 : 2;

  const qInt = randInt(2, 30);
  const dInt = randInt(2, 50);

  let divisor  = dInt / scaleD;
  let dividend = (dInt * qInt) / scaleA;
  let value    = qInt * (scaleD / scaleA);
  value = roundTo(value, 2);

  if (signType === "pn"){ divisor = -divisor; value = -value; }
  if (signType === "np"){ dividend = -dividend; value = -value; }
  if (signType === "nn"){ dividend = -dividend; divisor = -divisor; }

  const text = `${showNumberDec(dividend, dpDividend)} ÷ ${showNumberDec(divisor, dpDivisor)}`;
  const dpV = Number.isInteger(value) ? 0 : (Math.abs(value*10 - Math.round(value*10))<1e-9 ? 1 : 2);
  return { text, value, display: showNumberDec(value, dpV) };
}

/* ----------------------------------------------------------
   Part 1: 12 sign cases (integer or decimal)
---------------------------------------------------------- */
function generatePart1Questions(){
  const cases = [
    "add_neg_neg","add_neg_pos","add_pos_neg",
    "sub_neg_neg","sub_neg_pos","sub_pos_neg",
    "mul_neg_neg","mul_neg_pos","mul_pos_neg",
    "div_neg_neg","div_neg_pos","div_pos_neg"
  ];
  const shuffled = shuffle(cases);

  return shuffled.map(type => {
    if (MODE === "integer"){
      const m1 = randInt(2, 20);
      const m2 = randInt(2, 20);
      let a,b,value,text;

      switch(type){
        case "add_neg_neg": a=-m1; b=-m2; value=a+b; text=`${showNumberInt(a)} + ${showNumberInt(b)}`; break;
        case "add_neg_pos": a=-m1; b= m2; value=a+b; text=`${showNumberInt(a)} + ${showNumberInt(b)}`; break;
        case "add_pos_neg": a= m1; b=-m2; value=a+b; text=`${showNumberInt(a)} + ${showNumberInt(b)}`; break;

        case "sub_neg_neg": a=-m1; b=-m2; value=a-b; text=`${showNumberInt(a)} − ${showNumberInt(b)}`; break;
        case "sub_neg_pos": a=-m1; b= m2; value=a-b; text=`${showNumberInt(a)} − ${showNumberInt(b)}`; break;
        case "sub_pos_neg": a= m1; b=-m2; value=a-b; text=`${showNumberInt(a)} − ${showNumberInt(b)}`; break;

        case "mul_neg_neg": a=-m1; b=-m2; value=a*b; text=`${showNumberInt(a)} × ${showNumberInt(b)}`; break;
        case "mul_neg_pos": a=-m1; b= m2; value=a*b; text=`${showNumberInt(a)} × ${showNumberInt(b)}`; break;
        case "mul_pos_neg": a= m1; b=-m2; value=a*b; text=`${showNumberInt(a)} × ${showNumberInt(b)}`; break;

        case "div_neg_neg": { const q=randInt(2,9), d=randInt(2,9); a=-(q*d); b=-d; value=q;  text=`${showNumberInt(a)} ÷ ${showNumberInt(b)}`; break; }
        case "div_neg_pos": { const q=randInt(2,9), d=randInt(2,9); a=-(q*d); b= d; value=-q; text=`${showNumberInt(a)} ÷ ${showNumberInt(b)}`; break; }
        case "div_pos_neg": { const q=randInt(2,9), d=randInt(2,9); a= (q*d); b=-d; value=-q; text=`${showNumberInt(a)} ÷ ${showNumberInt(b)}`; break; }
      }
      return { text, value, display: showNumberInt(value), userValue:"", isCorrect:false, partIndex:0, indexInPart:0 };
    }

    if (type.startsWith("div_")){
      const signType = (type === "div_neg_neg") ? "nn" : (type === "div_neg_pos" ? "np" : "pn");
      const out = generateExactDecimalDivision(signType);
      return { text: out.text, value: out.value, display: out.display, userValue:"", isCorrect:false, partIndex:0, indexInPart:0 };
    }

    const dpA = Math.random() < 0.5 ? 1 : 2;
    const dpB = Math.random() < 0.5 ? 1 : 2;
    const m1 = makeDecimalNonZero(dpA, 0.2, 9.9);
    const m2 = makeDecimalNonZero(dpB, 0.2, 9.9);
    const abs1 = Math.abs(m1), abs2 = Math.abs(m2);

    let a,b,value,text;
    if (type === "add_neg_neg"){ a=-abs1; b=-abs2; value=a+b; text=`${showNumberDec(a,dpA)} + ${showNumberDec(b,dpB)}`; }
    if (type === "add_neg_pos"){ a=-abs1; b= abs2; value=a+b; text=`${showNumberDec(a,dpA)} + ${showNumberDec(b,dpB)}`; }
    if (type === "add_pos_neg"){ a= abs1; b=-abs2; value=a+b; text=`${showNumberDec(a,dpA)} + ${showNumberDec(b,dpB)}`; }

    if (type === "sub_neg_neg"){ a=-abs1; b=-abs2; value=a-b; text=`${showNumberDec(a,dpA)} − ${showNumberDec(b,dpB)}`; }
    if (type === "sub_neg_pos"){ a=-abs1; b= abs2; value=a-b; text=`${showNumberDec(a,dpA)} − ${showNumberDec(b,dpB)}`; }
    if (type === "sub_pos_neg"){ a= abs1; b=-abs2; value=a-b; text=`${showNumberDec(a,dpA)} − ${showNumberDec(b,dpB)}`; }

    if (type === "mul_neg_neg"){ a=-abs1; b=-abs2; value=a*b; text=`${showNumberDec(a,dpA)} × ${showNumberDec(b,dpB)}`; }
    if (type === "mul_neg_pos"){ a=-abs1; b= abs2; value=a*b; text=`${showNumberDec(a,dpA)} × ${showNumberDec(b,dpB)}`; }
    if (type === "mul_pos_neg"){ a= abs1; b=-abs2; value=a*b; text=`${showNumberDec(a,dpA)} × ${showNumberDec(b,dpB)}`; }

    value = roundTo(value, 2);
    const dpV = Number.isInteger(value) ? 0 : (Math.abs(value*10 - Math.round(value*10))<1e-9 ? 1 : 2);
    return { text, value, display: showNumberDec(value, dpV), userValue:"", isCorrect:false, partIndex:0, indexInPart:0 };
  });
}

/* ----------------------------------------------------------
   Part 2
---------------------------------------------------------- */
function genPart2(){
  if (MODE === "integer"){
    const a = randInt(-25, 25) || -8;
    const b = randInt(-25, 25) || 7;
    const c = randInt(-12, 12) || -6;
    const d = randInt(2, 9);

    const templates = [
      () => ({ text:`(${showNumberInt(a)} + ${showNumberInt(b)}) × ${showNumberInt(c)}`, value:(a+b)*c }),
      () => ({ text:`${showNumberInt(a)} + (${showNumberInt(b)} × ${showNumberInt(c)})`, value:a + (b*c) }),
      () => ({ text:`${showNumberInt(a)} − (${showNumberInt(b)} + ${showNumberInt(c)})`, value:a - (b+c) }),
      () => ({ text:`(${showNumberInt(a)} − ${showNumberInt(b)}) − ${showNumberInt(c)}`, value:(a-b)-c }),
      () => ({ text:`(${showNumberInt(a)} × ${showNumberInt(b)}) + ${showNumberInt(c)}`, value:(a*b)+c }),
      () => {
        const q = randInt(-12, 12) || 6;
        const dividend = q * d;
        return { text:`(${showNumberInt(dividend)}) ÷ ${showNumberInt(d)}`, value: q };
      }
    ];
    const out = choice(templates)();
    return { text: out.text, value: out.value, display: showNumberInt(out.value) };
  }

  const dpA = Math.random()<0.5?1:2;
  const dpB = Math.random()<0.5?1:2;
  const dpC = Math.random()<0.5?1:2;

  const a = makeDecimalNonZero(dpA, 0.2, 9.9);
  const b = makeDecimalNonZero(dpB, 0.2, 9.9);
  const c = makeDecimalNonZero(dpC, 0.2, 9.9);

  const templates = [
    () => ({ text:`(${showNumberDec(a,dpA)} + ${showNumberDec(b,dpB)}) × ${showNumberDec(c,dpC)}`, value: roundTo((a+b)*c,2) }),
    () => ({ text:`${showNumberDec(a,dpA)} − (${showNumberDec(b,dpB)} × ${showNumberDec(c,dpC)})`, value: roundTo(a - (b*c),2) }),
    () => ({ text:`(${showNumberDec(a,dpA)} − ${showNumberDec(b,dpB)}) − ${showNumberDec(c,dpC)}`, value: roundTo((a-b)-c,2) }),
    () => ({ text:`${showNumberDec(a,dpA)} + ${showNumberDec(b,dpB)} − ${showNumberDec(c,dpC)}`, value: roundTo(a + b - c,2) }),
    () => {
      const signType = choice(["pp","pn","np","nn"]);
      const out = generateExactDecimalDivision(signType);
      return { text:`(${out.text})`, value: out.value };
    }
  ];
  const out = choice(templates)();
  const dpV = Number.isInteger(out.value) ? 0 : (Math.abs(out.value*10 - Math.round(out.value*10))<1e-9 ? 1 : 2);
  return { text: out.text, value: out.value, display: showNumberDec(out.value, dpV) };
}

/* ----------------------------------------------------------
   Part 3: UNIQUE scenarios per quiz (NO repeats)
---------------------------------------------------------- */
function buildUniquePart3Questions(count){
  if (MODE === "integer"){
    const gens = [
      () => { const start = randInt(-12, 8), down = randInt(2, 10), up = randInt(2, 12); const val = start - down + up;
        return { text:`Temperature was ${showNumberInt(start)}°C. It dropped by ${showNumberInt(down)}°C, then rose by ${showNumberInt(up)}°C. What is the final temperature (°C)?`, value:val, display:showNumberInt(val) }; },
      () => { const start = randInt(-50, 80), spend = randInt(10, 60), dep = randInt(10, 80); const val = start - spend + dep;
        return { text:`A bank account balance is $${showNumberInt(start)}. You spend $${showNumberInt(spend)}, then deposit $${showNumberInt(dep)}. What is the new balance?`, value:val, display:showNumberInt(val) }; },
      () => { const start = randInt(-3, 8), up = randInt(2, 10), down = randInt(2, 12); const val = start + up - down;
        return { text:`An elevator starts at floor ${showNumberInt(start)}. It goes up ${showNumberInt(up)} floors, then down ${showNumberInt(down)} floors. What floor does it end on?`, value:val, display:showNumberInt(val) }; },
      () => { const start = randInt(-40, 30), dive = randInt(10, 60), rise = randInt(5, 40); const val = start - dive + rise;
        return { text:`A diver is at ${showNumberInt(start)} m relative to sea level. They dive ${showNumberInt(dive)} m deeper, then rise ${showNumberInt(rise)} m. What is their final position (m)?`, value:val, display:showNumberInt(val) }; },
      () => { const start = randInt(-10, 50), change1 = randInt(-20, 20) || -7, change2 = randInt(-20, 20) || 9; const val = start + change1 + change2;
        return { text:`A stock starts at ${showNumberInt(start)} points. It changes by ${showNumberInt(change1)} points, then by ${showNumberInt(change2)} points. What is the final value (points)?`, value:val, display:showNumberInt(val) }; },
      () => { const start = randInt(-20, 30), gain = randInt(5, 25), loss = randInt(5, 25); const val = start + gain - loss;
        return { text:`A team's score is ${showNumberInt(start)}. They gain ${showNumberInt(gain)} points, then lose ${showNumberInt(loss)} points. What is the new score?`, value:val, display:showNumberInt(val) }; },
      () => { const start = randInt(-200, 800), up = randInt(50, 400), down = randInt(50, 400); const val = start + up - down;
        return { text:`A hiker starts at ${showNumberInt(start)} m. They climb ${showNumberInt(up)} m, then descend ${showNumberInt(down)} m. What is the final altitude (m)?`, value:val, display:showNumberInt(val) }; },
      () => { const start = randInt(-30, -5), open = randInt(2, 10), cool = randInt(2, 12); const val = start + open - cool;
        return { text:`A freezer is at ${showNumberInt(start)}°C. After the door is opened, the temperature rises by ${showNumberInt(open)}°C, then cools down by ${showNumberInt(cool)}°C. What is the final temperature (°C)?`, value:val, display:showNumberInt(val) }; }
    ];
    return shuffle(gens).slice(0, count).map(fn => fn());
  }

  const gens = [
    () => { const dpS=Math.random()<0.5?1:2, dpX=Math.random()<0.5?1:2, dpY=Math.random()<0.5?1:2;
      const start=makeDecimalNonZero(dpS,0.2,12.0), down=Math.abs(makeDecimalNonZero(dpX,0.2,8.0)), up=Math.abs(makeDecimalNonZero(dpY,0.2,9.0));
      const val=roundTo(start-down+up,2); const dpV=Number.isInteger(val)?0:(Math.abs(val*10-Math.round(val*10))<1e-9?1:2);
      return { text:`Temperature was ${showNumberDec(start,dpS)}°C. It dropped by ${showNumberDec(down,dpX)}°C, then rose by ${showNumberDec(up,dpY)}°C. What is the final temperature (°C)?`, value:val, display:showNumberDec(val,dpV) }; },
    () => { const dpS=Math.random()<0.5?1:2, dpX=Math.random()<0.5?1:2, dpY=Math.random()<0.5?1:2;
      const start=makeDecimalNonZero(dpS,0.2,120.0), spend=Math.abs(makeDecimalNonZero(dpX,0.2,60.0)), dep=Math.abs(makeDecimalNonZero(dpY,0.2,80.0));
      const val=roundTo(start-spend+dep,2); const dpV=Number.isInteger(val)?0:(Math.abs(val*10-Math.round(val*10))<1e-9?1:2);
      return { text:`A bank account balance is $${showNumberDec(start,dpS)}. You spend $${showNumberDec(spend,dpX)}, then deposit $${showNumberDec(dep,dpY)}. What is the new balance?`, value:val, display:showNumberDec(val,dpV) }; },
    () => { const dpS=Math.random()<0.5?1:2, dpX=Math.random()<0.5?1:2, dpY=Math.random()<0.5?1:2;
      const start=makeDecimalNonZero(dpS,0.2,10.0), up=Math.abs(makeDecimalNonZero(dpX,0.2,10.0)), down=Math.abs(makeDecimalNonZero(dpY,0.2,12.0));
      const val=roundTo(start+up-down,2); const dpV=Number.isInteger(val)?0:(Math.abs(val*10-Math.round(val*10))<1e-9?1:2);
      return { text:`An elevator starts at floor ${showNumberDec(start,dpS)}. It goes up ${showNumberDec(up,dpX)} floors, then down ${showNumberDec(down,dpY)} floors. What floor does it end on?`, value:val, display:showNumberDec(val,dpV) }; },
    () => { const dpS=Math.random()<0.5?1:2, dpX=Math.random()<0.5?1:2, dpY=Math.random()<0.5?1:2;
      const start=makeDecimalNonZero(dpS,0.2,60.0), dive=Math.abs(makeDecimalNonZero(dpX,0.2,50.0)), rise=Math.abs(makeDecimalNonZero(dpY,0.2,45.0));
      const val=roundTo(start-dive+rise,2); const dpV=Number.isInteger(val)?0:(Math.abs(val*10-Math.round(val*10))<1e-9?1:2);
      return { text:`A diver is at ${showNumberDec(start,dpS)} m relative to sea level. They dive ${showNumberDec(dive,dpX)} m deeper, then rise ${showNumberDec(rise,dpY)} m. What is their final position (m)?`, value:val, display:showNumberDec(val,dpV) }; },
    () => { const dpS=Math.random()<0.5?1:2, dpX=Math.random()<0.5?1:2, dpY=Math.random()<0.5?1:2;
      const start=makeDecimalNonZero(dpS,0.2,80.0), used=Math.abs(makeDecimalNonZero(dpX,0.2,40.0)), add=Math.abs(makeDecimalNonZero(dpY,0.2,50.0));
      const val=roundTo(start-used+add,2); const dpV=Number.isInteger(val)?0:(Math.abs(val*10-Math.round(val*10))<1e-9?1:2);
      return { text:`A fuel tank has ${showNumberDec(start,dpS)} L. It uses ${showNumberDec(used,dpX)} L, then adds ${showNumberDec(add,dpY)} L. How much fuel is now in the tank (L)?`, value:val, display:showNumberDec(val,dpV) }; },
    () => { const dp=Math.random()<0.5?1:2;
      const p1=makeDecimalNonZero(dp,0.2,80.0), p2=makeDecimalNonZero(dp,0.2,80.0), p3=makeDecimalNonZero(dp,0.2,80.0);
      const val=roundTo(p1+p2+p3,2); const dpV=Number.isInteger(val)?0:(Math.abs(val*10-Math.round(val*10))<1e-9?1:2);
      return { text:`A shop's profit/loss over 3 days is: Day 1 = $${showNumberDec(p1,dp)}, Day 2 = $${showNumberDec(p2,dp)}, Day 3 = $${showNumberDec(p3,dp)}. (Negative means a loss.) What is the total profit/loss?`, value:val, display:showNumberDec(val,dpV) }; },
    () => { const dpS=Math.random()<0.5?1:2, dpX=Math.random()<0.5?1:2, dpY=Math.random()<0.5?1:2;
      const start=makeDecimalNonZero(dpS,0.2,800.0), up=Math.abs(makeDecimalNonZero(dpX,0.2,400.0)), down=Math.abs(makeDecimalNonZero(dpY,0.2,400.0));
      const val=roundTo(start+up-down,2); const dpV=Number.isInteger(val)?0:(Math.abs(val*10-Math.round(val*10))<1e-9?1:2);
      return { text:`A hiker starts at ${showNumberDec(start,dpS)} m. They climb ${showNumberDec(up,dpX)} m, then descend ${showNumberDec(down,dpY)} m. What is the final altitude (m)?`, value:val, display:showNumberDec(val,dpV) }; },
    () => { const dpS=Math.random()<0.5?1:2, dpX=Math.random()<0.5?1:2, dpY=Math.random()<0.5?1:2;
      const start=makeDecimalNonZero(dpS,0.2,30.0), gain=Math.abs(makeDecimalNonZero(dpX,0.2,25.0)), loss=Math.abs(makeDecimalNonZero(dpY,0.2,25.0));
      const val=roundTo(start+gain-loss,2); const dpV=Number.isInteger(val)?0:(Math.abs(val*10-Math.round(val*10))<1e-9?1:2);
      return { text:`A team's score is ${showNumberDec(start,dpS)}. They gain ${showNumberDec(gain,dpX)} points, then lose ${showNumberDec(loss,dpY)} points. What is the new score?`, value:val, display:showNumberDec(val,dpV) }; }
  ];
  return shuffle(gens).slice(0, count).map(fn => fn());
}

/* ----------------------------------------------------------
   Data & state
---------------------------------------------------------- */
let questions = [];
let currentQuestionIndex = 0;
let studentName = "Student";
let quizStartTime = null;
let quizEndTime = null;
let quizSubmitted = false;

let isRedoMode = false;
let redoIndices = [];
let redoPos = 0;
let normalIndexBeforeRedo = 0;

const quizContent = document.getElementById("quizContent");
const sidebarEl   = document.getElementById("sidebar");
const generateBtn = document.getElementById("generateButton");
const modeBadge   = document.getElementById("modeBadge");

/* ----------------------------------------------------------
   Build quiz
---------------------------------------------------------- */
function generateQuiz(){
  questions = [];
  quizSubmitted = false;
  isRedoMode = false;
  redoIndices = [];
  redoPos = 0;
  quizEndTime = null;

  const part1 = generatePart1Questions();
  part1.forEach((q, i) => {
    q.partIndex = 0;
    q.indexInPart = i;
    questions.push(q);
  });

  for (let i = 0; i < QUESTIONS_PER_PART[1]; i++){
    const q = genPart2();
    questions.push({
      partIndex:1, indexInPart:i,
      text:q.text, value:q.value, display:q.display,
      userValue:"", isCorrect:false
    });
  }

  const uniquePart3 = buildUniquePart3Questions(QUESTIONS_PER_PART[2]);
  uniquePart3.forEach((q, i) => {
    questions.push({
      partIndex:2, indexInPart:i,
      text:q.text, value:q.value, display:q.display,
      userValue:"", isCorrect:false
    });
  });
}

/* ----------------------------------------------------------
   Sidebar
---------------------------------------------------------- */
function renderSidebar(){
  sidebarEl.style.display = "block";
  const title = isRedoMode ? `Redo (${redoIndices.length})` : "Questions";
  sidebarEl.innerHTML = `<h4>${title}</h4><ul id="qList"></ul>`;
  const ul = document.getElementById("qList");

  if (isRedoMode){
    redoIndices.forEach((realIdx, k) => {
      const q = questions[realIdx];
      const li = document.createElement("li");
      const partShort = ["P1","P2","P3"][q.partIndex];
      li.textContent = `Redo ${k + 1} (Q${realIdx + 1} ${partShort}-${q.indexInPart + 1})`;
      li.dataset.real = realIdx;
      li.dataset.k = k;
      li.addEventListener("click", () => {
        saveCurrentInput();
        redoPos = k;
        currentQuestionIndex = redoIndices[redoPos];
        renderQuestion();
      });
      ul.appendChild(li);
    });
  } else {
    for (let i = 0; i < TOTAL_QUESTIONS; i++){
      const q = questions[i];
      const li = document.createElement("li");
      const partShort = ["P1","P2","P3"][q.partIndex];
      li.textContent = `Q${i + 1} (${partShort}-${q.indexInPart + 1})`;
      li.dataset.index = i;
      li.addEventListener("click", () => {
        saveCurrentInput();
        currentQuestionIndex = i;
        renderQuestion();
      });
      ul.appendChild(li);
    }
  }
  updateSidebarStatus();
}

function updateSidebarStatus(){
  const items = document.querySelectorAll("#qList li");
  items.forEach(li => {
    li.classList.remove("active","answered","correct","incorrect");

    if (isRedoMode){
      const k = Number(li.dataset.k);
      const realIdx = Number(li.dataset.real);
      const q = questions[realIdx];
      li.classList.toggle("active", k === redoPos);
      const ans = (q.userValue || "").trim();
      if (ans !== "") li.classList.add(q.isCorrect ? "correct" : "incorrect");
      return;
    }

    const idx = Number(li.dataset.index);
    const q = questions[idx];

    if (!quizSubmitted){
      li.classList.toggle("active", idx === currentQuestionIndex);
      if ((q.userValue || "").trim() !== "") li.classList.add("answered");
    } else {
      const ans = (q.userValue || "").trim();
      if (ans !== "") li.classList.add(q.isCorrect ? "correct" : "incorrect");
    }
  });
}

/* ----------------------------------------------------------
   Save input
---------------------------------------------------------- */
function saveCurrentInput(){
  const input = document.getElementById("answerInput");
  if (input) questions[currentQuestionIndex].userValue = input.value.trim();
}

/* ----------------------------------------------------------
   Grade
---------------------------------------------------------- */
function gradeAll(){
  let correctCount = 0;
  const eps = 1e-6;
  questions.forEach(q => {
    const val = parseAnswer(q.userValue || "");
    q.isCorrect = Number.isFinite(val) && nearlyEqual(val, q.value, eps);
    if (q.isCorrect) correctCount++;
  });
  return correctCount;
}

/* ----------------------------------------------------------
   Redo check answer
---------------------------------------------------------- */
function checkAnswerRedo(){
  saveCurrentInput();
  const q = questions[currentQuestionIndex];
  const fb = document.getElementById("checkFeedback");
  if (!fb) return;

  const ans = (q.userValue || "").trim();
  if (ans === ""){
    fb.textContent = "Please enter an answer first.";
    fb.className = "check-feedback neutral";
    return;
  }

  const val = parseAnswer(ans);
  q.isCorrect = Number.isFinite(val) && nearlyEqual(val, q.value);

  if (q.isCorrect){
    fb.textContent = "✅ Correct!";
    fb.className = "check-feedback correct";
  } else {
    fb.textContent = `❌ Incorrect.\nCorrect answer: ${q.display}`;
    fb.className = "check-feedback incorrect";
  }

  updateSidebarStatus();
}

/* ----------------------------------------------------------
   Save TXT
---------------------------------------------------------- */
function formatDateForFilename(date){
  if (!date) return "no_time";
  const pad = n => String(n).padStart(2,"0");
  return (
    date.getFullYear() +
    pad(date.getMonth() + 1) +
    pad(date.getDate()) + "_" +
    pad(date.getHours()) +
    pad(date.getMinutes()) +
    pad(date.getSeconds())
  );
}

function saveCurrentResultAsTxt(){
  saveCurrentInput();
  if (!quizSubmitted) gradeAll();

  let correctCount = 0;
  questions.forEach(q => { if (q.isCorrect) correctCount++; });

  const lines = [];
  lines.push("Negative Numbers Quiz - Current Result");
  lines.push("Student: " + studentName);
  lines.push("Mode: " + (MODE === "integer" ? "Integer Mode" : "Decimal Mode (1–2 dp, exact division)"));
  if (quizStartTime) lines.push("Start time: " + quizStartTime.toLocaleString());
  if (quizEndTime)   lines.push("Last submit time: " + quizEndTime.toLocaleString());
  lines.push("Score: " + correctCount + " / " + TOTAL_QUESTIONS);
  lines.push("");
  lines.push("Details:");
  lines.push("----------");

  questions.forEach((q, i) => {
    const partLbl = ["P1","P2","P3"][q.partIndex] + "-" + (q.indexInPart + 1);
    const userAns = (q.userValue || "").trim() === "" ? "Not answered" : q.userValue;
    const resultText = (q.userValue || "").trim() === ""
      ? "Not answered"
      : (q.isCorrect ? "Correct" : "Incorrect");

    lines.push(
      `Q${i + 1} (${partLbl})` +
      "\nQuestion: " + q.text +
      "\nYour answer: " + userAns +
      "\nCorrect answer: " + q.display +
      "\nResult: " + resultText
    );
    lines.push("");
  });

  const content = lines.join("\n");
  const blob = new Blob([content], { type:"text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = studentName.replace(/[^a-z0-9_\-]/gi,"_") || "Student";
  const ts = formatDateForFilename(new Date());
  a.href = url;
  a.download = `Negatives_${safeName}_${MODE}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ----------------------------------------------------------
   Render Question
---------------------------------------------------------- */
function renderQuestion(){
  const q = questions[currentQuestionIndex];
  const partShort = ["P1","P2","P3"][q.partIndex];
  const fullLabel = `${partShort}-${q.indexInPart + 1}`;

  const topLine = isRedoMode
    ? `Redo ${redoPos + 1} of ${redoIndices.length} (Original Q${currentQuestionIndex + 1})`
    : `Question ${currentQuestionIndex + 1} of ${TOTAL_QUESTIONS}`;

  const hintHTML =
    q.partIndex === 0 ? `
      <div class="hint-box">
        <b>Quick sign rules:</b><br>
        • Same signs add: keep the sign, add the magnitudes.<br>
        • Different signs add: subtract magnitudes, keep the sign of the larger magnitude.<br>
        • a − b = a + (−b).<br>
        • × or ÷ : same signs → positive, different signs → negative.
      </div>
    ` :
    q.partIndex === 1 ? `
      <div class="hint-box">
        <b>Order of operations:</b> Brackets → ×/÷ → +/−.
      </div>
    ` : `
      <div class="hint-box">
        <b>Tip:</b> Translate the story into an equation, then calculate carefully with signs.
      </div>
    `;

  const showPrev = isRedoMode ? (redoPos > 0) : (currentQuestionIndex > 0);
  const showNext = isRedoMode ? (redoPos < redoIndices.length - 1) : (currentQuestionIndex < TOTAL_QUESTIONS - 1);

  const answerHelp = (MODE === "integer")
    ? `Enter an <b>integer</b> answer (negative allowed). Example: -7`
    : `Enter a <b>decimal</b> answer (negative allowed). Example: -2.4`;

  quizContent.innerHTML = `
    <p class="question-text">${topLine}</p>
    <p class="instructions">${answerHelp}</p>

    <div class="part-title">${PART_TITLES[q.partIndex]}</div>

    <div class="single-question">
      <span>${fullLabel}.</span>
      <span>${q.text}</span>
      <input id="answerInput" class="answer-box" type="text" value="${(q.userValue || "").replace(/"/g,'&quot;')}">
    </div>

    ${hintHTML}

    <div id="checkFeedback" class="check-feedback"></div>

    <div class="question-buttons">
      <button id="backButton" style="${showPrev ? "" : "display:none;"}">Previous</button>
      ${isRedoMode ? `<button id="checkButton">Check Answer</button>` : ``}
      <button id="submitButton">Submit &amp; View Results</button>
      <button id="nextButton" style="${showNext ? "" : "display:none;"}">Next</button>
      ${(!isRedoMode && quizSubmitted) ? `<button id="redoButton">Redo (Wrong + Unanswered)</button>` : ``}
      ${isRedoMode ? `<button id="exitRedoButton">Exit Redo</button>` : ``}
      ${(quizSubmitted && !isRedoMode) ? `<button id="saveButton">Save Current Result</button>` : ``}
    </div>
  `;

  document.getElementById("nextButton")?.addEventListener("click", onNext);
  document.getElementById("backButton")?.addEventListener("click", onPrev);
  document.getElementById("submitButton")?.addEventListener("click", onSubmit);
  document.getElementById("saveButton")?.addEventListener("click", saveCurrentResultAsTxt);
  document.getElementById("redoButton")?.addEventListener("click", enterRedoMode);
  document.getElementById("exitRedoButton")?.addEventListener("click", exitRedoMode);
  document.getElementById("checkButton")?.addEventListener("click", checkAnswerRedo);

  updateSidebarStatus();
}

/* ----------------------------------------------------------
   Results
---------------------------------------------------------- */
function renderResults(){
  const correctCount = gradeAll();

  let timeInfo = "";
  if (quizStartTime && quizEndTime){
    const diffSec = Math.floor((quizEndTime - quizStartTime) / 1000);
    const min = Math.floor(diffSec / 60);
    const sec = diffSec % 60;
    timeInfo = `
      <p>Start time: <strong>${quizStartTime.toLocaleTimeString()}</strong></p>
      <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
      <p>Time taken: <strong>${min}m ${sec}s</strong></p>
    `;
  }

  let html = `
    <h3>Results for ${studentName}</h3>
    <p>Mode: <strong>${MODE === "integer" ? "Integer Mode" : "Decimal Mode (1–2 dp, exact division)"}</strong></p>
    <p>Score: <strong>${correctCount} / ${TOTAL_QUESTIONS}</strong></p>
    ${timeInfo}
    <p>You can click any question on the left to review. Use <b>Redo (Wrong + Unanswered)</b> to practise.</p>

    <table class="review-table">
      <tr>
        <th>#</th>
        <th>Part</th>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct</th>
        <th>Result</th>
      </tr>
  `;

  questions.forEach((q, i) => {
    const partLbl = ["P1","P2","P3"][q.partIndex] + "-" + (q.indexInPart + 1);
    const yourAns = (q.userValue || "").trim() === "" ? "—" : q.userValue;
    html += `
      <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
        <td>${i + 1}</td>
        <td>${partLbl}</td>
        <td style="text-align:left;">${q.text}</td>
        <td>${yourAns}</td>
        <td>${q.display}</td>
        <td>${q.isCorrect ? "Correct" : "Incorrect"}</td>
      </tr>
    `;
  });
  html += `</table>`;

  html += `
    <div class="question-buttons">
      <button id="redoButton">Redo (Wrong + Unanswered)</button>
      <button id="saveButton">Save Current Result</button>
      <button id="backToQuestionsButton">Back to Questions</button>
    </div>
  `;

  quizContent.innerHTML = html;

  document.getElementById("redoButton")?.addEventListener("click", enterRedoMode);
  document.getElementById("saveButton")?.addEventListener("click", saveCurrentResultAsTxt);
  document.getElementById("backToQuestionsButton")?.addEventListener("click", () => renderQuestion());

  updateSidebarStatus();
}

function calculateAndShowResults(fromRedo = false){
  saveCurrentInput();
  if (!fromRedo) quizEndTime = new Date();
  quizSubmitted = true;

  isRedoMode = false;
  redoIndices = [];
  redoPos = 0;

  renderSidebar();
  renderResults();

  generateBtn.style.display = "inline-block";
}

/* ----------------------------------------------------------
   Redo
---------------------------------------------------------- */
function enterRedoMode(){
  gradeAll();

  redoIndices = questions
    .map((q, i) => ({ q, i }))
    .filter(o => {
      const ans = (o.q.userValue || "").trim();
      return ans === "" || !o.q.isCorrect;
    })
    .map(o => o.i);

  if (redoIndices.length === 0){
    alert("Nothing to redo. All questions are answered correctly.");
    return;
  }

  normalIndexBeforeRedo = currentQuestionIndex;
  isRedoMode = true;
  redoPos = 0;
  currentQuestionIndex = redoIndices[redoPos];

  generateBtn.style.display = "none";
  renderSidebar();
  renderQuestion();
}

function exitRedoMode(){
  isRedoMode = false;
  redoIndices = [];
  redoPos = 0;
  currentQuestionIndex = normalIndexBeforeRedo;
  calculateAndShowResults(true);
}

/* ----------------------------------------------------------
   Navigation
---------------------------------------------------------- */
function onNext(){
  saveCurrentInput();
  if (isRedoMode){
    if (redoPos < redoIndices.length - 1){
      redoPos++;
      currentQuestionIndex = redoIndices[redoPos];
      renderQuestion();
    }
    return;
  }
  if (currentQuestionIndex < TOTAL_QUESTIONS - 1){
    currentQuestionIndex++;
    renderQuestion();
  }
}

function onPrev(){
  saveCurrentInput();
  if (isRedoMode){
    if (redoPos > 0){
      redoPos--;
      currentQuestionIndex = redoIndices[redoPos];
      renderQuestion();
    }
    return;
  }
  if (currentQuestionIndex > 0){
    currentQuestionIndex--;
    renderQuestion();
  }
}

function onSubmit(){
  if (isRedoMode){
    saveCurrentInput();
    gradeAll();
    isRedoMode = false;
    redoIndices = [];
    redoPos = 0;
    calculateAndShowResults(true);
    return;
  }
  calculateAndShowResults(false);
}

/* ----------------------------------------------------------
   Start screen
---------------------------------------------------------- */
function showStartScreen(){
  sidebarEl.style.display = "none";
  generateBtn.style.display = "none";
  modeBadge.style.display = "none";

  quizContent.innerHTML = `
    <p>This quiz contains <strong>${TOTAL_QUESTIONS}</strong> questions in 3 parts.</p>
    <p><b>Step 1:</b> Enter your name</p>
    <input id="nameInput" type="text"
      style="padding:10px; width:260px; font-size:1.05em;"
      placeholder="Your name">

    <p style="margin-top:16px;"><b>Step 2:</b> Choose a mode</p>
    <label style="display:block; margin:6px 0;">
      <input type="radio" name="modeChoice" value="integer" checked>
      Integer Mode (negatives)
    </label>
    <label style="display:block; margin:6px 0;">
      <input type="radio" name="modeChoice" value="decimal">
      Decimal Mode (1–2 dp, exact division, negatives)
    </label>

    <div class="question-buttons" style="margin-top:18px;">
      <button id="startButton" style="background:#4caf50;">Start Quiz</button>
    </div>
  `;

  // Auto-fill from URL if present
  const nameInput = document.getElementById("nameInput");
  if (nameInput && URL_STUDENT_NAME){
    nameInput.value = URL_STUDENT_NAME;
  }

  document.getElementById("startButton").addEventListener("click", startQuiz);
}

function startQuiz(){
  const nameInput = document.getElementById("nameInput");
  studentName = (nameInput.value || "Student").trim();

  const picked = document.querySelector('input[name="modeChoice"]:checked');
  MODE = picked ? picked.value : "integer";

  modeBadge.style.display = "inline-block";
  modeBadge.textContent = (MODE === "integer") ? "Integer Mode" : "Decimal Mode (1–2 dp)";

  quizStartTime = new Date();
  generateQuiz();
  currentQuestionIndex = 0;

  sidebarEl.style.display = "block";
  generateBtn.style.display = "inline-block";

  generateBtn.onclick = () => {
    if (!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;
    quizStartTime = new Date();
    generateQuiz();
    currentQuestionIndex = 0;
    renderSidebar();
    renderQuestion();
  };

  renderSidebar();
  renderQuestion();
}

/* Init */
showStartScreen();
</script>
</body>
</html>
