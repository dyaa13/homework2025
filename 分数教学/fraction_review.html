<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fractions Review — 20 Questions (Basic + Word Problems)</title>

  <style>
    body{
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:#f4f4f9;margin:0;padding:20px;color:#333;
    }
    .quiz-container{
      max-width:980px;margin:40px auto;background:#fff;padding:30px;
      border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);
    }
    #headerLogo{
      display:flex;align-items:center;margin-bottom:10px;
      border-bottom:2px solid #e0e0e0;padding-bottom:10px;
    }
    .logo-icon{width:40px;height:40px;background:#0d47a1;border-radius:4px;}
    .logo-text span.edu{font-size:.9em;color:#ff9800;font-weight:700;margin-left:10px;}

    .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;}
    .top-left{display:flex;flex-direction:column;gap:4px;}
    #timerDisplay{font-size:.95em;color:#333;}
    #studentDisplay{font-size:.95em;color:#333;}
    #studentDisplay strong{color:#0d47a1;}

    .quiz-main{display:flex;gap:20px;}
    .sidebar{
      width:160px;border-right:1px solid #ddd;padding-right:10px;display:none;
    }
    .sidebar h4{margin:0 0 8px;font-size:.95em;border-bottom:1px solid #eee;padding-bottom:4px;}
    .sidebar ul{list-style:none;padding:0;margin:0;}
    .sidebar li{padding:6px;cursor:pointer;border-radius:4px;font-size:.9em;}
    .sidebar li.active{outline:2px solid #1976d2;font-weight:600;}
    .sidebar li.answered{border-left:4px solid #4caf50;}
    .sidebar li.correct{background:#d4edda;border-left:4px solid #28a745;}
    .sidebar li.incorrect{background:#f8d7da;border-left:4px solid #f44336;}

    #quizContent{flex:1;}
    .question-text{font-size:1.1em;margin-bottom:8px;}
    .part-title{font-weight:bold;margin-bottom:8px;}
    .single-question{margin:6px 0;line-height:1.9;}
    .answer-box{width:260px;padding:8px 10px;font-size:1em;border-radius:8px;border:1px solid #bbb;}
    .qmark{font-weight:900;}

    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      background:#fff7e6;
      border:1px solid #ffe0b2;
      color:#5d4037;
      font-size:0.95em;
    }

    .button-container{
      display:flex;justify-content:space-between;gap:10px;margin-top:14px;flex-wrap:wrap;
    }
    button{
      padding:10px 16px;
      border:none;
      border-radius:8px;
      background:#1976d2;color:#fff;
      cursor:pointer;font-size:0.95em;
    }
    button:hover{background:#125aa3;}
    button:disabled{background:#9e9e9e;cursor:not-allowed;}
    #saveButton{background:#6a1b9a;}
    #saveButton:hover{background:#4a116b;}
    #checkButton{background:#ef6c00;}
    #checkButton:hover{background:#c25500;}
    #pauseButton{background:#455a64;}
    #pauseButton:hover{background:#2f3e45;}
    #generateButton{background:#2e7d32;}
    #generateButton:hover{background:#1f5a23;}
    #exportPdfButton{background:#546e7a;}
    #exportPdfButton:hover{background:#3f5560;}

    .review-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:0.95em;
    }
    .review-table th,.review-table td{
      border:1px solid #ddd;padding:8px;vertical-align:top;
    }
    .review-table th{background:#f2f2f2;}
    .correct-answer{background:#e8f5e9;}
    .incorrect-answer{background:#ffebee;}

    /* fraction inline */
    .frac{display:inline-block;text-align:center;vertical-align:middle;min-width:22px;margin:0 2px;}
    .frac .top{display:block;border-bottom:1px solid #000;padding:0 3px;}
    .frac .bottom{display:block;padding:0 3px;font-size:.9em;}

    /* Mixed number (3 boxes aligned like your requirement) */
    :root{
      --mixWholeW: 90px;
      --mixFracW: 90px;
      --mixNumH: 30px;
      --mixDenH: 30px;
      --mixBarH: 2px;
      --mixBorder: 2px;
      --mixRadius: 8px;
    }
    .mix3{
      display:inline-grid;
      grid-template-columns:var(--mixWholeW) var(--mixFracW);
      column-gap:12px;
      align-items:center;
      vertical-align:middle;
    }
    .mix-cell{
      box-sizing:border-box;
      border:var(--mixBorder) solid #333;
      border-radius:var(--mixRadius);
      background:#fff;
      font-weight:700;
      text-align:center;
      font-size:0.95em;
    }
    .mix-whole{
      width:var(--mixWholeW);
      height:calc(var(--mixNumH) + var(--mixDenH) + var(--mixBarH));
      display:flex;align-items:center;justify-content:center;
    }
    .mix-frac{
      width:var(--mixFracW);
      display:grid;
      grid-template-rows:var(--mixNumH) var(--mixBarH) var(--mixDenH);
      align-items:stretch;
    }
    .mix-num,.mix-den{
      width:var(--mixFracW);
      height:100%;
      display:flex;align-items:center;justify-content:center;
    }
    .mix-bar{
      width:var(--mixFracW);
      height:var(--mixBarH);
      background:#111;border-radius:1px;
    }

    /* Input version */
    .mix-input3{margin-top:8px;}
    .mix-input3 input{
      box-sizing:border-box;
      border:var(--mixBorder) solid #333;
      border-radius:var(--mixRadius);
      background:#fff;
      font-weight:700;
      font-size:0.95em;
      text-align:center;
      outline:none;
    }
    .mix-input3 .whole-in{
      width:var(--mixWholeW);
      height:calc(var(--mixNumH) + var(--mixDenH) + var(--mixBarH));
    }
    .mix-input3 .num-in,.mix-input3 .den-in{
      width:var(--mixFracW);
      height:100%;
    }

    @media (max-width:760px){
      .quiz-main{flex-direction:column;}
      .sidebar{width:100%;border-right:none;border-bottom:1px solid #ddd;margin-bottom:10px;padding-bottom:10px;}
      .answer-box{width:100%;max-width:320px;}
      :root{--mixWholeW:110px;--mixFracW:110px;}
    }

    @media print{
      @page{margin:14mm;}
      body{padding:0;}
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text"><span class="edu">DYAA EDUCATION</span></div>
  </div>

  <div class="top-bar">
    <div class="top-left">
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentDisplay">Student: <strong>—</strong></div>
    </div>
    <div>
      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="generateButton" style="display:none;">Generate New Set</button>
      <button id="exportPdfButton" style="display:none;">Export Questions PDF</button>
    </div>
  </div>

  <h2>Fractions Review — 20 Questions (Basic + Word Problems)</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <div id="navButtons" class="button-container" style="display:none;">
    <button id="backButton" style="display:none;">Previous</button>
    <button id="submitButton" style="display:none;">Submit &amp; View Results</button>
    <button id="nextButton" style="display:none;">Next</button>
    <button id="checkButton" style="display:none;">Check</button>
    <button id="saveButton" style="display:none;">Save Current Result</button>
  </div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const PART_TITLES = [
  "A. Core Fraction Skills (10 questions)",
  "B. Simple Word Problems (5 questions)",
  "C. Multi-step Word Problems (5 questions)"
];
const PART_COUNTS  = [10,5,5];
const PART_LETTERS = ["A","B","C"];
const TOTAL_QUESTIONS = PART_COUNTS.reduce((a,b)=>a+b,0);

/* ---------------- Pools ---------------- */
const NAMES = ["Ava","Leo","Mia","Noah","Sofia","Ethan","Zoe","Lucas","Ivy","Hannah","Mason","Ella","Owen","Liam","Grace","Jack","Chloe","Henry","Nora","James","Emily"];
const PLACES = ["a supermarket","a bakery","a sports shop","a weekend market","a café","a bookshop","a craft store","a hardware store"];
const ITEMS  = ["books","stickers","snacks","apples","ribbon","flour","paint","juice","yogurt","rice","cookies","rope"];
const CURRENCIES = [
  {sym:"$", name:"dollars"},
  {sym:"£", name:"pounds"},
  {sym:"€", name:"euros"}
];

/* ---------------- Utils ---------------- */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function choice(arr){ return arr[randInt(0, arr.length-1)]; }
function gcd(a,b){
  a=Math.abs(a); b=Math.abs(b);
  while(b!==0){ const t=b; b=a%b; a=t; }
  return a===0?1:a;
}
function lcm(a,b){ return Math.abs(a/gcd(a,b)*b); }
function simplifyFraction(fr){
  let n=fr.n, d=fr.d;
  if(d<0){ n=-n; d=-d; }
  const g=gcd(n,d);
  return {n:n/g, d:d/g};
}
function fractionToValue(fr){ return fr.n/fr.d; }
function fractionToString(fr){
  const s=simplifyFraction(fr);
  if(s.d===1) return String(s.n);
  return `${s.n}/${s.d}`;
}
function fractionToHtml(fr){
  const s=simplifyFraction(fr);
  if(s.d===1) return String(s.n);
  return `<span class="frac"><span class="top">${s.n}</span><span class="bottom">${s.d}</span></span>`;
}
function fractionToHtmlRaw(fr){
  const n = fr.n;
  const d = fr.d;
  if(d === 1) return String(n);
  return `<span class="frac"><span class="top">${n}</span><span class="bottom">${d}</span></span>`;
}

function addFrac(a,b){ return simplifyFraction({n:a.n*b.d + b.n*a.d, d:a.d*b.d}); }
function subFrac(a,b){ return simplifyFraction({n:a.n*b.d - b.n*a.d, d:a.d*b.d}); }
function mulFrac(a,b){ return simplifyFraction({n:a.n*b.n, d:a.d*b.d}); }
function divFrac(a,b){ return simplifyFraction({n:a.n*b.d, d:a.d*b.n}); }

/* ---------------- Mixed (3-box display + conversions) ---------------- */
function mixedBoxesHtml(whole, num, den){
  return `
    <span class="mix3" aria-label="mixed number display">
      <span class="mix-cell mix-whole">${whole}</span>
      <span class="mix-frac" aria-label="fraction part">
        <span class="mix-cell mix-num">${num}</span>
        <span class="mix-bar" aria-hidden="true"></span>
        <span class="mix-cell mix-den">${den}</span>
      </span>
    </span>
  `;
}
function mixedToString(whole, num, den){
  return `${whole} ${num}/${den}`;
}
function toMixed(fr){
  const s=simplifyFraction(fr);
  const sign = s.n<0 ? -1 : 1;
  const n = Math.abs(s.n), d = s.d;
  const whole = Math.floor(n/d);
  const rem = n % d;
  if(rem===0) return {whole: sign*whole, num:0, den:1, isInt:true};
  const simp = simplifyFraction({n:rem, d});
  return {whole: sign*whole, num:simp.n, den:simp.d, isInt:false};
}
function mixedToImproper(m){
  return simplifyFraction({n: m.whole*m.den + m.num, d: m.den});
}

/* ---------------- Random fractions (reduced) ---------------- */
const PROPER_DENS = [3,4,5,6,8,9,10,12];
const MIXED_DENS  = [3,4,5,6,7,8,9,10,12];
function randomProperReduced(){
  for(let t=0;t<400;t++){
    const d=choice(PROPER_DENS);
    const n=randInt(1,d-1);
    if(gcd(n,d)===1) return {n,d};
  }
  return {n:1,d:2};
}
function randomImproperReduced(){
  for(let t=0;t<600;t++){
    const d=choice(MIXED_DENS);
    const n=randInt(d+1, 3*d-1);
    if(n%d===0) continue;
    if(gcd(n,d)===1) return {n,d};
  }
  return {n:7,d:4};
}
function randomMixedReduced(){
  const den=choice(MIXED_DENS);
  const whole=randInt(1,5);
  for(let t=0;t<200;t++){
    const num=randInt(1,den-1);
    if(gcd(num,den)===1) return {whole,num,den};
  }
  return {whole:2,num:1,den:3};
}
function round2(x){ return Math.round(x*100)/100; }
function clean2(x){
  let s = (Math.round(x*100)/100).toFixed(2);
  s = s.replace(/\.00$/,"");
  s = s.replace(/(\.\d)0$/,"$1");
  return s;
}
function formatMs(ms){
  const totalSec=Math.floor(ms/1000);
  const min=Math.floor(totalSec/60);
  const sec=totalSec%60;
  return `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

/* ---------------- Parse Answers ---------------- */
function parseAnswer(str){
  let s=(str||"").trim();
  if(s==="") return NaN;

  let sign=1;
  if(s[0]==="+"){ s=s.slice(1).trim(); }
  else if(s[0]==="-"){ sign=-1; s=s.slice(1).trim(); }
  if(s==="") return NaN;

  // mixed: "2 1/3"
  const spaceParts=s.split(/\s+/);
  if(spaceParts.length===2 && spaceParts[1].includes("/")){
    const whole=Number(spaceParts[0]);
    const fracParts=spaceParts[1].split("/");
    if(fracParts.length!==2) return NaN;
    const num=Number(fracParts[0]);
    const den=Number(fracParts[1]);
    if(!Number.isFinite(whole)||!Number.isFinite(num)||!Number.isFinite(den)||den===0) return NaN;
    const absWhole=Math.abs(whole);
    const fracVal=num/den;
    let value=absWhole+fracVal;
    if(whole<0) value=-value;
    return sign*value;
  }

  // fraction: a/b
  if(s.includes("/")){
    const parts=s.split("/");
    if(parts.length!==2) return NaN;
    const num=Number(parts[0]);
    const den=Number(parts[1]);
    if(!Number.isFinite(num)||!Number.isFinite(den)||den===0) return NaN;
    return sign*(num/den);
  }

  // decimal/int
  const n=Number(s);
  return Number.isFinite(n)?sign*n:NaN;
}
function nearlyEqual(a,b,eps=1e-6){
  if(!Number.isFinite(a)||!Number.isFinite(b)) return false;
  return Math.abs(a-b)<eps;
}

/* ---------------- Quiz State ---------------- */
let studentName="Student";
let questions=[];
let currentQuestionIndex=0;
let quizSubmitted=false;

let quizStartTime=null;
let quizEndTime=null;
let timerInterval=null;
let elapsedMs=0;
let isPaused=false;
let firstAttemptMs=null;

/* ---------------- DOM ---------------- */
const quizContent=document.getElementById("quizContent");
const sidebarEl=document.getElementById("sidebar");

const pauseButton=document.getElementById("pauseButton");
const generateBtn=document.getElementById("generateButton");
const exportPdfButton=document.getElementById("exportPdfButton");

const buttonContainer=document.getElementById("navButtons");
const backButton=document.getElementById("backButton");
const nextButton=document.getElementById("nextButton");
const submitButton=document.getElementById("submitButton");
const checkButton=document.getElementById("checkButton");
const saveButton=document.getElementById("saveButton");

/* ---------------- URL name param ---------------- */
function getNameFromUrl(){
  try{
    const sp = new URLSearchParams(window.location.search);
    const raw = sp.get("name");
    if(!raw) return null;
    const name = String(raw).trim();
    return name.length ? name : null;
  }catch(e){ return null; }
}
function updateStudentDisplay(){
  const el=document.getElementById("studentDisplay");
  if(el) el.innerHTML = `Student: <strong>${studentName || "—"}</strong>`;
}

/* ---------------- Question helpers ---------------- */
function partLabelFor(q){
  return PART_LETTERS[q.partIndex] + (q.indexInPart+1);
}
function moneyDisplay(v, sym){
  // always show 2dp for money
  return `${sym}${(Math.round(v*100)/100).toFixed(2)}`;
}
function parseMixedStringToParts(s){
  // expects "W N/D"
  const t=(s||"").trim();
  const m=t.match(/^(-?\d+)\s+(\d+)\s*\/\s*(\d+)$/);
  if(!m) return null;
  return {w:m[1], n:m[2], d:m[3]};
}

/* ---------------- BASIC (10) generators ---------------- */
function genEquivalentMissing(){
  const base = randomProperReduced();
  const k = randInt(2,6);
  const eq  = {n: base.n*k, d: base.d*k};

  const missTop = Math.random()<0.5;
  const text = missTop
    ? `Fill the missing number: ${fractionToHtml(base)} = <span class="frac"><span class="top"><span class="qmark">?</span></span><span class="bottom">${eq.d}</span></span>`
    : `Fill the missing number: ${fractionToHtml(base)} = <span class="frac"><span class="top">${eq.n}</span><span class="bottom"><span class="qmark">?</span></span></span>`;

  const ans = missTop ? eq.n : eq.d;

  return {
    kind:"equiv",
    text,
    value:Number(ans),
    display:String(ans),
    displayHtml:String(ans),
    answerMode:"normal"
  };
}
function genSimplify(){
  // Always generate a fraction that is NOT in lowest terms (gcd > 1)
  let raw, reduced;

  while(true){
    reduced = randomProperReduced();   // lowest terms
    const k = randInt(2, 9);           // scale factor > 1
    raw = { n: reduced.n * k, d: reduced.d * k };

    // guaranteed reducible
    if(gcd(raw.n, raw.d) > 1) break;
  }

  return {
    kind:"simplify",
    text:`Simplify: ${fractionToHtmlRaw(raw)}`,  // IMPORTANT: show unsimplified
    value:fractionToValue(reduced),
    display:fractionToString(reduced),
    displayHtml:fractionToHtml(reduced),
    answerMode:"normal"
  };
}

function genCompareLarger(){
  let a,b;
  for(let t=0;t<400;t++){
    a=randomProperReduced();
    b=randomProperReduced();
    if(a.n===b.n && a.d===b.d) continue;
    const va=fractionToValue(a), vb=fractionToValue(b);
    if(Math.abs(va-vb)<1e-9) continue;
    break;
  }
  const larger = fractionToValue(a) > fractionToValue(b) ? a : b;
  return {
    kind:"compare",
    text:`Which fraction is <strong>larger</strong>? ${fractionToHtml(a)} or ${fractionToHtml(b)} <br/>Type the larger fraction.`,
    value:fractionToValue(larger),
    display:fractionToString(larger),
    displayHtml:fractionToHtml(larger),
    answerMode:"normal"
  };
}
function genReciprocal(){
  const f = randomProperReduced();
  const r = simplifyFraction({n:f.d, d:f.n});
  return {
    kind:"reciprocal",
    text:`Find the reciprocal of ${fractionToHtml(f)}.`,
    value:fractionToValue(r),
    display:fractionToString(r),
    displayHtml:fractionToHtml(r),
    answerMode:"normal"
  };
}
function genFracToDecimal2dp(){
  // pick a non-terminating fraction so rounding matters
  const pool = [
    {n:1,d:3},{n:2,d:3},{n:1,d:6},{n:5,d:6},
    {n:1,d:7},{n:2,d:7},{n:3,d:7},
    {n:1,d:9},{n:2,d:9},{n:4,d:9},
    {n:5,d:12},{n:7,d:12}
  ];
  const f = choice(pool);
  const val = f.n/f.d;
  const rounded = round2(val);
  return {
    kind:"fracToDec",
    text:`Convert to a decimal (round to <strong>2 dp</strong>): ${fractionToHtml(f)}`,
    value:rounded,
    display:clean2(rounded),
    displayHtml:clean2(rounded),
    answerMode:"normal"
  };
}
function genMixedToImproper(){
  const m = randomMixedReduced();
  const imp = mixedToImproper(m);
  return {
    kind:"mixedToImproper",
    text:`Convert this mixed number to an improper fraction: ${mixedBoxesHtml(m.whole,m.num,m.den)}`,
    value:fractionToValue(imp),
    display:fractionToString(imp),
    displayHtml:fractionToHtml(imp),
    answerMode:"normal"
  };
}
function genImproperToMixed(){
  const imp = randomImproperReduced();
  const m = toMixed(imp);
  // ensure it's not an integer
  if(m.isInt){
    return genImproperToMixed();
  }
  return {
    kind:"improperToMixed",
    text:`Convert this improper fraction to a mixed number (use the 3 boxes): ${fractionToHtml(imp)}`,
    value:fractionToValue(imp),
    display:mixedToString(m.whole,m.num,m.den),
    displayHtml:mixedBoxesHtml(m.whole,m.num,m.den),
    answerMode:"mixed3"
  };
}
function genMixedPlusFrac(){
  let m, f, sum, mix;
  for(let t=0;t<800;t++){
    m = randomMixedReduced();
    f = randomProperReduced();
    sum = addFrac(mixedToImproper(m), f);
    mix = toMixed(sum);
    if(!mix.isInt && mix.whole>=1) break;
  }
  return {
    kind:"add",
    text:`Calculate (answer as a mixed number): ${mixedBoxesHtml(m.whole,m.num,m.den)} + ${fractionToHtml(f)}`,
    value:fractionToValue(sum),
    display:mixedToString(mix.whole,mix.num,mix.den),
    displayHtml:mixedBoxesHtml(mix.whole,mix.num,mix.den),
    answerMode:"mixed3"
  };
}
function genMixedTimesFrac(){
  let m, f, prod, mix;
  for(let t=0;t<800;t++){
    m = randomMixedReduced();
    f = randomProperReduced();
    prod = mulFrac(mixedToImproper(m), f);
    mix = toMixed(prod);
    if(!mix.isInt && mix.whole>=1) break;
  }
  return {
    kind:"mul",
    text:`Calculate (answer as a mixed number): ${mixedBoxesHtml(m.whole,m.num,m.den)} × ${fractionToHtml(f)}`,
    value:fractionToValue(prod),
    display:mixedToString(mix.whole,mix.num,mix.den),
    displayHtml:mixedBoxesHtml(mix.whole,mix.num,mix.den),
    answerMode:"mixed3"
  };
}
function genMixedDivFrac(){
  let m, f, quot, mix;
  for(let t=0;t<1000;t++){
    m = randomMixedReduced();
    f = randomProperReduced();
    // avoid division by 0
    quot = divFrac(mixedToImproper(m), f);
    mix = toMixed(quot);
    if(!mix.isInt && mix.whole>=1) break;
  }
  return {
    kind:"div",
    text:`Calculate (answer as a mixed number): ${mixedBoxesHtml(m.whole,m.num,m.den)} ÷ ${fractionToHtml(f)}`,
    value:fractionToValue(quot),
    display:mixedToString(mix.whole,mix.num,mix.den),
    displayHtml:mixedBoxesHtml(mix.whole,mix.num,mix.den),
    answerMode:"mixed3"
  };
}

const BASIC_GENERATORS = [
  genEquivalentMissing,
  genSimplify,
  genCompareLarger,
  genReciprocal,
  genFracToDecimal2dp,
  genMixedToImproper,
  genImproperToMixed,
  genMixedPlusFrac,
  genMixedTimesFrac,
  genMixedDivFrac
];

/* ---------------- Word Problems (Simple / Complex) ---------------- */
function buildSimpleWordProblem(i, used){
  const name=choice(NAMES);
  const place=choice(PLACES);
  const item=choice(ITEMS);
  const cur=choice(CURRENCIES);

  const templates = [
    function wp1(){
      // fraction of money
      const d=choice([3,4,5,6,8,10,12]);
      const n=randInt(1,d-1);
      const total = d * randInt(8,30); // integer money
      const spent = total * (n/d);
      return {
        kind:"wpSimple",
        text:`${name} has ${cur.sym}${total} in ${cur.name}. At ${place}, ${name} spends ${fractionToHtml({n,d})} of the money on ${item}.<br/>How much money does ${name} spend? (Type the amount in ${cur.name}.)`,
        value:spent,
        display:moneyDisplay(spent, cur.sym),
        displayHtml:moneyDisplay(spent, cur.sym),
        answerMode:"normal"
      };
    },
    function wp2(){
      // multiplication to mixed
      let k=randInt(3,6);
      let f=randomProperReduced();
      let total = mulFrac({n:k,d:1}, f);
      let mix = toMixed(total);
      if(mix.isInt) return wp2();
      return {
        kind:"wpSimple",
        text:`Each smoothie needs ${fractionToHtml(f)} cup of yogurt. ${name} makes ${k} smoothies.<br/>How many cups of yogurt are needed in total? (Answer as a mixed number.)`,
        value:fractionToValue(total),
        display:mixedToString(mix.whole,mix.num,mix.den),
        displayHtml:mixedBoxesHtml(mix.whole,mix.num,mix.den),
        answerMode:"mixed3"
      };
    },
    function wp3(){
      // one-step addition with mixed + fraction
      let m = randomMixedReduced();
      let f = randomProperReduced();
      let sum = addFrac(mixedToImproper(m), f);
      let mix = toMixed(sum);
      if(mix.isInt) return wp3();
      return {
        kind:"wpSimple",
        text:`On Monday, ${name} jogs ${mixedBoxesHtml(m.whole,m.num,m.den)} km. On Tuesday, ${name} jogs ${fractionToHtml(f)} km.<br/>How far does ${name} jog in total? (Answer as a mixed number.)`,
        value:fractionToValue(sum),
        display:mixedToString(mix.whole,mix.num,mix.den),
        displayHtml:mixedBoxesHtml(mix.whole,mix.num,mix.den),
        answerMode:"mixed3"
      };
    },
    function wp4(){
      // division to integer: mixed length ÷ fractional piece
      const piece = randomProperReduced();
      const count = randInt(6,16);
      const length = mulFrac({n:count,d:1}, piece); // exact
      const mix = toMixed(length);
      // Ensure statement is mixed (not just proper)
      if(mix.whole===0) return wp4();
      return {
        kind:"wpSimple",
        text:`A rope is ${mixedBoxesHtml(mix.whole,mix.num,mix.den)} m long. It is cut into pieces that are ${fractionToHtml(piece)} m each.<br/>How many pieces are cut?`,
        value:count,
        display:String(count),
        displayHtml:String(count),
        answerMode:"normal"
      };
    },
    function wp5(){
      // subtraction: mixed - fraction
      let m = randomMixedReduced();
      let f = randomProperReduced();
      let left = subFrac(mixedToImproper(m), f);
      if(fractionToValue(left)<=0) return wp5();
      const mix = toMixed(left);
      if(mix.isInt) return wp5();
      return {
        kind:"wpSimple",
        text:`${name} has ${mixedBoxesHtml(m.whole,m.num,m.den)} L of juice. ${name} drinks ${fractionToHtml(f)} L.<br/>How much juice is left? (Answer as a mixed number.)`,
        value:fractionToValue(left),
        display:mixedToString(mix.whole,mix.num,mix.den),
        displayHtml:mixedBoxesHtml(mix.whole,mix.num,mix.den),
        answerMode:"mixed3"
      };
    }
  ];

  for(let tries=0;tries<120;tries++){
    const q = choice(templates)();
    const sig = q.text.replace(/\d+/g,"#"); // coarse signature
    if(used.has(sig)) continue;
    used.add(sig);
    return q;
  }
  // fallback
  return templates[0]();
}

function buildComplexWordProblem(i, used){
  const name=choice(NAMES);
  const cur=choice(CURRENCIES);
  const place=choice(PLACES);

  const templates = [
    function c1(){
      // money: spend fraction, then fraction of remaining
      const f1 = {n:randInt(1,4), d:choice([5,6,8,10,12])};
      if(f1.n>=f1.d) return c1();
      const f2 = {n:randInt(1,3), d:choice([4,5,6,8,10,12])};
      if(f2.n>=f2.d) return c1();

      // pick total so cents are nice
      const total = randInt(30,120) + randInt(0,1)*0.50; // allow .50 sometimes
      const after1 = total * (1 - f1.n/f1.d);
      const after2 = after1 * (1 - f2.n/f2.d);
      const ans = round2(after2);

      return {
        kind:"wpComplex",
        text:`${name} has ${moneyDisplay(total,cur.sym)}. ${name} spends ${fractionToHtml(f1)} of the money at ${place}. Then ${name} spends ${fractionToHtml(f2)} of the <em>remaining</em> money on snacks.<br/>How much money is left? (Round to the nearest cent.)`,
        value:ans,
        display:moneyDisplay(ans,cur.sym),
        displayHtml:moneyDisplay(ans,cur.sym),
        answerMode:"normal"
      };
    },
    function c2(){
      // recipe: multiply then compare, answer mixed (more needed)
      const perTray = randomMixedReduced();
      const trays = randInt(2,5);
      const have = randomMixedReduced();

      const need = mulFrac(mixedToImproper(perTray), {n:trays,d:1});
      const more = subFrac(need, mixedToImproper(have));
      if(fractionToValue(more)<=0) return c2(); // ensure they need more
      const mix = toMixed(more);
      if(mix.isInt || mix.whole<1) return c2();

      return {
        kind:"wpComplex",
        text:`A recipe uses ${mixedBoxesHtml(perTray.whole,perTray.num,perTray.den)} cups of flour for 1 tray of muffins. ${name} bakes ${trays} trays.<br/>At home, ${name} has ${mixedBoxesHtml(have.whole,have.num,have.den)} cups of flour. How many more cups of flour does ${name} need? (Answer as a mixed number.)`,
        value:fractionToValue(more),
        display:mixedToString(mix.whole,mix.num,mix.den),
        displayHtml:mixedBoxesHtml(mix.whole,mix.num,mix.den),
        answerMode:"mixed3"
      };
    },
    function c3(){
      // tank: 3/4 full, then uses 2/5 of that water (multi-step)
      const cap = choice([40,60,80,100,120,140,160,180,200]);
      const startFrac = {n:3,d:4};
      const usedFrac  = {n:2,d:5};
      // remaining = 3/4 * (1-2/5)=3/4*3/5=9/20
      const remainFrac = mulFrac(startFrac, subFrac({n:1,d:1}, usedFrac)); // 9/20
      const remain = cap * fractionToValue(remainFrac);
      return {
        kind:"wpComplex",
        text:`A water tank has a capacity of ${cap} L. It is ${fractionToHtml(startFrac)} full. Then ${fractionToHtml(usedFrac)} of the water in the tank is used.<br/>How many litres of water remain?`,
        value:remain,
        display:`${remain} L`,
        displayHtml:`${remain} L`,
        answerMode:"normal"
      };
    },
    function c4(){
      // ribbon: subtract two amounts then divide among friends (multi-step)
      const totalM = randomMixedReduced();
      const use1 = randomProperReduced();
      const use2 = randomProperReduced();
      const friends = randInt(2,5);

      const total = mixedToImproper(totalM);

      // make sure use amounts are smaller than total
      const u1 = use1;
      const u2 = use2;
      let left = subFrac(subFrac(total, u1), u2);
      if(fractionToValue(left)<=0) return c4();

      const each = divFrac(left, {n:friends,d:1});
      const mix = toMixed(each);

      // allow proper or mixed, but if mixed required then ensure not integer
      if(mix.isInt) return c4();

      return {
        kind:"wpComplex",
        text:`${name} has ${mixedBoxesHtml(totalM.whole,totalM.num,totalM.den)} m of ribbon. ${name} uses ${fractionToHtml(u1)} m to wrap a gift, and then uses ${fractionToHtml(u2)} m for a card.<br/>The remaining ribbon is shared equally among ${friends} friends. How many metres does each friend get? (Answer as a mixed number if needed.)`,
        value:fractionToValue(each),
        display: mix.whole===0 ? fractionToString(simplifyFraction(each)) : mixedToString(mix.whole,mix.num,mix.den),
        displayHtml: mix.whole===0 ? fractionToHtml(simplifyFraction(each)) : mixedBoxesHtml(mix.whole,mix.num,mix.den),
        answerMode: (mix.whole===0 ? "normal" : "mixed3")
      };
    },
    function c5(){
      // distance: fraction of goal + mixed, then how much more (multi-step)
      const goal = choice([18,20,24,25,30,36,40]);
      const f = randomProperReduced();
      const morning = mulFrac({n:goal,d:1}, f);

      const afternoon = randomMixedReduced();
      const total = addFrac(morning, mixedToImproper(afternoon));
      const more = subFrac({n:goal,d:1}, total);

      if(fractionToValue(more)<=0) return c5();
      const mix = toMixed(more);
      if(mix.isInt) return c5();

      return {
        kind:"wpComplex",
        text:`${name} wants to walk ${goal} km this week. So far, ${name} has walked ${fractionToHtml(f)} of the goal in the morning, and ${mixedBoxesHtml(afternoon.whole,afternoon.num,afternoon.den)} km in the afternoon.<br/>How many kilometres does ${name} still need to walk? (Answer as a mixed number.)`,
        value:fractionToValue(more),
        display:mixedToString(mix.whole,mix.num,mix.den),
        displayHtml:mixedBoxesHtml(mix.whole,mix.num,mix.den),
        answerMode:"mixed3"
      };
    }
  ];

  for(let tries=0;tries<140;tries++){
    const q = choice(templates)();
    const sig = q.text.replace(/\d+/g,"#");
    if(used.has(sig)) continue;
    used.add(sig);
    return q;
  }
  return templates[0]();
}

/* ---------------- Build hints ---------------- */
function buildPerQuestionHint(q){
  switch(q.kind){
    case "equiv":
      return `Hint: Multiply (or divide) the numerator and denominator by the <strong>same number</strong>.`;
    case "simplify":
      return `Hint: Find a common factor of numerator and denominator and divide both until it is in <strong>lowest terms</strong>.`;
    case "compare":
      return `Hint: Make the denominators the same, or cross-multiply (compare <strong>a×d</strong> and <strong>c×b</strong>).`;
    case "reciprocal":
      return `Hint: The reciprocal of <strong>a/b</strong> is <strong>b/a</strong>.`;
    case "fracToDec":
      return `Hint: Divide numerator by denominator. Round to <strong>2 decimal places</strong>.`;
    case "mixedToImproper":
      return `Hint: Improper numerator = (<strong>whole × denominator</strong>) + numerator.`;
    case "improperToMixed":
      return `Hint: Divide numerator by denominator to get the <strong>whole</strong>; the remainder becomes the new numerator.`;
    case "add":
      return `Hint: Use a common denominator, then simplify.`;
    case "mul":
      return `Hint: Multiply numerators and denominators, then simplify.`;
    case "div":
      return `Hint: Divide by a fraction = multiply by its reciprocal.`;
    case "wpSimple":
      return `Hint: Read carefully and choose the ONE operation (add, subtract, multiply, or divide).`;
    case "wpComplex":
      return `Hint: Break it into steps and solve one step at a time.`;
    default:
      return `Hint: Show your working and simplify if needed.`;
  }
}

/* ---------------- Generate Quiz ---------------- */
function generateQuiz(){
  const used=new Set();
  questions=[];
  for(let p=0;p<PART_TITLES.length;p++){
    for(let i=0;i<PART_COUNTS[p];i++){
      let q;
      if(p===0){
        q = BASIC_GENERATORS[i]();
      }else if(p===1){
        q = buildSimpleWordProblem(i, used);
      }else{
        q = buildComplexWordProblem(i, used);
      }
      q.partIndex=p;
      q.indexInPart=i;
      q.userValue="";
      q.isCorrect=false;
      questions.push(q);
    }
  }
  quizSubmitted=false;
}

/* ---------------- Sidebar ---------------- */
function renderSidebar(){
  sidebarEl.style.display="block";
  sidebarEl.innerHTML=`<h4>Questions</h4><ul id="sideList"></ul>`;
  const ul=document.getElementById("sideList");

  questions.forEach((q,i)=>{
    const li=document.createElement("li");
    li.textContent = (i+1) + " (" + partLabelFor(q) + ")";
    li.addEventListener("click", ()=>{ saveCurrentInput(); currentQuestionIndex=i; renderQuestion(); });
    ul.appendChild(li);
  });
  updateSidebarStatus();
}
function updateSidebarStatus(){
  const ul=document.getElementById("sideList");
  if(!ul) return;
  const items=ul.querySelectorAll("li");
  items.forEach((li,i)=>{
    li.classList.toggle("active", i===currentQuestionIndex);
    const q=questions[i];
    const hasAns=(q.userValue||"").trim()!=="";
    li.classList.toggle("answered", hasAns && !quizSubmitted);
    li.classList.remove("correct","incorrect");
    if(quizSubmitted){
      if(q.isCorrect) li.classList.add("correct");
      else li.classList.add("incorrect");
    }
  });
}

/* ---------------- Save current input ---------------- */
function saveCurrentInput(){
  if(!questions.length) return;
  const q=questions[currentQuestionIndex];
  if(q.answerMode==="mixed3"){
    const w=document.getElementById("wholeInput");
    const n=document.getElementById("numInput");
    const d=document.getElementById("denInput");
    const ws=(w?w.value:"").trim();
    const ns=(n?n.value:"").trim();
    const ds=(d?d.value:"").trim();
    if(ws==="" && ns==="" && ds===""){
      q.userValue="";
    }else{
      q.userValue = `${ws} ${ns}/${ds}`.trim();
    }
  }else{
    const inp=document.getElementById("answerInput");
    q.userValue = (inp ? inp.value : q.userValue || "");
  }
}

/* ---------------- Render Question ---------------- */
function mountNavButtonsInto(slotId){
  const slot=document.getElementById(slotId);
  if(!slot) return;
  slot.innerHTML="";
  slot.appendChild(buttonContainer);
  buttonContainer.style.display="flex";
}

function renderQuestion(){
  const q=questions[currentQuestionIndex];
  const fullLabel=partLabelFor(q);
  const hintText=buildPerQuestionHint(q);

  const pre = (q.answerMode==="mixed3") ? parseMixedStringToParts(q.userValue) : null;

  const answerInputHtml = (q.answerMode==="mixed3") ? `
    <div class="mix-input3">
      <span class="mix3" aria-label="mixed number input">
        <input id="wholeInput" class="whole-in" type="text"
          value="${(pre?pre.w:"").replace(/"/g,'&quot;')}" placeholder="Whole">
        <span class="mix-frac" aria-label="fraction input">
          <input id="numInput" class="num-in" type="text"
            value="${(pre?pre.n:"").replace(/"/g,'&quot;')}" placeholder="Num">
          <span class="mix-bar" aria-hidden="true"></span>
          <input id="denInput" class="den-in" type="text"
            value="${(pre?pre.d:"").replace(/"/g,'&quot;')}" placeholder="Den">
        </span>
      </span>
    </div>
    <div style="margin-top:6px;color:#666;font-size:.9em;">
      Mixed number format (3 boxes): <strong>Whole</strong>, <strong>Numerator</strong>, <strong>Denominator</strong>.
    </div>
  ` : `
    <div style="margin-top:6px;">
      <input id="answerInput" class="answer-box" type="text"
        value="${(q.userValue||"").replace(/"/g,'&quot;')}"
        placeholder="e.g. 3/10 or 1 1/2 or 0.33">
    </div>
  `;

  quizContent.innerHTML=`
    <p class="question-text">Question ${currentQuestionIndex+1} of ${TOTAL_QUESTIONS}</p>
    <div class="part-title">${PART_TITLES[q.partIndex]}</div>

    <div class="single-question">
      <strong>${fullLabel}.</strong> ${q.text}
      ${answerInputHtml}
      <div id="checkFeedback" style="display:none;margin-top:10px;"></div>
      <div class="hint">${hintText}</div>
    </div>

    <div id="navSlot"></div>
  `;

  mountNavButtonsInto("navSlot");

  backButton.style.display="inline-block";
  backButton.style.visibility=(currentQuestionIndex===0)?"hidden":"visible";

  const isLast=(currentQuestionIndex===TOTAL_QUESTIONS-1);
  nextButton.style.display=isLast?"none":"inline-block";
  submitButton.style.display=isLast?"inline-block":"none";

  saveButton.style.display=quizSubmitted?"inline-block":"none";
  checkButton.style.display=(quizSubmitted && !q.isCorrect)?"inline-block":"none";

  updateSidebarStatus();

  // disable inputs if paused
  if(isPaused){
    const inp=document.querySelectorAll("#quizContent input");
    inp.forEach(x=>x.disabled=true);
  }
}

/* ---------------- Grading ---------------- */
function gradeOneQuestion(i){
  const q=questions[i];
  const val=parseAnswer(q.userValue||"");
  q.isCorrect = nearlyEqual(val, q.value);
}

function calculateAndShowResults(){
  saveCurrentInput();

  const now=new Date();
  let attemptMs=elapsedMs;
  if(!isPaused && quizStartTime) attemptMs += (now - quizStartTime);

  if(firstAttemptMs===null) firstAttemptMs=attemptMs;

  const attemptStartTime=quizStartTime || now;
  quizEndTime=now;
  quizSubmitted=true;

  let correctCount=0;
  questions.forEach((q,i)=>{
    gradeOneQuestion(i);
    if(q.isCorrect) correctCount++;
  });

  updateSidebarStatus();

  let html=`
    <h3>Results for ${studentName}</h3>
    <p>Score: <strong>${correctCount} / ${TOTAL_QUESTIONS}</strong></p>
    <p>Start time: <strong>${attemptStartTime.toLocaleTimeString()}</strong></p>
    <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
    <p>Time taken (this attempt): <strong>${formatMs(attemptMs)}</strong></p>
    <p>First attempt time: <strong>${formatMs(firstAttemptMs)}</strong></p>
    <p>Click question numbers on the left to review. Incorrect questions will have a <strong>Check</strong> button.</p>

    <table class="review-table">
      <tr>
        <th>#</th><th>Part</th><th>Question</th><th>Your Answer</th><th>Correct</th><th>Result</th>
      </tr>
  `;

  questions.forEach((q,i)=>{
    const lbl=partLabelFor(q);

    let yourAns = (q.userValue||"").trim()==="" ? "—" : (q.userValue||"");
    if(q.answerMode==="mixed3"){
      const p=parseMixedStringToParts(q.userValue||"");
      if(p) yourAns = mixedBoxesHtml(p.w, p.n, p.d);
    }

    html += `
      <tr class="${q.isCorrect ? "correct-answer":"incorrect-answer"}">
        <td>${i+1}</td>
        <td>${lbl}</td>
        <td>${q.text}</td>
        <td>${yourAns}</td>
        <td>${q.displayHtml || q.display}</td>
        <td>${q.isCorrect ? "✅" : "❌"}</td>
      </tr>
    `;
  });

  html += `</table><div style="margin-top:10px;color:#666;">Use <strong>Generate New Set</strong> to get different numbers and scenarios.</div>`;
  quizContent.innerHTML = html;

  // show nav/controls after submit
  buttonContainer.style.display="flex";
  backButton.style.display="inline-block";
  nextButton.style.display="inline-block";
  submitButton.style.display="none";
  checkButton.style.display="none";
  saveButton.style.display="inline-block";
}

/* ---------------- Check (after submit) ---------------- */
function checkCurrentQuestion(){
  const q=questions[currentQuestionIndex];
  const fb=document.getElementById("checkFeedback");
  if(!fb) return;

  fb.style.display="block";
  fb.style.padding="10px 12px";
  fb.style.borderRadius="10px";
  fb.style.border="1px solid #ffe0b2";
  fb.style.background="#fff7e6";
  fb.style.color="#5d4037";

  const correct = q.displayHtml || q.display;

  fb.innerHTML = `
    <div><strong>Correct answer:</strong> ${correct}</div>
    <div style="margin-top:6px;">${buildPerQuestionHint(q)}</div>
  `;
}

/* ---------------- Timer ---------------- */
function updateTimerDisplay(){
  const el=document.getElementById("timerDisplay");
  if(!el) return;
  el.textContent="Time: " + formatMs(elapsedMs);
}
function startTimerInterval(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    if(isPaused) return;
    if(!quizStartTime) return;
    const now=new Date();
    elapsedMs += (now - quizStartTime);
    quizStartTime = now;
    updateTimerDisplay();
  }, 250);
}
function togglePause(){
  if(!quizStartTime) return;

  if(!isPaused){
    // pause: accumulate time to now
    const now=new Date();
    elapsedMs += (now - quizStartTime);
    quizStartTime = now;
    isPaused=true;
    pauseButton.textContent="Resume";

    // disable inputs
    document.querySelectorAll("#quizContent input").forEach(x=>x.disabled=true);
  }else{
    isPaused=false;
    pauseButton.textContent="Pause";
    quizStartTime=new Date();
    document.querySelectorAll("#quizContent input").forEach(x=>x.disabled=false);
  }
  updateTimerDisplay();
}

/* ---------------- Export PDF (questions only) ---------------- */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}
function buildQuestionsForPrint(){
  let out = "";
  let idx = 0;
  for(let p=0;p<PART_TITLES.length;p++){
    out += `<h2 style="margin:14px 0 6px;">${escapeHtml(PART_TITLES[p])}</h2>`;
    for(let i=0;i<PART_COUNTS[p];i++){
      const q = questions[idx++];
      const label = partLabelFor(q);
      out += `
        <div class="q">
          <div class="qline"><strong>${label}.</strong> ${q.text}</div>
          <div class="blankline"></div>
          <div class="blankline"></div>
        </div>
      `;
    }
  }
  return out;
}
function exportQuestionsToPdf(){
  saveCurrentInput();
  const title = "Fractions Review — Questions";
  const now=new Date();

  const w = window.open("", "_blank");
  if(!w) return;

  const html = `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>${escapeHtml(title)}</title>
<style>
  body{font-family:'Segoe UI',Tahoma,sans-serif;padding:18px;color:#111;}
  h1{margin:0 0 6px;}
  .meta{color:#444;font-size:14px;padding-top:4px;border-top:1px solid #ddd;}
  .q{margin:10px 0 0;}
  .qline{font-size:13.5px;line-height:1.6;}
  .blankline{height:18px;}

  .frac{display:inline-block;text-align:center;vertical-align:middle;min-width:22px;margin:0 2px;}
  .frac .top{display:block;border-bottom:1px solid #000;padding:0 3px;}
  .frac .bottom{display:block;padding:0 3px;font-size:.9em;}

  :root{--mixWholeW:120px;--mixFracW:120px;--mixNumH:44px;--mixDenH:44px;--mixBarH:2px;--mixBorder:2px;--mixRadius:10px;}
  .mix3{display:inline-grid;grid-template-columns:var(--mixWholeW) var(--mixFracW);column-gap:14px;align-items:center;vertical-align:middle;}
  .mix-cell{box-sizing:border-box;border:var(--mixBorder) solid #333;border-radius:var(--mixRadius);background:#fff;font-weight:700;text-align:center;font-size:1.05em;}
  .mix-whole{width:var(--mixWholeW);height:calc(var(--mixNumH) + var(--mixDenH) + var(--mixBarH));display:flex;align-items:center;justify-content:center;}
  .mix-frac{width:var(--mixFracW);display:grid;grid-template-rows:var(--mixNumH) var(--mixBarH) var(--mixDenH);align-items:stretch;}
  .mix-num,.mix-den{width:var(--mixFracW);height:100%;display:flex;align-items:center;justify-content:center;}
  .mix-bar{width:var(--mixFracW);height:var(--mixBarH);background:#111;border-radius:1px;}

  @media print{@page{margin:14mm;}body{padding:0;}}
</style>
</head>
<body>
  <h1>${escapeHtml(title)}</h1>
  <div class="meta">
    Student: <strong>${escapeHtml(studentName)}</strong>
    &nbsp; | &nbsp;
    ${escapeHtml(now.toLocaleString())}
  </div>
  ${buildQuestionsForPrint()}
</body>
</html>`;

  w.document.open();
  w.document.write(html);
  w.document.close();
  w.onload = function(){
    w.focus();
    w.print();
  };
}

/* ---------------- Start Screen ---------------- */
function showStartScreen(){
  sidebarEl.style.display="none";
  buttonContainer.style.display="none";
  generateBtn.style.display="none";
  saveButton.style.display="none";
  pauseButton.style.display="none";
  exportPdfButton.style.display="none";

  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  quizStartTime=null; quizEndTime=null;
  updateTimerDisplay();

  updateStudentDisplay();

  quizContent.innerHTML=`
    <p>This review contains <strong>${TOTAL_QUESTIONS}</strong> questions:</p>
    <ul style="margin-top:6px;color:#555;line-height:1.6;">
      <li><strong>Part A:</strong> 10 basic fraction skills</li>
      <li><strong>Part B:</strong> 5 simple one-step word problems</li>
      <li><strong>Part C:</strong> 5 multi-step word problems</li>
    </ul>
    <p style="margin-top:10px;color:#444;">
      Mixed numbers (e.g., 2 1/3) are shown using <strong>3 boxes</strong> (Whole / Numerator / Denominator).<br/>
      When the 3-box answer input is shown, you must use it to enter the mixed number.
    </p>
    <p>Please enter your name to begin:</p>

    <input id="nameInput" type="text"
      style="padding:10px;width:260px;font-size:1.05em;border-radius:8px;border:1px solid #bbb;"
      placeholder="Your name">

    <button id="startButton"
      style="margin-left:10px;background:#4caf50;padding:10px 20px;color:white;border:none;border-radius:8px;">
      Start Quiz
    </button>
  `;
  document.getElementById("startButton").addEventListener("click", startQuizFromInput);
}

function startQuizCommon(){
  updateStudentDisplay();

  quizStartTime=new Date();
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  updateTimerDisplay(); startTimerInterval();

  generateQuiz();
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();

  generateBtn.style.display="inline-block";
  pauseButton.style.display="inline-block";
  exportPdfButton.style.display="inline-block";
  pauseButton.textContent="Pause";
}
function startQuizFromInput(){
  const nameInput=document.getElementById("nameInput");
  studentName=(nameInput.value || "Student").trim() || "Student";
  startQuizCommon();
}
function startQuizAutoWithName(name){
  studentName=(name || "Student").trim() || "Student";
  startQuizCommon();
}

/* ---------------- Buttons ---------------- */
backButton.addEventListener("click", ()=>{
  saveCurrentInput();
  if(currentQuestionIndex>0){
    currentQuestionIndex--;
    renderQuestion();
  }
});
nextButton.addEventListener("click", ()=>{
  saveCurrentInput();
  if(currentQuestionIndex<TOTAL_QUESTIONS-1){
    currentQuestionIndex++;
    renderQuestion();
  }
});
submitButton.addEventListener("click", ()=>{
  calculateAndShowResults();
});
checkButton.addEventListener("click", ()=>{
  checkCurrentQuestion();
});
saveButton.addEventListener("click", ()=>{
  // lightweight “save” = download a txt summary
  const lines=[];
  lines.push(`Student: ${studentName}`);
  lines.push(`Date: ${new Date().toLocaleString()}`);
  let correct=0;
  questions.forEach((q,i)=>{ if(q.isCorrect) correct++; });
  lines.push(`Score: ${correct}/${TOTAL_QUESTIONS}`);
  lines.push("");
  questions.forEach((q,i)=>{
    lines.push(`${i+1}. ${partLabelFor(q)} | Your: ${(q.userValue||"—")} | Correct: ${q.display}`);
  });
  const blob=new Blob([lines.join("\n")], {type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`FractionsReview_${studentName.replace(/\s+/g,"_")}.txt`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
});

pauseButton.addEventListener("click", togglePause);

generateBtn.addEventListener("click", ()=>{
  const ok = confirm("Generate a new set? This will clear your current answers.");
  if(!ok) return;
  // reset timer for a fresh attempt
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  quizStartTime=new Date();
  updateTimerDisplay(); startTimerInterval();

  generateQuiz();
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();
});

exportPdfButton.addEventListener("click", exportQuestionsToPdf);

/* ---------------- Init ---------------- */
(function init(){
  const urlName=getNameFromUrl();
  if(urlName){
    startQuizAutoWithName(urlName);
  }else{
    studentName="Student";
    showStartScreen();
  }
})();
</script>
</body>
</html>
