<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fractions Skills — Add & Subtract (Proper / Improper / Mixed + Word Problems)</title>

  <style>
    body{
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:#f4f4f9;margin:0;padding:20px;color:#333;
    }
    .quiz-container{
      max-width:900px;margin:40px auto;background:#fff;padding:30px;
      border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);
    }
    #headerLogo{
      display:flex;align-items:center;margin-bottom:10px;
      border-bottom:2px solid #e0e0e0;padding-bottom:10px;
    }
    .logo-icon{width:40px;height:40px;background:#0d47a1;border-radius:4px;}
    .logo-text span.edu{font-size:.9em;color:#ff9800;font-weight:700;margin-left:10px;}

    .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;}
    .top-left{display:flex;flex-direction:column;gap:4px;}
    #timerDisplay{font-size:.95em;color:#333;}
    #studentDisplay{font-size:.95em;color:#333;}
    #studentDisplay strong{color:#0d47a1;}

    .quiz-main{display:flex;gap:20px;}
    .sidebar{
      width:170px;border-right:1px solid #ddd;padding-right:10px;display:none;
    }
    .sidebar h4{margin:0 0 8px;font-size:.95em;border-bottom:1px solid #eee;padding-bottom:4px;}
    .sidebar ul{list-style:none;padding:0;margin:0;}
    .sidebar li{padding:6px;cursor:pointer;border-radius:4px;font-size:.9em;}
    .sidebar li.active{outline:2px solid #1976d2;font-weight:600;}
    .sidebar li.answered{border-left:4px solid #4caf50;}
    .sidebar li.correct{background:#d4edda;border-left:4px solid #28a745;}
    .sidebar li.incorrect{background:#f8d7da;border-left:4px solid #f44336;}

    #quizContent{flex:1;}
    .question-text{font-size:1.1em;margin-bottom:8px;}
    .part-title{font-weight:bold;margin-bottom:8px;}
    .single-question{margin:6px 0;line-height:1.9;}
    .answer-box{width:260px;padding:6px;font-size:1em;margin-top:8px;}

    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      background:#fff7e6;
      border:1px solid #ffe0b2;
      color:#5d4037;
      font-size:0.95em;
    }

    .button-container{
      display:flex;justify-content:space-between;gap:10px;margin-top:14px;
    }
    button{
      padding:10px 20px;border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:1em;
      white-space:nowrap;
    }
    #nextButton{background:#4caf50;}
    #backButton{background:#039be5;}
    #generateButton{background:#ff9800;}
    #submitButton{background:#9c27b0;}
    #saveButton{background:#607d8b;}
    #pauseButton{background:#f57c00;}
    #checkButton{background:#455a64;}
    #exportPdfButton{background:#673ab7;}

    table.review-table{width:100%;border-collapse:collapse;margin-top:20px;}
    .review-table th,.review-table td{border:1px solid #ccc;padding:6px;font-size:.85em;text-align:center;vertical-align:top;}
    .review-table th{background:#f2f2f2;}
    .correct-answer{background:#d4edda;}
    .incorrect-answer{background:#f8d7da;}

    /* Fraction (a/b) */
    .frac{display:inline-block;text-align:center;vertical-align:middle;min-width:22px;}
    .frac .top{display:block;border-bottom:1px solid #000;padding:0 2px;}
    .frac .bottom{display:block;padding:0 2px;font-size:.9em;}

    .check-feedback{
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      background:#f7f7f7;
      border:1px solid #e0e0e0;
      color:#333;
      font-size:0.95em;
    }

    /* ---------------- Mixed number display/input (smaller like normal text) ---------------- */
    :root{
      --mixWholeW: 82px;
      --mixFracW: 82px;
      --mixNumH: 28px;
      --mixDenH: 28px;
      --mixBarH: 2px;
      --mixBorder: 2px;
      --mixRadius: 8px;
    }
    .mix3{
      display:inline-grid;
      grid-template-columns: var(--mixWholeW) var(--mixFracW);
      column-gap: 12px;
      align-items: center;
      vertical-align: middle;
    }
    .mix-cell{
      box-sizing: border-box;
      border: var(--mixBorder) solid #333;
      border-radius: var(--mixRadius);
      background:#fff;
      font-weight: 700;
      text-align: center;
      font-size: 0.95em;
    }
    .mix-whole{
      width: var(--mixWholeW);
      height: calc(var(--mixNumH) + var(--mixDenH) + var(--mixBarH));
      display:flex;align-items:center;justify-content:center;
    }
    .mix-frac{
      width: var(--mixFracW);
      display:grid;
      grid-template-rows: var(--mixNumH) var(--mixBarH) var(--mixDenH);
      align-items: stretch;
    }
    .mix-num, .mix-den{
      width: var(--mixFracW);
      height: 100%;
      display:flex;align-items:center;justify-content:center;
    }
    .mix-bar{
      width: var(--mixFracW);
      height: var(--mixBarH);
      background:#111;
      border-radius: 1px;
    }
    .mix-input3{ margin-top: 8px; }
    .mix-input3 input{
      box-sizing:border-box;
      border: var(--mixBorder) solid #333;
      border-radius: var(--mixRadius);
      background:#fff;
      font-weight:700;
      font-size: 0.95em;
      text-align:center;
      outline:none;
    }
    .mix-input3 .whole-in{
      width: var(--mixWholeW);
      height: calc(var(--mixNumH) + var(--mixDenH) + var(--mixBarH));
    }
    .mix-input3 .num-in,
    .mix-input3 .den-in{
      width: var(--mixFracW);
      height: 100%;
    }

    @media (max-width:700px){
      .quiz-main{flex-direction:column;}
      .sidebar{width:100%;border-right:none;border-bottom:1px solid #ddd;margin-bottom:10px;padding-bottom:10px;}
      .button-container{flex-wrap:wrap;}
      .top-left{flex-direction:column;}
      .answer-box{width:100%;max-width:320px;}
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text"><span class="edu">DYAA EDUCATION</span></div>
  </div>

  <div class="top-bar">
    <div class="top-left">
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentDisplay">Student: <strong>—</strong></div>
    </div>
    <div>
      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="generateButton" style="display:none;">Generate New Set</button>
      <button id="exportPdfButton" style="display:none;">Export Questions PDF</button>
    </div>
  </div>

  <h2>Fractions Skills — Add & Subtract</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <div id="navButtons" class="button-container" style="display:none;">
    <button id="backButton" style="display:none;">Previous</button>
    <button id="submitButton" style="display:none;">Submit &amp; View Results</button>
    <button id="nextButton" style="display:none;">Next</button>
    <button id="checkButton" style="display:none;">Check</button>
    <button id="saveButton" style="display:none;">Save Current Result</button>
  </div>
</div>

<script>
/* ---------------- PARTS ---------------- */
const PART_TITLES = [
  "A. Proper Fraction Addition (1 same denominator + 3 different denominators)",
  "B. Proper Fraction Subtraction (1 same denominator + 3 different denominators)",
  "C. Improper Fraction Addition (different denominators) — 2 questions",
  "D. Improper Fraction Subtraction (different denominators) — 2 questions",
  "E. Mixed Number Addition (different denominators) — 2 questions",
  "F. Mixed Number Subtraction (different denominators) — 2 questions",
  "G. Three-number Add / Sub (fractions / improper / integers) — 3 questions",
  "H. Word Problems (fractions add/sub) — 5 questions"
];
const PART_COUNTS  = [4,4,2,2,2,2,3,5];
const PART_LETTERS = ["A","B","C","D","E","F","G","H"];
const TOTAL_QUESTIONS = PART_COUNTS.reduce((a,b)=>a+b,0);

/* ---------------- Utils ---------------- */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function choice(arr){ return arr[randInt(0, arr.length-1)]; }
function gcd(a,b){
  a=Math.abs(a); b=Math.abs(b);
  while(b!==0){ const t=b; b=a%b; a=t; }
  return a===0?1:a;
}
function simplifyFraction(fr){
  let n=fr.n, d=fr.d;
  if(d<0){ n=-n; d=-d; }
  const g=gcd(n,d);
  return {n:n/g, d:d/g};
}
function fractionToValue(fr){ return fr.n/fr.d; }
function fractionToString(fr){
  const s=simplifyFraction(fr);
  if(s.d===1) return String(s.n);
  return `${s.n}/${s.d}`;
}
function fractionToHtml(fr){
  const s=simplifyFraction(fr);
  if(s.d===1) return String(s.n);
  return `<span class="frac"><span class="top">${s.n}</span><span class="bottom">${s.d}</span></span>`;
}
function addFrac(a,b){
  return simplifyFraction({n:a.n*b.d + b.n*a.d, d:a.d*b.d});
}
function subFrac(a,b){
  return simplifyFraction({n:a.n*b.d - b.n*a.d, d:a.d*b.d});
}
function toMixed(fr){
  const s=simplifyFraction(fr);
  const sign = s.n<0 ? -1 : 1;
  const n = Math.abs(s.n), d = s.d;
  const whole = Math.floor(n/d);
  const rem = n % d;
  if(rem===0) return {whole: sign*whole, num:0, den:1, isInt:true};
  const simp = simplifyFraction({n:rem, d});
  return {whole: sign*whole, num:simp.n, den:simp.d, isInt:false};
}
function mixedToImproper(m){
  const w=m.whole, n=m.num, d=m.den;
  return simplifyFraction({n:w*d + n, d});
}
function formatMs(ms){
  const totalSec=Math.floor(ms/1000);
  const min=Math.floor(totalSec/60);
  const sec=totalSec%60;
  return `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

/* ---------------- Mixed display ---------------- */
function mixedBoxesHtml(whole, num, den){
  return `
    <span class="mix3" aria-label="mixed number display">
      <span class="mix-cell mix-whole">${whole}</span>
      <span class="mix-frac" aria-label="fraction part">
        <span class="mix-cell mix-num">${num}</span>
        <span class="mix-bar" aria-hidden="true"></span>
        <span class="mix-cell mix-den">${den}</span>
      </span>
    </span>
  `;
}
function mixedToString(whole, num, den){
  return `${whole} ${num}/${den}`;
}

/* ---------------- Random fractions ---------------- */
const SMALL_DENS = [2,3,4,5,6,8,9,10,12,14,15];
function randomProperFrac(){
  const d=choice(SMALL_DENS);
  let n=randInt(1,d-1), t=0;
  while(gcd(n,d)!==1 && t<40){ n=randInt(1,d-1); t++; }
  return simplifyFraction({n,d});
}
function randomImproperFrac(){
  const d=choice([3,4,5,6,7,8,9,10,12]);
  let n=randInt(d+1, d*2+8), t=0;
  while(gcd(n,d)!==1 && t<40){ n=randInt(d+1, d*2+8); t++; }
  return simplifyFraction({n,d});
}

/* ---------------- URL name param ---------------- */
function getNameFromUrl(){
  try{
    const sp = new URLSearchParams(window.location.search);
    const raw = sp.get("name");
    if(!raw) return null;
    const name = String(raw).trim();
    return name.length ? name : null;
  }catch(e){ return null; }
}
function updateStudentDisplay(){
  const el = document.getElementById("studentDisplay");
  if(el) el.innerHTML = `Student: <strong>${studentName || "—"}</strong>`;
}

/* ---------------- Parse Answers ---------------- */
function parseAnswer(str){
  let s=(str||"").trim();
  if(s==="") return NaN;

  let sign=1;
  if(s[0]==="+"){ s=s.slice(1).trim(); }
  else if(s[0]==="-"){ sign=-1; s=s.slice(1).trim(); }
  if(s==="") return NaN;

  // mixed: "2 1/3"
  const spaceParts=s.split(/\s+/);
  if(spaceParts.length===2 && spaceParts[1].includes("/")){
    const whole=Number(spaceParts[0]);
    const fracParts=spaceParts[1].split("/");
    if(fracParts.length!==2) return NaN;
    const num=Number(fracParts[0]);
    const den=Number(fracParts[1]);
    if(!Number.isFinite(whole)||!Number.isFinite(num)||!Number.isFinite(den)||den===0) return NaN;
    const absWhole=Math.abs(whole);
    const fracVal=num/den;
    let value=absWhole+fracVal;
    if(whole<0) value=-value;
    return sign*value;
  }

  // fraction: a/b
  if(s.includes("/")){
    const parts=s.split("/");
    if(parts.length!==2) return NaN;
    const num=Number(parts[0]);
    const den=Number(parts[1]);
    if(!Number.isFinite(num)||!Number.isFinite(den)||den===0) return NaN;
    return sign*(num/den);
  }

  // decimal/int
  const n=Number(s);
  return Number.isFinite(n)?sign*n:NaN;
}
function nearlyEqual(a,b,eps=1e-6){
  if(!Number.isFinite(a)||!Number.isFinite(b)) return false;
  return Math.abs(a-b)<eps;
}
function gradeOneQuestion(i){
  const q = questions[i];
  const val = parseAnswer(q.userValue || "");
  q.isCorrect = nearlyEqual(val, q.value);
}

/* ---------------- Mixed input helpers (ONLY for parts E & F) ---------------- */
function isMixedAnswerQuestion(q){
  return (q.partIndex===4 || q.partIndex===5); // E or F
}
function splitMixedUserValue(userValue){
  const out = {w:"", n:"", d:""};
  const s = (userValue||"").trim();
  if(!s) return out;
  const parts = s.split(/\s+/);
  if(parts.length===2 && parts[1].includes("/")){
    out.w = parts[0];
    const fr = parts[1].split("/");
    out.n = fr[0] ?? "";
    out.d = fr[1] ?? "";
  }
  return out;
}
function buildMixedUserValue(w,n,d){
  const W=(w||"").trim();
  const N=(n||"").trim();
  const D=(d||"").trim();
  if(!W && !N && !D) return "";
  return `${W} ${N}/${D}`.trim();
}

/* ---------------- Standard Question generators ---------------- */
function makeProperSameDenAdd(){
  const d = randInt(6, 15);
  const n1 = randInt(1, d-2);
  const n2 = randInt(1, (d-1)-n1);
  const a = simplifyFraction({n:n1,d});
  const b = simplifyFraction({n:n2,d});
  const ans = addFrac(a,b);
  return { text:`Compute: ${fractionToHtml(a)} + ${fractionToHtml(b)} = ?`,
    value:fractionToValue(ans), display:fractionToString(ans), displayHtml:fractionToHtml(ans) };
}
function makeProperDiffDenAdd(){
  const dens = [4,5,6,7,8,9,10,12,14,15,16];
  for(let t=0;t<600;t++){
    let d1=choice(dens), d2=choice(dens);
    if(d1===d2) continue;
    let n1=randInt(1,d1-1), n2=randInt(1,d2-1);
    const a=simplifyFraction({n:n1,d:d1});
    const b=simplifyFraction({n:n2,d:d2});
    const val=fractionToValue(a)+fractionToValue(b);
    if(val>=1) continue;
    const ans=addFrac(a,b);
    if(ans.n<=0 || ans.n>=ans.d) continue;
    return { text:`Compute: ${fractionToHtml(a)} + ${fractionToHtml(b)} = ? <span style="color:#555">(Answer in simplest form.)</span>`,
      value:fractionToValue(ans), display:fractionToString(ans), displayHtml:fractionToHtml(ans) };
  }
  return makeProperDiffDenAdd();
}
function makeProperSameDenSub(){
  const d = randInt(6, 15);
  const n1 = randInt(2, d-1);
  const n2 = randInt(1, n1-1);
  const a=simplifyFraction({n:n1,d});
  const b=simplifyFraction({n:n2,d});
  const ans=subFrac(a,b);
  return { text:`Compute: ${fractionToHtml(a)} − ${fractionToHtml(b)} = ?`,
    value:fractionToValue(ans), display:fractionToString(ans), displayHtml:fractionToHtml(ans) };
}
function makeProperDiffDenSub(){
  const dens = [4,5,6,7,8,9,10,12,14,15,16];
  for(let t=0;t<800;t++){
    let d1=choice(dens), d2=choice(dens);
    if(d1===d2) continue;
    let n1=randInt(1,d1-1), n2=randInt(1,d2-1);
    const a=simplifyFraction({n:n1,d:d1});
    const b=simplifyFraction({n:n2,d:d2});
    const val=fractionToValue(a)-fractionToValue(b);
    if(val<=0 || val>=1) continue;
    const ans=subFrac(a,b);
    if(ans.n<=0 || ans.n>=ans.d) continue;
    return { text:`Compute: ${fractionToHtml(a)} − ${fractionToHtml(b)} = ? <span style="color:#555">(Answer in simplest form.)</span>`,
      value:fractionToValue(ans), display:fractionToString(ans), displayHtml:fractionToHtml(ans) };
  }
  return makeProperDiffDenSub();
}
function makeImproperDiffDenAdd(){
  for(let t=0;t<800;t++){
    const a=randomImproperFrac(), b=randomImproperFrac();
    if(a.d===b.d && a.n===b.n) continue;
    const ans=addFrac(a,b);
    if(ans.n<=ans.d) continue;
    if(ans.n>450 || ans.d>480) continue;
    return { text:`Compute: ${fractionToHtml(a)} + ${fractionToHtml(b)} = ? <span style="color:#555">(Answer as an improper fraction in simplest form.)</span>`,
      value:fractionToValue(ans), display:fractionToString(ans), displayHtml:fractionToHtml(ans) };
  }
  return makeImproperDiffDenAdd();
}
function makeImproperDiffDenSub(){
  for(let t=0;t<1200;t++){
    const a=randomImproperFrac();
    const b=randomImproperFrac();
    const val=fractionToValue(a)-fractionToValue(b);
    if(val<=1) continue;
    const ans=subFrac(a,b);
    if(ans.n<=ans.d) continue;
    if(ans.n>450 || ans.d>480) continue;
    return { text:`Compute: ${fractionToHtml(a)} − ${fractionToHtml(b)} = ? <span style="color:#555">(Answer as an improper fraction in simplest form.)</span>`,
      value:fractionToValue(ans), display:fractionToString(ans), displayHtml:fractionToHtml(ans) };
  }
  return makeImproperDiffDenSub();
}
function makeMixedAdd(){
  const dens=[3,4,5,6,7,8,9,10,12];
  for(let t=0;t<1200;t++){
    let d1=choice(dens), d2=choice(dens);
    if(d1===d2) continue;
    let w1=randInt(1,3), w2=randInt(1,3);
    let n1=randInt(1,d1-1), n2=randInt(1,d2-1);
    const f1=simplifyFraction({n:n1,d:d1});
    const f2=simplifyFraction({n:n2,d:d2});
    const m1={whole:w1,num:f1.n,den:f1.d};
    const m2={whole:w2,num:f2.n,den:f2.d};
    const a=mixedToImproper(m1);
    const b=mixedToImproper(m2);
    const ans=addFrac(a,b);
    const mixed=toMixed(ans);
    if(mixed.isInt) continue;
    if(mixed.whole<1) continue;
    return { text:`Compute: ${mixedBoxesHtml(m1.whole,m1.num,m1.den)} + ${mixedBoxesHtml(m2.whole,m2.num,m2.den)} = ? <span style="color:#555">(Answer as a mixed number using the 3 boxes.)</span>`,
      value:fractionToValue(ans), display:mixedToString(mixed.whole,mixed.num,mixed.den), displayHtml:mixedBoxesHtml(mixed.whole,mixed.num,mixed.den) };
  }
  return makeMixedAdd();
}
function makeMixedSub(){
  const dens=[3,4,5,6,7,8,9,10,12];
  for(let t=0;t<1600;t++){
    let d1=choice(dens), d2=choice(dens);
    if(d1===d2) continue;
    let w1=randInt(3,6), w2=randInt(1,3);
    let n1=randInt(1,d1-1), n2=randInt(1,d2-1);
    const f1=simplifyFraction({n:n1,d:d1});
    const f2=simplifyFraction({n:n2,d:d2});
    const m1={whole:w1,num:f1.n,den:f1.d};
    const m2={whole:w2,num:f2.n,den:f2.d};
    const a=mixedToImproper(m1);
    const b=mixedToImproper(m2);
    const val=fractionToValue(a)-fractionToValue(b);
    if(val<=1) continue;
    const ans=subFrac(a,b);
    const mixed=toMixed(ans);
    if(mixed.isInt) continue;
    if(mixed.whole<1) continue;
    return { text:`Compute: ${mixedBoxesHtml(m1.whole,m1.num,m1.den)} − ${mixedBoxesHtml(m2.whole,m2.num,m2.den)} = ? <span style="color:#555">(Answer as a mixed number using the 3 boxes.)</span>`,
      value:fractionToValue(ans), display:mixedToString(mixed.whole,mixed.num,mixed.den), displayHtml:mixedBoxesHtml(mixed.whole,mixed.num,mixed.den) };
  }
  return makeMixedSub();
}

/* ✅ Part G: THREE TERMS (fractions / improper / integers) */
function makeThreeTermAddSub(){
  function randomTerm(){
    const type = choice(["int","proper","improper"]);
    if(type==="int") return simplifyFraction({n: randInt(1, 6), d: 1});
    if(type==="proper") return randomProperFrac();
    return randomImproperFrac();
  }
  for(let t=0;t<2500;t++){
    const a=randomTerm(), b=randomTerm(), c=randomTerm();
    const op1=choice(["+","−"]);
    const op2=choice(["+","−"]);
    const step1 = (op1==="+") ? addFrac(a,b) : subFrac(a,b);
    if(fractionToValue(step1)<=0) continue;
    const ans = (op2==="+") ? addFrac(step1,c) : subFrac(step1,c);
    if(fractionToValue(ans)<=0) continue;
    if(ans.n>520 || ans.d>520) continue;
    return {
      text:`Compute: ${fractionToHtml(a)} ${op1} ${fractionToHtml(b)} ${op2} ${fractionToHtml(c)} = ? <span style="color:#555">(Answer in simplest form.)</span>`,
      value:fractionToValue(ans), display:fractionToString(ans), displayHtml:fractionToHtml(ans)
    };
  }
  return makeThreeTermAddSub();
}

/* ---------------- Part H: Word Problems (unique-ish scenarios) ---------------- */
const NAMES = ["Ava","Leo","Mia","Noah","Sofia","Ethan","Zoe","Lucas","Ivy","Hugo","Aria","Mason"];
const ITEMS = ["pizza","chocolate bar","water bottle","juice carton","ribbon roll","bag of rice","bag of flour","garden bed","book","trail"];
function pickUniqueTemplate(pool, usedKeys){
  const available = pool.filter(t => !usedKeys.has(t.key));
  const picked = choice(available.length ? available : pool);
  usedKeys.add(picked.key);
  return picked;
}
function ensureNiceProperInRange(minV, maxV){
  for(let t=0;t<600;t++){
    const f=randomProperFrac();
    const v=fractionToValue(f);
    if(v>minV && v<maxV) return f;
  }
  return randomProperFrac();
}

/* 1-step ADD word problem (1 question) */
const WP_ADD1_TEMPLATES = [
  {
    key:"wp_add_reading",
    build: ()=>{
      const name=choice(NAMES);
      const f1=ensureNiceProperInRange(0.15,0.55);
      const f2=ensureNiceProperInRange(0.10,0.45);
      const ans=addFrac(f1,f2);
      return {
        text:`${name} read ${fractionToHtml(f1)} of a book on Monday and ${fractionToHtml(f2)} of the same book on Tuesday. What fraction of the book did ${name} read in total?`,
        ans
      };
    }
  },
  {
    key:"wp_add_pizza",
    build: ()=>{
      const name=choice(NAMES);
      const f1=ensureNiceProperInRange(0.10,0.50);
      const f2=ensureNiceProperInRange(0.10,0.50);
      const ans=addFrac(f1,f2);
      return {
        text:`At a party, ${name} ate ${fractionToHtml(f1)} of a pizza, and later ate another ${fractionToHtml(f2)} of the same pizza. What fraction of the pizza did ${name} eat altogether?`,
        ans
      };
    }
  },
  {
    key:"wp_add_paint",
    build: ()=>{
      const name=choice(NAMES);
      const f1=ensureNiceProperInRange(0.10,0.55);
      const f2=ensureNiceProperInRange(0.10,0.55);
      const ans=addFrac(f1,f2);
      return {
        text:`${name} painted ${fractionToHtml(f1)} of a wall in the morning and ${fractionToHtml(f2)} of the same wall in the afternoon. What fraction of the wall was painted in total?`,
        ans
      };
    }
  },
  {
    key:"wp_add_juice",
    build: ()=>{
      const name=choice(NAMES);
      const f1=ensureNiceProperInRange(0.10,0.50);
      const f2=ensureNiceProperInRange(0.10,0.50);
      const ans=addFrac(f1,f2);
      return {
        text:`${name} drank ${fractionToHtml(f1)} of a juice carton before lunch and ${fractionToHtml(f2)} of the same carton after lunch. What fraction of the carton did ${name} drink altogether?`,
        ans
      };
    }
  }
];

/* 1-step SUB word problem (1 question) */
const WP_SUB1_TEMPLATES = [
  {
    key:"wp_sub_tank",
    build: ()=>{
      const name=choice(NAMES);
      const start=ensureNiceProperInRange(0.55,0.95);
      const used=ensureNiceProperInRange(0.10,0.45);
      // ensure start > used
      if(fractionToValue(start)<=fractionToValue(used)) return WP_SUB1_TEMPLATES[0].build();
      const ans=subFrac(start,used);
      return {
        text:`A tank was ${fractionToHtml(start)} full. ${name} used ${fractionToHtml(used)} of the tank. What fraction of the tank is full now?`,
        ans
      };
    }
  },
  {
    key:"wp_sub_ribbon",
    build: ()=>{
      const name=choice(NAMES);
      const start=ensureNiceProperInRange(0.60,0.95);
      const used=ensureNiceProperInRange(0.10,0.40);
      if(fractionToValue(start)<=fractionToValue(used)) return WP_SUB1_TEMPLATES[1].build();
      const ans=subFrac(start,used);
      return {
        text:`${name} had ${fractionToHtml(start)} of a ribbon roll left. Then ${name} used ${fractionToHtml(used)} of a roll. What fraction of a roll is left now?`,
        ans
      };
    }
  },
  {
    key:"wp_sub_chocolate",
    build: ()=>{
      const name=choice(NAMES);
      const start=ensureNiceProperInRange(0.55,0.95);
      const gave=ensureNiceProperInRange(0.10,0.40);
      if(fractionToValue(start)<=fractionToValue(gave)) return WP_SUB1_TEMPLATES[2].build();
      const ans=subFrac(start,gave);
      return {
        text:`${name} had ${fractionToHtml(start)} of a chocolate bar. ${name} gave away ${fractionToHtml(gave)} of a bar. How much of the chocolate bar does ${name} have now?`,
        ans
      };
    }
  }
];

/* 2+ step word problems (3 questions) */
const WP_MULTI_TEMPLATES = [
  {
    key:"wp_multi_bottle",
    build: ()=>{
      const name=choice(NAMES);
      const total = simplifyFraction({n:2,d:1}); // 2 L
      const drank1=ensureNiceProperInRange(0.10,0.40);
      const drank2=ensureNiceProperInRange(0.10,0.35);
      const added = ensureNiceProperInRange(0.10,0.40);
      // ans = 2 - drank1 - drank2 + added
      let ans=subFrac(subFrac(total,drank1),drank2);
      ans=addFrac(ans,added);
      if(fractionToValue(ans)<=0) return WP_MULTI_TEMPLATES[0].build();
      return {
        text:`${name} has 2 litres of water. ${name} drinks ${fractionToHtml(drank1)} litre in the morning and ${fractionToHtml(drank2)} litre in the afternoon. Later, ${name} adds ${fractionToHtml(added)} litre more. How many litres of water does ${name} have now?`,
        ans
      };
    }
  },
  {
    key:"wp_multi_garden",
    build: ()=>{
      const name=choice(NAMES);
      const planted1=ensureNiceProperInRange(0.25,0.60);
      const planted2=ensureNiceProperInRange(0.10,0.35);
      const removed = ensureNiceProperInRange(0.05,0.25);
      let ans=addFrac(planted1,planted2);
      // ensure planted total > removed
      if(fractionToValue(ans)<=fractionToValue(removed)) return WP_MULTI_TEMPLATES[1].build();
      ans=subFrac(ans,removed);
      return {
        text:`In a garden bed, ${name} plants ${fractionToHtml(planted1)} of the bed with flowers, then plants another ${fractionToHtml(planted2)} with vegetables. Later, ${name} removes ${fractionToHtml(removed)} of the bed to make a path. What fraction of the bed is planted now?`,
        ans
      };
    }
  },
  {
    key:"wp_multi_reading_week",
    build: ()=>{
      const name=choice(NAMES);
      const mon=ensureNiceProperInRange(0.10,0.35);
      const tue=ensureNiceProperInRange(0.10,0.35);
      const wed=ensureNiceProperInRange(0.10,0.35);
      // total read = mon + tue + wed
      let ans=addFrac(addFrac(mon,tue),wed);
      // keep <= 1
      if(fractionToValue(ans)>=1) return WP_MULTI_TEMPLATES[2].build();
      return {
        text:`${name} reads ${fractionToHtml(mon)} of a book on Monday, ${fractionToHtml(tue)} on Tuesday, and ${fractionToHtml(wed)} on Wednesday. What fraction of the book did ${name} read in total over these three days?`,
        ans
      };
    }
  },
  {
    key:"wp_multi_recipe",
    build: ()=>{
      const name=choice(NAMES);
      const need = simplifyFraction({n:3,d:2}); // 1 1/2 cups
      const used1=ensureNiceProperInRange(0.25,0.60);
      const used2=ensureNiceProperInRange(0.20,0.55);
      // remaining = 1 1/2 - used1 - used2  (ensure positive)
      let ans=subFrac(subFrac(need,used1),used2);
      if(fractionToValue(ans)<=0) return WP_MULTI_TEMPLATES[3].build();
      return {
        text:`A recipe needs 1 1/2 cups of milk. ${name} pours ${fractionToHtml(used1)} cup, then pours another ${fractionToHtml(used2)} cup. How many cups of milk are still needed?`,
        ans
      };
    }
  },
  {
    key:"wp_multi_trail",
    build: ()=>{
      const name=choice(NAMES);
      const total = simplifyFraction({n:1,d:1});
      const part1=ensureNiceProperInRange(0.20,0.55);
      const part2=ensureNiceProperInRange(0.15,0.45);
      let walked=addFrac(part1,part2);
      if(fractionToValue(walked)>=1) return WP_MULTI_TEMPLATES[4].build();
      const left=subFrac(total,walked);
      return {
        text:`On a trail, ${name} walks ${fractionToHtml(part1)} of the trail in the morning and ${fractionToHtml(part2)} in the afternoon. What fraction of the trail is still left to walk?`,
        ans:left
      };
    }
  },
  {
    key:"wp_multi_school",
    build: ()=>{
      const name=choice(NAMES);
      const total = simplifyFraction({n:5,d:2}); // 2 1/2 hours
      const hw=ensureNiceProperInRange(0.30,0.80);    // hours
      const reading=ensureNiceProperInRange(0.30,0.80);
      // time left = 2.5 - hw - reading (ensure positive)
      let ans=subFrac(subFrac(total,hw),reading);
      if(fractionToValue(ans)<=0) return WP_MULTI_TEMPLATES[5].build();
      return {
        text:`${name} has 2 1/2 hours of free time. ${name} spends ${fractionToHtml(hw)} hour on homework and ${fractionToHtml(reading)} hour reading. How many hours of free time are left?`,
        ans
      };
    }
  }
];

function makeWordProblemAdd1(usedKeys){
  const t = pickUniqueTemplate(WP_ADD1_TEMPLATES, usedKeys);
  const built = t.build();
  const ans = simplifyFraction(built.ans);
  return {
    text: built.text + ` <span style="color:#555">(Give your answer in simplest form.)</span>`,
    value: fractionToValue(ans),
    display: fractionToString(ans),
    displayHtml: fractionToHtml(ans)
  };
}
function makeWordProblemSub1(usedKeys){
  const t = pickUniqueTemplate(WP_SUB1_TEMPLATES, usedKeys);
  const built = t.build();
  const ans = simplifyFraction(built.ans);
  return {
    text: built.text + ` <span style="color:#555">(Give your answer in simplest form.)</span>`,
    value: fractionToValue(ans),
    display: fractionToString(ans),
    displayHtml: fractionToHtml(ans)
  };
}
function makeWordProblemMulti(usedKeys){
  const t = pickUniqueTemplate(WP_MULTI_TEMPLATES, usedKeys);
  const built = t.build();
  const ans = simplifyFraction(built.ans);
  return {
    text: built.text + ` <span style="color:#555">(Give your answer in simplest form.)</span>`,
    value: fractionToValue(ans),
    display: fractionToString(ans),
    displayHtml: fractionToHtml(ans)
  };
}

/* ---------------- Build per-part questions ---------------- */
let wpUsedKeys = new Set(); // reset each Generate New Set

function generateQuestionForPart(partIndex, indexInPart){
  if(partIndex===0) return (indexInPart===0) ? makeProperSameDenAdd() : makeProperDiffDenAdd();
  if(partIndex===1) return (indexInPart===0) ? makeProperSameDenSub() : makeProperDiffDenSub();
  if(partIndex===2) return makeImproperDiffDenAdd();
  if(partIndex===3) return makeImproperDiffDenSub();
  if(partIndex===4) return makeMixedAdd();
  if(partIndex===5) return makeMixedSub();
  if(partIndex===6) return makeThreeTermAddSub();

  // Part H (last):
  if(indexInPart===0) return makeWordProblemAdd1(wpUsedKeys);       // 1-step add (1)
  if(indexInPart===1) return makeWordProblemSub1(wpUsedKeys);       // 1-step sub (1)
  return makeWordProblemMulti(wpUsedKeys);                           // 2+ step (3)
}

/* ---------------- State ---------------- */
let questions=[];
let currentQuestionIndex=0;
let studentName="Student";
let quizStartTime=null;
let quizEndTime=null;
let quizSubmitted=false;

let timerInterval=null;
let elapsedMs=0;
let isPaused=false;
let firstAttemptMs=null;

const quizContent=document.getElementById("quizContent");
const sidebarEl=document.getElementById("sidebar");

const buttonContainer=document.getElementById("navButtons");
const backButton=document.getElementById("backButton");
const nextButton=document.getElementById("nextButton");
const submitButton=document.getElementById("submitButton");
const checkButton=document.getElementById("checkButton");
const saveButton=document.getElementById("saveButton");

const generateBtn=document.getElementById("generateButton");
const pauseButton=document.getElementById("pauseButton");
const exportPdfButton=document.getElementById("exportPdfButton");
const timerDisplay=document.getElementById("timerDisplay");

/* ---------------- Timer ---------------- */
function updateTimerDisplay(){
  let totalMs=elapsedMs;
  if(!isPaused && quizStartTime) totalMs+=(new Date()-quizStartTime);
  let text=`Time: ${formatMs(totalMs)}`;
  if(firstAttemptMs!==null) text+=` (First: ${formatMs(firstAttemptMs)})`;
  timerDisplay.textContent=text;
}
function startTimerInterval(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(updateTimerDisplay, 1000);
}
function pauseTimer(){
  if(isPaused || !quizStartTime) return;
  const now=new Date();
  elapsedMs+=now-quizStartTime;
  isPaused=true;
  quizStartTime=null;
  updateTimerDisplay();
}
function resumeTimer(){
  if(!isPaused) return;
  isPaused=false;
  quizStartTime=new Date();
  updateTimerDisplay();
}

/* ---------------- Generate Quiz ---------------- */
function generateQuiz(){
  questions=[];
  quizSubmitted=false;
  wpUsedKeys = new Set(); // reset word-problem scenario uniqueness

  for(let p=0;p<PART_TITLES.length;p++){
    for(let i=0;i<PART_COUNTS[p];i++){
      const baseQ = generateQuestionForPart(p,i);
      questions.push({
        partIndex:p,
        indexInPart:i,
        text:baseQ.text,
        value:baseQ.value,
        display:baseQ.display,
        displayHtml:baseQ.displayHtml||null,
        userValue:"",
        isCorrect:false
      });
    }
  }
}

/* ---------------- Sidebar ---------------- */
function renderSidebar(){
  sidebarEl.style.display="block";
  sidebarEl.innerHTML=`<h4>Questions</h4><ul id="qList"></ul>`;
  const ul=document.getElementById("qList");

  for(let i=0;i<questions.length;i++){
    const q=questions[i];
    const li=document.createElement("li");
    const label = PART_LETTERS[q.partIndex] + (q.indexInPart+1);
    li.textContent=`Q${i+1} (${label})`;
    li.dataset.index=i;
    li.addEventListener("click", ()=>{
      saveCurrentInput();
      currentQuestionIndex=i;
      renderQuestion();
    });
    ul.appendChild(li);
  }
  updateSidebarStatus();
}
function updateSidebarStatus(){
  const items=document.querySelectorAll("#qList li");
  items.forEach(li=>{
    const idx=Number(li.dataset.index);
    const q=questions[idx];

    li.classList.remove("active","answered","correct","incorrect");

    if(!quizSubmitted){
      li.classList.toggle("active", idx===currentQuestionIndex);
      if((q.userValue||"").trim()!=="") li.classList.add("answered");
    }else{
      if((q.userValue||"").trim()!==""){
        li.classList.add(q.isCorrect ? "correct" : "incorrect");
      }
    }
  });
}

/* ---------------- Helpers ---------------- */
function saveCurrentInput(){
  const q = questions[currentQuestionIndex];

  if(isMixedAnswerQuestion(q)){
    const wEl = document.getElementById("wholeInput");
    const nEl = document.getElementById("numInput");
    const dEl = document.getElementById("denInput");
    if(wEl && nEl && dEl){
      q.userValue = buildMixedUserValue(wEl.value, nEl.value, dEl.value);
    }
  }else{
    const input=document.getElementById("answerInput");
    if(input) q.userValue = input.value.trim();
  }

  if(quizSubmitted){
    gradeOneQuestion(currentQuestionIndex);
    updateSidebarStatus();
  }
}
function mountNavButtonsInto(slotId){
  const slot=document.getElementById(slotId);
  if(!slot) return;
  slot.appendChild(buttonContainer);
  buttonContainer.style.display="flex";
}
function buildPerQuestionHint(q){
  if(q.partIndex===0) return `Hint: Same denominator → add numerators. Different denominators → find a common denominator, then add and simplify.`;
  if(q.partIndex===1) return `Hint: Same denominator → subtract numerators. Different denominators → use a common denominator, then subtract and simplify.`;
  if(q.partIndex===2) return `Hint: Add using a common denominator. Keep the answer as an improper fraction in simplest form.`;
  if(q.partIndex===3) return `Hint: Use a common denominator, subtract, then simplify. Keep the answer as an improper fraction in simplest form.`;
  if(q.partIndex===4) return `Hint: Convert mixed numbers to improper fractions, add, simplify, then convert back to a mixed number.`;
  if(q.partIndex===5) return `Hint: Convert mixed numbers to improper fractions, subtract, simplify, then convert back to a mixed number.`;
  if(q.partIndex===6) return `Hint: Work left to right. If you subtract, make sure the running total stays positive. Simplify at the end.`;
  return `Hint: Turn the story into an expression (add/subtract). Do it step by step, then simplify your final fraction.`;
}

/* ---------------- Render Question ---------------- */
function renderQuestion(){
  const q=questions[currentQuestionIndex];
  const fullLabel = PART_LETTERS[q.partIndex] + (q.indexInPart+1);
  const hintText = buildPerQuestionHint(q);

  const mixedMode = isMixedAnswerQuestion(q);
  const pre = splitMixedUserValue(q.userValue);

  const answerInputHtml = mixedMode ? `
    <div class="mix-input3">
      <span class="mix3" aria-label="mixed number input">
        <input id="wholeInput" class="whole-in" type="text"
          value="${(pre.w||"").replace(/"/g,'&quot;')}" placeholder="Whole">
        <span class="mix-frac" aria-label="fraction input">
          <input id="numInput" class="num-in" type="text"
            value="${(pre.n||"").replace(/"/g,'&quot;')}" placeholder="Num">
          <span class="mix-bar" aria-hidden="true"></span>
          <input id="denInput" class="den-in" type="text"
            value="${(pre.d||"").replace(/"/g,'&quot;')}" placeholder="Den">
        </span>
      </span>
    </div>
    <div style="margin-top:6px;color:#666;font-size:.9em;">
      Answer as a mixed number: fill <strong>Whole</strong>, <strong>Num</strong>, <strong>Den</strong>.
    </div>
  ` : `
    <div>
      <input id="answerInput" class="answer-box" type="text"
        value="${(q.userValue||"").replace(/"/g,'&quot;')}"
        placeholder="Type your answer (e.g., 5/6 or 1 1/4)">
    </div>
  `;

  quizContent.innerHTML=`
    <p class="question-text">Question ${currentQuestionIndex+1} of ${questions.length}</p>
    <div class="part-title">${PART_TITLES[q.partIndex]}</div>

    <div class="single-question">
      <strong>${fullLabel}.</strong> ${q.text}
      ${answerInputHtml}
      <div id="checkFeedback" style="display:none;"></div>
      <div class="hint">${hintText}</div>
    </div>

    <div id="navSlot"></div>
  `;

  mountNavButtonsInto("navSlot");

  backButton.style.display="inline-block";
  backButton.style.visibility = (currentQuestionIndex===0) ? "hidden" : "visible";

  const isLast = (currentQuestionIndex===questions.length-1);
  nextButton.style.display = isLast ? "none" : "inline-block";
  submitButton.style.display = isLast ? "inline-block" : "none";

  saveButton.style.display = quizSubmitted ? "inline-block" : "none";
  checkButton.style.display = (quizSubmitted && !q.isCorrect) ? "inline-block" : "none";

  updateSidebarStatus();
}

/* ---------------- Results + Submit ---------------- */
function calculateAndShowResults(){
  saveCurrentInput();

  const now=new Date();
  let attemptMs=elapsedMs;
  if(!isPaused && quizStartTime) attemptMs+=now-quizStartTime;

  if(firstAttemptMs===null) firstAttemptMs=attemptMs;

  const attemptStartTime=quizStartTime || now;
  quizEndTime=now;
  quizSubmitted=true;

  let correctCount=0;
  questions.forEach(q=>{
    const val=parseAnswer(q.userValue||"");
    q.isCorrect=nearlyEqual(val, q.value);
    if(q.isCorrect) correctCount++;
  });

  updateSidebarStatus();

  let html=`
    <h3>Results for ${studentName}</h3>
    <p>Score: <strong>${correctCount} / ${questions.length}</strong></p>
    <p>Start time: <strong>${attemptStartTime.toLocaleTimeString()}</strong></p>
    <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
    <p>Time taken (this attempt): <strong>${formatMs(attemptMs)}</strong></p>
    <p>First attempt time: <strong>${formatMs(firstAttemptMs)}</strong></p>
    <p>Click question numbers on the left to review. Incorrect questions will have a <strong>Check</strong> button.</p>

    <table class="review-table">
      <tr>
        <th>#</th><th>Part</th><th>Question</th><th>Your Answer</th><th>Correct</th><th>Result</th>
      </tr>
  `;

  questions.forEach((q,i)=>{
    const partLbl = PART_LETTERS[q.partIndex] + (q.indexInPart+1);
    html+=`
      <tr class="${q.isCorrect ? "correct-answer":"incorrect-answer"}">
        <td>${i+1}</td>
        <td>${partLbl}</td>
        <td>${q.text}</td>
        <td>${(q.userValue||"").trim()==="" ? "—" : (q.userValue||"")}</td>
        <td>${q.displayHtml || q.display}</td>
        <td>${(q.userValue||"").trim()==="" ? "Not answered" : (q.isCorrect ? "Correct":"Incorrect")}</td>
      </tr>
    `;
  });

  html+=`</table><div id="navSlot"></div>`;
  quizContent.innerHTML=html;

  mountNavButtonsInto("navSlot");

  backButton.style.display="none";
  nextButton.style.display="none";
  submitButton.style.display="none";
  checkButton.style.display="none";
  saveButton.style.display="inline-block";

  // reset timer for next attempt
  elapsedMs=0; isPaused=false; quizStartTime=new Date();
  pauseButton.textContent="Pause";
  startTimerInterval();
  updateTimerDisplay();
}

/* ---------------- Buttons ---------------- */
nextButton.addEventListener("click", ()=>{
  saveCurrentInput();
  if(currentQuestionIndex<questions.length-1){
    currentQuestionIndex++;
    renderQuestion();
  }
});
backButton.addEventListener("click", ()=>{
  saveCurrentInput();
  if(currentQuestionIndex>0){
    currentQuestionIndex--;
    renderQuestion();
  }
});
submitButton.addEventListener("click", ()=>{
  if(currentQuestionIndex===questions.length-1){
    calculateAndShowResults();
  }
});
checkButton.addEventListener("click", ()=>{
  saveCurrentInput();

  const q = questions[currentQuestionIndex];
  if(!quizSubmitted) return;

  gradeOneQuestion(currentQuestionIndex);
  updateSidebarStatus();

  const box=document.getElementById("checkFeedback");
  if(!box) return;

  box.className="check-feedback";
  box.style.display="block";

  if(q.isCorrect){
    box.innerHTML = `✅ Correct!`;
    checkButton.style.display = "none";
  }else{
    const correctHtml = q.displayHtml || q.display;
    box.innerHTML = `❌ Incorrect. Correct answer: <strong>${correctHtml}</strong>`;
    checkButton.style.display = "inline-block";
  }
});

/* Save TXT */
function formatDateForFilename(date){
  if(!date) return "no_time";
  const pad=n=>String(n).padStart(2,"0");
  return date.getFullYear()+pad(date.getMonth()+1)+pad(date.getDate())+"_"+
         pad(date.getHours())+pad(date.getMinutes())+pad(date.getSeconds());
}
function saveCurrentResultAsTxt(){
  saveCurrentInput();

  if(!quizSubmitted){
    questions.forEach(q=>{
      const val=parseAnswer(q.userValue||"");
      q.isCorrect=nearlyEqual(val,q.value);
    });
  }
  let correctCount=0;
  questions.forEach(q=>{ if(q.isCorrect) correctCount++; });

  const lines=[];
  lines.push("Fractions Add/Sub Quiz - Current Result");
  lines.push("Student: "+studentName);
  if(quizStartTime) lines.push("Start time: "+quizStartTime.toLocaleString());
  if(quizEndTime) lines.push("Last submit time: "+quizEndTime.toLocaleString());
  lines.push("Score: "+correctCount+" / "+questions.length);
  if(firstAttemptMs!==null) lines.push("First attempt time: "+formatMs(firstAttemptMs));
  lines.push("");
  lines.push("Details:");
  lines.push("----------");

  questions.forEach((q,i)=>{
    const partLbl = PART_LETTERS[q.partIndex] + (q.indexInPart+1);
    const userAns=(q.userValue||"").trim()==="" ? "Not answered" : q.userValue;
    const resultText=(q.userValue||"").trim()==="" ? "Not answered" : (q.isCorrect?"Correct":"Incorrect");
    const plainQuestion=q.text.replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim();
    lines.push(
      `Q${i+1} (${partLbl})`+
      "\nQuestion: "+plainQuestion+
      "\nYour answer: "+userAns+
      "\nCorrect answer: "+q.display+
      "\nResult: "+resultText
    );
    lines.push("");
  });

  const content=lines.join("\n");
  const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const safeName=studentName.replace(/[^a-z0-9_\-]/gi,"_")||"Student";
  const ts=formatDateForFilename(new Date());
  a.href=url;
  a.download=`Fractions_AddSub_${safeName}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
saveButton.addEventListener("click", saveCurrentResultAsTxt);

/* Pause/Resume */
pauseButton.addEventListener("click", ()=>{
  if(!quizStartTime && elapsedMs===0 && !quizSubmitted) return;
  if(isPaused){ resumeTimer(); pauseButton.textContent="Pause"; }
  else { pauseTimer(); pauseButton.textContent="Resume"; }
});

/* Generate new set */
generateBtn.addEventListener("click", ()=>{
  if(!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;

  if(timerInterval) clearInterval(timerInterval);
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  quizStartTime=new Date(); quizEndTime=null;
  updateTimerDisplay(); startTimerInterval();

  pauseButton.style.display="inline-block";
  pauseButton.textContent="Pause";

  generateQuiz();
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();
});

/* ---------------- Export Questions PDF (Print) ---------------- */
function escapeHtml(s){
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function buildQuestionsForPrint(){
  let out = "";
  for(let p=0;p<PART_TITLES.length;p++){
    out += `<div class="part">${escapeHtml(PART_TITLES[p])}</div>`;
    const qs = questions.filter(q=>q.partIndex===p);
    qs.forEach(q=>{
      const label = `${PART_LETTERS[p]}${q.indexInPart+1}`;
      out += `
        <div class="q">
          <div class="qline"><strong>${label}.</strong> ${q.text}</div>
          <div class="blankline"></div>
        </div>
      `;
    });
  }
  return out;
}
function exportQuestionsToPdf(){
  if(!questions || questions.length===0){
    alert("Please start the quiz first.");
    return;
  }
  saveCurrentInput();

  const w = window.open("", "_blank");
  if(!w){
    alert("Popup blocked. Please allow popups for this page, then try again.");
    return;
  }

  const now = new Date();
  const title = "Fractions Add/Sub Quiz — Questions";

  const html = `
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>${title}</title>
  <style>
    body{font-family:'Segoe UI',Tahoma,sans-serif;color:#111;padding:18px 22px;}
    h1{font-size:20px;margin:0 0 6px;}
    .meta{font-size:12.5px;color:#444;margin-bottom:14px;}
    .part{margin-top:14px;font-weight:700;font-size:14px;padding-top:4px;border-top:1px solid #ddd;}
    .q{margin:10px 0 0;}
    .qline{font-size:13.5px;line-height:1.6;}
    .blankline{height:18px;}

    .frac{display:inline-block;text-align:center;vertical-align:middle;min-width:22px;}
    .frac .top{display:block;border-bottom:1px solid #000;padding:0 2px;}
    .frac .bottom{display:block;padding:0 2px;font-size:.9em;}

    :root{--mixWholeW:82px;--mixFracW:82px;--mixNumH:28px;--mixDenH:28px;--mixBarH:2px;--mixBorder:2px;--mixRadius:8px;}
    .mix3{display:inline-grid;grid-template-columns:var(--mixWholeW) var(--mixFracW);column-gap:12px;align-items:center;vertical-align:middle;}
    .mix-cell{box-sizing:border-box;border:var(--mixBorder) solid #333;border-radius:var(--mixRadius);background:#fff;font-weight:700;text-align:center;font-size:0.95em;}
    .mix-whole{width:var(--mixWholeW);height:calc(var(--mixNumH) + var(--mixDenH) + var(--mixBarH));display:flex;align-items:center;justify-content:center;}
    .mix-frac{width:var(--mixFracW);display:grid;grid-template-rows:var(--mixNumH) var(--mixBarH) var(--mixDenH);align-items:stretch;}
    .mix-num,.mix-den{width:var(--mixFracW);height:100%;display:flex;align-items:center;justify-content:center;}
    .mix-bar{width:var(--mixFracW);height:var(--mixBarH);background:#111;border-radius:1px;}

    @media print{@page{margin:14mm;}body{padding:0;}}
  </style>
</head>
<body>
  <h1>${title}</h1>
  <div class="meta">
    Student: <strong>${escapeHtml(studentName)}</strong>
    &nbsp; | &nbsp;
    ${escapeHtml(now.toLocaleString())}
  </div>
  ${buildQuestionsForPrint()}
</body>
</html>`;

  w.document.open();
  w.document.write(html);
  w.document.close();

  w.onload = function(){
    w.focus();
    w.print();
  };
}
exportPdfButton.addEventListener("click", exportQuestionsToPdf);

/* ---------------- Start Screen ---------------- */
function showStartScreen(){
  sidebarEl.style.display="none";
  buttonContainer.style.display="none";
  generateBtn.style.display="none";
  saveButton.style.display="none";
  pauseButton.style.display="none";
  exportPdfButton.style.display="none";

  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  quizStartTime=null; quizEndTime=null;
  updateTimerDisplay();

  updateStudentDisplay();

  quizContent.innerHTML=`
    <p>This quiz contains <strong>${TOTAL_QUESTIONS}</strong> questions.</p>
    <ul style="margin-top:6px;color:#555;line-height:1.6;">
      <li><strong>Proper addition:</strong> 1 same denominator + 3 different denominators</li>
      <li><strong>Proper subtraction:</strong> 1 same denominator + 3 different denominators</li>
      <li><strong>Improper addition:</strong> 2 (different denominators)</li>
      <li><strong>Improper subtraction:</strong> 2 (different denominators)</li>
      <li><strong>Mixed addition:</strong> 2 (different denominators, answer as mixed using 3 boxes)</li>
      <li><strong>Mixed subtraction:</strong> 2 (different denominators, answer as mixed using 3 boxes)</li>
      <li><strong>Three-number add/sub:</strong> 3 questions (fractions / improper / integers)</li>
      <li><strong>Word problems:</strong> 1-step add (1), 1-step sub (1), multi-step (3)</li>
    </ul>
    <p>Please enter your name to begin:</p>

    <input id="nameInput" type="text"
      style="padding:10px;width:250px;font-size:1.05em;"
      placeholder="Your name">

    <button id="startButton"
      style="margin-left:10px;background:#4caf50;padding:10px 20px;color:white;border:none;border-radius:6px;">
      Start Quiz
    </button>
  `;
  document.getElementById("startButton").addEventListener("click", startQuizFromInput);
}

function startQuizCommon(){
  updateStudentDisplay();

  quizStartTime=new Date();
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  updateTimerDisplay(); startTimerInterval();

  generateQuiz();
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();

  generateBtn.style.display="inline-block";
  pauseButton.style.display="inline-block";
  exportPdfButton.style.display="inline-block";
  pauseButton.textContent="Pause";
}

function startQuizFromInput(){
  const nameInput=document.getElementById("nameInput");
  studentName=(nameInput.value || "Student").trim() || "Student";
  startQuizCommon();
}
function startQuizAutoWithName(name){
  studentName = (name || "Student").trim() || "Student";
  startQuizCommon();
}

/* ---------------- Init ---------------- */
(function init(){
  const urlName = getNameFromUrl();
  if(urlName){
    startQuizAutoWithName(urlName);
  }else{
    studentName = "Student";
    showStartScreen();
  }
})();
</script>
</body>
</html>
