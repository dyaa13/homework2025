<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chasing Problems (Pursuit) – Image Quiz</title>

  <style>
    body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f4f4f9;margin:0;padding:20px;color:#333;}
    .quiz-container{max-width:900px;margin:40px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);}
    #headerLogo{display:flex;align-items:center;gap:12px;margin-bottom:10px;border-bottom:2px solid #e0e0e0;padding-bottom:10px;}
    .logo-icon{width:40px;height:40px;background:#0d47a1;border-radius:6px;position:relative;}
    .logo-icon:before{content:"";position:absolute;width:20px;height:9px;background:#ff9800;top:-6px;left:20px;border-radius:3px;}
    .logo-text{display:flex;flex-direction:column;line-height:1.1;}
    .logo-text .brand{font-weight:900;letter-spacing:1px;color:#ff9800;}
    .logo-text .edu{font-size:.9em;color:#0d47a1;font-weight:700;}

    .top-bar{display:flex;justify-content:space-between;align-items:center;margin:10px 0 6px 0;gap:10px;flex-wrap:wrap;}
    #timerDisplay{font-size:.95em;color:#333;}
    #studentLine{font-size:.95em;color:#555;}
    #setLine{font-size:.9em;color:#777;margin-top:2px;}

    .quiz-main{display:flex;gap:20px;margin-top:10px;}
    .sidebar{width:160px;border-right:1px solid #ddd;padding-right:10px;display:none;}
    .sidebar h4{margin:0 0 8px;font-size:.95em;border-bottom:1px solid #eee;padding-bottom:4px;}
    .sidebar ul{list-style:none;padding:0;margin:0;}
    .sidebar li{padding:6px;cursor:pointer;border-radius:6px;font-size:.9em;margin-bottom:6px;border:1px solid #eee;background:#fafafa;}
    .sidebar li.active{outline:2px solid #1976d2;font-weight:700;background:#fff;}
    .sidebar li.answered{border-left:5px solid #4caf50;}
    .sidebar li.correct{background:#d4edda;border-left:5px solid #28a745;border-color:#cbe7d1;}
    .sidebar li.incorrect{background:#f8d7da;border-left:5px solid #f44336;border-color:#f1c7cc;}

    #quizContent{flex:1;}
    .question-text{font-size:1.05em;margin-bottom:8px;}
    .part-title{font-weight:800;margin:8px 0 10px 0;}
    .single-question{margin:6px 0;line-height:1.7;}
    .answer-row{margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .answer-box{width:320px;max-width:100%;padding:8px;font-size:1em;border:1px solid #ccc;border-radius:8px;}

    .img-wrap{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:12px;box-shadow:0 3px 8px rgba(0,0,0,0.05);max-width:100%;}
    .q-img{width:100%;height:auto;display:block;border-radius:10px;}

    .hint-row{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .hint-btn{background:#ff9800;color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:0.95em;}
    .hint-btn:disabled{opacity:.55;cursor:not-allowed;}
    .hint{display:none;margin-top:10px;padding:10px 12px;border-radius:10px;background:#fff7e6;border:1px solid #ffe0b2;color:#5d4037;font-size:0.95em;}
    .hint-diagram-wrap{margin-top:10px;border:1px solid #ffe0b2;background:#ffffff;border-radius:10px;padding:10px;}
    .hint-diagram-wrap img{width:100%;height:auto;display:block;border-radius:8px;}

    .button-container{display:flex;justify-content:space-between;gap:10px;margin-top:14px;flex-wrap:wrap;}
    button{padding:10px 18px;border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:1em;}
    #nextButton{background:#4caf50;}
    #backButton{background:#039be5;}
    #generateButton{background:#ff9800;}
    #submitButton{background:#9c27b0;}
    #saveButton{background:#607d8b;}
    #pauseButton{background:#f57c00;}
    #checkButton{background:#455a64;}
    #exportQuestionsBtn{background:#6a1b9a;}
    button:disabled{opacity:.55;cursor:not-allowed;}

    .check-feedback{margin-top:10px;padding:10px 12px;border-radius:10px;background:#f7f7f7;border:1px solid #e0e0e0;color:#333;font-size:0.95em;}

    table.review-table{width:100%;border-collapse:collapse;margin-top:18px;}
    .review-table th,.review-table td{border:1px solid #ccc;padding:6px;font-size:.85em;text-align:center;vertical-align:top;}
    .review-table th{background:#f2f2f2;}
    .correct-answer{background:#d4edda;}
    .incorrect-answer{background:#f8d7da;}
    .thumb{width:160px;max-width:160px;height:auto;border-radius:8px;border:1px solid #ddd;background:#fff;}

    @media (max-width:760px){
      .quiz-main{flex-direction:column;}
      .sidebar{width:100%;border-right:none;border-bottom:1px solid #ddd;margin-bottom:10px;padding-bottom:10px;}
      .thumb{width:120px;max-width:120px;}
      .answer-box{width:100%;}
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text">
      <div class="brand">DYAA</div>
      <div class="edu">EDUCATION</div>
    </div>
  </div>

  <div class="top-bar">
    <div>
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentLine"></div>
      <div id="setLine"></div>
    </div>
    <div>
      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="generateButton" style="display:none;">Generate New Set</button>
      <button id="exportQuestionsBtn" style="display:none;">Export Questions PDF</button>
    </div>
  </div>

  <h2 style="margin:6px 0 0 0;">Lesson Theme: Chasing Problems (Pursuit) — Line Segment Method</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <div id="navButtons" class="button-container" style="display:none;">
    <button id="backButton" style="display:none;">Previous</button>
    <button id="submitButton" style="display:none;">Submit &amp; View Results</button>
    <button id="nextButton" style="display:none;">Next</button>
    <button id="checkButton" style="display:none;">Check</button>
    <button id="saveButton" style="display:none;">Save Current Result</button>
  </div>
</div>

<!-- ✅ Export-to-PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* ---------------- CONFIG ---------------- */
const SVG_TITLE = "Chasing Problems (Pursuit)";
const PART_TITLES = [
  "Part 1 (Easy) — Catch-up time using relative speed (same direction)",
  "Part 2 (Medium) — Track / remaining distance conditions",
  "Part 3 (Hard) — Turn-back / second overtake conditions"
];
const NUM_PARTS = 3;
const QUESTIONS_PER_PART = 2;
const TOTAL_QUESTIONS = NUM_PARTS * QUESTIONS_PER_PART;

/* ---------------- Names (traditional English) ---------------- */
const NAMES = [
  "Thomas","Catherine","Henry","Sarah","William","Elizabeth",
  "John","Mary","Edward","Anne","George","Margaret",
  "Charles","Alice","Joseph","Jane","Robert","Emily",
  "Oliver","Sophia","James","Arthur","Charlotte","Victoria"
];
function pickTwoNames(){
  const a = NAMES[Math.floor(Math.random()*NAMES.length)];
  let b = a;
  while(b===a) b = NAMES[Math.floor(Math.random()*NAMES.length)];
  return [a,b];
}

/* ---------------- Utils ---------------- */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pick(arr){ return arr[randInt(0, arr.length-1)]; }
function formatMs(ms){
  const totalSec=Math.floor(ms/1000), min=Math.floor(totalSec/60), sec=totalSec%60;
  return `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}
function escapeXml(s){
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&apos;");
}
function wrapLines(lines, maxChars = 58){
  const out=[];
  function pushWrapped(line){
    const words=String(line).split(/\s+/).filter(Boolean);
    let cur="";
    for(const w of words){
      if(w.length>maxChars){
        if(cur){ out.push(cur); cur=""; }
        for(let i=0;i<w.length;i+=maxChars) out.push(w.slice(i,i+maxChars));
        continue;
      }
      if(!cur) cur=w;
      else if((cur+" "+w).length<=maxChars) cur+=" "+w;
      else { out.push(cur); cur=w; }
    }
    if(cur) out.push(cur);
  }
  for(const line of lines) pushWrapped(line);
  return out;
}

/* ✅ Whole-number-only answers */
function parseIntegerAnswer(str){
  const s=(str||"").trim();
  if(s==="") return NaN;
  if(!/^[+-]?\d+$/.test(s)) return NaN;
  const n=Number(s);
  return Number.isInteger(n) ? n : NaN;
}
function isCorrectInt(userInt, correctInt){
  return Number.isInteger(userInt) && userInt===correctInt;
}

/* ---------------- SVG: TEXT CARD (NO DIAGRAM shown here) ---------------- */
function makeSvgTextCard(lines, titleText=SVG_TITLE){
  const W=980, headerH=72, padX=44, lineH=46, firstLineY=headerH+52, padBottom=54;
  const wrapped=wrapLines(lines, 58);
  const H=firstLineY + (wrapped.length-1)*lineH + padBottom;

  const nonce = Math.random().toString(36).slice(2);

  const textSpans=wrapped.map((t,i)=>{
    const y=firstLineY + i*lineH;
    return `<text x="${padX}" y="${y}" font-size="30" fill="#1f2a44" font-family="Segoe UI, Arial">${escapeXml(t)}</text>`;
  }).join("");

  const svg=`
  <svg xmlns="http://www.w3.org/2000/svg" data-nonce="${nonce}" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#f7fbff"/>
        <stop offset="1" stop-color="#ffffff"/>
      </linearGradient>
      <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="0" dy="3" stdDeviation="6" flood-color="#000" flood-opacity="0.12"/>
      </filter>
    </defs>

    <rect x="18" y="18" rx="18" ry="18" width="${W-36}" height="${H-36}"
          fill="url(#g)" stroke="#dfe7f2" stroke-width="3" filter="url(#shadow)"/>
    <rect x="18" y="18" rx="18" ry="18" width="${W-36}" height="${headerH}"
          fill="#0d47a1" opacity="0.10"/>

    <text x="${padX}" y="56" font-size="28" fill="#0d47a1" font-weight="700"
          font-family="Segoe UI, Arial">${escapeXml(titleText)}</text>

    ${textSpans}
  </svg>`.trim();

  const encoded=encodeURIComponent(svg)
    .replaceAll("%0A","").replaceAll("%20"," ")
    .replaceAll("%3D","=").replaceAll("%3A",":")
    .replaceAll("%2F","/").replaceAll("%2C",",");

  return "data:image/svg+xml;charset=utf-8," + encoded;
}

/* ---------------- SVG: CHASE DIAGRAM (ONLY inside Hint box) ---------------- */
function shortenLabel(s, max=28){
  s=String(s);
  return s.length<=max ? s : s.slice(0,max-1)+"…";
}
function chaseDiagramSvg(cfg){
  const W=980, H=280;
  const x0=120, x1=860, y=150;

  const leader = shortenLabel(cfg.leader || "Leader");
  const chaser = shortenLabel(cfg.chaser || "Chaser");
  const leaderNote = shortenLabel(cfg.leaderNote || "", 38);
  const chaserNote = shortenLabel(cfg.chaserNote || "", 38);
  const gapNote = shortenLabel(cfg.gapNote || "", 46);
  const topNote = shortenLabel(cfg.topNote || "", 70);

  const nonce = Math.random().toString(36).slice(2);

  const leaderX = x0 + (x1-x0)*0.78;
  const chaserX = x0 + (x1-x0)*0.30;

  const svg=`
  <svg xmlns="http://www.w3.org/2000/svg" data-nonce="${nonce}" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
    <defs>
      <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#ffffff"/>
        <stop offset="1" stop-color="#f7fbff"/>
      </linearGradient>
      <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="0" dy="2" stdDeviation="5" flood-color="#000" flood-opacity="0.10"/>
      </filter>
    </defs>

    <rect x="18" y="18" rx="18" ry="18" width="${W-36}" height="${H-36}"
          fill="url(#bg)" stroke="#ffe0b2" stroke-width="3" filter="url(#shadow)"/>

    ${topNote ? `<text x="${W/2}" y="70" text-anchor="middle" font-size="24" fill="#455a64" font-family="Segoe UI, Arial">${escapeXml(topNote)}</text>` : ""}

    <line x1="${x0}" y1="${y}" x2="${x1}" y2="${y}" stroke="#90caf9" stroke-width="8" stroke-linecap="round"/>

    <circle cx="${chaserX}" cy="${y}" r="10" fill="#1976d2"/>
    <text x="${chaserX}" y="${y+42}" text-anchor="middle" font-size="22" fill="#1f2a44" font-family="Segoe UI, Arial">${escapeXml(chaser)}</text>
    ${chaserNote ? `<text x="${chaserX}" y="${y-22}" text-anchor="middle" font-size="20" fill="#1976d2" font-family="Segoe UI, Arial">${escapeXml(chaserNote)}</text>` : ""}

    <circle cx="${leaderX}" cy="${y}" r="10" fill="#d32f2f"/>
    <text x="${leaderX}" y="${y+42}" text-anchor="middle" font-size="22" fill="#1f2a44" font-family="Segoe UI, Arial">${escapeXml(leader)}</text>
    ${leaderNote ? `<text x="${leaderX}" y="${y-22}" text-anchor="middle" font-size="20" fill="#d32f2f" font-family="Segoe UI, Arial">${escapeXml(leaderNote)}</text>` : ""}

    <line x1="${chaserX+18}" y1="${y-6}" x2="${chaserX+180}" y2="${y-6}" stroke="#1976d2" stroke-width="3"/>
    <polygon points="${chaserX+180},${y-6} ${chaserX+168},${y-13} ${chaserX+168},${y+1}" fill="#1976d2"/>

    <line x1="${leaderX+18}" y1="${y-6}" x2="${leaderX+140}" y2="${y-6}" stroke="#d32f2f" stroke-width="3"/>
    <polygon points="${leaderX+140},${y-6} ${leaderX+128},${y-13} ${leaderX+128},${y+1}" fill="#d32f2f"/>

    <line x1="${chaserX}" y1="${y+18}" x2="${leaderX}" y2="${y+18}" stroke="#455a64" stroke-width="2"/>
    <line x1="${chaserX}" y1="${y+10}" x2="${chaserX}" y2="${y+26}" stroke="#455a64" stroke-width="2"/>
    <line x1="${leaderX}" y1="${y+10}" x2="${leaderX}" y2="${y+26}" stroke="#455a64" stroke-width="2"/>
    ${gapNote ? `<text x="${(chaserX+leaderX)/2}" y="${y+64}" text-anchor="middle" font-size="20" fill="#455a64" font-family="Segoe UI, Arial">${escapeXml(gapNote)}</text>` : ""}

  </svg>`.trim();

  const encoded=encodeURIComponent(svg)
    .replaceAll("%0A","").replaceAll("%20"," ")
    .replaceAll("%3D","=").replaceAll("%3A",":")
    .replaceAll("%2F","/").replaceAll("%2C",",");

  return "data:image/svg+xml;charset=utf-8," + encoded;
}

/* ---------------- Question Generators (ALL answers are INTEGERS) ---------------- */
function genEasy_CatchUpTime(){
  const [leader, chaser] = pickTwoNames();
  const vLeader = pick([45,50,55,60,65,70]); // m/min
  const diff = pick([5,6,7,8,9,10,12,15]);
  const vChaser = vLeader + diff;
  const t = randInt(6, 20);
  const gap = diff * t;

  const lines = [
    `${leader} is walking, and ${chaser} is walking behind in the same direction.`,
    `At the start, ${leader} is ${gap} m ahead.`,
    `${leader} walks at ${vLeader} m/min and ${chaser} walks at ${vChaser} m/min.`,
    `How many minutes will it take for ${chaser} to catch up?`
  ];

  const diagram = chaseDiagramSvg({
    leader, chaser,
    leaderNote: `${vLeader} m/min`,
    chaserNote: `${vChaser} m/min`,
    gapNote: `Head start: ${gap} m`,
    topNote: "Same direction (catch-up)"
  });

  return {
    img: makeSvgTextCard(lines, SVG_TITLE),
    diagram,
    value: t,
    hint: "Hint: Relative speed = faster speed − slower speed. Time = head start ÷ relative speed."
  };
}

function genEasy_DelayedStart(){
  const [child, parent] = pickTwoNames();

  let vc = pick([36,40,42,45,48,50,54,56,60,63,64,70]); // m/min
  let diff = pick([6,7,8,9,10,12,14,15]);               // m/min
  let vp = vc + diff;
  let delay = pick([6,8,9,10,12,14,15,16,18,20]);       // minutes

  let tries=0;
  while(tries<40 && (vc*delay) % diff !== 0){
    vc = pick([36,40,42,45,48,50,54,56,60,63,64,70]);
    diff = pick([6,7,8,9,10,12,14,15]);
    vp = vc + diff;
    delay = pick([6,8,9,10,12,14,15,16,18,20]);
    tries++;
  }
  const gap = vc * delay;
  const t = (gap / diff);

  const lines = [
    `${child} walks to school at ${vc} m/min.`,
    `${parent} starts ${delay} minutes later on a bicycle at ${vp} m/min to catch up.`,
    `How many minutes after ${parent} starts will ${parent} catch ${child}?`
  ];

  const diagram = chaseDiagramSvg({
    leader: child,
    chaser: parent,
    leaderNote: `${vc} m/min`,
    chaserNote: `${vp} m/min`,
    gapNote: `Initial gap: ${gap} m`,
    topNote: `Delay: ${delay} minutes`
  });

  return {
    img: makeSvgTextCard(lines, SVG_TITLE),
    diagram,
    value: t,
    hint: "Hint: First find the head start distance = (slower speed) × (delay). Then Time = head start ÷ (difference of speeds)."
  };
}

function genMedium_TrackFindSlowSpeed(){
  const L = pick([300,360,400,480,500,600,720,800]); // meters
  const t = pick([10,12,15,16,18,20,24]); // minutes
  if(L % t !== 0) return genMedium_TrackFindSlowSpeed();

  const gapPerMin = L / t;
  const vFast = pick([90,96,100,105,108,110,120,125,130,135,140]);
  const vSlow = vFast - gapPerMin;
  if(vSlow <= 40) return genMedium_TrackFindSlowSpeed();

  const [fastName, slowName] = pickTwoNames();

  const lines = [
    `${fastName} and ${slowName} run on a circular track of length ${L} m.`,
    `They start together from the same point and run in the same direction.`,
    `${fastName}'s speed is ${vFast} m/min.`,
    `After ${t} minutes, ${fastName} catches ${slowName} for the first time.`,
    `What is ${slowName}'s speed (in m/min)?`
  ];

  const diagram = chaseDiagramSvg({
    leader: slowName,
    chaser: fastName,
    leaderNote: `? m/min`,
    chaserNote: `${vFast} m/min`,
    gapNote: `Track length: ${L} m`,
    topNote: `First overtake after ${t} min`
  });

  return {
    img: makeSvgTextCard(lines, SVG_TITLE),
    diagram,
    value: vSlow,
    hint: "Hint: At the first overtake, the faster runner gains exactly one full lap: (vFast − vSlow) × t = L."
  };
}

function genMedium_FindInitialGap(){
  const [leader, chaser] = pickTwoNames();

  const vLeader = pick([40,45,48,50,54,56,60,63,64,70]);
  const diff = pick([6,7,8,9,10,12,14,15]);
  const vChaser = vLeader + diff;

  const t = pick([6,8,9,10,12,14,15,16,18,20]);
  const remaining = pick([40,50,60,70,80,90,100,120,140,150,160,180,200]);
  const D = remaining + diff * t;

  const lines = [
    `${leader} is ahead and ${chaser} is behind, moving in the same direction.`,
    `${leader} moves at ${vLeader} m/min. ${chaser} moves at ${vChaser} m/min.`,
    `After ${t} minutes, ${leader} is still ${remaining} m ahead.`,
    `How many meters ahead was ${leader} at the start?`
  ];

  const diagram = chaseDiagramSvg({
    leader, chaser,
    leaderNote: `${vLeader} m/min`,
    chaserNote: `${vChaser} m/min`,
    gapNote: `After ${t} min: gap = ${remaining} m`,
    topNote: "Find the starting head start"
  });

  return {
    img: makeSvgTextCard(lines, SVG_TITLE),
    diagram,
    value: D,
    hint: "Hint: In t minutes, the gap decreases by (difference of speeds) × t. Starting gap = remaining gap + decrease."
  };
}

function genHard_TurnBackFindDistance(){
  const diff = pick([5,6,8,10,12,15]);
  const k = randInt(4, 10);
  const vS = diff * k;
  const vF = vS + diff;

  const m = pick([40,50,60,70,80,90,100,120]);
  const D = ((vF + vS) * m) / (vF - vS);

  const [fastName, slowName] = pickTwoNames();

  const lines = [
    `${fastName} and ${slowName} start at point A and walk towards point B at the same time.`,
    `${fastName} walks at ${vF} m/min, and ${slowName} walks at ${vS} m/min.`,
    `${fastName} reaches B, turns around immediately, and walks back toward A at the same speed.`,
    `They meet at a point that is ${m} m away from B (on the way back).`,
    `What is the distance from A to B (in meters)?`
  ];

  const diagram = chaseDiagramSvg({
    leader: slowName,
    chaser: fastName,
    leaderNote: `${vS} m/min`,
    chaserNote: `${vF} m/min`,
    gapNote: `Meeting point: ${m} m from B`,
    topNote: "Fast person turns back"
  });

  return {
    img: makeSvgTextCard(lines, SVG_TITLE),
    diagram,
    value: D,
    hint: "Hint: Let AB = D. Slow time = (D − m)/vS. Fast time = (D + m)/vF. Set them equal and solve."
  };
}

function genHard_SecondOvertake(){
  const L = pick([300,360,400,480,500,600,720,800]);
  const T = pick([12,15,16,18,20,24,25,30]);
  if((2*L) % T !== 0) return genHard_SecondOvertake();

  const gapPerMin = (2*L) / T;
  const vFast = pick([100,105,108,110,120,125,130,135,140,150,160]);
  const vSlow = vFast - gapPerMin;
  if(vSlow <= 40) return genHard_SecondOvertake();

  const [fastName, slowName] = pickTwoNames();

  const lines = [
    `${fastName} and ${slowName} run on a circular track of length ${L} m.`,
    `They start together from the same point and run in the same direction.`,
    `${fastName}'s speed is ${vFast} m/min.`,
    `After ${T} minutes, ${fastName} catches ${slowName} for the second time.`,
    `What is ${slowName}'s speed (in m/min)?`
  ];

  const diagram = chaseDiagramSvg({
    leader: slowName,
    chaser: fastName,
    leaderNote: `? m/min`,
    chaserNote: `${vFast} m/min`,
    gapNote: `Second overtake: gain 2 laps = ${2*L} m`,
    topNote: `Time: ${T} min`
  });

  return {
    img: makeSvgTextCard(lines, SVG_TITLE),
    diagram,
    value: vSlow,
    hint: "Hint: Second overtake means gaining 2 full laps: (vFast − vSlow) × T = 2L."
  };
}

/* ---------------- State ---------------- */
let questions=[];
let currentQuestionIndex=0;
let studentName="Student";
let quizStartTime=null;
let quizEndTime=null;
let quizSubmitted=false;

let timerInterval=null;
let elapsedMs=0;
let isPaused=false;
let firstAttemptMs=null;

let setCounter=0;
let lastAnswerSignature="";

/* DOM */
const quizContent=document.getElementById("quizContent");
const sidebarEl=document.getElementById("sidebar");

const buttonContainer=document.getElementById("navButtons");
const backButton=document.getElementById("backButton");
const nextButton=document.getElementById("nextButton");
const submitButton=document.getElementById("submitButton");
const checkButton=document.getElementById("checkButton");
const saveButton=document.getElementById("saveButton");

const generateBtn=document.getElementById("generateButton");
const pauseButton=document.getElementById("pauseButton");
const exportQuestionsBtn=document.getElementById("exportQuestionsBtn");

const timerDisplay=document.getElementById("timerDisplay");
const studentLine=document.getElementById("studentLine");
const setLine=document.getElementById("setLine");

/* ---------------- Timer ---------------- */
function updateTimerDisplay(){
  let totalMs=elapsedMs;
  if(!isPaused && quizStartTime) totalMs+=(new Date()-quizStartTime);
  let text=`Time: ${formatMs(totalMs)}`;
  if(firstAttemptMs!==null) text+=` (First: ${formatMs(firstAttemptMs)})`;
  timerDisplay.textContent=text;
}
function startTimerInterval(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(updateTimerDisplay, 1000);
}
function pauseTimer(){
  if(isPaused || !quizStartTime) return;
  const now=new Date();
  elapsedMs+=now-quizStartTime;
  isPaused=true;
  quizStartTime=null;
  updateTimerDisplay();
}
function resumeTimer(){
  if(!isPaused) return;
  isPaused=false;
  quizStartTime=new Date();
  updateTimerDisplay();
}

/* ---------------- Generate Quiz (ensure NEW answers) ---------------- */
function answersSignature(built){
  return built.map(x=>String(x.value)).join("|");
}
function generateQuiz(){
  questions=[];
  quizSubmitted=false;

  let tries=0;
  let built=null;

  while(tries<20){
    built = [
      genEasy_CatchUpTime(),
      genEasy_DelayedStart(),
      genMedium_TrackFindSlowSpeed(),
      genMedium_FindInitialGap(),
      genHard_TurnBackFindDistance(),
      genHard_SecondOvertake()
    ];
    const sig = answersSignature(built);
    if(sig !== lastAnswerSignature){
      lastAnswerSignature = sig;
      break;
    }
    tries++;
  }

  setCounter++;
  setLine.textContent = `Set: ${setCounter}`;

  for(let i=0;i<built.length;i++){
    const partIndex=Math.floor(i/QUESTIONS_PER_PART);
    const indexInPart=i%QUESTIONS_PER_PART;
    questions.push({
      partIndex,
      indexInPart,
      img: built[i].img,
      diagram: built[i].diagram || "",
      value: built[i].value,
      hint: built[i].hint,
      userValue:"",
      isCorrect:false
    });
  }
}

/* ---------------- Sidebar ---------------- */
function renderSidebar(){
  sidebarEl.style.display="block";
  sidebarEl.innerHTML=`<h4>Questions</h4><ul id="qList"></ul>`;
  const ul=document.getElementById("qList");
  for(let i=0;i<TOTAL_QUESTIONS;i++){
    const q=questions[i];
    const li=document.createElement("li");
    const label=["Easy","Medium","Hard"][q.partIndex]+(q.indexInPart+1);
    li.textContent=`Q${i+1} (${label})`;
    li.dataset.index=i;
    li.addEventListener("click",()=>{
      saveCurrentInput();
      currentQuestionIndex=i;
      renderQuestion();
    });
    ul.appendChild(li);
  }
  updateSidebarStatus();
}
function updateSidebarStatus(){
  const items=document.querySelectorAll("#qList li");
  items.forEach(li=>{
    const idx=Number(li.dataset.index);
    const q=questions[idx];
    li.classList.remove("active","answered","correct","incorrect");

    if(!quizSubmitted){
      li.classList.toggle("active", idx===currentQuestionIndex);
      if((q.userValue||"").trim()!=="") li.classList.add("answered");
    }else{
      if((q.userValue||"").trim()!==""){
        li.classList.add(q.isCorrect ? "correct" : "incorrect");
      }
    }
  });
}

/* ---------------- Helpers ---------------- */
function gradeOneQuestion(i){
  const q=questions[i];
  const val=parseIntegerAnswer(q.userValue||"");
  q.isCorrect=isCorrectInt(val, q.value);
}
function saveCurrentInput(){
  const input=document.getElementById("answerInput");
  if(input){
    questions[currentQuestionIndex].userValue=input.value.trim();
    if(quizSubmitted){
      gradeOneQuestion(currentQuestionIndex);
      updateSidebarStatus();
    }
  }
}
function mountNavButtonsInto(slotId){
  const slot=document.getElementById(slotId);
  if(!slot) return;
  slot.appendChild(buttonContainer);
  buttonContainer.style.display="flex";
}

/* ---------------- Render Question ---------------- */
function renderQuestion(){
  const q=questions[currentQuestionIndex];
  const levelLabel=["Easy","Medium","Hard"][q.partIndex];
  const fullLabel=`${levelLabel} — Question ${q.indexInPart+1}`;
  const hasHint=(q.hint||"").trim()!=="";

  const hintDiagramHtml = (hasHint && q.diagram)
    ? `<div class="hint-diagram-wrap"><img src="${q.diagram}" alt="Hint diagram"></div>`
    : "";

  quizContent.innerHTML=`
    <p class="question-text">Question ${currentQuestionIndex+1} of ${TOTAL_QUESTIONS}</p>
    <div class="part-title">${PART_TITLES[q.partIndex]}</div>

    <div class="single-question">
      <div style="font-weight:800;margin-bottom:8px;">${fullLabel}</div>

      <div class="img-wrap">
        <img class="q-img" src="${q.img}" alt="Question image">
      </div>

      <div class="answer-row">
        <div style="font-weight:700;">Answer (whole number):</div>
        <input id="answerInput" class="answer-box" type="text" inputmode="numeric"
               placeholder="Type a whole number (e.g., 12)"
               value="${q.userValue||""}">
      </div>

      <div id="checkFeedback" style="display:none;"></div>

      <div class="hint-row">
        <button id="hintBtn" class="hint-btn" ${hasHint ? "" : "disabled"}>${hasHint ? "Hint" : "No Hint"}</button>
      </div>

      <div id="hintBox" class="hint">
        <div>${hasHint ? q.hint : ""}</div>
        ${hintDiagramHtml}
      </div>
    </div>

    <div id="navSlot"></div>
  `;

  mountNavButtonsInto("navSlot");

  const hintBtn=document.getElementById("hintBtn");
  const hintBox=document.getElementById("hintBox");
  if(hintBtn && hintBox && hasHint){
    hintBtn.addEventListener("click", ()=>{
      const shown = hintBox.style.display==="block";
      hintBox.style.display = shown ? "none" : "block";
      hintBtn.textContent = shown ? "Hint" : "Hide Hint";
    });
  }

  backButton.style.display="inline-block";
  backButton.style.visibility=(currentQuestionIndex===0)?"hidden":"visible";

  const isLast=(currentQuestionIndex===TOTAL_QUESTIONS-1);
  nextButton.style.display=isLast?"none":"inline-block";
  submitButton.style.display=isLast?"inline-block":"none";

  saveButton.style.display=quizSubmitted?"inline-block":"none";
  checkButton.style.display=(quizSubmitted && !q.isCorrect)?"inline-block":"none";

  updateSidebarStatus();
}

/* ---------------- Results + Submit ---------------- */
function calculateAndShowResults(){
  saveCurrentInput();

  const now=new Date();
  let attemptMs=elapsedMs;
  if(!isPaused && quizStartTime) attemptMs+=now-quizStartTime;
  if(firstAttemptMs===null) firstAttemptMs=attemptMs;

  const attemptStartTime=quizStartTime || now;
  quizEndTime=now;
  quizSubmitted=true;

  let correctCount=0;
  questions.forEach(q=>{
    const val=parseIntegerAnswer(q.userValue||"");
    q.isCorrect=isCorrectInt(val, q.value);
    if(q.isCorrect) correctCount++;
  });

  updateSidebarStatus();

  let html=`
    <h3>Results for ${studentName}</h3>
    <p>Set: <strong>${setCounter}</strong></p>
    <p>Score: <strong>${correctCount} / ${TOTAL_QUESTIONS}</strong></p>
    <p>Start time: <strong>${attemptStartTime.toLocaleTimeString()}</strong></p>
    <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
    <p>Time taken (this attempt): <strong>${formatMs(attemptMs)}</strong></p>
    <p>First attempt time: <strong>${formatMs(firstAttemptMs)}</strong></p>

    <table class="review-table">
      <tr>
        <th>#</th><th>Part</th><th>Image</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th>
      </tr>
  `;

  questions.forEach((q,i)=>{
    const partLbl=["Easy","Medium","Hard"][q.partIndex]+(q.indexInPart+1);
    const ua=(q.userValue||"").trim();
    html+=`
      <tr class="${q.isCorrect ? "correct-answer":"incorrect-answer"}">
        <td>${i+1}</td>
        <td>${partLbl}</td>
        <td><img class="thumb" src="${q.img}" alt="Q${i+1}"></td>
        <td>${ua==="" ? "—" : ua}</td>
        <td><strong>${q.value}</strong></td>
        <td>${ua==="" ? "Not answered" : (q.isCorrect ? "Correct":"Incorrect")}</td>
      </tr>
    `;
  });

  html+=`</table><div id="navSlot"></div>`;
  quizContent.innerHTML=html;

  mountNavButtonsInto("navSlot");

  backButton.style.display="none";
  nextButton.style.display="none";
  submitButton.style.display="none";
  checkButton.style.display="none";
  saveButton.style.display="inline-block";

  elapsedMs=0; isPaused=false; quizStartTime=new Date();
  pauseButton.textContent="Pause";
  startTimerInterval();
  updateTimerDisplay();
}

/* ---------------- Buttons ---------------- */
nextButton.addEventListener("click", ()=>{
  saveCurrentInput();
  if(currentQuestionIndex<TOTAL_QUESTIONS-1){
    currentQuestionIndex++;
    renderQuestion();
  }
});
backButton.addEventListener("click", ()=>{
  saveCurrentInput();
  if(currentQuestionIndex>0){
    currentQuestionIndex--;
    renderQuestion();
  }
});
submitButton.addEventListener("click", ()=>{
  if(currentQuestionIndex===TOTAL_QUESTIONS-1){
    calculateAndShowResults();
  }
});
checkButton.addEventListener("click", ()=>{
  saveCurrentInput();
  const q=questions[currentQuestionIndex];
  if(!quizSubmitted) return;

  gradeOneQuestion(currentQuestionIndex);
  updateSidebarStatus();

  const box=document.getElementById("checkFeedback");
  if(!box) return;

  box.className="check-feedback";
  box.style.display="block";

  const userInt=parseIntegerAnswer(q.userValue||"");
  if(isCorrectInt(userInt, q.value)){
    box.innerHTML=`✅ Correct!`;
    checkButton.style.display="none";
  }else{
    box.innerHTML=`❌ Incorrect. Correct answer: <strong>${q.value}</strong> (whole number)`;
    checkButton.style.display="inline-block";
  }
});

/* Save TXT */
function formatDateForFilename(date){
  if(!date) return "no_time";
  const pad=n=>String(n).padStart(2,"0");
  return date.getFullYear()+pad(date.getMonth()+1)+pad(date.getDate())+"_"+
         pad(date.getHours())+pad(date.getMinutes())+pad(date.getSeconds());
}
function saveCurrentResultAsTxt(){
  saveCurrentInput();

  if(!quizSubmitted){
    questions.forEach(q=>{
      const val=parseIntegerAnswer(q.userValue||"");
      q.isCorrect=isCorrectInt(val,q.value);
    });
  }
  let correctCount=0;
  questions.forEach(q=>{ if(q.isCorrect) correctCount++; });

  const lines=[];
  lines.push("Chasing Problems (Pursuit) - Current Result");
  lines.push("Student: "+studentName);
  lines.push("Set: "+setCounter);
  if(quizStartTime) lines.push("Start time: "+quizStartTime.toLocaleString());
  if(quizEndTime) lines.push("Last submit time: "+quizEndTime.toLocaleString());
  lines.push("Score: "+correctCount+" / "+TOTAL_QUESTIONS);
  if(firstAttemptMs!==null) lines.push("First attempt time: "+formatMs(firstAttemptMs));
  lines.push("");

  questions.forEach((q,i)=>{
    const partLbl=["Easy","Medium","Hard"][q.partIndex]+(q.indexInPart+1);
    const userAns=(q.userValue||"").trim()==="" ? "Not answered" : q.userValue;
    const resultText=(q.userValue||"").trim()==="" ? "Not answered" : (q.isCorrect?"Correct":"Incorrect");
    lines.push(`Q${i+1} (${partLbl})`);
    lines.push("Your answer: "+userAns);
    lines.push("Correct answer: "+q.value);
    lines.push("Result: "+resultText);
    lines.push("");
  });

  const content=lines.join("\n");
  const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const safeName=studentName.replace(/[^a-z0-9_\-]/gi,"_")||"Student";
  const ts=formatDateForFilename(new Date());
  a.href=url;
  a.download=`Chasing_${safeName}_Set${setCounter}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
saveButton.addEventListener("click", saveCurrentResultAsTxt);

/* Pause/Resume */
pauseButton.addEventListener("click", ()=>{
  if(!quizStartTime && elapsedMs===0 && !quizSubmitted) return;
  if(isPaused){ resumeTimer(); pauseButton.textContent="Pause"; }
  else { pauseTimer(); pauseButton.textContent="Resume"; }
});

/* Generate new set */
generateBtn.addEventListener("click", ()=>{
  if(!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;

  if(timerInterval) clearInterval(timerInterval);
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  quizStartTime=new Date(); quizEndTime=null;
  updateTimerDisplay(); startTimerInterval();
  pauseButton.style.display="inline-block";
  pauseButton.textContent="Pause";

  generateQuiz();
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();
});

/* ---------------- Export Questions PDF (2 questions per page, DYAA header) ---------------- */
function waitForImages(container){
  const imgs = Array.from(container.querySelectorAll("img"));
  return Promise.all(imgs.map(img => {
    if(img.complete && img.naturalWidth > 0) return Promise.resolve();
    return new Promise(resolve => {
      img.onload = () => resolve();
      img.onerror = () => resolve();
    });
  }));
}

/** Add a canvas into jsPDF, auto-splitting into multiple pages if needed */
function addCanvasAutoPagedToPdf(pdf, canvas, marginMm = 10){
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const usableW = pageWidth - marginMm * 2;
  const usableH = pageHeight - marginMm * 2;

  // scale to fit page width
  const ratio = usableW / canvas.width;
  const scaledH = canvas.height * ratio;

  // If fits in one page, add directly
  if(scaledH <= usableH){
    const imgData = canvas.toDataURL("image/png", 1.0);
    pdf.addImage(imgData, "PNG", marginMm, marginMm, usableW, scaledH);
    return;
  }

  // Otherwise, slice the canvas by page height (in source pixels)
  const sliceHpx = Math.floor(usableH / ratio); // source pixels per page
  const pageCanvas = document.createElement("canvas");
  const ctx = pageCanvas.getContext("2d", { willReadFrequently: true });

  pageCanvas.width = canvas.width;

  let y = 0;
  let firstSlice = true;

  while(y < canvas.height){
    const remaining = canvas.height - y;
    const curSliceH = Math.min(sliceHpx, remaining);

    pageCanvas.height = curSliceH;
    ctx.clearRect(0, 0, pageCanvas.width, pageCanvas.height);

    // draw slice
    ctx.drawImage(canvas, 0, y, canvas.width, curSliceH, 0, 0, canvas.width, curSliceH);

    const imgData = pageCanvas.toDataURL("image/png", 1.0);

    // first slice uses current page; next slices need new pages
    if(!firstSlice) pdf.addPage();
    firstSlice = false;

    pdf.addImage(imgData, "PNG", marginMm, marginMm, usableW, curSliceH * ratio);

    y += curSliceH;
  }
}

function loadImage(src){
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = () => resolve(null);
    img.src = src;
  });
}

// Convert (svg/png) dataURL to a smaller JPEG dataURL (mobile-friendly)
async function toJpegDataUrl(src, targetWidthPx = 1400, quality = 0.88){
  const img = await loadImage(src);
  if(!img || !img.naturalWidth) return null;

  const scale = Math.min(1, targetWidthPx / img.naturalWidth);
  const w = Math.max(1, Math.round(img.naturalWidth * scale));
  const h = Math.max(1, Math.round(img.naturalHeight * scale));

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext("2d");

  // white background (important for JPEG)
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, w, h);
  ctx.drawImage(img, 0, 0, w, h);

  return canvas.toDataURL("image/jpeg", quality);
}

function addHeader(pdf, title, setCounter, x, y, w){
  // DYAA mini logo + title
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(12);
  pdf.text("DYAA EDUCATION", x, y);

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text(title, x, y + 7);

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(11);
  pdf.text(`Questions (Set ${setCounter})`, x, y + 13);

  // line
  pdf.setDrawColor(220);
  pdf.line(x, y + 16, x + w, y + 16);

  return y + 22; // next baseline
}

exportQuestionsBtn.addEventListener("click", async ()=>{
  if(!questions || questions.length===0){
    alert("Please start a quiz first.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  const margin = 10;
  const contentW = pageW - margin * 2;

  const title = "Chasing Problems (Pursuit)";

  let y = margin;

  // header on first page
  y = addHeader(pdf, title, setCounter, margin, y, contentW);

  for(let i=0;i<questions.length;i++){
    const q = questions[i];

    // Q label
    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(12);
    const qLabel = `Q${i+1}`;
    const qLabelH = 6;

    // Convert question image to JPEG (smaller & mobile-safe)
    const jpeg = await toJpegDataUrl(q.img, 1400, 0.88);
    if(!jpeg){
      // fallback text if image failed
      if(y + qLabelH + 10 > pageH - margin){
        pdf.addPage();
        y = margin;
        y = addHeader(pdf, title, setCounter, margin, y, contentW);
      }
      pdf.text(qLabel + " (image failed to load)", margin, y);
      y += 10;
      continue;
    }

    // Need image dimensions to keep aspect ratio
    const imgObj = await loadImage(jpeg);
    const ratio = imgObj.naturalHeight / imgObj.naturalWidth;
    const imgWmm = contentW;
    const imgHmm = imgWmm * ratio;

    // Card paddings
    const cardPad = 3;
    const cardTopGap = 2;
    const cardBottomGap = 6;

    // If not fit, new page + header
    const neededH = qLabelH + cardTopGap + imgHmm + cardPad*2 + cardBottomGap;
    if(y + neededH > pageH - margin){
      pdf.addPage();
      y = margin;
      y = addHeader(pdf, title, setCounter, margin, y, contentW);
    }

    // draw Q label
    pdf.text(qLabel, margin, y);
    y += qLabelH;

    // draw card border
    const cardX = margin;
    const cardY = y + cardTopGap;
    const cardW = contentW;
    const cardH = imgHmm + cardPad*2;

    pdf.setDrawColor(229);
    pdf.setFillColor(255,255,255);
    pdf.roundedRect(cardX, cardY, cardW, cardH, 2.5, 2.5, "S");

    // add image in card
    pdf.addImage(jpeg, "JPEG", cardX + cardPad, cardY + cardPad, cardW - cardPad*2, imgHmm);

    // move cursor
    y = cardY + cardH + cardBottomGap;
  }

  const safeName=(studentName||"Student").replace(/[^a-z0-9_\-]/gi,"_") || "Student";
  const ts=formatDateForFilename(new Date());
async function downloadPdfIOSFriendly(pdf, filename){
  // Make a Blob from jsPDF
  const blob = pdf.output("blob"); // application/pdf
  const file = new File([blob], filename, { type: "application/pdf" });

  // 1) iOS best path: Share sheet (Save to Files / AirDrop / etc.)
  // Works in Safari iOS 13+ (depends on context), very reliable for "not opening preview"
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

  if (isIOS && navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
    try {
      await navigator.share({
        files: [file],
        title: filename,
        text: "PDF Export"
      });
      return; // Done (user chooses Save to Files etc.)
    } catch (e) {
      // user cancelled or share failed -> fallback to download
    }
  }

  // 2) Standard download via ObjectURL + <a download>
  const url = URL.createObjectURL(blob);

  // Some iOS versions ignore download attribute and open preview.
  // Still better than pdf.save() in many cases.
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.rel = "noopener";
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // 3) iOS fallback: open in a new tab so user can use Share/Save
  // If Safari ignored download and didn't start downloading, opening helps.
  if (isIOS) {
    setTimeout(() => {
      try { window.open(url, "_blank"); } catch(_) {}
    }, 200);
  }

  setTimeout(() => URL.revokeObjectURL(url), 4000);
}

/* --- your export click handler end part --- */
exportQuestionsBtn.addEventListener("click", async ()=>{
  // ... your existing code ...

  const safeName=(studentName||"Student").replace(/[^a-z0-9_\-]/gi,"_") || "Student";
  const ts=formatDateForFilename(new Date());
  const filename = `ChasingProblems_Questions_${safeName}_Set${setCounter}_${ts}.pdf`;

  // ✅ replace pdf.save(...)
  await downloadPdfIOSFriendly(pdf, filename);

  // ... your finally cleanup ...
});

});

/* ---------------- Start Screen (+ optional ?name=Tiger) ---------------- */
function getNameFromUrl(){
  const url=new URL(window.location.href);
  const name=url.searchParams.get("name");
  return name ? name.trim() : "";
}
function showStartScreen(){
  sidebarEl.style.display="none";
  buttonContainer.style.display="none";
  generateBtn.style.display="none";
  saveButton.style.display="none";
  pauseButton.style.display="none";
  exportQuestionsBtn.style.display="none";

  studentLine.textContent="";
  setLine.textContent="";

  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  quizStartTime=null; quizEndTime=null;
  updateTimerDisplay();

  const preset=getNameFromUrl();
  if(preset){
    studentName=preset;
    studentLine.textContent=`Student: ${studentName}`;
    startQuiz(true);
    return;
  }

  quizContent.innerHTML=`
    <p>This quiz has <strong>${TOTAL_QUESTIONS}</strong> chasing (pursuit) word problems (all answers are <strong>whole numbers</strong>).</p>
    <ul style="margin-top:6px;color:#555;line-height:1.7;">
      <li><strong>Part 1 (Easy):</strong> 2 questions</li>
      <li><strong>Part 2 (Medium):</strong> 2 questions</li>
      <li><strong>Part 3 (Hard):</strong> 2 questions</li>
    </ul>
    <p style="margin-top:10px;">Please enter your name to begin:</p>

    <input id="nameInput" type="text"
      style="padding:10px;width:260px;font-size:1.05em;border:1px solid #ccc;border-radius:10px;"
      placeholder="Your name">

    <button id="startButton"
      style="margin-left:10px;background:#4caf50;padding:10px 20px;color:white;border:none;border-radius:8px;">
      Start Quiz
    </button>
  `;
  document.getElementById("startButton").addEventListener("click", ()=>startQuiz(false));
}
function startQuiz(skipReadName){
  if(!skipReadName){
    const nameInput=document.getElementById("nameInput");
    studentName=(nameInput.value || "Student").trim();
  }
  studentLine.textContent=`Student: ${studentName}`;

  quizStartTime=new Date();
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  updateTimerDisplay(); startTimerInterval();

  generateQuiz();
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();

  generateBtn.style.display="inline-block";
  pauseButton.style.display="inline-block";
  pauseButton.textContent="Pause";
  exportQuestionsBtn.style.display="inline-block";
}

/* ---------------- Init ---------------- */
showStartScreen();
</script>
</body>
</html>
