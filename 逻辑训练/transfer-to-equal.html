<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transfer-to-Equalize Word Problems (Image Quiz)</title>

  <style>
    body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f4f4f9;margin:0;padding:20px;color:#333;}
    .quiz-container{max-width:900px;margin:40px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);}
    #headerLogo{display:flex;align-items:center;gap:12px;margin-bottom:10px;border-bottom:2px solid #e0e0e0;padding-bottom:10px;}
    .logo-icon{width:40px;height:40px;background:#0d47a1;border-radius:6px;position:relative;}
    .logo-icon:before{content:"";position:absolute;width:20px;height:9px;background:#ff9800;top:-6px;left:20px;border-radius:3px;}
    .logo-text{display:flex;flex-direction:column;line-height:1.1;}
    .logo-text .brand{font-weight:900;letter-spacing:1px;color:#ff9800;}
    .logo-text .edu{font-size:.9em;color:#0d47a1;font-weight:700;}

    .top-bar{display:flex;justify-content:space-between;align-items:center;margin:10px 0 6px 0;gap:10px;flex-wrap:wrap;}
    #timerDisplay{font-size:.95em;color:#333;}
    #studentLine{font-size:.95em;color:#555;}

    .quiz-main{display:flex;gap:20px;margin-top:10px;}
    .sidebar{width:160px;border-right:1px solid #ddd;padding-right:10px;display:none;}
    .sidebar h4{margin:0 0 8px;font-size:.95em;border-bottom:1px solid #eee;padding-bottom:4px;}
    .sidebar ul{list-style:none;padding:0;margin:0;}
    .sidebar li{padding:6px;cursor:pointer;border-radius:6px;font-size:.9em;margin-bottom:6px;border:1px solid #eee;background:#fafafa;}
    .sidebar li.active{outline:2px solid #1976d2;font-weight:700;background:#fff;}
    .sidebar li.answered{border-left:5px solid #4caf50;}
    .sidebar li.correct{background:#d4edda;border-left:5px solid #28a745;border-color:#cbe7d1;}
    .sidebar li.incorrect{background:#f8d7da;border-left:5px solid #f44336;border-color:#f1c7cc;}

    #quizContent{flex:1;}
    .question-text{font-size:1.05em;margin-bottom:8px;}
    .part-title{font-weight:800;margin:8px 0 10px 0;}
    .single-question{margin:6px 0;line-height:1.7;}
    .answer-row{margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .answer-box{width:180px;padding:8px;font-size:1em;border:1px solid #ccc;border-radius:8px;}
    .img-wrap{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:12px;box-shadow:0 3px 8px rgba(0,0,0,0.05);max-width:100%;}
    .q-img{width:100%;height:auto;display:block;border-radius:10px;}

    /* Hint button + hidden hint box */
    .hint-row{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .hint-btn{background:#ff9800;color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:0.95em;}
    .hint-btn:disabled{opacity:.55;cursor:not-allowed;}
    .hint{display:none;margin-top:10px;padding:10px 12px;border-radius:10px;background:#fff7e6;border:1px solid #ffe0b2;color:#5d4037;font-size:0.95em;}

    .button-container{display:flex;justify-content:space-between;gap:10px;margin-top:14px;flex-wrap:wrap;}
    button{padding:10px 18px;border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:1em;}
    #nextButton{background:#4caf50;}
    #backButton{background:#039be5;}
    #generateButton{background:#ff9800;}
    #submitButton{background:#9c27b0;}
    #saveButton{background:#607d8b;}
    #pauseButton{background:#f57c00;}
    #checkButton{background:#455a64;}
    #exportQuestionsBtn{background:#9c27b0;}
    button:disabled{opacity:.55;cursor:not-allowed;}

    .check-feedback{margin-top:10px;padding:10px 12px;border-radius:10px;background:#f7f7f7;border:1px solid #e0e0e0;color:#333;font-size:0.95em;}

    table.review-table{width:100%;border-collapse:collapse;margin-top:18px;}
    .review-table th,.review-table td{border:1px solid #ccc;padding:6px;font-size:.85em;text-align:center;vertical-align:top;}
    .review-table th{background:#f2f2f2;}
    .correct-answer{background:#d4edda;}
    .incorrect-answer{background:#f8d7da;}
    .thumb{width:160px;max-width:160px;height:auto;border-radius:8px;border:1px solid #ddd;background:#fff;}

    @media (max-width:760px){
      .quiz-main{flex-direction:column;}
      .sidebar{width:100%;border-right:none;border-bottom:1px solid #ddd;margin-bottom:10px;padding-bottom:10px;}
      .thumb{width:120px;max-width:120px;}
    }
  </style>
</head>

<body>
<div class="quiz-container" id="quizContainer">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text">
      <div class="brand">DYAA</div>
      <div class="edu">EDUCATION</div>
    </div>
  </div>

  <div class="top-bar">
    <div>
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentLine"></div>
    </div>
    <div>
      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="generateButton" style="display:none;">Generate New Set</button>
      <button id="exportQuestionsBtn" style="display:none;">Export Questions PDF</button>
    </div>
  </div>

  <h2 style="margin:6px 0 0 0;">Lesson Theme: Transfer to Make Equal</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <div id="navButtons" class="button-container" style="display:none;">
    <button id="backButton" style="display:none;">Previous</button>
    <button id="submitButton" style="display:none;">Submit &amp; View Results</button>
    <button id="nextButton" style="display:none;">Next</button>
    <button id="checkButton" style="display:none;">Check</button>
    <button id="saveButton" style="display:none;">Save Current Result</button>
  </div>
</div>

<!-- PDF 依赖 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ---------------- CONFIG ---------------- */
const PART_TITLES = [
  "Part 1 (Easy) — Give some to make them equal",
  "Part 2 (Medium) — Find the original difference or the other amount",
  "Part 3 (Hard) — Use total or final-each information"
];
const NUM_PARTS = 3;
const QUESTIONS_PER_PART = 2;
const TOTAL_QUESTIONS = NUM_PARTS * QUESTIONS_PER_PART;

/* ---------------- Utils ---------------- */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function choice(arr){ return arr[randInt(0, arr.length-1)]; }
function formatMs(ms){
  const totalSec=Math.floor(ms/1000), min=Math.floor(totalSec/60), sec=totalSec%60;
  return `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}
function escapeXml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
                  .replaceAll('"',"&quot;").replaceAll("'","&apos;");
}

/* Build an SVG “image question” (data URI) */
function makeSvgQuestionImage(lines){
  const W = 980;

  const headerH = 72;          // header band height
  const padX = 44;
  const lineH = 46;            // line spacing
  const firstLineY = headerH + 52; // first content line starts well below header
  const padBottom = 54;

  const contentH = (lines.length - 1) * lineH;
  const H = firstLineY + contentH + padBottom;

  const textSpans = lines.map((t,i)=>{
    const y = firstLineY + i * lineH;
    return `<text x="${padX}" y="${y}" font-size="30" fill="#1f2a44" font-family="Segoe UI, Arial">${escapeXml(t)}</text>`;
  }).join("");

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#f7fbff"/>
        <stop offset="1" stop-color="#ffffff"/>
      </linearGradient>
      <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="0" dy="3" stdDeviation="6" flood-color="#000" flood-opacity="0.12"/>
      </filter>
    </defs>

    <rect x="18" y="18" rx="18" ry="18" width="${W-36}" height="${H-36}"
          fill="url(#g)" stroke="#dfe7f2" stroke-width="3" filter="url(#shadow)"/>

    <!-- header band -->
    <rect x="18" y="18" rx="18" ry="18" width="${W-36}" height="${headerH}"
          fill="#0d47a1" opacity="0.10"/>

    <text x="${padX}" y="56" font-size="28" fill="#0d47a1" font-weight="700"
          font-family="Segoe UI, Arial">Transfer to Make Equal</text>

    ${textSpans}
  </svg>`.trim();

  const encoded = encodeURIComponent(svg)
    .replaceAll("%0A","")
    .replaceAll("%20"," ")
    .replaceAll("%3D","=")
    .replaceAll("%3A",":")
    .replaceAll("%2F","/")
    .replaceAll("%2C",",");

  return "data:image/svg+xml;charset=utf-8," + encoded;
}

function parseAnswer(str){
  const s=(str||"").trim();
  if(s==="") return NaN;
  const n=Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function nearlyEqual(a,b,eps=1e-9){
  if(!Number.isFinite(a)||!Number.isFinite(b)) return false;
  return Math.abs(a-b)<eps;
}

/* ---------------- Theme Generators: “Transfer to Make Equal” ---------------- */
/*
Core idea:
If A gives x to B and then equal:
A - x = B + x  =>  x = (A - B)/2
Also:
Original difference = A - B = 2x
If total T known, after equal each = T/2:
A = T/2 + x, B = T/2 - x
If after transfer each has E:
A = E + x, B = E - x
*/

function genEasyFindTransferAmount(){
  const items = [
    ["books","books"], ["stickers","stickers"], ["marbles","marbles"], ["cards","cards"], ["candies","candies"]
  ];
  const [itemA] = choice(items);
  const names = [["Lily","Ben"],["Mia","Noah"],["Emma","Jack"],["Ava","Leo"],["Sophie","Tom"]];
  const [Aname,Bname] = choice(names);

  const x = randInt(2, 12);
  const B = randInt(6, 24);
  const A = B + 2*x;

  const lines = [
    `${Aname} has ${A} ${itemA}. ${Bname} has ${B} ${itemA}.`,
    `${Aname} gives ${Bname} some ${itemA}.`,
    `After that, they have the same number of ${itemA}.`,
    `How many ${itemA} did ${Aname} give to ${Bname}?`
  ];
  return {
    img: makeSvgQuestionImage(lines),
    value: x,
    hint: "Hint: Compare how many more items the first person has than the second person. When they share to become equal, the amount given is half of that difference."
  };
}

function genEasyFindOtherOriginal(){
  const contexts = [
    ["eggs","eggs"], ["pencils","pencils"], ["coins","coins"], ["apples","apples"]
  ];
  const [thing] = choice(contexts);
  const names = [["Anna","Bella"],["Ryan","Ethan"],["Chloe","Nina"],["Sam","Chris"]];
  const [Aname,Bname] = choice(names);

  const A = randInt(16, 30);
  const x = randInt(2, 9);
  const B = A - 2*x;
  if(B <= 0) return genEasyFindOtherOriginal();

  const lines = [
    `${Aname} has ${A} ${thing}. ${Bname} has some ${thing}.`,
    `If ${Aname} gives ${x} ${thing} to ${Bname},`,
    `then they will have the same number of ${thing}.`,
    `How many ${thing} did ${Bname} have at first?`
  ];
  return {
    img: makeSvgQuestionImage(lines),
    value: B,
    hint: "Hint: After giving the stated number, both sides become equal. That means the second person started with the first person’s amount minus twice the number given."
  };
}

function genMediumFindOriginalDifference(){
  const groups = [
    ["Chess Group","Drama Group"],
    ["Red Team","Blue Team"],
    ["Group A","Group B"],
    ["Math Club","Science Club"]
  ];
  const [g1,g2] = choice(groups);

  const k = randInt(3, 9); // moved
  const diff = 2*k;

  const lines = [
    `${k} students move from ${g1} to ${g2}.`,
    `After the move, the two groups have the same number of students.`,
    `Originally, how many more students were in ${g1} than in ${g2}?`
  ];
  return {
    img: makeSvgQuestionImage(lines),
    value: diff,
    hint: "Hint: Moving the same number from the larger group to the smaller group reduces the gap by that number from one side and increases it by that number on the other side. So the original gap is double the number moved."
  };
}

function genMediumFindOriginalWithTotalAndMove(){
  // total T even, and x small enough so B positive
  const themes = [
    ["marbles","Box A","Box B"],
    ["stickers","Team A","Team B"],
    ["coins","Jar A","Jar B"],
    ["cards","Pile A","Pile B"]
  ];
  const [thing,Aname,Bname] = choice(themes);

  const x = randInt(3, 10);
  const half = randInt(18, 35);
  const T = 2*half;
  const B = half - x;
  const A = half + x;
  if(B <= 0) return genMediumFindOriginalWithTotalAndMove();

  const lines = [
    `There are ${T} ${thing} in total in ${Aname} and ${Bname}.`,
    `${x} ${thing} are moved from ${Aname} to ${Bname}.`,
    `After that, ${Aname} and ${Bname} have the same number of ${thing}.`,
    `How many ${thing} were in ${Aname} at first?`
  ];
  return {
    img: makeSvgQuestionImage(lines),
    value: A,
    hint: "Hint: When they become equal, each side ends up with half of the total. The original larger amount is the final equal amount plus the number moved away."
  };
}

function genHardFindSmallerFromTotalAndMove(){
  const themes = [
    ["tickets","Box A","Box B"],
    ["beads","Bag A","Bag B"],
    ["balls","Basket A","Basket B"],
    ["stamps","Album A","Album B"]
  ];
  const [thing,Aname,Bname] = choice(themes);

  const x = randInt(4, 12);
  const half = randInt(x+10, 45);
  const T = 2*half;
  const smaller = half - x;
  if(smaller <= 0) return genHardFindSmallerFromTotalAndMove();

  const lines = [
    `${Aname} and ${Bname} have ${T} ${thing} altogether.`,
    `${x} ${thing} are moved from ${Aname} to ${Bname}.`,
    `Then both have the same number of ${thing}.`,
    `How many ${thing} were in ${Bname} at first?`
  ];
  return {
    img: makeSvgQuestionImage(lines),
    value: smaller,
    hint: "Hint: When they become equal, each side ends up with half of the total. The original smaller amount is the final equal amount minus the number it received."
  };
}

function genHardFindOriginalFromFinalEachAndMove(){
  const contexts = [
    ["fish","Big Fish","Small Fish"],
    ["candies","Person A","Person B"],
    ["pencils","Student A","Student B"],
    ["coins","Wallet A","Wallet B"]
  ];
  const [thing,Aname,Bname] = choice(contexts);

  const x = randInt(4, 12);
  const E = randInt(16, 30); // final each
  const A0 = E + x;          // original A
  if(E - x <= 0) return genHardFindOriginalFromFinalEachAndMove();

  const lines = [
    `${x} ${thing} are moved from ${Aname} to ${Bname}.`,
    `After that, both have ${E} ${thing}.`,
    `How many ${thing} did ${Aname} have at first?`
  ];
  return {
    img: makeSvgQuestionImage(lines),
    value: A0,
    hint: "Hint: If both end with the same number, the side that gave away items must have started with the final amount plus what it gave away."
  };
}

/* ---------------- State ---------------- */
let questions=[];
let currentQuestionIndex=0;
let studentName="Student";
let quizStartTime=null;
let quizEndTime=null;
let quizSubmitted=false;

let timerInterval=null;
let elapsedMs=0;
let isPaused=false;
let firstAttemptMs=null;

const quizContent=document.getElementById("quizContent");
const sidebarEl=document.getElementById("sidebar");

const buttonContainer=document.getElementById("navButtons");
const backButton=document.getElementById("backButton");
const nextButton=document.getElementById("nextButton");
const submitButton=document.getElementById("submitButton");
const checkButton=document.getElementById("checkButton");
const saveButton=document.getElementById("saveButton");

const generateBtn=document.getElementById("generateButton");
const pauseButton=document.getElementById("pauseButton");
const exportQuestionsBtn=document.getElementById("exportQuestionsBtn");
const timerDisplay=document.getElementById("timerDisplay");
const studentLine=document.getElementById("studentLine");
const quizContainer=document.getElementById("quizContainer");

/* ---------------- Timer ---------------- */
function updateTimerDisplay(){
  let totalMs=elapsedMs;
  if(!isPaused && quizStartTime) totalMs+=(new Date()-quizStartTime);
  let text=`Time: ${formatMs(totalMs)}`;
  if(firstAttemptMs!==null) text+=` (First: ${formatMs(firstAttemptMs)})`;
  timerDisplay.textContent=text;
}
function startTimerInterval(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(updateTimerDisplay, 1000);
}
function pauseTimer(){
  if(isPaused || !quizStartTime) return;
  const now=new Date();
  elapsedMs+=now-quizStartTime;
  isPaused=true;
  quizStartTime=null;
  updateTimerDisplay();
}
function resumeTimer(){
  if(!isPaused) return;
  isPaused=false;
  quizStartTime=new Date();
  updateTimerDisplay();
}

/* ---------------- Generate Quiz ---------------- */
function generateQuiz(){
  questions=[];
  quizSubmitted=false;

  const built = [
    genEasyFindTransferAmount(),
    genEasyFindOtherOriginal(),
    genMediumFindOriginalDifference(),
    genMediumFindOriginalWithTotalAndMove(),
    genHardFindSmallerFromTotalAndMove(),
    genHardFindOriginalFromFinalEachAndMove()
  ];

  for(let i=0;i<built.length;i++){
    const partIndex = Math.floor(i / QUESTIONS_PER_PART);
    const indexInPart = i % QUESTIONS_PER_PART;
    questions.push({
      partIndex,
      indexInPart,
      img: built[i].img,
      value: built[i].value,
      hint: built[i].hint,
      userValue:"",
      isCorrect:false
    });
  }
}

/* ---------------- Sidebar ---------------- */
function renderSidebar(){
  sidebarEl.style.display="block";
  sidebarEl.innerHTML=`<h4>Questions</h4><ul id="qList"></ul>`;
  const ul=document.getElementById("qList");
  for(let i=0;i<TOTAL_QUESTIONS;i++){
    const q=questions[i];
    const li=document.createElement("li");
    const label=["Easy","Medium","Hard"][q.partIndex] + (q.indexInPart+1);
    li.textContent=`Q${i+1} (${label})`;
    li.dataset.index=i;
    li.addEventListener("click",()=>{
      saveCurrentInput();
      currentQuestionIndex=i;
      renderQuestion();
    });
    ul.appendChild(li);
  }
  updateSidebarStatus();
}

function updateSidebarStatus(){
  const items=document.querySelectorAll("#qList li");
  items.forEach(li=>{
    const idx=Number(li.dataset.index);
    const q=questions[idx];
    li.classList.remove("active","answered","correct","incorrect");

    if(!quizSubmitted){
      li.classList.toggle("active", idx===currentQuestionIndex);
      if((q.userValue||"").trim()!=="") li.classList.add("answered");
    }else{
      if((q.userValue||"").trim()!==""){
        li.classList.add(q.isCorrect ? "correct" : "incorrect");
      }
    }
  });
}

/* ---------------- Helpers ---------------- */
function gradeOneQuestion(i){
  const q = questions[i];
  const val = parseAnswer(q.userValue || "");
  q.isCorrect = nearlyEqual(val, q.value);
}
function saveCurrentInput(){
  const input=document.getElementById("answerInput");
  if(input){
    questions[currentQuestionIndex].userValue = input.value.trim();
    if(quizSubmitted){
      gradeOneQuestion(currentQuestionIndex);
      updateSidebarStatus();
    }
  }
}
function mountNavButtonsInto(slotId){
  const slot=document.getElementById(slotId);
  if(!slot) return;
  slot.appendChild(buttonContainer);
  buttonContainer.style.display="flex";
}

/* ---------------- Render Question ---------------- */
function renderQuestion(){
  const q=questions[currentQuestionIndex];
  const levelLabel=["Easy","Medium","Hard"][q.partIndex];
  const fullLabel=`${levelLabel} — Question ${q.indexInPart+1}`;
  const hasHint = (q.hint||"").trim() !== "";

  quizContent.innerHTML=`
    <p class="question-text">Question ${currentQuestionIndex+1} of ${TOTAL_QUESTIONS}</p>
    <div class="part-title">${PART_TITLES[q.partIndex]}</div>

    <div class="single-question">
      <div style="font-weight:800;margin-bottom:8px;">${fullLabel}</div>

      <div class="img-wrap">
        <img class="q-img" src="${q.img}" alt="Question image">
      </div>

      <div class="answer-row">
        <div style="font-weight:700;">Answer (number):</div>
        <input id="answerInput" class="answer-box" type="text" inputmode="numeric" placeholder="e.g., 6" value="${q.userValue||""}">
      </div>

      <div id="checkFeedback" style="display:none;"></div>

      <div class="hint-row">
        <button id="hintBtn" class="hint-btn" ${hasHint ? "" : "disabled"}>${hasHint ? "Hint" : "No Hint"}</button>
      </div>
      <div id="hintBox" class="hint">${hasHint ? q.hint : ""}</div>
    </div>

    <div id="navSlot"></div>
  `;

  mountNavButtonsInto("navSlot");

  const hintBtn=document.getElementById("hintBtn");
  const hintBox=document.getElementById("hintBox");
  if(hintBtn && hintBox && hasHint){
    hintBtn.addEventListener("click", ()=>{
      const shown = hintBox.style.display==="block";
      hintBox.style.display = shown ? "none" : "block";
      hintBtn.textContent = shown ? "Hint" : "Hide Hint";
    });
  }

  backButton.style.display="inline-block";
  backButton.style.visibility = (currentQuestionIndex===0) ? "hidden" : "visible";

  const isLast = (currentQuestionIndex===TOTAL_QUESTIONS-1);
  nextButton.style.display = isLast ? "none" : "inline-block";
  submitButton.style.display = isLast ? "inline-block" : "none";

  saveButton.style.display = quizSubmitted ? "inline-block" : "none";
  checkButton.style.display = (quizSubmitted && !q.isCorrect) ? "inline-block" : "none";

  updateSidebarStatus();
}

/* ---------------- Results + Submit ---------------- */
function calculateAndShowResults(){
  saveCurrentInput();

  const now=new Date();
  let attemptMs=elapsedMs;
  if(!isPaused && quizStartTime) attemptMs+=now-quizStartTime;
  if(firstAttemptMs===null) firstAttemptMs=attemptMs;

  const attemptStartTime=quizStartTime || now;
  quizEndTime=now;
  quizSubmitted=true;

  let correctCount=0;
  questions.forEach(q=>{
    const val=parseAnswer(q.userValue||"");
    q.isCorrect=nearlyEqual(val, q.value);
    if(q.isCorrect) correctCount++;
  });

  updateSidebarStatus();

  let html=`
    <h3>Results for ${studentName}</h3>
    <p>Score: <strong>${correctCount} / ${TOTAL_QUESTIONS}</strong></p>
    <p>Start time: <strong>${attemptStartTime.toLocaleTimeString()}</strong></p>
    <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
    <p>Time taken (this attempt): <strong>${formatMs(attemptMs)}</strong></p>
    <p>First attempt time: <strong>${formatMs(firstAttemptMs)}</strong></p>
    <p>Click question numbers on the left to review. Incorrect questions will have a <strong>Check</strong> button.</p>

    <table class="review-table">
      <tr>
        <th>#</th><th>Part</th><th>Image</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th>
      </tr>
  `;

  questions.forEach((q,i)=>{
    const partLbl=["Easy","Medium","Hard"][q.partIndex] + (q.indexInPart+1);
    const ua=(q.userValue||"").trim();
    html+=`
      <tr class="${q.isCorrect ? "correct-answer":"incorrect-answer"}">
        <td>${i+1}</td>
        <td>${partLbl}</td>
        <td><img class="thumb" src="${q.img}" alt="Q${i+1}"></td>
        <td>${ua==="" ? "—" : ua}</td>
        <td><strong>${q.value}</strong></td>
        <td>${ua==="" ? "Not answered" : (q.isCorrect ? "Correct":"Incorrect")}</td>
      </tr>
    `;
  });

  html+=`</table><div id="navSlot"></div>`;
  quizContent.innerHTML=html;

  mountNavButtonsInto("navSlot");

  backButton.style.display="none";
  nextButton.style.display="none";
  submitButton.style.display="none";
  checkButton.style.display="none";
  saveButton.style.display="inline-block";

  // reset timer for next attempt
  elapsedMs=0; isPaused=false; quizStartTime=new Date();
  pauseButton.textContent="Pause";
  startTimerInterval();
  updateTimerDisplay();
}

/* ---------------- Buttons ---------------- */
nextButton.addEventListener("click", ()=>{
  saveCurrentInput();
  if(currentQuestionIndex<TOTAL_QUESTIONS-1){
    currentQuestionIndex++;
    renderQuestion();
  }
});
backButton.addEventListener("click", ()=>{
  saveCurrentInput();
  if(currentQuestionIndex>0){
    currentQuestionIndex--;
    renderQuestion();
  }
});
submitButton.addEventListener("click", ()=>{
  if(currentQuestionIndex===TOTAL_QUESTIONS-1){
    calculateAndShowResults();
  }
});

/* Check (after submit) */
checkButton.addEventListener("click", ()=>{
  saveCurrentInput();
  const q = questions[currentQuestionIndex];
  if(!quizSubmitted) return;

  gradeOneQuestion(currentQuestionIndex);
  updateSidebarStatus();

  const box=document.getElementById("checkFeedback");
  if(!box) return;

  box.className="check-feedback";
  box.style.display="block";

  if(q.isCorrect){
    box.innerHTML = `✅ Correct!`;
    checkButton.style.display = "none";
  }else{
    box.innerHTML = `❌ Incorrect. Correct answer: <strong>${q.value}</strong>`;
    checkButton.style.display = "inline-block";
  }
});

/* Save TXT */
function formatDateForFilename(date){
  if(!date) return "no_time";
  const pad=n=>String(n).padStart(2,"0");
  return date.getFullYear()+pad(date.getMonth()+1)+pad(date.getDate())+"_"+
         pad(date.getHours())+pad(date.getMinutes())+pad(date.getSeconds());
}
function saveCurrentResultAsTxt(){
  saveCurrentInput();

  if(!quizSubmitted){
    questions.forEach(q=>{
      const val=parseAnswer(q.userValue||"");
      q.isCorrect=nearlyEqual(val,q.value);
    });
  }
  let correctCount=0;
  questions.forEach(q=>{ if(q.isCorrect) correctCount++; });

  const lines=[];
  lines.push("Transfer-to-Equalize (Image Quiz) - Current Result");
  lines.push("Student: "+studentName);
  if(quizStartTime) lines.push("Start time: "+quizStartTime.toLocaleString());
  if(quizEndTime) lines.push("Last submit time: "+quizEndTime.toLocaleString());
  lines.push("Score: "+correctCount+" / "+TOTAL_QUESTIONS);
  if(firstAttemptMs!==null) lines.push("First attempt time: "+formatMs(firstAttemptMs));
  lines.push("");
  lines.push("Details:");
  lines.push("----------");

  questions.forEach((q,i)=>{
    const partLbl=["Easy","Medium","Hard"][q.partIndex]+(q.indexInPart+1);
    const userAns=(q.userValue||"").trim()==="" ? "Not answered" : q.userValue;
    const resultText=(q.userValue||"").trim()==="" ? "Not answered" : (q.isCorrect?"Correct":"Incorrect");
    lines.push(`Q${i+1} (${partLbl})`);
    lines.push("Your answer: "+userAns);
    lines.push("Correct answer: "+q.value);
    lines.push("Result: "+resultText);
    lines.push("");
  });

  const content=lines.join("\n");
  const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const safeName=studentName.replace(/[^a-z0-9_\-]/gi,"_")||"Student";
  const ts=formatDateForFilename(new Date());
  a.href=url;
  a.download=`TransferEqualize_${safeName}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
saveButton.addEventListener("click", saveCurrentResultAsTxt);

/* Export ALL QUESTIONS to PDF
   - DYAA logo only once in the page header
   - 2 questions per page
*/
exportQuestionsBtn.addEventListener("click", async () => {
  if (!questions || questions.length === 0) {
    alert("Please start a quiz first.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // 隐藏容器，用于按“每页 2 题”渲染
  const wrapper = document.createElement("div");
  wrapper.style.position = "fixed";
  wrapper.style.left = "-9999px";
  wrapper.style.top = "0";
  wrapper.style.width = "800px";
  wrapper.style.background = "#ffffff";
  document.body.appendChild(wrapper);

  let groupDiv = null; // 每个 groupDiv => PDF 的一页

  questions.forEach((q, idx) => {
    // 每 2 题新开一页，并在页顶加一次 DYAA 页眉
    if (idx % 2 === 0) {
      groupDiv = document.createElement("div");
      groupDiv.style.padding = "20px";
      groupDiv.style.marginBottom = "20px";
      groupDiv.style.boxSizing = "border-box";

      // 页眉：DYAA logo + 名称（只出现一次）
      const header = document.createElement("div");
      header.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <div style="width:40px;height:40px;background:#0d47a1;border-radius:6px;position:relative;">
            <div style="position:absolute;width:20px;height:9px;background:#ff9800;top:-6px;left:20px;border-radius:3px;"></div>
          </div>
          <div style="display:flex;flex-direction:column;line-height:1.1;">
            <div style="font-weight:900;letter-spacing:1px;color:#ff9800;">DYAA</div>
            <div style="font-size:0.85em;color:#0d47a1;font-weight:700;">EDUCATION</div>
          </div>
        </div>
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:0 0 12px 0;">
      `;
      groupDiv.appendChild(header);

      wrapper.appendChild(groupDiv);
    }

    // 当前页里的题目块（不再带小 logo）
    const qDiv = document.createElement("div");
    qDiv.style.marginBottom = "18px";
    qDiv.innerHTML = `
      <div style="font-weight:700;margin:4px 0 6px 0;">Q${idx + 1}</div>
      <div style="border-radius:12px;border:1px solid #e5e5e5;padding:12px;">
        <img src="${q.img}" style="width:100%;height:auto;border-radius:10px;" />
      </div>
    `;
    groupDiv.appendChild(qDiv);
  });

  const groups = Array.from(wrapper.children);

  for (let i = 0; i < groups.length; i++) {
    // 每个 group（一页）截图后塞进 PDF
    // eslint-disable-next-line no-await-in-loop
    const canvas = await html2canvas(groups[i], { scale: 2 });
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = pageWidth - 20;          // 左右各 10mm 边距
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    const x = 10;
    const y = 10;

    if (i > 0) pdf.addPage();
    pdf.addImage(
      imgData,
      "PNG",
      x,
      y,
      imgWidth,
      Math.min(imgHeight, pageHeight - 20)
    );
  }

  const safeName = (studentName || "Student")
    .replace(/[^a-z0-9_\-]/gi, "_") || "Student";
  const ts = formatDateForFilename(new Date());
  pdf.save(`TransferEqualize_${safeName}_${ts}.pdf`);

  document.body.removeChild(wrapper);
});


/* Pause/Resume */
pauseButton.addEventListener("click", ()=>{
  if(!quizStartTime && elapsedMs===0 && !quizSubmitted) return;
  if(isPaused){ resumeTimer(); pauseButton.textContent="Pause"; }
  else { pauseTimer(); pauseButton.textContent="Resume"; }
});

/* Generate new set */
generateBtn.addEventListener("click", ()=>{
  if(!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;

  if(timerInterval) clearInterval(timerInterval);
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  quizStartTime=new Date(); quizEndTime=null;
  updateTimerDisplay(); startTimerInterval();
  pauseButton.style.display="inline-block";
  pauseButton.textContent="Pause";

  generateQuiz();
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();
});

/* ---------------- Start Screen (+ optional ?name=Tiger) ---------------- */
function getNameFromUrl(){
  const url = new URL(window.location.href);
  const name = url.searchParams.get("name");
  return name ? name.trim() : "";
}

function showStartScreen(){
  sidebarEl.style.display="none";
  buttonContainer.style.display="none";
  generateBtn.style.display="none";
  saveButton.style.display="none";
  pauseButton.style.display="none";
  exportQuestionsBtn.style.display="none";
  studentLine.textContent="";

  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  quizStartTime=null; quizEndTime=null;
  updateTimerDisplay();

  const preset = getNameFromUrl();
  if(preset){
    studentName = preset;
    studentLine.textContent = `Student: ${studentName}`;
    startQuiz(true);
    return;
  }

  quizContent.innerHTML=`
    <p>This quiz has <strong>${TOTAL_QUESTIONS}</strong> image word problems:</p>
    <ul style="margin-top:6px;color:#555;line-height:1.7%;">
      <li><strong>Part 1 (Easy):</strong> 2 questions</li>
      <li><strong>Part 2 (Medium):</strong> 2 questions</li>
      <li><strong>Part 3 (Hard):</strong> 2 questions</li>
    </ul>
    <p style="margin-top:10px;">Please enter your name to begin:</p>

    <input id="nameInput" type="text"
      style="padding:10px;width:260px;font-size:1.05em;border:1px solid #ccc;border-radius:10px;"
      placeholder="Your name">

    <button id="startButton"
      style="margin-left:10px;background:#4caf50;padding:10px 20px;color:white;border:none;border-radius:8px;">
      Start Quiz
    </button>
  `;
  document.getElementById("startButton").addEventListener("click", ()=>startQuiz(false));
}

function startQuiz(skipReadName){
  if(!skipReadName){
    const nameInput=document.getElementById("nameInput");
    studentName=(nameInput.value || "Student").trim();
  }
  studentLine.textContent = `Student: ${studentName}`;

  quizStartTime=new Date();
  elapsedMs=0; isPaused=false; firstAttemptMs=null;
  updateTimerDisplay(); startTimerInterval();

  generateQuiz();
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();

  generateBtn.style.display="inline-block";
  pauseButton.style.display="inline-block";
  pauseButton.textContent="Pause";
  exportQuestionsBtn.style.display="inline-block";
}

/* ---------------- Init ---------------- */
showStartScreen();
</script>
</body>
</html>
