<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DYAA Wrong Questions — Local PNG Folder</title>

  <style>
    body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f4f4f9;margin:0;padding:20px;color:#333;}
    .quiz-container{max-width:900px;margin:40px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);}
    #headerLogo{display:flex;align-items:center;gap:12px;margin-bottom:10px;border-bottom:2px solid #e0e0e0;padding-bottom:10px;}
    .logo-icon{width:40px;height:40px;background:#0d47a1;border-radius:6px;position:relative;}
    .logo-icon:before{content:"";position:absolute;width:20px;height:9px;background:#ff9800;top:-6px;left:20px;border-radius:3px;}
    .logo-text{display:flex;flex-direction:column;line-height:1.1;}
    .logo-text .brand{font-weight:900;letter-spacing:1px;color:#ff9800;}
    .logo-text .edu{font-size:.9em;color:#0d47a1;font-weight:700;}

    .top-bar{display:flex;justify-content:space-between;align-items:flex-start;margin:10px 0 6px 0;gap:10px;flex-wrap:wrap;}
    #timerDisplay{font-size:.95em;color:#333;}
    #studentLine{font-size:.95em;color:#555;}
    #setInfo{font-size:.95em;color:#555;}
    #bankInfo{color:#666;font-size:.92em;line-height:1.6;}

    .top-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}

    button{padding:10px 18px;border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:1em;}
    button:disabled{opacity:.55;cursor:not-allowed;}
    #pauseButton{background:#f57c00;}
    #restartButton{background:#455a64;}
    #nextButton{background:#4caf50;}
    #backButton{background:#039be5;}
    #submitButton{background:#9c27b0;}
    #checkButton{background:#455a64;}
    #saveButton{background:#607d8b;}
    #exportQuestionsBtn{background:#ff9800;}

    .pdf-controls{
      display:none;align-items:center;gap:10px;flex-wrap:wrap;
      padding:6px 8px;border:1px solid #e6e6e6;border-radius:10px;background:#fafafa;
    }
    .pdf-controls label{display:flex;align-items:center;gap:8px;color:#444;font-size:.95em;}
    #pdfPerPageSelect{padding:8px 10px;border:1px solid #ccc;border-radius:10px;font-size:1em;background:#fff;}

    .quiz-main{display:flex;gap:20px;margin-top:10px;}
    .sidebar{width:180px;border-right:1px solid #ddd;padding-right:10px;display:none;}
    .sidebar h4{margin:0 0 8px;font-size:.95em;border-bottom:1px solid #eee;padding-bottom:4px;}
    .sidebar ul{list-style:none;padding:0;margin:0;}
    .sidebar li{padding:6px;cursor:pointer;border-radius:6px;font-size:.9em;margin-bottom:6px;border:1px solid #eee;background:#fafafa;}
    .sidebar li.active{outline:2px solid #1976d2;font-weight:700;background:#fff;}
    .sidebar li.answered{border-left:5px solid #4caf50;}
    .sidebar li.correct{background:#d4edda;border-left:5px solid #28a745;border-color:#cbe7d1;}
    .sidebar li.incorrect{background:#f8d7da;border-left:5px solid #f44336;border-color:#f1c7cc;}

    #quizContent{flex:1;}
    .question-text{font-size:1.05em;margin-bottom:8px;}
    .single-question{margin:6px 0;line-height:1.7;}
    .answer-row{margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}

    /* ✅ better for multi-part */
    .answer-box{
      width:160px;
      padding:8px;
      font-size:1em;
      border:1px solid #ccc;
      border-radius:8px;
    }
    .part-label{
      font-weight:700;
      color:#333;
      margin-right:4px;
      min-width:18px;
      display:inline-block;
      text-align:right;
    }

    .img-wrap{
      background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:12px;
      box-shadow:0 3px 8px rgba(0,0,0,0.05);
      max-width:100%;
      text-align:center;
      overflow:auto;
    }
    .q-img{max-width:100%;width:auto;height:auto;display:block;margin:0 auto;border-radius:10px;}
    .fit-width .q-img{width:100%;}

    .missing{border:2px dashed #ef9a9a;background:#fff5f5;padding:16px;border-radius:12px;color:#b71c1c;font-weight:700;}

    .button-container{
      display:flex;justify-content:space-between;gap:10px;margin-top:14px;flex-wrap:wrap;align-items:center;
    }

    .check-feedback{
      margin-top:10px;padding:10px 12px;border-radius:10px;background:#f7f7f7;border:1px solid #e0e0e0;color:#333;font-size:.95em;
    }

    table.review-table{width:100%;border-collapse:collapse;margin-top:18px;}
    .review-table th,.review-table td{border:1px solid #ccc;padding:6px;font-size:.85em;text-align:center;vertical-align:top;}
    .review-table th{background:#f2f2f2;}
    .correct-answer{background:#d4edda;}
    .incorrect-answer{background:#f8d7da;}
    .thumb{width:160px;max-width:160px;height:auto;border-radius:8px;border:1px solid #ddd;background:#fff;}

    .small-note{color:#666;font-size:.92em;line-height:1.6;}

    @media (max-width:760px){
      .quiz-main{flex-direction:column;}
      .sidebar{width:100%;border-right:none;border-bottom:1px solid #ddd;margin-bottom:10px;padding-bottom:10px;}
      .thumb{width:120px;max-width:120px;}
      .top-actions{justify-content:flex-start;}
      .answer-box{width:140px;}
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon"></div>
    <div class="logo-text">
      <div class="brand">DYAA</div>
      <div class="edu">EDUCATION</div>
    </div>
  </div>

  <div class="top-bar">
    <div>
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentLine"></div>
      <div id="setInfo"></div>
      <div id="bankInfo"></div>
    </div>

    <div class="top-actions">
      <div id="pdfControls" class="pdf-controls">
        <label>
          PDF per page
          <select id="pdfPerPageSelect">
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
        </label>
        <button id="exportQuestionsBtn">Export Questions PDF</button>
      </div>

      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="restartButton" style="display:none;">Restart</button>
    </div>
  </div>

  <h2 style="margin:6px 0 0 0;">Local PNG Quiz</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <div id="navButtons" class="button-container" style="display:none;">
    <button id="backButton">Previous</button>
    <button id="checkButton">Check</button>
    <button id="saveButton" style="display:none;">Save Current Result</button>
    <button id="submitButton" style="display:none;">Submit &amp; View Results</button>
    <button id="nextButton">Next</button>
  </div>
</div>

<script>
/* ===================== EDIT HERE ===================== */
var CONFIG = {
  QUESTIONS_DIR: "./",
  TOTAL_QUESTIONS: 11,
  SHUFFLE_EACH_SET: false
};

/*
✅ Multi-part answers supported:
- array: ANSWERS[7] = [550, 210];
- separator string: "550|210"  (also supports "," "，" ";" "；")
*/
var ANSWERS = [
  "",     // index 0 placeholder
  910,
  240,
  45,
  120,
  513.6,
  20,
  550,
  210,
   "44%",         // ✅ single-part answer
    [480000, "1.6%"],   // ✅ example: 2-part answer
    ["70%", 200],   // ✅ example: 2-part answer
]; // length >= TOTAL_QUESTIONS + 1


/* ===================== URL name support ===================== */
var urlName = "";
try{
  var sp = new URLSearchParams(window.location.search || "");
  urlName = (sp.get("name") || "").trim();
}catch(e){
  urlName = "";
}
var AUTO_START_ON_LOAD = (urlName !== "");

/* ===================== Helpers ===================== */
function ensureDirSlash(dir){
  if(!dir) return "./";
  return dir.charAt(dir.length-1) === "/" ? dir : (dir + "/");
}
function qSrc(id){
  return ensureDirSlash(CONFIG.QUESTIONS_DIR) + "q" + id + ".png";
}
function pad2(n){ return (n<10?"0":"") + n; }
function formatMs(ms){
  var totalSec = Math.floor(ms/1000);
  var m = Math.floor(totalSec/60);
  var s = totalSec % 60;
  return pad2(m) + ":" + pad2(s);
}
function nowMs(){ return (new Date()).getTime(); }
function shuffle(arr){
  for(var i=arr.length-1;i>0;i--){
    var j = Math.floor(Math.random()*(i+1));
    var t = arr[i]; arr[i]=arr[j]; arr[j]=t;
  }
  return arr;
}
function normalizeAnswer(s){
  return String(s==null?"":s).trim().replace(/\s+/g,"").toLowerCase();
}
function isNumericLike(s){
  s = String(s==null?"":s).trim();
  return /^-?\d+(\.\d+)?$/.test(s);
}
function nearlyEqual(a,b,eps){
  if(eps==null) eps = 1e-9;
  if(!isFinite(a) || !isFinite(b)) return false;
  return Math.abs(a-b) < eps;
}
function escapeAttr(s){
  s = String(s==null?"":s);
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function getBaseHref(){
  var clean = window.location.href.split("#")[0].split("?")[0];
  var idx = clean.lastIndexOf("/");
  return idx>=0 ? clean.slice(0, idx+1) : clean;
}

/* ✅ Multi-part helpers */
function partLetter(i){
  return String.fromCharCode(65 + i); // 0->A,1->B,2->C...
}
function keyToParts(key){
  if(key == null) return [""];
  if(Array.isArray(key)){
    return key.map(function(x){ return String(x==null?"":x).trim(); });
  }
  var s = String(key).trim();
  if(s==="") return [""];
  // if contains separator → split into parts
  var seps = ["|", ";", "；", "，", ","];
  for(var i=0;i<seps.length;i++){
    if(s.indexOf(seps[i]) >= 0){
      var parts = s.split(seps[i]).map(function(x){ return String(x==null?"":x).trim(); });
      // keep non-empty (but if all empty keep one)
      parts = parts.filter(function(x){ return x!==""; });
      return parts.length ? parts : [""];
    }
  }
  return [s];
}
function partsAllBlank(parts){
  for(var i=0;i<parts.length;i++){
    if(String(parts[i]||"").trim()!=="") return false;
  }
  return true;
}
function formatPartsForDisplay(parts){
  // A: xxx, B: yyy ...
  if(!parts || !parts.length) return "—";
  if(parts.length === 1) return String(parts[0]||"").trim() || "—";
  var out = [];
  for(var i=0;i<parts.length;i++){
    var v = String(parts[i]||"").trim();
    out.push(partLetter(i) + ": " + (v==="" ? "—" : v));
  }
  return out.join(" , ");
}
function gradePart(user, correct){
  var ua = String(user||"").trim();
  var ca = String(correct||"").trim();
  if(ua==="" || ca==="") return { ok:false, missingUser:(ua===""), missingKey:(ca==="") };

  if(isNumericLike(ua) && isNumericLike(ca)){
    return { ok: nearlyEqual(Number(ua), Number(ca)), missingUser:false, missingKey:false };
  }
  return { ok: normalizeAnswer(ua) === normalizeAnswer(ca), missingUser:false, missingKey:false };
}
function gradeMulti(userParts, correctParts){
  // overall ok if ALL parts ok
  // also if key missing for ALL parts -> noKey
  if(!correctParts || !correctParts.length) correctParts = [""];
  if(!userParts || !userParts.length) userParts = new Array(correctParts.length).fill("");

  if(partsAllBlank(correctParts)) return { ok:false, noKey:true, missing:false, partResults:[] };

  var n = Math.max(userParts.length, correctParts.length);
  var pr = [];
  var allOk = true;
  var anyMissing = false;

  for(var i=0;i<n;i++){
    var ua = (i<userParts.length ? userParts[i] : "");
    var ca = (i<correctParts.length ? correctParts[i] : "");
    if(String(ua||"").trim()==="") anyMissing = true;

    if(String(ca||"").trim()===""){
      // key missing for this part -> cannot be correct
      allOk = false;
      pr.push({i:i, ok:false, missingKey:true, missingUser:(String(ua||"").trim()==="")});
    }else{
      var r = gradePart(ua, ca);
      pr.push({i:i, ok:!!r.ok, missingKey:false, missingUser:!!r.missingUser});
      if(!r.ok) allOk = false;
    }
  }

  return { ok: allOk && !anyMissing, noKey:false, missing:anyMissing, partResults:pr };
}

/* ===================== State ===================== */
var questions = []; // {id, src, userParts[], checked, isCorrect}
var currentIndex = 0;
var studentName = "Student";

var timerInterval = null;
var startTime = null;
var elapsedMs = 0;
var paused = false;
var firstAttemptMs = null;
var submitted = false;

/* ===================== DOM refs ===================== */
var quizContent = document.getElementById("quizContent");
var sidebarEl = document.getElementById("sidebar");

var timerDisplay = document.getElementById("timerDisplay");
var studentLine = document.getElementById("studentLine");
var setInfo = document.getElementById("setInfo");
var bankInfo = document.getElementById("bankInfo");

var navButtons = document.getElementById("navButtons");
var backButton = document.getElementById("backButton");
var nextButton = document.getElementById("nextButton");
var submitButton = document.getElementById("submitButton");
var checkButton = document.getElementById("checkButton");
var saveButton = document.getElementById("saveButton");

var pauseButton = document.getElementById("pauseButton");
var restartButton = document.getElementById("restartButton");

var pdfControls = document.getElementById("pdfControls");
var pdfPerPageSelect = document.getElementById("pdfPerPageSelect");
var exportQuestionsBtn = document.getElementById("exportQuestionsBtn");

/* ===================== Timer ===================== */
function updateTimer(){
  var ms = elapsedMs;
  if(startTime && !paused) ms += (nowMs() - startTime);
  var text = "Time: " + formatMs(ms);
  if(firstAttemptMs !== null) text += " (First: " + formatMs(firstAttemptMs) + ")";
  timerDisplay.textContent = text;
}
function startTimer(){
  startTime = nowMs();
  elapsedMs = 0;
  paused = false;
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 1000);
  updateTimer();
}
function togglePause(){
  if(!startTime && elapsedMs===0) return;
  if(!paused){
    elapsedMs += (nowMs() - startTime);
    startTime = null;
    paused = true;
    pauseButton.textContent = "Resume";
  }else{
    startTime = nowMs();
    paused = false;
    pauseButton.textContent = "Pause";
  }
  updateTimer();
}
function currentAttemptMs(){
  var ms = elapsedMs;
  if(startTime && !paused) ms += (nowMs() - startTime);
  return ms;
}

/* ===================== Build questions ===================== */
function buildQuestions(){
  var total = Math.max(1, Number(CONFIG.TOTAL_QUESTIONS)||1);
  var ids = [];
  for(var i=1;i<=total;i++) ids.push(i);
  if(CONFIG.SHUFFLE_EACH_SET) shuffle(ids);

  questions = [];
  for(var k=0;k<ids.length;k++){
    questions.push({
      id: ids[k],
      src: qSrc(ids[k]),
      userParts: [],          // ✅ multi-part answers stored here
      checked: false,
      isCorrect: false
    });
  }
  currentIndex = 0;
  submitted = false;
}

/* ===================== Sidebar ===================== */
function renderSidebar(){
  sidebarEl.style.display = "block";
  sidebarEl.innerHTML = "";
  var h = document.createElement("h4");
  h.textContent = "Questions";
  sidebarEl.appendChild(h);

  var ul = document.createElement("ul");
  ul.id = "qList";
  sidebarEl.appendChild(ul);

  for(var i=0;i<questions.length;i++){
    (function(idx){
      var li = document.createElement("li");
      li.textContent = "Q" + (idx+1);
      li.onclick = function(){
        saveCurrentInput();
        currentIndex = idx;
        renderQuestion();
      };
      ul.appendChild(li);
    })(i);
  }
  updateSidebar();
}
function isAnswered(q){
  if(!q || !q.userParts || !q.userParts.length) return false;
  for(var i=0;i<q.userParts.length;i++){
    if(String(q.userParts[i]||"").trim()!=="") return true;
  }
  return false;
}
function updateSidebar(){
  var ul = document.getElementById("qList");
  if(!ul) return;
  var items = ul.querySelectorAll("li");
  for(var i=0;i<items.length;i++){
    items[i].classList.remove("active","answered","correct","incorrect");
    if(i===currentIndex) items[i].classList.add("active");
    if(isAnswered(questions[i])) items[i].classList.add("answered");
    if(submitted && questions[i].checked){
      items[i].classList.add(questions[i].isCorrect ? "correct" : "incorrect");
    }
  }
}

/* ===================== Render question ===================== */
function saveCurrentInput(){
  var q = questions[currentIndex];
  if(!q) return;

  var inputs = Array.prototype.slice.call(document.querySelectorAll(".answerPartInput"));
  if(inputs.length){
    q.userParts = inputs.map(function(inp){ return String(inp.value||"").trim(); });
    return;
  }

  // fallback (shouldn't happen)
  var inp = document.getElementById("answerInput");
  if(inp){
    q.userParts = [String(inp.value||"").trim()];
  }
}

function renderQuestion(){
  var q = questions[currentIndex];
  quizContent.innerHTML = "";

  var p = document.createElement("p");
  p.className = "question-text";
  p.textContent = "Question " + (currentIndex+1) + " of " + questions.length;
  quizContent.appendChild(p);

  var block = document.createElement("div");
  block.className = "single-question";
  quizContent.appendChild(block);

  var imgWrap = document.createElement("div");
  imgWrap.className = "img-wrap";
  imgWrap.id = "imgWrap";
  block.appendChild(imgWrap);

  var img = document.createElement("img");
  img.className = "q-img";
  img.alt = "Question image";
  img.src = q.src;
  imgWrap.appendChild(img);

  var missing = document.createElement("div");
  missing.className = "missing";
  missing.style.display = "none";
  missing.innerHTML = 'Missing image: <code>q' + q.id + '.png</code><br>Tried: <code>' + escapeAttr(q.src) + '</code>';
  imgWrap.appendChild(missing);

  img.onerror = function(){ img.style.display="none"; missing.style.display="block"; };
  img.onload  = function(){ img.style.display="block"; missing.style.display="none"; };

  var fitLabel = document.createElement("label");
  fitLabel.style.cssText = "display:inline-flex;gap:8px;align-items:center;margin-top:10px;color:#555;font-size:0.95em;";
  var fit = document.createElement("input");
  fit.type = "checkbox";
  fit.onchange = function(){
    if(fit.checked) imgWrap.classList.add("fit-width");
    else imgWrap.classList.remove("fit-width");
  };
  fitLabel.appendChild(fit);
  fitLabel.appendChild(document.createTextNode(" Fit to width (may look blurry)"));
  block.appendChild(fitLabel);

  var ansRow = document.createElement("div");
  ansRow.className = "answer-row";
  block.appendChild(ansRow);

  var ansTitle = document.createElement("div");
  ansTitle.style.fontWeight = "700";
  ansTitle.textContent = "Answer:";
  ansRow.appendChild(ansTitle);

  // ✅ Determine how many parts this question has (from ANSWERS)
  var keyParts = keyToParts(ANSWERS[q.id]);
  var partCount = Math.max(1, keyParts.length);

  // ensure stored userParts matches partCount (keep existing values)
  if(!q.userParts || !q.userParts.length){
    q.userParts = new Array(partCount).fill("");
  }else if(q.userParts.length !== partCount){
    var old = q.userParts.slice();
    q.userParts = new Array(partCount).fill("");
    for(var i=0;i<Math.min(old.length, partCount);i++) q.userParts[i] = old[i];
  }

  // ✅ Render multiple inputs
  for(var i=0;i<partCount;i++){
    var wrap = document.createElement("div");
    wrap.style.display = "inline-flex";
    wrap.style.alignItems = "center";
    wrap.style.gap = "6px";

    if(partCount > 1){
      var pl = document.createElement("span");
      pl.className = "part-label";
      pl.textContent = partLetter(i) + ":";
      wrap.appendChild(pl);
    }

    var inp = document.createElement("input");
    inp.className = "answer-box answerPartInput";
    inp.type = "text";
    inp.placeholder = partCount > 1 ? ("Answer " + partLetter(i)) : "Type your answer";
    inp.value = q.userParts[i] || "";
    wrap.appendChild(inp);

    ansRow.appendChild(wrap);
  }

  var feedback = document.createElement("div");
  feedback.id = "checkFeedback";
  feedback.style.display = "none";
  feedback.className = "check-feedback";
  block.appendChild(feedback);

  navButtons.style.display = "flex";
  backButton.disabled = (currentIndex===0);
  nextButton.disabled = (currentIndex===questions.length-1);

  submitButton.style.display = (currentIndex===questions.length-1) ? "inline-block" : "none";
  checkButton.style.display = "inline-block";
  saveButton.style.display = "none";

  updateSidebar();
}

/* ===================== Check current ===================== */
function doCheckCurrent(){
  saveCurrentInput();
  var q = questions[currentIndex];
  var fb = document.getElementById("checkFeedback");
  if(!fb) return;

  var keyParts = keyToParts(ANSWERS[q.id]);
  var userParts = q.userParts || [];

  q.checked = true;

  var g = gradeMulti(userParts, keyParts);
  q.isCorrect = !!g.ok;

  fb.style.display = "block";

  if(g.noKey){
    fb.innerHTML = "⚠️ No answer key for this question yet (ANSWERS[" + q.id + "] is blank).";
    updateSidebar();
    return;
  }

  if(g.missing){
    fb.innerHTML = "⚠️ Please enter all required answers" + (keyParts.length>1 ? (" (A–" + partLetter(keyParts.length-1) + ").") : ".");
    updateSidebar();
    return;
  }

  if(q.isCorrect){
    fb.innerHTML = "✅ Correct!";
  }else{
    fb.innerHTML = "❌ Incorrect. Correct answer: <strong>" + escapeAttr(formatPartsForDisplay(keyParts)) + "</strong>";
  }

  updateSidebar();
}

/* ===================== Submit & Results ===================== */
function showResults(){
  saveCurrentInput();

  var attemptMs = currentAttemptMs();
  if(firstAttemptMs === null) firstAttemptMs = attemptMs;

  submitted = true;

  var correctCount = 0;

  for(var i=0;i<questions.length;i++){
    var q = questions[i];
    var keyParts = keyToParts(ANSWERS[q.id]);
    var userParts = q.userParts || [];

    var g = gradeMulti(userParts, keyParts);
    q.checked = isAnswered(q);
    q.isCorrect = !!g.ok;

    if(q.isCorrect) correctCount++;
  }

  updateSidebar();

  quizContent.innerHTML = "";
  var h = document.createElement("h3");
  h.textContent = "Results — " + studentName;
  quizContent.appendChild(h);

  var p1 = document.createElement("p");
  p1.innerHTML = 'Score: <strong>' + correctCount + " / " + questions.length + "</strong>";
  quizContent.appendChild(p1);

  var p2 = document.createElement("p");
  p2.innerHTML = "Time taken: <strong>" + formatMs(attemptMs) + "</strong> &nbsp;&nbsp; First attempt: <strong>" + formatMs(firstAttemptMs) + "</strong>";
  quizContent.appendChild(p2);

  var table = document.createElement("table");
  table.className = "review-table";
  table.innerHTML = "<tr><th>#</th><th>Image</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr>";
  quizContent.appendChild(table);

  for(var j=0;j<questions.length;j++){
    var qq = questions[j];
    var userParts2 = qq.userParts || [];
    var keyParts2 = keyToParts(ANSWERS[qq.id]);

    var uaDisp = formatPartsForDisplay(userParts2);
    var caDisp = formatPartsForDisplay(keyParts2);

    var resultText;
    if(!isAnswered(qq)){
      resultText = "Not answered";
    }else if(partsAllBlank(keyParts2)){
      resultText = "Answered (no key)";
    }else{
      resultText = qq.isCorrect ? "Correct" : "Incorrect";
    }

    var row = document.createElement("tr");
    row.className = qq.isCorrect ? "correct-answer" : "incorrect-answer";

    row.innerHTML =
      "<td>" + (j+1) + "</td>" +
      '<td><img class="thumb" src="' + escapeAttr(qq.src) + '" alt="Q' + (j+1) + '" onerror="this.style.display=\'none\'"></td>' +
      "<td>" + escapeAttr(uaDisp) + "</td>" +
      "<td><strong>" + escapeAttr(caDisp) + "</strong></td>" +
      "<td>" + escapeAttr(resultText) + "</td>";
    table.appendChild(row);
  }

  navButtons.style.display = "flex";
  backButton.style.display = "none";
  nextButton.style.display = "none";
  checkButton.style.display = "none";
  submitButton.style.display = "none";
  saveButton.style.display = "inline-block";
}

/* ===================== Save current result ===================== */
function formatDateForFilename(date){
  var pad = function(n){ return (n<10?"0":"")+n; };
  return date.getFullYear()+pad(date.getMonth()+1)+pad(date.getDate())+"_"+
         pad(date.getHours())+pad(date.getMinutes())+pad(date.getSeconds());
}
function saveCurrentResultAsTxt(){
  if(!submitted) showResults();

  var attemptMs = currentAttemptMs();
  var correctCount = 0;
  for(var i=0;i<questions.length;i++) if(questions[i].isCorrect) correctCount++;

  var lines = [];
  lines.push("DYAA Local PNG Quiz - Result");
  lines.push("Student: " + studentName);
  lines.push("Score: " + correctCount + " / " + questions.length);
  lines.push("Time: " + formatMs(attemptMs));
  if(firstAttemptMs !== null) lines.push("First attempt time: " + formatMs(firstAttemptMs));
  lines.push("");
  lines.push("Details:");
  lines.push("----------");

  for(var j=0;j<questions.length;j++){
    var q = questions[j];
    var userParts = q.userParts || [];
    var keyParts = keyToParts(ANSWERS[q.id]);

    var ua = formatPartsForDisplay(userParts);
    var ca = formatPartsForDisplay(keyParts);

    var res;
    if(!isAnswered(q)) res = "Not answered";
    else if(partsAllBlank(keyParts)) res = "Answered (no key)";
    else res = (q.isCorrect ? "Correct" : "Incorrect");

    lines.push("Q" + (j+1) + " (file: q" + q.id + ".png)");
    lines.push("Your answer: " + ua);
    lines.push("Correct answer: " + ca);
    lines.push("Result: " + res);
    lines.push("");
  }

  var blob = new Blob([lines.join("\n")], {type:"text/plain;charset=utf-8"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  var safeName = studentName.replace(/[^a-z0-9_\-]/gi,"_") || "Student";
  a.href = url;
  a.download = "DYAA_Result_" + safeName + "_" + formatDateForFilename(new Date()) + ".txt";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ===================== PDF Export (Print to PDF) ===================== */
function gridForPerPage(n){
  var map = {3:{c:1,r:3},4:{c:2,r:2},6:{c:2,r:3},8:{c:2,r:4},9:{c:3,r:3}};
  return map[n] || {c:1,r:n};
}
function exportQuestionsToPdf(){
  if(!questions.length){
    alert("Start the quiz first.");
    return;
  }
  var perPage = Number(pdfPerPageSelect.value || 3);
  if([3,4,6,8,9].indexOf(perPage) < 0) perPage = 3;

  var g = gridForPerPage(perPage);
  var cols = g.c, rows = g.r;
  var baseHref = getBaseHref();

  var abs = [];
  for(var i=0;i<questions.length;i++){
    try{ abs.push((new URL(questions[i].src, baseHref)).toString()); }
    catch(e){ abs.push(questions[i].src); }
  }

  var pages = [];
  for(var k=0;k<abs.length;k+=perPage) pages.push(abs.slice(k, k+perPage));

  var bodyHtml = "";
  for(var p=0;p<pages.length;p++){
    bodyHtml += '<div class="page" style="grid-template-columns:repeat(' + cols + ',1fr);grid-template-rows:repeat(' + rows + ',1fr);">';
    for(var j=0;j<pages[p].length;j++){
      bodyHtml += '<div class="cell"><img src="' + escapeAttr(pages[p][j]) + '" /></div>';
    }
    for(var e=pages[p].length;e<perPage;e++){
      bodyHtml += '<div class="cell empty"></div>';
    }
    bodyHtml += '</div><div class="page-break"></div>';
  }

  var html =
'<!DOCTYPE html><html><head><meta charset="UTF-8" />' +
'<title>DYAA Questions</title>' +
'<base href="' + escapeAttr(baseHref) + '">' +
'<style>' +
'@page{size:A4;margin:10mm;}html,body{margin:0;padding:0;}body{font-family:Arial,sans-serif;}' +
'.page{width:100%;height:calc(297mm - 20mm);display:grid;gap:6mm;box-sizing:border-box;}' +
'.cell{display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fff;}' +
'.cell img{width:auto;height:auto;max-width:100%;max-height:100%;display:block;}' +
'.cell.empty{border:none;}.page-break{page-break-after:always;}.page-break:last-child{display:none;}' +
'</style></head><body>' +
bodyHtml +
'<script>' +
'(function(){' +
'function waitImgs(){var imgs=[].slice.call(document.images||[]);if(!imgs.length) return Promise.resolve();' +
'return Promise.all(imgs.map(function(im){return new Promise(function(res){if(im.complete) return res();im.onload=res;im.onerror=res;});}));}' +
'window.onload = function(){waitImgs().then(function(){setTimeout(function(){try{window.focus();window.print();}catch(e){}},150);window.onafterprint=function(){try{window.close();}catch(e){}};});};' +
'})();' +
'<\/script></body></html>';

  var w = window.open("", "_blank");
  if(!w){
    alert("Popup blocked. Please allow popups and try again.");
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ===================== Start Screen + Auto Start ===================== */
function startQuizWithName(name){
  studentName = (name || "Student").trim() || "Student";
  studentLine.textContent = "Student: " + studentName;
  setInfo.textContent = "Set: 1";

  buildQuestions();
  renderSidebar();
  renderQuestion();

  pdfControls.style.display = "flex";
  pauseButton.style.display = "inline-block";
  restartButton.style.display = "inline-block";
  navButtons.style.display = "flex";
  saveButton.style.display = "none";

  pauseButton.textContent = "Pause";
  firstAttemptMs = null;
  startTimer();
}

function showStart(){
  sidebarEl.style.display = "none";
  navButtons.style.display = "none";
  pdfControls.style.display = "none";
  pauseButton.style.display = "none";
  restartButton.style.display = "none";

  studentLine.textContent = "";
  setInfo.textContent = "";
  bankInfo.innerHTML =
    'Put images next to this HTML: <code>q1.png</code>...<code>q' + CONFIG.TOTAL_QUESTIONS + '.png</code><br>' +
    'If images are in a subfolder, set <code>QUESTIONS_DIR</code> to <code>./questions/</code>';

  quizContent.innerHTML = "";

  var p = document.createElement("p");
  p.innerHTML = "<strong>Local PNG mode.</strong>";
  quizContent.appendChild(p);

  var wrap = document.createElement("div");
  wrap.style.marginTop = "14px";
  quizContent.appendChild(wrap);

  var label = document.createElement("div");
  label.textContent = "Student name:";
  label.style.marginBottom = "6px";
  wrap.appendChild(label);

  var input = document.createElement("input");
  input.id = "nameInput";
  input.type = "text";
  input.placeholder = "Student";
  input.value = urlName || "Student";
  input.style.cssText = "padding:10px;width:260px;font-size:1.05em;border:1px solid #ccc;border-radius:10px;";
  wrap.appendChild(input);

  var btn = document.createElement("button");
  btn.textContent = "Start";
  btn.style.cssText = "margin-left:10px;background:#4caf50;padding:10px 20px;color:white;border:none;border-radius:8px;";
  btn.onclick = function(){
    startQuizWithName(String(input.value||"Student"));
  };
  wrap.appendChild(btn);

  updateTimer();
}

/* ===================== Events ===================== */
backButton.onclick = function(){
  if(submitted) return;
  saveCurrentInput();
  if(currentIndex>0){ currentIndex--; renderQuestion(); }
};
nextButton.onclick = function(){
  if(submitted) return;
  saveCurrentInput();
  if(currentIndex<questions.length-1){ currentIndex++; renderQuestion(); }
};
checkButton.onclick = function(){ if(!submitted) doCheckCurrent(); };
submitButton.onclick = function(){ showResults(); };
saveButton.onclick = function(){ saveCurrentResultAsTxt(); };

pauseButton.onclick = function(){ togglePause(); };
restartButton.onclick = function(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  startTime = null; elapsedMs = 0; paused = false;
  submitted = false;

  AUTO_START_ON_LOAD = false;
  showStart();
};

exportQuestionsBtn.onclick = function(){ exportQuestionsToPdf(); };

/* ===================== Init ===================== */
showStart();

if(AUTO_START_ON_LOAD){
  AUTO_START_ON_LOAD = false;
  startQuizWithName(urlName);
}
</script>
</body>
</html>
