<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Decimal Review — Learn & Practice — DYAA</title>

  <style>
    :root{
      --blue:#0d47a1;
      --orange:#ff9800;
      --bg:#f4f4f9;
      --ink:#222;
      --muted:#666;
      --card:#fff;
      --line:#e6e6ef;
      --ok:#1b5e20;
      --bad:#b71c1c;
      --shadow:0 6px 15px rgba(0,0,0,0.10);
    }
    *{box-sizing:border-box;}
    body{
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      color:var(--ink);
    }
    body:before{
      content:"DYAA";
      position:fixed;
      inset:auto auto 8% -10%;
      font-size:180px;
      font-weight:900;
      letter-spacing:8px;
      color:rgba(13,71,161,0.06);
      transform:rotate(-12deg);
      pointer-events:none;
      z-index:0;
      user-select:none;
    }

    .container{
      position:relative;
      z-index:1;
      max-width:980px;
      margin:28px auto;
      background:#fff;
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:26px;
      border:1px solid var(--line);
    }

    #headerLogo{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:12px;
      border-bottom:2px solid #e0e0e0;
      padding-bottom:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px;}
    .logo-icon{
      width:44px;height:44px;background:var(--blue);
      border-radius:8px;position:relative;flex:0 0 auto;
    }
    .logo-icon:before{
      content:"";position:absolute;width:22px;height:9px;background:var(--orange);
      top:-6px;left:11px;border-radius:4px;
    }
    .logo-text{display:flex;flex-direction:column;line-height:1.1;}
    .logo-text b{font-size:1.12rem;color:var(--blue);letter-spacing:.2px;}
    .logo-text span{font-size:.92rem;color:var(--orange);font-weight:800;}
    .title-block{flex:1 1 260px;min-width:260px;}
    .title-block h1{margin:0;font-size:1.15rem;color:#111;letter-spacing:.2px;}
    .title-block p{margin:4px 0 0 0;color:var(--muted);font-size:.95rem;}

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin:14px 0 18px;
      flex-wrap:wrap;
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;}
    .tab-btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      color:#333;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .tab-btn.active{
      background:rgba(13,71,161,0.10);
      border-color:rgba(13,71,161,0.25);
      color:var(--blue);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex:1 1 360px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      min-width:240px;
      flex:1 1 240px;
    }
    .pill label{font-weight:800;color:#333;font-size:.95rem;white-space:nowrap;}
    .pill input{
      border:1px solid var(--line);
      border-radius:10px;
      padding:9px 10px;
      outline:none;
      width:100%;
      font-size:.95rem;
    }
    .student-name{font-weight:800;color:#111;}

    .btn{
      border:none;
      background:var(--blue);
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      box-shadow:0 4px 12px rgba(13,71,161,0.18);
      white-space:nowrap;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid var(--line);
      box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    .btn.orange{
      background:var(--orange);
      box-shadow:0 4px 12px rgba(255,152,0,0.18);
    }

    select{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }

    .section{display:none;margin-top:10px;}
    .section.active{display:block;}

    .grid{display:grid;grid-template-columns:1fr;gap:14px;}
    @media (min-width: 900px){
      .grid.two{grid-template-columns:1fr 1fr;}
    }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
    }
    .card h2{margin:0 0 8px 0;font-size:1.05rem;color:var(--blue);}
    .card p, .card li{color:#222;line-height:1.55;margin:6px 0;}
    .muted{color:var(--muted);}

    .mini-table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      margin-top:10px;
    }
    .mini-table th, .mini-table td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      text-align:left;
      font-size:.95rem;
      vertical-align:top;
    }
    .mini-table th{
      background:rgba(13,71,161,0.06);
      color:#111;
    }
    .mini-table tr:last-child td{border-bottom:none;}

    .practice-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .note{
      background:rgba(255,152,0,0.12);
      border:1px solid rgba(255,152,0,0.25);
      padding:10px 12px;
      border-radius:12px;
      color:#222;
      line-height:1.45;
      flex:1 1 420px;
    }
    .tiny{font-size:.9rem;color:var(--muted);}

    .part-title{
      margin:18px 0 10px 0;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(13,71,161,0.06);
      border:1px solid rgba(13,71,161,0.15);
      color:#111;
      font-weight:900;
    }

    .qCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
      margin:12px 0;
    }
    .qHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .qHeader .qTitle{
      font-weight:1000;
      color:var(--blue);
      font-size:1.05rem;
      letter-spacing:.3px;
    }
    .qChip{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      color:#111;
      font-size:.85rem;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }

    .qPrompt{line-height:1.5;color:#111;margin:6px 0 10px 0;}

    .answerRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin:8px 0 10px 0;
    }
    .answerRow .label{
      font-weight:900;
      color:#111;
      min-width:70px;
      padding-top:8px;
    }
    .answerRow input{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      outline:none;
      width:min(560px, 100%);
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:2px;
    }
    .btnSmall{
      border:none;
      background:var(--blue);
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      box-shadow:0 4px 12px rgba(13,71,161,0.18);
    }
    .btnSmall.hint,
    .btnSmall.reveal{
      background:#eef3ff;
      color:var(--blue);
      border:1px solid rgba(13,71,161,0.18);
      box-shadow:none;
    }

    .msgBox{
      margin-top:10px;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid var(--line);
      display:none;
    }
    .msgBox.show{display:block;}
    .msgBox .msgHead{font-weight:1000;margin-bottom:6px;}
    .msgBox .msgBody{line-height:1.5;color:#111;}
    .msgBox.solution{background:rgba(27,94,32,0.08);border-color:rgba(27,94,32,0.22);}
    .msgBox.hint{background:rgba(13,71,161,0.07);border-color:rgba(13,71,161,0.20);}
    .msgBox.wrong{background:rgba(183,28,28,0.07);border-color:rgba(183,28,28,0.22);}

    .footer-actions{
      margin-top:18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .score{font-weight:900;color:#111;}

    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:18px;
    }
    .modal-backdrop.show{display:flex;}
    .modal{
      background:#fff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
      max-width:520px;
      width:100%;
      padding:18px;
    }
    .modal h4{margin:0 0 8px 0;color:#111;font-size:1.05rem;}
    .modal p{margin:0 0 14px 0;color:#333;line-height:1.5;}
    .modal .row{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}

    .math{
      font-feature-settings:"tnum" 1;
      font-variant-numeric: tabular-nums;
    }
    .uline{
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 2px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="headerLogo">
      <div class="brand">
        <div class="logo-icon"></div>
        <div class="logo-text">
          <b>DYAA Education</b>
          <span>Mathematics</span>
        </div>
      </div>
      <div class="title-block">
        <h1>Decimal Review — Learn & Practice</h1>
        <p>Place Value • Add/Subtract • Multiply • Divide • Word Problems</p>
      </div>
    </div>

    <div class="topbar">
      <div class="tabs">
        <button class="tab-btn active" id="learnTab">Learn</button>
        <button class="tab-btn" id="practiceTab">Practice</button>
      </div>

      <div class="controls">
        <div class="pill" id="studentPill">
          <label>Student</label>
          <span id="studentDisplay" class="student-name" style="display:none;"></span>
          <input id="studentInput" type="text" placeholder="Enter student name" style="display:none;">
        </div>

        <select id="perPageSelect" title="Questions per page for Export to PDF">
          <option value="3">3 / page</option>
          <option value="4" selected>4 / page</option>
          <option value="6">6 / page</option>
          <option value="8">8 / page</option>
          <option value="9">9 / page</option>
        </select>

        <button class="btn secondary" id="exportBtn" title="Opens the print dialog (Save as PDF)">
          Export to PDF
        </button>
        <button class="btn orange" id="newSetBtn">Generate New Set</button>
      </div>
    </div>

    <!-- LEARN -->
    <div class="section active" id="learnSection">
      <div class="grid two">
        <div class="card">
          <h2>Decimal Place Value</h2>
          <ul>
            <li><b>Tenths</b> = 0.1, <b>Hundredths</b> = 0.01, <b>Thousandths</b> = 0.001</li>
            <li>Reading: <b>“point”</b> then read digits one by one (e.g. 8.502 = “eight point five zero two”).</li>
            <li>Rounding: look at the next digit → 5 or more round up.</li>
            <li>Comparing: line up decimal points, compare digits from left to right.</li>
          </ul>
        </div>

        <div class="card">
          <h2>Add & Subtract Decimals</h2>
          <ul>
            <li>Line up the <b>decimal points</b>.</li>
            <li>Add zeros if needed (e.g. 2.3 = 2.30).</li>
            <li>Keep the decimal point in the answer aligned.</li>
          </ul>
          <p class="tiny">Tip: Estimate first to check if your answer is reasonable.</p>
        </div>

        <div class="card">
          <h2>Multiply Decimals</h2>
          <ul>
            <li>× 10.0 / 100.0 / 1000.0 → move decimal <b>right</b> 1 / 2 / 3 places.</li>
            <li>× 0.1 / 0.01 / 0.001 → move decimal <b>left</b> 1 / 2 / 3 places.</li>
            <li>Decimal × Decimal: multiply as whole numbers, then place the decimal using total decimal places.</li>
            <li>Use distributive law: a(b + c) = ab + ac.</li>
          </ul>
        </div>

        <div class="card">
          <h2>Divide Decimals (Divisors are decimals)</h2>
          <ul>
            <li>÷ 10.0 / 100.0 / 1000.0 → move decimal <b>left</b> 1 / 2 / 3 places.</li>
            <li>÷ 0.1 / 0.01 / 0.001 → move decimal <b>right</b> 1 / 2 / 3 places.</li>
            <li>Decimal ÷ Decimal: <b>shift decimals</b> in both numbers to make the divisor a whole number.</li>
          </ul>

          <table class="mini-table">
            <thead>
              <tr><th>Type</th><th>Example</th><th>Rule</th></tr>
            </thead>
            <tbody>
              <tr><td>Decimal ÷ Power of 10</td><td class="math">0.46 ÷ 100.0 = 0.0046</td><td>Move decimal left</td></tr>
              <tr><td>Decimal ÷ Multiple of 10</td><td class="math">7.2 ÷ 20.0 = 0.36</td><td>Divide by digit, then move decimal</td></tr>
              <tr><td>Decimal ÷ Whole-number divisor (shown as decimal)</td><td class="math">8.4 ÷ 4.0 = 2.1</td><td>Divide normally and place decimal</td></tr>
              <tr><td>Decimal ÷ Decimal</td><td class="math">1.8 ÷ 0.3 = 6</td><td>Make divisor whole by shifting decimals</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PRACTICE -->
    <div class="section" id="practiceSection">
      <div class="practice-head">
        <div class="note">
          <b>Instructions:</b> Each question has <b>Check</b>, <b>Hint</b>, and <b>Reveal</b>.
          <div class="tiny">Export to PDF will put the <b>Answer Key on a new page at the end</b>.</div>
          <div class="tiny"><b>Multi-part answers:</b> type answers in order, separated by commas. Example: <span class="math">10.95, 3.07</span></div>
        </div>
      </div>

      <div id="practiceRoot"></div>

      <div class="footer-actions">
        <div class="score" id="scoreText">Score: —</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn secondary" id="resetBtn">Reset Answers</button>
          <button class="btn" id="submitBtn">Submit & View Result</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-backdrop" id="confirmBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h4>Generate a new set?</h4>
      <p>This will replace all current questions and clear your answers.</p>
      <div class="row">
        <button class="btn secondary" id="cancelNewSet">Cancel</button>
        <button class="btn orange" id="confirmNewSet">Yes, generate</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Student name (?name=Tiger)
     ***********************/
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function initStudent(){
      const n = getParam("name");
      const studentDisplay = document.getElementById("studentDisplay");
      const studentInput = document.getElementById("studentInput");
      if(n && n.trim()){
        studentDisplay.style.display = "inline";
        studentInput.style.display = "none";
        studentDisplay.textContent = n.trim();
      }else{
        studentDisplay.style.display = "none";
        studentInput.style.display = "inline";
        const saved = localStorage.getItem("dyaa_student_name") || "";
        studentInput.value = saved;
        studentInput.addEventListener("input", ()=>{
          localStorage.setItem("dyaa_student_name", studentInput.value.trim());
        });
      }
    }
    function getStudentName(){
      const n = getParam("name");
      if(n && n.trim()) return n.trim();
      const v = (document.getElementById("studentInput").value || "").trim();
      return v || "________";
    }

    /***********************
     * Exact decimal helpers (BigInt)
     ***********************/
    function pow10(n){
      if(n <= 0) return 1n;
      return BigInt("1" + "0".repeat(n));
    }
    function powBig(base, exp){
      let b = BigInt(base);
      let e = exp;
      let r = 1n;
      while(e > 0){
        if(e & 1) r *= b;
        b *= b;
        e >>= 1;
      }
      return r;
    }
    function gcdBig(a,b){
      a = a < 0n ? -a : a;
      b = b < 0n ? -b : b;
      while(b !== 0n){
        const t = a % b;
        a = b;
        b = t;
      }
      return a;
    }
    function parseDec(str){
      str = String(str).trim();
      if(!str) return null;
      str = str.replace(/,/g,"");
      if(str[0]==="+") str = str.slice(1);
      if(!/^-?\d+(\.\d+)?$/.test(str)) return null;

      const neg = str[0]==="-";
      if(neg) str = str.slice(1);

      const parts = str.split(".");
      const intPart = parts[0] || "0";
      const frac = parts[1] || "";
      const scale = frac.length;
      const bi = BigInt(intPart + frac);
      return { int: (neg ? -bi : bi), scale };
    }
    function bigToStr(x, scale){
      const neg = x < 0n;
      let v = neg ? -x : x;
      let s = v.toString();
      if(scale === 0) return (neg ? "-" : "") + s;
      if(s.length <= scale){
        s = "0".repeat(scale - s.length + 1) + s;
      }
      const idx = s.length - scale;
      let out = s.slice(0, idx) + "." + s.slice(idx);
      out = out.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");
      return (neg ? "-" : "") + out;
    }
    function bigToStrFixed(x, scale){
      const neg = x < 0n;
      let v = neg ? -x : x;
      let s = v.toString();
      if(scale === 0) return (neg ? "-" : "") + s;
      if(s.length <= scale){
        s = "0".repeat(scale - s.length + 1) + s;
      }
      const idx = s.length - scale;
      return (neg ? "-" : "") + (s.slice(0, idx) + "." + s.slice(idx));
    }
    function stripTrailingZerosDec(s){
      return String(s).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");
    }
    function toFixedDpStr(xStr, dp){
      const p = parseDec(xStr);
      if(!p) return null;
      if(p.scale === dp) return bigToStrFixed(p.int, p.scale);
      if(p.scale < dp){
        const mul = pow10(dp - p.scale);
        return bigToStrFixed(p.int * mul, dp);
      }
      const diff = p.scale - dp;
      const div = pow10(diff);
      const neg = p.int < 0n;
      let v = neg ? -p.int : p.int;
      const q = v / div;
      const outInt = neg ? -q : q;
      return bigToStrFixed(outInt, dp);
    }
    function addDecStr(aStr,bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      const s = Math.max(a.scale, b.scale);
      const ai = a.int * pow10(s - a.scale);
      const bi = b.int * pow10(s - b.scale);
      return bigToStr(ai + bi, s);
    }
    function subDecStr(aStr,bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      const s = Math.max(a.scale, b.scale);
      const ai = a.int * pow10(s - a.scale);
      const bi = b.int * pow10(s - b.scale);
      return bigToStr(ai - bi, s);
    }
    function mulDecStr(aStr,bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      const prodInt = a.int * b.int;
      const scale = a.scale + b.scale;
      return bigToStr(prodInt, scale);
    }
    function divDecStr(aStr, bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      if(!a || !b) return null;
      if(b.int === 0n) return null;

      let num = a.int * pow10(b.scale);
      let den = b.int * pow10(a.scale);
      if(den < 0n){ den = -den; num = -num; }

      const g = gcdBig(num, den);
      num /= g; den /= g;

      let d = den;
      let c2 = 0, c5 = 0;
      while(d % 2n === 0n){ d /= 2n; c2++; }
      while(d % 5n === 0n){ d /= 5n; c5++; }

      if(d !== 1n){
        const scale = 6;
        const scaled = num * pow10(scale);
        const q = scaled / den;
        return bigToStr(q, scale);
      }

      const scale = Math.max(c2, c5);
      const adj2 = scale - c2;
      const adj5 = scale - c5;
      const adj = powBig(2, adj2) * powBig(5, adj5);

      const outInt = num * adj;
      return bigToStr(outInt, scale);
    }

    function sanitizeNumberInput(raw){
      let s = String(raw || "").trim();
      if(!s) return "";
      s = s.replace(/\$/g,"");
      s = s.replace(/%/g,"");
      s = s.replace(/[a-zA-Z]/g,"");
      s = s.replace(/\s+/g,"");
      return s;
    }

    function extractNumberTokens(raw){
      const s = String(raw||"")
        .replace(/,/g,"")
        .replace(/\$/g,"")
        .replace(/%/g,"");
      const m = s.match(/-?\d+(?:\.\d+)?/g);
      return m || [];
    }

    function normalizeDec(raw){
      const cleaned = sanitizeNumberInput(raw);
      const p = parseDec(cleaned);
      if(!p) return null;
      return stripTrailingZerosDec(bigToStr(p.int, p.scale));
    }

    function normalizeToDp(raw, dp){
      const n = normalizeDec(raw);
      if(n === null) return null;
      return toFixedDpStr(n, dp);
    }

    /***********************
     * Random helpers
     ***********************/
    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function randDigits(len, allowAllZero=false){
      let s="";
      for(let i=0;i<len;i++) s += String(randInt(0,9));
      if(!allowAllZero && /^0+$/.test(s)) return randDigits(len, allowAllZero);
      return s;
    }
    function makeDecimalStr(intMin,intMax, dpOptions, allowAllZeroFrac=false){
      const intPart = randInt(intMin,intMax);
      const dp = randChoice(dpOptions);
      if(dp===0) return String(intPart);
      const frac = randDigits(dp, allowAllZeroFrac);
      return `${intPart}.${frac}`;
    }
    function asDotZero(n){ return `${n}.0`; } // ensures a decimal form

    function pickUnique(list, n){
      const arr = list.slice();
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr.slice(0, Math.min(n, arr.length));
    }

    /***********************
     * Words for decimals
     ***********************/
    const ONES = ["zero","one","two","three","four","five","six","seven","eight","nine"];
    const TEENS = ["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
    const TENS = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];

    function intToWords(n){
      n = Number(n);
      if(!Number.isFinite(n) || n < 0 || n > 9999) return String(n);
      if(n < 10) return ONES[n];
      if(n < 20) return TEENS[n - 10];
      if(n < 100){
        const t = Math.floor(n/10);
        const o = n%10;
        return o===0 ? TENS[t] : `${TENS[t]} ${ONES[o]}`;
      }
      if(n < 1000){
        const h = Math.floor(n/100);
        const r = n%100;
        return r===0 ? `${ONES[h]} hundred` : `${ONES[h]} hundred ${intToWords(r)}`;
      }
      const th = Math.floor(n/1000);
      const r = n%1000;
      return r===0 ? `${ONES[th]} thousand` : `${ONES[th]} thousand ${intToWords(r)}`;
    }

    function decimalToWordsPointStyle(decStr){
      let s = String(decStr).trim();
      if(s[0]==="+") s = s.slice(1);
      const neg = s[0]==="-";
      if(neg) s = s.slice(1);

      const parts = s.split(".");
      const iPart = parts[0] || "0";
      const fPart = parts[1] || "";
      const iWords = intToWords(parseInt(iPart,10));
      const digits = fPart.split("").map(d => ONES[Number(d)]).join(" ");
      const out = fPart.length ? `${iWords} point ${digits}` : `${iWords}`;
      return neg ? `negative ${out}` : out;
    }

    function normText(s){
      return String(s||"")
        .toLowerCase()
        .replace(/-/g," ")
        .replace(/[^\w\s.]/g," ")
        .replace(/\boh\b/g,"zero")
        .replace(/\s+/g," ")
        .trim();
    }

    /***********************
     * Question model
     ***********************/
    let QUESTIONS = [];
    const PARTS = [
      {part:1, title:"Part 1 — Decimal Place Value & Rounding"},
      {part:2, title:"Part 2 — Decimal Addition & Subtraction"},
      {part:3, title:"Part 3 — Decimal Multiplication"},
      {part:4, title:"Part 4 — Decimal Division (Divisors are decimals)"},
      {part:5, title:"Part 5 — Word Problems (One-step & Multi-step)"},
    ];
    function qId(){ return "q_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }

    function makeNumericQuestion({part, chip, promptHtml, answerStr, hintHtml, solutionHtml, answerKeyText, acceptMoney=false, dpStrict=null}){
      const ansNorm = stripTrailingZerosDec(answerStr);
      return {
        id:qId(),
        part,
        chip,
        promptHtml,
        answer: ansNorm,
        hintHtml,
        solutionHtml: solutionHtml || (()=>`Answer: <b>${ansNorm}</b>.`),
        validate:(raw)=>{
          const cleaned = sanitizeNumberInput(raw);
          const p = parseDec(cleaned);
          if(!p) return {ok:false, msg:"Please enter a number."};

          const gotNorm = stripTrailingZerosDec(bigToStr(p.int,p.scale));

          if(dpStrict !== null){
            const gotFixed = toFixedDpStr(gotNorm, dpStrict);
            const ansFixed = toFixedDpStr(ansNorm, dpStrict);
            if(gotFixed === ansFixed) return {ok:true};
            return {ok:false, msg:`Correct answer: ${stripTrailingZerosDec(ansFixed)}`};
          }

          if(gotNorm === ansNorm) return {ok:true};

          if(acceptMoney){
            const got2 = toFixedDpStr(gotNorm, 2);
            const ans2 = toFixedDpStr(ansNorm, 2);
            if(got2 === ans2) return {ok:true};
          }
          return {ok:false, msg:`Correct answer: ${ansNorm}`};
        },
        answerKeyText: answerKeyText || (()=>ansNorm),
        _checked:false,_isCorrect:false,_revealed:false,_value:"",
      };
    }

    function makeTextQuestion({part, chip, promptHtml, answerText, hintHtml, solutionHtml, answerKeyText, extraAccept=null}){
      const ans = String(answerText||"").trim();
      return {
        id:qId(),
        part,
        chip,
        promptHtml,
        answer: ans,
        hintHtml,
        solutionHtml: solutionHtml || (()=>`Answer: <b>${escapeHtml(ans)}</b>.`),
        validate:(raw)=>{
          const got = normText(raw);
          const target = normText(ans);
          if(extraAccept && extraAccept(got)) return {ok:true};
          if(got && got === target) return {ok:true};
          return {ok:false, msg:`Correct answer: ${ans}`};
        },
        answerKeyText: answerKeyText || (()=>ans),
        _checked:false,_isCorrect:false,_revealed:false,_value:"",
      };
    }

    // Multi-part numeric answers (comma separated)
    // specs: [{label:"Total ($)", value:"16.47", dp:2, prefix:"$", suffix:""}]
    function makeMultiNumericQuestion({part, chip, promptHtml, specs, hintHtml, solutionHtml}){
      const cleanSpecs = specs.map(s=>({
        label: s.label || "",
        value: stripTrailingZerosDec(String(s.value)),
        dp: (s.dp === undefined ? null : s.dp),
        prefix: s.prefix || "",
        suffix: s.suffix || ""
      }));

      function formatSpecValue(s){
        const v = (s.dp === null) ? stripTrailingZerosDec(s.value) : stripTrailingZerosDec(toFixedDpStr(s.value, s.dp));
        return `${s.prefix}${v}${s.suffix}`;
      }

      const keyText = cleanSpecs.map(s=>`${s.label ? (s.label + ": ") : ""}${formatSpecValue(s)}`).join(" | ");

      return {
        id:qId(),
        part,
        chip,
        promptHtml,
        answer: keyText,
        hintHtml,
        solutionHtml: solutionHtml || (()=>`Answer: <b>${escapeHtml(keyText)}</b>`),
        validate:(raw)=>{
          const tokens = extractNumberTokens(raw);
          if(tokens.length < cleanSpecs.length){
            return {ok:false, msg:`Enter ${cleanSpecs.length} answers (comma-separated).`};
          }
          for(let i=0;i<cleanSpecs.length;i++){
            const spec = cleanSpecs[i];
            const got = tokens[i];
            if(spec.dp !== null){
              const gotFixed = normalizeToDp(got, spec.dp);
              const expFixed = toFixedDpStr(spec.value, spec.dp);
              if(!gotFixed || gotFixed !== expFixed){
                return {ok:false, msg:`Correct: ${keyText}`};
              }
            }else{
              const g = normalizeDec(got);
              const e = stripTrailingZerosDec(spec.value);
              if(!g || g !== e){
                return {ok:false, msg:`Correct: ${keyText}`};
              }
            }
          }
          return {ok:true};
        },
        answerKeyText: ()=>keyText,
        _checked:false,_isCorrect:false,_revealed:false,_value:"",
      };
    }

    /***********************
     * Generators (25 questions total: 5 per part)
     ***********************/

    // Part 1
    function buildUnderlineDigitQuestion(){
      const ip = randInt(1,9);
      const tenths = randInt(0,9);
      const hundredths = randInt(0,9);
      const thousandths = randInt(0,9);

      const positions = [
        {key:"ones", label:"ones", value: String(ip)},
        {key:"tenths", label:"tenths", value: stripTrailingZerosDec(`${tenths/10}`)},
        {key:"hundredths", label:"hundredths", value: stripTrailingZerosDec(`${hundredths/100}`)},
        {key:"thousandths", label:"thousandths", value: stripTrailingZerosDec(`${thousandths/1000}`)}
      ];
      const pick = randChoice(positions);

      let display = `${ip}.${tenths}${hundredths}${thousandths}`;
      if(pick.key === "ones"){
        display = `<span class="uline">${ip}</span>.${tenths}${hundredths}${thousandths}`;
      }else if(pick.key === "tenths"){
        display = `${ip}.<span class="uline">${tenths}</span>${hundredths}${thousandths}`;
      }else if(pick.key === "hundredths"){
        display = `${ip}.${tenths}<span class="uline">${hundredths}</span>${thousandths}`;
      }else{
        display = `${ip}.${tenths}${hundredths}<span class="uline">${thousandths}</span>`;
      }

      return makeNumericQuestion({
        part:1,
        chip:"Place value",
        promptHtml:`What is the value of the underlined digit in <span class="math">${display}</span>?`,
        answerStr: pick.value,
        hintHtml:`Identify the place (ones, tenths, hundredths, thousandths), then write the digit's value.`,
        solutionHtml: ()=>`The underlined digit is in the <b>${pick.label}</b> place.<br/>So the value is <b>${pick.value}</b>.`,
        answerKeyText: ()=>pick.value
      });
    }

    function buildRoundQuestion(){
      const n = makeDecimalStr(1, 20, [2,3], true);
      const place = randChoice(["tenth","hundredth"]);
      const dp = (place==="tenth") ? 1 : 2;

      const p = parseDec(n);
      const curScale = p.scale;

      let outStr;
      if(curScale < dp){
        outStr = bigToStr(p.int * pow10(dp - curScale), dp);
      }else if(curScale === dp){
        outStr = bigToStr(p.int, dp);
      }else{
        const diff = curScale - dp;
        const factor = pow10(diff);
        const neg = p.int < 0n;
        let v = neg ? -p.int : p.int;

        const q = v / factor;
        const r = v % factor;
        const nextDigit = Number((r / pow10(diff-1)) % 10n);
        let rounded = q;
        if(nextDigit >= 5) rounded = q + 1n;

        const outInt = neg ? -rounded : rounded;
        outStr = bigToStr(outInt, dp);
      }

      return makeNumericQuestion({
        part:1,
        chip:"Rounding",
        promptHtml:`Round <span class="math">${n}</span> to the nearest <b>${place}</b>.`,
        answerStr: outStr,
        hintHtml:`Check the digit right after the ${place}. If it's 5–9, round up.`,
        solutionHtml: ()=>`Nearest ${place}: <b>${stripTrailingZerosDec(outStr)}</b>.`,
        answerKeyText: ()=>stripTrailingZerosDec(outStr)
      });
    }

    function buildCompareQuestion(){
      const a = makeDecimalStr(1, 9, [2,3], true);
      let b = makeDecimalStr(1, 9, [2,3], true);
      while(b === a) b = makeDecimalStr(1, 9, [2,3], true);

      const pa = parseDec(a), pb = parseDec(b);
      const s = Math.max(pa.scale, pb.scale);
      const ai = pa.int * pow10(s - pa.scale);
      const bi = pb.int * pow10(s - pb.scale);
      const greater = (ai > bi) ? a : b;

      return makeNumericQuestion({
        part:1,
        chip:"Comparing",
        promptHtml:`Which number is greater: <span class="math">${a}</span> or <span class="math">${b}</span>? <span class="tiny">(Type the greater number)</span>`,
        answerStr: greater,
        hintHtml:`Line up decimal points and compare digits from left to right.`,
        solutionHtml: ()=>`Compare digit by digit. The greater number is <b>${greater}</b>.`,
        answerKeyText: ()=>greater
      });
    }

    function buildOrderQuestion(){
      const nums = new Set();
      while(nums.size < 4){
        nums.add(makeDecimalStr(1, 2, [2,3], true));
      }
      const list = Array.from(nums);

      const parsed = list.map(x=>{
        const p = parseDec(x);
        return {x, p};
      });
      const maxS = Math.max(...parsed.map(o=>o.p.scale));
      parsed.forEach(o=>{
        o.k = o.p.int * pow10(maxS - o.p.scale);
      });
      parsed.sort((u,v)=> (u.k < v.k ? -1 : u.k > v.k ? 1 : 0));
      const sorted = parsed.map(o=>o.x);

      const ans = sorted.join(", ");

      return makeTextQuestion({
        part:1,
        chip:"Ordering",
        promptHtml:`Arrange the numbers from smallest to largest:<br/><span class="math">${list.join(", ")}</span><br/><span class="tiny">(Type like: 1.23, 1.45, 1.67, 1.89)</span>`,
        answerText: ans,
        hintHtml:`Compare place values from left to right.`,
        solutionHtml: ()=>`Sorted order: <b>${escapeHtml(ans)}</b>.`,
        answerKeyText: ()=>ans,
        extraAccept:(gotNorm)=>{
          const gotNums = gotNorm.replace(/and/g," ").split(/[\s,]+/).filter(Boolean);
          const targetNums = normText(ans).split(/[\s,]+/).filter(Boolean);
          if(gotNums.length !== 4) return false;
          return gotNums.join(",") === targetNums.join(",");
        }
      });
    }

    function buildWordsQuestion(){
      const ip = randInt(0, 99);
      const dp = randChoice([1,2,3]);
      const frac = randDigits(dp, true);
      const num = `${ip}.${frac}`;
      const words = decimalToWordsPointStyle(num);

      return makeTextQuestion({
        part:1,
        chip:"Read decimals",
        promptHtml:`Write <span class="math">${num}</span> in words.`,
        answerText: words,
        hintHtml:`Say the whole number part, then say “point”, then read each digit.`,
        solutionHtml: ()=>`<span class="math">${num}</span> in words is: <b>${escapeHtml(words)}</b>.`,
        answerKeyText: ()=>words,
        extraAccept:(gotNorm)=>{
          const p = parseDec(gotNorm);
          if(!p) return false;
          const got = stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got === stripTrailingZerosDec(num);
        }
      });
    }

    function buildPart1(){
      return [
        buildWordsQuestion(),
        buildUnderlineDigitQuestion(),
        buildCompareQuestion(),
        buildRoundQuestion(),
        buildOrderQuestion(),
      ];
    }

    // Part 2
    function buildPart2(){
      const out = [];

      for(let i=0;i<2;i++){
        const a = makeDecimalStr(0, 20, [1,2,3], true);
        const b = makeDecimalStr(0, 20, [1,2,3], true);
        const ans = addDecStr(a,b);
        out.push(makeNumericQuestion({
          part:2, chip:"Addition",
          promptHtml:`<span class="math">${a} + ${b} =</span>`,
          answerStr: ans,
          hintHtml:`Line up decimal points. Add zeros if needed.`,
          solutionHtml: ()=>`Align decimals: ${a} + ${b} = <b>${stripTrailingZerosDec(ans)}</b>.`,
          answerKeyText: ()=>stripTrailingZerosDec(ans)
        }));
      }

      for(let i=0;i<2;i++){
        let a = makeDecimalStr(5, 30, [1,2,3], true);
        let b = makeDecimalStr(0, 20, [1,2,3], true);
        const pa=parseDec(a), pb=parseDec(b);
        const s=Math.max(pa.scale,pb.scale);
        const ai=pa.int*pow10(s-pa.scale), bi=pb.int*pow10(s-pb.scale);
        if(bi > ai){ const tmp=a; a=b; b=tmp; }
        const ans = subDecStr(a,b);

        out.push(makeNumericQuestion({
          part:2, chip:"Subtraction",
          promptHtml:`<span class="math">${a} - ${b} =</span>`,
          answerStr: ans,
          hintHtml:`Line up decimal points, then subtract.`,
          solutionHtml: ()=>`${a} - ${b} = <b>${stripTrailingZerosDec(ans)}</b>.`,
          answerKeyText: ()=>stripTrailingZerosDec(ans)
        }));
      }

      {
        const a = makeDecimalStr(0, 9, [2,3], true);
        const b = makeDecimalStr(0, 9, [2,3], true);
        const sum = addDecStr(a,b);

        const p = parseDec(sum);
        const curScale = p.scale;
        let outStr;
        if(curScale <= 1){
          outStr = bigToStr(p.int * pow10(1-curScale), 1);
        }else{
          const diff = curScale - 1;
          const factor = pow10(diff);
          let v = p.int < 0n ? -p.int : p.int;
          const q = v / factor;
          const r = v % factor;
          const nextDigit = Number((r / pow10(diff-1)) % 10n);
          let rounded = q;
          if(nextDigit >= 5) rounded = q + 1n;
          const outInt = p.int < 0n ? -rounded : rounded;
          outStr = bigToStr(outInt, 1);
        }

        out.push(makeNumericQuestion({
          part:2, chip:"Add then round",
          promptHtml:`Add <span class="math">${a}</span> and <span class="math">${b}</span>, then round your answer to <b>1 decimal place</b>.`,
          answerStr: outStr,
          hintHtml:`Step 1: add. Step 2: round to 1 dp.`,
          solutionHtml: ()=>`Sum = ${stripTrailingZerosDec(sum)}. Rounded to 1 dp = <b>${stripTrailingZerosDec(outStr)}</b>.`,
          answerKeyText: ()=>stripTrailingZerosDec(outStr)
        }));
      }

      return out;
    }

    // Part 3
    function buildPart3(){
      const out = [];
      const powMult = ["10.0","100.0","1000.0","0.1","0.01","0.001"];

      for(let i=0;i<2;i++){
        const a = makeDecimalStr(0, 20, [1,2,3], true);
        const m = randChoice(powMult);
        const ans = mulDecStr(a, m);
        const dir = (m==="10.0"||m==="100.0"||m==="1000.0") ? "right" : "left";
        const places = (m==="10.0"||m==="0.1")?1:(m==="100.0"||m==="0.01")?2:3;

        out.push(makeNumericQuestion({
          part:3, chip:"× Powers of 10",
          promptHtml:`<span class="math">${a} × ${m} =</span>`,
          answerStr: ans,
          hintHtml:`Move the decimal ${places} place(s) to the <b>${dir}</b>.`,
          solutionHtml: ()=>`${a} × ${m} = <b>${stripTrailingZerosDec(ans)}</b>.`,
          answerKeyText: ()=>stripTrailingZerosDec(ans)
        }));
      }

      for(let i=0;i<2;i++){
        const a = makeDecimalStr(0, 9, [1,2], true);
        const b = makeDecimalStr(0, 9, [1,2], true);
        const ans = mulDecStr(a,b);

        out.push(makeNumericQuestion({
          part:3, chip:"Decimal × Decimal",
          promptHtml:`<span class="math">${a} × ${b} =</span>`,
          answerStr: ans,
          hintHtml:`Multiply as whole numbers, then place the decimal using total decimal places.`,
          solutionHtml: ()=>`${a} × ${b} = <b>${stripTrailingZerosDec(ans)}</b>.`,
          answerKeyText: ()=>stripTrailingZerosDec(ans)
        }));
      }

      {
        const a = makeDecimalStr(1, 9, [1], true);
        const b = makeDecimalStr(1, 9, [1], true);
        const c = makeDecimalStr(1, 9, [1], true);
        const bc = addDecStr(b,c);
        const ans = mulDecStr(a, bc);
        const ab = mulDecStr(a,b);
        const ac = mulDecStr(a,c);
        const check = addDecStr(ab,ac);

        out.push(makeNumericQuestion({
          part:3,
          chip:"Distributive law",
          promptHtml:`Use distributive law: <span class="math">${a} × (${b} + ${c}) =</span>`,
          answerStr: ans,
          hintHtml:`Compute (${b} + ${c}) first, or do ${a}×${b} + ${a}×${c}.`,
          solutionHtml: ()=>`(${b}+${c}) = ${stripTrailingZerosDec(bc)}.<br/>` +
                           `${a}×${stripTrailingZerosDec(bc)} = <b>${stripTrailingZerosDec(ans)}</b>.<br/>` +
                           `Check: ${a}×${b} + ${a}×${c} = ${stripTrailingZerosDec(ab)} + ${stripTrailingZerosDec(ac)} = ${stripTrailingZerosDec(check)}.`,
          answerKeyText: ()=>stripTrailingZerosDec(ans)
        }));
      }

      return out;
    }

    // Part 4 (divisors must be decimals)
    function buildPart4(){
      const out = [];

      const powDiv = ["10.0","100.0","1000.0","0.1","0.01","0.001"];
      for(let i=0;i<2;i++){
        const a = makeDecimalStr(0, 50, [1,2,3], true);
        const d = randChoice(powDiv);
        const ans = divDecStr(a, d);
        const dir = (d==="10.0"||d==="100.0"||d==="1000.0") ? "left" : "right";
        const places = (d==="10.0"||d==="0.1")?1:(d==="100.0"||d==="0.01")?2:3;

        out.push(makeNumericQuestion({
          part:4, chip:"÷ Powers of 10",
          promptHtml:`<span class="math">${a} ÷ ${d} =</span>`,
          answerStr: ans,
          hintHtml:`Dividing by ${d} moves the decimal ${places} place(s) to the <b>${dir}</b>.`,
          solutionHtml: ()=>`${a} ÷ ${d} = <b>${stripTrailingZerosDec(ans)}</b>.`,
          answerKeyText: ()=>stripTrailingZerosDec(ans)
        }));
      }

      const divisors = ["0.2","0.3","0.4","0.5","0.6","0.8","0.9","0.04","0.12","0.15","2.5","3.2","1.6","4.8","3.0","6.0","9.0","12.0"];
      const quotPool = ["0.6","0.8","1.2","1.5","1.6","1.8","2.4","2.5","3.2","3.6","4.8","5.4","6.0","7.5","8.0","9.6","10.5","12.0"];

      for(let i=0;i<2;i++){
        const d = randChoice(divisors);
        const q = randChoice(quotPool);
        const a = mulDecStr(q, d);

        out.push(makeNumericQuestion({
          part:4,
          chip:"Decimal ÷ Decimal",
          promptHtml:`<span class="math">${stripTrailingZerosDec(a)} ÷ ${d} =</span>`,
          answerStr: q,
          hintHtml:`Shift decimals in BOTH numbers to make the divisor a whole number, then divide.`,
          solutionHtml: ()=>{
            const dp = (d.split(".")[1]||"").length;
            const factor = dp === 0 ? "1.0" : ("1" + "0".repeat(dp) + ".0");
            const a2 = mulDecStr(stripTrailingZerosDec(a), factor);
            const d2 = mulDecStr(d, factor);
            return `Multiply both numbers by <b>${factor}</b> to make the divisor whole:<br/>` +
                   `${stripTrailingZerosDec(a)} ÷ ${d} = ${stripTrailingZerosDec(a2)} ÷ ${stripTrailingZerosDec(d2)} = <b>${stripTrailingZerosDec(q)}</b>.`;
          },
          answerKeyText: ()=>stripTrailingZerosDec(q)
        }));
      }

      {
        const divisorInt = randChoice([3,4,5,6,8,9,10,12]);
        const d = asDotZero(divisorInt);
        const q = randChoice(quotPool);
        const a = mulDecStr(q, String(divisorInt));

        out.push(makeNumericQuestion({
          part:4,
          chip:"÷ (shown as decimal)",
          promptHtml:`<span class="math">${stripTrailingZerosDec(a)} ÷ ${d} =</span>`,
          answerStr: q,
          hintHtml:`${d} means divide by ${divisorInt}.`,
          solutionHtml: ()=>`${stripTrailingZerosDec(a)} ÷ ${d} = ${stripTrailingZerosDec(a)} ÷ ${divisorInt} = <b>${stripTrailingZerosDec(q)}</b>.`,
          answerKeyText: ()=>stripTrailingZerosDec(q)
        }));
      }

      return out;
    }

    // Part 5 — Word Problems bank (UPDATED: added your screenshots into the pool)
    function buildPart5(){
      const oneStep = [];
      const multiStep = [];

      // --- Existing (from previous version) ---
      oneStep.push(()=>{ // cost per item
        const items = randChoice([6,8,10,12]);
        const priceEach = randChoice(["2.40","3.25","4.50","1.80","2.85"]);
        const total = mulDecStr(priceEach, asDotZero(items));
        const total2 = toFixedDpStr(total,2);
        const ans = toFixedDpStr(priceEach,2);

        return makeNumericQuestion({
          part:5, chip:"1-step ($)",
          promptHtml:`A pack costs <b>$${total2}</b> for <b>${items}</b> equal items. What is the cost per item?`,
          answerStr: ans,
          hintHtml:`Cost per item = total cost ÷ number of items.`,
          solutionHtml: ()=>`$${total2} ÷ ${asDotZero(items)} = <b>$${ans}</b> per item.`,
          answerKeyText: ()=>`$${ans}`,
          acceptMoney:true
        });
      });

      oneStep.push(()=>{ // tap rate
        const rate = randChoice(["1.2","1.5","2.4","2.8"]);
        const mins = randChoice([4,6,8,10]);
        const ans = mulDecStr(rate, asDotZero(mins));
        return makeNumericQuestion({
          part:5, chip:"1-step",
          promptHtml:`A tap pours <b>${rate} L</b> per minute. How much water is poured in <b>${mins}</b> minutes?`,
          answerStr: ans,
          hintHtml:`Amount = rate × time.`,
          solutionHtml: ()=>`${rate} × ${asDotZero(mins)} = <b>${stripTrailingZerosDec(ans)}</b> L.`,
          answerKeyText: ()=>`${stripTrailingZerosDec(ans)} L`
        });
      });

      oneStep.push(()=>{ // remaining bottle
        const total = makeDecimalStr(5, 20, [1,2], true);
        const used = makeDecimalStr(1, 10, [1,2], true);
        const left = subDecStr(total, used);
        return makeNumericQuestion({
          part:5, chip:"1-step",
          promptHtml:`A bottle holds <b>${total} L</b>. If <b>${used} L</b> is used, how much is left?`,
          answerStr: left,
          hintHtml:`Left = total − used.`,
          solutionHtml: ()=>`${total} − ${used} = <b>${stripTrailingZerosDec(left)}</b> L.`,
          answerKeyText: ()=>`${stripTrailingZerosDec(left)} L`
        });
      });

      multiStep.push(()=>{ // books + pens, discount
        const a = randChoice(["8.60","12.75","5.40","9.25"]);
        const b = randChoice(["2.45","3.15","1.80","4.50"]);
        const qa = randChoice([2,3,4]);
        const qb = randChoice([3,5,6]);
        const subA = mulDecStr(a, asDotZero(qa));
        const subB = mulDecStr(b, asDotZero(qb));
        const total = addDecStr(subA, subB);
        const disc = randChoice(["0.10","0.15","0.20"]);
        const discAmt = mulDecStr(total, disc);
        const pay = subDecStr(total, discAmt);
        const pay2 = toFixedDpStr(pay,2);

        return makeNumericQuestion({
          part:5, chip:"2-step ($)",
          promptHtml:`Emma buys <b>${qa}</b> books for <b>$${a}</b> each and <b>${qb}</b> pens for <b>$${b}</b> each. The shop gives <b>${stripTrailingZerosDec(mulDecStr(disc,"100.0"))}%</b> off the total. How much does she pay?`,
          answerStr: pay2,
          hintHtml:`Total = books + pens. Discount = total × rate. Pay = total − discount.`,
          solutionHtml: ()=>{
            const total2 = toFixedDpStr(total,2);
            const disc2 = toFixedDpStr(discAmt,2);
            return `Books: ${qa} × $${a} = $${toFixedDpStr(subA,2)}<br/>` +
                   `Pens: ${qb} × $${b} = $${toFixedDpStr(subB,2)}<br/>` +
                   `Total = $${total2}<br/>` +
                   `Discount = $${total2} × ${disc} = $${disc2}<br/>` +
                   `Pay = $${total2} − $${disc2} = <b>$${pay2}</b>.`;
          },
          answerKeyText: ()=>`$${pay2}`,
          acceptMoney:true
        });
      });

      multiStep.push(()=>{ // km per litre then cost
        const litres = randChoice([8,10,12]);
        const km = randChoice([96,120,144,180]);
        const perL = divDecStr(asDotZero(km), asDotZero(litres));
        const price = randChoice(["2.75","2.85","3.10"]);
        const cost = mulDecStr(perL, price);
        const cost2 = toFixedDpStr(cost,2);

        return makeNumericQuestion({
          part:5, chip:"2-step",
          promptHtml:`A car travels <b>${km} km</b> using <b>${litres} L</b> of petrol. <br/>1) Find km per litre. 2) If petrol costs <b>$${price}</b> per litre, what is the cost for <b>1 litre</b> worth of travel? <span class="tiny">(Enter the cost)</span>`,
          answerStr: cost2,
          hintHtml:`Step 1: km/L = km ÷ L. Step 2: cost = (km/L) × price.`,
          solutionHtml: ()=>{
            const perL2 = stripTrailingZerosDec(perL);
            return `km per litre: ${asDotZero(km)} ÷ ${asDotZero(litres)} = <b>${perL2}</b> km/L.<br/>` +
                   `Cost: ${perL2} × $${price} = <b>$${cost2}</b>.`;
          },
          answerKeyText: ()=>`$${cost2}`,
          acceptMoney:true
        });
      });

      // --- NEW: From your screenshots (added into the bank) ---

      multiStep.push(()=>{ // pens + notebooks
        const ans = "10.95";
        return makeNumericQuestion({
          part:5, chip:"Multi-step ($)",
          promptHtml:`A shop sells pens for <b>$1.25</b> each and notebooks for <b>$3.60</b> each. If Jenny buys <b>3</b> pens and <b>2</b> notebooks, how much does she spend in total?`,
          answerStr: ans,
          hintHtml:`Total = (3 × 1.25) + (2 × 3.60).`,
          solutionHtml: ()=>`Pens: 3 × 1.25 = 3.75<br/>Notebooks: 2 × 3.60 = 7.20<br/>Total = 3.75 + 7.20 = <b>$10.95</b>.`,
          answerKeyText: ()=>`$10.95`,
          acceptMoney:true
        });
      });

      multiStep.push(()=>{ // tank loses each day
        const ans = "75.5";
        return makeNumericQuestion({
          part:5, chip:"Multi-step",
          promptHtml:`A tank holds <b>85.5 L</b> of water. It loses <b>2.5 L</b> each day for <b>4</b> days. How much water remains after 4 days?`,
          answerStr: ans,
          hintHtml:`Total loss = 2.5 × 4, then subtract from 85.5.`,
          solutionHtml: ()=>`Loss = 2.5 × 4 = 10.0 L<br/>Remaining = 85.5 − 10.0 = <b>75.5</b> L.`,
          answerKeyText: ()=>`75.5 L`
        });
      });

      multiStep.push(()=>{ // running total + average (rounded)
        return makeMultiNumericQuestion({
          part:5, chip:"Multi-step",
          promptHtml:`Sam runs <b>3.2 km</b> each day for <b>5</b> days, then <b>2.4 km</b> on the 6th day. <br/><b>Find:</b> (1) total distance, (2) average distance per day <b>(to 2 decimal places)</b>.<br/><span class="tiny">Type: total, average</span>`,
          specs:[
            {label:"Total (km)", value:"18.4", dp:null, prefix:"", suffix:""},
            {label:"Average (km/day)", value:"3.07", dp:2, prefix:"", suffix:""}
          ],
          hintHtml:`Total = 3.2×5 + 2.4. Average = total ÷ 6 (round to 2 dp).`,
          solutionHtml: ()=>`Total = 3.2×5 + 2.4 = 16.0 + 2.4 = <b>18.4</b> km.<br/>Average = 18.4 ÷ 6 = 3.0666... ≈ <b>3.07</b> km/day.`
        });
      });

      multiStep.push(()=>{ // rectangle bonus challenge (multi answers)
        return makeMultiNumericQuestion({
          part:5, chip:"Bonus Challenge",
          promptHtml:`A rectangle has a length of <b>5.6 cm</b> and a width of <b>3.75 cm</b>.<br/>
            Find: (1) area, (2) perimeter.<br/>
            Then, if each side is increased by <b>0.25 cm</b>, find: (3) new area, (4) increase in area.<br/>
            <span class="tiny">Type: area, perimeter, new area, increase</span>`,
          specs:[
            {label:"Area (cm²)", value:"21", dp:null},
            {label:"Perimeter (cm)", value:"18.7", dp:null},
            {label:"New area (cm²)", value:"23.4", dp:null},
            {label:"Increase (cm²)", value:"2.4", dp:null}
          ],
          hintHtml:`Area = L×W. Perimeter = 2(L+W). New sides: 5.85 and 4.00.`,
          solutionHtml: ()=>`Area = 5.6×3.75 = <b>21</b> cm²<br/>Perimeter = 2(5.6+3.75)=2×9.35=<b>18.7</b> cm<br/>New area = 5.85×4.00 = <b>23.4</b> cm²<br/>Increase = 23.4 − 21 = <b>2.4</b> cm²`
        });
      });

      multiStep.push(()=>{ // sandwich + drink with 10% discount
        const pay = "16.47";
        return makeNumericQuestion({
          part:5, chip:"Multi-step ($)",
          promptHtml:`A sandwich costs <b>$4.20</b> and a drink costs <b>$2.85</b>. Jamie buys <b>3</b> sandwiches and <b>2</b> drinks. A <b>10%</b> discount is applied to the total. How much does Jamie pay?`,
          answerStr: pay,
          hintHtml:`Total = (3×4.20) + (2×2.85). Discount = 10% of total. Pay = total − discount.`,
          solutionHtml: ()=>`Total = 12.60 + 5.70 = 18.30<br/>Discount = 10% of 18.30 = 1.83<br/>Pay = 18.30 − 1.83 = <b>$16.47</b>.`,
          answerKeyText: ()=>`$16.47`,
          acceptMoney:true,
          dpStrict:2
        });
      });

      multiStep.push(()=>{ // tank gains then used
        const ans = "132.15";
        return makeNumericQuestion({
          part:5, chip:"Multi-step",
          promptHtml:`A tank contains <b>120.5 L</b> of water. It gains <b>8.75 L</b> per day for <b>3</b> days, then <b>14.6 L</b> is used. How much water is in the tank at the end?`,
          answerStr: ans,
          hintHtml:`Add the gained water first, then subtract 14.6.`,
          solutionHtml: ()=>`Gain = 8.75×3 = 26.25<br/>After gain: 120.5 + 26.25 = 146.75<br/>After use: 146.75 − 14.6 = <b>132.15</b> L.`,
          answerKeyText: ()=>`132.15 L`
        });
      });

      multiStep.push(()=>{ // ticket sales commission (percentage INCLUDED)
        const price = "1.50";
        const sat = 28, sun = 35;
        const rate = randChoice(["0.20","0.25","0.30","0.40"]); // 20%,25%,30%,40%
        const totalTickets = sat + sun;
        const sales = mulDecStr(price, asDotZero(totalTickets)); // 1.50 * 63 = 94.50
        const earn = mulDecStr(sales, rate);
        const earn2 = toFixedDpStr(earn,2);

        return makeNumericQuestion({
          part:5, chip:"Multi-step ($)",
          promptHtml:`Tickets cost <b>$${price}</b> each. Mia sells <b>${sat}</b> tickets on Saturday and <b>${sun}</b> on Sunday. She earns <b>${stripTrailingZerosDec(mulDecStr(rate,"100.0"))}%</b> of the total sales. How much does she earn?`,
          answerStr: earn2,
          hintHtml:`Total sales = (tickets sold) × $1.50, then multiply by the commission rate.`,
          solutionHtml: ()=>{
            const sales2 = toFixedDpStr(sales,2);
            return `Tickets sold = ${sat}+${sun} = ${totalTickets}<br/>Sales = ${totalTickets}×$${price} = $${sales2}<br/>Earnings = ${stripTrailingZerosDec(mulDecStr(rate,"100.0"))}% of $${sales2} = <b>$${earn2}</b>.`;
          },
          answerKeyText: ()=>`$${earn2}`,
          acceptMoney:true,
          dpStrict:2
        });
      });

      multiStep.push(()=>{ // garden path bonus
        return makeMultiNumericQuestion({
          part:5, chip:"Bonus Challenge",
          promptHtml:`A rectangular garden measures <b>7.2 m</b> by <b>4.8 m</b>. A uniform path of <b>0.5 m</b> wide runs all around the inside edge of the garden.<br/>
            Find: (1) the area of the path, (2) the percentage of the garden’s area that the path occupies <b>(to 1 decimal place)</b>.<br/>
            <span class="tiny">Type: path area, percentage</span>`,
          specs:[
            {label:"Path area (m²)", value:"11", dp:null},
            {label:"Percentage (%)", value:"31.8", dp:1}
          ],
          hintHtml:`Outer area − inner area. Inner size: (7.2−1.0) by (4.8−1.0).`,
          solutionHtml: ()=>`Outer area = 7.2×4.8 = 34.56<br/>Inner area = 6.2×3.8 = 23.56<br/>Path area = 34.56 − 23.56 = <b>11</b> m²<br/>Percentage = 11 ÷ 34.56 × 100 ≈ <b>31.8%</b> (1 dp)`
        });
      });

      multiStep.push(()=>{ // cinema tickets + drinks
        return makeNumericQuestion({
          part:5, chip:"Multi-step ($)",
          promptHtml:`A cinema ticket costs <b>$12.80</b> and a drink costs <b>$3.45</b>. Emma buys <b>2</b> tickets and <b>3</b> drinks. How much does she spend in total?`,
          answerStr:"35.95",
          hintHtml:`Total = 2×12.80 + 3×3.45.`,
          solutionHtml: ()=>`Tickets: 2×12.80 = 25.60<br/>Drinks: 3×3.45 = 10.35<br/>Total = 25.60 + 10.35 = <b>$35.95</b>.`,
          answerKeyText: ()=>`$35.95`,
          acceptMoney:true,
          dpStrict:2
        });
      });

      multiStep.push(()=>{ // container poured out each day
        return makeNumericQuestion({
          part:5, chip:"Multi-step",
          promptHtml:`A container holds <b>58.6 L</b> of juice. <b>4.5 L</b> are poured out each day for <b>5</b> days. How much juice remains?`,
          answerStr:"36.1",
          hintHtml:`Total poured out = 4.5×5. Remaining = 58.6 − total.`,
          solutionHtml: ()=>`Poured out = 4.5×5 = 22.5<br/>Remaining = 58.6 − 22.5 = <b>36.1</b> L.`,
          answerKeyText: ()=>`36.1 L`
        });
      });

      multiStep.push(()=>{ // baker total income
        return makeNumericQuestion({
          part:5, chip:"Multi-step ($)",
          promptHtml:`A baker uses <b>1.25 kg</b> of flour for each batch of bread. If he makes <b>6</b> batches and each batch sells for <b>$9.50</b>, what is his total income?`,
          answerStr:"57.00",
          hintHtml:`Income = number of batches × price per batch.`,
          solutionHtml: ()=>`Income = 6×$9.50 = <b>$57.00</b>.`,
          answerKeyText: ()=>`$57.00`,
          acceptMoney:true,
          dpStrict:2
        });
      });

      multiStep.push(()=>{ // plumber hours
        return makeNumericQuestion({
          part:5, chip:"Multi-step ($)",
          promptHtml:`A plumber charges <b>$48.5</b> per hour. He works <b>3.5</b> hours on Monday and <b>4.2</b> hours on Tuesday. How much does he earn in total?`,
          answerStr:"373.45",
          hintHtml:`Total hours = 3.5 + 4.2, then multiply by 48.5.`,
          solutionHtml: ()=>`Total hours = 3.5 + 4.2 = 7.7<br/>Earnings = 48.5×7.7 = <b>$373.45</b>.`,
          answerKeyText: ()=>`$373.45`,
          acceptMoney:true,
          dpStrict:2
        });
      });

      multiStep.push(()=>{ // fuel for 250 km
        return makeNumericQuestion({
          part:5, chip:"Multi-step",
          promptHtml:`A car uses <b>7.2 L</b> of fuel to travel <b>90 km</b>. How much fuel will it use for <b>250 km</b>?`,
          answerStr:"20",
          hintHtml:`Find litres per km (7.2 ÷ 90), then multiply by 250.`,
          solutionHtml: ()=>`7.2 ÷ 90 = 0.08 L/km<br/>Fuel for 250 km = 0.08×250 = <b>20</b> L.`,
          answerKeyText: ()=>`20 L`
        });
      });

      multiStep.push(()=>{ // swim time
        return makeNumericQuestion({
          part:5, chip:"Multi-step",
          promptHtml:`A swimmer completes <b>1.25 km</b> in <b>0.5</b> hours. How long will it take to swim <b>3.75 km</b> at the same speed?`,
          answerStr:"1.5",
          hintHtml:`Speed = distance ÷ time. Then time = new distance ÷ speed.`,
          solutionHtml: ()=>`Speed = 1.25 ÷ 0.5 = 2.5 km/h<br/>Time = 3.75 ÷ 2.5 = <b>1.5</b> hours.`,
          answerKeyText: ()=>`1.5 hours`
        });
      });

      multiStep.push(()=>{ // taxi fare
        return makeNumericQuestion({
          part:5, chip:"Multi-step ($)",
          promptHtml:`A taxi charges a base fare of <b>$3.00</b> plus <b>$2.75</b> per kilometre. How much does a <b>5.4 km</b> trip cost?`,
          answerStr:"17.85",
          hintHtml:`Cost = base + (rate × distance).`,
          solutionHtml: ()=>`Rate cost = 2.75×5.4 = 14.85<br/>Total = 3.00 + 14.85 = <b>$17.85</b>.`,
          answerKeyText: ()=>`$17.85`,
          acceptMoney:true,
          dpStrict:2
        });
      });

      oneStep.push(()=>{ // water for 12 days
        return makeNumericQuestion({
          part:5, chip:"1-step",
          promptHtml:`A family uses <b>5.6 L</b> of water for cooking each day. How much water is needed for <b>12</b> days?`,
          answerStr:"67.2",
          hintHtml:`Multiply daily use by number of days.`,
          solutionHtml: ()=>`5.6×12 = <b>67.2</b> L.`,
          answerKeyText: ()=>`67.2 L`
        });
      });

      multiStep.push(()=>{ // cyclist distances (twice Wednesday)
        return makeNumericQuestion({
          part:5, chip:"Multi-step",
          promptHtml:`A cyclist rides <b>18.5 km</b> on Monday, <b>15.6 km</b> on Wednesday, and <b>twice</b> Wednesday’s distance on Friday. What is the total distance?`,
          answerStr:"65.3",
          hintHtml:`Friday = 2×15.6. Total = 18.5 + 15.6 + Friday.`,
          solutionHtml: ()=>`Friday = 2×15.6 = 31.2<br/>Total = 18.5 + 15.6 + 31.2 = <b>65.3</b> km.`,
          answerKeyText: ()=>`65.3 km`
        });
      });

      // --- Selection rule: always show more multi-step ---
      const selectedMulti = pickUnique(multiStep, 3).map(fn=>fn());
      const selectedOne = pickUnique(oneStep, 2).map(fn=>fn());

      // shuffle final 5
      const final = [...selectedMulti, ...selectedOne];
      for(let i=final.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [final[i],final[j]]=[final[j],final[i]];
      }
      return final;
    }

    function buildAllQuestions(){
      return [
        ...buildPart1(),
        ...buildPart2(),
        ...buildPart3(),
        ...buildPart4(),
        ...buildPart5(),
      ];
    }

    /***********************
     * Rendering
     ***********************/
    function renderPractice(){
      const root = document.getElementById("practiceRoot");
      root.innerHTML = "";

      let globalIndex = 0;

      PARTS.forEach(p=>{
        const partQs = QUESTIONS.filter(q=>q.part===p.part);
        if(!partQs.length) return;

        const title = document.createElement("div");
        title.className = "part-title";
        title.textContent = p.title;
        root.appendChild(title);

        partQs.forEach(q=>{
          globalIndex++;
          q._globalNo = globalIndex;

          const card = document.createElement("div");
          card.className = "qCard";
          card.dataset.qid = q.id;

          const header = document.createElement("div");
          header.className = "qHeader";

          const qTitle = document.createElement("div");
          qTitle.className = "qTitle";
          qTitle.textContent = `Q${globalIndex}`;

          const chip = document.createElement("div");
          chip.className = "qChip";
          chip.textContent = q.chip || "Practice";

          header.appendChild(qTitle);
          header.appendChild(chip);
          card.appendChild(header);

          const prompt = document.createElement("div");
          prompt.className = "qPrompt";
          prompt.innerHTML = q.promptHtml || "";
          card.appendChild(prompt);

          const answerRow = document.createElement("div");
          answerRow.className = "answerRow";

          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "Answer:";
          answerRow.appendChild(label);

          const inp = document.createElement("input");
          inp.type = "text";
          inp.placeholder = "Type your answer";
          inp.value = q._value || "";
          inp.addEventListener("input", ()=>{
            q._value = inp.value;
            hideMsg(q.id);
          });
          answerRow.appendChild(inp);

          card.appendChild(answerRow);

          const btnRow = document.createElement("div");
          btnRow.className = "btnRow";

          const btnCheck = document.createElement("button");
          btnCheck.className = "btnSmall";
          btnCheck.textContent = "Check";
          btnCheck.addEventListener("click", ()=>doCheck(q.id));

          const btnHint = document.createElement("button");
          btnHint.className = "btnSmall hint";
          btnHint.textContent = "Hint";
          btnHint.addEventListener("click", ()=>showHint(q.id));

          const btnReveal = document.createElement("button");
          btnReveal.className = "btnSmall reveal";
          btnReveal.textContent = "Reveal";
          btnReveal.addEventListener("click", ()=>doReveal(q.id));

          btnRow.appendChild(btnCheck);
          btnRow.appendChild(btnHint);
          btnRow.appendChild(btnReveal);

          card.appendChild(btnRow);

          const msg = document.createElement("div");
          msg.className = "msgBox";
          msg.id = "msg_" + q.id;
          msg.innerHTML = `<div class="msgHead"></div><div class="msgBody"></div>`;
          card.appendChild(msg);

          root.appendChild(card);
        });
      });

      document.getElementById("scoreText").textContent = "Score: —";
    }

    function hideMsg(qid){
      const box = document.getElementById("msg_"+qid);
      if(!box) return;
      box.className = "msgBox";
      box.style.display = "none";
    }

    function showMsg(qid, mode, title, html){
      const box = document.getElementById("msg_"+qid);
      if(!box) return;
      box.querySelector(".msgHead").textContent = title;
      box.querySelector(".msgBody").innerHTML = html;
      box.style.display = "block";
      box.className = "msgBox show " + mode;
    }

    function getQuestion(qid){ return QUESTIONS.find(q=>q.id===qid); }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function doCheck(qid){
      const q = getQuestion(qid);
      if(!q) return;

      const res = q.validate((q._value || "").trim());
      q._checked = true;
      q._isCorrect = !!res.ok;

      if(res.ok){
        showMsg(qid, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : "Correct.");
      }else{
        const extra = res.msg ? `<div style="margin-bottom:8px;"><b>Note:</b> ${escapeHtml(res.msg)}</div>` : "";
        showMsg(qid, "wrong", "Solution", extra + (q.solutionHtml ? q.solutionHtml() : ""));
      }
    }

    function showHint(qid){
      const q = getQuestion(qid);
      if(!q) return;
      showMsg(qid, "hint", "Hint", q.hintHtml || "Try a place value method.");
    }

    function doReveal(qid){
      const q = getQuestion(qid);
      if(!q) return;
      q._revealed = true;
      q._checked = true;
      q._isCorrect = true;
      showMsg(qid, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : `Answer: ${escapeHtml(q.answer)}`);
      updateScoreIfSubmitted(false);
    }

    /***********************
     * Submit & score
     ***********************/
    function updateScoreIfSubmitted(forceShow){
      const submitted = forceShow || window.__submitted;
      if(!submitted) return;

      let correct = 0;
      let total = QUESTIONS.length;

      for(const q of QUESTIONS){
        if(!q._checked){
          const res = q.validate((q._value || "").trim());
          q._checked = true;
          q._isCorrect = !!res.ok;

          if(res.ok){
            showMsg(q.id, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : "Correct.");
          }else{
            const extra = res.msg ? `<div style="margin-bottom:8px;"><b>Note:</b> ${escapeHtml(res.msg)}</div>` : "";
            showMsg(q.id, "wrong", "Solution", extra + (q.solutionHtml ? q.solutionHtml() : ""));
          }
        }
        if(q._isCorrect) correct++;
      }

      document.getElementById("scoreText").textContent = `Score: ${correct} / ${total}`;
    }

    /***********************
     * Export to PDF (questions first, answer key last page)
     ***********************/
    function stripHtml(html){
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return (tmp.textContent || tmp.innerText || "").trim();
    }

    function exportToPdfViaPrint(){
      const perPage = parseInt(document.getElementById("perPageSelect").value,10) || 4;
      const student = getStudentName();
      const today = new Date();
      const dateStr = today.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"});

      let html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Decimal Review — DYAA</title>
  <style>
    body{font-family:Arial, sans-serif; margin:24px; color:#111;}
    .head{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; border-bottom:2px solid #ddd; padding-bottom:10px;}
    .head h1{margin:0; font-size:18px;}
    .meta{font-weight:700;}
    .part{margin-top:16px;}
    .part h2{font-size:14px; margin:0 0 8px 0; padding:8px 10px; background:#f2f6ff; border:1px solid #dbe6ff; border-radius:10px;}
    .q{border:1px solid #e6e6ef; border-radius:10px; padding:10px; margin:10px 0;}
    .q .qn{font-weight:900; margin-bottom:6px;}
    .line{margin-top:10px; border-bottom:1px solid #111; height:22px;}
    .small{font-size:12px; color:#444;}
    .pagebreak{page-break-after:always;}
    .ansKey h2{font-size:16px; margin:0 0 10px 0;}
    .ansRow{border-bottom:1px solid #eee; padding:8px 0;}
    .ansRow b{display:inline-block; width:56px;}
  </style>
</head>
<body>
  <div class="head">
    <div>
      <h1>Decimal Review — DYAA</h1>
      <div class="small">Student: ${escapeHtml(student)} &nbsp;&nbsp;|&nbsp;&nbsp; Date: ${escapeHtml(dateStr)}</div>
    </div>
    <div class="meta">Questions first → Answer Key on last page</div>
  </div>
`;

      let qOnPage = 0;
      let globalNo = 0;

      PARTS.forEach(p=>{
        const list = QUESTIONS.filter(q=>q.part===p.part);
        if(!list.length) return;

        html += `<div class="part"><h2>${escapeHtml(p.title)}</h2>`;

        list.forEach(q=>{
          globalNo++;
          html += `<div class="q">
            <div class="qn">Q${globalNo}</div>
            <div>${escapeHtml(stripHtml(q.promptHtml))}</div>
            <div class="line"></div>
          </div>`;

          qOnPage++;
          if(qOnPage >= perPage){
            html += `<div class="pagebreak"></div>`;
            qOnPage = 0;
          }
        });

        html += `</div>`;
      });

      html += `<div class="pagebreak"></div>`;
      html += `<div class="ansKey"><h2>Answer Key</h2>`;

      globalNo = 0;
      PARTS.forEach(p=>{
        const list = QUESTIONS.filter(q=>q.part===p.part);
        list.forEach(q=>{
          globalNo++;
          const ansText = (typeof q.answerKeyText === "function")
            ? q.answerKeyText()
            : (typeof q.answer === "string" ? q.answer : JSON.stringify(q.answer));
          html += `<div class="ansRow"><b>Q${globalNo}</b> ${escapeHtml(String(ansText))}</div>`;
        });
      });

      html += `</div></body></html>`;

      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(()=>w.print(), 300);
    }

    /***********************
     * New set confirm + reset
     ***********************/
    function openConfirm(){ document.getElementById("confirmBackdrop").classList.add("show"); }
    function closeConfirm(){ document.getElementById("confirmBackdrop").classList.remove("show"); }

    function generateNewSet(){
      window.__submitted = false;
      QUESTIONS = buildAllQuestions();
      renderPractice();
    }

    function resetAnswers(){
      window.__submitted = false;
      QUESTIONS.forEach(q=>{
        q._value = "";
        q._checked = false;
        q._isCorrect = false;
        q._revealed = false;
        hideMsg(q.id);
      });
      renderPractice();
    }

    /***********************
     * Tabs
     ***********************/
    function setTab(which){
      const learnTab = document.getElementById("learnTab");
      const practiceTab = document.getElementById("practiceTab");
      const learnSection = document.getElementById("learnSection");
      const practiceSection = document.getElementById("practiceSection");

      if(which==="learn"){
        learnTab.classList.add("active");
        practiceTab.classList.remove("active");
        learnSection.classList.add("active");
        practiceSection.classList.remove("active");
      }else{
        practiceTab.classList.add("active");
        learnTab.classList.remove("active");
        practiceSection.classList.add("active");
        learnSection.classList.remove("active");
      }
    }

    /***********************
     * Init bindings
     ***********************/
    document.getElementById("learnTab").addEventListener("click", ()=>setTab("learn"));
    document.getElementById("practiceTab").addEventListener("click", ()=>setTab("practice"));

    document.getElementById("newSetBtn").addEventListener("click", openConfirm);
    document.getElementById("cancelNewSet").addEventListener("click", closeConfirm);
    document.getElementById("confirmNewSet").addEventListener("click", ()=>{
      closeConfirm();
      generateNewSet();
      setTab("practice");
    });
    document.getElementById("confirmBackdrop").addEventListener("click", (e)=>{
      if(e.target.id==="confirmBackdrop") closeConfirm();
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      setTab("practice");
      exportToPdfViaPrint();
    });

    document.getElementById("submitBtn").addEventListener("click", ()=>{
      window.__submitted = true;
      updateScoreIfSubmitted(true);
    });

    document.getElementById("resetBtn").addEventListener("click", resetAnswers);

    // Start
    initStudent();
    generateNewSet();
  </script>
</body>
</html>
