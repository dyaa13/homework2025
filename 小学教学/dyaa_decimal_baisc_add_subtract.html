<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decimals — Learn & Practice — DYAA</title>

  <style>
    :root{
      --blue:#0d47a1;
      --orange:#ff9800;
      --bg:#f4f4f9;
      --ink:#222;
      --muted:#666;
      --card:#fff;
      --line:#e6e6ef;
      --ok:#1b5e20;
      --bad:#b71c1c;
      --shadow:0 6px 15px rgba(0,0,0,0.10);
      --radius:14px;
    }
    *{box-sizing:border-box;}
    body{
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      color:var(--ink);
    }
    /* subtle DYAA watermark */
    body:before{
      content:"DYAA";
      position:fixed;
      inset:auto auto 8% -10%;
      font-size:180px;
      font-weight:900;
      letter-spacing:8px;
      color:rgba(13,71,161,0.06);
      transform:rotate(-12deg);
      pointer-events:none;
      z-index:0;
      user-select:none;
    }

    .container{
      position:relative;
      z-index:1;
      max-width:980px;
      margin:28px auto;
      background:var(--card);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:26px;
      border:1px solid var(--line);
    }

    /* Header */
    #headerLogo{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:12px;
      border-bottom:2px solid #e0e0e0;
      padding-bottom:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:12px;min-width:260px;
    }
    .logo-icon{
      width:44px;height:44px;background:var(--blue);
      border-radius:8px;position:relative;flex:0 0 auto;
    }
    .logo-icon:before{
      content:"";position:absolute;width:22px;height:9px;background:var(--orange);
      top:-6px;left:11px;border-radius:4px;
    }
    .logo-text{
      display:flex;flex-direction:column;line-height:1.1;
    }
    .logo-text b{font-size:1.12rem;color:var(--blue);letter-spacing:.2px;}
    .logo-text span{font-size:.92rem;color:var(--orange);font-weight:800;}
    .title-block{
      flex:1 1 260px;
      min-width:260px;
    }
    .title-block h1{
      margin:0;
      font-size:1.15rem;
      color:#111;
      letter-spacing:.2px;
    }
    .title-block p{
      margin:4px 0 0 0;
      color:var(--muted);
      font-size:.95rem;
    }

    /* Top Bar */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin:14px 0 18px;
      flex-wrap:wrap;
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;}
    .tab-btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      color:#333;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .tab-btn.active{
      background:rgba(13,71,161,0.10);
      border-color:rgba(13,71,161,0.25);
      color:var(--blue);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex:1 1 360px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      min-width:240px;
      flex:1 1 240px;
    }
    .pill label{font-weight:800;color:#333;font-size:.95rem;white-space:nowrap;}
    .pill input{
      border:1px solid var(--line);
      border-radius:10px;
      padding:9px 10px;
      outline:none;
      width:100%;
      font-size:.95rem;
    }
    .student-name{font-weight:800;color:#111;}

    .btn{
      border:none;
      background:var(--blue);
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      box-shadow:0 4px 12px rgba(13,71,161,0.18);
      white-space:nowrap;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid var(--line);
      box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    .btn.orange{
      background:var(--orange);
      box-shadow:0 4px 12px rgba(255,152,0,0.18);
    }
    .btn:active{transform:translateY(1px);}

    select{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }

    /* Sections */
    .section{display:none;margin-top:10px;}
    .section.active{display:block;}

    .grid{display:grid;grid-template-columns:1fr;gap:14px;}
    @media (min-width: 900px){
      .grid.two{grid-template-columns:1fr 1fr;}
    }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
    }
    .card h2{margin:0 0 8px 0;font-size:1.05rem;color:var(--blue);}
    .card h3{margin:12px 0 6px 0;font-size:1rem;color:#111;}
    .card p, .card li{color:#222;line-height:1.55;margin:6px 0;}
    .muted{color:var(--muted);}

    .mini-table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      margin-top:10px;
    }
    .mini-table th, .mini-table td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      text-align:left;
      font-size:.95rem;
    }
    .mini-table th{
      background:rgba(13,71,161,0.06);
      color:#111;
    }
    .mini-table tr:last-child td{border-bottom:none;}

    /* Practice header note */
    .practice-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .note{
      background:rgba(255,152,0,0.12);
      border:1px solid rgba(255,152,0,0.25);
      padding:10px 12px;
      border-radius:12px;
      color:#222;
      line-height:1.45;
      flex:1 1 420px;
    }
    .tiny{font-size:.9rem;color:var(--muted);}

    /* Part title */
    .part-title{
      margin:18px 0 10px 0;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(13,71,161,0.06);
      border:1px solid rgba(13,71,161,0.15);
      color:#111;
      font-weight:900;
    }

    /* Question card style (like your screenshot) */
    .qCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
      margin:12px 0;
    }
    .qHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .qHeader .qTitle{
      font-weight:1000;
      color:var(--blue);
      font-size:1.05rem;
      letter-spacing:.3px;
    }
    .qChip{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      color:#111;
      font-size:.85rem;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }

    .qPrompt{
      line-height:1.5;
      color:#111;
      margin:6px 0 10px 0;
    }

    .answerRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin:8px 0 10px 0;
    }
    .answerRow .label{
      font-weight:900;
      color:#111;
      min-width:70px;
      padding-top:8px;
    }
    .answerRow input, .answerRow textarea{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      outline:none;
      width:min(520px, 100%);
    }
    .answerRow textarea{min-height:44px;resize:vertical;}

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:2px;
    }
    .btnSmall{
      border:none;
      background:var(--blue);
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      box-shadow:0 4px 12px rgba(13,71,161,0.18);
    }
    .btnSmall.hint{
      background:#eef3ff;
      color:var(--blue);
      border:1px solid rgba(13,71,161,0.18);
      box-shadow:none;
    }
    .btnSmall.reveal{
      background:#eef3ff;
      color:var(--blue);
      border:1px solid rgba(13,71,161,0.18);
      box-shadow:none;
    }

    .msgBox{
      margin-top:10px;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid var(--line);
      display:none;
    }
    .msgBox.show{display:block;}
    .msgBox .msgHead{
      display:flex;align-items:center;gap:8px;
      font-weight:1000;
      margin-bottom:6px;
    }
    .msgBox .msgBody{line-height:1.5;color:#111;}
    .msgBox.solution{
      background:rgba(27,94,32,0.08);
      border-color:rgba(27,94,32,0.22);
    }
    .msgBox.hint{
      background:rgba(13,71,161,0.07);
      border-color:rgba(13,71,161,0.20);
    }
    .msgBox.wrong{
      background:rgba(183,28,28,0.07);
      border-color:rgba(183,28,28,0.22);
    }

    .underline{
      text-decoration:underline;
      text-decoration-thickness: 3px;
      text-underline-offset: 4px;
      color:#000;
      font-weight:900;
    }

    /* Digit values grid */
    .digit-grid{
      display:grid;
      grid-template-columns:repeat(5, minmax(140px, 1fr));
      gap:8px;
      width:100%;
    }
    @media (max-width: 820px){
      .digit-grid{grid-template-columns:repeat(2, minmax(140px, 1fr));}
    }
    .digit-cell{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .digit-cell b{display:block;margin-bottom:6px;}
    .digit-cell input{width:100%;}

    /* Footer actions */
    .footer-actions{
      margin-top:18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .score{font-weight:900;color:#111;}

    /* Confirm modal */
    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:18px;
    }
    .modal-backdrop.show{display:flex;}
    .modal{
      background:#fff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
      max-width:520px;
      width:100%;
      padding:18px;
    }
    .modal h4{margin:0 0 8px 0;color:#111;font-size:1.05rem;}
    .modal p{margin:0 0 14px 0;color:#333;line-height:1.5;}
    .modal .row{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
  </style>
</head>

<body>
  <div class="container">
    <div id="headerLogo">
      <div class="brand">
        <div class="logo-icon"></div>
        <div class="logo-text">
          <b>DYAA Education</b>
          <span>Mathematics</span>
        </div>
      </div>
      <div class="title-block">
        <h1>Decimals — Learn & Practice</h1>
        <p>Basics • Reading decimals • Place value • Add & subtract • Word problems</p>
      </div>
    </div>

    <div class="topbar">
      <div class="tabs">
        <button class="tab-btn active" id="learnTab">Learn</button>
        <button class="tab-btn" id="practiceTab">Practice</button>
      </div>

      <div class="controls">
        <div class="pill" id="studentPill">
          <label>Student</label>
          <span id="studentDisplay" class="student-name" style="display:none;"></span>
          <input id="studentInput" type="text" placeholder="Enter student name" style="display:none;">
        </div>

        <select id="perPageSelect" title="Questions per page for Export to PDF">
          <option value="3">3 / page</option>
          <option value="4" selected>4 / page</option>
          <option value="6">6 / page</option>
          <option value="8">8 / page</option>
          <option value="9">9 / page</option>
        </select>

        <button class="btn secondary" id="exportBtn" title="Opens the print dialog (Save as PDF)">
          Export to PDF
        </button>
        <button class="btn orange" id="newSetBtn">Generate New Set</button>
      </div>
    </div>

    <!-- LEARN -->
    <div class="section active" id="learnSection">
      <div class="grid two">
        <div class="card">
          <h2>1) Decimal Basics — What is a decimal?</h2>
          <p>A decimal is another way to write fractions based on <b>tenths</b>, <b>hundredths</b>, <b>thousandths</b>…</p>
          <ul>
            <li>The <b>decimal point</b> separates the whole-number part and the fractional part.</li>
            <li>Moving right: each place is <b>10 times smaller</b>.</li>
            <li>Moving left: each place is <b>10 times larger</b>.</li>
          </ul>

          <h3>How to read decimals</h3>
          <ul>
            <li><b>Point reading:</b> 8.502 = “eight point five zero two”.</li>
            <li><b>Place-value reading:</b> 8.502 = “eight and five hundred two thousandths”.</li>
          </ul>
        </div>

        <div class="card">
          <h2>2) Decimal Place Value</h2>
          <p>Each digit has a <b>place</b> and a <b>value</b>.</p>

          <table class="mini-table">
            <thead>
              <tr>
                <th>Place</th>
                <th>Example (in 45.028)</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Tens</td><td>4</td><td>40</td></tr>
              <tr><td>Ones</td><td>5</td><td>5</td></tr>
              <tr><td>Tenths</td><td>0</td><td>0.0</td></tr>
              <tr><td>Hundredths</td><td>2</td><td>0.02</td></tr>
              <tr><td>Thousandths</td><td>8</td><td>0.008</td></tr>
            </tbody>
          </table>

          <h3>Comparing & ordering</h3>
          <ul>
            <li>Line up decimal points (add zeros if needed): 4.56 = 4.560</li>
            <li>Compare digits from left to right.</li>
          </ul>
        </div>

        <div class="card">
          <h2>3) Decimal Addition</h2>
          <ol>
            <li><b>Line up decimal points</b>.</li>
            <li>Add zeros to make the same number of decimal places (optional).</li>
            <li>Add as usual and bring the decimal point straight down.</li>
          </ol>
          <p><b>Example:</b> 2.45 + 3.7 = 2.45 + 3.70 = 6.15</p>
        </div>

        <div class="card">
          <h2>4) Decimal Subtraction</h2>
          <ol>
            <li><b>Line up decimal points</b>.</li>
            <li>Add zeros if needed.</li>
            <li>Subtract carefully (borrow across the decimal if needed).</li>
          </ol>
          <p><b>Example:</b> 7.50 − 3.28 = 4.22</p>
        </div>

        <div class="card">
          <h2>5) Word Problems (1-step & 2-step)</h2>
          <h3>1-step</h3>
          <ul>
            <li>Is it a <b>total</b> (add) or <b>left/difference</b> (subtract)?</li>
            <li>Keep the <b>unit</b> (L, kg, $, km…).</li>
          </ul>

          <h3>2-step</h3>
          <ul>
            <li>Write a plan: <b>Step 1</b> then <b>Step 2</b>.</li>
            <li>Check your final answer makes sense.</li>
          </ul>
        </div>

        <div class="card">
          <h2>Tip Box</h2>
          <ul>
            <li><b>Rounding:</b> look at the next digit. 7.294 to nearest tenth → 7.3</li>
            <li><b>Missing number:</b> if a + □ = b, then □ = b − a</li>
            <li><b>Neat work:</b> always align decimal points.</li>
          </ul>
          <p class="tiny">Switch to <b>Practice</b> to try questions like your worksheet.</p>
        </div>
      </div>
    </div>

    <!-- PRACTICE -->
    <div class="section" id="practiceSection">
      <div class="practice-head">
        <div class="note">
          <b>Instructions:</b> Each question has <b>Check</b>, <b>Hint</b>, and <b>Reveal</b> (like your screenshot).
          <div class="tiny">Export to PDF will put the <b>Answer Key on a new page at the end</b>.</div>
        </div>
      </div>

      <div id="practiceRoot"></div>

      <div class="footer-actions">
        <div class="score" id="scoreText">Score: —</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn secondary" id="resetBtn">Reset Answers</button>
          <button class="btn" id="submitBtn">Submit & View Result</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-backdrop" id="confirmBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h4>Generate a new set?</h4>
      <p>This will replace all current questions and clear your answers.</p>
      <div class="row">
        <button class="btn secondary" id="cancelNewSet">Cancel</button>
        <button class="btn orange" id="confirmNewSet">Yes, generate</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Student name (URL param ?name=Tiger)
     ***********************/
    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function initStudent(){
      const n = getParam("name");
      const studentDisplay = document.getElementById("studentDisplay");
      const studentInput = document.getElementById("studentInput");
      if(n && n.trim()){
        studentDisplay.style.display = "inline";
        studentInput.style.display = "none";
        studentDisplay.textContent = n.trim();
      }else{
        studentDisplay.style.display = "none";
        studentInput.style.display = "inline";
        const saved = localStorage.getItem("dyaa_student_name") || "";
        studentInput.value = saved;
        studentInput.addEventListener("input", ()=>{
          localStorage.setItem("dyaa_student_name", studentInput.value.trim());
        });
      }
    }
    function getStudentName(){
      const n = getParam("name");
      if(n && n.trim()) return n.trim();
      const v = (document.getElementById("studentInput").value || "").trim();
      return v || "________";
    }

    /***********************
     * BigInt decimal helpers (exact arithmetic)
     ***********************/
    function parseDec(str){
      str = String(str).trim();
      if(!str) return null;
      str = str.replace(/,/g,"");
      if(str[0]==="+") str = str.slice(1);
      if(!/^-?\d+(\.\d+)?$/.test(str)) return null;

      const neg = str[0]==="-";
      if(neg) str = str.slice(1);

      const parts = str.split(".");
      const intPart = parts[0] || "0";
      const frac = parts[1] || "";
      const scale = frac.length;
      const bi = BigInt(intPart + frac);
      return { neg, int: (neg ? -bi : bi), scale };
    }
    function align(a,b){
      const s = Math.max(a.scale, b.scale);
      const ai = a.int * BigInt(10 ** (s - a.scale));
      const bi = b.int * BigInt(10 ** (s - b.scale));
      return {ai, bi, scale:s};
    }
    function bigToStr(x, scale){
      const neg = x < 0n;
      let v = neg ? -x : x;
      let s = v.toString();
      if(scale === 0) return (neg ? "-" : "") + s;
      if(s.length <= scale){
        s = "0".repeat(scale - s.length + 1) + s;
      }
      const idx = s.length - scale;
      let out = s.slice(0, idx) + "." + s.slice(idx);
      out = out.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");
      return (neg ? "-" : "") + out;
    }
    function addDecStr(aStr,bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      const al = align(a,b);
      return bigToStr(al.ai + al.bi, al.scale);
    }
    function subDecStr(aStr,bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      const al = align(a,b);
      return bigToStr(al.ai - al.bi, al.scale);
    }
    function cmpDecStr(aStr,bStr){
      const a = parseDec(aStr), b = parseDec(bStr);
      const al = align(a,b);
      if(al.ai < al.bi) return -1;
      if(al.ai > al.bi) return 1;
      return 0;
    }
    function roundToDpStr(xStr, dp){
      const x = parseDec(xStr);
      if(!x) return null;
      const target = dp;

      if(x.scale === target) return bigToStr(x.int, x.scale);

      if(x.scale < target){
        const mul = BigInt(10 ** (target - x.scale));
        return bigToStr(x.int * mul, target);
      }else{
        const diff = x.scale - target;
        const div = BigInt(10 ** diff);
        const half = div / 2n;

        const neg = x.int < 0n;
        let v = neg ? -x.int : x.int;

        const q = v / div;
        const r = v % div;

        let qq = q;
        if(r >= half) qq = q + 1n;

        const outInt = neg ? -qq : qq;
        return bigToStr(outInt, target);
      }
    }
    function stripTrailingZerosDec(s){
      return String(s).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"");
    }

    /***********************
     * Words input acceptance (for "write in words" question)
     ***********************/
    function normalizeSpaces(s){
      return String(s).toLowerCase()
        .replace(/[\.\,\!\?\;\:]/g," ")
        .replace(/-/g," ")
        .replace(/\s+/g," ")
        .trim();
    }
    const wordToDigit = {
      "zero":"0","oh":"0","one":"1","two":"2","three":"3","four":"4",
      "five":"5","six":"6","seven":"7","eight":"8","nine":"9"
    };
    function wordsToNumberMaybe(input){
      const s = normalizeSpaces(input);
      if(!s) return null;

      // already a number?
      const numeric = parseDec(s.replace(/\s+/g,""));
      if(numeric) return bigToStr(numeric.int, numeric.scale);

      const parts = s.split(" point ");
      if(parts.length !== 2) return null;

      const leftWords = parts[0].trim().split(" ").filter(Boolean);
      const rightWords = parts[1].trim().split(" ").filter(Boolean);

      let leftNum = null;
      if(leftWords.length === 1 && wordToDigit[leftWords[0]] !== undefined){
        leftNum = wordToDigit[leftWords[0]];
      }else{
        if(/^\d+$/.test(leftWords.join(""))) leftNum = leftWords.join("");
      }
      if(leftNum === null) return null;

      let rightDigits = "";
      for(const w of rightWords){
        if(wordToDigit[w] === undefined) return null;
        rightDigits += wordToDigit[w];
      }
      if(rightDigits.length === 0) return null;

      return leftNum + "." + rightDigits;
    }

    /***********************
     * Random helpers
     ***********************/
    function randInt(min,max){
      return Math.floor(Math.random()*(max-min+1))+min;
    }
    function randChoice(arr){
      return arr[Math.floor(Math.random()*arr.length)];
    }
    function randDigits(len, allowAllZero=false){
      let s="";
      for(let i=0;i<len;i++) s += String(randInt(0,9));
      if(!allowAllZero && /^0+$/.test(s)) return randDigits(len, allowAllZero);
      return s;
    }
    function makeDecimalStr(intMin,intMax, dpOptions, allowAllZeroFrac=false){
      const intPart = randInt(intMin,intMax);
      const dp = randChoice(dpOptions);
      if(dp===0) return String(intPart);
      const frac = randDigits(dp, allowAllZeroFrac);
      return `${intPart}.${frac}`;
    }

    /***********************
     * Question model
     ***********************/
    let QUESTIONS = []; // ordered list (global numbering)
    const PARTS = [
      {part:1, title:"Part 1 — Decimal Place Value (20 marks)"},
      {part:2, title:"Part 2 — Decimal Addition (20 marks)"},
      {part:3, title:"Part 3 — Decimal Subtraction (20 marks)"},
      {part:4, title:"Part 4 — Word Problems (One-Step, 20 marks) Show your working."},
      {part:5, title:"Part 5 — Word Problems (Two-Step) Show your working."},
    ];

    function qId(){
      return "q_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    }

    /***********************
     * Build questions (with Hint + Solution text)
     ***********************/
    function buildPlaceValuePart(){
      const out = [];

      // Q1: write decimal in words
      const d1 = makeDecimalStr(1,9,[3], true);
      const q1 = {
        id:qId(),
        part:1,
        chip:"Decimal Place Value",
        promptHtml:`Write <b>${d1}</b> in words.`,
        inputType:"text", // uses textarea
        answer: stripTrailingZerosDec(d1),
        hintHtml:`Read the number as: <b>whole number</b>, then say <b>"point"</b>, then read each digit after the point.`,
        solutionHtml:()=> {
          const digits = d1.split(".")[1].split("").map(x=>{
            return Object.keys(wordToDigit).find(k=>wordToDigit[k]===x) || x;
          });
          return `One common way: <b>${d1.split(".")[0]} point ${digits.join(" ")}</b>.<br/>Accepted answer (numeric): <b>${stripTrailingZerosDec(d1)}</b>.`;
        },
        validate:(raw)=>{
          if(!raw.trim()) return {ok:false, msg:"Please enter an answer."};
          const p = parseDec(raw.replace(/\s+/g,""));
          const exp = stripTrailingZerosDec(d1);
          if(p){
            const got = stripTrailingZerosDec(bigToStr(p.int,p.scale));
            return got === exp ? {ok:true} : {ok:false, msg:`Correct answer: ${exp}`};
          }
          const maybe = wordsToNumberMaybe(raw);
          if(maybe){
            return stripTrailingZerosDec(maybe) === exp ? {ok:true} : {ok:false, msg:`Correct answer: ${exp}`};
          }
          return {ok:false, msg:`Accepted formats: a number (e.g., ${d1}) or “... point ...”.`};
        },
        answerKeyText:()=> `${stripTrailingZerosDec(d1)} (e.g., “${d1.split(".")[0]} point ${d1.split(".")[1].split("").join(" ")}”)`
      };
      out.push(q1);

      // Q2: underlined digit value
      const int2 = randInt(1,9);
      const frac2 = randDigits(3,true);
      const num2 = `${int2}.${frac2}`;
      const pos = randChoice([0,2,3,4]); // 0 ones, 2 tenths, 3 hundredths, 4 thousandths
      let html2 = "";
      for(let i=0;i<num2.length;i++){
        const ch = num2[i];
        html2 += (i===pos) ? `<span class="underline">${ch}</span>` : ch;
      }
      const underDigit = num2[pos];

      let placeName = "ones";
      let value2 = underDigit;
      if(pos===2){ placeName="tenths"; value2 = `0.${underDigit}`; }
      if(pos===3){ placeName="hundredths"; value2 = `0.0${underDigit}`; }
      if(pos===4){ placeName="thousandths"; value2 = `0.00${underDigit}`; }
      value2 = stripTrailingZerosDec(value2);

      out.push({
        id:qId(),
        part:1,
        chip:"Decimal Place Value",
        promptHtml:`What is the value of the underlined digit in <b>${html2}</b>?`,
        inputType:"number",
        answer:value2,
        hintHtml:`Find the <b>place</b> of the underlined digit (ones / tenths / hundredths / thousandths), then write its value.`,
        solutionHtml:()=> `The underlined digit is in the <b>${placeName}</b> place, so its value is <b>${value2}</b>.`,
        validate:(raw)=>{
          const p = parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number."};
          const got = stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got === value2 ? {ok:true} : {ok:false, msg:`Correct answer: ${value2}`};
        },
        answerKeyText:()=> value2
      });

      // Q3: greater number
      const base = randInt(1,9) + "." + randDigits(1,true);
      const A = stripTrailingZerosDec(base + randDigits(2,true)); // 3dp
      const B = stripTrailingZerosDec(base + randDigits(1,true)); // 2dp
      const correct = cmpDecStr(A,B) >= 0 ? "A" : "B";

      out.push({
        id:qId(),
        part:1,
        chip:"Comparing",
        promptHtml:`Which number is greater?<br/><b>A)</b> ${A} &nbsp;&nbsp; <b>B)</b> ${B}`,
        inputType:"shortText",
        placeholder:`Type A or B`,
        answer:correct,
        hintHtml:`Make the same number of decimal places by adding zeros, then compare digits from left to right.`,
        solutionHtml:()=>{
          const dp = Math.max((A.split(".")[1]||"").length, (B.split(".")[1]||"").length);
          const Ap = A.includes(".") ? A : (A + "." + "0".repeat(dp));
          const Bp = B.includes(".") ? B : (B + "." + "0".repeat(dp));
          const A2 = Ap.includes(".") ? (Ap + "0".repeat(dp - (Ap.split(".")[1]||"").length)) : Ap;
          const B2 = Bp.includes(".") ? (Bp + "0".repeat(dp - (Bp.split(".")[1]||"").length)) : Bp;
          return `Pad with zeros: <b>${A2}</b> and <b>${B2}</b>. Compare digit by digit → the greater one is <b>${correct}</b>.`;
        },
        validate:(raw)=>{
          const s = String(raw).trim().toUpperCase();
          if(s!=="A" && s!=="B") return {ok:false, msg:"Please type A or B."};
          return s===correct ? {ok:true} : {ok:false, msg:`Correct answer: ${correct}`};
        },
        answerKeyText:()=> correct
      });

      // Q4: rounding
      const d4 = makeDecimalStr(1,9,[3], true);
      const ans4 = stripTrailingZerosDec(roundToDpStr(d4,1));
      out.push({
        id:qId(),
        part:1,
        chip:"Rounding",
        promptHtml:`Round <b>${d4}</b> to the nearest <b>tenth</b>.`,
        inputType:"number",
        answer:ans4,
        hintHtml:`Look at the <b>hundredths</b> digit: 0–4 round down, 5–9 round up.`,
        solutionHtml:()=>{
          const hundredths = (d4.split(".")[1]||"00")[1] || "0";
          return `The hundredths digit is <b>${hundredths}</b>, so the number rounds to <b>${ans4}</b>.`;
        },
        validate:(raw)=>{
          const p = parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number."};
          const got = stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===ans4 ? {ok:true} : {ok:false, msg:`Correct answer: ${ans4}`};
        },
        answerKeyText:()=> ans4
      });

      // Q5: order
      const list = [
        stripTrailingZerosDec(makeDecimalStr(1,2,[1,2,3], true)),
        stripTrailingZerosDec(makeDecimalStr(1,2,[1,2,3], true)),
        stripTrailingZerosDec(makeDecimalStr(1,2,[1,2,3], true)),
        stripTrailingZerosDec(makeDecimalStr(1,2,[1,2,3], true)),
      ];
      for(let i=0;i<20;i++){
        const set = new Set(list);
        if(set.size === list.length) break;
        list[randInt(0,3)] = stripTrailingZerosDec(makeDecimalStr(1,2,[1,2,3], true));
      }
      const sorted = [...list].sort((x,y)=>cmpDecStr(x,y));

      out.push({
        id:qId(),
        part:1,
        chip:"Ordering",
        promptHtml:`Arrange the numbers in order from smallest to largest:<br/><b>${list.join(", ")}</b>`,
        inputType:"order",
        placeholder:"Type your order, separated by commas",
        answer:sorted,
        hintHtml:`Write them with the same number of decimal places (add zeros), then compare left to right.`,
        solutionHtml:()=> `Smallest to largest: <b>${sorted.join(", ")}</b>.`,
        validate:(raw)=>{
          const items = String(raw).split(",").map(s=>s.trim()).filter(Boolean);
          if(items.length !== list.length) return {ok:false, msg:`Please enter ${list.length} numbers, separated by commas.`};
          const parsed = items.map(x=>{
            const p = parseDec(x);
            return p ? stripTrailingZerosDec(bigToStr(p.int,p.scale)) : null;
          });
          if(parsed.some(v=>v===null)) return {ok:false, msg:"Please enter valid decimals."};
          const ok = parsed.every((v,i)=>v===sorted[i]);
          return ok ? {ok:true} : {ok:false, msg:`Correct order: ${sorted.join(", ")}`};
        },
        answerKeyText:()=> sorted.join(", ")
      });

      // Q6: each digit's value
      const tens = randInt(1,9);
      const ones = randInt(0,9);
      const tenths = randInt(0,9);
      const hundredths = randInt(0,9);
      const thousandths = randInt(0,9);
      const d6 = `${tens}${ones}.${tenths}${hundredths}${thousandths}`;

      const ans6 = {
        tens: String(tens*10),
        ones: String(ones),
        tenths: stripTrailingZerosDec(`0.${tenths}`),
        hundredths: stripTrailingZerosDec(`0.0${hundredths}`),
        thousandths: stripTrailingZerosDec(`0.00${thousandths}`)
      };

      out.push({
        id:qId(),
        part:1,
        chip:"Place Value",
        promptHtml:`Write each digit’s value in <b>${d6}</b>.`,
        inputType:"digitValues",
        answer:ans6,
        hintHtml:`Each step to the right of the decimal is ÷10. Tens, ones, tenths, hundredths, thousandths.`,
        solutionHtml:()=> `Tens: <b>${ans6.tens}</b>, Ones: <b>${ans6.ones}</b>, Tenths: <b>${ans6.tenths}</b>, Hundredths: <b>${ans6.hundredths}</b>, Thousandths: <b>${ans6.thousandths}</b>.`,
        validate:(inputs)=>{
          const keys = ["tens","ones","tenths","hundredths","thousandths"];
          for(const k of keys){
            const val = (inputs[k] || "").trim();
            if(!val) return {ok:false, msg:"Please fill all boxes."};
            const p = parseDec(val);
            if(!p) return {ok:false, msg:"Please enter numbers in all boxes."};
            const got = stripTrailingZerosDec(bigToStr(p.int,p.scale));
            if(got !== ans6[k]) return {ok:false, msg:`Correct values: tens=${ans6.tens}, ones=${ans6.ones}, tenths=${ans6.tenths}, hundredths=${ans6.hundredths}, thousandths=${ans6.thousandths}`};
          }
          return {ok:true};
        },
        answerKeyText:()=> `tens=${ans6.tens}, ones=${ans6.ones}, tenths=${ans6.tenths}, hundredths=${ans6.hundredths}, thousandths=${ans6.thousandths}`
      });

      // Q7: missing decimal
      let B7 = stripTrailingZerosDec(makeDecimalStr(6,9,[0,1,2], true));
      let A7 = stripTrailingZerosDec(makeDecimalStr(1,8,[1,2], true));
      if(cmpDecStr(A7,B7) > 0){ const tmp=A7; A7=B7; B7=tmp; }
      const missing = stripTrailingZerosDec(subDecStr(B7, A7));

      out.push({
        id:qId(),
        part:1,
        chip:"Missing Number",
        promptHtml:`Fill in the missing decimal to make the statement true:<br/><b>${A7}</b> + <b>__</b> = <b>${B7}</b>`,
        inputType:"number",
        answer:missing,
        hintHtml:`Use subtraction: missing = <b>${B7}</b> − <b>${A7}</b>.`,
        solutionHtml:()=> `${B7} − ${A7} = <b>${missing}</b>. So the missing number is <b>${missing}</b>.`,
        validate:(raw)=>{
          const p = parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number."};
          const got = stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===missing ? {ok:true} : {ok:false, msg:`Correct answer: ${missing}`};
        },
        answerKeyText:()=> missing
      });

      return out;
    }

    function buildAdditionPart(){
      const out = [];
      function mkAdd(a,b){
        const exp = stripTrailingZerosDec(addDecStr(a,b));
        return {
          id:qId(),
          part:2,
          chip:"Addition",
          promptHtml:`<b>${a}</b> + <b>${b}</b> =`,
          inputType:"number",
          answer:exp,
          hintHtml:`Line up the decimal points, add zeros if needed, then add.`,
          solutionHtml:()=> `${a} + ${b} = <b>${exp}</b>.`,
          validate:(raw)=>{
            const p=parseDec(raw);
            if(!p) return {ok:false, msg:"Please enter a number."};
            const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
            return got===exp ? {ok:true} : {ok:false, msg:`Correct answer: ${exp}`};
          },
          answerKeyText:()=> exp
        };
      }

      out.push(mkAdd(makeDecimalStr(1,9,[2], true), makeDecimalStr(1,9,[1], true)));
      out.push(mkAdd(makeDecimalStr(1,9,[3], true), makeDecimalStr(1,9,[1], true)));
      out.push(mkAdd(makeDecimalStr(0,2,[2], true), makeDecimalStr(0,2,[3], true)));

      const a4 = makeDecimalStr(10,19,[2], true);
      const b4 = makeDecimalStr(1,9,[2], true);
      const c4 = makeDecimalStr(1,9,[1], true);
      const sum4 = stripTrailingZerosDec(addDecStr(addDecStr(a4,b4),c4));
      out.push({
        id:qId(),
        part:2,
        chip:"Addition",
        promptHtml:`<b>${a4}</b> + <b>${b4}</b> + <b>${c4}</b> =`,
        inputType:"number",
        answer:sum4,
        hintHtml:`Line up all decimal points. Add step-by-step (first two, then add the third).`,
        solutionHtml:()=> `${a4} + ${b4} + ${c4} = <b>${sum4}</b>.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===sum4 ? {ok:true} : {ok:false, msg:`Correct answer: ${sum4}`};
        },
        answerKeyText:()=> sum4
      });

      const a5 = makeDecimalStr(1,9,[2], true);
      const b5 = makeDecimalStr(0,2,[2], true);
      const raw5 = stripTrailingZerosDec(addDecStr(a5,b5));
      const rounded5 = stripTrailingZerosDec(roundToDpStr(raw5,1));
      out.push({
        id:qId(),
        part:2,
        chip:"Add then round",
        promptHtml:`Add <b>${a5}</b> and <b>${b5}</b>, then round your answer to <b>1 decimal place</b>.`,
        inputType:"number",
        answer:rounded5,
        hintHtml:`Step 1: add. Step 2: round to 1 decimal place.`,
        solutionHtml:()=> `${a5} + ${b5} = ${raw5}, rounded to 1 dp = <b>${rounded5}</b>.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===rounded5 ? {ok:true} : {ok:false, msg:`Correct answer: ${rounded5}`};
        },
        answerKeyText:()=> rounded5
      });

      return out;
    }

    function buildSubtractionPart(){
      const out = [];
      function mkSub(a,b){
        // ensure a >= b
        let A=a,B=b;
        if(cmpDecStr(A,B) < 0){ const tmp=A; A=B; B=tmp; }
        const exp = stripTrailingZerosDec(subDecStr(A,B));
        return {
          id:qId(),
          part:3,
          chip:"Subtraction",
          promptHtml:`<b>${stripTrailingZerosDec(A)}</b> − <b>${stripTrailingZerosDec(B)}</b> =`,
          inputType:"number",
          answer:exp,
          hintHtml:`Line up decimal points, add zeros if needed, then subtract (borrow carefully).`,
          solutionHtml:()=> `${stripTrailingZerosDec(A)} − ${stripTrailingZerosDec(B)} = <b>${exp}</b>.`,
          validate:(raw)=>{
            const p=parseDec(raw);
            if(!p) return {ok:false, msg:"Please enter a number."};
            const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
            return got===exp ? {ok:true} : {ok:false, msg:`Correct answer: ${exp}`};
          },
          answerKeyText:()=> exp
        };
      }

      out.push(mkSub(makeDecimalStr(5,9,[1], true), makeDecimalStr(1,4,[2], true)));
      out.push(mkSub(makeDecimalStr(8,12,[1], true), makeDecimalStr(5,9,[2], true)));
      out.push(mkSub(makeDecimalStr(6,9,[2], true), makeDecimalStr(1,5,[1], true)));
      out.push(mkSub(makeDecimalStr(6,9,[3], true), makeDecimalStr(1,5,[2], true)));
      out.push(mkSub(makeDecimalStr(7,12,[2], true), makeDecimalStr(2,7,[1], true)));

      return out;
    }

    function buildOneStepWordPart(){
      const out = [];

      const cap = stripTrailingZerosDec(makeDecimalStr(1,3,[2], true));
      const drink = stripTrailingZerosDec(makeDecimalStr(0,2,[2], true));
      const left = stripTrailingZerosDec(subDecStr(cap, drink));
      out.push({
        id:qId(),
        part:4,
        chip:"One-step",
        promptHtml:`A water bottle holds <b>${cap} L</b> of water. If <b>${drink} L</b> is drunk, how much water is left?`,
        inputType:"number",
        answer:left,
        hintHtml:`“Left” means subtract: <b>${cap}</b> − <b>${drink}</b>.`,
        solutionHtml:()=> `${cap} − ${drink} = <b>${left}</b> L.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number (litres)."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===left ? {ok:true} : {ok:false, msg:`Correct answer: ${left} L`};
        },
        answerKeyText:()=> `${left} L`
      });

      const w1 = stripTrailingZerosDec(makeDecimalStr(0,2,[3], true));
      const w2 = stripTrailingZerosDec(makeDecimalStr(0,2,[2], true));
      const tot = stripTrailingZerosDec(addDecStr(w1,w2));
      out.push({
        id:qId(),
        part:4,
        chip:"One-step",
        promptHtml:`A packet of nuts weighs <b>${w1} kg</b>. Another packet weighs <b>${w2} kg</b>. What is their total weight?`,
        inputType:"number",
        answer:tot,
        hintHtml:`“Total” means add: <b>${w1}</b> + <b>${w2}</b>.`,
        solutionHtml:()=> `${w1} + ${w2} = <b>${tot}</b> kg.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number (kg)."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===tot ? {ok:true} : {ok:false, msg:`Correct answer: ${tot} kg`};
        },
        answerKeyText:()=> `${tot} kg`
      });

      const money = stripTrailingZerosDec(makeDecimalStr(10,30,[2], true));
      const spend = stripTrailingZerosDec(makeDecimalStr(1,9,[2], true));
      const remain = stripTrailingZerosDec(subDecStr(money, spend));
      out.push({
        id:qId(),
        part:4,
        chip:"One-step",
        promptHtml:`You have <b>$${money}</b>. You spend <b>$${spend}</b> on snacks. How much money is left?`,
        inputType:"number",
        answer:remain,
        hintHtml:`“Left” means subtract: <b>${money}</b> − <b>${spend}</b>.`,
        solutionHtml:()=> `${money} − ${spend} = <b>${remain}</b>. So you have <b>$${remain}</b> left.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number (dollars)."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===remain ? {ok:true} : {ok:false, msg:`Correct answer: $${remain}`};
        },
        answerKeyText:()=> `$${remain}`
      });

      const dA = stripTrailingZerosDec(makeDecimalStr(0,5,[2], true));
      const dB = stripTrailingZerosDec(makeDecimalStr(0,5,[2], true));
      const dTot = stripTrailingZerosDec(addDecStr(dA,dB));
      out.push({
        id:qId(),
        part:4,
        chip:"One-step",
        promptHtml:`A cyclist rides <b>${dA} km</b> in the morning and <b>${dB} km</b> in the afternoon. How far in total?`,
        inputType:"number",
        answer:dTot,
        hintHtml:`“In total” means add: <b>${dA}</b> + <b>${dB}</b>.`,
        solutionHtml:()=> `${dA} + ${dB} = <b>${dTot}</b> km.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number (km)."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===dTot ? {ok:true} : {ok:false, msg:`Correct answer: ${dTot} km`};
        },
        answerKeyText:()=> `${dTot} km`
      });

      return out;
    }

    function buildTwoStepWordPart(){
      const out = [];

      let S = stripTrailingZerosDec(makeDecimalStr(8,20,[1,2], true));
      let Sold  = stripTrailingZerosDec(makeDecimalStr(1,7,[1,2], true));
      const bought= stripTrailingZerosDec(makeDecimalStr(0,6,[1,2], true));
      if(cmpDecStr(S, Sold) < 0){ const tmp=S; S=Sold; Sold=tmp; }
      const afterSold = stripTrailingZerosDec(subDecStr(S, Sold));
      const final1 = stripTrailingZerosDec(addDecStr(afterSold, bought));
      out.push({
        id:qId(),
        part:5,
        chip:"Two-step",
        promptHtml:`A shop has <b>${S} kg</b> of rice. It sells <b>${Sold} kg</b>, then buys <b>${bought} kg</b> more. How many kilograms of rice are there now?`,
        inputType:"number",
        answer:final1,
        hintHtml:`Step 1: ${S} − ${Sold}. Step 2: add ${bought}.`,
        solutionHtml:()=> `Step 1: ${S} − ${Sold} = ${afterSold}.<br/>Step 2: ${afterSold} + ${bought} = <b>${final1}</b> kg.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number (kg)."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===final1 ? {ok:true} : {ok:false, msg:`Correct answer: ${final1} kg`};
        },
        answerKeyText:()=> `${final1} kg`
      });

      const t1 = stripTrailingZerosDec(makeDecimalStr(1,6,[2], true));
      const t2 = stripTrailingZerosDec(makeDecimalStr(1,6,[2], true));
      let used = stripTrailingZerosDec(makeDecimalStr(0,5,[2], true));
      const sum = stripTrailingZerosDec(addDecStr(t1,t2));
      if(cmpDecStr(sum, used) < 0) used = stripTrailingZerosDec(makeDecimalStr(0,2,[2], true));
      const final2 = stripTrailingZerosDec(subDecStr(sum, used));
      out.push({
        id:qId(),
        part:5,
        chip:"Two-step",
        promptHtml:`A family buys <b>${t1} L</b> of milk on Monday and <b>${t2} L</b> on Tuesday. They use <b>${used} L</b> in total. How much milk is left?`,
        inputType:"number",
        answer:final2,
        hintHtml:`Step 1: add the milk bought. Step 2: subtract the milk used.`,
        solutionHtml:()=> `Step 1: ${t1} + ${t2} = ${sum}.<br/>Step 2: ${sum} − ${used} = <b>${final2}</b> L.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number (L)."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===final2 ? {ok:true} : {ok:false, msg:`Correct answer: ${final2} L`};
        },
        answerKeyText:()=> `${final2} L`
      });

      let Wallet = stripTrailingZerosDec(makeDecimalStr(15,60,[2], true));
      let Buy1 = stripTrailingZerosDec(makeDecimalStr(1,20,[2], true));
      const refund = stripTrailingZerosDec(makeDecimalStr(0,10,[2], true));
      if(cmpDecStr(Wallet, Buy1) < 0){ const tmp=Wallet; Wallet=Buy1; Buy1=tmp; }
      const afterBuy = stripTrailingZerosDec(subDecStr(Wallet, Buy1));
      const final3 = stripTrailingZerosDec(addDecStr(afterBuy, refund));
      out.push({
        id:qId(),
        part:5,
        chip:"Two-step",
        promptHtml:`You have <b>$${Wallet}</b>. You buy a book for <b>$${Buy1}</b>. Later you get a refund of <b>$${refund}</b>. How much money do you have now?`,
        inputType:"number",
        answer:final3,
        hintHtml:`Step 1: subtract the cost. Step 2: add the refund.`,
        solutionHtml:()=> `Step 1: ${Wallet} − ${Buy1} = ${afterBuy}.<br/>Step 2: ${afterBuy} + ${refund} = <b>${final3}</b>.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number ($)."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===final3 ? {ok:true} : {ok:false, msg:`Correct answer: $${final3}`};
        },
        answerKeyText:()=> `$${final3}`
      });

      const run1 = stripTrailingZerosDec(makeDecimalStr(1,8,[1,2], true));
      const run2 = stripTrailingZerosDec(makeDecimalStr(1,8,[1,2], true));
      let less = stripTrailingZerosDec(makeDecimalStr(0,3,[1,2], true));
      const total12 = stripTrailingZerosDec(addDecStr(run1,run2));
      if(cmpDecStr(total12, less) < 0) less = "0.5";
      const final4 = stripTrailingZerosDec(subDecStr(total12, less));
      out.push({
        id:qId(),
        part:5,
        chip:"Two-step",
        promptHtml:`A runner runs <b>${run1} km</b> in the morning and <b>${run2} km</b> in the afternoon. The next day, the runner runs <b>${less} km</b> less than the total from the first day. How far does the runner run the next day?`,
        inputType:"number",
        answer:final4,
        hintHtml:`Step 1: add Day 1 total. Step 2: subtract the “less” amount.`,
        solutionHtml:()=> `Day 1 total: ${run1} + ${run2} = ${total12}.<br/>Next day: ${total12} − ${less} = <b>${final4}</b> km.`,
        validate:(raw)=>{
          const p=parseDec(raw);
          if(!p) return {ok:false, msg:"Please enter a number (km)."};
          const got=stripTrailingZerosDec(bigToStr(p.int,p.scale));
          return got===final4 ? {ok:true} : {ok:false, msg:`Correct answer: ${final4} km`};
        },
        answerKeyText:()=> `${final4} km`
      });

      return out;
    }

    function buildAllQuestions(){
      const all = [];
      all.push(...buildPlaceValuePart());
      all.push(...buildAdditionPart());
      all.push(...buildSubtractionPart());
      all.push(...buildOneStepWordPart());
      all.push(...buildTwoStepWordPart());
      // init state
      all.forEach(q=>{
        q._checked = false;
        q._isCorrect = false;
        q._revealed = false;
        q._value = "";
        q._inputs = null;
      });
      return all;
    }

    /***********************
     * Rendering (global Q1..Qn)
     ***********************/
    function renderPractice(){
      const root = document.getElementById("practiceRoot");
      root.innerHTML = "";

      let globalIndex = 0;

      PARTS.forEach(p=>{
        const partQs = QUESTIONS.filter(q=>q.part===p.part);
        if(!partQs.length) return;

        const title = document.createElement("div");
        title.className = "part-title";
        title.textContent = p.title;
        root.appendChild(title);

        partQs.forEach(q=>{
          globalIndex++;
          q._globalNo = globalIndex;

          const card = document.createElement("div");
          card.className = "qCard";
          card.dataset.qid = q.id;

          const header = document.createElement("div");
          header.className = "qHeader";

          const qTitle = document.createElement("div");
          qTitle.className = "qTitle";
          qTitle.textContent = `Q${globalIndex}`;

          const chip = document.createElement("div");
          chip.className = "qChip";
          chip.textContent = q.chip || "Practice";

          header.appendChild(qTitle);
          header.appendChild(chip);
          card.appendChild(header);

          const prompt = document.createElement("div");
          prompt.className = "qPrompt";
          prompt.innerHTML = q.promptHtml || "";
          card.appendChild(prompt);

          // Answer row
          const answerRow = document.createElement("div");
          answerRow.className = "answerRow";

          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "Answer:";
          answerRow.appendChild(label);

          // input(s)
          if(q.inputType === "digitValues"){
            q._inputs = q._inputs || {tens:"", ones:"", tenths:"", hundredths:"", thousandths:""};
            const grid = document.createElement("div");
            grid.className = "digit-grid";

            const cells = [
              {k:"tens", label:"Tens value"},
              {k:"ones", label:"Ones value"},
              {k:"tenths", label:"Tenths value"},
              {k:"hundredths", label:"Hundredths value"},
              {k:"thousandths", label:"Thousandths value"},
            ];
            cells.forEach(c=>{
              const cell = document.createElement("div");
              cell.className = "digit-cell";
              const b = document.createElement("b");
              b.textContent = c.label;
              const inp = document.createElement("input");
              inp.placeholder = "e.g., 40 or 0.02";
              inp.value = q._inputs[c.k] || "";
              inp.addEventListener("input", ()=>{
                q._inputs[c.k] = inp.value;
                hideMsg(q.id);
              });
              cell.appendChild(b);
              cell.appendChild(inp);
              grid.appendChild(cell);
            });

            answerRow.appendChild(grid);
          } else {
            if(q.inputType === "text"){
              const ta = document.createElement("textarea");
              ta.placeholder = "Type your answer";
              ta.value = q._value || "";
              ta.addEventListener("input", ()=>{
                q._value = ta.value;
                hideMsg(q.id);
              });
              answerRow.appendChild(ta);
            } else {
              const inp = document.createElement("input");
              inp.type = "text";
              inp.placeholder = q.placeholder || "Type your answer";
              inp.value = q._value || "";
              inp.addEventListener("input", ()=>{
                q._value = inp.value;
                hideMsg(q.id);
              });
              answerRow.appendChild(inp);
            }
          }

          card.appendChild(answerRow);

          // Buttons row
          const btnRow = document.createElement("div");
          btnRow.className = "btnRow";

          const btnCheck = document.createElement("button");
          btnCheck.className = "btnSmall";
          btnCheck.textContent = "Check";
          btnCheck.addEventListener("click", ()=>doCheck(q.id));

          const btnHint = document.createElement("button");
          btnHint.className = "btnSmall hint";
          btnHint.textContent = "Hint";
          btnHint.addEventListener("click", ()=>showHint(q.id));

          const btnReveal = document.createElement("button");
          btnReveal.className = "btnSmall reveal";
          btnReveal.textContent = "Reveal";
          btnReveal.addEventListener("click", ()=>doReveal(q.id));

          btnRow.appendChild(btnCheck);
          btnRow.appendChild(btnHint);
          btnRow.appendChild(btnReveal);

          card.appendChild(btnRow);

          // Message box
          const msg = document.createElement("div");
          msg.className = "msgBox";
          msg.id = "msg_" + q.id;
          msg.innerHTML = `<div class="msgHead"></div><div class="msgBody"></div>`;
          card.appendChild(msg);

          root.appendChild(card);
        });
      });

      document.getElementById("scoreText").textContent = "Score: —";
    }

    function hideMsg(qid){
      const box = document.getElementById("msg_"+qid);
      if(!box) return;
      box.className = "msgBox";
      box.classList.remove("show","solution","hint","wrong");
      box.style.display = "none";
    }

    function showMsg(qid, mode, title, html){
      const box = document.getElementById("msg_"+qid);
      if(!box) return;
      const head = box.querySelector(".msgHead");
      const body = box.querySelector(".msgBody");
      head.textContent = title;
      body.innerHTML = html;

      box.style.display = "block";
      box.className = "msgBox show " + mode;
    }

    function getQuestion(qid){
      return QUESTIONS.find(q=>q.id===qid);
    }

    function doCheck(qid){
      const q = getQuestion(qid);
      if(!q) return;

      let res = null;
      if(q.inputType === "digitValues"){
        res = q.validate(q._inputs || {});
      } else {
        res = q.validate((q._value || "").trim());
      }

      q._checked = true;
      q._isCorrect = !!res.ok;

      if(res.ok){
        showMsg(qid, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : "Correct.");
      }else{
        const extra = res.msg ? `<div style="margin-bottom:8px;"><b>Note:</b> ${escapeHtml(res.msg)}</div>` : "";
        showMsg(qid, "wrong", "Solution", extra + (q.solutionHtml ? q.solutionHtml() : ""));
      }
    }

    function showHint(qid){
      const q = getQuestion(qid);
      if(!q) return;
      showMsg(qid, "hint", "Hint", q.hintHtml || "Think about lining up decimal points and place values.");
    }

    function doReveal(qid){
      const q = getQuestion(qid);
      if(!q) return;
      q._revealed = true;
      q._checked = true;
      q._isCorrect = true; // treat reveal as completed

      showMsg(qid, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : `Answer: ${q.answer}`);
      updateScoreIfSubmitted(false);
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    /***********************
     * Submit & score
     ***********************/
    function updateScoreIfSubmitted(forceShow){
      const submitted = forceShow || window.__submitted;
      if(!submitted) return;

      let correct = 0;
      let total = QUESTIONS.length;

      for(const q of QUESTIONS){
        // auto-check anything not checked yet
        if(!q._checked){
          let res = null;
          if(q.inputType === "digitValues"){
            res = q.validate(q._inputs || {});
          } else {
            res = q.validate((q._value || "").trim());
          }
          q._checked = true;
          q._isCorrect = !!res.ok;

          if(res.ok){
            showMsg(q.id, "solution", "Solution", q.solutionHtml ? q.solutionHtml() : "Correct.");
          }else{
            const extra = res.msg ? `<div style="margin-bottom:8px;"><b>Note:</b> ${escapeHtml(res.msg)}</div>` : "";
            showMsg(q.id, "wrong", "Solution", extra + (q.solutionHtml ? q.solutionHtml() : ""));
          }
        }

        if(q._isCorrect) correct++;
      }

      document.getElementById("scoreText").textContent = `Score: ${correct} / ${total}`;
    }

    /***********************
     * Export to PDF (questions first, answer key on a new page at the end)
     ***********************/
        function exportToPdfViaPrint(){
      const perPage = parseInt(document.getElementById("perPageSelect").value,10) || 4;
      const student = getStudentName();
      const today = new Date();
      const dateStr = today.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"});

      // Build ordered list (by PARTS then in list order)
      const ordered = [];
      PARTS.forEach(p=>{
        QUESTIONS.filter(q=>q.part===p.part).forEach(q=>ordered.push(q));
      });

      // Chunk into pages of exactly perPage questions (prevents "big blank space" caused by auto page wrapping)
      const pages = [];
      for(let i=0;i<ordered.length;i+=perPage){
        pages.push(ordered.slice(i, i+perPage));
      }

      function partLabel(partNo){
        const p = PARTS.find(x=>x.part===partNo);
        // keep it short in PDF
        if(!p) return `Part ${partNo}`;
        return `Part ${partNo}`;
      }

      function answerArea(q){
        // More working space for word problems
        if(q.inputType === "digitValues"){
          return `
            <table class="pv">
              <tr><th>Tens</th><th>Ones</th><th>Tenths</th><th>Hundredths</th><th>Thousandths</th></tr>
              <tr><td></td><td></td><td></td><td></td><td></td></tr>
            </table>
          `;
        }
        if(q.part>=4){
          return `<div class="line"></div><div class="line"></div>`;
        }
        return `<div class="line"></div>`;
      }

      const layoutClass = (perPage===9) ? "per9" : (perPage===3 ? "per3" : (perPage===4 ? "per4" : (perPage===6 ? "per6" : (perPage===8 ? "per8" : "per4"))));

      let html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Decimals Worksheet — DYAA</title>
  <style>
    @page{ margin: 14mm; }
    body{font-family:Arial, sans-serif; margin:0; color:#111;}
    .head{
      display:flex; justify-content:space-between; align-items:flex-end;
      gap:12px; border-bottom:2px solid #ddd; padding:0 0 8px 0; margin:0 0 10px 0;
    }
    .head h1{margin:0; font-size:15.5px;}
    .small{font-size:11.5px; color:#333; font-weight:700;}
    .meta{font-size:11.5px; font-weight:800; color:#111; text-align:right;}

    .page{page-break-after:always;}
    .page:last-child{page-break-after:auto;}

    .cards{display:grid; gap:10px;}
    .cards.per4{grid-template-columns:1fr 1fr; --cardH: 118mm;}
    .cards.per6{grid-template-columns:1fr 1fr; --cardH: 78mm;}
    .cards.per8{grid-template-columns:1fr 1fr; --cardH: 58mm;}
    .cards.per3{grid-template-columns:1fr;      --cardH: 82mm;}
    .cards.per9{grid-template-columns:1fr 1fr 1fr; --cardH: 78mm;}

    .qcard{
      border:1px solid #e6e6ef; border-radius:12px; padding:10px;
      height: var(--cardH);
      box-sizing:border-box;
      break-inside:avoid; page-break-inside:avoid;
      overflow:hidden;
    }
    .qtop{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;}
    .qn{font-weight:900; font-size:13px;}
    .chip{
      border:1px solid #e6e6ef; border-radius:999px; padding:4px 8px;
      font-size:10.5px; font-weight:900; background:#fff;
    }
    .qprompt{font-size:12px; line-height:1.35; margin:0 0 8px 0;}
    .qprompt b{font-weight:900;}
    .underline{
      text-decoration:underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 3px;
      font-weight:900;
    }
    .line{border-bottom:1px solid #111; height:18px; margin-top:10px;}
    table.pv{width:100%; border-collapse:collapse; margin-top:8px;}
    table.pv th, table.pv td{border:1px solid #ddd; padding:6px; font-size:10.5px; text-align:left;}
    table.pv th{background:#f7f7f7;}
    table.pv td{height:22px;}

    .ansKey h2{font-size:15px; margin:0 0 10px 0;}
    .ansRow{border-bottom:1px solid #eee; padding:6px 0; font-size:12px;}
    .ansRow b{display:inline-block; width:52px;}
  </style>
</head>
<body>
`;

      // Questions pages
      let globalNo = 0;

      pages.forEach((chunk, pageIdx)=>{
        html += `<div class="page">`;
        html += `
          <div class="head">
            <div>
              <h1>Decimals Worksheet — DYAA</h1>
              <div class="small">Student: ${escapeHtml(student)} &nbsp;&nbsp;|&nbsp;&nbsp; Date: ${escapeHtml(dateStr)}</div>
            </div>
            <div class="meta">Questions per page: ${perPage}</div>
          </div>
          <div class="cards ${layoutClass}">
        `;

        chunk.forEach(q=>{
          globalNo++;
          html += `
            <div class="qcard">
              <div class="qtop">
                <div class="qn">Q${globalNo}</div>
                <div class="chip">${escapeHtml(partLabel(q.part))}</div>
              </div>
              <div class="qprompt">${q.promptHtml || ""}</div>
              ${answerArea(q)}
            </div>
          `;
        });

        // fill blanks to keep grid shape (optional, but keeps pages visually consistent)
        const missing = perPage - chunk.length;
        for(let k=0;k<missing;k++){
          html += `<div class="qcard" aria-hidden="true"></div>`;
        }

        html += `</div></div>`;
      });

      // Answer key on a new page at the end
      html += `<div class="page"><div class="head">
          <div>
            <h1>Answer Key — Decimals (DYAA)</h1>
            <div class="small">Student: ${escapeHtml(student)} &nbsp;&nbsp;|&nbsp;&nbsp; Date: ${escapeHtml(dateStr)}</div>
          </div>
          <div class="meta">Answer Key</div>
        </div>
        <div class="ansKey">`;

      globalNo = 0;
      PARTS.forEach(p=>{
        const list = QUESTIONS.filter(q=>q.part===p.part);
        list.forEach(q=>{
          globalNo++;
          const ansText = (typeof q.answerKeyText === "function")
            ? q.answerKeyText()
            : (typeof q.answer === "string" ? q.answer : JSON.stringify(q.answer));
          html += `<div class="ansRow"><b>Q${globalNo}</b> ${escapeHtml(ansText)}</div>`;
        });
      });

      html += `</div></div></body></html>`;

      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(()=>w.print(), 300);
    }

    function stripHtml(html){
      // very simple strip for printing text-only prompt
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return (tmp.textContent || tmp.innerText || "").trim();
    }

    /***********************
     * New set confirm + reset
     ***********************/
    function openConfirm(){ document.getElementById("confirmBackdrop").classList.add("show"); }
    function closeConfirm(){ document.getElementById("confirmBackdrop").classList.remove("show"); }

    function generateNewSet(){
      window.__submitted = false;
      QUESTIONS = buildAllQuestions();
      renderPractice();
    }

    function resetAnswers(){
      window.__submitted = false;
      QUESTIONS.forEach(q=>{
        q._value = "";
        q._inputs = (q.inputType==="digitValues")
          ? {tens:"", ones:"", tenths:"", hundredths:"", thousandths:""}
          : null;
        q._checked = false;
        q._isCorrect = false;
        q._revealed = false;
      });
      renderPractice();
    }

    /***********************
     * Tabs
     ***********************/
    function setTab(which){
      const learnTab = document.getElementById("learnTab");
      const practiceTab = document.getElementById("practiceTab");
      const learnSection = document.getElementById("learnSection");
      const practiceSection = document.getElementById("practiceSection");

      if(which==="learn"){
        learnTab.classList.add("active");
        practiceTab.classList.remove("active");
        learnSection.classList.add("active");
        practiceSection.classList.remove("active");
      }else{
        practiceTab.classList.add("active");
        learnTab.classList.remove("active");
        practiceSection.classList.add("active");
        learnSection.classList.remove("active");
      }
    }

    /***********************
     * Init bindings
     ***********************/
    document.getElementById("learnTab").addEventListener("click", ()=>setTab("learn"));
    document.getElementById("practiceTab").addEventListener("click", ()=>setTab("practice"));

    document.getElementById("newSetBtn").addEventListener("click", openConfirm);
    document.getElementById("cancelNewSet").addEventListener("click", closeConfirm);
    document.getElementById("confirmNewSet").addEventListener("click", ()=>{
      closeConfirm();
      generateNewSet();
      setTab("practice");
    });
    document.getElementById("confirmBackdrop").addEventListener("click", (e)=>{
      if(e.target.id==="confirmBackdrop") closeConfirm();
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      setTab("practice");
      exportToPdfViaPrint();
    });

    document.getElementById("submitBtn").addEventListener("click", ()=>{
      window.__submitted = true;
      updateScoreIfSubmitted(true);
    });

    document.getElementById("resetBtn").addEventListener("click", resetAnswers);

    // Start
    initStudent();
    generateNewSet();
  </script>
</body>
</html>
