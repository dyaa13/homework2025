<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decimal Division (Decimal Point Shifts)</title>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .quiz-container {
      max-width: 900px;
      margin: 40px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    #headerLogo {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background-color: #0d47a1;
      border-radius: 6px;
    }

    .logo-text .brand {
      font-size: 1.1em;
      color: #0d47a1;
      font-weight: 900;
      letter-spacing: 1px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }

    #timerDisplay {
      font-size: 0.95em;
      color: #333;
    }

    #studentDisplay {
      font-size: 0.95em;
      color: #333;
      font-weight: 600;
    }

    .quiz-main {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 170px;
      border-right: 1px solid #ddd;
      padding-right: 10px;
      display: none;
    }

    .sidebar h4 {
      margin: 0 0 8px;
      font-size: 0.95em;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .sidebar li.active {
      outline: 2px solid #1976d2;
      font-weight: 600;
    }

    .sidebar li.answered {
      border-left: 4px solid #4caf50;
    }

    .sidebar li.correct {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }

    .sidebar li.incorrect {
      background: #f8d7da;
      border-left: 4px solid #f44336;
    }

    #quizContent {
      flex: 1;
    }

    .question-text {
      font-size: 1.1em;
      margin-bottom: 8px;
    }

    .instructions {
      font-size: 0.9em;
      color: #555;
      margin-top: 6px;
      margin-bottom: 12px;
    }

    .part-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .single-question {
      margin-top: 6px;
      margin-bottom: 6px;
      font-size: 1.15em;
      line-height: 1.25;
    }

    .answer-box {
      width: 160px;
      padding: 6px;
      font-size: 1em;
      margin-left: 10px;
    }

    .button-container {
      display: flex;
      justify-content: flex-start;
      margin-top: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 20px;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
    }

    #nextButton { background:#4caf50; }
    #backButton { background:#039be5; }
    #generateButton { background:#ff9800; }
    #submitButton { background:#9c27b0; }
    #saveButton { background:#607d8b; }
    #pauseButton { background:#f57c00; }
    #checkButton { background:#455a64; }
    #exportPdfButton { background:#1976d2; }

    table.review-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .review-table th,
    .review-table td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 0.85em;
      text-align: center;
    }

    .review-table th {
      background: #f2f2f2;
    }

    .correct-answer { background: #d4edda; }
    .incorrect-answer { background: #f8d7da; }

    /* Stacked fraction */
    .frac {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      line-height: 1;
      transform: translateY(-1px);
    }

    .frac .top {
      display: block;
      border-bottom: 1px solid #000;
      padding: 0 2px 1px;
    }

    .frac .bottom {
      display: block;
      padding: 1px 2px 0;
      font-size: 0.9em;
    }

    .mix {
      display: inline-flex;
      align-items: center;
      gap: 0;
    }

    .status-line {
      font-size: 0.9em;
      margin-top: 6px;
    }
    .status-ok {
      color:#2e7d32;
      font-weight:600;
    }
    .status-bad {
      color:#c62828;
      font-weight:600;
    }

    @media (max-width: 700px) {
      .quiz-main { flex-direction: column; }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
        padding-bottom: 10px;
      }
    }

    /* Modal (Export to PDF) */
    .modal-overlay{
      position:fixed;
      left:0; top:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(420px, 92vw);
      background:#fff;
      border-radius:12px;
      padding:18px 18px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
    }
    .modal h3{
      margin:0 0 12px;
      font-size:1.1em;
    }
    .modal-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:10px 0;
      font-size:0.95em;
    }
    .modal-row label{ color:#333; font-weight:600; }
    .modal-row select{
      width:160px;
      padding:7px 10px;
      border:1px solid #ccc;
      border-radius:8px;
      font-size:0.95em;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:14px;
    }
    .modal-btn{
      padding:8px 16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      color:#fff;
      font-size:0.95em;
    }
    .modal-btn.secondary{ background:#607d8b; }
    .modal-btn.primary{ background:#1976d2; }

    /* Hidden PDF render root (off-screen) */
    #pdfRenderRoot{
      position:fixed;
      left:-9999px;
      top:-9999px;
      width:210mm;
      background:#fff;
    }

    /* PDF page layout */
    .pdf-page{
      width:210mm;
      height:297mm;
      box-sizing:border-box;
      padding:10mm 10mm 8mm;
      background:#fff;
      color:#222;
      font-family:'Segoe UI', Tahoma, sans-serif;
    }
    .pdf-page.compact{
      padding:7mm 7mm 6mm;
    }
    .pdf-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom:2px solid #e0e0e0;
      padding-bottom:5px;
      margin-bottom:8px;
    }
    .pdf-page.compact .pdf-header{
      padding-bottom:4px;
      margin-bottom:6px;
    }
    .pdf-brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .pdf-brand .pdf-brand-name{
      font-weight:900;
      color:#0d47a1;
      letter-spacing:1px;
    }
    .pdf-title{
      font-size:13pt;
      font-weight:700;
      margin:0;
    }
    .pdf-ts{
      font-size:9pt;
      font-weight:600;
      color:#555;
      margin-left:6px;
    }
    .pdf-page.compact .pdf-title{
      font-size:11pt;
    }
    .pdf-page.compact .pdf-ts{
      font-size:8pt;
      margin-left:6px;
    }
    .pdf-meta{
      font-size:9.5pt;
      text-align:right;
      color:#333;
    }
    .pdf-page.compact .pdf-meta{
      font-size:8.2pt;
    }
    .pdf-grid{
      display:flex;
      flex-wrap:wrap;
      gap:5mm;
    }
    .pdf-grid.compact{
      gap:2.6mm;
    }
    .pdf-card{
      flex:0 0 calc(50% - 2.5mm);
      border:1px solid #cfcfcf;
      border-radius:10px;
      padding:4.5mm;
      box-sizing:border-box;
      min-height:50mm;
      display:flex;
      flex-direction:column;
    }
    .pdf-grid.cols-3 .pdf-card{ flex-basis: calc(33.333% - 3.4mm); }
    .pdf-grid.cols-4 .pdf-card{ flex-basis: calc(25% - 3.4mm); }

    .pdf-page.compact .pdf-card{
      padding:3mm;
      border-radius:8px;
      min-height:50mm;
      display:flex;
      flex-direction:column;
    }
    .pdf-qnum{
      font-weight:700;
      margin-bottom:3px;
      font-size:10pt;
    }
    .pdf-page.compact .pdf-qnum{
      font-size:9pt;
      margin-bottom:2px;
    }
    .pdf-qtext{
      font-size:11pt;
      line-height:1.15;
      margin-bottom:4mm;
      word-break:break-word;
    }
    .pdf-page.compact .pdf-qtext{
      font-size:9.5pt;
      line-height:1.1;
      margin-bottom:2.4mm;
    }
    .pdf-write-space{
      margin-top:auto;
      min-height:22mm;
    }
    .pdf-page.compact .pdf-write-space{
      min-height:22mm;
    }

    .pdf-answer{ display:none; }
    .pdf-page.compact /* fraction size inside PDF */
    .pdf-card .frac{ font-size:1em; }
    .pdf-card .frac .top{ padding:0 2px; }
    .pdf-card .frac .bottom{ font-size:0.9em; }

    /* Answer key */
    .pdf-answerkey{
      margin-top:2mm;
    }
    .pdf-answerkey-title{
      font-size:14pt;
      font-weight:800;
      margin:0 0 4mm;
    }
    .pdf-page.compact .pdf-answerkey-title{
      font-size:12pt;
      margin-bottom:3mm;
    }
    .pdf-ans-grid{
      display:flex;
      flex-wrap:wrap;
      column-gap:6mm;
      row-gap:2mm;
    }
    .pdf-ans-item{
      flex:0 0 calc(50% - 3mm);
      font-size:11pt;
      line-height:1.2;
      word-break:break-word;
    }
    .pdf-page.compact .pdf-ans-item{
      font-size:10pt;
    }
    .pdf-ans-num{
      font-weight:700;
      margin-right:4px;
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon" aria-hidden="true"></div>
    <div class="logo-text">
      <div class="brand">DYAA</div>
    </div>
  </div>

  <div class="top-bar">
    <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentDisplay" style="display:none;">Student: DYAA</div>
    </div>
    <div>
      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="generateButton" style="display:none;">Generate New Set</button>
      <button id="exportPdfButton" style="display:none;">Export to PDF</button>
    </div>
  </div>

  <h2>Decimal Division (Decimal Point Shifts)</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <div class="button-container">
    <button id="saveButton" style="display:none;">Save Current Result</button>
  </div>
</div>

<!-- Export to PDF Modal + Hidden Render Root -->
<div id="pdfModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h3>Export to PDF</h3>

    <div class="modal-row">
      <label for="pdfTotalSelect">Total questions</label>
      <select id="pdfTotalSelect">
        <option value="15" selected>15</option>
        <option value="30">30</option>
      </select>
    </div>

    <div style="font-size:0.9em; color:#555; margin-top:6px;">
      Fixed layout: <strong>15</strong> questions per page (<strong>3 columns</strong>). Extra questions continue on the next page.
    </div>

    <div class="modal-actions">
      <button id="pdfCancelBtn" class="modal-btn secondary" type="button">Cancel</button>
      <button id="pdfExportBtn" class="modal-btn primary" type="button">Export</button>
    </div>
  </div>
</div>

<div id="pdfRenderRoot" aria-hidden="true"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */
const TITLE = "Decimal Division (Decimal Point Shifts)";
const NUM_QUESTIONS = 20;




/* ----------------------------------------------------------
   Helpers
---------------------------------------------------------- */
function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function choice(arr) { return arr[randInt(0, arr.length - 1)]; }

function gcd(a, b) {
  a = Math.abs(a); b = Math.abs(b);
  while (b !== 0) { const t = b; b = a % b; a = t; }
  return a === 0 ? 1 : a;
}

function simplifyFraction(fr) {
  if (fr.d < 0) { fr.n = -fr.n; fr.d = -fr.d; }
  const g = gcd(fr.n, fr.d);
  fr.n /= g; fr.d /= g;
  return fr;
}

function mulFrac(a, b) {
  return simplifyFraction({ n: a.n * b.n, d: a.d * b.d });
}

function fracToValue(fr) { return fr.n / fr.d; }

function fracToString(fr) {
  fr = simplifyFraction({ n: fr.n, d: fr.d });
  if (fr.d === 1) return String(fr.n);
  return `${fr.n}/${fr.d}`;
}

function fracToHtml(fr) {
  fr = simplifyFraction({ n: fr.n, d: fr.d });
  if (fr.d === 1) return String(fr.n);
  return `<span class="frac"><span class="top">${fr.n}</span><span class="bottom">${fr.d}</span></span>`;
}

function mixedToImproper(whole, frac) {
  // whole is positive integer; frac is proper positive
  return simplifyFraction({ n: whole * frac.d + frac.n, d: frac.d });
}

function mixedToHtml(whole, frac) {
  return `<span class="mix"><span>${whole}</span>${fracToHtml(frac)}</span>`;
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#39;"
  }[m]));
}

/* ----------------------------------------------------------
   Answer parsing (supports: integer, decimal, a/b, a b/c, optional leading -)
---------------------------------------------------------- */
function parseAnswer(str) {
  let s = (str || "").trim();
  if (s === "") return NaN;

  let sign = 1;
  if (s[0] === "+") s = s.slice(1).trim();
  else if (s[0] === "-") { sign = -1; s = s.slice(1).trim(); }
  if (s === "") return NaN;

  const parts = s.split(/\s+/);
  // mixed number: "a b/c"
  if (parts.length === 2 && parts[1].includes("/")) {
    const whole = Number(parts[0]);
    const f = parts[1].split("/");
    if (f.length !== 2) return NaN;
    const num = Number(f[0]);
    const den = Number(f[1]);
    if (!Number.isFinite(whole) || !Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;
    const value = Math.abs(whole) + (num / den);
    return sign * (whole < 0 ? -value : value);
  }

  if (s.includes("/")) {
    const f = s.split("/");
    if (f.length !== 2) return NaN;
    const num = Number(f[0]);
    const den = Number(f[1]);
    if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;
    return sign * (num / den);
  }

  const n = Number(s);
  return Number.isFinite(n) ? sign * n : NaN;
}

function nearlyEqual(a, b, eps = 1e-8) {
  if (!Number.isFinite(a) || !Number.isFinite(b)) return false;
  return Math.abs(a - b) < eps;
}

/* ---------------/* ----------------------------------------------------------
   Question generator (decimal division — shift focus)
   Goal: minimal arithmetic load, mainly decimal point shifting.
---------------------------------------------------------- */
function pickDp() { return Math.random() < 0.72 ? 1 : 2; } // mostly 1dp

function randDecimalInt(dp, min = 0.1, max = 99.99) {
  const scale = dp === 1 ? 10 : 100;
  const lo = Math.ceil(min * scale);
  const hi = Math.floor(max * scale);

  for (let t = 0; t < 900; t++) {
    const v = randInt(lo, hi);
    if (v % scale === 0) continue; // avoid .0 / .00
    return { int: v, dp };
  }
  return { int: lo + 1, dp };
}

function scaledToString(n, dp) {
  dp = Math.max(0, Math.trunc(dp));
  let sign = "";
  if (n < 0) { sign = "-"; n = Math.abs(n); }
  n = Math.trunc(n);

  if (dp === 0) return sign + String(n);

  let s = String(n);
  while (s.length <= dp) s = "0" + s;

  const cut = s.length - dp;
  let out = s.slice(0, cut) + "." + s.slice(cut);
  out = out.replace(/\.?0+$/, ""); // trim trailing zeros and dot
  return sign + out;
}

function scaledToNumber(n, dp) {
  return n / Math.pow(10, dp);
}

function makeScaledQuestion(textHtml, n, dp) {
  const ansStr = scaledToString(n, dp);
  return {
    textHtml,
    answerValue: scaledToNumber(n, dp),
    answerText: ansStr,
    answerHtml: escapeHtml(ansStr)
  };
}

const SHIFT_DIVISORS = [
  { int: 2, dp: 1, label: "0.2" },
  { int: 3, dp: 2, label: "0.03" },
  { int: 4, dp: 4, label: "0.0004" },
  { int: 5, dp: 2, label: "0.05" },
  { int: 8, dp: 2, label: "0.08" },
  { int: 9, dp: 1, label: "0.9" }
];

/* ---- Types ---- */
function makeDivByPow10() {
  const pow = choice([10, 100, 1000]);
  // Keep answers to at most 3 decimal places (shift practice, not long decimals)
  // If dividing by 1000 -> use an integer dividend (dp=0) so answer has 3 dp.
  // If dividing by 100  -> use 1dp dividend so answer has 3 dp.
  // If dividing by 10   -> use 1–2dp dividend so answer has 2–3 dp.
  let dp;
  if (pow === 1000) dp = 0;
  else if (pow === 100) dp = 1;
  else dp = pickDp();

  let a;
  if (dp === 0) {
    const v = randInt(1, 999);
    a = { int: v, dp: 0 };
  } else {
    const maxA = (pow === 1000) ? 99.9 : 999.9;
    a = randDecimalInt(dp, 0.2, maxA);
  }

  const aStr = scaledToString(a.int, a.dp);
  const k = pow === 10 ? 1 : (pow === 100 ? 2 : 3);
  return makeScaledQuestion(`${aStr} ÷ ${pow}`, a.int, a.dp + k);
}


function makeDivBySmallPow10() {
  // Divide by 0.1 / 0.01 / 0.001 (shifts decimal right)
  const opts = [
    { k: 1, label: "0.1" },
    { k: 2, label: "0.01" },
    { k: 3, label: "0.001" }
  ];
  const o = choice(opts);

  // Keep results reasonable (avoid huge numbers) while still practising shifting
  let a;
  if (o.k === 3) {
    // use 2dp and small dividend so answer is still easy
    a = randDecimalInt(2, 0.11, 0.99);
  } else if (o.k === 2) {
    a = randDecimalInt(pickDp(), 0.2, 9.99);
  } else {
    a = randDecimalInt(pickDp(), 0.2, 99.99);
  }

  const aStr = scaledToString(a.int, a.dp);

  // (aInt/10^dp) ÷ (1/10^k) = aInt*10^k / 10^dp
  const ansInt = a.int * Math.pow(10, o.k);
  return makeScaledQuestion(`${aStr} ÷ ${o.label}`, ansInt, a.dp);
}


function makeDecDivInt() {
  // Decimal ÷ Integer with tidy answers (construct dividend = answer × divisor)
  const b = randInt(2, 9);
  const rDp = pickDp();
  const rMax = (rDp === 2) ? 49.99 : 99.9;
  const r = randDecimalInt(rDp, 0.2, rMax);

  const aInt = r.int * b;
  const aDp = r.dp;

  const aStr = scaledToString(aInt, aDp);
  const rStr = scaledToString(r.int, r.dp);

  return {
    textHtml: `${aStr} ÷ ${b}`,
    answerValue: scaledToNumber(r.int, r.dp),
    answerText: rStr,
    answerHtml: escapeHtml(rStr)
  };
}

function makeDecDivDecShift() {
  // Decimal ÷ easy decimal (<1) to practise shifting
  const d = choice(SHIFT_DIVISORS);

  // Choose a simple quotient (integer or 1dp)
  const qIsInt = Math.random() < 0.65;
  const qDp = qIsInt ? 0 : 1;
  const qMax = qIsInt ? 60 : 30.0;

  // Build q as scaled int
  const qScale = qDp === 0 ? 1 : 10;
  const qInt = randInt(2 * qScale, Math.floor(qMax * qScale));
  const qStr = scaledToString(qInt, qDp);

  // dividend = q × divisor
  const aInt = qInt * d.int;
  const aDp = qDp + d.dp;
  const aStr = scaledToString(aInt, aDp);

  return {
    textHtml: `${aStr} ÷ ${d.label}`,
    answerValue: scaledToNumber(qInt, qDp),
    answerText: qStr,
    answerHtml: escapeHtml(qStr)
  };
}

function makeMakeDivisorWhole() {
  // Make the divisor a whole number by multiplying both numbers (classic method)
  // Example: 18 ÷ 1.2  -> 180 ÷ 12
  const dp = Math.random() < 0.7 ? 1 : 2;
  const factor = dp === 1 ? 10 : 100;

  // Choose an integer divisor D (so divisor = D/factor is a decimal)
  const D = randInt(12, 90);
  const divisorStr = scaledToString(D, dp);

  // Choose an easy integer quotient Q
  const Q = randInt(3, 60);
  const dividendInt = D * Q;
  const dividendStr = scaledToString(dividendInt, dp);

  // Ensure dividend stays within a sensible range (avoid too many digits)
  if (dividendInt / factor > 999.99) {
    const Q2 = randInt(3, 30);
    const dividendInt2 = D * Q2;
    const dividendStr2 = scaledToString(dividendInt2, dp);
    return {
      textHtml: `${dividendStr2} ÷ ${divisorStr}`,
      answerValue: Q2,
      answerText: String(Q2),
      answerHtml: escapeHtml(String(Q2))
    };
  }

  return {
    textHtml: `${dividendStr} ÷ ${divisorStr}`,
    answerValue: Q,
    answerText: String(Q),
    answerHtml: escapeHtml(String(Q))
  };
}

/* ---- Type plan (mostly shifting) ---- */
function makeTypePlan(total) {
  const buckets = [
    // Fewer pure ÷10/÷0.1 style questions; more practical shift-friendly division.
    { t: "p10",   w: 0.09, min: 1 }, // ÷10/100/1000 (few)
    { t: "d10",   w: 0.09, min: 1 }, // ÷0.1/0.01/0.001 (few)
    { t: "dxi",   w: 0.30, min: 4 }, // decimal ÷ integer (shift-friendly)
    { t: "dxd",   w: 0.40, min: 6 }, // decimal ÷ easy decimal (e.g., ÷0.2, ÷0.05)
    { t: "whole", w: 0.12, min: 1 }  // make divisor whole number
  ];

  const counts = {};
  let sum = 0;

  buckets.forEach(b => {
    const c = Math.max(b.min, Math.round(total * b.w));
    counts[b.t] = c;
    sum += c;
  });

  while (sum > total) {
    let best = null;
    let bestExcess = -1;
    buckets.forEach(b => {
      const excess = counts[b.t] - b.min;
      if (excess > bestExcess) { bestExcess = excess; best = b; }
    });
    if (!best || bestExcess <= 0) break;
    counts[best.t]--;
    sum--;
  }

  const addOrder = ["dxd", "dxi", "whole", "p10", "d10"];
  let idx = 0;
  while (sum < total) {
    counts[addOrder[idx % addOrder.length]]++;
    idx++;
    sum++;
  }

  const plan = [];
  Object.keys(counts).forEach(t => plan.push(...Array(counts[t]).fill(t)));

  for (let i = plan.length - 1; i > 0; i--) {
    const j = randInt(0, i);
    const tmp = plan[i]; plan[i] = plan[j]; plan[j] = tmp;
  }
  return plan.slice(0, total);
}

function generateOneQuestion(preferredType = null) {
  const type = preferredType || choice(["dxd","dxi","dxd","dxi","whole","p10","d10"]);
  if (type === "p10") return makeDivByPow10();
  if (type === "d10") return makeDivBySmallPow10();
  if (type === "dxi") return makeDecDivInt();
  if (type === "dxd") return makeDecDivDecShift();
  return makeMakeDivisorWhole();
}

/* ----------------------------------------------------------
   QueryString name
---------------------------------------------------------- */
function getNameFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get("name");
  if (!raw) return null;
  const name = raw.trim();
  return name ? name : null;
}

/* ----------------------------------------------------------
   Global state (timer)
---------------------------------------------------------- */
let questions = [];
let currentQuestionIndex = 0;
let studentName = "DYAA";
let quizStartTime = null;
let quizEndTime = null;
let quizSubmitted = false;

let timerInterval = null;
let elapsedMs = 0;
let isPaused = false;
let firstAttemptMs = null;

const quizContent   = document.getElementById("quizContent");
const sidebarEl     = document.getElementById("sidebar");
const saveButton    = document.getElementById("saveButton");
const generateBtn   = document.getElementById("generateButton");
const pauseButton   = document.getElementById("pauseButton");
const timerDisplay  = document.getElementById("timerDisplay");
const exportPdfButton = document.getElementById("exportPdfButton");

const pdfModal        = document.getElementById("pdfModal");
const pdfTotalSelect  = document.getElementById("pdfTotalSelect");
const pdfCancelBtn    = document.getElementById("pdfCancelBtn");
const pdfExportBtn    = document.getElementById("pdfExportBtn");
const pdfRenderRoot   = document.getElementById("pdfRenderRoot");

function updateStudentDisplay() {
  const el = document.getElementById("studentDisplay");
  el.style.display = "inline-block";
  el.textContent = `Student: ${studentName}`;
}

/* ----------------------------------------------------------
   Timer
---------------------------------------------------------- */
function formatMs(ms) {
  const totalSec = Math.floor(ms / 1000);
  const min = Math.floor(totalSec / 60);
  const sec = totalSec % 60;
  return `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

function updateTimerDisplay() {
  let totalMs = elapsedMs;
  if (!isPaused && quizStartTime) totalMs += (new Date() - quizStartTime);
  let text = `Time: ${formatMs(totalMs)}`;
  if (firstAttemptMs !== null) text += ` (First: ${formatMs(firstAttemptMs)})`;
  timerDisplay.textContent = text;
}

function startTimerInterval() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay, 1000);
}

function pauseTimer() {
  if (isPaused || !quizStartTime) return;
  const now = new Date();
  elapsedMs += now - quizStartTime;
  isPaused = true;
  quizStartTime = null;
  updateTimerDisplay();
}

function resumeTimer() {
  if (!isPaused) return;
  isPaused = false;
  quizStartTime = new Date();
  updateTimerDisplay();
}

/* ----------------------------------------------------------
   Generate quiz (avoid duplicates)
---------------------------------------------------------- */
function generateQuiz() {
  questions = [];
  quizSubmitted = false;

  const seen = new Set();
  const plan = makeTypePlan(NUM_QUESTIONS);

  for (let i = 0; i < NUM_QUESTIONS; i++) {
    let guard = 0;
    while (guard < 500) {
      guard++;
      const q = generateOneQuestion(plan[i]);
      const key = q.textHtml.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
      if (seen.has(key)) continue;
      seen.add(key);

      questions.push({
        index: questions.length,
        textHtml: q.textHtml,
        value: q.answerValue,
        display: q.answerText,
        displayHtml: q.answerHtml,
        userValue: "",
        isCorrect: false
      });
      break;
    }

    // Fallback: if we couldn't fill this slot, use any type
    if (questions.length < i + 1) {
      let g2 = 0;
      while (g2 < 600) {
        g2++;
        const q = generateOneQuestion();
        const key = q.textHtml.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
        if (seen.has(key)) continue;
        seen.add(key);

        questions.push({
          index: questions.length,
          textHtml: q.textHtml,
          value: q.answerValue,
          display: q.answerText,
          displayHtml: q.answerHtml,
          userValue: "",
          isCorrect: false
        });
        break;
      }
    }
  }
}

/* ----------------------------------------------------------
   Sidebar
---------------------------------------------------------- */
function renderSidebar() {
  sidebarEl.style.display = "block";
  sidebarEl.innerHTML = `<h4>Questions</h4><ul id="qList"></ul>`;
  const ul = document.getElementById("qList");

  for (let i = 0; i < questions.length; i++) {
    const li = document.createElement("li");
    li.textContent = `Q${i + 1}`;
    li.dataset.index = i;

    li.addEventListener("click", () => {
      saveCurrentInput();
      currentQuestionIndex = i;
      renderQuestion();
    });

    ul.appendChild(li);
  }

  updateSidebarStatus();
}

function updateSidebarStatus() {
  const items = document.querySelectorAll("#qList li");
  items.forEach(li => {
    const idx = Number(li.dataset.index);
    const q = questions[idx];

    li.classList.remove("active","answered","correct","incorrect");
    li.classList.toggle("active", idx === currentQuestionIndex);

    if (!quizSubmitted) {
      if ((q.userValue || "").trim() !== "") li.classList.add("answered");
    } else {
      if ((q.userValue || "").trim() !== "") {
        li.classList.add(q.isCorrect ? "correct" : "incorrect");
      }
    }
  });
}

/* ----------------------------------------------------------
   Render single question
---------------------------------------------------------- */
function saveCurrentInput() {
  const input = document.getElementById("answerInput");
  if (input) questions[currentQuestionIndex].userValue = input.value.trim();
}

const backButton   = document.createElement("button");
backButton.id = "backButton";
backButton.textContent = "Previous";

const nextButton   = document.createElement("button");
nextButton.id = "nextButton";
nextButton.textContent = "Next";

const submitButton = document.createElement("button");
submitButton.id = "submitButton";
submitButton.textContent = "Submit & View Results";

const checkButton  = document.createElement("button");
checkButton.id = "checkButton";
checkButton.textContent = "Check Answer";

backButton.style.background = "#039be5";
nextButton.style.background = "#4caf50";
submitButton.style.background = "#9c27b0";
checkButton.style.background = "#455a64";

function renderQuestion() {
  const q = questions[currentQuestionIndex];

  quizContent.innerHTML = `
    <p class="question-text">Question ${currentQuestionIndex + 1} of ${questions.length}</p>

    <div class="part-title">Solve.</div>

    <div class="single-question">
      Q${currentQuestionIndex + 1}. ${q.textHtml}
      <input id="answerInput" class="answer-box" type="text" value="${escapeHtml(q.userValue || "")}">
    </div>

    <p id="statusLine" class="status-line">Status: <span>—</span></p>

    <p class="instructions">
      Enter your answer as a number (decimals allowed). Do <strong>not</strong> round your answer.
    </p>
  `;

  const btnBar = document.createElement("div");
  btnBar.className = "button-container";

  btnBar.appendChild(backButton);
  btnBar.appendChild(nextButton);

  if (currentQuestionIndex === questions.length - 1) btnBar.appendChild(submitButton);
  if (quizSubmitted) btnBar.appendChild(checkButton);

  quizContent.appendChild(btnBar);

  backButton.style.visibility = currentQuestionIndex === 0 ? "hidden" : "visible";
  nextButton.style.visibility = currentQuestionIndex === questions.length - 1 ? "hidden" : "visible";

  updateSidebarStatus();
}

/* ----------------------------------------------------------
   Results
---------------------------------------------------------- */
function calculateAndShowResults() {
  saveCurrentInput();
  const now = new Date();

  let attemptMs = elapsedMs;
  if (!isPaused && quizStartTime) attemptMs += now - quizStartTime;
  if (firstAttemptMs === null) firstAttemptMs = attemptMs;

  const attemptStart = quizStartTime || now;
  quizEndTime = now;

  quizSubmitted = true;

  let correctCount = 0;
  questions.forEach(q => {
    const val = parseAnswer(q.userValue || "");
    q.isCorrect = nearlyEqual(val, q.value);
    if (q.isCorrect) correctCount++;
  });

  updateSidebarStatus();

  const min = Math.floor(attemptMs / 60000);
  const sec = Math.floor((attemptMs % 60000) / 1000);

  let html = `
    <h3>Results for ${escapeHtml(studentName)}</h3>
    <p>Score: <strong>${correctCount} / ${questions.length}</strong></p>
    <p>Start time: <strong>${attemptStart.toLocaleTimeString()}</strong></p>
    <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
    <p>Time taken (this attempt): <strong>${min}m ${sec}s</strong></p>
    <p>First attempt time: <strong>${formatMs(firstAttemptMs)}</strong></p>
    <p>You can click any question on the left to review and use <strong>Check Answer</strong>.</p>

    <table class="review-table">
      <tr>
        <th>#</th>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct</th>
        <th>Result</th>
      </tr>
  `;

  questions.forEach((q, i) => {
    html += `
      <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
        <td>${i + 1}</td>
        <td>${q.textHtml}</td>
        <td>${escapeHtml(q.userValue || "—")}</td>
        <td>${q.displayHtml}</td>
        <td>${q.isCorrect ? "Correct" : "Incorrect"}</td>
      </tr>
    `;
  });

  html += `</table>`;
  quizContent.innerHTML = html;

  saveButton.style.display = "inline-block";

  // Restart timer for re-check practice
  elapsedMs = 0;
  isPaused = false;
  quizStartTime = new Date();
  pauseButton.textContent = "Pause";
  startTimerInterval();
  updateTimerDisplay();
}

function checkCurrentQuestion() {
  if (!quizSubmitted) return;

  saveCurrentInput();
  const q = questions[currentQuestionIndex];
  const statusLine = document.getElementById("statusLine");
  if (!statusLine) return;

  if ((q.userValue || "").trim() === "") {
    statusLine.innerHTML = 'Status: <span class="status-bad">No answer</span>';
    return;
  }

  const val = parseAnswer(q.userValue || "");
  if (!Number.isFinite(val)) {
    statusLine.innerHTML = 'Status: <span class="status-bad">Invalid input</span>';
    return;
  }

  if (nearlyEqual(val, q.value)) {
    q.isCorrect = true;
    statusLine.innerHTML = 'Status: <span class="status-ok">Correct</span>';
  } else {
    q.isCorrect = false;
    statusLine.innerHTML = 'Status: <span class="status-bad">Incorrect</span>';
  }

  updateSidebarStatus();
}

/* ----------------------------------------------------------
   Save result
---------------------------------------------------------- */
function formatDateForFilename(date) {
  if (!date) return "no_time";
  const pad = n => String(n).padStart(2, "0");
  return (
    date.getFullYear() +
    pad(date.getMonth() + 1) +
    pad(date.getDate()) + "_" +
    pad(date.getHours()) +
    pad(date.getMinutes()) +
    pad(date.getSeconds())
  );
}

function saveCurrentResultAsTxt() {
  saveCurrentInput();

  if (!quizSubmitted) {
    questions.forEach(q => {
      const val = parseAnswer(q.userValue || "");
      q.isCorrect = nearlyEqual(val, q.value);
    });
  }

  let correctCount = 0;
  questions.forEach(q => { if (q.isCorrect) correctCount++; });

  const lines = [];
  lines.push(TITLE + " - Current Result");
  lines.push("Student: " + studentName);
  if (quizEndTime) lines.push("Last submit time: " + quizEndTime.toLocaleString());
  lines.push("Score: " + correctCount + " / " + questions.length);
  if (firstAttemptMs !== null) lines.push("First attempt time: " + formatMs(firstAttemptMs));
  lines.push("");
  lines.push("Details:");
  lines.push("----------");

  questions.forEach((q, i) => {
    const plainQuestion = q.textHtml.replace(/<[^>]+>/g,"");
    const userAns = (q.userValue || "").trim() === "" ? "Not answered" : q.userValue;
    const resultText = (q.userValue || "").trim() === "" ? "Not answered" : (q.isCorrect ? "Correct" : "Incorrect");

    lines.push(
      `Q${i + 1}` +
      "\nQuestion: " + plainQuestion +
      "\nYour answer: " + userAns +
      "\nCorrect answer: " + q.display +
      "\nResult: " + resultText
    );
    lines.push("");
  });

  const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = (studentName || "DYAA").replace(/[^a-z0-9_\-]/gi, "_") || "DYAA";
  const ts = formatDateForFilename(new Date());
  a.href = url;
  a.download = `DecimalDiv_${safeName}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ----------------------------------------------------------
   Button events
---------------------------------------------------------- */
nextButton.addEventListener("click", () => {
  saveCurrentInput();
  if (currentQuestionIndex < questions.length - 1) {
    currentQuestionIndex++;
    renderQuestion();
  }
});

backButton.addEventListener("click", () => {
  saveCurrentInput();
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    renderQuestion();
  }
});

submitButton.addEventListener("click", calculateAndShowResults);
checkButton.addEventListener("click", checkCurrentQuestion);
saveButton.addEventListener("click", saveCurrentResultAsTxt);

pauseButton.addEventListener("click", () => {
  if (!quizStartTime && elapsedMs === 0 && !quizSubmitted) return;
  if (isPaused) { resumeTimer(); pauseButton.textContent = "Pause"; }
  else { pauseTimer(); pauseButton.textContent = "Resume"; }
});

generateBtn.addEventListener("click", () => {
  if (!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;

  if (timerInterval) clearInterval(timerInterval);
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;
  quizStartTime = new Date();
  quizEndTime = null;
  updateTimerDisplay();
  startTimerInterval();
  pauseButton.style.display = "inline-block";
  pauseButton.textContent = "Pause";

  generateQuiz();
  currentQuestionIndex = 0;

  renderSidebar();
  renderQuestion();
  saveButton.style.display = "none";
});

/* ----------------------------------------------------------
   Start screen
---------------------------------------------------------- */
function showStartScreen() {
  sidebarEl.style.display = "none";
  saveButton.style.display = "none";
  pauseButton.style.display = "none";
  generateBtn.style.display = "none";
  exportPdfButton.style.display = "none";

  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  elapsedMs = 0; isPaused = false; firstAttemptMs = null;
  quizStartTime = null; quizEndTime = null;
  updateTimerDisplay();

  quizContent.innerHTML = `
    <p>This practice set contains <strong>${NUM_QUESTIONS}</strong> questions on <strong>decimal multiplication</strong>: multiplying by <strong>powers of 10</strong> (10, 100, 1000), <strong>negative powers of 10</strong> (0.1, 0.01, 0.001), <strong>decimal × integer</strong>, <strong>decimal × decimal</strong>, and using the <strong>distributive</strong> and <strong>associative</strong> laws. Most decimal multipliers are easy shift values like <strong>0.2</strong>, <strong>0.03</strong>, <strong>0.0004</strong>, <strong>0.05</strong>, <strong>0.08</strong>, and <strong>0.9</strong>.</p>
    <p>Please enter your name to begin:</p>

    <input id="nameInput"
           type="text"
           style="padding:10px; width:250px; font-size:1.05em;"
           placeholder="DYAA"
           value="DYAA">

    <button id="startButton"
            style="margin-left:10px; background:#4caf50; padding:10px 20px; color:white; border:none; border-radius:6px;">
      Start
    </button>
  `;

  document.getElementById("startButton").addEventListener("click", startQuizFromInput);
}

function startQuizCommon() {
  updateStudentDisplay();

  quizStartTime = new Date();
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;

  updateTimerDisplay();
  startTimerInterval();

  generateQuiz();
  currentQuestionIndex = 0;

  renderSidebar();
  renderQuestion();

  generateBtn.style.display = "inline-block";
  pauseButton.style.display = "inline-block";
  exportPdfButton.style.display = "inline-block";
  pauseButton.textContent = "Pause";
  saveButton.style.display = "none";
}

function startQuizFromInput() {
  const nameInput = document.getElementById("nameInput");
  studentName = (nameInput.value || "DYAA").trim() || "DYAA";
  startQuizCommon();
}

function startQuizFromUrlName(name) {
  studentName = (name || "DYAA").trim() || "DYAA";
  startQuizCommon();
}

/* ----------------------------------------------------------
   Export to PDF
---------------------------------------------------------- */
function openPdfModal() {
  pdfModal.style.display = "flex";
}
function closePdfModal() { pdfModal.style.display = "none"; }

function buildPdfQuestionSet(total) {
  const out = [];
  const seen = new Set();

  const plan = makeTypePlan(total);

  for (let i = 0; i < total; i++) {
    let guard = 0;
    while (guard < 500) {
      guard++;
      const q = generateOneQuestion(plan[i]);
      const key = q.textHtml.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
      if (seen.has(key)) continue;
      seen.add(key);

      out.push({
        number: i + 1,
        textHtml: q.textHtml,
        answerHtml: q.answerHtml
      });
      break;
    }

    // Fallback: if we somehow couldn't fill this slot, use any type
    if (out.length < i + 1) {
      let g2 = 0;
      while (g2 < 600) {
        g2++;
        const q = generateOneQuestion();
        const key = q.textHtml.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push({ number: i + 1, textHtml: q.textHtml, answerHtml: q.answerHtml });
        break;
      }
    }
  }

  return out;
}

function renderPdfAllPages(questionSet, total, ts) {
  pdfRenderRoot.innerHTML = "";
  const pages = [];

  const perPage = 15;          // fixed
  const cols = 3;              // fixed
  const questionPageCount = Math.ceil(total / perPage);

  const answersPerPage = 40;
  const answerPageCount = Math.ceil(total / answersPerPage);

  const totalPagesOverall = questionPageCount + answerPageCount;

  const safeStudent = escapeHtml((studentName || "DYAA").trim() || "DYAA");
  const safeTs = escapeHtml(ts || "");

  // Question pages (15 per page, 3 columns)
  for (let p = 0; p < questionPageCount; p++) {
    const start = p * perPage;
    const end = Math.min(start + perPage, total);

    const page = document.createElement("div");
    page.className = "pdf-page compact";

    page.innerHTML = `
      <div class="pdf-header">
        <div class="pdf-brand">
          <div class="pdf-brand-name">DYAA</div>
          <div class="pdf-title">${TITLE}<span class="pdf-ts">${safeTs}</span></div>
        </div>
        <div class="pdf-meta">
          <div><strong>Student:</strong> ${safeStudent}</div>
          <div><strong>Page:</strong> ${p + 1} / ${totalPagesOverall}</div>
          <div style="margin-top:2px;"><strong>Total:</strong> ${total} questions</div>
        </div>
      </div>
      <div class="pdf-grid cols-${cols} compact"></div>
    `;

    const grid = page.querySelector(".pdf-grid");

    for (let i = start; i < end; i++) {
      const q = questionSet[i];
      const card = document.createElement("div");
      card.className = "pdf-card";
      card.innerHTML = `
        <div class="pdf-qnum">Q${q.number}</div>
        <div class="pdf-qtext">${q.textHtml}</div>
        <div class="pdf-write-space"></div>
      `;
      grid.appendChild(card);
    }

    pdfRenderRoot.appendChild(page);
    pages.push(page);
  }

  // Answer key pages (kept as last page(s))
  for (let ap = 0; ap < answerPageCount; ap++) {
    const start = ap * answersPerPage;
    const end = Math.min(start + answersPerPage, total);
    const pageNo = questionPageCount + ap + 1;

    const page = document.createElement("div");
    page.className = "pdf-page compact";

    page.innerHTML = `
      <div class="pdf-header">
        <div class="pdf-brand">
          <div class="pdf-brand-name">DYAA</div>
          <div class="pdf-title">Answer Key<span class="pdf-ts">${safeTs}</span></div>
        </div>
        <div class="pdf-meta">
          <div><strong>Student:</strong> ${safeStudent}</div>
          <div><strong>Page:</strong> ${pageNo} / ${totalPagesOverall}</div>
          <div style="margin-top:2px;"><strong>For:</strong> ${TITLE}</div>
        </div>
      </div>

      <div class="pdf-answerkey">
        <div class="pdf-answerkey-title">Answers</div>
        <div class="pdf-ans-grid"></div>
      </div>
    `;

    const grid = page.querySelector(".pdf-ans-grid");
    for (let i = start; i < end; i++) {
      const q = questionSet[i];
      const item = document.createElement("div");
      item.className = "pdf-ans-item";
      item.innerHTML = `<span class="pdf-ans-num">Q${q.number}.</span> <span class="pdf-ans-val">${q.answerHtml}</span>`;
      grid.appendChild(item);
    }

    pdfRenderRoot.appendChild(page);
    pages.push(page);
  }

  return pages;
}

async function exportToPdf(total) {
  if (!window.jspdf || !window.jspdf.jsPDF || !window.html2canvas) {
    alert("PDF libraries not loaded. Please refresh and try again.");
    return;
  }

  // Use ONE timestamp for both PDF title and file name
  const ts = formatDateForFilename(new Date());

  const questionSet = buildPdfQuestionSet(total);
  const pages = renderPdfAllPages(questionSet, total, ts);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  for (let i = 0; i < pages.length; i++) {
    const canvas = await window.html2canvas(pages[i], {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true
    });

    const imgData = canvas.toDataURL("image/png");
    if (i > 0) pdf.addPage();
    pdf.addImage(imgData, "PNG", 0, 0, 210, 297);
  }

  const safeName = (studentName || "DYAA").replace(/[^a-z0-9_\-]/gi, "_") || "DYAA";
  pdf.save(`DecimalDiv_${safeName}_${total}Q_${ts}.pdf`);
}

exportPdfButton.addEventListener("click", openPdfModal);
pdfCancelBtn.addEventListener("click", closePdfModal);
pdfModal.addEventListener("click", (e) => { if (e.target === pdfModal) closePdfModal(); });

pdfExportBtn.addEventListener("click", async () => {
  const total = Number(pdfTotalSelect.value || 15);

  pdfExportBtn.disabled = true;
  const oldText = pdfExportBtn.textContent;
  pdfExportBtn.textContent = "Exporting...";

  try {
    closePdfModal();
    await exportToPdf(total);
  } finally {
    pdfExportBtn.disabled = false;
    pdfExportBtn.textContent = oldText;
  }
});
/* ----------------------------------------------------------
   Init
---------------------------------------------------------- */
(function init() {
  const urlName = getNameFromUrl();
  if (urlName) startQuizFromUrlName(urlName);
  else showStartScreen();
})();
</script>
</body>
</html>
