<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decimal Operations Practice</title>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .quiz-container {
      max-width: 900px;
      margin: 40px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    #headerLogo {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background-color: #0d47a1;
      border-radius: 6px;
    }

    .logo-text .brand {
      font-size: 1.1em;
      color: #0d47a1;
      font-weight: 900;
      letter-spacing: 1px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }

    #timerDisplay {
      font-size: 0.95em;
      color: #333;
    }

    #studentDisplay {
      font-size: 0.95em;
      color: #333;
      font-weight: 600;
    }

    .quiz-main {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 170px;
      border-right: 1px solid #ddd;
      padding-right: 10px;
      display: none;
    }

    .sidebar h4 {
      margin: 0 0 8px;
      font-size: 0.95em;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .sidebar li.active {
      outline: 2px solid #1976d2;
      font-weight: 600;
    }

    .sidebar li.answered {
      border-left: 4px solid #4caf50;
    }

    .sidebar li.correct {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }

    .sidebar li.incorrect {
      background: #f8d7da;
      border-left: 4px solid #f44336;
    }

    #quizContent {
      flex: 1;
    }

    .question-text {
      font-size: 1.1em;
      margin-bottom: 8px;
    }

    .instructions {
      font-size: 0.9em;
      color: #555;
      margin-top: 6px;
      margin-bottom: 12px;
    }

    .part-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .single-question {
      margin-top: 6px;
      margin-bottom: 6px;
      font-size: 1.15em;
      line-height: 1.25;
    }

    .answer-box {
      width: 160px;
      padding: 6px;
      font-size: 1em;
      margin-left: 10px;
    }

    .button-container {
      display: flex;
      justify-content: flex-start;
      margin-top: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 20px;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95em;
    }

    #nextButton { background:#4caf50; }
    #backButton { background:#039be5; }
    #generateButton { background:#ff9800; }
    #submitButton { background:#9c27b0; }
    #saveButton { background:#607d8b; }
    #pauseButton { background:#f57c00; }
    #checkButton { background:#455a64; }
    #exportPdfButton { background:#1976d2; }

    table.review-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .review-table th,
    .review-table td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 0.85em;
      text-align: center;
    }

    .review-table th {
      background: #f2f2f2;
    }

    .correct-answer { background: #d4edda; }
    .incorrect-answer { background: #f8d7da; }

    /* Stacked fraction */
    .frac {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      line-height: 1;
      transform: translateY(-1px);
    }

    .frac .top {
      display: block;
      border-bottom: 1px solid #000;
      padding: 0 2px 1px;
    }

    .frac .bottom {
      display: block;
      padding: 1px 2px 0;
      font-size: 0.9em;
    }

    .mix {
      display: inline-flex;
      align-items: center;
      gap: 0;
    }

    .status-line {
      font-size: 0.9em;
      margin-top: 6px;
    }
    .status-ok {
      color:#2e7d32;
      font-weight:600;
    }
    .status-bad {
      color:#c62828;
      font-weight:600;
    }

    @media (max-width: 700px) {
      .quiz-main { flex-direction: column; }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
        padding-bottom: 10px;
      }
    }

    /* Modal (Export to PDF) */
    .modal-overlay{
      position:fixed;
      left:0; top:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(420px, 92vw);
      background:#fff;
      border-radius:12px;
      padding:18px 18px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
    }
    .modal h3{
      margin:0 0 12px;
      font-size:1.1em;
    }
    .modal-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:10px 0;
      font-size:0.95em;
    }
    .modal-row label{ color:#333; font-weight:600; }
    .modal-row select{
      width:160px;
      padding:7px 10px;
      border:1px solid #ccc;
      border-radius:8px;
      font-size:0.95em;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:14px;
    }
    .modal-btn{
      padding:8px 16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      color:#fff;
      font-size:0.95em;
    }
    .modal-btn.secondary{ background:#607d8b; }
    .modal-btn.primary{ background:#1976d2; }

    /* Hidden PDF render root (off-screen) */
    #pdfRenderRoot{
      position:fixed;
      left:-9999px;
      top:-9999px;
      width:210mm;
      background:#fff;
    }

    /* PDF page layout */
    .pdf-page{
      width:210mm;
      height:297mm;
      box-sizing:border-box;
      padding:10mm 10mm 8mm;
      background:#fff;
      color:#222;
      font-family:'Segoe UI', Tahoma, sans-serif;
    }
    .pdf-page.compact{
      padding:7mm 7mm 6mm;
    }
    .pdf-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom:2px solid #e0e0e0;
      padding-bottom:5px;
      margin-bottom:8px;
    }
    .pdf-page.compact .pdf-header{
      padding-bottom:4px;
      margin-bottom:6px;
    }
    .pdf-brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .pdf-brand .pdf-brand-name{
      font-weight:900;
      color:#0d47a1;
      letter-spacing:1px;
    }
    .pdf-title{
      font-size:13pt;
      font-weight:700;
      margin:0;
    }
    .pdf-ts{
      font-size:9pt;
      font-weight:600;
      color:#555;
      margin-left:6px;
    }
    .pdf-page.compact .pdf-title{
      font-size:11pt;
    }
    .pdf-page.compact .pdf-ts{
      font-size:8pt;
      margin-left:6px;
    }
    .pdf-meta{
      font-size:9.5pt;
      text-align:right;
      color:#333;
    }
    .pdf-page.compact .pdf-meta{
      font-size:8.2pt;
    }
    .pdf-grid{
      display:flex;
      flex-wrap:wrap;
      gap:5mm;
    }
    .pdf-grid.compact{
      gap:2.6mm;
    }
    .pdf-card{
      flex:0 0 calc(50% - 2.5mm);
      border:1px solid #cfcfcf;
      border-radius:10px;
      padding:4.5mm;
      box-sizing:border-box;
      min-height:50mm;
      display:flex;
      flex-direction:column;
    }
    .pdf-grid.cols-3 .pdf-card{ flex-basis: calc(33.333% - 3.4mm); }
    .pdf-grid.cols-4 .pdf-card{ flex-basis: calc(25% - 3.4mm); }

    .pdf-page.compact .pdf-card{
      padding:3mm;
      border-radius:8px;
      min-height:50mm;
      display:flex;
      flex-direction:column;
    }
    .pdf-qnum{
      font-weight:700;
      margin-bottom:3px;
      font-size:10pt;
    }
    .pdf-page.compact .pdf-qnum{
      font-size:9pt;
      margin-bottom:2px;
    }
    .pdf-qtext{
      font-size:11pt;
      line-height:1.15;
      margin-bottom:4mm;
      word-break:break-word;
    }
    .pdf-page.compact .pdf-qtext{
      font-size:9.5pt;
      line-height:1.1;
      margin-bottom:2.4mm;
    }
    .pdf-write-space{
      margin-top:auto;
      min-height:22mm;
    }
    .pdf-page.compact .pdf-write-space{
      min-height:22mm;
    }

    .pdf-answer{ display:none; }
    .pdf-page.compact /* fraction size inside PDF */
    .pdf-card .frac{ font-size:1em; }
    .pdf-card .frac .top{ padding:0 2px; }
    .pdf-card .frac .bottom{ font-size:0.9em; }

    /* Answer key */
    .pdf-answerkey{
      margin-top:2mm;
    }
    .pdf-answerkey-title{
      font-size:14pt;
      font-weight:800;
      margin:0 0 4mm;
    }
    .pdf-page.compact .pdf-answerkey-title{
      font-size:12pt;
      margin-bottom:3mm;
    }
    .pdf-ans-grid{
      display:flex;
      flex-wrap:wrap;
      column-gap:6mm;
      row-gap:2mm;
    }
    .pdf-ans-item{
      flex:0 0 calc(50% - 3mm);
      font-size:11pt;
      line-height:1.2;
      word-break:break-word;
    }
    .pdf-page.compact .pdf-ans-item{
      font-size:10pt;
    }
    .pdf-ans-num{
      font-weight:700;
      margin-right:4px;
    }
  </style>
</head>

<body>
<div class="quiz-container">
  <div id="headerLogo">
    <div class="logo-icon" aria-hidden="true"></div>
    <div class="logo-text">
      <div class="brand">DYAA</div>
    </div>
  </div>

  <div class="top-bar">
    <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
      <div id="timerDisplay">Time: 00:00</div>
      <div id="studentDisplay" style="display:none;">Student: DYAA</div>
    </div>
    <div>
      <button id="pauseButton" style="display:none;">Pause</button>
      <button id="generateButton" style="display:none;">Generate New Set</button>
      <button id="exportPdfButton" style="display:none;">Export to PDF</button>
    </div>
  </div>

  <h2>Decimal Operations Practice</h2>

  <div class="quiz-main">
    <div id="sidebar" class="sidebar"></div>
    <div id="quizContent"></div>
  </div>

  <div class="button-container">
    <button id="saveButton" style="display:none;">Save Current Result</button>
  </div>
</div>

<!-- Export to PDF Modal + Hidden Render Root -->
<div id="pdfModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h3>Export to PDF</h3>

    <div class="modal-row">
      <label for="pdfTotalSelect">Total questions</label>
      <select id="pdfTotalSelect">
        <option value="15" selected>15</option>
        <option value="30">30</option>
      </select>
    </div>

    <div style="font-size:0.9em; color:#555; margin-top:6px;">
      Fixed layout: <strong>15</strong> questions per page (<strong>3 columns</strong>). Extra questions continue on the next page.
    </div>

    <div class="modal-actions">
      <button id="pdfCancelBtn" class="modal-btn secondary" type="button">Cancel</button>
      <button id="pdfExportBtn" class="modal-btn primary" type="button">Export</button>
    </div>
  </div>
</div>

<div id="pdfRenderRoot" aria-hidden="true"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */
const TITLE = "Decimal Operations Practice";
const NUM_QUESTIONS = 20;

/* ----------------------------------------------------------
   Helpers
---------------------------------------------------------- */
function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function choice(arr) { return arr[randInt(0, arr.length - 1)]; }

function gcd(a, b) {
  a = Math.abs(a); b = Math.abs(b);
  while (b !== 0) { const t = b; b = a % b; a = t; }
  return a === 0 ? 1 : a;
}

function simplifyFraction(fr) {
  if (fr.d < 0) { fr.n = -fr.n; fr.d = -fr.d; }
  const g = gcd(fr.n, fr.d);
  fr.n /= g; fr.d /= g;
  return fr;
}

function mulFrac(a, b) {
  return simplifyFraction({ n: a.n * b.n, d: a.d * b.d });
}

function fracToValue(fr) { return fr.n / fr.d; }

function fracToString(fr) {
  fr = simplifyFraction({ n: fr.n, d: fr.d });
  if (fr.d === 1) return String(fr.n);
  return `${fr.n}/${fr.d}`;
}

function fracToHtml(fr) {
  fr = simplifyFraction({ n: fr.n, d: fr.d });
  if (fr.d === 1) return String(fr.n);
  return `<span class="frac"><span class="top">${fr.n}</span><span class="bottom">${fr.d}</span></span>`;
}

function mixedToImproper(whole, frac) {
  // whole is positive integer; frac is proper positive
  return simplifyFraction({ n: whole * frac.d + frac.n, d: frac.d });
}

function mixedToHtml(whole, frac) {
  return `<span class="mix"><span>${whole}</span>${fracToHtml(frac)}</span>`;
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#39;"
  }[m]));
}

/* ----------------------------------------------------------
   Answer parsing (supports: integer, decimal, a/b, a b/c, optional leading -)
---------------------------------------------------------- */
function parseAnswer(str) {
  let s = (str || "").trim();
  if (s === "") return NaN;

  let sign = 1;
  if (s[0] === "+") s = s.slice(1).trim();
  else if (s[0] === "-") { sign = -1; s = s.slice(1).trim(); }
  if (s === "") return NaN;

  const parts = s.split(/\s+/);
  // mixed number: "a b/c"
  if (parts.length === 2 && parts[1].includes("/")) {
    const whole = Number(parts[0]);
    const f = parts[1].split("/");
    if (f.length !== 2) return NaN;
    const num = Number(f[0]);
    const den = Number(f[1]);
    if (!Number.isFinite(whole) || !Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;
    const value = Math.abs(whole) + (num / den);
    return sign * (whole < 0 ? -value : value);
  }

  if (s.includes("/")) {
    const f = s.split("/");
    if (f.length !== 2) return NaN;
    const num = Number(f[0]);
    const den = Number(f[1]);
    if (!Number.isFinite(num) || !Number.isFinite(den) || den === 0) return NaN;
    return sign * (num / den);
  }

  const n = Number(s);
  return Number.isFinite(n) ? sign * n : NaN;
}

function nearlyEqual(a, b, eps = 1e-8) {
  if (!Number.isFinite(a) || !Number.isFinite(b)) return false;
  return Math.abs(a - b) < eps;
}

/* ----------------------------------------------------------
   Question generator (decimals)
---------------------------------------------------------- */
function clamp(n, lo, hi){ return Math.min(hi, Math.max(lo, n)); }

function pickDp() { return Math.random() < 0.55 ? 1 : 2; } // slightly more 1dp

function randDecObj(dp, min = 0.1, max = 500) {
  const scale = dp === 1 ? 10 : 100;
  const lo = Math.ceil(min * scale);
  const hi = Math.floor(max * scale);

  for (let t = 0; t < 600; t++) {
    const v = randInt(lo, hi);
    if (v % scale === 0) continue; // avoid .0 / .00
    return { v, dp };
  }
  return { v: lo + 1, dp };
}

function decObjToNumber(o) {
  const scale = o.dp === 1 ? 10 : 100;
  return o.v / scale;
}

function decObjToStr(o) {
  const scale = o.dp === 1 ? 10 : 100;
  return (o.v / scale).toFixed(o.dp);
}

function toHundredths(o) {
  // Return integer value in hundredths
  return o.dp === 1 ? (o.v * 10) : o.v;
}

function fmtAnswer(num, dp) {
  // Keep dp digits (answers can be entered with fewer digits; check uses numeric compare)
  return Number(num).toFixed(dp);
}

/* ---- integer words (0–999) ---- */
const WORD_ONES = ["zero","one","two","three","four","five","six","seven","eight","nine"];
const WORD_TEENS = ["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
const WORD_TENS = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];

function intToWords(n) {
  n = Math.trunc(n);
  if (n < 0 || n > 999) return String(n);
  if (n < 10) return WORD_ONES[n];
  if (n < 20) return WORD_TEENS[n - 10];
  if (n < 100) {
    const t = Math.trunc(n / 10);
    const u = n % 10;
    return u === 0 ? WORD_TENS[t] : `${WORD_TENS[t]}-${WORD_ONES[u]}`;
  }
  const h = Math.trunc(n / 100);
  const r = n % 100;
  if (r === 0) return `${WORD_ONES[h]} hundred`;
  return `${WORD_ONES[h]} hundred and ${intToWords(r)}`;
}

/* ---- Decimal addition / subtraction ---- */
function makeAdd() {
  for (let t = 0; t < 900; t++) {
    const dpA = pickDp();
    const dpB = pickDp();
    const a = randDecObj(dpA, 0.1, 500);
    const b = randDecObj(dpB, 0.1, 500);

    const aH = toHundredths(a);
    const bH = toHundredths(b);
    const sumH = aH + bH;

    // Keep the sums manageable
    if (sumH > 99999) continue; // 999.99

    const maxdp = Math.max(dpA, dpB);
    const aStr = decObjToStr(a);
    const bStr = decObjToStr(b);
    const ans = sumH / 100;

    return {
      textHtml: `${aStr} + ${bStr}`,
      answerValue: ans,
      answerText: fmtAnswer(ans, maxdp),
      answerHtml: escapeHtml(fmtAnswer(ans, maxdp))
    };
  }
  return {
    textHtml: `12.3 + 4.56`,
    answerValue: 16.86,
    answerText: "16.86",
    answerHtml: "16.86"
  };
}

function makeSub() {
  for (let t = 0; t < 1000; t++) {
    const dpA = pickDp();
    const dpB = pickDp();
    const a = randDecObj(dpA, 0.1, 700);
    const b = randDecObj(dpB, 0.1, 700);

    let aH = toHundredths(a);
    let bH = toHundredths(b);

    // ensure non-negative difference
    if (aH < bH) { const tmp = aH; aH = bH; bH = tmp; }

    const diffH = aH - bH;
    if (diffH < 0) continue;

    const maxdp = Math.max(dpA, dpB);
    const aStr = (aH / 100).toFixed(maxdp);
    const bStr = (bH / 100).toFixed(maxdp);
    const ans = diffH / 100;

    return {
      textHtml: `${aStr} − ${bStr}`,
      answerValue: ans,
      answerText: fmtAnswer(ans, maxdp),
      answerHtml: escapeHtml(fmtAnswer(ans, maxdp))
    };
  }
  return {
    textHtml: `23.7 − 5.42`,
    answerValue: 18.28,
    answerText: "18.28",
    answerHtml: "18.28"
  };
}

/* ---- Decimal place value ---- */
function makePlaceDigit() {
  for (let t = 0; t < 900; t++) {
    const dp = pickDp();
    const intPart = randInt(10, 999);
    let frac = 0;

    if (dp === 1) {
      const tenths = randInt(1, 9);
      frac = tenths / 10;
    } else {
      const hundredths = randInt(1, 99); // allows leading zero in decimal
      frac = hundredths / 100;
    }

    const num = intPart + frac;
    const s = num.toFixed(dp);

    // digits
    const parts = s.split(".");
    const intStr = parts[0];
    const decStr = (parts[1] || "");
    const hundreds = intStr.length >= 3 ? Number(intStr[intStr.length - 3]) : null;
    const tens = intStr.length >= 2 ? Number(intStr[intStr.length - 2]) : null;
    const ones = Number(intStr[intStr.length - 1]);
    const tenths = decStr.length >= 1 ? Number(decStr[0]) : null;
    const hundredths = decStr.length >= 2 ? Number(decStr[1]) : null;

    const places = [];
    if (hundreds !== null) places.push({ name: "hundreds", digit: hundreds });
    if (tens !== null) places.push({ name: "tens", digit: tens });
    places.push({ name: "ones", digit: ones });
    places.push({ name: "tenths", digit: tenths });
    if (dp === 2) places.push({ name: "hundredths", digit: hundredths });

    const p = choice(places);

    return {
      textHtml: `In <strong>${s}</strong>, what digit is in the <strong>${p.name}</strong> place?`,
      answerValue: p.digit,
      answerText: String(p.digit),
      answerHtml: escapeHtml(String(p.digit))
    };
  }
  return {
    textHtml: `In <strong>45.67</strong>, what digit is in the <strong>hundredths</strong> place?`,
    answerValue: 7,
    answerText: "7",
    answerHtml: "7"
  };
}

function makePlaceValue() {
  for (let t = 0; t < 900; t++) {
    const dp = pickDp();
    const intPart = randInt(10, 999);
    let frac = 0;

    if (dp === 1) {
      const tenths = randInt(1, 9);
      frac = tenths / 10;
    } else {
      const hundredths = randInt(1, 99);
      frac = hundredths / 100;
    }

    const num = intPart + frac;
    const s = num.toFixed(dp);

    const parts = s.split(".");
    const intStr = parts[0];
    const decStr = (parts[1] || "");

    const hundredsDigit = intStr.length >= 3 ? Number(intStr[intStr.length - 3]) : null;
    const tensDigit = intStr.length >= 2 ? Number(intStr[intStr.length - 2]) : null;
    const onesDigit = Number(intStr[intStr.length - 1]);
    const tenthsDigit = decStr.length >= 1 ? Number(decStr[0]) : null;
    const hundredthsDigit = decStr.length >= 2 ? Number(decStr[1]) : null;

    const places = [];
    if (hundredsDigit !== null) places.push({ name: "hundreds", digit: hundredsDigit, value: hundredsDigit * 100, dp: 0 });
    if (tensDigit !== null) places.push({ name: "tens", digit: tensDigit, value: tensDigit * 10, dp: 0 });
    places.push({ name: "ones", digit: onesDigit, value: onesDigit * 1, dp: 0 });
    places.push({ name: "tenths", digit: tenthsDigit, value: tenthsDigit / 10, dp: 1 });
    if (dp === 2) places.push({ name: "hundredths", digit: hundredthsDigit, value: hundredthsDigit / 100, dp: 2 });

    const p = choice(places);

    const ansText = (p.dp === 0) ? String(p.value) : fmtAnswer(p.value, p.dp);

    return {
      textHtml: `In <strong>${s}</strong>, what is the <strong>value</strong> of the digit in the <strong>${p.name}</strong> place?`,
      answerValue: p.value,
      answerText: ansText,
      answerHtml: escapeHtml(ansText)
    };
  }
  return {
    textHtml: `In <strong>345.67</strong>, what is the <strong>value</strong> of the digit in the <strong>tenths</strong> place?`,
    answerValue: 0.6,
    answerText: "0.6",
    answerHtml: "0.6"
  };
}

/* ---- Decimals in words -> decimal ---- */
function makeWordsToDecimal() {
  for (let t = 0; t < 900; t++) {
    const dp = pickDp();
    const whole = randInt(1, 250);

    if (dp === 1) {
      const tenths = randInt(1, 9);
      const words = `${intToWords(whole)} and ${intToWords(tenths)} tenths`;
      const ans = whole + tenths / 10;
      const ansText = ans.toFixed(1);
      return {
        textHtml: `Write <strong>${escapeHtml(words)}</strong> as a decimal.`,
        answerValue: ans,
        answerText: ansText,
        answerHtml: escapeHtml(ansText)
      };
    } else {
      const hundredths = randInt(1, 99);
      const words = `${intToWords(whole)} and ${intToWords(hundredths)} hundredths`;
      const ans = whole + hundredths / 100;
      const ansText = ans.toFixed(2);
      return {
        textHtml: `Write <strong>${escapeHtml(words)}</strong> as a decimal.`,
        answerValue: ans,
        answerText: ansText,
        answerHtml: escapeHtml(ansText)
      };
    }
  }
  return {
    textHtml: `Write <strong>twelve and four hundredths</strong> as a decimal.`,
    answerValue: 12.04,
    answerText: "12.04",
    answerHtml: "12.04"
  };
}

/* ---- Type plan ---- */
function makeTypePlan(total) {
  const plan = [];

  let add = Math.round(total * 0.34);
  let sub = Math.round(total * 0.34);
  let place = Math.round(total * 0.22);
  let words = total - add - sub - place;

  // Ensure each category appears
  if (add < 4) add = 4;
  if (sub < 4) sub = 4;
  if (place < 4) place = 4;
  words = total - add - sub - place;
  if (words < 2) { words = 2; add = Math.max(4, add - 1); sub = Math.max(4, sub - 1); }

  let placeDigit = Math.max(2, Math.round(place * 0.55));
  let placeValue = Math.max(2, place - placeDigit);
  if (placeDigit + placeValue > place) placeValue = place - placeDigit;

  plan.push(...Array(add).fill("add"));
  plan.push(...Array(sub).fill("sub"));
  plan.push(...Array(placeDigit).fill("pd"));
  plan.push(...Array(placeValue).fill("pv"));
  plan.push(...Array(words).fill("w2d"));

  while (plan.length < total) plan.push(choice(["add","sub","pd","pv","w2d"]));

  for (let i = plan.length - 1; i > 0; i--) {
    const j = randInt(0, i);
    const tmp = plan[i]; plan[i] = plan[j]; plan[j] = tmp;
  }
  return plan.slice(0, total);
}

function generateOneQuestion(preferredType = null) {
  const type = preferredType || choice(["add","sub","pd","pv","w2d"]);

  if (type === "add") return makeAdd();
  if (type === "sub") return makeSub();
  if (type === "pd") return makePlaceDigit();
  if (type === "pv") return makePlaceValue();
  return makeWordsToDecimal();
}
/* ----------------------------------------------------------
   QueryString name
---------------------------------------------------------- */
function getNameFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get("name");
  if (!raw) return null;
  const name = raw.trim();
  return name ? name : null;
}

/* ----------------------------------------------------------
   Global state (timer)
---------------------------------------------------------- */
let questions = [];
let currentQuestionIndex = 0;
let studentName = "DYAA";
let quizStartTime = null;
let quizEndTime = null;
let quizSubmitted = false;

let timerInterval = null;
let elapsedMs = 0;
let isPaused = false;
let firstAttemptMs = null;

const quizContent   = document.getElementById("quizContent");
const sidebarEl     = document.getElementById("sidebar");
const saveButton    = document.getElementById("saveButton");
const generateBtn   = document.getElementById("generateButton");
const pauseButton   = document.getElementById("pauseButton");
const timerDisplay  = document.getElementById("timerDisplay");
const exportPdfButton = document.getElementById("exportPdfButton");

const pdfModal        = document.getElementById("pdfModal");
const pdfTotalSelect  = document.getElementById("pdfTotalSelect");
const pdfCancelBtn    = document.getElementById("pdfCancelBtn");
const pdfExportBtn    = document.getElementById("pdfExportBtn");
const pdfRenderRoot   = document.getElementById("pdfRenderRoot");

function updateStudentDisplay() {
  const el = document.getElementById("studentDisplay");
  el.style.display = "inline-block";
  el.textContent = `Student: ${studentName}`;
}

/* ----------------------------------------------------------
   Timer
---------------------------------------------------------- */
function formatMs(ms) {
  const totalSec = Math.floor(ms / 1000);
  const min = Math.floor(totalSec / 60);
  const sec = totalSec % 60;
  return `${String(min).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

function updateTimerDisplay() {
  let totalMs = elapsedMs;
  if (!isPaused && quizStartTime) totalMs += (new Date() - quizStartTime);
  let text = `Time: ${formatMs(totalMs)}`;
  if (firstAttemptMs !== null) text += ` (First: ${formatMs(firstAttemptMs)})`;
  timerDisplay.textContent = text;
}

function startTimerInterval() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay, 1000);
}

function pauseTimer() {
  if (isPaused || !quizStartTime) return;
  const now = new Date();
  elapsedMs += now - quizStartTime;
  isPaused = true;
  quizStartTime = null;
  updateTimerDisplay();
}

function resumeTimer() {
  if (!isPaused) return;
  isPaused = false;
  quizStartTime = new Date();
  updateTimerDisplay();
}

/* ----------------------------------------------------------
   Generate quiz (avoid duplicates)
---------------------------------------------------------- */
function generateQuiz() {
  questions = [];
  quizSubmitted = false;

  const seen = new Set();
  const plan = makeTypePlan(NUM_QUESTIONS);

  for (let i = 0; i < NUM_QUESTIONS; i++) {
    let guard = 0;
    while (guard < 500) {
      guard++;
      const q = generateOneQuestion(plan[i]);
      const key = q.textHtml.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
      if (seen.has(key)) continue;
      seen.add(key);

      questions.push({
        index: questions.length,
        textHtml: q.textHtml,
        value: q.answerValue,
        display: q.answerText,
        displayHtml: q.answerHtml,
        userValue: "",
        isCorrect: false
      });
      break;
    }

    // Fallback: if we couldn't fill this slot, use any type
    if (questions.length < i + 1) {
      let g2 = 0;
      while (g2 < 600) {
        g2++;
        const q = generateOneQuestion();
        const key = q.textHtml.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
        if (seen.has(key)) continue;
        seen.add(key);

        questions.push({
          index: questions.length,
          textHtml: q.textHtml,
          value: q.answerValue,
          display: q.answerText,
          displayHtml: q.answerHtml,
          userValue: "",
          isCorrect: false
        });
        break;
      }
    }
  }
}

/* ----------------------------------------------------------
   Sidebar
---------------------------------------------------------- */
function renderSidebar() {
  sidebarEl.style.display = "block";
  sidebarEl.innerHTML = `<h4>Questions</h4><ul id="qList"></ul>`;
  const ul = document.getElementById("qList");

  for (let i = 0; i < questions.length; i++) {
    const li = document.createElement("li");
    li.textContent = `Q${i + 1}`;
    li.dataset.index = i;

    li.addEventListener("click", () => {
      saveCurrentInput();
      currentQuestionIndex = i;
      renderQuestion();
    });

    ul.appendChild(li);
  }

  updateSidebarStatus();
}

function updateSidebarStatus() {
  const items = document.querySelectorAll("#qList li");
  items.forEach(li => {
    const idx = Number(li.dataset.index);
    const q = questions[idx];

    li.classList.remove("active","answered","correct","incorrect");
    li.classList.toggle("active", idx === currentQuestionIndex);

    if (!quizSubmitted) {
      if ((q.userValue || "").trim() !== "") li.classList.add("answered");
    } else {
      if ((q.userValue || "").trim() !== "") {
        li.classList.add(q.isCorrect ? "correct" : "incorrect");
      }
    }
  });
}

/* ----------------------------------------------------------
   Render single question
---------------------------------------------------------- */
function saveCurrentInput() {
  const input = document.getElementById("answerInput");
  if (input) questions[currentQuestionIndex].userValue = input.value.trim();
}

const backButton   = document.createElement("button");
backButton.id = "backButton";
backButton.textContent = "Previous";

const nextButton   = document.createElement("button");
nextButton.id = "nextButton";
nextButton.textContent = "Next";

const submitButton = document.createElement("button");
submitButton.id = "submitButton";
submitButton.textContent = "Submit & View Results";

const checkButton  = document.createElement("button");
checkButton.id = "checkButton";
checkButton.textContent = "Check Answer";

backButton.style.background = "#039be5";
nextButton.style.background = "#4caf50";
submitButton.style.background = "#9c27b0";
checkButton.style.background = "#455a64";

function renderQuestion() {
  const q = questions[currentQuestionIndex];

  quizContent.innerHTML = `
    <p class="question-text">Question ${currentQuestionIndex + 1} of ${questions.length}</p>

    <div class="part-title">Solve.</div>

    <div class="single-question">
      Q${currentQuestionIndex + 1}. ${q.textHtml}
      <input id="answerInput" class="answer-box" type="text" value="${escapeHtml(q.userValue || "")}">
    </div>

    <p id="statusLine" class="status-line">Status: <span>—</span></p>

    <p class="instructions">
      Enter your answer as a number. Decimals may have <strong>1</strong> or <strong>2</strong> decimal places. For digit questions, enter a single digit (0–9).
    </p>
  `;

  const btnBar = document.createElement("div");
  btnBar.className = "button-container";

  btnBar.appendChild(backButton);
  btnBar.appendChild(nextButton);

  if (currentQuestionIndex === questions.length - 1) btnBar.appendChild(submitButton);
  if (quizSubmitted) btnBar.appendChild(checkButton);

  quizContent.appendChild(btnBar);

  backButton.style.visibility = currentQuestionIndex === 0 ? "hidden" : "visible";
  nextButton.style.visibility = currentQuestionIndex === questions.length - 1 ? "hidden" : "visible";

  updateSidebarStatus();
}

/* ----------------------------------------------------------
   Results
---------------------------------------------------------- */
function calculateAndShowResults() {
  saveCurrentInput();
  const now = new Date();

  let attemptMs = elapsedMs;
  if (!isPaused && quizStartTime) attemptMs += now - quizStartTime;
  if (firstAttemptMs === null) firstAttemptMs = attemptMs;

  const attemptStart = quizStartTime || now;
  quizEndTime = now;

  quizSubmitted = true;

  let correctCount = 0;
  questions.forEach(q => {
    const val = parseAnswer(q.userValue || "");
    q.isCorrect = nearlyEqual(val, q.value);
    if (q.isCorrect) correctCount++;
  });

  updateSidebarStatus();

  const min = Math.floor(attemptMs / 60000);
  const sec = Math.floor((attemptMs % 60000) / 1000);

  let html = `
    <h3>Results for ${escapeHtml(studentName)}</h3>
    <p>Score: <strong>${correctCount} / ${questions.length}</strong></p>
    <p>Start time: <strong>${attemptStart.toLocaleTimeString()}</strong></p>
    <p>Submit time: <strong>${quizEndTime.toLocaleTimeString()}</strong></p>
    <p>Time taken (this attempt): <strong>${min}m ${sec}s</strong></p>
    <p>First attempt time: <strong>${formatMs(firstAttemptMs)}</strong></p>
    <p>You can click any question on the left to review and use <strong>Check Answer</strong>.</p>

    <table class="review-table">
      <tr>
        <th>#</th>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct</th>
        <th>Result</th>
      </tr>
  `;

  questions.forEach((q, i) => {
    html += `
      <tr class="${q.isCorrect ? "correct-answer" : "incorrect-answer"}">
        <td>${i + 1}</td>
        <td>${q.textHtml}</td>
        <td>${escapeHtml(q.userValue || "—")}</td>
        <td>${q.displayHtml}</td>
        <td>${q.isCorrect ? "Correct" : "Incorrect"}</td>
      </tr>
    `;
  });

  html += `</table>`;
  quizContent.innerHTML = html;

  saveButton.style.display = "inline-block";

  // Restart timer for re-check practice
  elapsedMs = 0;
  isPaused = false;
  quizStartTime = new Date();
  pauseButton.textContent = "Pause";
  startTimerInterval();
  updateTimerDisplay();
}

function checkCurrentQuestion() {
  if (!quizSubmitted) return;

  saveCurrentInput();
  const q = questions[currentQuestionIndex];
  const statusLine = document.getElementById("statusLine");
  if (!statusLine) return;

  if ((q.userValue || "").trim() === "") {
    statusLine.innerHTML = 'Status: <span class="status-bad">No answer</span>';
    return;
  }

  const val = parseAnswer(q.userValue || "");
  if (!Number.isFinite(val)) {
    statusLine.innerHTML = 'Status: <span class="status-bad">Invalid input</span>';
    return;
  }

  if (nearlyEqual(val, q.value)) {
    q.isCorrect = true;
    statusLine.innerHTML = 'Status: <span class="status-ok">Correct</span>';
  } else {
    q.isCorrect = false;
    statusLine.innerHTML = 'Status: <span class="status-bad">Incorrect</span>';
  }

  updateSidebarStatus();
}

/* ----------------------------------------------------------
   Save result
---------------------------------------------------------- */
function formatDateForFilename(date) {
  if (!date) return "no_time";
  const pad = n => String(n).padStart(2, "0");
  return (
    date.getFullYear() +
    pad(date.getMonth() + 1) +
    pad(date.getDate()) + "_" +
    pad(date.getHours()) +
    pad(date.getMinutes()) +
    pad(date.getSeconds())
  );
}

function saveCurrentResultAsTxt() {
  saveCurrentInput();

  if (!quizSubmitted) {
    questions.forEach(q => {
      const val = parseAnswer(q.userValue || "");
      q.isCorrect = nearlyEqual(val, q.value);
    });
  }

  let correctCount = 0;
  questions.forEach(q => { if (q.isCorrect) correctCount++; });

  const lines = [];
  lines.push(TITLE + " - Current Result");
  lines.push("Student: " + studentName);
  if (quizEndTime) lines.push("Last submit time: " + quizEndTime.toLocaleString());
  lines.push("Score: " + correctCount + " / " + questions.length);
  if (firstAttemptMs !== null) lines.push("First attempt time: " + formatMs(firstAttemptMs));
  lines.push("");
  lines.push("Details:");
  lines.push("----------");

  questions.forEach((q, i) => {
    const plainQuestion = q.textHtml.replace(/<[^>]+>/g,"");
    const userAns = (q.userValue || "").trim() === "" ? "Not answered" : q.userValue;
    const resultText = (q.userValue || "").trim() === "" ? "Not answered" : (q.isCorrect ? "Correct" : "Incorrect");

    lines.push(
      `Q${i + 1}` +
      "\nQuestion: " + plainQuestion +
      "\nYour answer: " + userAns +
      "\nCorrect answer: " + q.display +
      "\nResult: " + resultText
    );
    lines.push("");
  });

  const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = (studentName || "DYAA").replace(/[^a-z0-9_\-]/gi, "_") || "DYAA";
  const ts = formatDateForFilename(new Date());
  a.href = url;
  a.download = `DecimalOps_${safeName}_${ts}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ----------------------------------------------------------
   Button events
---------------------------------------------------------- */
nextButton.addEventListener("click", () => {
  saveCurrentInput();
  if (currentQuestionIndex < questions.length - 1) {
    currentQuestionIndex++;
    renderQuestion();
  }
});

backButton.addEventListener("click", () => {
  saveCurrentInput();
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    renderQuestion();
  }
});

submitButton.addEventListener("click", calculateAndShowResults);
checkButton.addEventListener("click", checkCurrentQuestion);
saveButton.addEventListener("click", saveCurrentResultAsTxt);

pauseButton.addEventListener("click", () => {
  if (!quizStartTime && elapsedMs === 0 && !quizSubmitted) return;
  if (isPaused) { resumeTimer(); pauseButton.textContent = "Pause"; }
  else { pauseTimer(); pauseButton.textContent = "Resume"; }
});

generateBtn.addEventListener("click", () => {
  if (!quizSubmitted && !confirm("Generate a new random set? All answers will be lost.")) return;

  if (timerInterval) clearInterval(timerInterval);
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;
  quizStartTime = new Date();
  quizEndTime = null;
  updateTimerDisplay();
  startTimerInterval();
  pauseButton.style.display = "inline-block";
  pauseButton.textContent = "Pause";

  generateQuiz();
  currentQuestionIndex = 0;

  renderSidebar();
  renderQuestion();
  saveButton.style.display = "none";
});

/* ----------------------------------------------------------
   Start screen
---------------------------------------------------------- */
function showStartScreen() {
  sidebarEl.style.display = "none";
  saveButton.style.display = "none";
  pauseButton.style.display = "none";
  generateBtn.style.display = "none";
  exportPdfButton.style.display = "none";

  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  elapsedMs = 0; isPaused = false; firstAttemptMs = null;
  quizStartTime = null; quizEndTime = null;
  updateTimerDisplay();

  quizContent.innerHTML = `
    <p>This practice set contains <strong>${NUM_QUESTIONS}</strong> questions on decimals: <strong>place value</strong>, <strong>decimals in words</strong>, and <strong>addition/subtraction</strong> (1–2 decimal places).</p>
    <p>Please enter your name to begin:</p>

    <input id="nameInput"
           type="text"
           style="padding:10px; width:250px; font-size:1.05em;"
           placeholder="DYAA"
           value="DYAA">

    <button id="startButton"
            style="margin-left:10px; background:#4caf50; padding:10px 20px; color:white; border:none; border-radius:6px;">
      Start
    </button>
  `;

  document.getElementById("startButton").addEventListener("click", startQuizFromInput);
}

function startQuizCommon() {
  updateStudentDisplay();

  quizStartTime = new Date();
  elapsedMs = 0;
  isPaused = false;
  firstAttemptMs = null;

  updateTimerDisplay();
  startTimerInterval();

  generateQuiz();
  currentQuestionIndex = 0;

  renderSidebar();
  renderQuestion();

  generateBtn.style.display = "inline-block";
  pauseButton.style.display = "inline-block";
  exportPdfButton.style.display = "inline-block";
  pauseButton.textContent = "Pause";
  saveButton.style.display = "none";
}

function startQuizFromInput() {
  const nameInput = document.getElementById("nameInput");
  studentName = (nameInput.value || "DYAA").trim() || "DYAA";
  startQuizCommon();
}

function startQuizFromUrlName(name) {
  studentName = (name || "DYAA").trim() || "DYAA";
  startQuizCommon();
}

/* ----------------------------------------------------------
   Export to PDF
---------------------------------------------------------- */
function openPdfModal() {
  pdfModal.style.display = "flex";
}
function closePdfModal() { pdfModal.style.display = "none"; }

function buildPdfQuestionSet(total) {
  const out = [];
  const seen = new Set();

  const plan = makeTypePlan(total);

  for (let i = 0; i < total; i++) {
    let guard = 0;
    while (guard < 500) {
      guard++;
      const q = generateOneQuestion(plan[i]);
      const key = q.textHtml.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
      if (seen.has(key)) continue;
      seen.add(key);

      out.push({
        number: i + 1,
        textHtml: q.textHtml,
        answerHtml: q.answerHtml
      });
      break;
    }

    // Fallback: if we somehow couldn't fill this slot, use any type
    if (out.length < i + 1) {
      let g2 = 0;
      while (g2 < 600) {
        g2++;
        const q = generateOneQuestion();
        const key = q.textHtml.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push({ number: i + 1, textHtml: q.textHtml, answerHtml: q.answerHtml });
        break;
      }
    }
  }

  return out;
}

function renderPdfAllPages(questionSet, total, ts) {
  pdfRenderRoot.innerHTML = "";
  const pages = [];

  const perPage = 15;          // fixed
  const cols = 3;              // fixed
  const questionPageCount = Math.ceil(total / perPage);

  const answersPerPage = 40;
  const answerPageCount = Math.ceil(total / answersPerPage);

  const totalPagesOverall = questionPageCount + answerPageCount;

  const safeStudent = escapeHtml((studentName || "DYAA").trim() || "DYAA");
  const safeTs = escapeHtml(ts || "");

  // Question pages (15 per page, 3 columns)
  for (let p = 0; p < questionPageCount; p++) {
    const start = p * perPage;
    const end = Math.min(start + perPage, total);

    const page = document.createElement("div");
    page.className = "pdf-page compact";

    page.innerHTML = `
      <div class="pdf-header">
        <div class="pdf-brand">
          <div class="pdf-brand-name">DYAA</div>
          <div class="pdf-title">${TITLE}<span class="pdf-ts">${safeTs}</span></div>
        </div>
        <div class="pdf-meta">
          <div><strong>Student:</strong> ${safeStudent}</div>
          <div><strong>Page:</strong> ${p + 1} / ${totalPagesOverall}</div>
          <div style="margin-top:2px;"><strong>Total:</strong> ${total} questions</div>
        </div>
      </div>
      <div class="pdf-grid cols-${cols} compact"></div>
    `;

    const grid = page.querySelector(".pdf-grid");

    for (let i = start; i < end; i++) {
      const q = questionSet[i];
      const card = document.createElement("div");
      card.className = "pdf-card";
      card.innerHTML = `
        <div class="pdf-qnum">Q${q.number}</div>
        <div class="pdf-qtext">${q.textHtml}</div>
        <div class="pdf-write-space"></div>
      `;
      grid.appendChild(card);
    }

    pdfRenderRoot.appendChild(page);
    pages.push(page);
  }

  // Answer key pages (kept as last page(s))
  for (let ap = 0; ap < answerPageCount; ap++) {
    const start = ap * answersPerPage;
    const end = Math.min(start + answersPerPage, total);
    const pageNo = questionPageCount + ap + 1;

    const page = document.createElement("div");
    page.className = "pdf-page compact";

    page.innerHTML = `
      <div class="pdf-header">
        <div class="pdf-brand">
          <div class="pdf-brand-name">DYAA</div>
          <div class="pdf-title">Answer Key<span class="pdf-ts">${safeTs}</span></div>
        </div>
        <div class="pdf-meta">
          <div><strong>Student:</strong> ${safeStudent}</div>
          <div><strong>Page:</strong> ${pageNo} / ${totalPagesOverall}</div>
          <div style="margin-top:2px;"><strong>For:</strong> ${TITLE}</div>
        </div>
      </div>

      <div class="pdf-answerkey">
        <div class="pdf-answerkey-title">Answers</div>
        <div class="pdf-ans-grid"></div>
      </div>
    `;

    const grid = page.querySelector(".pdf-ans-grid");
    for (let i = start; i < end; i++) {
      const q = questionSet[i];
      const item = document.createElement("div");
      item.className = "pdf-ans-item";
      item.innerHTML = `<span class="pdf-ans-num">Q${q.number}.</span> <span class="pdf-ans-val">${q.answerHtml}</span>`;
      grid.appendChild(item);
    }

    pdfRenderRoot.appendChild(page);
    pages.push(page);
  }

  return pages;
}

async function exportToPdf(total) {
  if (!window.jspdf || !window.jspdf.jsPDF || !window.html2canvas) {
    alert("PDF libraries not loaded. Please refresh and try again.");
    return;
  }

  // Use ONE timestamp for both PDF title and file name
  const ts = formatDateForFilename(new Date());

  const questionSet = buildPdfQuestionSet(total);
  const pages = renderPdfAllPages(questionSet, total, ts);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  for (let i = 0; i < pages.length; i++) {
    const canvas = await window.html2canvas(pages[i], {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true
    });

    const imgData = canvas.toDataURL("image/png");
    if (i > 0) pdf.addPage();
    pdf.addImage(imgData, "PNG", 0, 0, 210, 297);
  }

  const safeName = (studentName || "DYAA").replace(/[^a-z0-9_\-]/gi, "_") || "DYAA";
  pdf.save(`DecimalOps_${safeName}_${total}Q_${ts}.pdf`);
}

exportPdfButton.addEventListener("click", openPdfModal);
pdfCancelBtn.addEventListener("click", closePdfModal);
pdfModal.addEventListener("click", (e) => { if (e.target === pdfModal) closePdfModal(); });

pdfExportBtn.addEventListener("click", async () => {
  const total = Number(pdfTotalSelect.value || 15);

  pdfExportBtn.disabled = true;
  const oldText = pdfExportBtn.textContent;
  pdfExportBtn.textContent = "Exporting...";

  try {
    closePdfModal();
    await exportToPdf(total);
  } finally {
    pdfExportBtn.disabled = false;
    pdfExportBtn.textContent = oldText;
  }
});
/* ----------------------------------------------------------
   Init
---------------------------------------------------------- */
(function init() {
  const urlName = getNameFromUrl();
  if (urlName) startQuizFromUrlName(urlName);
  else showStartScreen();
})();
</script>
</body>
</html>
